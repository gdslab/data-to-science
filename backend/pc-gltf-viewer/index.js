let t=class{constructor(t,e,s){this.owner=t,this.name=e,this.fn=s}unbind(){this.owner&&(this.owner.unbind(this.name,this.fn),this.owner=null,this.name=null,this.fn=null)}call(t,...e){this.fn&&this.fn.call(this.owner,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}on(t,e){return this.owner.on(t,e)}};class e{constructor(){this._suspendEvents=!1,this._additionalEmitters=[],this._events={},Object.defineProperty(this,"_events",{enumerable:!1,configurable:!1,writable:!0,value:{}})}set suspendEvents(t){this._suspendEvents=!!t}get suspendEvents(){return this._suspendEvents}on(e,s){const i=this._events[e];return void 0===i?this._events[e]=[s]:-1===i.indexOf(s)&&i.push(s),new t(this,e,s)}once(t,e){const s=this.on(t,((t,i,n,r,a,o,l,h)=>{e.call(this,t,i,n,r,a,o,l,h),s.unbind()}));return s}emit(t,e,s,i,n,r,a,o,l){if(this._suspendEvents)return this;let h=this._events[t];if(h&&h.length){h=h.slice(0);for(let c=0;c<h.length;c++)if(h[c])try{h[c].call(this,e,s,i,n,r,a,o,l)}catch(e){console.info("%c%s %c(event error)","color: #06f",t,"color: #f00"),console.log(e.stack)}}if(this._additionalEmitters.length){this._additionalEmitters.slice().forEach((h=>{h.emit(t,e,s,i,n,r,a,o,l)}))}return this}unbind(t,e){if(t){const s=this._events[t];if(!s)return this;if(e){const i=s.indexOf(e);-1!==i&&(1===s.length?delete this._events[t]:s.splice(i,1))}else delete this._events[t]}else this._events={};return this}addEmitter(t){this._additionalEmitters.includes(t)||this._additionalEmitters.push(t)}removeEmitter(t){const e=this._additionalEmitters.indexOf(t);-1!==e&&this._additionalEmitters.splice(e,1)}}const s=(t,e)=>{if(!t||!e)return!1;const i=t.length;if(i!==e.length)return!1;for(let n=0;n<i;n++)if(t[n]instanceof Array&&e[n]instanceof Array){if(!s(t[n],e[n]))return!1}else if(t[n]!==e[n])return!1;return!0};class i extends e{constructor(t,e={}){if(super(),this._destroyed=!1,this._path="",this._keys=[],this._data={},this._pathsWithDuplicates=null,this._parent=null,this._parentPath="",this._parentField=null,this._parentKey=null,this._latestFn=null,this._silent=!1,this._pathsWithDuplicates=null,e.pathsWithDuplicates){this._pathsWithDuplicates={};for(let t=0;t<e.pathsWithDuplicates.length;t++)this._pathsWithDuplicates[e.pathsWithDuplicates[t]]=!0}this.patch(t),this._parent=e.parent||null,this._parentPath=e.parentPath||"",this._parentField=e.parentField||null,this._parentKey=e.parentKey||null,this._latestFn=e.latestFn||null,this._silent=!1;const s=function(t){return function(e,s,i,n){if(!this._parent)return;let r,a=this._parentKey;!a&&this._parentField instanceof Array&&(a=this._parentField.indexOf(this),-1===a)||(e=`${this._parentPath}.${a}.${e}`,this._silent&&(r=this._parent.silence()),this._parent.emit(`${e}:${t}`,s,i,n),this._parent.emit(`*:${t}`,e,s,i,n),this._silent&&this._parent.silenceRestore(r))}};this.on("*:set",s("set")),this.on("*:unset",s("unset")),this.on("*:insert",s("insert")),this.on("*:remove",s("remove")),this.on("*:move",s("move"))}static _splitPath(t){const e=i._splitPathsCache;let s=e[t];return s?s=s.slice():(s=t.split("."),e[t]=s),s}silence(){this._silent=!0;const t=this.history&&this.history.enabled;t&&(this.history.enabled=!1);const e=this.sync&&this.sync.enabled;return e&&(this.sync.enabled=!1),[t,e]}silenceRestore(t){this._silent=!1,t[0]&&(this.history.enabled=!0),t[1]&&(this.sync.enabled=!0)}_prepare(t,e,s,n=!1,r=!1){let a,o;const l=(t._path?`${t._path}.`:"")+e,h=typeof s;if(t._keys.push(e),"object"===h&&s instanceof Array){for(t._data[e]=s.slice(0),a=0;a<t._data[e].length;a++)"object"==typeof t._data[e][a]&&null!==t._data[e][a]?t._data[e][a]instanceof Array?t._data[e][a].slice(0):t._data[e][a]=new i(t._data[e][a],{parent:this,parentPath:l,parentField:t._data[e],parentKey:null}):(o=this.silence(),this.emit(`${l}.${a}:set`,t._data[e][a],null,r),this.emit("*:set",`${l}.${a}`,t._data[e][a],null,r),this.silenceRestore(o));n&&(o=this.silence()),this.emit(`${l}:set`,t._data[e],null,r),this.emit("*:set",l,t._data[e],null,r),n&&this.silenceRestore(o)}else if("object"===h&&s instanceof Object){for(a in"object"!=typeof t._data[e]&&(t._data[e]={_path:l,_keys:[],_data:{}}),s)"object"==typeof s[a]?this._prepare(t._data[e],a,s[a],!0,r):(o=this.silence(),t._data[e]._data[a]=s[a],t._data[e]._keys.push(a),this.emit(`${l}.${a}:set`,s[a],null,r),this.emit("*:set",`${l}.${a}`,s[a],null,r),this.silenceRestore(o));n&&(o=this.silence()),this.emit(`${l}:set`,s,void 0,r),this.emit("*:set",l,s,void 0,r),n&&this.silenceRestore(o)}else n&&(o=this.silence()),t._data[e]=s,this.emit(`${l}:set`,s,void 0,r),this.emit("*:set",l,s,void 0,r),n&&this.silenceRestore(o);return!0}set(t,e,n=!1,r=!1,a=!1){let o,l,h=i._splitPath(t);const c=h.length,d=h[c-1];let u,f,p=this,m="",_=this;for(o=0;o<c-1;o++)p instanceof Array?(p=p[h[o]],p instanceof i&&(t=h.slice(o+1).join("."),_=p)):(o<c&&"object"!=typeof p._data[h[o]]&&(p._data[h[o]]&&_.unset((p._path?`${p._path}.`:"")+h[o]),p._data[h[o]]={_path:t,_keys:[],_data:{}},p._keys.push(h[o])),o===c-1&&p._path&&(m=`${p._path}.${h[o]}`),p=p._data[h[o]]);if(p instanceof Array){const s=parseInt(d,10);return!(p[s]===e&&!a)&&(l=p[s],l=l instanceof i?l.json():_.json(l),p[s]=e,e instanceof i&&(e._parent=_,e._parentPath=m,e._parentField=p,e._parentKey=null),n&&(u=_.silence()),_.emit(`${t}:set`,e,l,r),_.emit("*:set",t,e,l,r),n&&_.silenceRestore(u),!0)}if(p._data&&!p._data.hasOwnProperty(d))return"object"==typeof e?_._prepare(p,d,e,!1,r):(p._data[d]=e,p._keys.push(d),n&&(u=_.silence()),_.emit(`${t}:set`,e,null,r),_.emit("*:set",t,e,null,r),n&&_.silenceRestore(u),!0);if("object"==typeof e&&e instanceof Array){if(s(e,p._data[d])&&!a)return!1;if(l=p._data[d],l instanceof i||(l=_.json(l)),p._data[d]&&p._data[d].length===e.length){for(u=_.silence(),0===e.length&&(p._data[d]=e),o=0;o<p._data[d].length;o++)p._data[d][o]instanceof i?p._data[d][o].patch(e[o],!0):p._data[d][o]!==e[o]&&(p._data[d][o]=e[o],_.emit(`${t}.${o}:set`,p._data[d][o],l&&l[o]||null,r),_.emit("*:set",`${t}.${o}`,p._data[d][o],l&&l[o]||null,r));_.silenceRestore(u)}else{for(p._data[d]=[],e.forEach((t=>{this._doInsert(p,d,t,void 0,!0)})),u=_.silence(),o=0;o<p._data[d].length;o++)_.emit(`${t}.${o}:set`,p._data[d][o],l&&l[o]||null,r),_.emit("*:set",`${t}.${o}`,p._data[d][o],l&&l[o]||null,r);_.silenceRestore(u)}return n&&(u=_.silence()),_.emit(`${t}:set`,e,l,r),_.emit("*:set",t,e,l,r),n&&_.silenceRestore(u),!0}if("object"==typeof e&&e instanceof Object){let s,a=!1;l=p._data[d],l instanceof i||(l=_.json(l)),h=Object.keys(e),p._data[d]&&p._data[d]._data||(p._data[d]?_.unset((p._path?`${p._path}.`:"")+d):a=!0,p._data[d]={_path:t,_keys:[],_data:{}});for(const i in p._data[d]._data)e.hasOwnProperty(i)?p._data[d]._data.hasOwnProperty(i)?_._equals(p._data[d]._data[i],e[i])||(s=_.set(`${t}.${i}`,e[i],!0),s&&(a=!0)):(s=_._prepare(p._data[d],i,e[i],!0,r),s&&(a=!0)):(s=_.unset(`${t}.${i}`,!0),s&&(a=!0));for(o=0;o<h.length;o++)void 0===e[h[o]]&&p._data[d]._data.hasOwnProperty(h[o])?(s=_.unset(`${t}.${h[o]}`,!0),s&&(a=!0)):"object"==typeof e[h[o]]?p._data[d]._data.hasOwnProperty(h[o])?(s=_.set(`${t}.${h[o]}`,e[h[o]],!0),s&&(a=!0)):(s=_._prepare(p._data[d],h[o],e[h[o]],!0,r),s&&(a=!0)):_._equals(p._data[d]._data[h[o]],e[h[o]])||("object"==typeof e[h[o]]?(s=_.set(`${p._data[d]._path}.${h[o]}`,e[h[o]],!0),s&&(a=!0)):p._data[d]._data[h[o]]!==e[h[o]]&&(a=!0,-1===p._data[d]._keys.indexOf(h[o])&&p._data[d]._keys.push(h[o]),p._data[d]._data[h[o]]=e[h[o]],u=_.silence(),_.emit(`${p._data[d]._path}.${h[o]}:set`,p._data[d]._data[h[o]],null,r),_.emit("*:set",`${p._data[d]._path}.${h[o]}`,p._data[d]._data[h[o]],null,r),_.silenceRestore(u)));if(a){n&&(u=_.silence());const t=_.json(p._data[d]);return _.emit(`${p._data[d]._path}:set`,t,l,r),_.emit("*:set",p._data[d]._path,t,l,r),n&&_.silenceRestore(u),!0}return!1}return f=!p.hasOwnProperty("_data")&&p.hasOwnProperty(d)?p:p._data,!(f[d]===e&&!a)&&(n&&(u=_.silence()),l=f[d],l instanceof i||(l=_.json(l)),f[d]=e,_.emit(`${t}:set`,e,l,r),_.emit("*:set",t,e,l,r),n&&_.silenceRestore(u),!0)}has(t){const e=i._splitPath(t);let s=this;for(let t=0,i=e.length;t<i;t++){if(null==s)return;s=s._data?s._data[e[t]]:s[e[t]]}return void 0!==s}get(t,e=!1){const s=i._splitPath(t);let n=this;for(let t=0;t<s.length;t++){if(null==n)return;n=n._data?n._data[s[t]]:n[s[t]]}return e?n:null==n?null:this.json(n)}getRaw(t){return this.get(t,!0)}_equals(t,e){return t===e||!!(t instanceof Array&&e instanceof Array&&s(t,e))}unset(t,e=!1,s=!1){let n;const r=i._splitPath(t),a=r[r.length-1];let o=this,l=this;for(n=0;n<r.length-1;n++)o instanceof Array?(o=o[r[n]],o instanceof i&&(t=r.slice(n+1).join("."),l=o)):o=o._data[r[n]];if(!o._data||!o._data.hasOwnProperty(a))return!1;let h,c=o._data[a];if(c instanceof i||(c=l.json(c)),o._data[a]&&o._data[a]._data)for(n=o._data[a]._keys.length-1;n>=0;n--)l.unset(`${t}.${o._data[a]._keys[n]}`,!0);return o._keys.splice(o._keys.indexOf(a),1),delete o._data[a],e&&(h=l.silence()),l.emit(`${t}:unset`,c,s),l.emit("*:unset",t,c,s),e&&l.silenceRestore(h),!0}remove(t,e,s=!1,n=!1){const r=i._splitPath(t),a=r[r.length-1];let o=this,l=this;for(let e=0;e<r.length-1;e++)if(o instanceof Array)o=o[parseInt(r[e],10)],o instanceof i&&(t=r.slice(e+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[e]))return!1;o=o._data[r[e]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return!1;const h=o._data[a];if(h.length<e)return!1;let c,d=h[e];return d instanceof i?d._parent=null:d=l.json(d),h.splice(e,1),s&&(c=l.silence()),l.emit(`${t}:remove`,d,e,n),l.emit("*:remove",t,d,e,n),s&&l.silenceRestore(c),!0}removeValue(t,e,s=!1,n=!1){const r=i._splitPath(t),a=r[r.length-1];let o=this,l=this;for(let e=0;e<r.length-1;e++)if(o instanceof Array)o=o[parseInt(r[e],10)],o instanceof i&&(t=r.slice(e+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[e]))return;o=o._data[r[e]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return;const h=o._data[a],c=h.indexOf(e);if(-1===c)return;if(h.length<c)return;let d;return(e=h[c])instanceof i?e._parent=null:e=l.json(e),h.splice(c,1),s&&(d=l.silence()),l.emit(`${t}:remove`,e,c,n),l.emit("*:remove",t,e,c,n),s&&l.silenceRestore(d),!0}insert(t,e,s,n=!1,r=!1){const a=i._splitPath(t),o=a[a.length-1];let l=this,h=this;for(let e=0;e<a.length-1;e++)if(l instanceof Array)l=l[parseInt(a[e],10)],l instanceof i&&(t=a.slice(e+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(a[e]))return;l=l._data[a[e]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];let d;return e=h._doInsert(l,o,e,s),void 0===s&&(s=c.length-1),n&&(d=h.silence()),h.emit(`${t}:insert`,e,s,r),h.emit("*:insert",t,e,s,r),n&&h.silenceRestore(d),!0}_doInsert(t,e,s,n,r=!1){const a=t._data[e];"object"!=typeof s||s instanceof i||null===s||(s=s instanceof Array?s.slice(0):new i(s));const o=t._path?`${t._path}.${e}`:e;if(null===s||r||this._pathsWithDuplicates&&this._pathsWithDuplicates[o]||-1===a.indexOf(s))return void 0===n?a.push(s):a.splice(n,0,s),s instanceof i?(s._parent=this,s._parentPath=o,s._parentField=a,s._parentKey=null):s=this.json(s),s}move(t,e,s,n=!1,r=!1){const a=i._splitPath(t),o=a[a.length-1];let l=this,h=this;for(let e=0;e<a.length-1;e++)if(l instanceof Array)l=l[parseInt(a[e],10)],l instanceof i&&(t=a.slice(e+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(a[e]))return;l=l._data[a[e]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];if(c.length<e||c.length<s||e===s)return;let d,u=c[e];return c.splice(e,1),-1===s&&(s=c.length),c.splice(s,0,u),u instanceof i||(u=h.json(u)),n&&(d=h.silence()),h.emit(`${t}:move`,u,s,e,r),h.emit("*:move",t,u,s,e,r),n&&h.silenceRestore(d),!0}patch(t,e=!1){if("object"==typeof t){for(const e in t)"object"!=typeof t[e]||this._data.hasOwnProperty(e)?this._data[e]!==t[e]&&this.set(e,t[e]):this._prepare(this,e,t[e]);if(e)for(const e in this._data)t.hasOwnProperty(e)||this.unset(e)}}json(t){let e,s,i={};const n=void 0===t?this:t;let r,a;if(n instanceof Object&&n._keys){r=n._keys.length;for(let t=0;t<r;t++){e=n._keys[t];const r=n._data[e],o=typeof r;if("object"===o&&r instanceof Array)for(i[e]=r.slice(0),a=i[e].length,s=0;s<a;s++)"object"==typeof i[e][s]&&(i[e][s]=this.json(i[e][s]));else i[e]="object"===o&&r instanceof Object?this.json(r):r}}else{if(null===n)return null;if("object"==typeof n&&n instanceof Array)for(i=n.slice(0),r=i.length,s=0;s<r;s++)i[s]=this.json(i[s]);else if("object"==typeof n)for(e in n)n.hasOwnProperty(e)&&(i[e]=n[e]);else i=n}return i}forEach(t,e,s=""){const i=e||this;for(let e=0;e<i._keys.length;e++){const n=i._keys[e],r=i._data[n],a=this.schema&&this.schema.has(s+n)&&this.schema.get(s+n).type.name.toLowerCase()||typeof r;"object"===a&&r instanceof Array?t(s+n,"array",r,n):"object"===a&&r instanceof Object?(t(s+n,"object",r,n),this.forEach(t,r,`${s+n}.`)):t(s+n,a,r,n)}}latest(){return this._latestFn?this._latestFn():this}destroy(){this._destroyed||(this._destroyed=!0,this.emit("destroy"),this.unbind())}set latestFn(t){this._latestFn=t}get latestFn(){return this._latestFn}}function n(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}i._splitPathsCache={};var r,a,o={exports:{}},l={};function h(){if(r)return l;r=1;var t=Symbol.for("react.element"),e=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),i=Symbol.for("react.strict_mode"),n=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),o=Symbol.for("react.context"),h=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),u=Symbol.for("react.lazy"),f=Symbol.iterator;var p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,_={};function g(t,e,s){this.props=t,this.context=e,this.refs=_,this.updater=s||p}function v(){}function b(t,e,s){this.props=t,this.context=e,this.refs=_,this.updater=s||p}g.prototype.isReactComponent={},g.prototype.setState=function(t,e){if("object"!=typeof t&&"function"!=typeof t&&null!=t)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,t,e,"setState")},g.prototype.forceUpdate=function(t){this.updater.enqueueForceUpdate(this,t,"forceUpdate")},v.prototype=g.prototype;var y=b.prototype=new v;y.constructor=b,m(y,g.prototype),y.isPureReactComponent=!0;var S=Array.isArray,x=Object.prototype.hasOwnProperty,w={current:null},T={key:!0,ref:!0,__self:!0,__source:!0};function E(e,s,i){var n,r={},a=null,o=null;if(null!=s)for(n in void 0!==s.ref&&(o=s.ref),void 0!==s.key&&(a=""+s.key),s)x.call(s,n)&&!T.hasOwnProperty(n)&&(r[n]=s[n]);var l=arguments.length-2;if(1===l)r.children=i;else if(1<l){for(var h=Array(l),c=0;c<l;c++)h[c]=arguments[c+2];r.children=h}if(e&&e.defaultProps)for(n in l=e.defaultProps)void 0===r[n]&&(r[n]=l[n]);return{$$typeof:t,type:e,key:a,ref:o,props:r,_owner:w.current}}function C(e){return"object"==typeof e&&null!==e&&e.$$typeof===t}var A=/\/+/g;function D(t,e){return"object"==typeof t&&null!==t&&null!=t.key?function(t){var e={"=":"=0",":":"=2"};return"$"+t.replace(/[=:]/g,(function(t){return e[t]}))}(""+t.key):e.toString(36)}function P(s,i,n,r,a){var o=typeof s;"undefined"!==o&&"boolean"!==o||(s=null);var l=!1;if(null===s)l=!0;else switch(o){case"string":case"number":l=!0;break;case"object":switch(s.$$typeof){case t:case e:l=!0}}if(l)return a=a(l=s),s=""===r?"."+D(l,0):r,S(a)?(n="",null!=s&&(n=s.replace(A,"$&/")+"/"),P(a,i,n,"",(function(t){return t}))):null!=a&&(C(a)&&(a=function(e,s){return{$$typeof:t,type:e.type,key:s,ref:e.ref,props:e.props,_owner:e._owner}}(a,n+(!a.key||l&&l.key===a.key?"":(""+a.key).replace(A,"$&/")+"/")+s)),i.push(a)),1;if(l=0,r=""===r?".":r+":",S(s))for(var h=0;h<s.length;h++){var c=r+D(o=s[h],h);l+=P(o,i,n,c,a)}else if(c=function(t){return null===t||"object"!=typeof t?null:"function"==typeof(t=f&&t[f]||t["@@iterator"])?t:null}(s),"function"==typeof c)for(s=c.call(s),h=0;!(o=s.next()).done;)l+=P(o=o.value,i,n,c=r+D(o,h++),a);else if("object"===o)throw i=String(s),Error("Objects are not valid as a React child (found: "+("[object Object]"===i?"object with keys {"+Object.keys(s).join(", ")+"}":i)+"). If you meant to render a collection of children, use an array instead.");return l}function L(t,e,s){if(null==t)return t;var i=[],n=0;return P(t,i,"","",(function(t){return e.call(s,t,n++)})),i}function I(t){if(-1===t._status){var e=t._result;(e=e()).then((function(e){0!==t._status&&-1!==t._status||(t._status=1,t._result=e)}),(function(e){0!==t._status&&-1!==t._status||(t._status=2,t._result=e)})),-1===t._status&&(t._status=0,t._result=e)}if(1===t._status)return t._result.default;throw t._result}var R={current:null},M={transition:null},k={ReactCurrentDispatcher:R,ReactCurrentBatchConfig:M,ReactCurrentOwner:w};function O(){throw Error("act(...) is not supported in production builds of React.")}return l.Children={map:L,forEach:function(t,e,s){L(t,(function(){e.apply(this,arguments)}),s)},count:function(t){var e=0;return L(t,(function(){e++})),e},toArray:function(t){return L(t,(function(t){return t}))||[]},only:function(t){if(!C(t))throw Error("React.Children.only expected to receive a single React element child.");return t}},l.Component=g,l.Fragment=s,l.Profiler=n,l.PureComponent=b,l.StrictMode=i,l.Suspense=c,l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=k,l.act=O,l.cloneElement=function(e,s,i){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var n=m({},e.props),r=e.key,a=e.ref,o=e._owner;if(null!=s){if(void 0!==s.ref&&(a=s.ref,o=w.current),void 0!==s.key&&(r=""+s.key),e.type&&e.type.defaultProps)var l=e.type.defaultProps;for(h in s)x.call(s,h)&&!T.hasOwnProperty(h)&&(n[h]=void 0===s[h]&&void 0!==l?l[h]:s[h])}var h=arguments.length-2;if(1===h)n.children=i;else if(1<h){l=Array(h);for(var c=0;c<h;c++)l[c]=arguments[c+2];n.children=l}return{$$typeof:t,type:e.type,key:r,ref:a,props:n,_owner:o}},l.createContext=function(t){return(t={$$typeof:o,_currentValue:t,_currentValue2:t,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:t},t.Consumer=t},l.createElement=E,l.createFactory=function(t){var e=E.bind(null,t);return e.type=t,e},l.createRef=function(){return{current:null}},l.forwardRef=function(t){return{$$typeof:h,render:t}},l.isValidElement=C,l.lazy=function(t){return{$$typeof:u,_payload:{_status:-1,_result:t},_init:I}},l.memo=function(t,e){return{$$typeof:d,type:t,compare:void 0===e?null:e}},l.startTransition=function(t){var e=M.transition;M.transition={};try{t()}finally{M.transition=e}},l.unstable_act=O,l.useCallback=function(t,e){return R.current.useCallback(t,e)},l.useContext=function(t){return R.current.useContext(t)},l.useDebugValue=function(){},l.useDeferredValue=function(t){return R.current.useDeferredValue(t)},l.useEffect=function(t,e){return R.current.useEffect(t,e)},l.useId=function(){return R.current.useId()},l.useImperativeHandle=function(t,e,s){return R.current.useImperativeHandle(t,e,s)},l.useInsertionEffect=function(t,e){return R.current.useInsertionEffect(t,e)},l.useLayoutEffect=function(t,e){return R.current.useLayoutEffect(t,e)},l.useMemo=function(t,e){return R.current.useMemo(t,e)},l.useReducer=function(t,e,s){return R.current.useReducer(t,e,s)},l.useRef=function(t){return R.current.useRef(t)},l.useState=function(t){return R.current.useState(t)},l.useSyncExternalStore=function(t,e,s){return R.current.useSyncExternalStore(t,e,s)},l.useTransition=function(){return R.current.useTransition()},l.version="18.3.1",l}function c(){return a||(a=1,o.exports=h()),o.exports}var d=c(),u=n(d);const f="pcui-collapsed",p="pcui-collapsible",m="pcui-disabled",_="pcui-error",g="flash",v="pcui-flex",b="pcui-focus",y="font-regular",S="font-bold",x="pcui-grid",w="pcui-hidden",T="pcui-multiple-values",E="pcui-not-flexible",C="pcui-readonly",A="pcui-resizable",D="pcui-scrollable",P=["flexDirection","flexGrow","flexBasis","flexShrink","flexWrap","alignItems","alignSelf","justifyContent","justifySelf"];let L=class t extends e{constructor(t={}){var e,s,i,n;if(super(),this._destroyed=!1,this._parent=null,this._eventsParent=[],this._flashTimeout=null,this._suppressChange=!1,this._onMouseOver=t=>{this.emit("hover",t)},this._onMouseOut=t=>{this.emit("hoverend",t)},"string"==typeof t.dom?this._dom=document.createElement(t.dom):t.dom instanceof Node?this._dom=t.dom:this._dom=document.createElement("div"),void 0!==t.id&&(this._dom.id=t.id),this._dom.ui=this,this._onClickEvt=this._onClick.bind(this),this._dom.addEventListener("click",this._onClickEvt),this._dom.addEventListener("mouseover",this._onMouseOver),this._dom.addEventListener("mouseout",this._onMouseOut),this._dom.classList.add("pcui-element",y),t.class){const e=Array.isArray(t.class)?t.class:[t.class];for(const t of e)this._dom.classList.add(t)}this.enabled=null===(e=t.enabled)||void 0===e||e,this._hiddenParents=!t.isRoot,this.hidden=null!==(s=t.hidden)&&void 0!==s&&s,this.readOnly=null!==(i=t.readOnly)&&void 0!==i&&i,this.ignoreParent=null!==(n=t.ignoreParent)&&void 0!==n&&n,void 0!==t.width&&(this.width=t.width),void 0!==t.height&&(this.height=t.height),void 0!==t.tabIndex&&(this.tabIndex=t.tabIndex);for(const e in t)void 0!==t[e]&&-1!==P.indexOf(e)&&(this[e]=t[e]);t.binding&&(this.binding=t.binding)}destroy(){if(this._destroyed)return;if(this._destroyed=!0,this.binding?this.binding=null:this.unlink(),this.parent){const t=this.parent;for(const t of this._eventsParent)t.unbind();this._eventsParent.length=0,t.remove&&!t._destroyed&&t.remove(this),this._parent=null,!t._destroyed&&this._dom&&this._dom.parentElement&&this._dom.parentElement.removeChild(this._dom)}const t=this._dom;t&&(t.removeEventListener("click",this._onClickEvt),t.removeEventListener("mouseover",this._onMouseOver),t.removeEventListener("mouseout",this._onMouseOut),delete t.ui,this._dom=null),this._flashTimeout&&window.clearTimeout(this._flashTimeout),this.emit("destroy",t,this),this.unbind()}link(t,e){this._binding&&this._binding.link(t,e)}unlink(){this._binding&&this._binding.unlink()}flash(){this._flashTimeout||(this.class.add(g),this._flashTimeout=window.setTimeout((()=>{this._flashTimeout=null,this.class.remove(g)}),200))}_onClick(t){this.enabled&&this.emit("click",t)}_onHiddenToRootChange(t){this.emit(t?"hideToRoot":"showToRoot")}_onEnabledChange(t){t?this.class.remove(m):this.class.add(m),this.emit(t?"enable":"disable")}_onParentDestroy(){this.destroy()}_onParentDisable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!1)}_onParentEnable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!0)}_onParentShowToRoot(){const t=this.hiddenToRoot;this._hiddenParents=!1,t!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onParentHideToRoot(){const t=this.hiddenToRoot;this._hiddenParents=!0,t!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onReadOnlyChange(t){t?this.class.add(C):this.class.remove(C),this.emit("readOnly",t)}_onParentReadOnlyChange(t){this._ignoreParent||(t?this._readOnly||this._onReadOnlyChange(!0):this._readOnly||this._onReadOnlyChange(!1))}static register(e,s,i){t.registry.set(e,{cls:s,defaultArguments:i})}static unregister(e){t.registry.delete(e)}static create(e,s){const i=t.registry.get(e);if(!i)return void console.error("Invalid type passed to Element.create:",e);return new(0,i.cls)(Object.assign(Object.assign({},i.defaultArguments),s))}set enabled(t){if(this._enabled===t)return;const e=this.enabled;this._enabled=t,e!==t&&this._onEnabledChange(t)}get enabled(){return this._ignoreParent?this._enabled:this._enabled&&(!this._parent||this._parent.enabled)}set ignoreParent(t){this._ignoreParent=t,this._onEnabledChange(this.enabled),this._onReadOnlyChange(this.readOnly)}get ignoreParent(){return this._ignoreParent}get dom(){return this._dom}set parent(t){if(t===this._parent)return;const e=this.enabled,s=this.readOnly,i=this.hiddenToRoot;if(this._parent){for(let t=0;t<this._eventsParent.length;t++)this._eventsParent[t].unbind();this._eventsParent.length=0}this._parent=t,this._parent?(this._eventsParent.push(this._parent.once("destroy",this._onParentDestroy.bind(this))),this._eventsParent.push(this._parent.on("disable",this._onParentDisable.bind(this))),this._eventsParent.push(this._parent.on("enable",this._onParentEnable.bind(this))),this._eventsParent.push(this._parent.on("readOnly",this._onParentReadOnlyChange.bind(this))),this._eventsParent.push(this._parent.on("showToRoot",this._onParentShowToRoot.bind(this))),this._eventsParent.push(this._parent.on("hideToRoot",this._onParentHideToRoot.bind(this))),this._hiddenParents=this._parent.hiddenToRoot):this._hiddenParents=!0,this.emit("parent",this._parent);const n=this.enabled;n!==e&&this._onEnabledChange(n);const r=this.readOnly;r!==s&&this._onReadOnlyChange(r);const a=this.hiddenToRoot;a!==i&&this._onHiddenToRootChange(a)}get parent(){return this._parent}set hidden(t){if(t===this._hidden)return;const e=this.hiddenToRoot;this._hidden=t,t?this.class.add(w):this.class.remove(w),this.emit(t?"hide":"show"),this.hiddenToRoot!==e&&this._onHiddenToRootChange(this.hiddenToRoot)}get hidden(){return this._hidden}get hiddenToRoot(){return this._hidden||this._hiddenParents}set readOnly(t){this._readOnly!==t&&(this._readOnly=t,this._onReadOnlyChange(t))}get readOnly(){return this._ignoreParent?this._readOnly:this._readOnly||!(!this._parent||!this._parent.readOnly)}set error(t){this._hasError!==t&&(this._hasError=t,t?this.class.add(_):this.class.remove(_))}get error(){return this._hasError}get style(){return this._dom.style}get class(){return this._dom.classList}set width(t){this.style.width="number"==typeof t?`${t}px`:t}get width(){return this._dom.clientWidth}set height(t){this.style.height="number"==typeof t?`${t}px`:t}get height(){return this._dom.clientHeight}set tabIndex(t){this._dom.tabIndex=t}get tabIndex(){return this._dom.tabIndex}set binding(t){if(this._binding===t)return;let e,s;this._binding&&(e=this._binding.observers,s=this._binding.paths,this.unlink(),this._binding.element=null,this._binding=null),this._binding=t,this._binding&&(this._binding.element=this,e&&s&&this.link(e,s))}get binding(){return this._binding}get destroyed(){return this._destroyed}set flexDirection(t){this.style.flexDirection=t}get flexDirection(){return this.style.flexDirection}set flexGrow(t){this.style.flexGrow=t}get flexGrow(){return this.style.flexGrow}set flexBasis(t){this.style.flexBasis=t}get flexBasis(){return this.style.flexBasis}set flexShrink(t){this.style.flexShrink=t}get flexShrink(){return this.style.flexShrink}set flexWrap(t){this.style.flexWrap=t}get flexWrap(){return this.style.flexWrap}set alignItems(t){this.style.alignItems=t}get alignItems(){return this.style.alignItems}set alignSelf(t){this.style.alignSelf=t}get alignSelf(){return this.style.alignSelf}set justifyContent(t){this.style.justifyContent=t}get justifyContent(){return this.style.justifyContent}set justifySelf(t){this.style.justifySelf=t}get justifySelf(){return this.style.justifySelf}set disabled(t){this.enabled=!t}get disabled(){return!this.enabled}set element(t){this._dom=t}get element(){return this.dom}set innerElement(t){this._domContent=t}get innerElement(){return this._domContent}};L.EVENT_ENABLE="enable",L.EVENT_DISABLE="disable",L.EVENT_HIDE="hide",L.EVENT_HIDE_TO_ROOT="hideToRoot",L.EVENT_SHOW="show",L.EVENT_SHOW_TO_ROOT="showToRoot",L.EVENT_READ_ONLY="readOnly",L.EVENT_PARENT="parent",L.EVENT_CLICK="click",L.EVENT_HOVER="hover",L.EVENT_HOVER_END="hoverend",L.EVENT_DESTROY="destroy",L.registry=new Map;let I=class extends d.Component{constructor(t){super(t),this.attachElement=(t,e)=>{if(!t)return;this.element=new this.elementClass(Object.assign(Object.assign({},this.props),{dom:t,content:e,parent:void 0}));const s=this.props.class;this.class=new Set(s?Array.isArray(s)?s.slice():[s]:void 0),this.onClick&&this.element.on("click",this.onClick),this.onRemove&&this.element.on("click:remove",this.onRemove),this.onChange&&this.element.on("change",this.onChange),this.props.parent&&(this.element.parent=this.props.parent),this.onAttach&&this.onAttach()},this.getPropertyDescriptor=(t,e)=>{let s;do{s=Object.getOwnPropertyDescriptor(t,e)}while(!s&&(t=Object.getPrototypeOf(t)));return s},this.elementClass=L,t.onClick&&(this.onClick=t.onClick),t.onRemove&&(this.onRemove=t.onRemove),t.onChange&&(this.onChange=t.onChange),t.link&&(this.link=t.link)}componentDidMount(){this.link&&this.element.link(this.link.observer,this.link.path)}componentDidUpdate(t){Object.keys(this.props).forEach((t=>{const e=this.getPropertyDescriptor(this.element,t);if(e&&e.set)"value"===t?(this.element._suppressChange=!0,this.element[t]=this.props[t],this.element._suppressChange=!1):this.element[t]=this.props[t];else if("class"===t){const e=this.props[t],s=new Set(e?Array.isArray(e)?e.slice():[e]:void 0);s.forEach((t=>{this.class.has(t)||(this.element.class.add(t),this.class.add(t))})),this.class.forEach((t=>{s.has(t)||(this.element.class.remove(t),this.class.delete(t))}))}})),t.link!==this.props.link&&this.props.link&&this.element.link(this.props.link.observer,this.props.link.path)}render(){return d.createElement("div",{ref:this.attachElement})}};let R=class extends L{constructor(t={}){super(Object.assign({dom:"button"},t)),this._onKeyDown=t=>{"Escape"===t.key?this.blur():"Enter"===t.key&&this._onClick(t)},this.class.add("pcui-button"),this._unsafe=t.unsafe,this.text=t.text,this.size=t.size,this.icon=t.icon,this.dom.addEventListener("keydown",this._onKeyDown)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),super.destroy())}_onClick(t){this.blur(),this.readOnly||super._onClick(t)}focus(){this.dom.focus()}blur(){this.dom.blur()}set text(t){this._text!==t&&(this._text=t,this._unsafe?this.dom.innerHTML=t:this.dom.textContent=t)}get text(){return this._text}set icon(t){this._icon!==t&&t.match(/^E\d{0,4}$/)&&(this._icon=t,t?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set size(t){this._size!==t&&(this._size&&(this.class.remove(`pcui-${this._size}`),this._size=null),this._size=t,this._size&&this.class.add(`pcui-${this._size}`))}get size(){return this._size}};L.register("button",R);const M=[null,"top","right","bottom","left"],k=`${A}-resizing`,O="pcui-container",F=`${O}-dragged`,N=`${F}-child`;let B=class extends L{constructor(t={}){var e;super(t),this._scrollable=!1,this._flex=!1,this._grid=!1,this._domResizeHandle=null,this._resizePointerId=null,this._resizeData=null,this._resizeHorizontally=!0,this._resizeMin=100,this._resizeMax=300,this._draggedStartIndex=-1,this._onScroll=t=>{this.emit("scroll",t)},this._onResizeStart=t=>{null===this._resizePointerId&&(t.preventDefault(),t.stopPropagation(),this._domResizeHandle.setPointerCapture(t.pointerId),this._resizePointerId=t.pointerId,this._resizeStart())},this._onResizeMove=t=>{this._resizePointerId===t.pointerId&&(t.preventDefault(),t.stopPropagation(),this._resizeMove(t.clientX,t.clientY))},this._onResizeEnd=t=>{this._resizePointerId===t.pointerId&&(t.preventDefault(),t.stopPropagation(),this._resizeEnd(),this._domResizeHandle.releasePointerCapture(t.pointerId),this._resizePointerId=null)},this.class.add(O),this.domContent=this._dom,t.scrollable&&(this.scrollable=!0),this.flex=!!t.flex;let s=!!t.grid;s&&this.flex&&(console.error('Invalid Container arguments: "grid" and "flex" cannot both be true.'),s=!1),this.grid=s,this.resizable=null!==(e=t.resizable)&&void 0!==e?e:null,void 0!==t.resizeMin&&(this.resizeMin=t.resizeMin),void 0!==t.resizeMax&&(this.resizeMax=t.resizeMax)}destroy(){this._destroyed||(this.domContent=null,this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd)),super.destroy())}append(t){const e=this._getDomFromElement(t);this._domContent.appendChild(e),this._onAppendChild(t)}appendBefore(t,e){const s=this._getDomFromElement(t);this._domContent.appendChild(s);const i=e&&this._getDomFromElement(e);this._domContent.insertBefore(s,i),this._onAppendChild(t)}appendAfter(t,e){const s=this._getDomFromElement(t),i=e&&this._getDomFromElement(e),n=i?i.nextSibling:null;n?this._domContent.insertBefore(s,n):this._domContent.appendChild(s),this._onAppendChild(t)}prepend(t){const e=this._getDomFromElement(t),s=this._domContent.firstChild;s?this._domContent.insertBefore(e,s):this._domContent.appendChild(e),this._onAppendChild(t)}remove(t){if(t.parent!==this)return;const e=this._getDomFromElement(t);this._domContent.removeChild(e),this._onRemoveChild(t)}move(t,e){const s=Array.prototype.indexOf.call(this.dom.childNodes,t.dom);-1===s?this.appendBefore(t,this.dom.childNodes[e]):e!==s&&(this.remove(t),e<s?this.appendBefore(t,this.dom.childNodes[e]):this.appendAfter(t,this.dom.childNodes[e-1]))}clear(){let t=this._domContent.childNodes.length;for(;t--;){const e=this._domContent.childNodes[t];e.ui&&e.ui!==this&&e.ui.destroy()}this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=null),this._domContent.innerHTML="",this.resizable&&(this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle))}_getDomFromElement(t){return t.dom?t.dom:t.element?t.element:t}_onAppendChild(t){t.parent=this,this.emit("append",t)}_onRemoveChild(t){t.parent=null,this.emit("remove",t)}_createResizeHandle(){const t=document.createElement("div");t.classList.add("pcui-resizable-handle"),t.ui=this,t.addEventListener("pointerdown",this._onResizeStart),t.addEventListener("pointermove",this._onResizeMove),t.addEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=t}_resizeStart(){this.class.add(k)}_resizeMove(t,e){if(this._resizeData){if(this._resizeHorizontally){let e=this._resizeData.x-t;"right"===this._resizable&&(e=-e),this.width=4+Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.width+e))}else{let t=this._resizeData.y-e;"bottom"===this._resizable&&(t=-t),this.height=Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.height+t))}this.emit("resize")}else this._resizeData={x:t,y:e,width:this.dom.clientWidth,height:this.dom.clientHeight}}_resizeEnd(){this._resizeData=null,this.class.remove(k)}resize(t=0,e=0){this._resizeStart(),this._resizeMove(0,0),this._resizeMove(4-t,-e),this._resizeEnd()}_getDraggedChildIndex(t){for(let e=0;e<this.dom.childNodes.length;e++)if(this.dom.childNodes[e].ui===t)return e;return-1}_onChildDragStart(t,e){this.class.add(N),this._draggedStartIndex=this._getDraggedChildIndex(e),e.class.add(F),this.emit("child:dragstart",e,this._draggedStartIndex)}_onChildDragMove(t,e){const s=this.dom.getBoundingClientRect(),i=t.clientX<s.left||t.clientX>s.right||t.clientY<s.top||t.clientY>s.bottom,n=this._getDraggedChildIndex(e);if(i)return e.class.remove(F),void(this._draggedStartIndex!==n&&(this.remove(e),this._draggedStartIndex<n?this.appendBefore(e,this.dom.childNodes[this._draggedStartIndex]):this.appendAfter(e,this.dom.childNodes[this._draggedStartIndex-1])));e.class.add(F);const r=t.clientY-s.top;let a=null;for(let t=0;t<this.dom.childNodes.length;t++){const s=this.dom.childNodes[t].ui,i=s.dom.offsetTop;if(t<n){if(r<=i+s.header.height){a=t;break}}else if(t>n&&r+e.height>=i+s.height){a=t;break}}null!==a&&n!==a&&(this.remove(e),a<n?this.appendBefore(e,this.dom.childNodes[a]):this.appendAfter(e,this.dom.childNodes[a-1]))}_onChildDragEnd(t,e){this.class.remove(N),e.class.remove(F);const s=this._getDraggedChildIndex(e);this.emit("child:dragend",e,s,this._draggedStartIndex),this._draggedStartIndex=-1}forEachChild(t){for(let e=0;e<this.dom.childNodes.length;e++){const s=this.dom.childNodes[e].ui;if(s){if(!1===t(s,e))break}}}_buildDomNode(t){const e=Object.keys(t);let s;return e.includes("root")?(s=this._buildDomNode(t.root),t.children.forEach((t=>{const e=this._buildDomNode(t);null!==e&&s.append(e)}))):(s=t[e[0]],this[`_${e[0]}`]=s),s}buildDom(t){t.forEach((t=>{const e=this._buildDomNode(t);this.append(e)}))}set flex(t){t!==this._flex&&(this._flex=t,t?this.class.add(v):this.class.remove(v))}get flex(){return this._flex}set grid(t){t!==this._grid&&(this._grid=t,t?this.class.add(x):this.class.remove(x))}get grid(){return this._grid}set scrollable(t){this._scrollable!==t&&(this._scrollable=t,t?this.class.add(D):this.class.remove(D))}get scrollable(){return this._scrollable}set resizable(t){t!==this._resizable&&(-1!==M.indexOf(t)?(this._resizable&&this.class.remove(`${A}-${this._resizable}`),this._resizable=t,this._resizeHorizontally="right"===t||"left"===t,t?(this.class.add(A),this.class.add(`${A}-${t}`),this._domResizeHandle||this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle)):(this.class.remove(A),this._domResizeHandle&&this._dom.removeChild(this._domResizeHandle))):console.error(`Invalid resizable value: must be one of ${M.join(",")}`))}get resizable(){return this._resizable}set resizeMin(t){this._resizeMin=Math.max(0,Math.min(t,this._resizeMax))}get resizeMin(){return this._resizeMin}set resizeMax(t){this._resizeMax=Math.max(this._resizeMin,t)}get resizeMax(){return this._resizeMax}set domContent(t){this._domContent!==t&&(this._domContent&&this._domContent.removeEventListener("scroll",this._onScroll),this._domContent=t,this._domContent&&this._domContent.addEventListener("scroll",this._onScroll))}get domContent(){return this._domContent}};B.EVENT_APPEND="append",B.EVENT_REMOVE="remove",B.EVENT_SCROLL="scroll",B.EVENT_RESIZE="resize",L.register("container",B);class U extends L{constructor(t={}){var e,s,i,n,r;super(t),this.blurOnEnter=!0,this.blurOnEscape=!0,this._onInputFocus=t=>{this.class.add(b),this.emit("focus",t),this._prevValue=this._domInput.value},this._onInputBlur=t=>{this.class.remove(b),this.emit("blur",t)},this._onInputKeyUp=t=>{"Escape"!==t.key&&this._onInputChange(t),this.emit("keyup",t)},this._onInputCtxMenu=t=>{this._domInput.select()},this._updateInputReadOnly=()=>{!this.enabled||this.readOnly?this._domInput.setAttribute("readonly","true"):this._domInput.removeAttribute("readonly")},this.class.add("pcui-input-element");let a=t.input;a||(a=document.createElement("input"),a.type="text"),a.ui=this,a.tabIndex=0,a.autocomplete="off",this._onInputKeyDownEvt=this._onInputKeyDown.bind(this),this._onInputChangeEvt=this._onInputChange.bind(this),a.addEventListener("change",this._onInputChangeEvt),a.addEventListener("keydown",this._onInputKeyDownEvt),a.addEventListener("focus",this._onInputFocus),a.addEventListener("blur",this._onInputBlur),a.addEventListener("contextmenu",this._onInputCtxMenu,!1),this.dom.appendChild(a),this._domInput=a,this._suspendInputChangeEvt=!1,void 0!==t.value&&(this._domInput.value=t.value),this.placeholder=null!==(e=t.placeholder)&&void 0!==e?e:"",this.renderChanges=null!==(s=t.renderChanges)&&void 0!==s&&s,this.blurOnEnter=null===(i=t.blurOnEnter)||void 0===i||i,this.blurOnEscape=null===(n=t.blurOnEscape)||void 0===n||n,this.keyChange=null!==(r=t.keyChange)&&void 0!==r&&r,this._prevValue=null,this.on("change",(()=>{this.renderChanges&&this.flash()})),this.on("disable",this._updateInputReadOnly),this.on("enable",this._updateInputReadOnly),this.on("readOnly",this._updateInputReadOnly),this._updateInputReadOnly()}destroy(){if(this._destroyed)return;const t=this._domInput;t.removeEventListener("change",this._onInputChangeEvt),t.removeEventListener("keydown",this._onInputKeyDownEvt),t.removeEventListener("focus",this._onInputFocus),t.removeEventListener("blur",this._onInputBlur),t.removeEventListener("keyup",this._onInputKeyUp),t.removeEventListener("contextmenu",this._onInputCtxMenu),super.destroy()}_onInputKeyDown(t){if("Enter"===t.key&&this.blurOnEnter)this._suspendInputChangeEvt=this.keyChange,this._domInput.blur(),this._suspendInputChangeEvt=!1;else if("Escape"===t.key){this._suspendInputChangeEvt=!0;const e=this._domInput.value;this._domInput.value=this._prevValue,this._suspendInputChangeEvt=!1,this.keyChange&&e!==this._prevValue&&this._onInputChange(t),this.blurOnEscape&&this._domInput.blur()}this.emit("keydown",t)}_onInputChange(t){}focus(t){this._domInput.focus(),t&&this._domInput.select()}blur(){this._domInput.blur()}set placeholder(t){t?this.dom.setAttribute("placeholder",t):this.dom.removeAttribute("placeholder")}get placeholder(){var t;return null!==(t=this.dom.getAttribute("placeholder"))&&void 0!==t?t:""}set keyChange(t){this._keyChange!==t&&(this._keyChange=t,t?this._domInput.addEventListener("keyup",this._onInputKeyUp):this._domInput.removeEventListener("keyup",this._onInputKeyUp))}get keyChange(){return this._keyChange}get input(){return this._domInput}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}}const z="pcui-numeric-input",V=`${z}-slider-control`,H=`${V}-active`,G=`${V}-hidden`,W=/,/g;let j=class extends U{constructor(t={}){var e,s,i,n;const r=Object.assign({},t);delete r.value,delete r.renderChanges,super(r),this._sliderUsed=!1,this._onSliderMouseWheel=t=>{this._updatePosition(t.deltaY,t.shiftKey)},this._onSliderMouseMove=t=>{this._updatePosition(t.movementX,t.shiftKey)},this._onSliderMouseDown=t=>{this._sliderControl.dom.requestPointerLock(),this._sliderMovement=0,this._sliderPrevValue=this.value,this._sliderUsed=!0,this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`),this.emit("slider:mousedown",t)},this._onSliderMouseUp=()=>{document.exitPointerLock(),this._sliderUsed&&(this._sliderUsed=!1,this.value=this._sliderPrevValue+this._sliderMovement,this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null),this.focus(),this.emit("slider:mouseup"))},this._onPointerLockChange=()=>{this._isScrolling()?(this._sliderControl.dom.addEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.addEventListener("wheel",this._onSliderMouseWheel,{passive:!0}),this._sliderControl.class.add(H)):(this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),this._sliderControl.class.remove(H))},this.class.add(z),this._min=null!==(e=t.min)&&void 0!==e?e:null,this._max=null!==(s=t.max)&&void 0!==s?s:null,this._allowNull=null!==(i=t.allowNull)&&void 0!==i&&i,this._precision=null!==(n=t.precision)&&void 0!==n?n:7,Number.isFinite(t.step)?this._step=t.step:t.precision?this._step=10/Math.pow(10,t.precision):this._step=1,Number.isFinite(t.stepPrecision)?this._stepPrecision=t.stepPrecision:this._stepPrecision=.1*this._step,this._oldValue=void 0,Number.isFinite(t.value)?this.value=t.value:this._allowNull||(this.value=0),this._historyCombine=!1,this._historyPostfix=null,this._sliderPrevValue=0,this.renderChanges=t.renderChanges,t.hideSlider||(this._sliderControl=new L,this._sliderControl.class.add(V),this.dom.append(this._sliderControl.dom),this._sliderControl.dom.addEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.addEventListener("mouseup",this._onSliderMouseUp),document.addEventListener("pointerlockchange",this._onPointerLockChange,!1))}destroy(){this.destroyed||(this._sliderControl&&(this._sliderControl.dom.removeEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.removeEventListener("mouseup",this._onSliderMouseUp),this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),document.removeEventListener("pointerlockchange",this._onPointerLockChange,!1)),super.destroy())}_updatePosition(t,e){this._sliderMovement+=t/100*(e?this._stepPrecision:this._step),this.value=this._sliderPrevValue+this._sliderMovement}_onInputChange(t){this.value=this._normalizeValue(this._domInput.value)}_onInputKeyDown(t){if(this.enabled&&!this.readOnly){if("ArrowUp"===t.key||"ArrowDown"===t.key){const e="ArrowDown"===t.key?-1:1;this.value+=(t.shiftKey?this._stepPrecision:this._step)*e}super._onInputKeyDown(t)}}_getPointerLockElementByShadowRoot(t){const e=t.shadowRoot;if(e){const t=e.pointerLockElement;return this._getPointerLockElementByShadowRoot(t)}return t===this._sliderControl.dom}_isScrolling(){return!!this._sliderControl&&(document.pointerLockElement&&document.pointerLockElement.shadowRoot?this._getPointerLockElementByShadowRoot(document.pointerLockElement):document.pointerLockElement===this._sliderControl.dom)}_normalizeValue(t){try{if("string"==typeof t){if("0"===t)return 0;if(null!==(t=(t=(t=t.replace(W,".")).replace(/\s/g,"")).match(/^[*/+\-0-9().]+$/))&&t[0].length<20){let e=t[0];["+","-","/","*"].forEach((t=>{const s=e.split(t);s.forEach(((t,e)=>{s[e]=s[e].replace(/^0+/,"")})),e=s.join(t)})),t=Function(`"use strict";return (${e})`)()}}if(null==t||""===t){if(this._allowNull)return null;t=0}if(t=Number(t),isNaN(t)){if(this._allowNull)return null;t=0}return null!==this.min&&t<this.min&&(t=this.min),null!==this.max&&t>this.max&&(t=this.max),null!==this.precision&&(t=parseFloat(Number(t).toFixed(this.precision))),t}catch(t){return this._allowNull?null:0}}_updateValue(t,e){const s=t!==this._oldValue||e;return this._oldValue=t,this._domInput.value=null===t?"":String(t),this.class.remove(T),s&&this.emit("change",t),s}set value(t){t=this._normalizeValue(t);const e=this.class.contains(T)&&null===t&&this._allowNull;this._updateValue(t,e)&&this.binding&&this.binding.setValue(t),this._sliderControl&&this._sliderControl.class.remove(G)}get value(){const t=this._domInput.value;return""!==t?parseFloat(t):null}set values(t){const e=t.map((t=>this._normalizeValue(t))),s=e.some((t=>t!==e[0]));s?(this._updateValue(null),this.class.add(T),this._sliderControl&&this._sliderControl.class.add(G)):(this._updateValue(e[0]),this._sliderControl&&this._sliderControl.class.remove(G))}set min(t){this._min!==t&&(this._min=t,null!==this._min&&(this.value=this.value))}get min(){return this._min}set max(t){this._max!==t&&(this._max=t,null!==this._max&&(this.value=this.value))}get max(){return this._max}set precision(t){this._precision!==t&&(this._precision=t,null!==this._precision&&(this.value=this.value))}get precision(){return this._precision}set step(t){this._step=t}get step(){return this._step}};L.register("number",j,{renderChanges:!0});let X=class extends L{constructor(t={}){var e,s,i;super(Object.assign({dom:"span"},t)),this.class.add("pcui-label"),this._unsafe=null!==(e=t.unsafe)&&void 0!==e&&e,this.text=null!==(i=null!==(s=t.text)&&void 0!==s?s:t.value)&&void 0!==i?i:"",t.allowTextSelection&&this.class.add("pcui-default-mousedown"),t.nativeTooltip&&(this.dom.title=this.text),this.placeholder=t.placeholder,this.renderChanges=t.renderChanges,this.on("change",(()=>{this.renderChanges&&this.flash()}))}_updateText(t){return this.class.remove(T),this._text!==t&&(this._text=t,this._unsafe?this._dom.innerHTML=t:this._dom.textContent=t,this.emit("change",t),!0)}set text(t){null==t&&(t="");this._updateText(t)&&this._binding&&this._binding.setValue(t)}get text(){return this._text}set value(t){this.text=t}get value(){return this.text}set values(t){const e=t.some((e=>e!==t[0]));e?(this._updateText(""),this.class.add(T)):this._updateText(t[0])}set placeholder(t){t?this.dom.setAttribute("placeholder",t):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};L.register("label",X);const $="pcui-panel",q=`${$}-header`,K=`${q}-title`,Y=`${$}-content`,Q=`${$}-horizontal`,Z=`${$}-sortable-icon`,J=`${$}-remove`;let tt=class extends B{constructor(t={}){var e,s,i,n,r;const a=Object.assign(Object.assign({},t),{flex:!0});delete a.grid,delete a.flexDirection,delete a.scrollable,super(a),this._reflowTimeout=null,this._widthBeforeCollapse=null,this._heightBeforeCollapse=null,this._iconSort=null,this._btnRemove=null,this._onHeaderClick=t=>{this._collapsible&&(t.target!==this.header.dom&&t.target!==this._labelTitle.dom||(this.collapsed=!this.collapsed))},this._onDragStart=t=>{this.enabled&&!this.readOnly&&(t.stopPropagation(),t.preventDefault(),window.addEventListener("mouseup",this._onDragEndEvt),window.addEventListener("mouseleave",this._onDragEndEvt),window.addEventListener("mousemove",this._onDragMove),this.emit("dragstart"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragStart(t,this))},this._onDragMove=t=>{this.emit("dragmove"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragMove(t,this)},this.class.add($),t.panelType&&this.class.add(`${$}-${t.panelType}`),this._suspendReflow=!0,this._initializeHeader(t),this._initializeContent(t),this.headerSize=null!==(e=t.headerSize)&&void 0!==e?e:32,this.collapsible=null!==(s=t.collapsible)&&void 0!==s&&s,this.collapsed=null!==(i=t.collapsed)&&void 0!==i&&i,this.collapseHorizontally=null!==(n=t.collapseHorizontally)&&void 0!==n&&n,this.sortable=null!==(r=t.sortable)&&void 0!==r&&r,this.removable=t.removable||!!t.onRemove||!1,this.domContent=this._containerContent.dom,this._suspendReflow=!1,this._reflow(),this._onDragEndEvt=this._onDragEnd.bind(this)}destroy(){this._destroyed||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),super.destroy())}_initializeHeader(t){this._containerHeader=new B({flex:!0,flexDirection:"row",class:[q,S]}),this._labelTitle=new X({text:t.headerText,class:[K,S]}),this._containerHeader.append(this._labelTitle),this._containerHeader.dom.addEventListener("click",this._onHeaderClick),this.append(this._containerHeader)}_onClickRemove(t){t.preventDefault(),t.stopPropagation(),this.emit("click:remove")}_initializeContent(t){this._containerContent=new B({class:Y,grid:t.grid,flex:t.flex,flexDirection:t.flexDirection,scrollable:t.scrollable,dom:t.content}),this.append(this._containerContent)}_reflow(){this._suspendReflow||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),!this.hidden&&this.collapsible&&(this.collapsed&&this.collapseHorizontally?this._containerHeader.style.top=-this.headerSize+"px":this._containerHeader.style.top="",this._reflowTimeout=requestAnimationFrame((()=>{this._reflowTimeout=null,this.collapsed?(this._widthBeforeCollapse||(this._widthBeforeCollapse=this.style.width),this._heightBeforeCollapse||(this._heightBeforeCollapse=this.style.height),this._collapseHorizontally?(this.height="",this.width=this.headerSize):this.height=this.headerSize,this.class.add(f)):(this.class.remove(f),this._collapseHorizontally?(this.height="",null!==this._widthBeforeCollapse&&(this.width=this._widthBeforeCollapse)):null!==this._heightBeforeCollapse&&(this.height=this._heightBeforeCollapse),this._widthBeforeCollapse=null,this._heightBeforeCollapse=null)}))))}_onDragEnd(t){window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),this._draggedChild===this&&(this._draggedChild=null),this.emit("dragend"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragEnd(t,this)}set collapsible(t){t!==this._collapsible&&(this._collapsible=t,t?this.class.add(p):this.class.remove(p),this._reflow(),this.collapsed&&this.emit(t?"collapse":"expand"))}get collapsible(){return this._collapsible}set collapsed(t){this._collapsed!==t&&(this._collapsed=t,this._reflow(),this.collapsible&&this.emit(t?"collapse":"expand"))}get collapsed(){return this._collapsed}set sortable(t){this._sortable!==t&&(this._sortable=t,t?(this._iconSort=new X({class:Z}),this._iconSort.dom.addEventListener("mousedown",this._onDragStart),this.header.prepend(this._iconSort)):this._iconSort&&(this._iconSort.destroy(),this._iconSort=null))}get sortable(){return this._sortable}set removable(t){this.removable!==t&&(t?(this._btnRemove=new R({icon:"E289",class:J}),this._btnRemove.on("click",this._onClickRemove.bind(this)),this.header.append(this._btnRemove)):(this._btnRemove.destroy(),this._btnRemove=null))}get removable(){return!!this._btnRemove}set collapseHorizontally(t){this._collapseHorizontally!==t&&(this._collapseHorizontally=t,t?this.class.add(Q):this.class.remove(Q),this._reflow())}get collapseHorizontally(){return this._collapseHorizontally}get content(){return this._containerContent}get header(){return this._containerHeader}set headerText(t){this._labelTitle.text=t}get headerText(){return this._labelTitle.text}set headerSize(t){this._headerSize=t;const e=this._containerHeader.dom.style;e.height=`${Math.max(0,t)}px`,e.lineHeight=e.height,this._reflow()}get headerSize(){return this._headerSize}};tt.EVENT_COLLAPSE="collapse",tt.EVENT_EXPAND="expand",L.register("panel",tt);const et="pcui-boolean-input",st=`${et}-ticked`,it=`${et}-toggle`;let nt=class extends L{constructor(t={}){var e;super(Object.assign({tabIndex:0},t)),this._onKeyDown=t=>{"Escape"!==t.key?this.enabled&&!this.readOnly&&" "===t.key&&(t.stopPropagation(),t.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},"toggle"===t.type?this.class.add(it):this.class.add(et),this.class.add(E),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this._value=null,void 0!==t.value&&(this.value=t.value),this.renderChanges=null!==(e=t.renderChanges)&&void 0!==e&&e}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(t){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(t)}_updateValue(t){return this.class.remove(T),t!==this.value&&(this._value=t,t?this.class.add(st):this.class.remove(st),this.renderChanges&&this.flash(),this.emit("change",t),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(t){this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._value}set values(t){const e=t.some((e=>e!==t[0]));e?(this._updateValue(null),this.class.add(T)):this._updateValue(t[0])}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};L.register("boolean",nt,{renderChanges:!0});class rt extends I{constructor(t={}){super(t),this.elementClass=nt}render(){return super.render()}}rt.ctor=nt;class at extends I{constructor(t={}){super(t),this.elementClass=R}render(){return d.createElement("button",{ref:this.attachElement})}}function ot(t){const e=t[0]/255,s=t[1]/255,i=t[2]/255;let n,r;const a=Math.max(e,s,i),o=a-Math.min(e,s,i),l=t=>(a-t)/6/o+.5;if(0===o)return n=r=0,[n,r,a];r=o/a;const h=l(e),c=l(s),d=l(i);return e===a?n=d-c:s===a?n=1/3+h-d:i===a&&(n=2/3+c-h),n<0?n+=1:n>1&&(n-=1),[n,r,a]}function lt(t){const e=t[0],s=t[1],i=t[2];let n,r,a;const o=Math.floor(6*e),l=6*e-o,h=i*(1-s),c=i*(1-l*s),d=i*(1-(1-l)*s);switch(o%6){case 0:n=i,r=d,a=h;break;case 1:n=c,r=i,a=h;break;case 2:n=h,r=i,a=d;break;case 3:n=h,r=c,a=i;break;case 4:n=d,r=h,a=i;break;case 5:n=i,r=h,a=c}return[Math.round(255*n),Math.round(255*r),Math.round(255*a)]}at.ctor=R;const ht="pcui-overlay",ct=`${ht}-inner`,dt=`${ht}-clickable`,ut=`${ht}-transparent`,ft=`${ht}-content`;let pt=class extends B{constructor(t={}){var e,s;super(t),this._onPointerDown=t=>{this.clickable&&!this.domContent.contains(t.target)&&(document.body.blur(),requestAnimationFrame((()=>{this.hidden=!0})),t.preventDefault(),t.stopPropagation())},this.class.add(ht),this._domClickableOverlay=document.createElement("div"),this._domClickableOverlay.ui=this,this._domClickableOverlay.classList.add(ct),this.dom.appendChild(this._domClickableOverlay),this.on("show",(()=>{document.body.addEventListener("pointerdown",this._onPointerDown,!0)})),this.on("hide",(()=>{document.body.removeEventListener("pointerdown",this._onPointerDown,!0)})),this.domContent=document.createElement("div"),this.domContent.ui=this,this.domContent.classList.add(ft),this.dom.appendChild(this.domContent),this.clickable=null!==(e=t.clickable)&&void 0!==e&&e,this.transparent=null!==(s=t.transparent)&&void 0!==s&&s}destroy(){this._destroyed||super.destroy()}position(t,e){const s=this._domClickableOverlay.getBoundingClientRect(),i=this.domContent.getBoundingClientRect();t=Math.max(0,Math.min(s.width-i.width,t)),e=Math.max(0,Math.min(s.height-i.height,e)),this.domContent.style.position="absolute",this.domContent.style.left=`${t}px`,this.domContent.style.top=`${e}px`}set clickable(t){t?this.class.add(dt):this.class.remove(dt)}get clickable(){return this.class.contains(dt)}set transparent(t){t?this.class.add(ut):this.class.remove(ut)}get transparent(){return this.class.contains(ut)}};L.register("overlay",pt);let mt=class extends U{constructor(t={}){super(t),this.class.add("pcui-text-input"),t.onValidate&&(this.onValidate=t.onValidate)}_onInputChange(t){if(!this._suspendInputChangeEvt){if(this.onValidate){const t=!this.onValidate(this.value);if(this.error=t,t)return}else this.error=!1;this.emit("change",this.value),this._binding&&this._binding.setValue(this.value)}}_updateValue(t){if(this.class.remove(T),t&&"object"==typeof t)if(Array.isArray(t)){let e=!1;for(let s=0;s<t.length;s++)if(t[s]&&"object"==typeof t[s]){e=!0;break}t=e?"[Not available]":t.map((t=>null===t?"null":t)).join(",")}else t="[Not available]";return t!==this.value&&(this._suspendInputChangeEvt=!0,this._domInput.value=null==t?"":String(t),this._suspendInputChangeEvt=!1,this.emit("change",t),!0)}set value(t){const e=this._updateValue(t);e&&(this.error=!1),e&&this._binding&&this._binding.setValue(t)}get value(){return this._domInput.value}set values(t){const e=t.some((e=>e!==t[0]));e?(this._updateValue(null),this.class.add(T)):this._updateValue(t[0])}};L.register("string",mt,{renderChanges:!0});let _t=class extends L{constructor(t={}){var e,s,i;super(t),this._historyCombine=!1,this._historyPostfix=null,this._size=144,this._directInput=!0,this._colorHSV=[0,0,0],this._pickerChannels=[],this._channelsNumber=4,this._changing=!1,this._dragging=!1,this._callingCallback=!1,this._pickRectPointerId=null,this._pickHuePointerId=null,this._pickOpacityPointerId=null,this._evtColorPick=null,this._evtColorToPicker=null,this._evtColorPickStart=null,this._evtColorPickEnd=null,this._onKeyDown=t=>{"Escape"===t.key&&this.blur(),"Enter"===t.key&&this.enabled&&!this.readOnly&&(t.stopPropagation(),t.preventDefault())},this._onFocus=t=>{this.emit("focus")},this._onBlur=t=>{this.emit("blur")},this._pickRectPointerDown=t=>{null===this._pickRectPointerId&&(this._pickRect.setPointerCapture(t.pointerId),this._pickRectPointerId=t.pointerId,t.preventDefault(),t.stopPropagation(),this.emit("picker:color:start"),this._pickRectPointerMove(t))},this._pickRectPointerMove=t=>{if(this._pickRectPointerId!==t.pointerId)return;this._changing=!0;const e=this._pickRect.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(t.clientX-e.left))),i=Math.max(0,Math.min(this._size,Math.floor(t.clientY-e.top)));this._colorHSV[1]=s/this._size,this._colorHSV[2]=1-i/this._size,this._directInput=!1;const n=lt(this._colorHSV);for(let t=0;t<3;t++)this._pickerChannels[t].value=n[t];this._fieldHex.value=this._getHex(),this._directInput=!0,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,s))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,i))}px`,this._changing=!1},this._pickRectPointerUp=t=>{this._pickRectPointerId===t.pointerId&&(this.emit("picker:color:end"),this._pickRect.releasePointerCapture(t.pointerId),this._pickRectPointerId=null)},this._pickHuePointerDown=t=>{null===this._pickHuePointerId&&(this._pickHue.setPointerCapture(t.pointerId),this._pickHuePointerId=t.pointerId,t.preventDefault(),t.stopPropagation(),this.emit("picker:color:start"),this._pickHuePointerMove(t))},this._pickHuePointerMove=t=>{if(this._pickHuePointerId!==t.pointerId)return;this._changing=!0;const e=this._pickHue.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(t.clientY-e.top)))/this._size,i=lt([s,this._colorHSV[1],this._colorHSV[2]]);this._colorHSV[0]=s,this._directInput=!1;for(let t=0;t<3;t++)this._pickerChannels[t].value=i[t];this._fieldHex.value=this._getHex(),this._onChangeRgb(),this._directInput=!0,this._changing=!1},this._pickHuePointerUp=t=>{this._pickHuePointerId===t.pointerId&&(this.emit("picker:color:end"),this._pickHue.releasePointerCapture(t.pointerId),this._pickHuePointerId=null)},this._pickOpacityPointerDown=t=>{null===this._pickOpacityPointerId&&(this._pickOpacity.setPointerCapture(t.pointerId),this._pickOpacityPointerId=t.pointerId,t.preventDefault(),t.stopPropagation(),this.emit("picker:color:start"),this._pickOpacityPointerMove(t))},this._pickOpacityPointerMove=t=>{if(this._pickOpacityPointerId!==t.pointerId)return;this._changing=!0;const e=this._pickOpacity.getBoundingClientRect(),s=1-Math.max(0,Math.min(this._size,Math.floor(t.clientY-e.top)))/this._size;this._directInput=!1,this._pickerChannels[3].value=Math.max(0,Math.min(255,Math.round(255*s))),this._fieldHex.value=this._getHex(),this._directInput=!0,this._changing=!1},this._pickOpacityPointerUp=t=>{this._pickOpacityPointerId===t.pointerId&&(this.emit("picker:color:end"),this._pickOpacity.releasePointerCapture(t.pointerId),this._pickOpacityPointerId=null)},this.class.add("pcui-color-input",E),this._domColor=document.createElement("div"),this.dom.appendChild(this._domColor),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.dom.addEventListener("pointerdown",(t=>{this.enabled&&!this.readOnly&&this._overlay.hidden&&(this._openColorPicker(),t.stopPropagation(),t.preventDefault())})),this._value=null!==(e=t.value)&&void 0!==e?e:[0,0,255,1],this._channels=null!==(s=t.channels)&&void 0!==s?s:3,this._setValue(this._value),this.renderChanges=null!==(i=t.renderChanges)&&void 0!==i&&i,this.on("change",(()=>{this.renderChanges&&this.flash()})),this._overlay=new pt({class:"picker-color",clickable:!0,hidden:!0,transparent:!0}),this.dom.appendChild(this._overlay.dom),this._pickRect=document.createElement("div"),this._pickRect.classList.add("pick-rect"),this._overlay.append(this._pickRect),this._pickRect.addEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.addEventListener("pointermove",this._pickRectPointerMove),this._pickRect.addEventListener("pointerup",this._pickRectPointerUp),this._pickRectWhite=document.createElement("div"),this._pickRectWhite.classList.add("white"),this._pickRect.appendChild(this._pickRectWhite),this._pickRectBlack=document.createElement("div"),this._pickRectBlack.classList.add("black"),this._pickRect.appendChild(this._pickRectBlack),this._pickRectHandle=document.createElement("div"),this._pickRectHandle.classList.add("handle"),this._pickRect.appendChild(this._pickRectHandle),this._pickHue=document.createElement("div"),this._pickHue.classList.add("pick-hue"),this._overlay.append(this._pickHue),this._pickHue.addEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.addEventListener("pointermove",this._pickHuePointerMove),this._pickHue.addEventListener("pointerup",this._pickHuePointerUp),this._pickHueHandle=document.createElement("div"),this._pickHueHandle.classList.add("handle"),this._pickHue.appendChild(this._pickHueHandle),this._pickOpacity=document.createElement("div"),this._pickOpacity.classList.add("pick-opacity"),this._overlay.append(this._pickOpacity),this._pickOpacity.addEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.addEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.addEventListener("pointerup",this._pickOpacityPointerUp),this._pickOpacityHandle=document.createElement("div"),this._pickOpacityHandle.classList.add("handle"),this._pickOpacity.appendChild(this._pickOpacityHandle),this._panelFields=document.createElement("div"),this._panelFields.classList.add("fields"),this._overlay.append(this._panelFields),this._overlay.on("hide",(()=>{this._evtColorPick.unbind(),this._evtColorPick=null,this._evtColorToPicker.unbind(),this._evtColorToPicker=null,this._evtColorPickStart.unbind(),this._evtColorPickStart=null,this._evtColorPickEnd.unbind(),this._evtColorPickEnd=null}));const n=t=>new j({class:["field",`field-${t}`],precision:0,step:1,min:0,max:255,placeholder:t}),r=n("r");r.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(r),this._panelFields.appendChild(r.dom);const a=n("g");a.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(a),this._panelFields.appendChild(a.dom);const o=n("b");o.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(o),this._panelFields.appendChild(o.dom);const l=n("a");l.on("change",(t=>{this._onChangeAlpha(t)})),this._pickerChannels.push(l),this._panelFields.appendChild(l.dom),this._fieldHex=new mt({class:["field","field-hex"],placeholder:"#"}),this._fieldHex.on("change",(()=>{this._onChangeHex()})),this._panelFields.appendChild(this._fieldHex.dom)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),this._pickRect.removeEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.removeEventListener("pointermove",this._pickRectPointerMove),this._pickRect.removeEventListener("pointerup",this._pickRectPointerUp),this._pickHue.removeEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.removeEventListener("pointermove",this._pickHuePointerMove),this._pickHue.removeEventListener("pointerup",this._pickHuePointerUp),this._pickOpacity.removeEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.removeEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.removeEventListener("pointerup",this._pickOpacityPointerUp),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}_setColorPickerPosition(t,e){this._overlay.position(t,e)}_setPickerColor(t){if(!this._changing&&!this._dragging){if(this._channelsNumber>=3){const e=ot(t);this._colorHSV[0]=e[0],this._colorHSV[1]=e[1],this._colorHSV[2]=e[2]}this._directInput=!1;for(let e=0;e<t.length;e++)this._pickerChannels[e].value=t[e];this._fieldHex.value=this._getHex(),this._directInput=!0}}_openColorPicker(){this._callPicker(this.value.map((t=>Math.floor(255*t)))),this._evtColorPick=this.on("picker:color",(t=>{this.value=t.map((t=>t/255))})),this._evtColorPickStart=this.on("picker:color:start",(()=>{this.binding?(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this._binding.historyPostfix=`(${Date.now()})`):(this._historyCombine=!1,this._historyPostfix=null)})),this._evtColorPickEnd=this.on("picker:color:end",(()=>{this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix)}));const t=this._overlay.dom.getBoundingClientRect(),e=this.dom.getBoundingClientRect();this._setColorPickerPosition(e.left-t.left,e.bottom-t.top+1),this._evtColorToPicker=this.on("change",(()=>{this._setPickerColor(this.value.map((t=>Math.floor(255*t))))}))}_callPicker(t){for(let e=0;e<4;e++)t.length-1<e?this._overlay.class.remove(`c-${e+1}`):this._overlay.class.add(`c-${e+1}`);if(this._channelsNumber=t.length,this._channelsNumber>=3){const e=ot(t);this._colorHSV[0]=e[0],this._colorHSV[1]=e[1],this._colorHSV[2]=e[2]}this._directInput=!1;for(let e=0;e<t.length;e++)this._pickerChannels[e].value=t[e];this._fieldHex.value=this._getHex(),this._directInput=!0,this._overlay.hidden=!1,this._fieldHex.dom.focus(),window.setTimeout((()=>{this._fieldHex.dom.focus()}),100)}_valueToColor(t){return t=Math.floor(255*t),Math.max(0,Math.min(t,255))}_setValue(t){const e=this._valueToColor(t[0]),s=this._valueToColor(t[1]),i=this._valueToColor(t[2]),n=t[3];1===this._channels?this._domColor.style.backgroundColor=`rgb(${e}, ${e}, ${e})`:3===this._channels?this._domColor.style.backgroundColor=`rgb(${e}, ${s}, ${i})`:4===this._channels&&(this._domColor.style.backgroundColor=`rgba(${e}, ${s}, ${i}, ${n})`)}_updateValue(t){let e=!1;for(let s=0;s<t.length;s++)this._value[s]!==t[s]&&(e=!0,this._value[s]=t[s]);return this.class.remove(T),e&&(this._setValue(t),this.emit("change",t)),e}_getHex(){let t="";for(let e=0;e<this._channelsNumber;e++)t+=`00${this._pickerChannels[e].value.toString(16)}`.slice(-2).toUpperCase();return t}_onChangeHex(){if(!this._directInput)return;this._changing=!0;const t=this._fieldHex.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(t))for(let e=0;e<this._channelsNumber;e++)this._pickerChannels[e].value=parseInt(t.slice(2*e,2*e+2),16);this._changing=!1}_onChangeRgb(){const t=this._pickerChannels.map((t=>t.value||0)).slice(0,this._channelsNumber),e=ot(t);if(this._directInput){const s=t[0]+t[1]+t[2];765!==s&&0!==s&&(this._colorHSV[0]=e[0]),this._colorHSV[1]=e[1],this._colorHSV[2]=e[2],this._dragging=!0,this.emit("picker:color:start"),this._fieldHex.value=this._getHex()}if(this._pickHueHandle.style.top=`${Math.floor(this._size*this._colorHSV[0])}px`,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,this._size*this._colorHSV[1]))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,this._size*(1-this._colorHSV[2])))}px`,this._channelsNumber>=3){const e=lt([this._colorHSV[0],1,1]).join(",");this._pickRect.style.backgroundColor=`rgb(${e})`,this._pickRectHandle.style.backgroundColor=`rgb(${t.slice(0,3).join(",")})`,this._pickHueHandle.style.backgroundColor=`rgb(${e})`}this.callCallback()}_onChangeAlpha(t){4===this._channelsNumber&&(this._pickOpacityHandle.style.top=`${Math.floor(this._size*(1-Math.max(0,Math.min(255,t))/255))}px`,this._pickOpacityHandle.style.backgroundColor=`rgb(${t}, ${t}, ${t})`,this.callCallback())}callbackHandle(){this._callingCallback=!1,this.emit("picker:color",this._pickerChannels.map((t=>t.value||0)).slice(0,this._channelsNumber))}callCallback(){this._callingCallback||(this._callingCallback=!0,window.setTimeout((()=>{this.callbackHandle()}),1e3/60))}set value(t){t=t||[0,0,0,0];this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._value.slice(0,this._channels)}set values(t){let e=!1;const s=t[0];for(let i=1;i<t.length;i++)if(Array.isArray(s)){if(!s.equals(t[i])){e=!0;break}}else if(s!==t[i]){e=!0;break}e?(this.value=null,this.class.add(T)):this.value=t[0]}set channels(t){this._channels!==t&&(this._channels=Math.max(0,Math.min(t,4)),this._setValue(this.value))}get channels(){return this._channels}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};L.register("rgb",_t),L.register("rgba",_t,{channels:4});class gt extends I{constructor(t){super(t),this.elementClass=_t}render(){return d.createElement("div",{ref:this.attachElement})}}gt.ctor=_t;class vt extends I{constructor(t={}){super(t),this.getParent=()=>this,this.elementClass=B}componentDidMount(){this.props.onResize&&this.element.on("resize",this.props.onResize)}render(){const t=Array.from(d.Children.toArray(this.props.children));let e;return 1===t.length?e=d.cloneElement(t[0],{parent:this.element}):t.length>0&&(e=t.map((t=>d.cloneElement(t,{parent:this.element})))),d.createElement("div",{ref:this.attachElement},e)}}vt.ctor=B;const bt=(t,e)=>{if(0===t.length)return e.length;if(0===e.length)return t.length;if(t===e)return 0;const s=[];for(let t=0;t<=e.length;t++)s[t]=[t];for(let e=0;e<=t.length;e++)s[0][e]=e;for(let i=1;i<=e.length;i++)for(let n=1;n<=t.length;n++)e.charAt(i-1)===t.charAt(n-1)?s[i][n]=s[i-1][n-1]:s[i][n]=Math.min(s[i-1][n-1]+1,Math.min(s[i][n-1]+1,s[i-1][n]+1));return s[e.length][t.length]},yt=(t,e)=>{if(t===e)return t.length;let s=0;const i=new Set;for(let t=0;t<e.length;t++)i.add(e.charAt(t));for(let e=0;e<t.length;e++)i.has(t.charAt(e))&&s++;return s},St=t=>{const e=[],s=t.replace(/([^A-Z])([A-Z][^A-Z])/g,"$1 $2").replace(/([A-Z0-9]{2,})/g," $1").split(/([\s\-_])/);for(let t=0;t<s.length;t++)s[t]=s[t].toLowerCase().trim(),s[t]&&"-"!==s[t]&&"_"!==s[t]&&e.push(s[t]);return e},xt=(t,e,s)=>{const i=[];for(const n of t){if(n.subFull!==1/0){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=n.subFull);continue}if(n.name===e||0===n.name.indexOf(e)){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=0);continue}if(yt(e,n.name)/e.length<s.containsCharsTolerance)continue;let t=1/0,r=1/0;for(let i=0;i<n.tokens.length;i++){if(n.tokens[i]===e){t=0,r=i;break}const a=bt(e,n.tokens[i]);(r===1/0||a<t)&&-1!==n.tokens[i].indexOf(e)?(r=i,t=a):r===1/0&&a<t&&a/Math.max(e.length,n.tokens[i].length)<=s.editsDistanceTolerance&&(t=a)}t!==1/0&&(i.push(n),n.edits=n.edits===1/0?t:n.edits+t,n.sub=n.sub===1/0?r:n.sub+r)}return i},wt=(t,e,s="",i={})=>{var n,r;if(!(s=s.toLowerCase().trim()))return[];const a=St(s);if(!a.length)return[];i.containsCharsTolerance=null!==(n=i.containsCharsTolerance)&&void 0!==n?n:.5,i.editsDistanceTolerance=null!==(r=i.editsDistanceTolerance)&&void 0!==r?r:.5;let o=t.map((t=>{const i=t[e].toLowerCase().trim().indexOf(s);return{name:t[e],item:t,tokens:St(t[e]),edits:1/0,subFull:-1!==i?i:1/0,sub:1/0}}));for(let t=0;t<a.length;t++)o=xt(o,a[t],i);o.sort(((t,e)=>t.subFull!==e.subFull?t.subFull-e.subFull:t.sub!==e.sub?t.sub-e.sub:t.edits!==e.edits?t.edits-e.edits:t.name.length-e.name.length));let l=o.map((t=>t.item));return i.hasOwnProperty("limitResults")&&l.length>i.limitResults&&(l=l.slice(0,i.limitResults)),l},Tt="pcui-select-input",Et=`${Tt}-container-value`,Ct=`${Tt}-multi`,At=`${Tt}-disabled-value`,Dt=`${Tt}-has-disabled-value`,Pt=`${Tt}-value`,Lt=`${Tt}-icon`,It=`${Tt}-textinput`,Rt=`${Tt}-list`,Mt=`${Tt}-tags`,kt=`${Tt}-tags-empty`,Ot=`${Tt}-tag`,Ft=`${Tt}-tag-not-everywhere`,Nt=`${Tt}-shadow`,Bt=`${Tt}-fit-height`,Ut="pcui-selected",zt=`${Tt}-label-highlighted`,Vt=`${Tt}-create-new`,Ht="pcui-open";let Gt=class extends L{constructor(t={}){var e,s,i,n;const r=new B({dom:t.dom});super(Object.assign(Object.assign({},t),{dom:r.dom})),this._timeoutLabelValueTabIndex=null,this._valueToText={},this._valueToLabel={},this._labelToValue=new Map,this._labelHighlighted=null,this._disabledOptions={},this._prefix="",this._onInputChange=t=>{this._suspendInputChange||this._lastInputValue!==t&&(this.open(),this._lastInputValue=t,this._filterOptions(t))},this._onInputKeyDown=t=>{if("Enter"===t.key&&this.enabled&&!this.readOnly){let e;if(t.stopPropagation(),t.preventDefault(),e=this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)?this._labelToValue.get(this._labelHighlighted):this._input.value,void 0!==e)return this.focus(),this.close(),void(this._valueToText[e]?this._onSelectValue(e):this._allowCreate&&(this._createFn?this._createFn(e):this._onSelectValue(e)))}this._onKeyDown(t)},this._onDocumentPointerDown=t=>{this.dom.contains(t.composedPath()[0])||this.close()},this._onKeyDown=t=>{if("Escape"!==t.key)if("Tab"!==t.key){if(this.enabled&&!this.readOnly)if("Enter"!==t.key||this._allowInput){if("ArrowUp"===t.key||"ArrowDown"===t.key)if(t.stopPropagation(),t.preventDefault(),(this._allowInput||this.multiSelect)&&this._containerOptions.hidden)this.open();else if(this._containerOptions.hidden){if(!this._options.length)return;let e=-1;for(let t=0;t<this._options.length;t++)if(this._options[t].v===this.value){e=t;break}"ArrowUp"===t.key?e--:"ArrowDown"===t.key&&e++,e>=0&&e<this._options.length&&this._onSelectValue(this._options[e].v)}else{if(!this._containerOptions.dom.childNodes.length)return;if(this._labelHighlighted){let e=this._labelHighlighted.dom;do{"ArrowUp"===t.key?e=e.previousSibling:"ArrowDown"===t.key&&(e=e.nextSibling)}while(e&&e.ui.hidden);e&&this._highlightLabel(e.ui)}else this._highlightLabel(this._containerOptions.dom.childNodes[0].ui)}}else this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)&&(this._onSelectValue(this._labelToValue.get(this._labelHighlighted)),this.close())}else this.close();else this.close()},this._onPointerDown=()=>{this._allowInput||this.focus()},this._onFocus=()=>{this.class.add(b),this.emit("focus"),this._input.hidden||this.open()},this._onBlur=()=>{this.class.remove(b),this.emit("blur")},this._onWheel=t=>{t.stopPropagation()},this._container=r,this._container.parent=this,this.class.add(Tt),this._containerValue=new B({class:Et}),this._container.append(this._containerValue),this._domShadow=document.createElement("div"),this._domShadow.classList.add(Nt),this._containerValue.append(this._domShadow),this._allowInput=t.allowInput,this._allowInput&&this.class.add("pcui-select-input-allow-input"),this._allowCreate=t.allowCreate,this._createFn=t.createFn,this._createLabelText=t.createLabelText,this._labelValue=new X({class:Pt,tabIndex:0}),this._labelValue.on("click",(()=>{this.enabled&&!this.readOnly&&this.toggle()})),this._containerValue.append(this._labelValue),this._labelIcon=new X({class:Lt,hidden:t.allowInput&&t.multiSelect}),this._containerValue.append(this._labelIcon),this._input=new mt({class:It,blurOnEnter:!1,keyChange:!0}),this._containerValue.append(this._input),this._lastInputValue="",this._suspendInputChange=!1,this._input.on("change",this._onInputChange),this._input.on("keydown",this._onInputKeyDown),this._input.on("focus",this._onFocus),this._input.on("blur",this._onBlur),t.placeholder&&(this.placeholder=t.placeholder),this._containerOptions=new B({class:Rt,hidden:!0}),this._containerValue.append(this._containerOptions),this._containerTags=new B({class:Mt,flex:!0,flexDirection:"row",hidden:!0}),this._container.append(this._containerTags),t.multiSelect&&(this.class.add(Ct),this._containerTags.hidden=!1),this._labelValue.dom.addEventListener("keydown",this._onKeyDown),this._labelValue.dom.addEventListener("focus",this._onFocus),this._labelValue.dom.addEventListener("blur",this._onBlur),this._labelValue.dom.addEventListener("pointerdown",this._onPointerDown),this._containerOptions.dom.addEventListener("wheel",this._onWheel,{passive:!0}),this.on("hide",(()=>{this.close()})),this._type=null!==(e=t.type)&&void 0!==e?e:"string",this.invalidOptions=null!==(s=t.invalidOptions)&&void 0!==s?s:[],this.options=null!==(i=t.options)&&void 0!==i?i:[],this._optionsFn=t.optionsFn,this._allowNull=t.allowNull,this._values=null,void 0!==t.value?this.value=t.value:t.defaultValue?this.value=t.defaultValue:this.value=null,this._renderChanges=t.renderChanges,this.on("change",(()=>{this._updateInputFieldsVisibility(),this.renderChanges&&!this.multiSelect&&this._labelValue.flash()})),this._updateInputFieldsVisibility(!1),this._onSelect=t.onSelect,this.fallbackOrder=t.fallbackOrder,this.disabledOptions=t.disabledOptions,this._prefix=null!==(n=t.prefix)&&void 0!==n?n:""}destroy(){this._destroyed||(this._labelValue.dom.removeEventListener("keydown",this._onKeyDown),this._labelValue.dom.removeEventListener("pointerdown",this._onPointerDown),this._labelValue.dom.removeEventListener("focus",this._onFocus),this._labelValue.dom.removeEventListener("blur",this._onBlur),this._containerOptions.dom.removeEventListener("wheel",this._onWheel),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown),this._timeoutLabelValueTabIndex&&(cancelAnimationFrame(this._timeoutLabelValueTabIndex),this._timeoutLabelValueTabIndex=null),super.destroy())}_initializeCreateLabel(){const t=new B({class:Vt,flex:!0,flexDirection:"row"}),e=new X({text:this._input.value,tabIndex:-1});t.append(e);let s=this._input.on("change",(s=>{e.destroyed||(e.text=s,this.invalidOptions&&-1!==this.invalidOptions.indexOf(s)?t.hidden||(t.hidden=!0,this._resizeShadow()):t.hidden&&(t.hidden=!1,this._resizeShadow()))}));t.on("click",(t=>{t.stopPropagation();const s=e.text;this.focus(),this.close(),this._createFn?this._createFn(s):s&&this._onSelectValue(s)})),e.on("destroy",(()=>{s.unbind(),s=null}));const i=new X({text:this._createLabelText});return t.append(i),this._containerOptions.append(t),t}_convertSingleValue(t){if(null===t&&this._allowNull)return t;if("string"===this._type)t=t?t.toString():"";else if("number"===this._type)t=t?parseInt(t,10):0;else if("boolean"===this._type)return!!t;return t}_convertValue(t){return null===t&&this._allowNull?t:this.multiSelect?Array.isArray(t)?t.map((t=>this._convertSingleValue(t))):t:this._convertSingleValue(t)}_onSelectValue(t){if(t=this._convertSingleValue(t),this.multiSelect)if(this._values){let e=!1;this._values.forEach((s=>{s?-1===s.indexOf(t)&&(s.push(t),e=!0):(s=[t],e=!0)})),e&&(this._onMultipleValuesChange(this._values),this.emit("change",this.value),this._binding&&this._binding.addValues([t]))}else this._value&&Array.isArray(this._value)?-1===this._value.indexOf(t)&&(this._value.push(t),this._addTag(t),this.emit("change",this.value),this._binding&&this._binding.addValues([t])):this.value=[t];else this.value=t}_highlightLabel(t){if(this._labelHighlighted!==t&&(this._labelHighlighted&&this._labelHighlighted.class.remove(zt),this._labelHighlighted=t,this._labelHighlighted)){this._labelHighlighted.class.add(zt);const t=this._labelHighlighted.dom.offsetTop,e=this._containerOptions.dom.scrollTop;t<e?this._containerOptions.dom.scrollTop=t:t+this._labelHighlighted.height>this._containerOptions.height+e&&(this._containerOptions.dom.scrollTop=t+this._labelHighlighted.height-this._containerOptions.height)}}_onValueChange(t){if(this.multiSelect){if(this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(kt),t&&Array.isArray(t)){for(const e of t){this._addTag(e);const t=this._valueToLabel[String(e)];t&&t.class.add(Ut)}for(const e in this._valueToLabel){const s=this._valueToLabel[e];-1!==t.indexOf(this._convertSingleValue(e))?s.class.add(Ut):s.class.remove(Ut)}}}else{this._labelValue.value=this._prefix+(this._valueToText[String(t)]||""),t=String(t);for(const e in this._valueToLabel){const s=this._valueToLabel[e];e===t?s.class.add(Ut):s.class.remove(Ut)}}}_onMultipleValuesChange(t){this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(kt);const e={},s={};t.forEach((t=>{t&&t.forEach((t=>{e[t]?s[t]++:(e[t]=this._addTag(t),s[t]=1)}))}));for(const i in s)if(s[i]!==t.length){e[i].class.add(Ft);const t=this._valueToLabel[String(i)];t&&t.class.remove(Ut)}}_addTag(t){const e=new B({flex:!0,flexDirection:"row",class:Ot});e.append(new X({text:this._valueToText[String(t)]||t}));const s=new R({size:"small",icon:"E132",tabIndex:-1});e.append(s),s.on("click",(()=>this._removeTag(e,String(t)))),this._containerTags.append(e),this._containerTags.class.remove(kt);const i=this._valueToLabel[String(t)];return i&&i.class.add(Ut),e.value=t,e}_removeTag(t,e){t.destroy();const s=this._valueToLabel[String(e)];if(s&&s.class.remove(Ut),this._values)this._values.forEach((t=>{if(!t)return;const s=t.indexOf(e);-1!==s&&t.splice(s,1)}));else if(this._value&&Array.isArray(this._value)){const t=this._value.indexOf(e);-1!==t&&this._value.splice(t,1)}this.emit("change",this.value),this._binding&&this._binding.removeValues([e])}_filterOptions(t){const e=this._containerOptions.dom;for(;e.firstChild;)e.removeChild(e.lastChild);if(t){wt(this._options,"t",t).forEach((t=>{const s=this._valueToLabel[String(t.v)];e.appendChild(s.dom)}))}else for(const t of this._options){const s=this._valueToLabel[String(t.v)];e.appendChild(s.dom)}this._createLabelContainer&&e.appendChild(this._createLabelContainer.dom),e.firstChild&&this._highlightLabel(e.firstChild.ui),this._resizeShadow()}_resizeShadow(){this._domShadow.style.height=`${this._containerValue.height+this._containerOptions.height}px`}_updateInputFieldsVisibility(t){let e=!1,s=!1;this._allowInput&&(t?(e=!0,s=!0):e=this.multiSelect||!this._valueToLabel[this.value]),this._labelValue.hidden=e,this._labelIcon.hidden=e,this._input.hidden=!e,s&&this._input.focus(),this._labelValue.hidden||(this._labelValue.tabIndex=-1,this._timeoutLabelValueTabIndex||(this._timeoutLabelValueTabIndex=requestAnimationFrame((()=>{this._timeoutLabelValueTabIndex=null,this._labelValue.tabIndex=0}))))}focus(){this._input.hidden?this._labelValue.dom.focus():this._input.focus()}blur(){this._allowInput?this._input.blur():this._labelValue.dom.blur()}open(){if(!this._containerOptions.hidden||!this.enabled||this.readOnly)return;if(this._updateInputFieldsVisibility(!0),this._optionsFn&&(this.options=this._optionsFn()),0===this._containerOptions.dom.childNodes.length)return;this._containerOptions.forEachChild((t=>{t.hidden=!1,this._labelToValue.get(t)===this.value&&this._highlightLabel(t)})),this._labelHighlighted||this._highlightLabel(this._containerOptions.dom.childNodes[0].ui),this._containerOptions.hidden=!1,this.class.add(Ht),window.addEventListener("keydown",this._onKeyDown),document.addEventListener("pointerdown",this._onDocumentPointerDown);const t=(this._allowInput?this._input.dom:this._labelValue.dom).getBoundingClientRect();let e=t.bottom+this._containerOptions.height+25>=window.innerHeight;e&&t.top-this._containerOptions.height<0&&(e=!1,this._containerOptions.style.maxHeight=window.innerHeight-t.bottom-25+"px"),e?this.class.add(Bt):this.class.remove(Bt),this._resizeShadow()}close(){this._containerOptions.style.maxHeight="",this._highlightLabel(null),this._updateInputFieldsVisibility(!1),this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this._containerOptions.hidden||(this._containerOptions.hidden=!0,this._domShadow.style.height="",this.class.remove(Ht),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown))}toggle(){this._containerOptions.hidden?this.open():this.close()}unlink(){super.unlink(),this._containerOptions.hidden||this.close()}_updateValue(t){t!==this._value&&(this._value=t,this._onValueChange(t),this._suppressChange||this.emit("change",t),this._binding&&this._binding.setValue(t))}_updateDisabledValue(t){const e={};this._containerOptions.forEachChild((t=>{e[t.dom.id]=t,this._disabledOptions[t.dom.id]?(t.enabled=!1,t.text=this._disabledOptions[t.dom.id]):(t.enabled=!0,t.text=this._valueToText[t.dom.id]),t.class.remove(At)}));const s=this._disabledOptions[t]?t:null;let i=null;if(s){if(this._fallbackOrder)for(let e=0;e<this._fallbackOrder.length;e++)if(this._fallbackOrder[e]!==t){i=this._fallbackOrder[e];break}this.disabledValue=s,e[s].class.add(At)}else this._disabledValue?(i=this._disabledValue,this.disabledValue=null):(i=t,this.disabledValue=null);return i}set options(t){if(!this._options||JSON.stringify(this._options)!==JSON.stringify(t)){this._containerOptions.clear(),this._labelHighlighted=null,this._valueToText={},this._valueToLabel={},this._options=t;for(const t of this._options){if(this._valueToText[String(t.v)]=t.t,""===t.v)return;const e=new X({text:t.t,tabIndex:-1,id:String(t.v)});this._labelToValue.set(e,t.v),this._valueToLabel[String(t.v)]=e,e.on("click",(e=>{e.stopPropagation(),this._onSelectValue(t.v),this.close(),this._onSelect&&this._onSelect(this.value)})),this._containerOptions.append(e)}this._createLabelContainer=null,this._createLabelText&&(this._createLabelContainer=this._initializeCreateLabel()),this.multiSelect&&this._values?this._onMultipleValuesChange(this._values):this._onValueChange(this.value),this._lastInputValue&&this._filterOptions(this._lastInputValue)}}get options(){return this._options.slice()}set invalidOptions(t){this._invalidOptions=t||null}get invalidOptions(){return this._invalidOptions}set disabledValue(t){this._disabledValue=t,null!==this._disabledValue?this.class.add(Dt):this.class.remove(Dt)}set disabledOptions(t){if(JSON.stringify(this._disabledOptions)===JSON.stringify(t))return;this._disabledOptions=t||{};const e=this._updateDisabledValue(this._value);this._updateValue(e)}set fallbackOrder(t){this._fallbackOrder=t||null}get multiSelect(){return this.class.contains(Ct)}set value(t){this._values=null,this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this.class.remove(T),t=this._convertValue(t),(!(this._value===t||this.multiSelect&&this._value&&this._value.equals(t))||null===t&&this._allowNull&&this.class.contains(T))&&(this.disabledValue=null,this._updateValue(t))}get value(){if(!this.multiSelect)return this._value;const t=[];return this._containerTags.dom.childNodes.forEach((e=>{t.push(e.ui.value)})),t}set values(t){t=t.map((t=>this._convertValue(t)));let e=!1;const s=t[0],i=this.multiSelect;this._values=null;for(let n=1;n<t.length;n++)if(!(t[n]===s||i&&t[n]&&t[n].equals(s))){e=!0;break}e?(this._labelValue.values=t,i?(this._values=t,this._value=null,this._onMultipleValuesChange(this._values),this.emit("change",this.value)):null!==this._value&&(this._value=null,this.emit("change",null)),this.class.add(T)):this.value=t[0]}set placeholder(t){this._input.placeholder=t}get placeholder(){return this._input.placeholder}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};L.register("select",Gt,{renderChanges:!0}),L.register("multiselect",Gt,{multiSelect:!0,renderChanges:!0}),L.register("tags",Gt,{allowInput:!0,allowCreate:!0,multiSelect:!0,renderChanges:!0});let Wt=class extends B{constructor(t={}){var e,s,i,n;super(t),this._titleElement=new L,this._textElement=new L,this.class.add("pcui-infobox"),this.append(this._titleElement),this.append(this._textElement),this._unsafe=null!==(e=t.unsafe)&&void 0!==e&&e,this.icon=null!==(s=t.icon)&&void 0!==s?s:"",this.title=null!==(i=t.title)&&void 0!==i?i:"",this.text=null!==(n=t.text)&&void 0!==n?n:""}set icon(t){this._icon!==t&&(this._icon=t,t?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set title(t){this._title!==t&&(this._title=t,this._unsafe?this._titleElement.dom.innerHTML=t:this._titleElement.dom.textContent=t)}get title(){return this._title}set text(t){this._text!==t&&(this._text=t,this._unsafe?this._textElement.dom.innerHTML=t:this._textElement.dom.textContent=t)}get text(){return this._text}};L.register("infobox",Wt);class jt extends I{constructor(t){super(t),this.elementClass=Wt}render(){return d.createElement("span",{ref:this.attachElement})}}jt.ctor=Wt;class Xt extends I{constructor(t={}){super(t),this.elementClass=X}render(){return d.createElement("span",{ref:this.attachElement})}}Xt.ctor=X;class $t extends I{constructor(t){super(t),this.elementClass=j}render(){return super.render()}}$t.ctor=j;class qt extends I{constructor(t={}){super(t),this.elementClass=tt}componentDidMount(){this.attachElement(this.nodeElement,this.containerElement)}render(){let t=d.Children.toArray(this.props.children);return 1===t.length?t=d.cloneElement(t[0],{parent:this.element}):t.length>0&&(t=t.map((t=>d.cloneElement(t,{parent:this.element})))),d.createElement("div",{ref:t=>{this.nodeElement=t}},d.createElement("div",{ref:t=>{this.containerElement=t}},t))}}qt.ctor=tt;class Kt extends I{constructor(t){super(t),this.elementClass=Gt,this.onSelect=t.onSelect,this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect)}render(){return super.render()}}var Yt;Kt.ctor=Gt;const Qt="pcui-slider",Zt=`${Qt}-container`,Jt=`${Qt}-bar`,te=`${Qt}-handle`,ee=`${Qt}-active`,se=/Chrome\//.test(null===(Yt=globalThis.navigator)||void 0===Yt?void 0:Yt.userAgent);let ie=class extends L{constructor(t={}){var e,s,i,n,r;super(t),this._historyCombine=!1,this._historyPostfix=null,this._cursorHandleOffset=0,this._pointerId=null,this._onPointerDown=t=>{"mouse"===t.pointerType&&0!==t.button||!this.enabled||this.readOnly||null!==this._pointerId||(t.stopPropagation(),this._domSlider.setPointerCapture(t.pointerId),this._pointerId=t.pointerId,this._onSlideStart(t.pageX))},this._onPointerMove=t=>{t.pointerId===this._pointerId&&(t.stopPropagation(),t.preventDefault(),this._onSlideMove(t.pageX))},this._onPointerUp=t=>{t.pointerId===this._pointerId&&null!==this._pointerId&&(t.stopPropagation(),this._domSlider.releasePointerCapture(t.pointerId),this._onSlideEnd(t.pageX),this._pointerId=null)},this._onKeyDown=t=>{if("Escape"===t.key)return void this.blur();if(!this.enabled||this.readOnly)return;if("ArrowLeft"!==t.key&&"ArrowRight"!==t.key)return;t.stopPropagation(),t.preventDefault();let e="ArrowLeft"===t.key?-1:1;t.shiftKey&&(e*=10),this.value+=e*this.step},this.class.add(Qt);const a=new j({allowNull:t.allowNull,hideSlider:!0,min:t.min,max:t.max,keyChange:t.keyChange,placeholder:t.placeholder,precision:null!==(e=t.precision)&&void 0!==e?e:2,renderChanges:t.renderChanges,step:t.step});a.on("change",(t=>{this._onValueChange(t)})),a.on("focus",(()=>{this.emit("focus")})),a.on("blur",(()=>{this.emit("blur")})),a.parent=this,this.dom.appendChild(a.dom),this._numericInput=a,this._sliderMin=null!==(i=null!==(s=t.sliderMin)&&void 0!==s?s:t.min)&&void 0!==i?i:0,this._sliderMax=null!==(r=null!==(n=t.sliderMax)&&void 0!==n?n:t.max)&&void 0!==r?r:1,this._domSlider=document.createElement("div"),this._domSlider.classList.add(Zt),this.dom.appendChild(this._domSlider),this._domBar=document.createElement("div"),this._domBar.classList.add(Jt),this._domBar.ui=this,this._domSlider.appendChild(this._domBar),this._domHandle=document.createElement("div"),this._domHandle.ui=this,this._domHandle.tabIndex=0,this._domHandle.classList.add(te),this._domBar.appendChild(this._domHandle),this._domSlider.addEventListener("pointerdown",this._onPointerDown),this._domHandle.addEventListener("keydown",this._onKeyDown),void 0!==t.value&&(this.value=t.value),void 0!==t.values&&(this.values=t.values),0===this.value&&this._updateHandle(0)}destroy(){this._destroyed||(this._domSlider.removeEventListener("pointerdown",this._onPointerDown),this._domHandle.removeEventListener("keydown",this._onKeyDown),super.destroy())}_updateHandle(t){const e=100*Math.max(0,Math.min(1,((t||0)-this._sliderMin)/(this._sliderMax-this._sliderMin))),s=this._domHandle.getBoundingClientRect().width;this._domHandle.style.left=`calc(${e}% + ${s/2}px)`}_onValueChange(t){this._updateHandle(t),this._suppressChange||this.emit("change",t),this._binding&&this._binding.setValue(t)}_calculateCursorHandleOffset(t){const e=se?2:0,s=this._domHandle.getBoundingClientRect(),i=s.left-e,n=s.right;return this._cursorHandleOffset=t>=i&&t<=n?t-(i+(n-i)/2):0,this._cursorHandleOffset}_onSlideStart(t){this._domHandle.focus(),this._domSlider.addEventListener("pointermove",this._onPointerMove),this._domSlider.addEventListener("pointerup",this._onPointerUp),this.class.add(ee),this._calculateCursorHandleOffset(t)||this._onSlideMove(t),this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)}_onSlideMove(t){const e=this._domBar.getBoundingClientRect();t-=this._cursorHandleOffset;let s=Math.max(0,Math.min(1,(t-e.left)/e.width))*(this._sliderMax-this._sliderMin)+this._sliderMin;s=parseFloat(s.toFixed(this.precision)),this.value=s}_onSlideEnd(t){this._calculateCursorHandleOffset(t)||this._onSlideMove(t),this.class.remove(ee),this._domSlider.removeEventListener("pointermove",this._onPointerMove),this._domSlider.removeEventListener("pointerup",this._onPointerUp),this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null)}focus(){this._numericInput.focus()}blur(){this._domHandle.blur(),this._numericInput.blur()}set sliderMin(t){this._sliderMin!==t&&(this._sliderMin=t,this._updateHandle(this.value))}get sliderMin(){return this._sliderMin}set sliderMax(t){this._sliderMax!==t&&(this._sliderMax=t,this._updateHandle(this.value))}get sliderMax(){return this._sliderMax}set value(t){this._numericInput.value=t,this._numericInput.class.contains(T)?this.class.add(T):this.class.remove(T)}get value(){return this._numericInput.value}set values(t){this._numericInput.values=t,this._numericInput.class.contains(T)?this.class.add(T):this.class.remove(T)}set renderChanges(t){this._numericInput.renderChanges=t}get renderChanges(){return this._numericInput.renderChanges}set min(t){this._numericInput.min=t}get min(){return this._numericInput.min}set max(t){this._numericInput.max=t}get max(){return this._numericInput.max}set step(t){this._numericInput.step=t}get step(){return this._numericInput.step}set precision(t){this._numericInput.precision=t}get precision(){return this._numericInput.precision}set keyChange(t){this._numericInput.keyChange=t}get keyChange(){return this._numericInput.keyChange}set placeholder(t){this._numericInput.placeholder=t}get placeholder(){return this._numericInput.placeholder}};L.register("slider",ie,{renderChanges:!0});class ne extends I{constructor(t){super(t),this.elementClass=ie}render(){return super.render()}}ne.ctor=ie;let re=class t extends L{constructor(e={}){var s,i;if((null!==(s=e.type)&&void 0!==s?s:"small-thick")===t.TYPE_SMALL_THICK){const t=function(t,e){const s=e||document.createElementNS("http://www.w3.org/2000/svg","svg");return s.classList.add("spin"),s.setAttribute("width",t),s.setAttribute("height",t),s.setAttribute("viewBox","0 0 14 14"),s.setAttribute("fill","none"),s.innerHTML='<path d="M7 14C3.13871 14 0 10.8613 0 7C0 3.13871 3.13871 0 7 0C10.8613 0 14 3.13871 14 7C14 10.8613 10.8613 14 7 14ZM7 2.25806C4.38064 2.25806 2.25806 4.38064 2.25806 7C2.25806 9.61935 4.38064 11.7419 7 11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7C11.7419 4.38064 9.61935 2.25806 7 2.25806Z" fill="#773417"/><path class="pcui-spinner-highlight" d="M7 14V11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7H14C14 10.8613 10.8613 14 7 14Z" fill="#FF6600"/>',s}(null!==(i=e.size)&&void 0!==i?i:12,e.dom);e=Object.assign(Object.assign({},e),{dom:t})}super(e),this.class.add("pcui-spinner")}};re.TYPE_SMALL_THICK="small-thick";class ae extends I{constructor(t){super(t),this.elementClass=re}render(){return d.createElement("svg",{ref:this.attachElement})}}ae.ctor=re;class oe extends I{constructor(t={}){super(t),this.elementClass=mt,t.onValidate&&(this.onValidate=t.onValidate),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.onValidate&&(this.element.onValidate=this.onValidate)}render(){return super.render()}}oe.ctor=mt;const le="pcui-treeview-item",he=`${le}-icon`,ce=`${le}-text`,de=`${le}-selected`,ue=`${le}-open`,fe=`${le}-contents`,pe=`${le}-empty`,me=`${le}-rename`;let _e=class t extends B{constructor(t={}){var e,s,i,n,r;super(t),this.allowDrop=!0,this.allowDrag=!0,this.allowSelect=!0,this._numChildren=0,this._open=!1,this._onContentKeyDown=t=>{"INPUT"!==t.target.tagName&&this.allowSelect&&this._treeView&&this._treeView._onChildKeyDown(t,this)},this._onContentMouseDown=t=>{this._treeView&&this._treeView.allowDrag&&this.allowDrag&&(this._treeView._updateModifierKeys(t),t.stopPropagation())},this._onContentMouseUp=t=>{t.stopPropagation(),t.preventDefault(),window.removeEventListener("mouseup",this._onContentMouseUp),this._treeView&&this._treeView._onChildDragEnd(t,this)},this._onContentMouseOver=t=>{t.stopPropagation(),this._treeView&&this._treeView._onChildDragOver(t,this),this.emit("hover",t)},this._onContentDragStart=t=>{t.stopPropagation(),t.preventDefault(),this._treeView&&this._treeView.allowDrag&&(this.class.contains(me)||(this._treeView._onChildDragStart(t,this),window.addEventListener("mouseup",this._onContentMouseUp)))},this._onContentClick=t=>{if(!this.allowSelect||0!==t.button)return;if("INPUT"===t.target.tagName)return;t.stopPropagation();const e=this._containerContents.dom.getBoundingClientRect();this._numChildren>0&&t.clientX-e.left<0?(this.open=!this.open,t.altKey&&this._dfs((t=>{t.open=this.open})),this.focus()):this._treeView&&this._treeView._onChildClick(t,this)},this._onContentDblClick=t=>{if(!this._treeView||!this._treeView.allowRenaming||0!==t.button)return;if("INPUT"===t.target.tagName)return;t.stopPropagation();const e=this._containerContents.dom.getBoundingClientRect();this.numChildren&&t.clientX-e.left<0||(this.allowSelect&&(this._treeView.deselect(),this._treeView._onChildClick(t,this)),this.rename())},this._onContentContextMenu=t=>{this._treeView&&this._treeView._onContextMenu&&this._treeView._onContextMenu(t,this)},this._onContentFocus=t=>{this.emit("focus")},this._onContentBlur=t=>{this.emit("blur")},this.class.add(le,pe),this._containerContents=new B({class:fe,flex:!0,flexDirection:"row",tabIndex:0}),this.append(this._containerContents),this._containerContents.dom.draggable=!0,this._labelIcon=new X({class:he}),this._containerContents.append(this._labelIcon),this.icon=null!==(e=t.icon)&&void 0!==e?e:"E360",this._labelText=new X({class:ce}),this._containerContents.append(this._labelText),this.allowSelect=null===(s=t.allowSelect)||void 0===s||s,this.allowDrop=null===(i=t.allowDrop)||void 0===i||i,this.allowDrag=null===(n=t.allowDrag)||void 0===n||n,t.text&&(this.text=t.text),t.selected&&(this.selected=t.selected),this._open=null!==(r=t.open)&&void 0!==r&&r;const a=this._containerContents.dom;a.addEventListener("focus",this._onContentFocus),a.addEventListener("blur",this._onContentBlur),a.addEventListener("keydown",this._onContentKeyDown),a.addEventListener("dragstart",this._onContentDragStart),a.addEventListener("mousedown",this._onContentMouseDown),a.addEventListener("mouseover",this._onContentMouseOver),a.addEventListener("click",this._onContentClick),a.addEventListener("dblclick",this._onContentDblClick),a.addEventListener("contextmenu",this._onContentContextMenu)}destroy(){if(this._destroyed)return;const t=this._containerContents.dom;t.removeEventListener("focus",this._onContentFocus),t.removeEventListener("blur",this._onContentBlur),t.removeEventListener("keydown",this._onContentKeyDown),t.removeEventListener("dragstart",this._onContentDragStart),t.removeEventListener("mousedown",this._onContentMouseDown),t.removeEventListener("mouseover",this._onContentMouseOver),t.removeEventListener("click",this._onContentClick),t.removeEventListener("dblclick",this._onContentDblClick),t.removeEventListener("contextmenu",this._onContentContextMenu),window.removeEventListener("mouseup",this._onContentMouseUp),super.destroy()}_onAppendChild(e){super._onAppendChild(e),e instanceof t&&(this._numChildren++,this.class.remove(pe),this._open&&this.class.add(ue),this._treeView&&this._treeView._onAppendTreeViewItem(e))}_onRemoveChild(e){e instanceof t&&(this._numChildren--,0===this._numChildren&&this.class.add(pe),this._treeView&&this._treeView._onRemoveTreeViewItem(e)),super._onRemoveChild(e)}_dfs(t){t(this);let e=this.firstChild;for(;e;)e._dfs(t),e=e.nextSibling}rename(){this.class.add(me);const t=new mt({renderChanges:!1,value:this.text,class:y});t.on("blur",(()=>{t.destroy()})),t.on("destroy",(()=>{this.class.remove(me),this.focus()})),t.on("change",(e=>{(e=e.trim())&&(this.text=e,t.destroy())})),t.on("disable",(()=>{t.input.removeAttribute("readonly")})),this._containerContents.append(t),t.focus(!0)}focus(){this._containerContents.dom.focus()}blur(){this._containerContents.dom.blur()}set selected(t){t!==this.selected?t?(this._containerContents.class.add(de),this.emit("select",this),this._treeView&&this._treeView._onChildSelected(this),this.focus()):(this._containerContents.class.remove(de),this.blur(),this.emit("deselect",this),this._treeView&&this._treeView._onChildDeselected(this)):t&&this.focus()}get selected(){return this._containerContents.class.contains(de)}set text(t){this._labelText.value!==t&&(this._labelText.value=t,this._treeView&&this._treeView._onChildRename(this,t))}get text(){return this._labelText.value}get textLabel(){return this._labelText}get iconLabel(){return this._labelIcon}set open(t){if(this._open!==t)if(this._open=t,t){if(!this.numChildren)return;this.class.add(ue),this.emit("open",this)}else this.class.remove(ue),this.emit("close",this)}get open(){return this._open}set parentsOpen(e){let s=this.parent;for(;s&&s instanceof t;)s.open=e,s=s.parent}get parentsOpen(){let e=this.parent;for(;e&&e instanceof t;){if(!e.open)return!1;e=e.parent}return!0}set treeView(t){this._treeView=t}get treeView(){return this._treeView}get numChildren(){return this._numChildren}get firstChild(){if(this._numChildren)for(const e of this.dom.childNodes)if(e.ui instanceof t)return e.ui;return null}get lastChild(){if(this._numChildren)for(let e=this.dom.childNodes.length-1;e>=0;e--)if(this.dom.childNodes[e].ui instanceof t)return this.dom.childNodes[e].ui;return null}get nextSibling(){let e=this.dom.nextSibling;for(;e&&!(e.ui instanceof t);)e=e.nextSibling;return e&&e.ui}get previousSibling(){let e=this.dom.previousSibling;for(;e&&!(e.ui instanceof t);)e=e.previousSibling;return e&&e.ui}set icon(t){this._icon!==t&&t.match(/^E\d{0,4}$/)&&(this._icon=t,t?this._labelIcon.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this._labelIcon.dom.removeAttribute("data-icon"))}get icon(){return this._icon}};_e.EVENT_SELECT="select",_e.EVENT_DESELECT="deselect",_e.EVENT_OPEN="open",_e.EVENT_CLOSE="close";const ge="pcui-treeview",ve=`${ge}-item-dragged`,be=`${ge}-drag-handle`,ye=`${ge}-filtering`,Se=`${ye}-result`,xe="inside",we="before",Te="after";let Ee=class extends B{constructor(t={}){var e,s,i,n;super(t),this.allowReordering=!0,this.allowRenaming=!1,this._selectedItems=[],this._dragItems=[],this._dragging=!1,this._dragOverItem=null,this._dragArea=xe,this._dragScroll=0,this._dragScrollInterval=null,this._pressedCtrl=!1,this._pressedShift=!1,this._filter=null,this._filterResults=[],this._updateModifierKeys=t=>{this._pressedCtrl=t.ctrlKey||t.metaKey,this._pressedShift=t.shiftKey},this._onMouseLeave=t=>{this._allowDrag&&this._dragging&&(this._dragOverItem=null,this._updateDragHandle())},this._onMouseMove=t=>{if(!this._dragging)return;const e=this.dom.getBoundingClientRect();this._dragScroll=0;let s=e.top,i=e.bottom;if(this._dragScrollElement!==this){const t=this._dragScrollElement.dom.getBoundingClientRect();s=Math.max(s+this._dragScrollElement.dom.scrollTop,t.top),i=Math.min(i+this._dragScrollElement.dom.scrollTop,t.bottom)}s=Math.max(0,s),i=Math.min(i,document.body.clientHeight),t.pageY<s+32&&this._dragScrollElement.dom.scrollTop>0?this._dragScroll=-1:t.pageY>i-32&&this._dragScrollElement.dom.scrollHeight>this._dragScrollElement.height+this._dragScrollElement.dom.scrollTop&&(this._dragScroll=1)},this._onDragMove=t=>{if(t.preventDefault(),t.stopPropagation(),!this._allowDrag||!this._dragOverItem)return;const e=this._dragHandle.dom.getBoundingClientRect(),s=Math.floor((t.clientY-e.top)/e.height*5),i=this._dragArea,n=this._dragOverItem;if(this._dragOverItem.parent===this){let t=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this._dragOverItem){t=!0,this._dragOverItem=null;break}t||(this._dragArea=xe)}else{let t=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].dom.contains(this._dragOverItem.dom)){t=!0;break}if(t)this._dragOverItem=null;else if(this.allowReordering&&s<=1&&-1===this._dragItems.indexOf(this._dragOverItem.previousSibling))this._dragArea=we;else if(this.allowReordering&&s>=4&&-1===this._dragItems.indexOf(this._dragOverItem.nextSibling)&&(0===this._dragOverItem.numChildren||!this._dragOverItem.open))this._dragArea=Te;else{let t=!1;if(this.allowReordering&&this._dragOverItem.open)for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this._dragOverItem){t=!0,this._dragArea=we;break}t||(this._dragArea=xe)}}i===this._dragArea&&n===this._dragOverItem||this._updateDragHandle()},this.class.add(ge),this._allowDrag=null===(e=t.allowDrag)||void 0===e||e,this.allowReordering=null===(s=t.allowReordering)||void 0===s||s,this.allowRenaming=null!==(i=t.allowRenaming)&&void 0!==i&&i,this._dragHandle=new L({class:be,hidden:!0}),this._dragScrollElement=null!==(n=t.dragScrollElement)&&void 0!==n?n:this,this.append(this._dragHandle),this._onContextMenu=t.onContextMenu,this._onReparentFn=t.onReparent,this._wasDraggingAllowedBeforeFiltering=this._allowDrag,window.addEventListener("keydown",this._updateModifierKeys),window.addEventListener("keyup",this._updateModifierKeys),window.addEventListener("mousedown",this._updateModifierKeys),this.dom.addEventListener("mouseleave",this._onMouseLeave),this._dragHandle.dom.addEventListener("mousemove",this._onDragMove),this._dragHandle.on("destroy",(t=>{t.removeEventListener("mousemove",this._onDragMove)}))}destroy(){this._destroyed||(window.removeEventListener("keydown",this._updateModifierKeys),window.removeEventListener("keyup",this._updateModifierKeys),window.removeEventListener("mousedown",this._updateModifierKeys),window.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("mouseleave",this._onMouseLeave),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null),super.destroy())}_findNextVisibleTreeItem(t){if(t.numChildren>0&&t.open)return t.firstChild;const e=t.nextSibling;if(e)return e;let s=t.parent;if(!(s instanceof _e))return null;let i=s.nextSibling;for(;!i&&(s=s.parent,s instanceof _e);)i=s.nextSibling;return i}_findLastVisibleChildTreeItem(t){if(!t.numChildren||!t.open)return null;let e=t.lastChild;for(;e&&e.numChildren&&e.open;)e=e.lastChild;return e}_findPreviousVisibleTreeItem(t){const e=t.previousSibling;if(e)return e.numChildren>0&&e.open?this._findLastVisibleChildTreeItem(e):e;const s=t.parent;return s instanceof _e?s:null}_getChildrenRange(t,e){const s=[];if(this._filterResults.length){const i=this.dom.querySelectorAll(`.${ge}-item.${Se}`);let n=-1,r=-1;for(let a=0;a<i.length;a++){const o=i[a].ui;if(o===t?n=a:o===e&&(r=a),-1!==n&&-1!==r){const t=n<r?r:n;for(let e=n<r?n:r;e<=t;e++)s.push(i[e].ui);break}}}else{let i=t;const n=t.dom.getBoundingClientRect(),r=e.dom.getBoundingClientRect();if(n.top<r.top)for(;i&&i!==e;)i=this._findNextVisibleTreeItem(i),i&&i!==e&&s.push(i);else for(;i&&i!==e;)i=this._findPreviousVisibleTreeItem(i),i&&i!==e&&s.push(i);s.push(e)}return s}_onAppendChild(t){super._onAppendChild(t),t instanceof _e&&this._onAppendTreeViewItem(t)}_onRemoveChild(t){t instanceof _e&&this._onRemoveTreeViewItem(t),super._onRemoveChild(t)}_onAppendTreeViewItem(t){t.treeView=this,this._filter&&this._searchItems([t],this._filter),t.forEachChild((t=>{t instanceof _e&&this._onAppendTreeViewItem(t)}))}_onRemoveTreeViewItem(t){t.selected=!1,t.forEachChild((t=>{t instanceof _e&&this._onRemoveTreeViewItem(t)}))}_onChildKeyDown(t,e){if(-1!==["Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(t.key))switch(t.preventDefault(),t.stopPropagation(),t.key){case"ArrowLeft":if(e.numChildren>0&&e.open)e.open=!1;else{const t=e.parent;t instanceof _e&&this._selectSingleItem(t)}break;case"ArrowRight":if(e.numChildren>0)if(e.open){const t=e.firstChild;t instanceof _e&&this._selectSingleItem(t)}else e.open=!0;break;case"ArrowDown":if(this._selectedItems.length){const t=this._findNextVisibleTreeItem(e);t&&(this._pressedShift||this._pressedCtrl?t.selected=!0:this._selectSingleItem(t))}break;case"ArrowUp":if(this._selectedItems.length){const t=this._findPreviousVisibleTreeItem(e);t&&(this._pressedShift||this._pressedCtrl?t.selected=!0:this._selectSingleItem(t))}}}_onChildClick(t,e){if(0===t.button&&e.allowSelect)if(this._pressedCtrl)e.selected=!e.selected;else if(this._pressedShift){if(!this._selectedItems.length||1===this._selectedItems.length&&this._selectedItems[0]===e)return void(e.selected=!0);const t=this._selectedItems[this._selectedItems.length-1];this._openHierarchy(t);this._getChildrenRange(t,e).forEach((t=>{t.allowSelect&&(t.selected=!0)}))}else this._selectSingleItem(e)}_traverseDepthFirst(t){function e(s){if(s&&s instanceof _e&&(t(s),s.numChildren))for(const t of s.dom.childNodes)e(t.ui)}for(const t of this.dom.childNodes)e(t.ui)}_getTreeOrder(){const t=new Map;let e=0;return this._traverseDepthFirst((s=>{t.set(s,e++)})),t}_getChildIndex(t,e){return Array.prototype.indexOf.call(e.dom.childNodes,t.dom)-1}_onChildDragStart(t,e){if(this.allowDrag&&!this._dragging){if(this._dragItems=[],-1!==this._selectedItems.indexOf(e)){const t=[];let e=-1;for(let s=0;s<this._selectedItems.length;s++){let i=this._selectedItems[s].parent,n=0,r=!1;for(;i&&i instanceof _e;){if(-1!==this._selectedItems.indexOf(i)){r=!0;break}n++,i=i.parent}if(!r){if(-1===e)e=n;else if(e!==n)return;t.push(this._selectedItems[s])}}this._dragItems=t}else e.class.add(ve),this._dragItems.push(e);this._dragItems.length&&(this._dragItems.forEach((t=>{t.class.add(ve)})),this.isDragging=!0,this.emit("dragstart",this._dragItems.slice()))}}_onChildDragEnd(t,e){if(!this.allowDrag||!this._dragging)return;this._dragItems.forEach((t=>t.class.remove(ve)));let s=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this){s=!0;break}if(!s&&this._dragOverItem){if(this._dragItems.length>1){const t=this._getTreeOrder();this._dragItems.sort(((e,s)=>t.get(e)-t.get(s)))}if(this._dragItems.length){const t=[];if(this._onReparentFn){const e=[],s=t=>{let s=e.findIndex((e=>e.parent===t));return-1===s&&(e.push({parent:t,children:[...t.dom.childNodes]}),s=e.length-1),e[s].children};this._dragItems.forEach((e=>{if(e.parent===this._dragOverItem&&this._dragArea===xe)return;t.push({item:e,oldParent:e.parent});const i=s(e.parent),n=i.indexOf(e.dom);i.splice(n,1)})),t.forEach(((e,i)=>{if(this._dragArea===we){e.newParent=this._dragOverItem.parent;const t=s(this._dragOverItem.parent),i=t.indexOf(this._dragOverItem.dom);t.splice(i,0,e.item.dom),e.newChildIndex=i}else if(this._dragArea===xe){e.newParent=this._dragOverItem;const t=s(this._dragOverItem);t.push(e.item.dom),e.newChildIndex=t.length-1}else if(this._dragArea===Te){e.newParent=this._dragOverItem.parent;const n=s(this._dragOverItem.parent),r=i>0?t[i-1].item:this._dragOverItem,a=n.indexOf(r.dom);n.splice(a+1,0,e.item.dom),e.newChildIndex=a+1}e.newChildIndex--}))}else this._dragItems.forEach((e=>{e.parent===this._dragOverItem&&this._dragArea===xe||(t.push({item:e,oldParent:e.parent}),e.parent.remove(e))})),t.forEach(((e,s)=>{this._dragArea===we?(e.newParent=this._dragOverItem.parent,e.newParent.appendBefore(e.item,this._dragOverItem),e.newChildIndex=this._getChildIndex(e.item,e.newParent)):this._dragArea===xe?(e.newParent=this._dragOverItem,e.newParent.append(e.item),e.newParent.open=!0,e.newChildIndex=this._getChildIndex(e.item,e.newParent)):this._dragArea===Te&&(e.newParent=this._dragOverItem.parent,e.newParent.appendAfter(e.item,s>0?t[s-1].item:this._dragOverItem),e.newChildIndex=this._getChildIndex(e.item,e.newParent))}));t.length&&(this._onReparentFn&&this._onReparentFn(t),this.emit("reparent",t))}}this._dragItems=[],this.isDragging=!1,this.emit("dragend")}_onChildDragOver(t,e){this._allowDrag&&this._dragging&&(e.allowDrop&&-1===this._dragItems.indexOf(e)?this._dragOverItem=e:this._dragOverItem=null,this._updateDragHandle(),this._onDragMove(t))}_scrollWhileDragging(){this._dragging&&0!==this._dragScroll&&(this._dragScrollElement.dom.scrollTop+=8*this._dragScroll,this._dragOverItem=null,this._updateDragHandle())}_updateDragHandle(t,e){if(e||this._allowDrag&&this._dragging)if(t||(t=this._dragOverItem),t&&!t.hidden&&t.parentsOpen){const e=t._containerContents.dom.getBoundingClientRect();this._dragHandle.hidden=!1,this._dragHandle.class.remove(Te,we,xe),this._dragHandle.class.add(this._dragArea);const s=e.top;let i=e.left,n=e.width;if(this.dom.parentElement){const t=this.dom.parentElement.getBoundingClientRect();i=Math.max(i,t.left),n=Math.min(n,this.dom.parentElement.clientWidth-i+t.left)}this._dragHandle.style.top=`${s}px`,this._dragHandle.style.left=`${i}px`,this._dragHandle.style.width=n-7+"px"}else this._dragHandle.hidden=!0}_openHierarchy(t){t.parentsOpen=!0}_selectSingleItem(t){let e=this._selectedItems.length,s=!1;for(;e--;)this._selectedItems[e]&&this._selectedItems[e]!==t&&(this._selectedItems[e].selected=!1,s=!0);t.selected=!!s||!t.selected}_onChildSelected(t){this._selectedItems.push(t),this._openHierarchy(t),this.emit("select",t)}_onChildDeselected(t){const e=this._selectedItems.indexOf(t);-1!==e&&(this._selectedItems.splice(e,1),this.emit("deselect",t))}_onChildRename(t,e){if(this._filter){t.class.remove(Se);const e=this._filterResults.indexOf(t);-1!==e&&this._filterResults.splice(e,1),this._searchItems([t],this._filter)}this.emit("rename",t,e)}_searchItems(t,e){const s=wt(t,"text",e);s.length&&s.forEach((t=>{this._filterResults.push(t),t.class.add(Se)}))}_applyFilter(t){this._clearFilter(),this._wasDraggingAllowedBeforeFiltering=this._allowDrag,this._allowDrag=!1,this.class.add(ye);const e=[];this._traverseDepthFirst((t=>{e.push(t)})),this._searchItems(e,t)}_clearFilter(){this._filterResults.forEach((t=>{t.destroyed||t.class.remove(Se)})),this._filterResults.length=0,this.class.remove(ye),this._allowDrag=this._wasDraggingAllowedBeforeFiltering}showDragHandle(t){this._updateDragHandle(t,!0)}deselect(){let t=this._selectedItems.length;for(;t--;)this._selectedItems[t]&&(this._selectedItems[t].selected=!1)}clearTreeItems(){let t=this.dom.childNodes.length;for(;t--;){const e=this.dom.childNodes[t];if(!e)continue;const s=e.ui;s instanceof _e&&s.destroy()}this._selectedItems=[],this._dragItems=[],this._allowDrag=this._wasDraggingAllowedBeforeFiltering}set allowDrag(t){this._allowDrag=t,this._filter&&(this._wasDraggingAllowedBeforeFiltering=t)}get allowDrag(){return this._allowDrag}set isDragging(t){this._dragging!==t&&(t?(this._dragging=!0,this._updateDragHandle(),(this.scrollable||this._dragScrollElement!==this)&&(window.removeEventListener("mousemove",this._onMouseMove),window.addEventListener("mousemove",this._onMouseMove),this._dragScrollInterval||(this._dragScrollInterval=window.setInterval((()=>{this._scrollWhileDragging()}),1e3/60)))):(this._dragOverItem=null,this._updateDragHandle(),this._dragging=!1,window.removeEventListener("mousemove",this._onMouseMove),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null)))}get isDragging(){return this._dragging}get selected(){return this._selectedItems.slice()}set filter(t){this._filter!==t&&(this._filter=t,t?this._applyFilter(t):this._clearFilter())}get filter(){return this._filter}get pressedCtrl(){return this._pressedCtrl}get pressedShift(){return this._pressedShift}};Ee.EVENT_DRAGSTART="dragstart",Ee.EVENT_DRAGEND="dragend",Ee.EVENT_REPARENT="reparent",Ee.EVENT_SELECT="select",Ee.EVENT_DESELECT="deselect",Ee.EVENT_RENAME="rename";class Ce extends I{constructor(t){super(t),this.element=new Ee(Object.assign({},t)),this.loadChildren(this.props.children,this.element)}loadChildren(t,e){t&&(Array.isArray(t)||(t=[t]),t.forEach((t=>{const s=new _e({text:t.props.text,icon:t.props.icon,open:!1});t.props.onSelect&&s.on("select",t.props.onSelect),t.props.onDeselect&&s.on("deselect",t.props.onDeselect),e.append(s),this.loadChildren(t.props.children,s)})))}componentDidUpdate(){this.parentElement.removeChild(this.element.dom),this.element=new Ee(Object.assign({},this.props)),this.loadChildren(this.props.children,this.element),this.parentElement.appendChild(this.element.dom)}parentElementRendered(t){t&&(this.parentElement=t,this.parentElement.appendChild(this.element.dom))}render(){return d.createElement("div",{ref:this.parentElementRendered.bind(this)})}}Ce.ctor=Ee;class Ae extends I{constructor(t){super(t),this.elementClass=_e,this.onSelect=()=>{t.onSelect&&t.onSelect((()=>{this.element.selected=!1}))},t.onDeselect&&(this.onDeselect=t.onDeselect),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect),this.props.onDeselect&&this.element.on("deselect",this.onDeselect)}render(){return super.render()}}Ae.ctor=_e;let De=class extends L{constructor(t={}){var e,s,i;const n=Object.assign({},t);delete n.binding,super(n),this._inputs=[],this._applyingChange=!1,this._bindAllInputs=!1,this.class.add("pcui-vector-input");const r=Math.max(2,Math.min(4,null!==(e=t.dimensions)&&void 0!==e?e:3));for(let e=0;e<r;e++){const n=new j({min:t.min,max:t.max,precision:null!==(s=t.precision)&&void 0!==s?s:7,step:null!==(i=t.step)&&void 0!==i?i:1,stepPrecision:t.stepPrecision,renderChanges:t.renderChanges,placeholder:t.placeholder?Array.isArray(t.placeholder)?t.placeholder[e]:t.placeholder:null});n.on("slider:mousedown",(t=>{if(this._bindAllInputs=!!t.altKey,this._bindAllInputs){n.focus();for(let t=0;t<this._inputs.length;t++)this._inputs[t].class.add(b);this.binding&&(this.binding.historyCombine=!0)}})),n.on("slider:mouseup",(()=>{this._onInputChange(n),this._bindAllInputs=!1;for(let t=0;t<this._inputs.length;t++)this._inputs[t].class.remove(b);n.blur(),this.binding&&(this.binding.historyCombine=!1)})),n.on("change",(()=>{this._onInputChange(n)})),n.on("focus",(()=>{this.emit("focus")})),n.on("blur",(()=>{this.emit("blur")})),this.dom.appendChild(n.dom),n.parent=this,this._inputs.push(n)}t.binding&&(this.binding=t.binding),void 0!==t.value&&(this.value=t.value)}_onInputChange(t){if(this._applyingChange)return;const e=this._inputs.some((t=>t.class.contains(T)));if(e?this.class.add(T):this.class.remove(T),this._bindAllInputs){const e=Array(this._inputs.length).fill(t.value);this._updateValue(e)&&this._binding&&this._binding.setValue(e)}else this.emit("change",this.value)}_updateValue(t){return this.class.remove(T),JSON.stringify(this.value)!==JSON.stringify(t)&&(this._applyingChange=!0,this._inputs.forEach(((e,s)=>{const i=e.binding;let n=!1;i&&(n=i.applyingChange,i.applyingChange=!0),e.value=t&&void 0!==t[s]?t[s]:null,i&&(i.applyingChange=n)})),this.emit("change",this.value),this._applyingChange=!1,!0)}link(t,e){super.link(t,e),t=Array.isArray(t)?t:[t];if(1===(e=Array.isArray(e)?e:[e]).length||t.length!==e.length)for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(t,`${e[0]}.${s}`);else for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(t,e.map((t=>`${t}.${s}`)))}unlink(){super.unlink();for(const t of this._inputs)t.unlink()}focus(){this._inputs[0].focus()}blur(){for(const t of this._inputs)t.blur()}set value(t){if("string"==typeof t)try{if(t=JSON.parse(t),Array.isArray(t)&&t.some((t=>!Number.isFinite(t))))throw new Error("VectorInput value set to string which doesn't contain an array of numbers")}catch(e){console.error(e),t=[]}Array.isArray(t)||(t=[]);this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._inputs.map((t=>t.value))}set values(t){t=this._inputs.map(((e,s)=>t.map((t=>t?t[s]:void 0)))),this._inputs.forEach(((e,s)=>{e.values=t[s]}))}set binding(t){super.binding=t;for(const e of this._inputs)e.binding=t?t.clone():null}get binding(){return super.binding}set placeholder(t){for(let e=0;e<this._inputs.length;e++)this._inputs[e].placeholder=t[e]||t||null}get placeholder(){return this._inputs.map((t=>t.placeholder))}get inputs(){return this._inputs.slice()}set renderChanges(t){for(const e of this._inputs)e.renderChanges=t}get renderChanges(){return this._inputs[0].renderChanges}set min(t){for(const e of this._inputs)e.min=t}get min(){return this._inputs[0].min}set max(t){for(const e of this._inputs)e.max=t}get max(){return this._inputs[0].max}set precision(t){for(const e of this._inputs)e.precision=t}get precision(){return this._inputs[0].precision}set step(t){for(const e of this._inputs)e.step=t}get step(){return this._inputs[0].step}};L.register("vec2",De,{dimensions:2,renderChanges:!0}),L.register("vec3",De,{dimensions:3,renderChanges:!0}),L.register("vec4",De,{dimensions:4,renderChanges:!0});class Pe extends I{constructor(t){super(t),this.elementClass=De}render(){return super.render()}}Pe.ctor=De;const Le="2.10.6",Ie="5322cb8";function Re(t,e){for(const s in e){const i=e[s];Array.isArray(i)?t[s]=Re([],i):t[s]=i&&"object"==typeof i?Re({},i):i}return t}const Me={create:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))},ke={delimiter:"/",join(...t){let e=t[0];for(let s=0;s<t.length-1;s++){const i=t[s],n=t[s+1];n[0]!==ke.delimiter?i&&n&&i[i.length-1]!==ke.delimiter&&n[0]!==ke.delimiter?e+=ke.delimiter+n:e+=n:e=n}return e},normalize(t){const e=t.startsWith(ke.delimiter),s=t.endsWith(ke.delimiter),i=t.split("/");let n="",r=[];for(let t=0;t<i.length;t++)""!==i[t]&&"."!==i[t]&&(".."===i[t]&&r.length>0?r=r.slice(0,r.length-2):(t>0&&r.push(ke.delimiter),r.push(i[t])));return n=r.join(""),e||n[0]!==ke.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==ke.delimiter&&(n+=ke.delimiter),n},split(t){const e=t.lastIndexOf(ke.delimiter);return-1!==e?[t.substring(0,e),t.substring(e+1)]:["",t]},getBasename:t=>ke.split(t)[1],getDirectory:t=>ke.split(t)[0],getExtension(t){const e=t.split("?")[0].split(".").pop();return e!==t?`.${e}`:""},isRelativePath:t=>"/"!==t.charAt(0)&&null===t.match(/:\/\//),extractPath(t){let e="";const s=t.split("/");let i=0;if(s.length>1)if(ke.isRelativePath(t))if("."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:`/${s[i]}`;else if(".."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:`/${s[i]}`;else for(e=".",i=0;i<s.length-1;++i)e+=`/${s[i]}`;else for(i=0;i<s.length-1;++i)e+=0===i?s[i]:`/${s[i]}`;return e}},Oe="undefined"!=typeof navigator?navigator.userAgent:"",Fe="undefined"!=typeof window?"browser":"undefined"!=typeof global?"node":"worker",Ne=/android/i.test(Oe)?"android":/ip(?:[ao]d|hone)/i.test(Oe)?"ios":/windows/i.test(Oe)?"windows":/mac os/i.test(Oe)?"osx":/linux/i.test(Oe)?"linux":/cros/i.test(Oe)?"cros":null,Be="browser"!==Fe?null:/Chrome\/|Chromium\/|Edg.*\//.test(Oe)?"chrome":/Safari\//.test(Oe)?"safari":/Firefox\//.test(Oe)?"firefox":"other",Ue={name:Ne,environment:Fe,browser:"browser"===Fe,worker:"worker"===Fe,android:"android"===Ne,passiveEvents:(()=>{let t=!1;try{const e=Object.defineProperty({},"passive",{get:function(){return t=!0,!1}});window.addEventListener("testpassive",null,e),window.removeEventListener("testpassive",null,e)}catch(t){}return t})(),browserName:Be};class ze{constructor(t,e,s,i,n=!1){this._removed=!1,this.handler=t,this.name=e,this.callback=s,this.scope=i,this._once=n}off(){this._removed||this.handler.offByHandle(this)}on(t,e,s=this){return this.handler._addCallback(t,e,s,!1)}once(t,e,s=this){return this.handler._addCallback(t,e,s,!0)}set removed(t){t&&(this._removed=!0)}get removed(){return this._removed}toJSON(t){}}class Ve{initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(t,e,s,i){if(this._callbacks.has(t)||this._callbacks.set(t,[]),this._callbackActive.has(t)){const e=this._callbackActive.get(t);e&&e===this._callbacks.get(t)&&this._callbackActive.set(t,e.slice())}const n=new ze(this,t,e,s,i);return this._callbacks.get(t).push(n),n}on(t,e,s=this){return this._addCallback(t,e,s,!1)}once(t,e,s=this){return this._addCallback(t,e,s,!0)}off(t,e,s){if(t)this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());else for(const[t,e]of this._callbackActive)this._callbacks.has(t)&&this._callbacks.get(t)===e&&this._callbackActive.set(t,e.slice());if(t)if(e){const i=this._callbacks.get(t);if(!i)return this;for(let t=0;t<i.length;t++)i[t].callback===e&&(s&&i[t].scope!==s||(i[t].removed=!0,i.splice(t,1),t--));0===i.length&&this._callbacks.delete(t)}else{const e=this._callbacks.get(t);if(e){for(let t=0;t<e.length;t++)e[t].removed=!0;this._callbacks.delete(t)}}else{for(const t of this._callbacks.values())for(let e=0;e<t.length;e++)t[e].removed=!0;this._callbacks.clear()}return this}offByHandle(t){const e=t.name;t.removed=!0,this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());const s=this._callbacks.get(e);if(!s)return this;const i=s.indexOf(t);return-1!==i&&(s.splice(i,1),0===s.length&&this._callbacks.delete(e)),this}fire(t,e,s,i,n,r,a,o,l){if(!t)return this;const h=this._callbacks.get(t);if(!h)return this;let c;this._callbackActive.has(t)?this._callbackActive.get(t)!==h&&(c=h.slice()):this._callbackActive.set(t,h);for(let h=0;(c||this._callbackActive.get(t))&&h<(c||this._callbackActive.get(t)).length;h++){const d=(c||this._callbackActive.get(t))[h];if(d.callback&&(d.callback.call(d.scope,e,s,i,n,r,a,o,l),d._once)){const e=this._callbacks.get(t),s=e?e.indexOf(d):-1;if(-1!==s){this._callbackActive.get(t)===e&&this._callbackActive.set(t,this._callbackActive.get(t).slice());const i=this._callbacks.get(t);if(!i)continue;i[s].removed=!0,i.splice(s,1),0===i.length&&this._callbacks.delete(t)}}}return c||this._callbackActive.delete(t),this}hasEvent(t){return!!this._callbacks.get(t)?.length}constructor(){this._callbacks=new Map,this._callbackActive=new Map}}class He{static{this.modules={}}static{this.wasmSupported=(t=>{const e={};let s=e;return()=>(s===e&&(s=t()),s)})((()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1}))}static loadScript(t,e){const s=document.createElement("script");s.setAttribute("src",t),s.onload=()=>{e(null)},s.onerror=()=>{e(`Failed to load script='${t}'`)},document.body.appendChild(s)}static loadWasm(t,e,s){const i=He.wasmSupported()&&e.glueUrl&&e.wasmUrl?e.glueUrl:e.fallbackUrl;i?He.loadScript(i,(i=>{if(i)s(i,null);else{const i=window[t];window[t]=void 0,i({locateFile:()=>e.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then((t=>{s(null,t)}))}})):s("No supported wasm modules found.",null)}static getModule(t){return He.modules.hasOwnProperty(t)||(He.modules[t]={config:null,initializing:!1,instance:null,callbacks:[]}),He.modules[t]}static initialize(t,e){if(e.initializing)return;const s=e.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(e.initializing=!0,He.loadWasm(t,s,((i,n)=>{i?s.errorHandler?s.errorHandler(i):console.error(`failed to initialize module=${t} error=${i}`):(e.instance=n,e.callbacks.forEach((t=>{t(n)})))})))}}class Ge{static setConfig(t,e){const s=He.getModule(t);s.config=e,s.callbacks.length>0&&He.initialize(t,s)}static getConfig(t){return He.modules?.[t]?.config}static getInstance(t,e){const s=He.getModule(t);s.instance?e(s.instance):(s.callbacks.push(e),s.config&&He.initialize(t,s))}}class We{constructor(t){this.offset=0,this.arraybuffer=t,this.dataView=new DataView(t)}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(t=0){this.offset=t}skip(t){this.offset+=t}align(t){this.offset=this.offset+t-1&~(t-1)}_inc(t){return this.offset+=t,this.offset-t}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(t){let e="";for(let s=0;s<t;++s)e+=this.readChar();return e}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(t){for(let e=0;e<t.length;++e)t[e]=this.readU8()}readLine(){const t=this.dataView;let e="";for(;!(this.offset>=t.byteLength);){const t=String.fromCharCode(this.readU8());if("\n"===t)break;e+=t}return e}}class je{constructor(t){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=t.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(t){let e=0,s=this.items.length-1;const i=t[this._sortBy];let n,r;for(;e<=s;)n=Math.floor((e+s)/2),r=this.items[n][this._sortBy],r<=i?e=n+1:r>i&&(s=n-1);return e}_doSort(t,e){const s=this._sortBy;return t[s]-e[s]}insert(t){const e=this._binarySearch(t);this.items.splice(e,0,t),this.length++,this.loopIndex>=e&&this.loopIndex++}append(t){this.items.push(t),this.length++}remove(t){const e=this.items.indexOf(t);e<0||(this.items.splice(e,1),this.length--,this.loopIndex>=e&&this.loopIndex--)}sort(){const t=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==t&&(this.loopIndex=this.items.indexOf(t))}}class Xe extends Ve{static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_CHANGE="change"}constructor(t){super(),this._index={},this._list=[],this._parent=t}add(...t){let e=!1;const s=this._processArguments(t,!0);if(!s.length)return e;for(let t=0;t<s.length;t++)this._index[s[t]]||(e=!0,this._index[s[t]]=!0,this._list.push(s[t]),this.fire("add",s[t],this._parent));return e&&this.fire("change",this._parent),e}remove(...t){let e=!1;if(!this._list.length)return e;const s=this._processArguments(t,!0);if(!s.length)return e;for(let t=0;t<s.length;t++)this._index[s[t]]&&(e=!0,delete this._index[s[t]],this._list.splice(this._list.indexOf(s[t]),1),this.fire("remove",s[t],this._parent));return e&&this.fire("change",this._parent),e}clear(){if(!this._list.length)return;const t=this._list.slice(0);this._list=[],this._index={};for(let e=0;e<t.length;e++)this.fire("remove",t[e],this._parent);this.fire("change",this._parent)}has(...t){return!!this._list.length&&this._has(this._processArguments(t))}_has(t){if(!this._list.length||!t.length)return!1;for(let e=0;e<t.length;e++)if(1===t[e].length){if(this._index[t[e][0]])return!0}else{let s=!0;for(let i=0;i<t[e].length;i++)if(!this._index[t[e][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(t,e){const s=[];let i=[];if(!t||!t.length)return s;for(let n=0;n<t.length;n++)if(t[n]instanceof Array){e||(i=[]);for(let r=0;r<t[n].length;r++)"string"==typeof t[n][r]&&(e?s.push(t[n][r]):i.push(t[n][r]));!e&&i.length&&s.push(i)}else"string"==typeof t[n]&&(e?s.push(t[n]):s.push([t[n]]));return s}get size(){return this._list.length}}const $e="undefined"!=typeof window&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now,qe=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class Ke{constructor(t){const e=t.match(qe);this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9]}toString(){let t="";return this.scheme&&(t+=`${this.scheme}:`),this.authority&&(t+=`//${this.authority}`),t+=this.path,this.query&&(t+=`?${this.query}`),this.fragment&&(t+=`#${this.fragment}`),t}getQuery(){const t={};if(this.query){const e=decodeURIComponent(this.query).split("&");for(const s of e){const e=s.split("=");t[e[0]]=e[1]}}return t}setQuery(t){let e="";for(const s in t)t.hasOwnProperty(s)&&(""!==e&&(e+="&"),e+=`${encodeURIComponent(s)}=${encodeURIComponent(t[s])}`);this.query=e}}class Ye{static{this._traceChannels=new Set}static{this.stack=!1}static set(t,e=!0){}static get(t){return Ye._traceChannels.has(t)}}const Qe={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:(t,e,s)=>t>=s?s:t<=e?e:t,intToBytes24:t=>[t>>16&255,t>>8&255,255&t],intToBytes32:t=>[t>>24&255,t>>16&255,t>>8&255,255&t],bytesToInt24:(t,e,s)=>(t.length&&(s=t[2],e=t[1],t=t[0]),t<<16|e<<8|s),bytesToInt32:(t,e,s,i)=>(t.length&&(i=t[3],s=t[2],e=t[1],t=t[0]),(t<<24|e<<16|s<<8|i)>>>0),lerp:(t,e,s)=>t+(e-t)*Qe.clamp(s,0,1),lerpAngle:(t,e,s)=>(e-t>180&&(e-=360),e-t<-180&&(e+=360),Qe.lerp(t,e,Qe.clamp(s,0,1))),powerOfTwo:t=>0!==t&&!(t&t-1),nextPowerOfTwo:t=>(t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t),nearestPowerOfTwo:t=>Math.pow(2,Math.round(Math.log2(t))),random(t,e){const s=e-t;return Math.random()*s+t},smoothstep:(t,e,s)=>s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*(3-2*s),smootherstep:(t,e,s)=>s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*s*(s*(6*s-15)+10),roundUp:(t,e)=>0===e?t:Math.ceil(t/e)*e,between(t,e,s,i){const n=Math.min(e,s),r=Math.max(e,s);return i?t>=n&&t<=r:t>n&&t<r}};class Ze{constructor(t=0,e=0,s=0,i=1){const n=t.length;3===n||4===n?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=t[3]??1):(this.r=t,this.g=e,this.b=s,this.a=i)}clone(){return new(0,this.constructor)(this.r,this.g,this.b,this.a)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}equals(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}set(t,e,s,i=1){return this.r=t,this.g=e,this.b=s,this.a=i,this}lerp(t,e,s){return this.r=t.r+s*(e.r-t.r),this.g=t.g+s*(e.g-t.g),this.b=t.b+s*(e.b-t.b),this.a=t.a+s*(e.a-t.a),this}linear(t=this){return this.r=Math.pow(t.r,2.2),this.g=Math.pow(t.g,2.2),this.b=Math.pow(t.b,2.2),this.a=t.a,this}gamma(t=this){return this.r=Math.pow(t.r,1/2.2),this.g=Math.pow(t.g,1/2.2),this.b=Math.pow(t.b,1/2.2),this.a=t.a,this}mulScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}fromString(t){const e=parseInt(t.replace("#","0x"),16);let s;return t.length>7?s=Qe.intToBytes32(e):(s=Qe.intToBytes24(e),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}fromArray(t,e=0){return this.r=t[e]??this.r,this.g=t[e+1]??this.g,this.b=t[e+2]??this.b,this.a=t[e+3]??this.a,this}toString(t,e){const{r:s,g:i,b:n,a:r}=this;if(e||s>1||i>1||n>1)return`${s.toFixed(3)}, ${i.toFixed(3)}, ${n.toFixed(3)}, ${r.toFixed(3)}`;let a=`#${((1<<24)+(Math.round(255*s)<<16)+(Math.round(255*i)<<8)+Math.round(255*n)).toString(16).slice(1)}`;if(!0===t){const t=Math.round(255*r).toString(16);this.a<16/255?a+=`0${t}`:a+=t}return a}toArray(t=[],e=0,s=!0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,s&&(t[e+3]=this.a),t}static{this.BLACK=Object.freeze(new Ze(0,0,0,1))}static{this.BLUE=Object.freeze(new Ze(0,0,1,1))}static{this.CYAN=Object.freeze(new Ze(0,1,1,1))}static{this.GRAY=Object.freeze(new Ze(.5,.5,.5,1))}static{this.GREEN=Object.freeze(new Ze(0,1,0,1))}static{this.MAGENTA=Object.freeze(new Ze(1,0,1,1))}static{this.RED=Object.freeze(new Ze(1,0,0,1))}static{this.WHITE=Object.freeze(new Ze(1,1,1,1))}static{this.YELLOW=Object.freeze(new Ze(1,1,0,1))}}class Je{constructor(t,e=0){this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=t,this._reset(e)}evaluate(t,e=!1){let s;(e||t<this._left||t>=this._right)&&this._reset(t);const i=this._curve.type;if(5===i)s=this._p0;else{const e=0===this._recip?0:(t-this._left)*this._recip;s=0===i?Qe.lerp(this._p0,this._p1,e):1===i?Qe.lerp(this._p0,this._p1,e*e*(3-2*e)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,e)}return s}_reset(t){const e=this._curve.keys,s=e.length;if(s)if(t<e[0][0])this._left=-1/0,this._right=e[0][0],this._recip=0,this._p0=this._p1=e[0][1],this._m0=this._m1=0;else if(t>=e[s-1][0])this._left=e[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=e[s-1][1],this._m0=this._m1=0;else{let s=0;for(;t>=e[s+1][0];)s++;this._left=e[s][0],this._right=e[s+1][0];const i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=e[s][1],this._p1=e[s+1][1],4===this._curve.type&&this._calcTangents(e,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_calcTangents(t,e){let s;const i=t[e],n=t[e+1];let r;if(s=0===e?[t[0][0]+(t[0][0]-t[1][0]),t[0][1]+(t[0][1]-t[1][1])]:t[e-1],r=e===t.length-2?[t[e+1][0]+(t[e+1][0]-t[e][0]),t[e+1][1]+(t[e+1][1]-t[e][1])]:t[e+2],4===this._curve.type){const t=2*(n[0]-i[0])/(n[0]-s[0]),e=2*(n[0]-i[0])/(r[0]-i[0]);this._m0=this._curve.tension*(isFinite(t)?t:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(e)?e:0)*(r[1]-i[1])}else{const t=(n[0]-i[0])/(i[0]-s[0]),e=(n[0]-i[0])/(r[0]-n[0]),a=i[1]+(s[1]-i[1])*(isFinite(t)?t:0),o=n[1]+(r[1]-n[1])*(isFinite(e)?e:0),l=this._curve.tension;this._m0=l*(n[1]-a),this._m1=l*(o-i[1])}}_evaluateHermite(t,e,s,i,n){const r=n*n,a=n+n,o=1-n,l=o*o;return t*((1+a)*l)+s*(n*l)+e*(r*(3-a))+i*(r*(n-1))}}class ts{constructor(t){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new Je(this),t)for(let e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()}get length(){return this.keys.length}add(t,e){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>t);n++);const r=[t,e];return this.keys.splice(n,0,r),r}get(t){return this.keys[t]}sort(){this.keys.sort(((t,e)=>t[0]-e[0]))}value(t){return this._eval.evaluate(t,!0)}closest(t){const e=this.keys,s=e.length;let i=2,n=null;for(let r=0;r<s;r++){const s=Math.abs(t-e[r][0]);if(!(i>=s))break;i=s,n=e[r]}return n}clone(){const t=new this.constructor;return t.keys=this.keys.map((t=>[...t])),t.type=this.type,t.tension=this.tension,t}quantize(t){t=Math.max(t,2);const e=new Float32Array(t),s=1/(t-1);e[0]=this._eval.evaluate(0,!0);for(let i=1;i<t;i++)e[i]=this._eval.evaluate(s*i);return e}quantizeClamped(t,e,s){const i=this.quantize(t);for(let t=0;t<i.length;++t)i[t]=Math.min(s,Math.max(e,i[t]));return i}}class es{constructor(...t){if(this.curves=[],this._type=1,t.length>1)for(let e=0;e<t.length;e++)this.curves.push(new ts(t[e]));else if(0===t.length)this.curves.push(new ts);else{const e=t[0];if("number"==typeof e)for(let t=0;t<e;t++)this.curves.push(new ts);else for(let t=0;t<e.length;t++)this.curves.push(new ts(e[t]))}}get length(){return this.curves.length}set type(t){this._type=t;for(let e=0;e<this.curves.length;e++)this.curves[e].type=t}get type(){return this._type}get(t){return this.curves[t]}value(t,e=[]){const s=this.curves.length;e.length=s;for(let i=0;i<s;i++)e[i]=this.curves[i].value(t);return e}clone(){const t=new this.constructor;t.curves=[];for(let e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t}quantize(t){t=Math.max(t,2);const e=this.curves.length,s=new Float32Array(t*e),i=1/(t-1);for(let n=0;n<e;n++){const r=new Je(this.curves[n]);for(let a=0;a<t;a++)s[a*e+n]=r.evaluate(i*a)}return s}quantizeClamped(t,e,s){const i=this.quantize(t);for(let t=0;t<i.length;++t)i[t]=Math.min(s,Math.max(e,i[t]));return i}}const ss=new Float32Array(1),is=new Int32Array(ss.buffer);class ns{static float2Half(t){ss[0]=t;const e=is[0];let s=e>>16&32768,i=e>>12&2047;const n=e>>23&255;return n<103?s:n>142?(s|=31744,s|=(255===n?0:1)&&8388607&e,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=1&i,s)}static float2RGBA8(t,e){ss[0]=t;const s=is[0];e.r=(s>>24&255)/255,e.g=(s>>16&255)/255,e.b=(s>>8&255)/255,e.a=(255&s)/255}}class rs{constructor(t=0,e=0,s=0){3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t,this.y=e,this.z=s)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addScaled(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}cross(t,e){const s=t.x,i=t.y,n=t.z,r=e.x,a=e.y,o=e.z;return this.x=i*o-a*n,this.y=n*r-o*s,this.z=s*a-r*i,this}distance(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return Math.sqrt(e*e+s*s+i*i)}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}equalsApprox(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e&&Math.abs(this.z-t.z)<e}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(t=this){const e=t.x*t.x+t.y*t.y+t.z*t.z;if(e>0){const s=1/Math.sqrt(e);this.x=t.x*s,this.y=t.y*s,this.z=t.z*s}return this}floor(t=this){return this.x=Math.floor(t.x),this.y=Math.floor(t.y),this.z=Math.floor(t.z),this}ceil(t=this){return this.x=Math.ceil(t.x),this.y=Math.ceil(t.y),this.z=Math.ceil(t.z),this}round(t=this){return this.x=Math.round(t.x),this.y=Math.round(t.y),this.z=Math.round(t.z),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this}project(t){const e=(this.x*t.x+this.y*t.y+this.z*t.z)/(t.x*t.x+t.y*t.y+t.z*t.z);return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}fromArray(t,e=0){return this.x=t[e]??this.x,this.y=t[e+1]??this.y,this.z=t[e+2]??this.z,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}static{this.ZERO=Object.freeze(new rs(0,0,0))}static{this.HALF=Object.freeze(new rs(.5,.5,.5))}static{this.ONE=Object.freeze(new rs(1,1,1))}static{this.UP=Object.freeze(new rs(0,1,0))}static{this.DOWN=Object.freeze(new rs(0,-1,0))}static{this.RIGHT=Object.freeze(new rs(1,0,0))}static{this.LEFT=Object.freeze(new rs(-1,0,0))}static{this.FORWARD=Object.freeze(new rs(0,0,-1))}static{this.BACK=Object.freeze(new rs(0,0,1))}}class as{constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}clone(){return(new(0,this.constructor)).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this}getX(t=new rs){return t.set(this.data[0],this.data[1],this.data[2])}getY(t=new rs){return t.set(this.data[3],this.data[4],this.data[5])}getZ(t=new rs){return t.set(this.data[6],this.data[7],this.data[8])}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&1===t[4]&&0===t[5]&&0===t[6]&&0===t[7]&&1===t[8]}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}toString(){return`[${this.data.join(", ")}]`}transpose(t=this){const e=t.data,s=this.data;if(e===s){let t;t=e[1],s[1]=e[3],s[3]=t,t=e[2],s[2]=e[6],s[6]=t,t=e[5],s[5]=e[7],s[7]=t}else s[0]=e[0],s[1]=e[3],s[2]=e[6],s[3]=e[1],s[4]=e[4],s[5]=e[7],s[6]=e[2],s[7]=e[5],s[8]=e[8];return this}setFromMat4(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[4],s[4]=e[5],s[5]=e[6],s[6]=e[8],s[7]=e[9],s[8]=e[10],this}setFromQuat(t){const e=t.x,s=t.y,i=t.z,n=t.w,r=e+e,a=s+s,o=i+i,l=e*r,h=e*a,c=e*o,d=s*a,u=s*o,f=i*o,p=n*r,m=n*a,_=n*o,g=this.data;return g[0]=1-(d+f),g[1]=h+_,g[2]=c-m,g[3]=h-_,g[4]=1-(l+f),g[5]=u+p,g[6]=c+m,g[7]=u-p,g[8]=1-(l+d),this}invertMat4(t){const e=t.data,s=e[0],i=e[1],n=e[2],r=e[4],a=e[5],o=e[6],l=e[8],h=e[9],c=e[10],d=c*a-o*h,u=-c*i+n*h,f=o*i-n*a,p=-c*r+o*l,m=c*s-n*l,_=-o*s+n*r,g=h*r-a*l,v=-h*s+i*l,b=a*s-i*r,y=s*d+i*p+n*g;if(0===y)this.setIdentity();else{const t=1/y,e=this.data;e[0]=d*t,e[1]=u*t,e[2]=f*t,e[3]=p*t,e[4]=m*t,e[5]=_*t,e[6]=g*t,e[7]=v*t,e[8]=b*t}return this}transformVector(t,e=new rs){const s=this.data,{x:i,y:n,z:r}=t;return e.x=i*s[0]+n*s[3]+r*s[6],e.y=i*s[1]+n*s[4]+r*s[7],e.z=i*s[2]+n*s[5]+r*s[8],e}static{this.IDENTITY=Object.freeze(new as)}static{this.ZERO=Object.freeze((new as).set([0,0,0,0,0,0,0,0,0]))}}class os{constructor(t=0,e=0){2===t.length?(this.x=t[0],this.y=t[1]):(this.x=t,this.y=e)}add(t){return this.x+=t.x,this.y+=t.y,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addScaled(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}clone(){return new(0,this.constructor)(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}cross(t){return this.x*t.y-this.y*t.x}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}div(t){return this.x/=t.x,this.y/=t.y,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}divScalar(t){return this.x/=t,this.y/=t,this}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}equalsApprox(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this}mul(t){return this.x*=t.x,this.y*=t.y,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}mulScalar(t){return this.x*=t,this.y*=t,this}normalize(t=this){const e=t.x*t.x+t.y*t.y;if(e>0){const s=1/Math.sqrt(e);this.x=t.x*s,this.y=t.y*s}return this}rotate(t){const e=Math.atan2(this.x,this.y)+t*Qe.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(e)*s,this.y=Math.cos(e)*s,this}angle(){return Math.atan2(this.x,this.y)*Qe.RAD_TO_DEG}angleTo(t){return Math.atan2(this.x*t.y+this.y*t.x,this.x*t.x+this.y*t.y)*Qe.RAD_TO_DEG}floor(t=this){return this.x=Math.floor(t.x),this.y=Math.floor(t.y),this}ceil(t=this){return this.x=Math.ceil(t.x),this.y=Math.ceil(t.y),this}round(t=this){return this.x=Math.round(t.x),this.y=Math.round(t.y),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),this}set(t,e){return this.x=t,this.y=e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}subScalar(t){return this.x-=t,this.y-=t,this}fromArray(t,e=0){return this.x=t[e]??this.x,this.y=t[e+1]??this.y,this}toString(){return`[${this.x}, ${this.y}]`}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}static angleRad(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}static{this.ZERO=Object.freeze(new os(0,0))}static{this.HALF=Object.freeze(new os(.5,.5))}static{this.ONE=Object.freeze(new os(1,1))}static{this.UP=Object.freeze(new os(0,1))}static{this.DOWN=Object.freeze(new os(0,-1))}static{this.RIGHT=Object.freeze(new os(1,0))}static{this.LEFT=Object.freeze(new os(-1,0))}}class ls{constructor(t=0,e=0,s=0,i=0){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addScaled(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this.w=t.w/e.w,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}equalsApprox(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e&&Math.abs(this.z-t.z)<e&&Math.abs(this.w-t.w)<e}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this.w=t.w+s*(e.w-t.w),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}normalize(t=this){const e=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;if(e>0){const s=1/Math.sqrt(e);this.x=t.x*s,this.y=t.y*s,this.z=t.z*s,this.w=t.w*s}return this}floor(t=this){return this.x=Math.floor(t.x),this.y=Math.floor(t.y),this.z=Math.floor(t.z),this.w=Math.floor(t.w),this}ceil(t=this){return this.x=Math.ceil(t.x),this.y=Math.ceil(t.y),this.z=Math.ceil(t.z),this.w=Math.ceil(t.w),this}round(t=this){return this.x=Math.round(t.x),this.y=Math.round(t.y),this.z=Math.round(t.z),this.w=Math.round(t.w),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}fromArray(t,e=0){return this.x=t[e]??this.x,this.y=t[e+1]??this.y,this.z=t[e+2]??this.z,this.w=t[e+3]??this.w,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}static{this.ZERO=Object.freeze(new ls(0,0,0,0))}static{this.HALF=Object.freeze(new ls(.5,.5,.5,.5))}static{this.ONE=Object.freeze(new ls(1,1,1,1))}}const hs=new os,cs=new rs,ds=new rs,us=new rs,fs=new rs;class ps{constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}static _getPerspectiveHalfSize(t,e,s,i,n){n?(t.x=i*Math.tan(e*Math.PI/360),t.y=t.x/s):(t.y=i*Math.tan(e*Math.PI/360),t.x=t.y*s)}add2(t,e){const s=t.data,i=e.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(t){return this.add2(this,t)}clone(){return(new(0,this.constructor)).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]&&e[9]===s[9]&&e[10]===s[10]&&e[11]===s[11]&&e[12]===s[12]&&e[13]===s[13]&&e[14]===s[14]&&e[15]===s[15]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]}mul2(t,e){const s=t.data,i=e.data,n=this.data,r=s[0],a=s[1],o=s[2],l=s[3],h=s[4],c=s[5],d=s[6],u=s[7],f=s[8],p=s[9],m=s[10],_=s[11],g=s[12],v=s[13],b=s[14],y=s[15];let S,x,w,T;return S=i[0],x=i[1],w=i[2],T=i[3],n[0]=r*S+h*x+f*w+g*T,n[1]=a*S+c*x+p*w+v*T,n[2]=o*S+d*x+m*w+b*T,n[3]=l*S+u*x+_*w+y*T,S=i[4],x=i[5],w=i[6],T=i[7],n[4]=r*S+h*x+f*w+g*T,n[5]=a*S+c*x+p*w+v*T,n[6]=o*S+d*x+m*w+b*T,n[7]=l*S+u*x+_*w+y*T,S=i[8],x=i[9],w=i[10],T=i[11],n[8]=r*S+h*x+f*w+g*T,n[9]=a*S+c*x+p*w+v*T,n[10]=o*S+d*x+m*w+b*T,n[11]=l*S+u*x+_*w+y*T,S=i[12],x=i[13],w=i[14],T=i[15],n[12]=r*S+h*x+f*w+g*T,n[13]=a*S+c*x+p*w+v*T,n[14]=o*S+d*x+m*w+b*T,n[15]=l*S+u*x+_*w+y*T,this}mulAffine2(t,e){const s=t.data,i=e.data,n=this.data,r=s[0],a=s[1],o=s[2],l=s[4],h=s[5],c=s[6],d=s[8],u=s[9],f=s[10],p=s[12],m=s[13],_=s[14];let g,v,b;return g=i[0],v=i[1],b=i[2],n[0]=r*g+l*v+d*b,n[1]=a*g+h*v+u*b,n[2]=o*g+c*v+f*b,n[3]=0,g=i[4],v=i[5],b=i[6],n[4]=r*g+l*v+d*b,n[5]=a*g+h*v+u*b,n[6]=o*g+c*v+f*b,n[7]=0,g=i[8],v=i[9],b=i[10],n[8]=r*g+l*v+d*b,n[9]=a*g+h*v+u*b,n[10]=o*g+c*v+f*b,n[11]=0,g=i[12],v=i[13],b=i[14],n[12]=r*g+l*v+d*b+p,n[13]=a*g+h*v+u*b+m,n[14]=o*g+c*v+f*b+_,n[15]=1,this}mul(t){return this.mul2(this,t)}transformPoint(t,e=new rs){const s=this.data,{x:i,y:n,z:r}=t;return e.x=i*s[0]+n*s[4]+r*s[8]+s[12],e.y=i*s[1]+n*s[5]+r*s[9]+s[13],e.z=i*s[2]+n*s[6]+r*s[10]+s[14],e}transformVector(t,e=new rs){const s=this.data,{x:i,y:n,z:r}=t;return e.x=i*s[0]+n*s[4]+r*s[8],e.y=i*s[1]+n*s[5]+r*s[9],e.z=i*s[2]+n*s[6]+r*s[10],e}transformVec4(t,e=new ls){const s=this.data,{x:i,y:n,z:r,w:a}=t;return e.x=i*s[0]+n*s[4]+r*s[8]+a*s[12],e.y=i*s[1]+n*s[5]+r*s[9]+a*s[13],e.z=i*s[2]+n*s[6]+r*s[10]+a*s[14],e.w=i*s[3]+n*s[7]+r*s[11]+a*s[15],e}setLookAt(t,e,s){us.sub2(t,e).normalize(),ds.copy(s).normalize(),cs.cross(ds,us).normalize(),ds.cross(us,cs);const i=this.data;return i[0]=cs.x,i[1]=cs.y,i[2]=cs.z,i[3]=0,i[4]=ds.x,i[5]=ds.y,i[6]=ds.z,i[7]=0,i[8]=us.x,i[9]=us.y,i[10]=us.z,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}setFrustum(t,e,s,i,n,r){const a=2*n,o=e-t,l=i-s,h=r-n,c=this.data;return c[0]=a/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=a/l,c[6]=0,c[7]=0,c[8]=(e+t)/o,c[9]=(i+s)/l,c[10]=(-r-n)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-a*r/h,c[15]=0,this}setPerspective(t,e,s,i,n){return ps._getPerspectiveHalfSize(hs,t,e,s,n),this.setFrustum(-hs.x,hs.x,-hs.y,hs.y,s,i)}setOrtho(t,e,s,i,n,r){const a=this.data;return a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(e+t)/(e-t),a[13]=-(i+s)/(i-s),a[14]=-(r+n)/(r-n),a[15]=1,this}setFromAxisAngle(t,e){e*=Qe.DEG_TO_RAD;const{x:s,y:i,z:n}=t,r=Math.cos(e),a=Math.sin(e),o=1-r,l=o*s,h=o*i,c=this.data;return c[0]=l*s+r,c[1]=l*i+a*n,c[2]=l*n-a*i,c[3]=0,c[4]=l*i-a*n,c[5]=h*i+r,c[6]=h*n+a*s,c[7]=0,c[8]=l*n+a*i,c[9]=h*n-s*a,c[10]=o*n*n+r,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(t,e,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=s,i[15]=1,this}setScale(t,e,s){const i=this.data;return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(t,e,s,i){const n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=t+.5*s,n[13]=e+.5*i,n[14]=.5,n[15]=1,this}setReflection(t,e){const s=t.x,i=t.y,n=t.z,r=this.data;return r[0]=1-2*s*s,r[1]=-2*s*i,r[2]=-2*s*n,r[3]=0,r[4]=-2*s*i,r[5]=1-2*i*i,r[6]=-2*i*n,r[7]=0,r[8]=-2*s*n,r[9]=-2*i*n,r[10]=1-2*n*n,r[11]=0,r[12]=-2*s*e,r[13]=-2*i*e,r[14]=-2*n*e,r[15]=1,this}invert(t=this){const e=t.data,s=e[0],i=e[1],n=e[2],r=e[3],a=e[4],o=e[5],l=e[6],h=e[7],c=e[8],d=e[9],u=e[10],f=e[11],p=e[12],m=e[13],_=e[14],g=e[15],v=s*o-i*a,b=s*l-n*a,y=s*h-r*a,S=i*l-n*o,x=i*h-r*o,w=n*h-r*l,T=c*m-d*p,E=c*_-u*p,C=c*g-f*p,A=d*_-u*m,D=d*g-f*m,P=u*g-f*_,L=v*P-b*D+y*A+S*C-x*E+w*T;if(0===L)this.setIdentity();else{const t=1/L,e=this.data;e[0]=(o*P-l*D+h*A)*t,e[1]=(-i*P+n*D-r*A)*t,e[2]=(m*w-_*x+g*S)*t,e[3]=(-d*w+u*x-f*S)*t,e[4]=(-a*P+l*C-h*E)*t,e[5]=(s*P-n*C+r*E)*t,e[6]=(-p*w+_*y-g*b)*t,e[7]=(c*w-u*y+f*b)*t,e[8]=(a*D-o*C+h*T)*t,e[9]=(-s*D+i*C-r*T)*t,e[10]=(p*x-m*y+g*v)*t,e[11]=(-c*x+d*y-f*v)*t,e[12]=(-a*A+o*E-l*T)*t,e[13]=(s*A-i*E+n*T)*t,e[14]=(-p*S+m*b-_*v)*t,e[15]=(c*S-d*b+u*v)*t}return this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}setTRS(t,e,s){const i=e.x,n=e.y,r=e.z,a=e.w,o=s.x,l=s.y,h=s.z,c=i+i,d=n+n,u=r+r,f=i*c,p=i*d,m=i*u,_=n*d,g=n*u,v=r*u,b=a*c,y=a*d,S=a*u,x=this.data;return x[0]=(1-(_+v))*o,x[1]=(p+S)*o,x[2]=(m-y)*o,x[3]=0,x[4]=(p-S)*l,x[5]=(1-(f+v))*l,x[6]=(g+b)*l,x[7]=0,x[8]=(m+y)*h,x[9]=(g-b)*h,x[10]=(1-(f+_))*h,x[11]=0,x[12]=t.x,x[13]=t.y,x[14]=t.z,x[15]=1,this}transpose(t=this){const e=t.data,s=this.data;if(e===s){let t;t=e[1],s[1]=e[4],s[4]=t,t=e[2],s[2]=e[8],s[8]=t,t=e[3],s[3]=e[12],s[12]=t,t=e[6],s[6]=e[9],s[9]=t,t=e[7],s[7]=e[13],s[13]=t,t=e[11],s[11]=e[14],s[14]=t}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return this}getTranslation(t=new rs){return t.set(this.data[12],this.data[13],this.data[14])}getX(t=new rs){return t.set(this.data[0],this.data[1],this.data[2])}getY(t=new rs){return t.set(this.data[4],this.data[5],this.data[6])}getZ(t=new rs){return t.set(this.data[8],this.data[9],this.data[10])}getScale(t=new rs){return this.getX(cs),this.getY(ds),this.getZ(us),t.set(cs.length(),ds.length(),us.length()),t}get scaleSign(){return this.getX(cs),this.getY(ds),this.getZ(us),cs.cross(cs,ds),cs.dot(us)<0?-1:1}setFromEulerAngles(t,e,s){t*=Qe.DEG_TO_RAD,e*=Qe.DEG_TO_RAD,s*=Qe.DEG_TO_RAD;const i=Math.sin(-t),n=Math.cos(-t),r=Math.sin(-e),a=Math.cos(-e),o=Math.sin(-s),l=Math.cos(-s),h=this.data;return h[0]=a*l,h[1]=-a*o,h[2]=r,h[3]=0,h[4]=n*o+l*i*r,h[5]=n*l-i*r*o,h[6]=-a*i,h[7]=0,h[8]=i*o-n*l*r,h[9]=l*i+n*r*o,h[10]=n*a,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(t=new rs){this.getScale(fs);const e=fs.x,s=fs.y,i=fs.z;if(0===e||0===s||0===i)return t.set(0,0,0);const n=this.data,r=Math.asin(-n[2]/e),a=.5*Math.PI;let o,l;return r<a?r>-a?(o=Math.atan2(n[6]/s,n[10]/i),l=Math.atan2(n[1]/e,n[0]/e)):(l=0,o=-Math.atan2(n[4]/s,n[5]/s)):(l=0,o=Math.atan2(n[4]/s,n[5]/s)),t.set(o,r,l).mulScalar(Qe.RAD_TO_DEG)}toString(){return`[${this.data.join(", ")}]`}static{this.IDENTITY=Object.freeze(new ps)}static{this.ZERO=Object.freeze((new ps).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]))}}class ms{constructor(t=0,e=0,s=0,i=1){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}conjugate(t=this){return this.x=-1*t.x,this.y=-1*t.y,this.z=-1*t.z,this.w=t.w,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}equalsApprox(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e&&Math.abs(this.z-t.z)<e&&Math.abs(this.w-t.w)<e}getAxisAngle(t){let e=2*Math.acos(this.w);const s=Math.sin(e/2);return 0!==s?(t.x=this.x/s,t.y=this.y/s,t.z=this.z/s,(t.x<0||t.y<0||t.z<0)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*Qe.RAD_TO_DEG}getEulerAngles(t=new rs){let e,s,i;const n=this.x,r=this.y,a=this.z,o=this.w,l=2*(o*r-n*a);return l<=-.99999?(e=2*Math.atan2(n,o),s=-Math.PI/2,i=0):l>=.99999?(e=2*Math.atan2(n,o),s=Math.PI/2,i=0):(e=Math.atan2(2*(o*n+r*a),1-2*(n*n+r*r)),s=Math.asin(l),i=Math.atan2(2*(o*a+n*r),1-2*(r*r+a*a))),t.set(e,s,i).mulScalar(Qe.RAD_TO_DEG)}invert(t=this){return this.conjugate(t).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e,s){const i=(1-s)*(t.dot(e)<0?-1:1);return this.x=t.x*i+e.x*s,this.y=t.y*i+e.y*s,this.z=t.z*i+e.z*s,this.w=t.w*i+e.w*s,this.normalize()}mul(t){const e=this.x,s=this.y,i=this.z,n=this.w,r=t.x,a=t.y,o=t.z,l=t.w;return this.x=n*r+e*l+s*o-i*a,this.y=n*a+s*l+i*r-e*o,this.z=n*o+i*l+e*a-s*r,this.w=n*l-e*r-s*a-i*o,this}mulScalar(t,e=this){return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t,this}mul2(t,e){const s=t.x,i=t.y,n=t.z,r=t.w,a=e.x,o=e.y,l=e.z,h=e.w;return this.x=r*a+s*h+i*l-n*o,this.y=r*o+i*h+n*a-s*l,this.z=r*l+n*h+s*o-i*a,this.w=r*h-s*a-i*o-n*l,this}normalize(t=this){let e=t.length();return 0===e?(this.x=this.y=this.z=0,this.w=1):(e=1/e,this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}setFromAxisAngle(t,e){e*=.5*Qe.DEG_TO_RAD;const s=Math.sin(e),i=Math.cos(e);return this.x=s*t.x,this.y=s*t.y,this.z=s*t.z,this.w=i,this}setFromEulerAngles(t,e,s){if(t instanceof rs){const i=t;t=i.x,e=i.y,s=i.z}const i=.5*Qe.DEG_TO_RAD;t*=i,e*=i,s*=i;const n=Math.sin(t),r=Math.cos(t),a=Math.sin(e),o=Math.cos(e),l=Math.sin(s),h=Math.cos(s);return this.x=n*o*h-r*a*l,this.y=r*a*h+n*o*l,this.z=r*o*l-n*a*h,this.w=r*o*h+n*a*l,this}setFromMat4(t){const e=t.data;let s,i=e[0],n=e[1],r=e[2],a=e[4],o=e[5],l=e[6],h=e[8],c=e[9],d=e[10];return s=i*i+n*n+r*r,0===s?this.set(0,0,0,1):(s=1/Math.sqrt(s),i*=s,n*=s,r*=s,s=a*a+o*o+l*l,0===s?this.set(0,0,0,1):(s=1/Math.sqrt(s),a*=s,o*=s,l*=s,s=h*h+c*c+d*d,0===s?this.set(0,0,0,1):(s=1/Math.sqrt(s),h*=s,c*=s,d*=s,d<0?i>o?this.set(1+i-o-d,n+a,h+r,l-c):this.set(n+a,1-i+o-d,l+c,h-r):i<-o?this.set(h+r,l+c,1-i-o+d,n-a):this.set(l-c,h-r,n-a,1+i+o+d),this.mulScalar(1/this.length()))))}setFromDirections(t,e){const s=1+t.dot(e);return s<Number.EPSILON?Math.abs(t.x)>Math.abs(t.y)?(this.x=-t.z,this.y=0,this.z=t.x,this.w=0):(this.x=0,this.y=-t.z,this.z=t.y,this.w=0):(this.x=t.y*e.z-t.z*e.y,this.y=t.z*e.x-t.x*e.z,this.z=t.x*e.y-t.y*e.x,this.w=s),this.normalize()}slerp(t,e,s){const i=t.x,n=t.y,r=t.z,a=t.w;let o=e.x,l=e.y,h=e.z,c=e.w,d=a*c+i*o+n*l+r*h;if(d<0&&(c=-c,o=-o,l=-l,h=-h,d=-d),Math.abs(d)>=1)return this.w=a,this.x=i,this.y=n,this.z=r,this;const u=Math.acos(d),f=Math.sqrt(1-d*d);if(Math.abs(f)<.001)return this.w=.5*a+.5*c,this.x=.5*i+.5*o,this.y=.5*n+.5*l,this.z=.5*r+.5*h,this;const p=Math.sin((1-s)*u)/f,m=Math.sin(s*u)/f;return this.w=a*p+c*m,this.x=i*p+o*m,this.y=n*p+l*m,this.z=r*p+h*m,this}transformVector(t,e=new rs){const s=t.x,i=t.y,n=t.z,r=this.x,a=this.y,o=this.z,l=this.w,h=l*s+a*n-o*i,c=l*i+o*s-r*n,d=l*n+r*i-a*s,u=-r*s-a*i-o*n;return e.x=h*l+u*-r+c*-o-d*-a,e.y=c*l+u*-a+d*-r-h*-o,e.z=d*l+u*-o+h*-a-c*-r,e}fromArray(t,e=0){return this.x=t[e]??this.x,this.y=t[e+1]??this.y,this.z=t[e+2]??this.z,this.w=t[e+3]??this.w,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}static{this.IDENTITY=Object.freeze(new ms(0,0,0,1))}static{this.ZERO=Object.freeze(new ms(0,0,0,0))}}const _s=new rs,gs=new rs,vs=new rs,bs=new rs,ys=new rs;class Ss{constructor(t,e){this.center=new rs,this.halfExtents=new rs(.5,.5,.5),this._min=new rs,this._max=new rs,t&&this.center.copy(t),e&&this.halfExtents.copy(e)}add(t){const e=this.center,s=e.x,i=e.y,n=e.z,r=this.halfExtents,a=r.x,o=r.y,l=r.z;let h=s-a,c=s+a,d=i-o,u=i+o,f=n-l,p=n+l;const m=t.center,_=m.x,g=m.y,v=m.z,b=t.halfExtents,y=b.x,S=b.y,x=b.z,w=_-y,T=_+y,E=g-S,C=g+S,A=v-x,D=v+x;w<h&&(h=w),T>c&&(c=T),E<d&&(d=E),C>u&&(u=C),A<f&&(f=A),D>p&&(p=D),e.x=.5*(h+c),e.y=.5*(d+u),e.z=.5*(f+p),r.x=.5*(c-h),r.y=.5*(u-d),r.z=.5*(p-f)}copy(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents)}clone(){return new Ss(this.center,this.halfExtents)}intersects(t){const e=this.getMax(),s=this.getMin(),i=t.getMax(),n=t.getMin();return s.x<=i.x&&e.x>=n.x&&s.y<=i.y&&e.y>=n.y&&s.z<=i.z&&e.z>=n.z}_intersectsRay(t,e){const s=_s.copy(this.getMin()).sub(t.origin),i=gs.copy(this.getMax()).sub(t.origin),n=t.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const r=vs.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),a=bs.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(a.x,a.y),a.z),l=Math.max(Math.max(r.x,r.y),r.z),h=o>=l&&l>=0;return h&&e.copy(t.direction).mulScalar(l).add(t.origin),h}_fastIntersectsRay(t){const e=_s,s=gs,i=vs,n=bs,r=ys,a=t.direction;return e.sub2(t.origin,this.center),n.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)),i.mul2(e,a),!(n.x>this.halfExtents.x&&i.x>=0)&&(!(n.y>this.halfExtents.y&&i.y>=0)&&(!(n.z>this.halfExtents.z&&i.z>=0)&&(r.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),s.cross(a,e),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*r.z+this.halfExtents.z*r.y)&&(!(s.y>this.halfExtents.x*r.z+this.halfExtents.z*r.x)&&!(s.z>this.halfExtents.x*r.y+this.halfExtents.y*r.x)))))}intersectsRay(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)}setMinMax(t,e){this.center.add2(e,t).mulScalar(.5),this.halfExtents.sub2(e,t).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(t){const e=this.getMin(),s=this.getMax();return!(t.x<e.x||t.x>s.x||t.y<e.y||t.y>s.y||t.z<e.z||t.z>s.z)}setFromTransformedAabb(t,e,s=!1){const i=t.center,n=t.halfExtents,r=e.data;let a=r[0],o=r[4],l=r[8],h=r[1],c=r[5],d=r[9],u=r[2],f=r[6],p=r[10];if(s){let t=a*a+o*o+l*l;if(t>0){const e=1/Math.sqrt(t);a*=e,o*=e,l*=e}if(t=h*h+c*c+d*d,t>0){const e=1/Math.sqrt(t);h*=e,c*=e,d*=e}if(t=u*u+f*f+p*p,t>0){const e=1/Math.sqrt(t);u*=e,f*=e,p*=e}}this.center.set(r[12]+a*i.x+o*i.y+l*i.z,r[13]+h*i.x+c*i.y+d*i.z,r[14]+u*i.x+f*i.y+p*i.z),this.halfExtents.set(Math.abs(a)*n.x+Math.abs(o)*n.y+Math.abs(l)*n.z,Math.abs(h)*n.x+Math.abs(c)*n.y+Math.abs(d)*n.z,Math.abs(u)*n.x+Math.abs(f)*n.y+Math.abs(p)*n.z)}static computeMinMax(t,e,s,i=t.length/3){if(i>0){let n=t[0],r=t[1],a=t[2],o=n,l=r,h=a;const c=3*i;for(let e=3;e<c;e+=3){const s=t[e],i=t[e+1],c=t[e+2];s<n&&(n=s),i<r&&(r=i),c<a&&(a=c),s>o&&(o=s),i>l&&(l=i),c>h&&(h=c)}e.set(n,r,a),s.set(o,l,h)}}compute(t,e){Ss.computeMinMax(t,_s,gs,e),this.setMinMax(_s,gs)}intersectsBoundingSphere(t){return this._distanceToBoundingSphereSq(t)<=t.radius*t.radius}_distanceToBoundingSphereSq(t){const e=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let r=0;r<3;++r){let a=0;const o=t.center[n[r]],l=e[n[r]],h=s[n[r]];let c=0;o<l&&(c=l-o,a+=c*c),o>h&&(c=o-h,a+=c*c),i+=a}return i}_expand(t,e){_s.add2(this.getMin(),t),gs.add2(this.getMax(),e),this.setMinMax(_s,gs)}}const xs=new rs,ws=new rs;class Ts{constructor(t=new rs,e=.5){this.center=t,this.radius=e}containsPoint(t){const e=xs.sub2(t,this.center).lengthSq(),s=this.radius;return e<s*s}intersectsRay(t,e){const s=xs.copy(t.origin).sub(this.center),i=s.dot(ws.copy(t.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const r=i*i-n;if(r<0)return!1;const a=Math.abs(-i-Math.sqrt(r));return e&&e.copy(t.direction).mulScalar(a).add(t.origin),!0}intersectsBoundingSphere(t){xs.sub2(t.center,this.center);const e=t.radius+this.radius;return xs.lengthSq()<=e*e}}class Es{constructor(t=rs.UP,e=0){this.normal=new rs,this.normal.copy(t),this.distance=e}clone(){return(new(0,this.constructor)).copy(this)}copy(t){return this.normal.copy(t.normal),this.distance=t.distance,this}intersectsLine(t,e,s){const i=this.distance,n=this.normal.dot(t)+i,r=n/(n-(this.normal.dot(e)+i)),a=r>=0&&r<=1;return a&&s&&s.lerp(t,e,r),a}intersectsRay(t,e){const s=this.normal.dot(t.direction);if(0===s)return!1;const i=-(this.normal.dot(t.origin)+this.distance)/s;return i>=0&&e&&e.copy(t.direction).mulScalar(i).add(t.origin),i>=0}normalize(){const t=1/this.normal.length();return this.normal.mulScalar(t),this.distance*=t,this}set(t,e,s,i){return this.normal.set(t,e,s),this.distance=i,this}setFromPointNormal(t,e){return this.normal.copy(e),this.distance=-this.normal.dot(t),this}}class Cs{constructor(){this.planes=[];for(let t=0;t<6;t++)this.planes[t]=new Es}clone(){return(new(0,this.constructor)).copy(this)}copy(t){for(let e=0;e<6;e++)this.planes[e].copy(t.planes[e]);return this}setFromMat4(t){const[e,s,i,n,r,a,o,l,h,c,d,u,f,p,m,_]=t.data,g=this.planes;g[0].set(n-e,l-r,u-h,_-f).normalize(),g[1].set(n+e,l+r,u+h,_+f).normalize(),g[2].set(n+s,l+a,u+c,_+p).normalize(),g[3].set(n-s,l-a,u-c,_-p).normalize(),g[4].set(n-i,l-o,u-d,_-m).normalize(),g[5].set(n+i,l+o,u+d,_+m).normalize()}containsPoint(t){for(let e=0;e<6;e++){const{normal:s,distance:i}=this.planes[e];if(s.dot(t)+i<=0)return!1}return!0}containsSphere(t){const{center:e,radius:s}=t;let i=0;for(let t=0;t<6;t++){const{normal:n,distance:r}=this.planes[t],a=n.dot(e)+r;if(a<=-s)return 0;a>s&&i++}return 6===i?2:1}}class As{constructor(t,e){this.origin=new rs,this.direction=rs.FORWARD.clone(),t&&this.origin.copy(t),e&&this.direction.copy(e)}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.set(t.origin,t.direction)}clone(){return new this.constructor(this.origin,this.direction)}}const Ds=10,Ps=12,Ls=14,Is=15,Rs=16,Ms=17,ks=18,Os=20,Fs=24,Ns=25,Bs=37,Us=49,zs=69,Vs=new Map([[0,{name:"A8",size:1,ldr:!0}],[52,{name:"R8",size:1,ldr:!0}],[1,{name:"L8",size:1,ldr:!0}],[2,{name:"LA8",size:2,ldr:!0}],[53,{name:"RG8",size:2,ldr:!0}],[3,{name:"RGB565",size:2,ldr:!0}],[4,{name:"RGBA5551",size:2,ldr:!0}],[5,{name:"RGBA4",size:2,ldr:!0}],[6,{name:"RGB8",size:4,ldr:!0}],[7,{name:"RGBA8",size:4,ldr:!0,srgbFormat:Os}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[Ps,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[Ls,{name:"RGBA32F",size:16}],[Is,{name:"R32F",size:4}],[Rs,{name:"DEPTH",size:4}],[zs,{name:"DEPTH16",size:2}],[Ms,{name:"DEPTHSTENCIL",size:4}],[ks,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:!0,srgb:!0}],[Os,{name:"SRGBA8",size:4,ldr:!0,srgb:!0}],[31,{name:"BGRA8",size:4,ldr:!0}],[64,{name:"SBGRA8",size:4,ldr:!0,srgb:!0}],[8,{name:"DXT1",blockSize:8,ldr:!0,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:!0,srgbFormat:55}],[Ds,{name:"DXT5",blockSize:16,ldr:!0,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:!0}],[22,{name:"ETC2_RGB",blockSize:8,ldr:!0,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:!0,srgbFormat:62}],[Fs,{name:"PVRTC_2BPP_RGB_1",ldr:!0,blockSize:8}],[Ns,{name:"PVRTC_2BPP_RGBA_1",ldr:!0,blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:!0,blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:!0,blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16,ldr:!0,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:!0}],[30,{name:"ATC_RGBA",blockSize:16,ldr:!0}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:!0,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:!0,srgb:!0}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:!0,srgb:!0}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:!0,srgb:!0}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[32,{name:"R8I",size:1,isInt:!0}],[33,{name:"R8U",size:1,isInt:!0}],[34,{name:"R16I",size:2,isInt:!0}],[35,{name:"R16U",size:2,isInt:!0}],[36,{name:"R32I",size:4,isInt:!0}],[Bs,{name:"R32U",size:4,isInt:!0}],[38,{name:"RG8I",size:2,isInt:!0}],[39,{name:"RG8U",size:2,isInt:!0}],[40,{name:"RG16I",size:4,isInt:!0}],[41,{name:"RG16U",size:4,isInt:!0}],[42,{name:"RG32I",size:8,isInt:!0}],[43,{name:"RG32U",size:8,isInt:!0}],[44,{name:"RGBA8I",size:4,isInt:!0}],[45,{name:"RGBA8U",size:4,isInt:!0}],[46,{name:"RGBA16I",size:8,isInt:!0}],[47,{name:"RGBA16U",size:8,isInt:!0}],[48,{name:"RGBA32I",size:16,isInt:!0}],[Us,{name:"RGBA32U",size:16,isInt:!0}]]),Hs=t=>void 0!==Vs.get(t)?.blockSize,Gs=t=>!0===Vs.get(t)?.srgb,Ws=t=>!0===Vs.get(t)?.isInt,js=t=>Vs.get(t)?.srgbFormat||t,Xs=t=>{switch(t){case Is:case 13:case Ls:return Float32Array;case 36:case 42:case 48:return Int32Array;case Bs:case 43:case Us:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 53:case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case Ps:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}},$s="POSITION",qs="NORMAL",Ks="TANGENT",Ys="BLENDWEIGHT",Qs="BLENDINDICES",Zs="COLOR",Js="TEXCOORD",ti="TEXCOORD0",ei="TEXCOORD1",si="TEXCOORD2",ii="TEXCOORD3",ni="TEXCOORD4",ri="TEXCOORD5",ai="TEXCOORD6",oi="TEXCOORD7",li="ATTR8",hi="ATTR9",ci="ATTR11",di="ATTR12",ui="ATTR13",fi="ATTR14",pi="ATTR15",mi="default",_i="rgbm",gi="rgbe",vi="rgbp",bi="swizzleGGGR",yi="2d",Si="2d-array",xi="cube",wi="cube-array",Ti="3d",Ei="cube",Ci="equirect",Ai="glsl",Di="wgsl",Pi=13,Li=14,Ii=26,Ri=27,Mi=28,ki=29,Oi=30,Fi=33,Ni=36,Bi=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],Ui=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],zi=new Map;Ui.forEach(((t,e)=>{t.forEach((t=>zi.set(t,e)))}));const Vi="webgl2",Hi="webgpu",Gi="null",Wi="ldr_srgb",ji=["view","mesh","mesh_ub"],Xi="default",$i="_unused_float_uniform",qi=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],Ki=[1,1,2,2,4,4,4,2],Yi=[Uint8Array,Uint16Array,Uint32Array],Qi=[1,2,4],Zi=new Map([["float","f32"],["vec2","vec2f"],["vec3","vec3f"],["vec4","vec4f"],["int","i32"],["ivec2","vec2i"],["ivec3","vec3i"],["ivec4","vec4i"],["uint","u32"],["uvec2","vec2u"],["uvec3","vec3u"],["uvec4","vec4u"]]),Ji={};Ji[$s]=0,Ji[qs]=1,Ji[Ys]=2,Ji[Qs]=3,Ji[Zs]=4,Ji[ti]=5,Ji[ei]=6,Ji[si]=7,Ji[ii]=8,Ji[ni]=9,Ji[ri]=10,Ji[ai]=11,Ji[oi]=12,Ji[Ks]=13,Ji.ATTR0=0,Ji.ATTR1=1,Ji.ATTR2=2,Ji.ATTR3=3,Ji.ATTR4=4,Ji.ATTR5=5,Ji.ATTR6=6,Ji.ATTR7=7,Ji[li]=8,Ji[hi]=9,Ji.ATTR10=10,Ji[ci]=11,Ji[di]=12,Ji[ui]=13,Ji[fi]=14,Ji[pi]=15;let tn=0;class en{constructor(t,e){this.slot=-1,this.scopeId=null,this.name=t,this.visibility=e}}class sn extends en{}class nn extends en{constructor(t,e,s=!1){super(t,e),this.format="",this.readOnly=s}}class rn extends en{constructor(t,e,s=yi,i=0,n=!0,r=null){super(t,e),this.textureDimension=s,this.sampleType=i,this.hasSampler=n,this.samplerName=r??`${t}_sampler`}}class an extends en{constructor(t,e=7,s=yi,i=!0,n=!1){super(t,4),this.format=e,this.textureDimension=s,this.write=i,this.read=n}}class on{constructor(t,e){this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=tn++;let s=0;e.forEach((t=>{t.slot=s++,t instanceof rn&&t.hasSampler&&s++,t instanceof sn?this.uniformBufferFormats.push(t):t instanceof rn?this.textureFormats.push(t):t instanceof an?this.storageTextureFormats.push(t):t instanceof nn&&this.storageBufferFormats.push(t)})),this.device=t;const i=t.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach(((t,e)=>this.bufferFormatsMap.set(t.name,e))),this.textureFormatsMap=new Map,this.textureFormats.forEach(((t,e)=>{this.textureFormatsMap.set(t.name,e),t.scopeId=i.resolve(t.name)})),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach(((t,e)=>{this.storageTextureFormatsMap.set(t.name,e),t.scopeId=i.resolve(t.name)})),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach(((t,e)=>{this.storageBufferFormatsMap.set(t.name,e),t.scopeId=i.resolve(t.name)})),this.impl=t.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(t){const e=this.textureFormatsMap.get(t);return void 0!==e?this.textureFormats[e]:null}getStorageTexture(t){const e=this.storageTextureFormatsMap.get(t);return void 0!==e?this.storageTextureFormats[e]:null}loseContext(){}}class ln{get(t,e){return this._cache.has(t)||(this._cache.set(t,e()),t.on("destroy",(()=>{this.remove(t)})),t.on("devicelost",(()=>{this._cache.get(t)?.loseContext?.(t)}))),this._cache.get(t)}remove(t){this._cache.get(t)?.destroy?.(t),this._cache.delete(t)}constructor(){this._cache=new Map}}class hn{static calcLevelDimension(t,e){return Math.max(t>>e,1)}static calcMipLevelsCount(t,e,s=1){return 1+Math.floor(Math.log2(Math.max(t,e,s)))}static calcLevelGpuSize(t,e,s,i){const n=Vs.get(i),r=Vs.get(i)?.size??0;if(r>0)return t*e*s*r;const a=n.blockSize??0;let o=Math.floor((t+3)/4);const l=Math.floor((e+3)/4),h=Math.floor((s+3)/4);return i!==Fs&&i!==Ns||(o=Math.max(Math.floor(o/2),1)),o*l*h*a}static calcGpuSize(t,e,s,i,n,r){let a=0;for(;a+=hn.calcLevelGpuSize(t,e,s,i),n&&(1!==t||1!==e||1!==s);)t=Math.max(t>>1,1),e=Math.max(e>>1,1),s=Math.max(s>>1,1);return a*(r?6:1)}}let cn=0;class dn{constructor(t,e={}){this._gpuSize=0,this.id=cn++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=!1,this._numLevels=0,this.device=t,this.name=e.name??"",this._width=Math.floor(e.width??4),this._height=Math.floor(e.height??4),this._format=e.format??7,this._compressed=Hs(this._format),this._integerFormat=Ws(this._format),this._integerFormat&&(e.minFilter=0,e.magFilter=0),this._volume=e.volume??!1,this._depth=Math.floor(e.depth??1),this._arrayLength=Math.floor(e.arrayLength??0),this._storage=e.storage??!1,this._cubemap=e.cubemap??!1,this._flipY=e.flipY??!1,this._premultiplyAlpha=e.premultiplyAlpha??!1,this._mipmaps=e.mipmaps??!0,this._numLevelsRequested=e.numLevels,void 0!==e.numLevels&&(this._numLevels=e.numLevels),this._updateNumLevel(),this._minFilter=e.minFilter??5,this._magFilter=e.magFilter??1,this._anisotropy=e.anisotropy??1,this._addressU=e.addressU??0,this._addressV=e.addressV??0,this._addressW=e.addressW??0,this._compareOnRead=e.compareOnRead??!1,this._compareFunc=e.compareFunc??1,this._type=e.type??mi,this.projection="none",this._cubemap?this.projection=Ei:e.projection&&e.projection!==Ei&&(this.projection=e.projection),this._levels=e.levels;const s=!!e.levels;this._levels||this._clearLevels(),this.recreateImpl(s),t.textures.push(this)}destroy(){const t=this.device;if(t){const e=t.textures.indexOf(this);-1!==e&&t.textures.splice(e,1),t.scope.removeValue(this),this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this._gpuSize),this._levels=null,this.device=null}}recreateImpl(t=!0){const{device:e}=this;this.impl?.destroy(e),this.impl=null,this.impl=e.createTextureImpl(this),this.dirtyAll(),t&&this.upload()}_clearLevels(){this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]}resize(t,e,s=1){const i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._clearLevels(),this._width=Math.floor(t),this._height=Math.floor(e),this._depth=Math.floor(s),this._updateNumLevel(),this.impl=i.createTextureImpl(this),this.dirtyAll()}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(t,e){t.tex+=e}propertyChanged(t){this.impl.propertyChanged(t),this.renderVersionDirty=this.device.renderVersion}_updateNumLevel(){const t=this.mipmaps?hn.calcMipLevelsCount(this.width,this.height):1,e=this._numLevelsRequested;this._numLevels=Math.min(e??t,t),this._mipmaps=this._numLevels>1}get lockedMode(){return this._lockedMode}set minFilter(t){this._minFilter!==t&&(Ws(this._format)||(this._minFilter=t,this.propertyChanged(1)))}get minFilter(){return this._minFilter}set magFilter(t){this._magFilter!==t&&(Ws(this._format)||(this._magFilter=t,this.propertyChanged(2)))}get magFilter(){return this._magFilter}set addressU(t){this._addressU!==t&&(this._addressU=t,this.propertyChanged(4))}get addressU(){return this._addressU}set addressV(t){this._addressV!==t&&(this._addressV=t,this.propertyChanged(8))}get addressV(){return this._addressV}set addressW(t){this._volume&&t!==this._addressW&&(this._addressW=t,this.propertyChanged(16))}get addressW(){return this._addressW}set compareOnRead(t){this._compareOnRead!==t&&(this._compareOnRead=t,this.propertyChanged(32))}get compareOnRead(){return this._compareOnRead}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this.propertyChanged(64))}get compareFunc(){return this._compareFunc}set anisotropy(t){this._anisotropy!==t&&(this._anisotropy=t,this.propertyChanged(128))}get anisotropy(){return this._anisotropy}set mipmaps(t){this._mipmaps!==t&&(this.device.isWebGPU||Ws(this._format)||(this._mipmaps=t),t&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get numLevels(){return this._numLevels}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const t=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return hn.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set type(t){this._type!==t&&(this._type=t,this.device._shadersDirty=!0)}get type(){return this._type}set srgb(t){if(t!==Gs(this.format))if(t){const t=js(this.format);this._format!==t&&(this._format=t,this.recreateImpl(),this.device._shadersDirty=!0)}else{const t=(t=>{for(const[e,s]of Vs)if(s.srgbFormat===t)return e;return t})(this.format);this._format!==t&&(this._format=t,this.recreateImpl(),this.device._shadersDirty=!0)}}get srgb(){return Gs(this.format)}set flipY(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return Qe.powerOfTwo(this._width)&&Qe.powerOfTwo(this._height)}get encoding(){switch(this.type){case _i:return"rgbm";case gi:return"rgbe";case vi:return"rgbp"}return(t=>{const e=Vs.get(t);return!(!e?.ldr||e?.srgb)})(this.format)?"srgb":"linear"}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)}lock(t={}){t.level??=0,t.face??=0,t.mode??=2,this._lockedMode=t.mode,this._lockedLevel=t.level;const e=this.cubemap?this._levels[t.face]:this._levels;if(null===e[t.level]){const s=Math.max(1,this._width>>t.level),i=Math.max(1,this._height>>t.level),n=Math.max(1,this._depth>>t.level),r=new ArrayBuffer(hn.calcLevelGpuSize(s,i,n,this._format));e[t.level]=new(Xs(this._format))(r)}return e[t.level]}setSource(t,e=0){let s,i,n=!1;if(this._cubemap){if(t[0]){s=t[0].width||0,i=t[0].height||0;for(let e=0;e<6;e++){const r=t[e];if(!r||r.width!==s||r.height!==i||!this.device._isBrowserInterface(r)){n=!0;break}}}else n=!0;if(!n)for(let s=0;s<6;s++)this._levels[e][s]!==t[s]&&(this._levelsUpdated[e][s]=!0)}else this.device._isBrowserInterface(t)||(n=!0),n||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),t instanceof HTMLVideoElement?(s=t.videoWidth,i=t.videoHeight):(s=t.width,i=t.height));if(n)if(this._width=4,this._height=4,this._cubemap)for(let t=0;t<6;t++)this._levels[e][t]=null,this._levelsUpdated[e][t]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else 0===e&&(this._width=s,this._height=i),this._levels[e]=t;this._invalid===n&&n||(this._invalid=n,this.upload())}getSource(t=0){return this._levels[t]}unlock(){2===this._lockedMode&&this.upload(),this._lockedLevel=-1,this._lockedMode=0}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this.impl.uploadImmediate?.(this.device,this)}read(t,e,s,i,n={}){return this.impl.read?.(t,e,s,i,n)}write(t,e,s,i,n){return this.impl.write?.(t,e,s,i,n)}}const un={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]};class fn{destroy(){this.map.forEach((t=>{t.destroy()}))}constructor(){this.map=new Map}}const pn=new ln,mn=(t,e)=>{const s=pn.get(t,(()=>new fn));if(!s.map.has(e)){const i=new dn(t,{name:`built-in-texture-${e}`,width:1,height:1,format:7}),n=i.lock(),r=un[e];n.set(r),i.unlock(),s.map.set(e,i)}return s.map.get(e)};let _n=0;class gn{constructor(){this.offsets=[]}}class vn{constructor(t,e,s){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=_n++,this.device=t,this.format=e,this.dirty=!0,this.impl=t.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(Xi,s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(t,e){const s=this.format.bufferFormatsMap.get(t);this.uniformBuffers[s]!==e&&(this.uniformBuffers[s]=e,this.dirty=!0)}setStorageBuffer(t,e){const s=this.format.storageBufferFormatsMap.get(t);this.storageBuffers[s]!==e&&(this.storageBuffers[s]=e,this.dirty=!0)}setTexture(t,e){const s=this.format.textureFormatsMap.get(t);this.textures[s]!==e?(this.textures[s]=e,this.dirty=!0):this.renderVersionUpdated<e.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(t,e){const s=this.format.storageTextureFormatsMap.get(t);this.storageTextures[s]!==e?(this.storageTextures[s]=e,this.dirty=!0):this.renderVersionUpdated<e.renderVersionDirty&&(this.dirty=!0)}updateUniformBuffers(){for(let t=0;t<this.uniformBuffers.length;t++)this.uniformBuffers[t].update()}update(){const{textureFormats:t,storageTextureFormats:e,storageBufferFormats:s}=this.format;for(let e=0;e<t.length;e++){const s=t[e];let i=s.scopeId.value;i||("uSceneDepthMap"===s.name&&(i=mn(this.device,"white")),"uSceneColorMap"===s.name&&(i=mn(this.device,"pink")),i||(i=mn(this.device,"pink"))),this.setTexture(s.name,i)}for(let t=0;t<e.length;t++){const s=e[t],i=s.scopeId.value;this.setStorageTexture(s.name,i)}for(let t=0;t<s.length;t++){const e=s[t],i=e.scopeId.value;this.setStorageBuffer(e.name,i)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let t=0;t<this.uniformBuffers.length;t++){const e=this.uniformBuffers[t];this.uniformBufferOffsets[t]=e.offset,this.renderVersionUpdated<e.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}}const bn={set:(t,e,s,i=1)=>t&~(i<<s)|e<<s,get:(t,e,s=1)=>t>>e&s,all(t,e,s=1){const i=s<<e;return(t&i)===i},any:(t,e,s=1)=>0!==(t&s<<e)},yn=15;class Sn{constructor(t=!1,e=0,s=1,i=0,n,r,a,o=!0,l=!0,h=!0,c=!0){this.target0=0,this.setColorBlend(e,s,i),this.setAlphaBlend(n??e,r??s,a??i),this.setColorWrite(o,l,h,c),this.blend=t}set blend(t){this.target0=bn.set(this.target0,t?1:0,26)}get blend(){return bn.all(this.target0,26)}setColorBlend(t,e,s){this.target0=bn.set(this.target0,t,0,7),this.target0=bn.set(this.target0,e,3,yn),this.target0=bn.set(this.target0,s,7,yn)}setAlphaBlend(t,e,s){this.target0=bn.set(this.target0,t,11,7),this.target0=bn.set(this.target0,e,14,yn),this.target0=bn.set(this.target0,s,18,yn)}setColorWrite(t,e,s,i){this.redWrite=t,this.greenWrite=e,this.blueWrite=s,this.alphaWrite=i}get colorOp(){return bn.get(this.target0,0,7)}get colorSrcFactor(){return bn.get(this.target0,3,yn)}get colorDstFactor(){return bn.get(this.target0,7,yn)}get alphaOp(){return bn.get(this.target0,11,7)}get alphaSrcFactor(){return bn.get(this.target0,14,yn)}get alphaDstFactor(){return bn.get(this.target0,18,yn)}set redWrite(t){this.target0=bn.set(this.target0,t?1:0,22)}get redWrite(){return bn.all(this.target0,22)}set greenWrite(t){this.target0=bn.set(this.target0,t?1:0,23)}get greenWrite(){return bn.all(this.target0,23)}set blueWrite(t){this.target0=bn.set(this.target0,t?1:0,24)}get blueWrite(){return bn.all(this.target0,24)}set alphaWrite(t){this.target0=bn.set(this.target0,t?1:0,25)}get alphaWrite(){return bn.all(this.target0,25)}get allWrite(){return bn.get(this.target0,22,15)}copy(t){return this.target0=t.target0,this}clone(){return(new this.constructor).copy(this)}get key(){return this.target0}equals(t){return this.target0===t.target0}static{this.NOBLEND=Object.freeze(new Sn)}static{this.NOWRITE=Object.freeze(new Sn(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1))}static{this.ALPHABLEND=Object.freeze(new Sn(!0,0,6,8))}static{this.ADDBLEND=Object.freeze(new Sn(!0,0,1,1))}}class xn{get(t){let e=this.map.get(t);return void 0===e&&(e=this.id++,this.map.set(t,e)),e}constructor(){this.map=new Map,this.id=0}}const wn=new xn;class Tn{constructor(t=3,e=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=t,this.write=e}set test(t){this.func=t?3:7,this.updateKey()}get test(){return 7!==this.func}set write(t){this.data=bn.set(this.data,t?1:0,3),this.updateKey()}get write(){return bn.all(this.data,3)}set func(t){this.data=bn.set(this.data,t,0,7),this.updateKey()}get func(){return bn.get(this.data,0,7)}set depthBias(t){this._depthBias=t,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(t){this._depthBiasSlope=t,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(t){return this.data=t.data,this._depthBias=t._depthBias,this._depthBiasSlope=t._depthBiasSlope,this.key=t.key,this}clone(){return(new this.constructor).copy(this)}updateKey(){const{data:t,_depthBias:e,_depthBiasSlope:s}=this,i=`${t}-${e}-${s}`;this.key=wn.get(i)}equals(t){return this.key===t.key}static{this.DEFAULT=Object.freeze(new Tn)}static{this.NODEPTH=Object.freeze(new Tn(7,!1))}static{this.WRITEDEPTH=Object.freeze(new Tn(7,!0))}}class En{equals(t){return this.globalId===t.globalId&&this.revision===t.revision}copy(t){this.globalId=t.globalId,this.revision=t.revision}reset(){this.globalId=0,this.revision=0}constructor(){this.globalId=0,this.revision=0}}let Cn=0;class An{constructor(){Cn++,this.version=new En,this.version.globalId=Cn}increment(){this.version.revision++}}class Dn{constructor(t){this.name=t,this.value=null,this.versionObject=new An}toJSON(t){}setValue(t){this.value=t,this.versionObject.increment()}getValue(){return this.value}}class Pn{constructor(t){this.name=t,this.variables=new Map}resolve(t){return this.variables.has(t)||this.variables.set(t,new Dn(t)),this.variables.get(t)}removeValue(t){for(const e in this.variables){const s=this.variables[e];s.value===t&&(s.value=null)}}}let Ln=0;class In{constructor(t,e,s,i){this.usage=0,this.usage=i?.usage??0,this.device=t,this.format=e,this.numVertices=s,this.id=Ln++,this.impl=t.createVertexBufferImpl(this,e,i),this.numBytes=e.verticesByteSize?e.verticesByteSize:e.size*s,this.adjustVramSizeTracking(t._vram,this.numBytes);const n=i?.data;n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.impl.initialized&&(this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this.storage.byteLength))}adjustVramSizeTracking(t,e){t.vb+=e}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}}function Rn(t){if(null==t)return 0;let e=0;for(let s=0,i=t.length;s<i;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0;return e}function Mn(t){let e=2166136261;for(let s=0;s<t.length;s++)e^=t[s],e*=16777619;return e>>>0}const kn=new xn,On=[2,4,8,12,16],Fn=new ln;class Nn{constructor(t,e,s){this.device=t,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.instancing=!1,this.size=e.reduce(((t,e)=>t+4*Math.ceil(e.components*Ki[e.type]/4)),0);let i,n=0;for(let t=0,r=e.length;t<r;t++){const r=e[t];i=r.components*Ki[r.type],s&&(n=Qe.roundUp(n,i));const a=r.asInt??!1,o=!a&&(r.normalize??!1),l={name:r.semantic,offset:s?n:r.hasOwnProperty("offset")?r.offset:n,stride:s?i:r.hasOwnProperty("stride")?r.stride:this.size,dataType:r.type,numComponents:r.components,normalize:o,size:i,asInt:a};this._elements.push(l),n+=s?i*s:4*Math.ceil(i/4),r.semantic===ti?this.hasUv0=!0:r.semantic===ei?this.hasUv1=!0:r.semantic===Zs?this.hasColor=!0:r.semantic===Ks&&(this.hasTangents=!0)}s&&(this.verticesByteSize=n),this._evaluateHash()}get elements(){return this._elements}static getDefaultInstancingFormat(t){return Fn.get(t,(()=>new Nn(t,[{semantic:ci,components:4,type:6},{semantic:di,components:4,type:6},{semantic:fi,components:4,type:6},{semantic:pi,components:4,type:6}])))}static isElementValid(t,e){const s=e.components*Ki[e.type];return!(t.isWebGPU&&!On.includes(s))}update(){this._evaluateHash()}_evaluateHash(){const t=[],e=[],s=this._elements.length;for(let i=0;i<s;i++){const{name:s,dataType:n,numComponents:r,normalize:a,offset:o,stride:l,size:h,asInt:c}=this._elements[i],d=s+n+r+a+c;t.push(d);const u=d+o+l+h;e.push(u)}t.sort();const i=t.join();this.batchingHash=Rn(i),this.shaderProcessingHashString=i,this.renderingHashString=e.join("_"),this.renderingHash=kn.get(this.renderingHashString)}}const Bn=new xn;class Un{set func(t){this._func=t,this._dirty=!0}get func(){return this._func}set ref(t){this._ref=t,this._dirty=!0}get ref(){return this._ref}set fail(t){this._fail=t,this._dirty=!0}get fail(){return this._fail}set zfail(t){this._zfail=t,this._dirty=!0}get zfail(){return this._zfail}set zpass(t){this._zpass=t,this._dirty=!0}get zpass(){return this._zpass}set readMask(t){this._readMask=t,this._dirty=!0}get readMask(){return this._readMask}set writeMask(t){this._writeMask=t,this._dirty=!0}get writeMask(){return this._writeMask}constructor(t={}){this._dirty=!0,this._func=t.func??7,this._ref=t.ref??0,this._readMask=t.readMask??255,this._writeMask=t.writeMask??255,this._fail=t.fail??0,this._zfail=t.zfail??0,this._zpass=t.zpass??0,this._evalKey()}_evalKey(){const{_func:t,_ref:e,_fail:s,_zfail:i,_zpass:n,_readMask:r,_writeMask:a}=this,o=`${t},${e},${s},${i},${n},${r},${a}`;this._key=Bn.get(o),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(t){return this._func=t._func,this._ref=t._ref,this._readMask=t._readMask,this._writeMask=t._writeMask,this._fail=t._fail,this._zfail=t._zfail,this._zpass=t._zpass,this._dirty=t._dirty,this._key=t._key,this}clone(){return(new this.constructor).copy(this)}static{this.DEFAULT=Object.freeze(new Un)}}class zn extends Ve{static{this.EVENT_RESIZE="resizecanvas"}constructor(t,e){super(),this.backBuffer=null,this.backBufferSize=new os,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL2=!1,this.isHdr=!1,this.maxIndirectDrawCount=1024,this.maxColorAttachments=1,this.maxSamples=1,this.supportsCompute=!1,this.supportsStorageTextureRead=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.insideRenderPass=!1,this.supportsUniformBuffers=!1,this.supportsClipDistances=!1,this.textureRG11B10Renderable=!1,this.textureFloatFilterable=!1,this.blendState=new Sn,this.depthState=new Tn,this.stencilEnabled=!1,this.stencilFront=new Un,this.stencilBack=new Un,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.clientRect={width:0,height:0},this._shadersDirty=!1,this.capsDefines=new Map,this.mapsToClear=new Set,this.canvas=t,"setAttribute"in t&&t.setAttribute("data-engine",`PlayCanvas ${Le}`),this.initOptions={...e},this.initOptions.alpha??=!0,this.initOptions.depth??=!0,this.initOptions.stencil??=!0,this.initOptions.antialias??=!0,this.initOptions.powerPreference??="high-performance",this.initOptions.displayFormat??="ldr",this._maxPixelRatio=Ue.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0,sb:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let t=0;t<=6;t++)this._primsPerFrame[t]=0;this._renderTargetCreationTime=0,this.scope=new Pn("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}postInit(){const t=new Nn(this,[{semantic:$s,components:2,type:6}]),e=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new In(this,t,4,{data:e})}initCapsDefines(){const{capsDefines:t}=this;t.clear(),this.textureFloatFilterable&&t.set("CAPS_TEXTURE_FLOAT_FILTERABLE",""),this.textureFloatRenderable&&t.set("CAPS_TEXTURE_FLOAT_RENDERABLE","")}destroy(){this.fire("destroy"),this.quadVertexBuffer?.destroy(),this.quadVertexBuffer=null,this.dynamicBuffers?.destroy(),this.dynamicBuffers=null,this.gpuProfiler?.destroy(),this.gpuProfiler=null}onDestroyShader(t){this.fire("destroy:shader",t);const e=this.shaders.indexOf(t);-1!==e&&this.shaders.splice(e,1)}postDestroy(){this.scope=null,this.canvas=null}loseContext(){this.contextLost=!0,this.backBufferSize.set(-1,-1);for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext();this.gpuProfiler?.loseContext()}restoreContext(){this.contextLost=!1,this.initializeRenderState(),this.initializeContextCaches();for(const t of this.buffers)t.unlock();this.gpuProfiler?.restoreContext?.()}toJSON(t){}initializeContextCaches(){this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new Sn,this.depthState=new Tn,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new Ze(0,0,0,0)}setStencilState(t,e){}setBlendState(t){}setBlendColor(t,e,s,i){}setDepthState(t){}setCullMode(t){}setRenderTarget(t){this.renderTarget=t}setVertexBuffer(t){t&&this.vertexBuffers.push(t)}clearVertexBuffer(){this.vertexBuffers.length=0}getIndirectDrawSlot(){return 0}get indirectDrawBuffer(){return null}getRenderTarget(){return this.renderTarget}initRenderTarget(t){t.initialized||(t.init(),this.targets.add(t))}draw(t,e,s,i,n=!0,r=!0){}_isBrowserInterface(t){return this._isImageBrowserInterface(t)||this._isImageCanvasInterface(t)||this._isImageVideoInterface(t)}_isImageBrowserInterface(t){return"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement}_isImageCanvasInterface(t){return"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement}_isImageVideoInterface(t){return"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement}resizeCanvas(t,e){const s=Math.min(this._maxPixelRatio,Ue.browser?window.devicePixelRatio:1),i=Math.floor(t*s),n=Math.floor(e*s);i===this.canvas.width&&n===this.canvas.height||this.setResolution(i,n)}setResolution(t,e){this.canvas.width=t,this.canvas.height=e,this.fire(zn.EVENT_RESIZE,t,e)}update(){this.updateClientRect()}updateClientRect(){if(Ue.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else{const t=this.canvas.getBoundingClientRect();this.clientRect.width=t.width,this.clientRect.height=t.height}}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(t){}get fullscreen(){return!1}set maxPixelRatio(t){this._maxPixelRatio=t}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}startRenderPass(t){}endRenderPass(t){}startComputePass(t){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){this.mapsToClear.forEach((t=>t.clear())),this.mapsToClear.clear()}computeDispatch(t,e="Unnamed"){}getRenderableHdrFormat(t=[ks,Ps,Ls],e=!0,s=1){for(let i=0;i<t.length;i++){const n=t[i];switch(n){case ks:if(this.textureRG11B10Renderable)return n;break;case Ps:if(this.textureHalfFloatRenderable)return n;break;case Ls:if(this.isWebGPU&&s>1)continue;if(this.textureFloatRenderable&&(!e||this.textureFloatFilterable))return n}}}validateAttributes(t,e,s){}}let Vn=0;class Hn{constructor(t={}){this.id=Vn++;const e=t.colorBuffer?.device??t.colorBuffers?.[0].device??t.depthBuffer?.device??t.graphicsDevice;this._device=e;const{maxSamples:s}=this._device;if(this._samples=Math.min(t.samples??1,s),e.isWebGPU&&(this._samples=this._samples>1?s:1),this._colorBuffer=t.colorBuffer,t.colorBuffer&&(this._colorBuffers=[t.colorBuffer]),this._depthBuffer=t.depthBuffer,this._face=t.face??0,this._depthBuffer){const t=this._depthBuffer._format;t===Rs||t===zs?(this._depth=!0,this._stencil=!1):t===Ms?(this._depth=!0,this._stencil=!0):t===Is&&this._depthBuffer.device.isWebGPU&&this._samples>1?(this._depth=!0,this._stencil=!1):(this._depth=!1,this._stencil=!1)}else this._depth=t.depth??!0,this._stencil=t.stencil??!1;t.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...t.colorBuffers],this._colorBuffer=t.colorBuffers[0])),this.autoResolve=t.autoResolve??!0,this.name=t.name,this.name||(this.name=this._colorBuffer?.name),this.name||(this.name=this._depthBuffer?.name),this.name||(this.name="Untitled"),this.flipY=t.flipY??!1,this._mipLevel=t.mipLevel??0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=void 0===t.mipLevel,this.validateMrt(),this.impl=e.createRenderTargetImpl(this)}destroy(){const t=this._device;t&&(t.targets.delete(this),t.renderTarget===this&&t.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){const t=this._device;t&&this.impl.destroy(t)}destroyTextureBuffers(){this._depthBuffer?.destroy(),this._depthBuffer=null,this._colorBuffers?.forEach((t=>{t.destroy()})),this._colorBuffers=null,this._colorBuffer=null}resize(t,e){if(this.width!==t||this.height!==e){if(this.mipLevel>0)return;const s=this._device;this.destroyFrameBuffers(),s.renderTarget===this&&s.setRenderTarget(null),this._depthBuffer?.resize(t,e),this._colorBuffers?.forEach((s=>{s.resize(t,e)})),this.validateMrt(),this.impl=s.createRenderTargetImpl(this)}}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(t=!0,e=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,t,e)}copy(t,e,s){if(!this._device){if(!t._device)return!1;this._device=t._device}return this._device.copyRenderTarget(t,this,e,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(t){return this._colorBuffers?.[t]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get mipLevel(){return this._mipLevel}get mipmaps(){return this._mipmaps}get width(){let t=this._colorBuffer?.width||this._depthBuffer?.width||this._device.width;return this._mipLevel>0&&(t=hn.calcLevelDimension(t,this._mipLevel)),t}get height(){let t=this._colorBuffer?.height||this._depthBuffer?.height||this._device.height;return this._mipLevel>0&&(t=hn.calcLevelDimension(t,this._mipLevel)),t}isColorBufferSrgb(t=0){if(this.device.backBuffer===this)return Gs(this.device.backBufferFormat);const e=this.getColorBuffer(t);return!!e&&Gs(e.format)}}class Gn{update(t){this.destroy();const e=t.device,s=this.createDescriptor(e,t);this.bindGroup=e.wgpu.createBindGroup(s)}destroy(){this.bindGroup=null}createDescriptor(t,e){const s=[],i=e.format,n=e.format.uniformBufferFormats;e.uniformBuffers.forEach(((t,e)=>{const i=n[e].slot,r=t.persistent?t.impl.buffer:t.allocation.gpuBuffer.buffer;s.push({binding:i,resource:{buffer:r,offset:0,size:t.format.byteSize}})}));const r=e.format.textureFormats;e.textures.forEach(((e,n)=>{const a=e.impl,o=i.textureFormats[n],l=r[n].slot,h=a.getView(t);if(s.push({binding:l,resource:h}),o.hasSampler){const e=a.getSampler(t,o.sampleType);s.push({binding:l+1,resource:e})}}));const a=e.format.storageTextureFormats;e.storageTextures.forEach(((e,i)=>{const n=e.impl,r=a[i].slot,o=n.getView(t);s.push({binding:r,resource:o})}));const o=e.format.storageBufferFormats;e.storageBuffers.forEach(((t,e)=>{const i=t.impl.buffer,n=o[e].slot;s.push({binding:n,resource:{buffer:i}})}));return{layout:e.format.impl.bindGroupLayout,entries:s}}}class Wn{static shaderStage(t){let e=0;return 1&t&&(e|=GPUShaderStage.VERTEX),2&t&&(e|=GPUShaderStage.FRAGMENT),4&t&&(e|=GPUShaderStage.COMPUTE),e}}const jn=[];jn[0]="",jn[1]="",jn[2]="",jn[52]="r8unorm",jn[53]="rg8unorm",jn[3]="",jn[4]="",jn[5]="",jn[6]="rgba8unorm",jn[7]="rgba8unorm",jn[8]="bc1-rgba-unorm",jn[9]="bc2-rgba-unorm",jn[10]="bc3-rgba-unorm",jn[11]="",jn[12]="rgba16float",jn[50]="r16float",jn[51]="rg16float",jn[13]="",jn[14]="rgba32float",jn[15]="r32float",jn[16]="depth32float",jn[69]="depth16unorm",jn[17]="depth24plus-stencil8",jn[18]="rg11b10ufloat",jn[19]="",jn[20]="rgba8unorm-srgb",jn[21]="",jn[22]="etc2-rgb8unorm",jn[23]="etc2-rgba8unorm",jn[24]="",jn[25]="",jn[26]="",jn[27]="",jn[28]="astc-4x4-unorm",jn[29]="",jn[30]="",jn[31]="bgra8unorm",jn[64]="bgra8unorm-srgb",jn[32]="r8sint",jn[33]="r8uint",jn[34]="r16sint",jn[35]="r16uint",jn[36]="r32sint",jn[37]="r32uint",jn[38]="rg8sint",jn[39]="rg8uint",jn[40]="rg16sint",jn[41]="rg16uint",jn[42]="rg32sint",jn[43]="rg32uint",jn[44]="rgba8sint",jn[45]="rgba8uint",jn[46]="rgba16sint",jn[47]="rgba16uint",jn[48]="rgba32sint",jn[49]="rgba32uint",jn[65]="bc6h-rgb-float",jn[66]="bc6h-rgb-ufloat",jn[67]="bc7-rgba-unorm",jn[54]="bc1-rgba-unorm-srgb",jn[55]="bc2-rgba-unorm-srgb",jn[56]="bc3-rgba-unorm-srgb",jn[61]="etc2-rgb8unorm-srgb",jn[62]="etc2-rgba8unorm-srgb",jn[68]="bc7-rgba-unorm-srgb",jn[63]="astc-4x4-unorm-srgb";const Xn=[];Xn[0]="filtering",Xn[1]="non-filtering",Xn[2]="comparison",Xn[3]="comparison",Xn[4]="comparison";const $n=[];$n[0]="float",$n[1]="unfilterable-float",$n[2]="depth",$n[3]="sint",$n[4]="uint";const qn=new xn;class Kn{constructor(t){const e=t.device,{key:s,desc:i}=this.createDescriptor(t);this.key=qn.get(s),this.bindGroupLayout=e.wgpu.createBindGroupLayout(i)}destroy(){this.bindGroupLayout=null}loseContext(){}createDescriptor(t){const e=[];let s="";t.uniformBufferFormats.forEach((t=>{const i=Wn.shaderStage(t.visibility);s+=`#${t.slot}U:${i}`,e.push({binding:t.slot,visibility:i,buffer:{type:"uniform",hasDynamicOffset:!0}})})),t.textureFormats.forEach((t=>{const i=Wn.shaderStage(t.visibility),n=t.sampleType,r=t.textureDimension,a=!1,o=$n[n];if(s+=`#${t.slot}T:${i}-${o}-${r}-false`,e.push({binding:t.slot,visibility:i,texture:{sampleType:o,viewDimension:r,multisampled:a}}),t.hasSampler){const r=Xn[n];s+=`#${t.slot+1}S:${i}-${r}`,e.push({binding:t.slot+1,visibility:i,sampler:{type:r}})}})),t.storageTextureFormats.forEach((t=>{const{format:i,textureDimension:n}=t,{read:r,write:a}=t;s+=`#${t.slot}ST:${i}-${n}-${r?"r1":"r0"}-${a?"w1":"w0"}`,e.push({binding:t.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:r?a?"read-write":"read-only":"write-only",format:jn[i],viewDimension:n}})})),t.storageBufferFormats.forEach((t=>{const i=t.readOnly,n=Wn.shaderStage(t.visibility);s+=`#${t.slot}SB:${n}-${i?"ro":"rw"}`,e.push({binding:t.slot,visibility:n,buffer:{type:i?"read-only-storage":"storage"}})}));return{key:s,desc:{entries:e}}}}class Yn{constructor(t=0){this.buffer=null,this.usageFlags=0,this.usageFlags=t}destroy(t){this.buffer&&(this.buffer.destroy(),this.buffer=null)}get initialized(){return!!this.buffer}loseContext(){}allocate(t,e){this.buffer=t.wgpu.createBuffer({size:e,usage:this.usageFlags})}unlock(t,e){const s=t.wgpu;if(!this.buffer){const s=e.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(t,s)}const i=e.byteOffset??0,n=new Uint8Array(e.buffer??e,i,e.byteLength),r=new Uint8Array(this.buffer.size);r.set(n),s.queue.writeBuffer(this.buffer,0,r,0,r.length)}read(t,e,s,i,n){return t.readStorageBuffer(this,e,s,i,n)}write(t,e,s,i,n){t.writeStorageBuffer(this,e,s,i,n)}clear(t,e,s){t.clearStorageBuffer(this,e,s)}}class Qn extends Yn{constructor(t,e){super(16|(e?.storage?128:0)),this.format=null,this.format=1===t.format?"uint16":"uint32"}unlock(t){const e=t.device;super.unlock(e,t.storage)}}const Zn={equals(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}},Jn=[];Jn[0]="sint8",Jn[1]="uint8",Jn[2]="sint16",Jn[3]="uint16",Jn[4]="sint32",Jn[5]="uint32",Jn[6]="float32",Jn[7]="float16";const tr=[];tr[0]="snorm8",tr[1]="unorm8",tr[2]="snorm16",tr[3]="unorm16",tr[4]="sint32",tr[5]="uint32",tr[6]="float32",tr[7]="float16";class er{get(t,e=null){const s=this.getKey(t,e);let i=this.cache.get(s);return i||(i=this.create(t,e),this.cache.set(s,i)),i}getKey(t,e=null){return`${t?.renderingHashString}-${e?.renderingHashString}`}create(t,e){const s=[],i=t=>{const e=t.interleaved,i=t.instancing?"instance":"vertex";let n=[];const r=t.elements.length;for(let a=0;a<r;a++){const o=t.elements[a],l=Ji[o.name],h=o.normalize?tr:Jn;n.push({shaderLocation:l,offset:e?o.offset:0,format:`${h[o.dataType]}${o.numComponents>1?`x${o.numComponents}`:""}`}),e&&a!==r-1||(s.push({attributes:n,arrayStride:o.stride,stepMode:i}),n=[])}};return t&&i(t),e&&i(e),s}constructor(){this.cache=new Map}}class sr{constructor(t){this.device=t}getPipelineLayout(t){const e=[];t.forEach((t=>{e.push(t.bindGroupLayout)}));const s={bindGroupLayouts:e};return this.device.wgpu.createPipelineLayout(s)}}const ir=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],nr=["add","subtract","reverse-subtract","min","max"],rr=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],ar=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],or=["none","back","front"],lr=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"],hr=["","uint16","uint32"];class cr{}class dr extends sr{constructor(t){super(t),this.lookupHashes=new Uint32Array(14),this.vertexBufferLayout=new er,this.cache=new Map}get(t,e,s,i,n,r,a,o,l,h,c,d,u){const f=t.type;i&&3!==f&&5!==f&&(i=void 0);const p=this.lookupHashes;p[0]=f,p[1]=n.id,p[2]=h,p[3]=l.key,p[4]=o.key,p[5]=e?.renderingHash??0,p[6]=s?.renderingHash??0,p[7]=r.impl.key,p[8]=a[0]?.key??0,p[9]=a[1]?.key??0,p[10]=a[2]?.key??0,p[11]=c?d.key:0,p[12]=c?u.key:0,p[13]=i??0;const m=Mn(p);let _=this.cache.get(m);if(_)for(let t=0;t<_.length;t++){const e=_[t];if(Zn.equals(e.hashes,p))return e.pipeline}const g=ir[f],v=this.getPipelineLayout(a),b=this.vertexBufferLayout.get(e,s),y=new cr;return y.hashes=new Uint32Array(p),y.pipeline=this.create(g,i,n,r,v,o,l,b,h,c,d,u),_?_.push(y):_=[y],this.cache.set(m,_),y.pipeline}getBlend(t){let e;return t.blend&&(e={color:{operation:nr[t.colorOp],srcFactor:rr[t.colorSrcFactor],dstFactor:rr[t.colorDstFactor]},alpha:{operation:nr[t.alphaOp],srcFactor:rr[t.alphaSrcFactor],dstFactor:rr[t.alphaDstFactor]}}),e}getDepthStencil(t,e,s,i,n,r){let a;const{depth:o,stencil:l}=e;if(o||l){if(a={format:e.impl.depthAttachment.format},o){a.depthWriteEnabled=t.write,a.depthCompare=ar[t.func];const e="triangle-list"===r||"triangle-strip"===r;a.depthBias=e?t.depthBias:0,a.depthBiasSlopeScale=e?t.depthBiasSlope:0}else a.depthWriteEnabled=!1,a.depthCompare="always";l&&s&&(a.stencilReadMas=i.readMask,a.stencilWriteMask=i.writeMask,a.stencilFront={compare:ar[i.func],failOp:lr[i.fail],passOp:lr[i.zpass],depthFailOp:lr[i.zfail]},a.stencilBack={compare:ar[n.func],failOp:lr[n.fail],passOp:lr[n.zpass],depthFailOp:lr[n.zfail]})}return a}create(t,e,s,i,n,r,a,o,l,h,c,d){const u=this.device.wgpu,f=s.impl,p={vertex:{module:f.getVertexShaderModule(),entryPoint:f.vertexEntryPoint,buffers:o},primitive:{topology:t,frontFace:"ccw",cullMode:or[l]},depthStencil:this.getDepthStencil(a,i,h,c,d,t),multisample:{count:i.samples},layout:n};e&&(p.primitive.stripIndexFormat=hr[e]),p.fragment={module:f.getFragmentShaderModule(),entryPoint:f.fragmentEntryPoint,targets:[]};const m=i.impl.colorAttachments;if(m.length>0){let t=0;r.redWrite&&(t|=GPUColorWrite.RED),r.greenWrite&&(t|=GPUColorWrite.GREEN),r.blueWrite&&(t|=GPUColorWrite.BLUE),r.alphaWrite&&(t|=GPUColorWrite.ALPHA);const e=this.getBlend(r);m.forEach((s=>{p.fragment.targets.push({format:s.format,writeMask:t,blend:e})}))}return u.createRenderPipeline(p)}}class ur extends sr{get(t,e){const s=this.getPipelineLayout([e.impl]);return this.create(t,s)}create(t,e){const s=this.device.wgpu,i=t.impl,n={compute:{module:i.getComputeShaderModule(),entryPoint:i.computeEntryPoint},layout:e};return s.createComputePipeline(n)}}class fr{incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}constructor(){this._refCount=0}}class pr extends fr{constructor(t){super(),this.object=t,this.incRefCount()}}class mr{destroy(){this.cache.forEach((t=>{t.object?.destroy()})),this.cache.clear()}clear(){this.cache.clear()}get(t){const e=this.cache.get(t);return e?(e.incRefCount(),e.object):null}set(t,e){this.cache.set(t,new pr(e))}release(t){const e=this.cache.get(t);e&&(e.decRefCount(),0===e.refCount&&(this.cache.delete(t),e.object?.destroy()))}constructor(){this.cache=new Map}}class _r extends mr{loseContext(t){this.clear()}}const gr=new ln,vr=t=>gr.get(t,(()=>new _r)),br=new xn;class yr{destroy(){this.multisampledBuffer?.destroy(),this.multisampledBuffer=null}}class Sr{constructor(t){this.depthTexture=null,this.depthTextureInternal=!1,this.multisampledDepthBuffer=null,this.format=t,this.hasStencil="depth24plus-stencil8"===t}destroy(t){this.depthTextureInternal&&(this.depthTexture?.destroy(),this.depthTexture=null),this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,vr(t).release(this.multisampledDepthBufferKey))}}class xr{constructor(t){this.initialized=!1,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=!1,this.renderTarget=t}destroy(t){this.initialized=!1,this.assignedColorTexture=null,this.colorAttachments.forEach((t=>{t.destroy()})),this.colorAttachments.length=0,this.depthAttachment?.destroy(t),this.depthAttachment=null}updateKey(){let t=`${this.renderTarget.samples}:${this.depthAttachment?this.depthAttachment.format:"nodepth"}`;this.colorAttachments.forEach((e=>{t+=`:${e.format}`})),this.key=br.get(t)}assignColorTexture(t,e){this.assignedColorTexture=e;const s=e.createView({format:t.backBufferViewFormat}),i=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?i.resolveTarget=s:i.view=s,this.setColorAttachment(0,void 0,t.backBufferViewFormat),this.updateKey()}setColorAttachment(t,e,s){this.colorAttachments[t]||(this.colorAttachments[t]=new yr),e&&(this.colorAttachments[t].multisampledBuffer=e),s&&(this.colorAttachments[t].format=s)}init(t,e){const s=t.wgpu;this.initDepthStencil(t,s,e),e._colorBuffers&&e._colorBuffers.forEach(((t,e)=>{this.setColorAttachment(e,void 0,t.impl.format)})),this.renderPassDescriptor.colorAttachments=[];const i=this.isBackbuffer?1:e._colorBuffers?.length??0;for(let n=0;n<i;++n){const i=this.initColor(t,s,e,n),r=0===n&&this.colorAttachments[0]?.format;(i.view||r)&&this.renderPassDescriptor.colorAttachments.push(i)}this.updateKey(),this.initialized=!0}initDepthStencil(t,e,s){const{samples:i,width:n,height:r,depth:a,depthBuffer:o}=s;if(a||o){let s;if(o)if(this.depthAttachment=new Sr(o.impl.format),i>1){const a="depth24plus-stencil8";this.depthAttachment.format=a,this.depthAttachment.hasStencil="depth24plus-stencil8"===a;const l=`${o.id}:${n}:${r}:${i}:${a}`,h=vr(t);let c=h.get(l);if(!c){const t={size:[n,r,1],dimension:"2d",sampleCount:i,format:a,usage:GPUTextureUsage.RENDER_ATTACHMENT|(a!==o.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};c=e.createTexture(t),h.set(l,c)}this.depthAttachment.multisampledDepthBuffer=c,this.depthAttachment.multisampledDepthBufferKey=l,s=c.createView()}else{const t=o.impl.gpuTexture;this.depthAttachment.depthTexture=t,s=t.createView()}else{this.depthAttachment=new Sr("depth24plus-stencil8");const t={size:[n,r,1],dimension:"2d",sampleCount:i,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};t.usage|=i>1?GPUTextureUsage.TEXTURE_BINDING:GPUTextureUsage.COPY_SRC;const a=e.createTexture(t);this.depthAttachment.depthTexture=a,this.depthAttachment.depthTextureInternal=!0,s=a.createView()}this.renderPassDescriptor.depthStencilAttachment={view:s}}}initColor(t,e,s,i){const n={},{samples:r,width:a,height:o,mipLevel:l}=s,h=s.getColorBuffer(i);let c=null;if(h){const t=1;c=h.cubemap?h.impl.createView({dimension:"2d",baseArrayLayer:s.face,arrayLayerCount:1,mipLevelCount:t,baseMipLevel:l}):h.impl.createView({mipLevelCount:t,baseMipLevel:l})}if(r>1){const s={size:[a,o,1],dimension:"2d",sampleCount:r,format:this.isBackbuffer?t.backBufferViewFormat:h.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},l=e.createTexture(s);this.setColorAttachment(i,l,s.format),n.view=l.createView(),n.resolveTarget=c}else n.view=c;return n}setupForRenderPass(t,e){const s=this.renderPassDescriptor.colorAttachments?.length??0;for(let i=0;i<s;++i){const s=this.renderPassDescriptor.colorAttachments[i],n=t.colorArrayOps[i],r=e.isColorBufferSrgb(i);s.clearValue=r?n.clearValueLinear:n.clearValue,s.loadOp=n.clear?"clear":"load",s.storeOp=n.store?"store":"discard"}const i=this.renderPassDescriptor.depthStencilAttachment;i&&(i.depthClearValue=t.depthStencilOps.clearDepthValue,i.depthLoadOp=t.depthStencilOps.clearDepth?"clear":"load",i.depthStoreOp=t.depthStencilOps.storeDepth?"store":"discard",i.depthReadOnly=!1,this.depthAttachment.hasStencil&&(i.stencilClearValue=t.depthStencilOps.clearStencilValue,i.stencilLoadOp=t.depthStencilOps.clearStencil?"clear":"load",i.stencilStoreOp=t.depthStencilOps.storeStencil?"store":"discard",i.stencilReadOnly=!1))}loseContext(){this.initialized=!1}resolve(t,e,s,i){}}const wr=[];wr[2]=1,wr[3]=2,wr[4]=3,wr[5]=4,wr[1]=1,wr[6]=2,wr[7]=3,wr[8]=4,wr[0]=1,wr[9]=2,wr[10]=3,wr[11]=4,wr[12]=8,wr[13]=12,wr[14]=16,wr[26]=1,wr[27]=2,wr[28]=3,wr[29]=4;class Tr{get isArrayType(){return this.count>0}constructor(t,e,s=0){if(this.shortName=t,this.name=s?`${t}[0]`:t,this.type=e,this.numComponents=wr[e],this.updateType=e,s>0)switch(e){case 2:this.updateType=17;break;case 1:this.updateType=Oi;break;case Ii:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=Fi;break;case Ri:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=Ni;break;case Mi:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case ki:this.updateType=40;break;case 11:this.updateType=41;break;case Li:this.updateType=24}this.count=s;let i=this.numComponents;s&&(i=Qe.roundUp(i,4)),this.byteSize=4*i,s&&(this.byteSize*=s)}calculateOffset(t){let e=this.byteSize<=8?this.byteSize:16;this.count&&(e=16),t=Qe.roundUp(t,e),this.offset=t/4}}class Er{constructor(t,e){this.byteSize=0,this.map=new Map,this.scope=t.scope,this.uniforms=e;let s=0;for(let t=0;t<e.length;t++){const i=e[t];i.calculateOffset(s),s=4*i.offset+i.byteSize,i.scopeId=this.scope.resolve(i.name),this.map.set(i.name,i)}this.byteSize=Qe.roundUp(s,16)}get(t){return this.map.get(t)}}const Cr=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,Ar=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,Dr="@@@",Pr=/([\w-]+)\[(.*?)\]/,Lr=new Set(["highp","mediump","lowp"]),Ir=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),Rr={sampler2D:yi,sampler3D:Ti,samplerCube:xi,samplerCubeShadow:xi,sampler2DShadow:yi,sampler2DArray:Si,sampler2DArrayShadow:Si,isampler2D:yi,usampler2D:yi,isampler3D:Ti,usampler3D:Ti,isamplerCube:xi,usamplerCube:xi,isampler2DArray:Si,usampler2DArray:Si},Mr={[yi]:"texture2D",[xi]:"textureCube",[Ti]:"texture3D",[Si]:"texture2DArray"};let kr=class{constructor(t,e){this.line=t;const s=t.trim().split(/\s+/);if(Lr.has(s[0])&&(this.precision=s.shift()),this.type=s.shift(),t.includes(","),t.includes("[")){const t=s.join(" "),i=Pr.exec(t);this.name=i[1],this.arraySize=Number(i[2]),isNaN(this.arraySize)&&(e.failed=!0)}else this.name=s.shift(),this.arraySize=0;this.isSampler=-1!==this.type.indexOf("sampler"),this.isSignedInt=-1!==this.type.indexOf("isampler"),this.isUnsignedInt=-1!==this.type.indexOf("usampler")}};class Or{static run(t,e,s){const i=new Map,n=Or.extract(e.vshader),r=Or.extract(e.fshader),a=new Map,o=Or.processAttributes(n.attributes,e.attributes,a,e.processingOptions),l=Or.processVaryings(n.varyings,i,!0),h=Or.processVaryings(r.varyings,i,!1),c=Or.processOuts(r.outs),d=n.uniforms.concat(r.uniforms),u=Array.from(new Set(d)).map((t=>new kr(t,s))),f=Or.processUniforms(t,u,e.processingOptions,s),p=`${o}\n${l}\n${f.code}`,m=n.src.replace(Dr,p),_=`${h}\n${c}\n${f.code}`;return{vshader:m,fshader:r.src.replace(Dr,_),attributes:a,meshUniformBufferFormat:f.meshUniformBufferFormat,meshBindGroupFormat:f.meshBindGroupFormat}}static extract(t){const e=[],s=[],i=[],n=[];let r,a=`${Dr}\n`;for(;null!==(r=Cr.exec(t));){const o=r[1];switch(o){case"attribute":case"varying":case"uniform":case"out":{Ar.lastIndex=r.index;const l=Ar.exec(t);"attribute"===o?e.push(l[2]):"varying"===o?s.push(l[2]):"out"===o?i.push(l[2]):"uniform"===o&&n.push(l[2]),t=Or.cutOut(t,r.index,Ar.lastIndex,a),Cr.lastIndex=r.index+a.length,a="";break}}}return{src:t,attributes:e,varyings:s,outs:i,uniforms:n}}static processUniforms(t,e,s,i){const n=[],r=[];e.forEach((t=>{t.isSampler?n.push(t):r.push(t)}));const a=[];r.forEach((t=>{if(!s.hasUniform(t.name)){const e=Bi.indexOf(t.type),s=new Tr(t.name,e,t.arraySize);a.push(s)}})),0===a.length&&a.push(new Tr($i,2));const o=a.length?new Er(t,a):null,l=[];n.forEach((t=>{if(!s.hasTexture(t.name)){let e=0;t.isSignedInt?e=3:t.isUnsignedInt?e=4:("highp"===t.precision&&(e=1),Ir.has(t.type)&&(e=2));const s=Rr[t.type];l.push(new rn(t.name,3,s,e))}}));const h=new on(t,l);let c="";return s.uniformFormats.forEach(((t,e)=>{t&&(c+=Or.getUniformShaderDeclaration(t,e,0))})),o&&(c+=Or.getUniformShaderDeclaration(o,2,0)),s.bindGroupFormats.forEach(((t,e)=>{t&&(c+=Or.getTexturesShaderDeclaration(t,e))})),c+=Or.getTexturesShaderDeclaration(h,1),{code:c,meshUniformBufferFormat:o,meshBindGroupFormat:h}}static processVaryings(t,e,s){let i="";const n=s?"out":"in";return t.forEach(((t,r)=>{const a=Or.splitToWords(t),o=a.slice(0,-1).join(" "),l=a[a.length-1];s?e.set(l,r):r=e.get(l),i+=`layout(location = ${r}) ${n} ${o} ${l};\n`})),i}static processOuts(t){let e="";return t.forEach(((t,s)=>{e+=`layout(location = ${s}) out ${t};\n`})),e}static getTypeCount(t){const e=t.substring(t.length-1),s=parseInt(e,10);return isNaN(s)?1:s}static processAttributes(t,e,s,i){let n="";return t.forEach((t=>{const r=Or.splitToWords(t);let a=r[0],o=r[1];if(e.hasOwnProperty(o)){const t=e[o],r=Ji[t];let l;s.set(r,o);const h=i.getVertexElement(t);if(h){const t=h.dataType;if(6!==t&&7!==t&&!h.normalize&&!h.asInt){const e=Or.getTypeCount(a),s=`_private_${o}`;l=`vec${e} ${o} = vec${e}(${s});\n`,o=s;const i=0===t||2===t||4===t;a=1===e?i?"int":"uint":i?`ivec${e}`:`uvec${e}`}}n+=`layout(location = ${r}) in ${a} ${o};\n`,l&&(n+=l)}})),n}static splitToWords(t){return(t=t.replace(/\s+/g," ").trim()).split(" ")}static cutOut(t,e,s,i){return t.substring(0,e)+i+t.substring(s)}static getUniformShaderDeclaration(t,e,s){let i=`layout(set = ${e}, binding = ${s}, std140) uniform ub_${ji[e]} {\n`;return t.uniforms.forEach((t=>{const e=Bi[t.type];i+=`    ${e} ${t.shortName}${t.count?`[${t.count}]`:""};\n`})),`${i}};\n`}static getTexturesShaderDeclaration(t,e){let s="";return t.textureFormats.forEach((t=>{let i=Mr[t.textureDimension];const n="texture2DArray"===i,r=4===t.sampleType?"u":3===t.sampleType?"i":"";i=`${r}${i}`;let a="",o="";n&&(a="_texture",o=`#define ${t.name} ${r}sampler2DArray(${t.name}${a}, ${t.name}_sampler)\n`),s+=`layout(set = ${e}, binding = ${t.slot}) uniform ${i} ${t.name}${a};\n`,t.hasSampler&&(s+=`layout(set = ${e}, binding = ${t.slot+1}) uniform sampler ${t.name}_sampler;\n`),s+=o})),s}}const Fr=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,Nr=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,Br=/^[ \t]*var\s*(?:(<storage,[^>]*>)\s*([\w\d_]+)\s*:\s*(.*?)\s*;|(<(?!storage,)[^>]*>)?\s*([\w\d_]+)\s*:\s*(texture_.*|storage_texture_.*|storage\w.*|external_texture|sampler(?:_comparison)?)\s*;)\s*$/gm,Ur=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:/,zr="@@@",Vr=/(@vertex|@fragment)\s*fn\s+\w+\s*\(\s*(\w+)\s*:[\s\S]*?\{/,Hr={texture_1d:{viewDimension:"1d",baseSampleType:0},texture_2d:{viewDimension:yi,baseSampleType:0},texture_2d_array:{viewDimension:Si,baseSampleType:0},texture_3d:{viewDimension:Ti,baseSampleType:0},texture_cube:{viewDimension:xi,baseSampleType:0},texture_cube_array:{viewDimension:wi,baseSampleType:0},texture_multisampled_2d:{viewDimension:yi,baseSampleType:0},texture_depth_2d:{viewDimension:yi,baseSampleType:2},texture_depth_2d_array:{viewDimension:Si,baseSampleType:2},texture_depth_cube:{viewDimension:xi,baseSampleType:2},texture_depth_cube_array:{viewDimension:wi,baseSampleType:2},texture_external:{viewDimension:yi,baseSampleType:1}},Gr={f32:"WrappedF32",i32:"WrappedI32",u32:"WrappedU32",vec2f:"WrappedVec2F",vec2i:"WrappedVec2I",vec2u:"WrappedVec2U"},Wr=t=>(t=t.replace(/\s+/g," ").trim()).split(/[\s:]+/),jr=/array<([^,]+),\s*([^>]+)>/;class Xr{constructor(t,e){this.ubName=null,this.arraySize=0,this.line=t;const s=Wr(t);if(s.length<2)e.failed=!0;else if(this.name=s[0],this.type=s.slice(1).join(" "),this.type.includes("array<")){const t=jr.exec(this.type);this.type=t[1].trim(),this.arraySize=Number(t[2]),isNaN(this.arraySize)&&(e.failed=!0)}}}const $r=/^\s*var\s+(\w+)\s*:\s*(texture_\w+)(?:<(\w+)>)?;\s*$/,qr=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,Kr=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,Yr=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,Qr=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/;class Zr{constructor(t,e){this.originalLine=t,this.line=t,this.isTexture=!1,this.isSampler=!1,this.isStorageTexture=!1,this.isStorageBuffer=!1,this.isExternalTexture=!1,this.type="",this.matchedElements=[];const s=this.line.match($r);if(s){this.name=s[1],this.type=s[2],this.textureFormat=s[3],this.isTexture=!0,this.matchedElements.push(...s);const t=((t,e)=>{const s=Hr[t];let i=s.baseSampleType;if(0===s.baseSampleType&&"texture_multisampled_2d"!==t)switch(e){case"u32":i=4;break;case"i32":i=3;break;case"f32":i=0;break;case"uff":i=1}return{viewDimension:s.viewDimension,sampleType:i}})(this.type,this.textureFormat);this.textureDimension=t.viewDimension,this.sampleType=t.sampleType}const i=this.line.match(qr);i&&(this.isStorageTexture=!0,this.name=i[1],this.textureType=i[2],this.format=i[3],this.access=i[4],this.matchedElements.push(...i));const n=this.line.match(Kr);n&&(this.isStorageBuffer=!0,this.accessMode=n[1]||"none",this.name=n[2],this.type=n[3],this.matchedElements.push(...n));const r=this.line.match(Yr);r&&(this.name=r[1],this.isExternalTexture=!0,this.matchedElements.push(...n));const a=this.line.match(Qr);a&&(this.name=a[1],this.samplerType=a[2],this.isSampler=!0,this.matchedElements.push(...a)),0===this.matchedElements.length&&(e.failed=!0)}equals(t){return this.name===t.name&&(this.type===t.type&&(this.isTexture===t.isTexture&&(this.isSampler===t.isSampler&&(this.isStorageTexture===t.isStorageTexture&&(this.isStorageBuffer===t.isStorageBuffer&&(this.isExternalTexture===t.isExternalTexture&&(this.textureFormat===t.textureFormat&&(this.textureDimension===t.textureDimension&&(this.sampleType===t.sampleType&&(this.textureType===t.textureType&&(this.format===t.format&&(this.access===t.access&&(this.accessMode===t.accessMode&&this.samplerType===t.samplerType)))))))))))))}}class Jr{static run(t,e,s){const i=new Map,n=Jr.extract(e.vshader),r=Jr.extract(e.fshader),a=new Map,o=Jr.processAttributes(n.attributes,e.attributes,a,e.processingOptions,s),l=Jr.processVaryings(n.varyings,i,!0),h=Jr.processVaryings(r.varyings,i,!1),c=n.uniforms.concat(r.uniforms),d=Array.from(new Set(c)).map((t=>new Xr(t,s))),u=Jr.processUniforms(t,d,e.processingOptions,s);n.src=Jr.renameUniformAccess(n.src,d),r.src=Jr.renameUniformAccess(r.src,d);const f=Jr.mergeResources(n.resources,r.resources,s),p=Jr.processResources(t,f,e.processingOptions,s),m=Jr.generateFragmentOutputStruct(r.src,t.maxColorAttachments);n.src=Jr.copyInputs(n.src,s),r.src=Jr.copyInputs(r.src,s);const _=`${o}\n${l}\n${u.code}\n${p.code}\n`,g=n.src.replace(zr,_),v=`${h}\n${m}\n${u.code}\n${p.code}\n`;return{vshader:g,fshader:r.src.replace(zr,v),attributes:a,meshUniformBufferFormat:u.meshUniformBufferFormat,meshBindGroupFormat:p.meshBindGroupFormat}}static extract(t){const e=[],s=[],i=[],n=[];let r,a=`${zr}\n`;for(;null!==(r=Fr.exec(t));){const n=r[1];Nr.lastIndex=r.index;const o=Nr.exec(t);"attribute"===n?e.push(o[2]):"varying"===n?s.push(o[2]):"uniform"===n&&i.push(o[2]),t=Jr.cutOut(t,r.index,Nr.lastIndex,a),Fr.lastIndex=r.index+a.length,a=""}for(;null!==(r=Br.exec(t));)n.push(r[0]),t=Jr.cutOut(t,r.index,Br.lastIndex,a),Br.lastIndex=r.index+a.length,a="";return{src:t,attributes:e,varyings:s,uniforms:i,resources:n}}static processUniforms(t,e,s,i){const n=[];e.forEach((t=>{if(s.hasUniform(t.name))t.ubName="ub_view";else{t.ubName="ub_mesh_ub";const e=zi.get(t.type),s=new Tr(t.name,e,t.arraySize);n.push(s)}})),0===n.length&&n.push(new Tr($i,2));const r=new Er(t,n);let a="";return s.uniformFormats.forEach(((t,e)=>{t&&(a+=Jr.getUniformShaderDeclaration(t,e,0))})),r&&(a+=Jr.getUniformShaderDeclaration(r,2,0)),{code:a,meshUniformBufferFormat:r}}static renameUniformAccess(t,e){return e.forEach((e=>{const s=`uniform.${e.name}`,i=`${e.ubName}.${e.name}`,n=new RegExp(`\\b${s}\\b`,"g");t=t.replace(n,i)})),t}static mergeResources(t,e,s){const i=t.map((t=>new Zr(t,s)));return e.map((t=>new Zr(t,s))).forEach((t=>{const e=i.find((e=>e.name===t.name));e?e.equals(t)||(s.failed=!0):i.push(t)})),i}static processResources(t,e,s,i){const n=[];for(let t=0;t<e.length;t++){const s=e[t];if(s.isTexture){const i=e[t+1],r=i?.isSampler,a=s.sampleType,o=s.textureDimension;n.push(new rn(s.name,3,o,a,r,r?i.name:null)),r&&t++}if(s.isStorageBuffer){const t="read_write"!==s.accessMode,e=new nn(s.name,3,t);e.format=s.type,n.push(e)}}const r=new on(t,n);let a="";return s.bindGroupFormats.forEach(((t,e)=>{t&&(a+=Jr.getTextureShaderDeclaration(t,e,1))})),a+=Jr.getTextureShaderDeclaration(r,1,0),{code:a,meshBindGroupFormat:r}}static getUniformShaderDeclaration(t,e,s){const i=ji[e],n=`struct_ub_${i}`;let r=`struct ${n} {\n`;return t.uniforms.forEach((t=>{let e=Ui[t.type][0];t.count>0?(Gr.hasOwnProperty(e)&&(e=Gr[e]),r+=`    ${t.shortName}: array<${e}, ${t.count}>,\n`):r+=`    ${t.shortName}: ${e},\n`})),r+="};\n",r+=`@group(${e}) @binding(${s}) var<uniform> ub_${i} : ${n};\n\n`,r}static getTextureShaderDeclaration(t,e,s){let i="",n=s;return t.textureFormats.forEach((t=>{const s=((t,e)=>{if(2===e)switch(t){case yi:return"texture_depth_2d";case Si:return"texture_depth_2d_array";case xi:return"texture_depth_cube";case wi:return"texture_depth_cube_array"}let s,i;switch(t){case"1d":s="texture_1d";break;case yi:s="texture_2d";break;case Si:s="texture_2d_array";break;case Ti:s="texture_3d";break;case xi:s="texture_cube";break;case wi:s="texture_cube_array"}switch(e){case 0:case 1:i="f32";break;case 4:i="u32";break;case 3:i="i32"}return`${s}<${i}>`})(t.textureDimension,t.sampleType);if(i+=`@group(${e}) @binding(${n}) var ${t.name}: ${s};\n`,n++,t.hasSampler){const s=2===t.sampleType?"sampler_comparison":"sampler";i+=`@group(${e}) @binding(${n}) var ${t.samplerName}: ${s};\n`,n++}})),t.storageBufferFormats.forEach((t=>{const s=t.readOnly?"read":"read_write";i+=`@group(${e}) @binding(${n}) var<storage, ${s}> ${t.name} : ${t.format};\n`,n++})),i}static processVaryings(t,e,s){let i="",n="",r="";t.forEach(((t,a)=>{const o=t.match(Ur);if(o){const l=o[1];s?e.set(l,a):a=e.get(l),i+=`    @location(${a}) ${t},\n`,s||(n+=`    var<private> ${t};\n`,r+=`    ${l} = input.${l};\n`)}})),s?i+="    @builtin(position) position : vec4f,\n":(i+="    @builtin(position) position : vec4f,\n",i+="    @builtin(front_facing) frontFacing : bool,\n",i+="    @builtin(sample_index) sampleIndex : u32\n");return`\n\t\t\t\t\t\tstruct ${s?"VertexOutput":"FragmentInput"} {\n\t\t\t\t\t\t\t\t${i}\n\t\t\t\t\t\t};\n\t\t\t\t\t\t${s?"":`\n\t\t\t\t\t\tvar<private> pcPosition: vec4f;\n\t\t\t\t\t\tvar<private> pcFrontFacing: bool;\n\t\t\t\t\t\tvar<private> pcSampleIndex: u32;\n\t\t\t\t\t\t${n}\n\t\t\t\t\t\t\n\t\t\t\t\t\t// function to copy inputs (varyings) to private global variables\n\t\t\t\t\t\tfn _pcCopyInputs(input: FragmentInput) {\n\t\t\t\t\t\t\t\t${r}\n\t\t\t\t\t\t\t\tpcPosition = input.position;\n\t\t\t\t\t\t\t\tpcFrontFacing = input.frontFacing;\n\t\t\t\t\t\t\t\tpcSampleIndex = input.sampleIndex;\n\t\t\t\t\t\t}\n\t\t\t\t`}\n\t\t\t\t`}static generateFragmentOutputStruct(t,e){let s="struct FragmentOutput {\n";for(let t=0;t<e;t++)s+=`    @location(${t}) color${t>0?t:""} : pcOutType${t},\n`;return-1!==t.search(/\.fragDepth\s*=/)&&(s+="    @builtin(frag_depth) fragDepth : f32\n"),`${s}};\n`}static floatAttributeToInt(t,e){return{f32:e?"i32":"u32",vec2f:e?"vec2i":"vec2u",vec3f:e?"vec3i":"vec3u",vec4f:e?"vec4i":"vec4u"}[{f32:"f32","vec2<f32>":"vec2f","vec3<f32>":"vec3f","vec4<f32>":"vec4f"}[t]||t]||null}static processAttributes(t,e={},s,i,n){let r="",a="",o="";return t.forEach((t=>{const n=Wr(t),l=n[0];let h=n[1];const c=h;if(e.hasOwnProperty(l)){const n=e[l],d=Ji[n];s.set(d,l);const u=i.getVertexElement(n);if(u){const t=u.dataType;if(6!==t&&7!==t&&!u.normalize&&!u.asInt){const e=0===t||2===t||4===t;h=Jr.floatAttributeToInt(h,e)}}r+=`    @location(${d}) ${l}: ${h},\n`,a+=`    var<private> ${t};\n`,o+=`    ${l} = ${c}(input.${l});\n`}})),`\n\t\t\t\t\t\tstruct VertexInput {\n\t\t\t\t\t\t\t\t${r}\n\t\t\t\t\t\t\t\t@builtin(vertex_index) vertexIndex : u32,       // built-in vertex index\n\t\t\t\t\t\t\t\t@builtin(instance_index) instanceIndex : u32    // built-in instance index\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t${a}\n\t\t\t\t\t\tvar<private> pcVertexIndex: u32;\n\t\t\t\t\t\tvar<private> pcInstanceIndex: u32;\n\n\t\t\t\t\t\tfn _pcCopyInputs(input: VertexInput) {\n\t\t\t\t\t\t\t\t${o}\n\t\t\t\t\t\t\t\tpcVertexIndex = input.vertexIndex;\n\t\t\t\t\t\t\t\tpcInstanceIndex = input.instanceIndex;\n\t\t\t\t\t\t}\n\t\t\t\t`}static copyInputs(t,e){const s=t.match(Vr);if(!s||!s[2])return t;const i=s[2],n=s.index+s[0].length-1;return t.slice(0,n+1)+`\n    _pcCopyInputs(${i});`+t.slice(n+1)}static cutOut(t,e,s,i){return t.substring(0,e)+i+t.substring(s)}}class ta{constructor(t){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=t;const e=t.definition;e.shaderLanguage===Di?(e.cshader?(this._computeCode=e.cshader??null,this.computeUniformBufferFormats=e.computeUniformBufferFormats,this.computeBindGroupFormat=e.computeBindGroupFormat):(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",e.processingOptions?this.processWGSL():(this._vertexCode=e.vshader??null,this._fragmentCode=e.fshader??null,t.meshUniformBufferFormat=e.meshUniformBufferFormat,t.meshBindGroupFormat=e.meshBindGroupFormat)),t.ready=!0):e.processingOptions&&this.processGLSL()}destroy(t){this._vertexCode=null,this._fragmentCode=null}createShaderModule(t,e){return this.shader.device.wgpu.createShaderModule({code:t})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}processGLSL(){const t=this.shader,e=Or.run(t.device,t.definition,t);this._vertexCode=this.transpile(e.vshader,"vertex",t.definition.vshader),this._fragmentCode=this.transpile(e.fshader,"fragment",t.definition.fshader),this._vertexCode&&this._fragmentCode?t.ready=!0:t.failed=!0,t.meshUniformBufferFormat=e.meshUniformBufferFormat,t.meshBindGroupFormat=e.meshBindGroupFormat,t.attributes=e.attributes}processWGSL(){const t=this.shader,e=Jr.run(t.device,t.definition,t);this._vertexCode=e.vshader,this._fragmentCode=e.fshader,t.meshUniformBufferFormat=e.meshUniformBufferFormat,t.meshBindGroupFormat=e.meshBindGroupFormat,t.attributes=e.attributes}transpile(t,e,s){const i=this.shader.device;if(!i.glslang||!i.twgsl)return console.error(`Cannot transpile shader [${this.shader.label}] - shader transpilers (glslang/twgsl) are not available. Make sure to provide glslangUrl and twgslUrl when creating the device.`,{shader:this.shader}),null;try{const s=i.glslang.compileGLSL(t,e);return i.twgsl.convertSpirV2WGSL(s)}catch(i){console.error(`Failed to transpile webgl ${e} shader [${this.shader.label}] to WebGPU while rendering undefined, error:\n [${i.stack}]`,{processed:t,original:s,shader:this.shader,error:i,stack:i.stack})}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(t,e){}}const ea=[];ea[0]="repeat",ea[1]="clamp-to-edge",ea[2]="mirror-repeat";const sa=[];sa[0]={level:"nearest",mip:"nearest"},sa[1]={level:"linear",mip:"nearest"},sa[2]={level:"nearest",mip:"nearest"},sa[3]={level:"nearest",mip:"linear"},sa[4]={level:"linear",mip:"nearest"},sa[5]={level:"linear",mip:"linear"};class ia{constructor(t){this.samplers=[],this.texture=t,this.format=jn[t.format],this.create(t.device)}create(t){const e=this.texture,s=t.wgpu,i=e.numLevels;let n;this.desc={size:{width:e.width,height:e.height,depthOrArrayLayers:e.cubemap?6:e.array?e.arrayLength:1},format:this.format,mipLevelCount:i,sampleCount:1,dimension:e.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(Hs(e.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(e.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=s.createTexture(this.desc),this.texture.format===Ms&&(n={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(n)}destroy(t){}propertyChanged(t){this.samplers.length=0}getView(t){return this.uploadImmediate(t,this.texture),this.view}createView(t){const e=t??{},s=this.desc,i=this.texture,n={format:e.format??s.format,dimension:e.dimension??(i.cubemap?"cube":i.volume?"3d":i.array?"2d-array":"2d"),aspect:e.aspect??"all",baseMipLevel:e.baseMipLevel??0,mipLevelCount:e.mipLevelCount??s.mipLevelCount,baseArrayLayer:e.baseArrayLayer??0,arrayLayerCount:e.arrayLayerCount??s.depthOrArrayLayers};return this.gpuTexture.createView(n)}getSampler(t,e){let s=this.samplers[e];if(!s){const i=this.texture,n={addressModeU:ea[i.addressU],addressModeV:ea[i.addressV],addressModeW:ea[i.addressW]};if(!e&&i.compareOnRead&&(e=2),2===e||3===e||4===e)n.compare="less",n.magFilter="linear",n.minFilter="linear";else if(1===e)n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest";else{!t.textureFloatFilterable&&(i.format===Ls||i.format===Ps)||this.texture.format===Ms||Ws(this.texture.format)?(n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest"):(n.magFilter=sa[i.magFilter].level,n.minFilter=sa[i.minFilter].level,n.mipmapFilter=sa[i.minFilter].mip)}const r="linear"===n.minFilter&&"linear"===n.magFilter&&"linear"===n.mipmapFilter;n.maxAnisotropy=r?Qe.clamp(Math.round(i._anisotropy),1,t.maxTextureAnisotropy):1,s=t.wgpu.createSampler(n),this.samplers[e]=s}return s}loseContext(){}uploadImmediate(t,e){(e._needsUpload||e._needsMipmapsUpload)&&(this.uploadData(t),e._needsUpload=!1,e._needsMipmapsUpload=!1)}uploadData(t){const e=this.texture;if(e._levels){let s=!1,i=!1;const n=e.numLevels;for(let r=0;r<n;r++){const n=e._levels[r];if(n)if(e.cubemap)for(let e=0;e<6;e++){const a=n[e];a?this.isExternalImage(a)?(this.uploadExternalImage(t,a,r,e),s=!0):ArrayBuffer.isView(a)&&(this.uploadTypedArrayData(t,a,r,e),s=!0):i=!0}else if(e._volume);else if(e.array)if(e.arrayLength===n.length)for(let i=0;i<e._arrayLength;i++){const e=n[i];this.isExternalImage(e)?(this.uploadExternalImage(t,e,r,i),s=!0):ArrayBuffer.isView(e)&&(this.uploadTypedArrayData(t,e,r,i),s=!0)}else i=!0;else this.isExternalImage(n)?(this.uploadExternalImage(t,n,r,0),s=!0):ArrayBuffer.isView(n)&&(this.uploadTypedArrayData(t,n,r,0),s=!0);else i=!0}s&&i&&e.mipmaps&&!Hs(e.format)&&!Ws(e.format)&&t.mipmapRenderer.generate(this),e._gpuSize&&e.adjustVramSizeTracking(t._vram,-e._gpuSize),e._gpuSize=e.gpuSize,e.adjustVramSizeTracking(t._vram,e._gpuSize)}}isExternalImage(t){return"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas}uploadExternalImage(t,e,s,i){const n={source:e,origin:[0,0],flipY:!1},r={texture:this.gpuTexture,mipLevel:s,origin:[0,0,i],aspect:"all"},a={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};t.submit(),e instanceof HTMLCanvasElement&&e.getContext("2d"),t.wgpu.queue.copyExternalImageToTexture(n,r,a)}uploadTypedArrayData(t,e,s,i){const n=this.texture,r=t.wgpu,a={texture:this.gpuTexture,origin:[0,0,i],mipLevel:s},o=hn.calcLevelDimension(n.width,s),l=hn.calcLevelDimension(n.height,s);hn.calcLevelGpuSize(o,l,1,n.format);const h=Vs.get(n.format);let c,d;if(h.size)c={offset:0,bytesPerRow:h.size*o,rowsPerImage:l},d={width:o,height:l};else if(h.blockSize){const t=t=>Math.floor((t+3)/4);c={offset:0,bytesPerRow:h.blockSize*t(o),rowsPerImage:t(l)},d={width:Math.max(4,o),height:Math.max(4,l)}}t.submit(),r.queue.writeTexture(a,e,c,d)}read(t,e,s,i,n){const r=n.mipLevel??0,a=n.face??0,o=n.data??null,l=n.immediate??!1,h=this.texture,c=s*Vs.get(h.format).size,d=Qe.roundUp(c,256),u=d*i,f=h.device,p=f.createBufferImpl(9);p.allocate(f,u);const m={texture:this.gpuTexture,mipLevel:r,origin:[t,e,a]},_={buffer:p.buffer,offset:0,bytesPerRow:d},g={width:s,height:i,depthOrArrayLayers:1};return f.getCommandEncoder().copyTextureToBuffer(m,_,g),f.readBuffer(p,u,null,l).then((t=>{const e=o?.constructor===Uint8Array?o:new Uint8Array(o?.buffer??i*c);for(let s=0;s<i;s++){const i=s*d,n=s*c,r=t.subarray(i,i+c);e.set(r,n)}return o??e}))}}class na extends Yn{constructor(t){super(64)}unlock(t){const e=t.device;super.unlock(e,t.storageInt32.buffer)}}class ra extends Yn{constructor(t,e,s){super(32|(s?.storage?128:0))}unlock(t){const e=t.device;super.unlock(e,t.storage)}}const aa=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,oa=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,la=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,ha=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,ca=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,da=/(endif|else|elif)(?:[ \t]+([^\r\n]*))?\r?\n?/g,ua=/\{?[\w-]+\}?/,fa=/(!|\s)?defined\(([\w-]+)\)/,pa=/!?defined\s*\([^)]*\)/g,ma=/!?defined\s*$/,_a=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,ga=/[+\-]/g,va=/include[ \t]+"([\w-]+)(?:\s*,\s*([\w-]+))?"/g,ba=/\{i\}/g,ya=/(pcFragColor[1-8])\b/g;class Sa{static run(t,e=new Map,s={}){Sa.sourceName=s.sourceName,t=(t=this.stripComments(t)).split(/\r?\n/).map((t=>t.trimEnd())).join("\n");const i=new Map,n=new Map;if(null===(t=this._preprocess(t,i,n,e,s.stripDefines)))return null;const r=new Map;return i.forEach(((t,e)=>{Number.isInteger(parseFloat(t))&&!t.includes(".")&&r.set(e,t)})),t=this.stripComments(t),t=this.stripUnusedColorAttachments(t,s),t=this.RemoveEmptyLines(t),t=this.processArraySize(t,r),t=this.injectDefines(t,n)}static stripUnusedColorAttachments(t,e){if(e.stripUnusedColorAttachments){const e=new Map,s=t.match(ya);s?.forEach((t=>{const s=parseInt(t.charAt(t.length-1),10);e.set(s,(e.get(s)??0)+1)}));if(Array.from(e.values()).some((t=>1===t))){const s=t.split("\n"),i=[];for(let t=0;t<s.length;t++){const n=s[t].match(ya);if(n){const t=parseInt(n[0].charAt(n[0].length-1),10);if(t>0&&1===e.get(t))continue}i.push(s[t])}t=i.join("\n")}}return t}static stripComments(t){return t.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")}static processArraySize(t,e){return null!==t&&e.forEach(((e,s)=>{t=t.replace(new RegExp(`\\[${s}\\]`,"g"),`[${e}]`)})),t}static injectDefines(t,e){if(null!==t&&e.size>0){const s=t.split("\n");e.forEach(((t,e)=>{const i=new RegExp(e,"g");for(let e=0;e<s.length;e++)s[e].includes("#")||(s[e]=s[e].replace(i,t))})),t=s.join("\n")}return t}static RemoveEmptyLines(t){return null!==t&&(t=(t=t.split(/\r?\n/).map((t=>""===t.trim()?"":t)).join("\n")).replace(/(\n\n){3,}/g,"\n\n")),t}static _preprocess(t,e=new Map,s,i,n){const r=t,a=[];let o,l=!1;for(;null!==(o=aa.exec(t))&&!l;){const h=o[1];switch(h){case"define":{oa.lastIndex=o.index;const i=oa.exec(t);l||=null===i;const r=i[1];ua.lastIndex=i.index;const h=ua.exec(r)[0];let c=r.substring(h.length).trim();""===c&&(c="true");let d=n;if(Sa._keep(a)){const n=h.startsWith("{")&&h.endsWith("}");n&&(d=!0),n?s.set(h,c):e.set(h,c),d&&(t=t.substring(0,i.index-1)+t.substring(oa.lastIndex),aa.lastIndex=i.index-1)}d||(aa.lastIndex=i.index+i[0].length);break}case"undef":{ha.lastIndex=o.index;const s=ha.exec(t),i=s[1].trim();Sa._keep(a)&&(e.delete(i),n&&(t=t.substring(0,s.index-1)+t.substring(ha.lastIndex),aa.lastIndex=s.index-1)),n||(aa.lastIndex=s.index+s[0].length);break}case"extension":{la.lastIndex=o.index;const s=la.exec(t);if(l||=null===s,s){const t=s[1];Sa._keep(a)&&e.set(t,"true")}aa.lastIndex=s.index+s[0].length;break}case"ifdef":case"ifndef":case"if":{ca.lastIndex=o.index;const s=ca.exec(t),i=s[2],n=Sa.evaluate(i,e);l||=n.error;let r=n.result;"ifndef"===h&&(r=!r),a.push({anyKeep:r,keep:r,start:o.index,end:ca.lastIndex}),aa.lastIndex=s.index+s[0].length;break}case"endif":case"else":case"elif":{da.lastIndex=o.index;const s=da.exec(t),i=a.pop();if(!i){console.error(`Shader preprocessing encountered "#${s[1]}" without a preceding #if #ifdef #ifndef while preprocessing ${Sa.sourceName} on line:\n ${t.substring(o.index,o.index+100)}...`,{source:r}),l=!0;continue}const n=i.keep?t.substring(i.end,o.index):"";t=t.substring(0,i.start)+n+t.substring(da.lastIndex),aa.lastIndex=i.start+n.length;const h=s[1];if("else"===h||"elif"===h){let t=!1;if(!i.anyKeep)if("else"===h)t=!i.keep;else{const i=Sa.evaluate(s[2],e);t=i.result,l||=i.error}a.push({anyKeep:i.anyKeep||t,keep:t,start:aa.lastIndex,end:aa.lastIndex})}break}case"include":{va.lastIndex=o.index;const s=va.exec(t);if(l||=null===s,!s){l=!0;continue}const n=s[1].trim(),h=s[2]?.trim();if(Sa._keep(a)){let a=i?.get(n);if(void 0===a){console.error(`Include "${n}" not resolved while preprocessing ${Sa.sourceName}`,{originalSource:r,source:t}),l=!0;continue}if(a=this.stripComments(a),h){const s=e.get(h),i=parseFloat(s);if(Number.isInteger(i)){let t="";for(let e=0;e<i;e++)t+=a.replace(ba,String(e));a=t}else console.error(`Include Count identifier "${h}" not resolved while preprocessing ${Sa.sourceName} on line:\n ${t.substring(o.index,o.index+100)}...`,{originalSource:r,source:t}),l=!0}t=t.substring(0,s.index-1)+a+t.substring(va.lastIndex),aa.lastIndex=s.index-1}break}}}return a.length>0&&(console.error(`Shader preprocessing reached the end of the file without encountering the necessary #endif to close a preceding #if, #ifdef, or #ifndef block. ${Sa.sourceName}`),l=!0),l?(console.error("Failed to preprocess shader: ",{source:r}),null):t}static _keep(t){for(let e=0;e<t.length;e++)if(!t[e].keep)return!1;return!0}static evaluateAtomicExpression(t,e){let s=!1,i=!1;if("true"===(t=t.trim()))return{result:!0,error:s};if("false"===t)return{result:!1,error:s};const n=fa.exec(t);if(n){i="!"===n[1],t=n[2].trim();const r=e.has(t);return{result:i?!r:r,error:s}}const r=_a.exec(t);if(r){const t=e.get(r[1].trim())??r[1].trim(),i=e.get(r[3].trim())??r[3].trim();let n=!1;switch(r[2].trim()){case"==":n=t===i;break;case"!=":n=t!==i;break;case"<":n=t<i;break;case"<=":n=t<=i;break;case">":n=t>i;break;case">=":n=t>=i;break;default:s=!0}return{result:n,error:s}}return{result:e.has(t),error:s}}static processParentheses(t,e){let s=!1,i=t.trim();for(;i.startsWith("(")&&i.endsWith(")");){let t=0,e=!0;for(let s=0;s<i.length-1;s++)if("("===i[s])t++;else if(")"===i[s]&&(t--,0===t)){e=!1;break}if(!e)break;i=i.slice(1,-1).trim()}for(;;){let t=!1,n=0,r=0,a=-1,o=-1,l=0;for(let e=0;e<i.length;e++)if("("===i[e]){const s=i.substring(0,e);ma.test(s)?l++:0===l&&(n++,n>r&&(r=n,a=e),t=!0)}else")"===i[e]&&(l>0?l--:n>0&&(n===r&&-1!==a&&(o=e),n--));if(!t||-1===a||-1===o)break;const h=i.substring(a+1,o),{result:c,error:d}=Sa.evaluate(h,e);s=s||d,i=i.substring(0,a)+(c?"true":"false")+i.substring(o+1)}return{expression:i,error:s}}static evaluate(t,e){const s=null===ga.exec(t);let i=t,n=!1;if(-1!==t.replace(pa,"").indexOf("(")){const s=Sa.processParentheses(t,e);i=s.expression,n=s.error}if(n)return{result:!1,error:!0};const r=i.split("||");for(const t of r){const i=t.split("&&");let n=!0;for(const t of i){const{result:s,error:i}=Sa.evaluateAtomicExpression(t.trim(),e);if(!s||i){n=!1;break}}if(n)return{result:!0,error:!s}}return{result:!1,error:!s}}}var xa="\n#ifndef outType_0\n#define outType_0 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\n#if COLOR_ATTACHMENT_1\nlayout(location = 1) out highp outType_1 pcFragColor1;\n#endif\n#if COLOR_ATTACHMENT_2\nlayout(location = 2) out highp outType_2 pcFragColor2;\n#endif\n#if COLOR_ATTACHMENT_3\nlayout(location = 3) out highp outType_3 pcFragColor3;\n#endif\n#if COLOR_ATTACHMENT_4\nlayout(location = 4) out highp outType_4 pcFragColor4;\n#endif\n#if COLOR_ATTACHMENT_5\nlayout(location = 5) out highp outType_5 pcFragColor5;\n#endif\n#if COLOR_ATTACHMENT_6\nlayout(location = 6) out highp outType_6 pcFragColor6;\n#endif\n#if COLOR_ATTACHMENT_7\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#endif\n#define gl_FragColor pcFragColor0\n#define varying in\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLod textureLod\n#define texture2DProjLod textureProjLod\n#define textureCubeLod textureLod\n#define texture2DGrad textureGrad\n#define texture2DProjGrad textureProjGrad\n#define textureCubeGrad textureGrad\n#define utexture2D texture\n#define itexture2D texture\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2DShadow name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n#define GL2\n",wa="\n#define attribute in\n#define varying out\n#define texture2D texture\n#define utexture2D texture\n#define itexture2D texture\n#define GL2\n#define VERTEXSHADER\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n",Ta="\n#extension GL_EXT_samplerless_texture_functions : require\n#ifndef outType_0\n#define outType_0 vec4\n#endif\n#ifndef outType_1\n#define outType_1 vec4\n#endif\n#ifndef outType_2\n#define outType_2 vec4\n#endif\n#ifndef outType_3\n#define outType_3 vec4\n#endif\n#ifndef outType_4\n#define outType_4 vec4\n#endif\n#ifndef outType_5\n#define outType_5 vec4\n#endif\n#ifndef outType_6\n#define outType_6 vec4\n#endif\n#ifndef outType_7\n#define outType_7 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\nlayout(location = 1) out highp outType_1 pcFragColor1;\nlayout(location = 2) out highp outType_2 pcFragColor2;\nlayout(location = 3) out highp outType_3 pcFragColor3;\nlayout(location = 4) out highp outType_4 pcFragColor4;\nlayout(location = 5) out highp outType_5 pcFragColor5;\nlayout(location = 6) out highp outType_6 pcFragColor6;\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#define gl_FragColor pcFragColor0\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)\n#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)\n#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)\n#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define SHADOWMAP_PASS(name) name, name ## _sampler\n#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n",Ea="\n#extension GL_EXT_samplerless_texture_functions : require\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n#define VERTEXSHADER\n#define gl_VertexID gl_VertexIndex\n#define gl_InstanceID gl_InstanceIndex\n",Ca="\n#define VERTEXSHADER\n",Aa="\nvec2 getGrabScreenPos(vec4 clipPos) {\n\tvec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\nvec2 getImageEffectUV(vec2 uv) {\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\n",Da="\nfn getGrabScreenPos(clipPos: vec4<f32>) -> vec2<f32> {\n\tvar uv: vec2<f32> = (clipPos.xy / clipPos.w) * 0.5 + vec2<f32>(0.5);\n\tuv.y = 1.0 - uv.y;\n\treturn uv;\n}\nfn getImageEffectUV(uv: vec2<f32>) -> vec2<f32> {\n\tvar modifiedUV: vec2<f32> = uv;\n\tmodifiedUV.y = 1.0 - modifiedUV.y;\n\treturn modifiedUV;\n}\nstruct WrappedF32 { @size(16) element: f32 }\nstruct WrappedI32 { @size(16) element: i32 }\nstruct WrappedU32 { @size(16) element: u32 }\nstruct WrappedVec2F { @size(16) element: vec2f }\nstruct WrappedVec2I { @size(16) element: vec2i }\nstruct WrappedVec2U { @size(16) element: vec2u }\n";const Pa={vertex_position:$s,vertex_normal:qs,vertex_tangent:Ks,vertex_texCoord0:ti,vertex_texCoord1:ei,vertex_texCoord2:si,vertex_texCoord3:ii,vertex_texCoord4:ni,vertex_texCoord5:ri,vertex_texCoord6:ai,vertex_texCoord7:oi,vertex_color:Zs,vertex_boneIndices:Qs,vertex_boneWeights:Ys};class La{static createDefinition(t,e){const s=t=>{let e=t.fragmentOutputTypes??"vec4";return Array.isArray(e)||(e=[e]),e},i=(e,i,n,r)=>{const a=t.isWebGPU?e:i;let o="";if(!n){const e=s(r);for(let s=0;s<t.maxColorAttachments;s++){o+=`#define COLOR_ATTACHMENT_${s}\n`;o+=`#define outType_${s} ${e[s]??"vec4"}\n`}}return o+a},n=(e,i)=>{let n="";if(!e){const e=s(i);for(let s=0;s<t.maxColorAttachments;s++){const t=e[s]??"vec4";n+=`alias pcOutType${s} = ${Zi.get(t)};\n`}}return n},r=e.name??"Untitled";let a,o;const l=La.getDefinesCode(t,e.vertexDefines),h=La.getDefinesCode(t,e.fragmentDefines);return e.shaderLanguage===Di?(a=`\n\t\t\t\t\t\t\t\t${n(!0,e)}\n\t\t\t\t\t\t\t\t${Ca}\n\t\t\t\t\t\t\t\t${Da}\n\t\t\t\t\t\t\t\t${l}\n\t\t\t\t\t\t\t\t${e.vertexCode}\n\t\t\t\t\t\t`,o=`\n\t\t\t\t\t\t\t\t${n(!1,e)}\n\t\t\t\t\t\t\t\t\n\n\t\t\t\t\t\t\t\t${Da}\n\t\t\t\t\t\t\t\t${h}\n\t\t\t\t\t\t\t\t${e.fragmentCode}\n\t\t\t\t\t\t`):(a=`${La.versionCode(t)+i(Ea,wa,!0,e)+l+La.precisionCode(t)}\n\t\t\t\t\t\t\t\t${Aa}\n\t\t\t\t\t\t\t\t${La.getShaderNameCode(r)}\n\t\t\t\t\t\t\t\t${e.vertexCode}`,o=`${(e.fragmentPreamble||"")+La.versionCode(t)+i(Ta,xa,!1,e)+h+La.precisionCode(t)}\n\t\t\t\t\t\t\t\t${Aa}\n\t\t\t\t\t\t\t\t${La.getShaderNameCode(r)}\n\t\t\t\t\t\t\t\t${e.fragmentCode}`),{name:r,shaderLanguage:e.shaderLanguage??Ai,attributes:e.attributes,vshader:a,vincludes:e.vertexIncludes,fincludes:e.fragmentIncludes,fshader:o,useTransformFeedback:e.useTransformFeedback,meshUniformBufferFormat:e.meshUniformBufferFormat,meshBindGroupFormat:e.meshBindGroupFormat}}static getDefinesCode(t,e){let s="";return t.capsDefines.forEach(((t,e)=>{s+=`#define ${e} ${t}\n`})),s+="\n",e?.forEach(((t,e)=>{s+=`#define ${e} ${t}\n`})),s+="\n",s}static getShaderNameCode(t){return`#define SHADER_NAME ${t}\n`}static versionCode(t){return t.isWebGPU?"#version 450\n":"#version 300 es\n"}static precisionCode(t,e){e&&"highp"!==e&&"mediump"!==e&&"lowp"!==e&&(e=null),e&&("highp"===e&&"highp"!==t.maxPrecision&&(e="mediump"),"mediump"===e&&"lowp"===t.maxPrecision&&(e="lowp"));const s=e||t.precision;return`\n\t\t\t\t\t\tprecision ${s} float;\n\t\t\t\t\t\tprecision ${s} int;\n\t\t\t\t\t\tprecision ${s} usampler2D;\n\t\t\t\t\t\tprecision ${s} isampler2D;\n\t\t\t\t\t\tprecision ${s} sampler2DShadow;\n\t\t\t\t\t\tprecision ${s} samplerCubeShadow;\n\t\t\t\t\t\tprecision ${s} sampler2DArray;\n\t\t\t\t`}static collectAttributes(t){const e={};let s=0,i=t.indexOf("attribute");for(;i>=0&&!(i>0&&"/"===t[i-1]);){let n=!1;if(i>0){let e=t.lastIndexOf("\n",i);e=-1!==e?e+1:0;t.substring(e,i).includes("#")&&(n=!0)}if(!n){const n=t.indexOf(";",i),r=t.lastIndexOf(" ",n),a=t.substring(r+1,n);if(e[a]);else{const t=Pa[a];void 0!==t?e[a]=t:(e[a]=`ATTR${s}`,s++)}}i=t.indexOf("attribute",i+1)}return e}}let Ia=0;class Ra{constructor(t,e){if(this.attributes=new Map,this.id=Ia++,this.device=t,this.definition=e,this.name=e.name||"Untitled",this.init(),e.cshader)e.cshader=Sa.run(e.cshader,e.cincludes,{sourceName:`compute shader for ${this.label}`,stripDefines:!0});else{const s=e.shaderLanguage===Di;e.vshader=Sa.run(e.vshader,e.vincludes,{sourceName:`vertex shader for ${this.label}`,stripDefines:s}),e.shaderLanguage===Ai&&(e.attributes??=La.collectAttributes(e.vshader));const i=t.isWebGL2&&("osx"===Ue.name||"ios"===Ue.name);if(e.fshader=Sa.run(e.fshader,e.fincludes,{stripUnusedColorAttachments:i,stripDefines:s,sourceName:`fragment shader for ${this.label}`}),!e.vshader||!e.fshader)return void(this.failed=!0)}this.impl=t.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}get label(){return`Shader Id ${this.id} (${this.definition.shaderLanguage===Di?"WGSL":"GLSL"}) ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}}class Ma{}class ka{}class Oa{constructor(t,e,s){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=t,this.bufferSize=e,this.bufferAlignment=s}destroy(){this.gpuBuffers.forEach((t=>{t.destroy(this.device)})),this.gpuBuffers=null,this.stagingBuffers.forEach((t=>{t.destroy(this.device)})),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null}alloc(t,e){if(this.activeBuffer){const t=Qe.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-t<e&&this.scheduleSubmit()}if(!this.activeBuffer){let t=this.gpuBuffers.pop();t||(t=this.createBuffer(this.device,this.bufferSize,!1));let e=this.stagingBuffers.pop();e||(e=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new Ma,this.activeBuffer.stagingBuffer=e,this.activeBuffer.gpuBuffer=t,this.activeBuffer.offset=0,this.activeBuffer.size=0}const s=this.activeBuffer,i=Qe.roundUp(s.size,this.bufferAlignment);t.gpuBuffer=s.gpuBuffer,t.offset=i,t.storage=s.stagingBuffer.alloc(i,e),s.size=i+e}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit()}}const Fa=[];Fa[2]=function(t,e,s){t.storageFloat32[s]=e},Fa[3]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1]},Fa[4]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2]},Fa[5]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2],i[s+3]=e[3]},Fa[1]=function(t,e,s){t.storageInt32[s]=e},Fa[6]=function(t,e,s){const i=t.storageInt32;i[s]=e[0],i[s+1]=e[1]},Fa[7]=function(t,e,s){const i=t.storageInt32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2]},Fa[8]=function(t,e,s){const i=t.storageInt32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2],i[s+3]=e[3]},Fa[12]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1],i[s+4]=e[2],i[s+5]=e[3],i[s+8]=e[4],i[s+9]=e[5]},Fa[13]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2],i[s+4]=e[3],i[s+5]=e[4],i[s+6]=e[5],i[s+8]=e[6],i[s+9]=e[7],i[s+10]=e[8]},Fa[17]=function(t,e,s,i){const n=t.storageFloat32;for(let t=0;t<i;t++)n[s+4*t]=e[t]},Fa[21]=(t,e,s,i)=>{const n=t.storageFloat32;for(let t=0;t<i;t++)n[s+4*t]=e[2*t],n[s+4*t+1]=e[2*t+1]},Fa[22]=(t,e,s,i)=>{const n=t.storageFloat32;for(let t=0;t<i;t++)n[s+4*t]=e[3*t],n[s+4*t+1]=e[3*t+1],n[s+4*t+2]=e[3*t+2]},Fa[26]=(t,e,s,i)=>{t.storageUint32[s]=e},Fa[27]=(t,e,s,i)=>{const n=t.storageUint32;n[s]=e[0],n[s+1]=e[1]},Fa[28]=(t,e,s,i)=>{const n=t.storageUint32;n[s]=e[0],n[s+1]=e[1],n[s+2]=e[2]},Fa[29]=(t,e,s,i)=>{const n=t.storageUint32;n[s]=e[0],n[s+1]=e[1],n[s+2]=e[2],n[s+3]=e[3]},Fa[30]=function(t,e,s,i){const n=t.storageInt32;for(let t=0;t<i;t++)n[s+4*t]=e[t]},Fa[32]=Fa[30],Fa[31]=function(t,e,s,i){const n=t.storageUint32;for(let t=0;t<i;t++)n[s+4*t]=e[t]},Fa[33]=(t,e,s,i)=>{const n=t.storageInt32;for(let t=0;t<i;t++)n[s+4*t]=e[2*t],n[s+4*t+1]=e[2*t+1]},Fa[35]=Fa[33],Fa[34]=(t,e,s,i)=>{const n=t.storageUint32;for(let t=0;t<i;t++)n[s+4*t]=e[2*t],n[s+4*t+1]=e[2*t+1]},Fa[36]=(t,e,s,i)=>{const n=t.storageInt32;for(let t=0;t<i;t++)n[s+4*t]=e[3*t],n[s+4*t+1]=e[3*t+1],n[s+4*t+2]=e[3*t+2]},Fa[38]=Fa[36],Fa[37]=(t,e,s,i)=>{const n=t.storageUint32;for(let t=0;t<i;t++)n[s+4*t]=e[3*t],n[s+4*t+1]=e[3*t+1],n[s+4*t+2]=e[3*t+2]};class Na{constructor(t,e,s=!0){if(this.renderVersionDirty=0,this.device=t,this.format=e,this.persistent=s,s){this.impl=t.createUniformBufferImpl(this);const s=new ArrayBuffer(e.byteSize);this.assignStorage(new Int32Array(s)),t._vram.ub+=this.format.byteSize}else this.allocation=new ka}destroy(){if(this.persistent){const t=this.device;this.impl.destroy(t),t._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(t){this.storageInt32=t,this.storageUint32=new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4),this.storageFloat32=new Float32Array(t.buffer,t.byteOffset,t.byteLength/4)}loseContext(){this.impl?.loseContext()}setUniform(t,e){const s=t.offset;if(null!=e){const i=Fa[t.updateType];i?i(this,e,s,t.count):this.storageFloat32.set(e,s)}}set(t,e){const s=this.format.map.get(t);s&&this.setUniform(s,e)}startUpdate(t){if(!this.persistent){const e=this.allocation,s=e.gpuBuffer;this.device.dynamicBuffers.alloc(e,this.format.byteSize),this.assignStorage(e.storage),t&&(t.bindGroup=e.gpuBuffer.getBindGroup(this),t.offsets[0]=e.offset),s!==e.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}}endUpdate(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}update(t){this.startUpdate(t);const e=this.format.uniforms;for(let t=0;t<e.length;t++){const s=e[t].scopeId.value;this.setUniform(e[t],s)}this.endUpdate()}}const Ba={type:5,base:0,baseVertex:0,count:4,indexed:!1};class Ua{constructor(t){const e="\n\n\t\t\t\t\t\tstruct ub_mesh {\n\t\t\t\t\t\t\t\tcolor : vec4f,\n\t\t\t\t\t\t\t\tdepth: f32\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@group(2) @binding(0) var<uniform> ubMesh : ub_mesh;\n\n\t\t\t\t\t\tvar<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n\t\t\t\t\t\t\t\tvec2(-1.0, 1.0), vec2(1.0, 1.0),\n\t\t\t\t\t\t\t\tvec2(-1.0, -1.0), vec2(1.0, -1.0)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstruct VertexOutput {\n\t\t\t\t\t\t\t\t@builtin(position) position : vec4f\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@vertex\n\t\t\t\t\t\tfn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n\t\t\t\t\t\t\t\tvar output : VertexOutput;\n\t\t\t\t\t\t\t\toutput.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);\n\t\t\t\t\t\t\t\treturn output;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@fragment\n\t\t\t\t\t\tfn fragmentMain() -> @location(0) vec4f {\n\t\t\t\t\t\t\t\treturn ubMesh.color;\n\t\t\t\t\t\t}\n\t\t\t\t";this.shader=new Ra(t,{name:"WebGPUClearRendererShader",shaderLanguage:Di,vshader:e,fshader:e}),this.uniformBuffer=new Na(t,new Er(t,[new Tr("color",5),new Tr("depth",2)]),!1),this.dynamicBindGroup=new gn,this.colorData=new Float32Array(4)}destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null}clear(t,e,s,i){const n=(s=s||i).flags??i.flags;if(0!==n){const{uniformBuffer:r,dynamicBindGroup:a}=this;if(r.startUpdate(a),t.setBindGroup(2,a.bindGroup,a.offsets),t.setBindGroup(1,t.emptyBindGroup),1&n&&(e.colorBuffer||e.impl.assignedColorTexture)){const e=s.color??i.color;this.colorData.set(e),t.setBlendState(Sn.NOBLEND)}else t.setBlendState(Sn.NOWRITE);if(r.set("color",this.colorData),2&n&&e.depth){const e=s.depth??i.depth;r.set("depth",e),t.setDepthState(Tn.WRITEDEPTH)}else r.set("depth",1),t.setDepthState(Tn.NODEPTH);r.endUpdate(),t.setCullMode(0),t.setShader(this.shader),t.draw(Ba)}}}class za{constructor(t){this.device=t;const e="\n \n\t\t\t\t\t\tvar<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n\t\t\t\t\t\t\t\tvec2(-1.0, 1.0), vec2(1.0, 1.0),\n\t\t\t\t\t\t\t\tvec2(-1.0, -1.0), vec2(1.0, -1.0)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstruct VertexOutput {\n\t\t\t\t\t\t\t\t@builtin(position) position : vec4f,\n\t\t\t\t\t\t\t\t@location(0) texCoord : vec2f\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t@vertex\n\t\t\t\t\t\tfn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n\t\t\t\t\t\t\tvar output : VertexOutput;\n\t\t\t\t\t\t\toutput.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);\n\t\t\t\t\t\t\toutput.position = vec4f(pos[vertexIndex], 0, 1);\n\t\t\t\t\t\t\treturn output;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@group(0) @binding(0) var imgSampler : sampler;\n\t\t\t\t\t\t@group(0) @binding(1) var img : texture_2d<f32>;\n\n\t\t\t\t\t\t@fragment\n\t\t\t\t\t\tfn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {\n\t\t\t\t\t\t\treturn textureSample(img, imgSampler, texCoord);\n\t\t\t\t\t\t}\n\t\t\t\t";this.shader=new Ra(t,{name:"WebGPUMipmapRendererShader",shaderLanguage:Di,vshader:e,fshader:e}),this.minSampler=t.wgpu.createSampler({minFilter:"linear"})}destroy(){this.shader.destroy(),this.shader=null}generate(t){const e=t.desc;if(e.mipLevelCount<=1)return;if(t.texture.volume)return;const s=this.device,i=s.wgpu,n=this.shader.impl,r=i.createRenderPipeline({layout:"auto",vertex:{module:n.getVertexShaderModule(),entryPoint:n.vertexEntryPoint},fragment:{module:n.getFragmentShaderModule(),entryPoint:n.fragmentEntryPoint,targets:[{format:e.format}]},primitive:{topology:"triangle-strip"}}),a=t.texture,o=a.cubemap?6:a.array?a.arrayLength:1,l=[];for(let e=0;e<o;e++)l.push(t.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:e}));const h=s.getCommandEncoder();for(let s=1;s<e.mipLevelCount;s++)for(let e=0;e<o;e++){const n=t.createView({dimension:"2d",baseMipLevel:s,mipLevelCount:1,baseArrayLayer:e}),a=h.beginRenderPass({colorAttachments:[{view:n,loadOp:"clear",storeOp:"store"}]}),o=i.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:l[e]}]});a.setPipeline(r),a.setBindGroup(0,o),a.draw(4),a.end(),l[e]=n}s.pipeline=null}}class Va{constructor(t){this.bindGroupCache=new Map,this.device=t,this.bindGroupFormat=new on(this.device,[new sn(Xi,3)])}getBindGroup(t){const e=t.format.byteSize;let s=this.bindGroupCache.get(e);return s||(s=new vn(this.device,this.bindGroupFormat,t),s.update(),this.bindGroupCache.set(e,s)),s}}class Ha extends Va{constructor(t,e,s){super(t),this.buffer=null,this.mappedRange=null,this.buffer=t.wgpu.createBuffer({size:e,usage:s?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:s}),s&&this.onAvailable(),t._vram.ub+=e}destroy(t){t._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null}onAvailable(){this.mappedRange=this.buffer.getMappedRange()}alloc(t,e){return new Int32Array(this.mappedRange,t,e/4)}}class Ga extends Oa{createBuffer(t,e,s){return new Ha(t,e,s)}submit(){super.submit();const t=this.usedBuffers.length;if(t){const e=this.device,s=this.gpuBuffers,i=e.wgpu.createCommandEncoder();for(let e=t-1;e>=0;e--){const t=this.usedBuffers[e],{stagingBuffer:n,gpuBuffer:r,offset:a,size:o}=t,l=n.buffer;l.unmap(),i.copyBufferToBuffer(l,a,r.buffer,a,o),s.push(r)}const n=i.finish();e.addCommandBuffer(n,!0);for(let e=0;e<t;e++){const t=this.usedBuffers[e].stagingBuffer;this.pendingStagingBuffers.push(t)}this.usedBuffers.length=0}}onCommandBuffersSubmitted(){const t=this.pendingStagingBuffers.length;if(t){for(let e=0;e<t;e++){const t=this.pendingStagingBuffers[e];t.buffer.mapAsync(GPUMapMode.WRITE).then((()=>{this.stagingBuffers&&(t.onAvailable(),this.stagingBuffers.push(t))}))}this.pendingStagingBuffers.length=0}}constructor(...t){super(...t),this.pendingStagingBuffers=[]}}class Wa{loseContext(){this.pastFrameAllocations.clear()}set enabled(t){this._enableRequest=t}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))}request(t){this.pastFrameAllocations.set(t,this.frameAllocations),this.frameAllocations=[]}report(t,e){e&&(this.pastFrameAllocations.get(t),e.length>0&&(this._frameTime=e.reduce(((t,e)=>t+e),0)),Ye.get("GpuTimings")),this.pastFrameAllocations.delete(t)}getSlot(t){const e=this.frameAllocations.length;return this.frameAllocations.push(t),e}get slotCount(){return this.frameAllocations.length}constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0}}class ja{constructor(t,e,s){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=t,this.capacity=s,this.bytesPerSlot=e?8:4;const i=t.wgpu;this.querySet=i.createQuerySet({type:e?"timestamp":"occlusion",count:s}),this.queryBuffer=i.createBuffer({size:this.bytesPerSlot*s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}destroy(){this.querySet?.destroy(),this.querySet=null,this.queryBuffer?.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach((t=>{t.destroy()})),this.stagingBuffers=null}getStagingBuffer(){let t=this.stagingBuffers.pop();return t||(t=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),t}resolve(t){const e=this.device.getCommandEncoder();e.resolveQuerySet(this.querySet,0,t,this.queryBuffer,0);const s=this.getStagingBuffer();this.activeStagingBuffer=s,e.copyBufferToBuffer(this.queryBuffer,0,s,0,this.bytesPerSlot*t)}request(t,e){const s=this.activeStagingBuffer;return this.activeStagingBuffer=null,s.mapAsync(GPUMapMode.READ).then((()=>{const i=new BigInt64Array(s.getMappedRange()),n=[];for(let e=0;e<t;e++)n.push(1e-6*Number(i[2*e+1]-i[2*e]));return s.unmap(),this.stagingBuffers?.push(s),{renderVersion:e,timings:n}}))}}class Xa extends Wa{constructor(t){super(),this.device=t,this.timestampQueriesSet=t.supportsTimestampQuery?new ja(t,!0,512):null}destroy(){this.timestampQueriesSet?.destroy(),this.timestampQueriesSet=null}frameStart(){this.processEnableRequest()}frameEnd(){this._enabled&&this.timestampQueriesSet?.resolve(2*this.slotCount)}request(){if(this._enabled){const t=this.device.renderVersion;this.timestampQueriesSet?.request(this.slotCount,t).then((t=>{this.report(t.renderVersion,t.timings)})),super.request(t)}}}class $a{constructor(t){this.pipelineCache=new Map,this.device=t;const e="\n \n\t\t\t\t\t\tvar<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n\t\t\t\t\t\t\t\tvec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstruct VertexOutput {\n\t\t\t\t\t\t\t\t@builtin(position) position : vec4f,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t@vertex\n\t\t\t\t\t\tfn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n\t\t\t\t\t\t\tvar output : VertexOutput;\n\t\t\t\t\t\t\toutput.position = vec4f(pos[vertexIndex], 0, 1);\n\t\t\t\t\t\t\treturn output;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@group(0) @binding(0) var img : texture_depth_multisampled_2d;\n\n\t\t\t\t\t\t@fragment\n\t\t\t\t\t\tfn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {\n\t\t\t\t\t\t\t\t// load th depth value from sample index 0\n\t\t\t\t\t\t\t\tvar depth = textureLoad(img, vec2i(fragColor.xy), 0u);\n\t\t\t\t\t\t\t\treturn vec4f(depth, 0.0, 0.0, 0.0);\n\t\t\t\t\t\t}\n\t\t\t\t";this.shader=new Ra(t,{name:"WebGPUResolverDepthShader",shaderLanguage:Di,vshader:e,fshader:e})}destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null}getPipeline(t){let e=this.pipelineCache.get(t);return e||(e=this.createPipeline(t),this.pipelineCache.set(t,e)),e}createPipeline(t){const e=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:e.getVertexShaderModule(),entryPoint:e.vertexEntryPoint},fragment:{module:e.getFragmentShaderModule(),entryPoint:e.fragmentEntryPoint,targets:[{format:t}]},primitive:{topology:"triangle-strip"}})}resolveDepth(t,e,s){const i=this.device,n=i.wgpu,r=this.getPipeline(s.format),a=e.depthOrArrayLayers;for(let i=0;i<a;i++){const a=e.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:i}),o=s.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:i}),l=t.beginRenderPass({colorAttachments:[{view:o,loadOp:"clear",storeOp:"store"}]}),h=n.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:a}]});l.setPipeline(r),l.setBindGroup(0,h),l.draw(4),l.end()}i.pipeline=null}}class qa{constructor(t){this.uniformBuffers=[],this.bindGroup=null,this.compute=t;const{device:e,shader:s}=t,{computeBindGroupFormat:i,computeUniformBufferFormats:n}=s.impl;if(this.bindGroup=new vn(e,i),n)for(const t in n)if(n.hasOwnProperty(t)){const s=new Na(e,n[t],!0);this.uniformBuffers.push(s),this.bindGroup.setUniformBuffer(t,s)}this.pipeline=e.computePipeline.get(s,i)}destroy(){this.uniformBuffers.forEach((t=>t.destroy())),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null}updateBindGroup(){const{bindGroup:t}=this;t.updateUniformBuffers(),t.update()}dispatch(t,e,s){const i=this.compute.device;i.setBindGroup(0,this.bindGroup);const n=i.passEncoder;n.setPipeline(this.pipeline),n.dispatchWorkgroups(t,e,s)}}let Ka=0;class Ya{constructor(t,e,s=0){this.id=Ka++,this.device=t,this.byteSize=e,this.bufferUsage=s,this.impl=t.createBufferImpl(128|s),this.impl.allocate(t,e),this.device.buffers.push(this),this.adjustVramSizeTracking(t._vram,this.byteSize)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.adjustVramSizeTracking(t._vram,-this.byteSize),this.impl.destroy(t)}adjustVramSizeTracking(t,e){t.sb+=e}read(t=0,e=this.byteSize,s=null,i=!1){return this.impl.read(this.device,t,e,s,i)}write(t=0,e,s=0,i){this.impl.write(this.device,t,e,s,i)}clear(t=0,e=this.byteSize){this.impl.clear(this.device,t,e)}}const Qa=new Map;class Za extends zn{constructor(t,e={}){super(t,e),this.renderPipeline=new dr(this),this.computePipeline=new ur(this),this._indirectDrawBuffer=null,this._indirectDrawBufferCount=0,this._indirectDrawNextIndex=0,this.pipeline=null,this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],this.glslang=null,this.twgsl=null,(e=this.initOptions).alpha=e.alpha??!0,this.backBufferAntialias=e.antialias??!1,this.isWebGPU=!0,this._deviceType=Hi,this.scope.resolve($i).setValue(0)}destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy()}initDeviceCaps(){const t=this.wgpu?.limits;this.limits=t,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=t.maxTextureDimension2D,this.maxCubeMapSize=t.maxTextureDimension2D,this.maxVolumeSize=t.maxTextureDimension3D,this.maxColorAttachments=t.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=t.maxUniformBufferBindingSize/16,this.vertexUniformsCount=t.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=!0,this.supportsAreaLights=!0,this.supportsGpuParticles=!0,this.supportsCompute=!0,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0,this.samples=this.backBufferAntialias?4:1;const e=window.navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=e?.has("readonly_and_readwrite_storage_textures"),this.initCapsDefines()}async initWebGpu(t,e){if(!window.navigator.gpu)throw new Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");if(t&&e){const s=t=>new URL(t,window.location.href).toString(),i=await Promise.all([import(`${s(e)}`).then((t=>twgsl(e.replace(".js",".wasm")))),import(`${s(t)}`).then((t=>t.default()))]);this.twgsl=i[0],this.glslang=i[1]}return this.createDevice()}async createDevice(){const t={powerPreference:"default"!==this.initOptions.powerPreference?this.initOptions.powerPreference:void 0,xrCompatible:this.initOptions.xrCompatible};this.gpuAdapter=await window.navigator.gpu.requestAdapter(t);const e=[],s=t=>{const s=this.gpuAdapter.features.has(t);return s&&e.push(t),s};this.textureFloatFilterable=s("float32-filterable"),this.textureFloatBlendable=s("float32-blendable"),this.extCompressedTextureS3TC=s("texture-compression-bc"),this.extCompressedTextureETC=s("texture-compression-etc2"),this.extCompressedTextureASTC=s("texture-compression-astc"),this.supportsTimestampQuery=s("timestamp-query"),this.supportsDepthClip=s("depth-clip-control"),this.supportsDepth32Stencil=s("depth32float-stencil8"),this.supportsIndirectFirstInstance=s("indirect-first-instance"),this.supportsShaderF16=s("shader-f16"),this.supportsStorageRGBA8=s("bgra8unorm-storage"),this.textureRG11B10Renderable=s("rg11b10ufloat-renderable"),this.supportsClipDistances=s("clip-distances");const i=this.gpuAdapter?.limits,n={};if(i)for(const t in i)"minSubgroupSize"!==t&&"maxSubgroupSize"!==t&&(n[t]=i[t]);const r={requiredFeatures:e,requiredLimits:n,defaultQueue:{label:"Default Queue"}};this.wgpu=await this.gpuAdapter.requestDevice(r),this.wgpu.lost?.then(this.handleDeviceLost.bind(this)),this.initDeviceCaps(),this.gpuContext=this.canvas.getContext("webgpu");let a="standard",o=window.navigator.gpu.getPreferredCanvasFormat();const l=this.initOptions.displayFormat;if(this.backBufferFormat="rgba8unorm"===o?l===Wi?Os:7:l===Wi?64:31,this.backBufferViewFormat=l===Wi?`${o}-srgb`:o,"hdr"===l&&this.textureFloatFilterable){const t=window.matchMedia("(dynamic-range: high)");t?.matches&&(this.backBufferFormat=Ps,this.backBufferViewFormat="rgba16float",o="rgba16float",this.isHdr=!0,a="extended")}return this.canvasConfig={device:this.wgpu,colorSpace:"srgb",alphaMode:this.initOptions.alpha?"premultiplied":"opaque",format:o,toneMapping:{mode:a},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:l===Wi?[this.backBufferViewFormat]:[]},this.gpuContext?.configure(this.canvasConfig),this.createBackbuffer(),this.clearRenderer=new Ua(this),this.mipmapRenderer=new za(this),this.resolver=new $a(this),this.postInit(),this}async handleDeviceLost(t){"destroyed"!==t.reason&&(super.loseContext(),await this.createDevice(),super.restoreContext())}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new Xa(this),this.dynamicBuffers=new Ga(this,102400,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new vn(this,new on(this,[])),this.emptyBindGroup.update()}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new Hn({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=!0}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();const t=this.gpuContext?.getCurrentTexture?.()??this.externalBackbuffer?.impl.gpuTexture;this.backBufferSize.x===t.width&&this.backBufferSize.y===t.height||(this.backBufferSize.set(t.width,t.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());const e=this.backBuffer,s=e.impl;s.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(e),s.assignColorTexture(this,t)}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request(),this._indirectDrawNextIndex=0}createBufferImpl(t){return new Yn(t)}createUniformBufferImpl(t){return new na(t)}createVertexBufferImpl(t,e,s){return new ra(t,e,s)}createIndexBufferImpl(t,e){return new Qn(t,e)}createShaderImpl(t){return new ta(t)}createTextureImpl(t){return new ia(t)}createRenderTargetImpl(t){return new xr(t)}createBindGroupFormatImpl(t){return new Kn(t)}createBindGroupImpl(t){return new Gn}createComputeImpl(t){return new qa(t)}get indirectDrawBuffer(){return this.allocateIndirectDrawBuffer(),this._indirectDrawBuffer}allocateIndirectDrawBuffer(){0===this._indirectDrawNextIndex&&this._indirectDrawBufferCount<this.maxIndirectDrawCount&&(this._indirectDrawBuffer?.destroy(),this._indirectDrawBuffer=null),null===this._indirectDrawBuffer&&(this._indirectDrawBuffer=new Ya(this,4*this.maxIndirectDrawCount,264),this._indirectDrawBufferCount=this.maxIndirectDrawCount)}getIndirectDrawSlot(){this.allocateIndirectDrawBuffer();const t=this._indirectDrawNextIndex;return this._indirectDrawNextIndex++,t}setBindGroup(t,e,s){this.passEncoder&&(this.passEncoder.setBindGroup(t,e.impl.bindGroup,s??e.uniformBufferOffsets),this.bindGroupFormats[t]=e.format.impl)}submitVertexBuffer(t,e){const s=t.format,{interleaved:i,elements:n}=s,r=n.length,a=t.impl.buffer;if(i)return this.passEncoder.setVertexBuffer(e,a),1;for(let t=0;t<r;t++)this.passEncoder.setVertexBuffer(e+t,a,n[t].offset);return r}validateVBLocations(t,e){const s=t=>{const{elements:e}=t.format;for(let t=0;t<e.length;t++){const s=e[t].name,i=Ji[s];Qa.has(i),Qa.set(i,s)}};s(t),s(e),Qa.clear()}draw(t,e,s=1,i,n=!0,r=!0){if(this.shader.ready&&!this.shader.failed){const r=this.passEncoder;let a=this.pipeline;const o=this.vertexBuffers[0],l=this.vertexBuffers[1];if(n){if(o){const t=this.submitVertexBuffer(o,0);l&&this.submitVertexBuffer(l,t)}a=this.renderPipeline.get(t,o?.format,l?.format,e?.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack),this.pipeline!==a&&(this.pipeline=a,r.setPipeline(a))}if(e&&r.setIndexBuffer(e.impl.buffer,e.impl.format),void 0!==i){const t=20*i,s=this.indirectDrawBuffer.impl.buffer;e?r.drawIndexedIndirect(s,t):r.drawIndirect(s,t)}else e?r.drawIndexed(t.count,s,t.base,t.baseVertex??0,0):r.draw(t.count,s,t.base,0)}r&&(this.clearVertexBuffer(),this.pipeline=null)}setShader(t,e=!1){t!==this.shader&&(this.shader=t)}setBlendState(t){this.blendState.copy(t)}setDepthState(t){this.depthState.copy(t)}setStencilState(t,e){if(t||e){this.stencilEnabled=!0,this.stencilFront.copy(t??Un.DEFAULT),this.stencilBack.copy(e??Un.DEFAULT);const s=this.stencilFront.ref;this.stencilRef!==s&&(this.stencilRef=s,this.passEncoder.setStencilReference(s))}else this.stencilEnabled=!1}setBlendColor(t,e,s,i){const n=this.blendColor;t===n.r&&e===n.g&&s===n.b&&i===n.a||(n.set(t,e,s,i),this.passEncoder.setBlendConstant(n))}setCullMode(t){this.cullMode=t}setAlphaToCoverage(t){}initializeContextCaches(){super.initializeContextCaches()}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)}_uploadDirtyTextures(){this.textures.forEach((t=>{(t._needsUpload||t._needsMipmaps)&&t.upload()}))}setupTimeStampWrites(t,e){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){const s=this.gpuProfiler.getSlot(e);(t=t??{}).timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:2*s,endOfPassWriteIndex:2*s+1}}return t}startRenderPass(t){this._uploadDirtyTextures();const e=t.renderTarget||this.backBuffer;this.renderTarget=e;const s=e.impl;e!==this.backBuffer&&this.initRenderTarget(e),s.setupForRenderPass(t,e);const i=s.renderPassDescriptor;this.setupTimeStampWrites(i,t.name);const n=this.getCommandEncoder();this.passEncoder=n.beginRenderPass(i),this.passEncoder.label=`${t.name}-PassEncoder RT:${e.name}`,this.setupPassEncoderDefaults();const{width:r,height:a}=e;this.setViewport(0,0,r,a),this.setScissor(0,0,r,a),this.insideRenderPass=!0}endRenderPass(t){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;const e=this.renderTarget;if(e&&e.depthBuffer&&t.depthStencilOps.resolveDepth&&t.samples>1&&e.autoResolve){const t=e.impl.depthAttachment,s=e.depthBuffer.impl.gpuTexture;t&&s&&this.resolver.resolveDepth(this.commandEncoder,t.multisampledDepthBuffer,s)}for(let e=0;e<t.colorArrayOps.length;e++){t.colorArrayOps[e].genMipmaps&&this.mipmapRenderer.generate(t.renderTarget._colorBuffers[e].impl)}}startComputePass(t){this.pipeline=null;const e=this.setupTimeStampWrites(void 0,t),s=this.getCommandEncoder();this.passEncoder=s.beginComputePass(e),this.insideRenderPass=!0}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0}computeDispatch(t,e="Unnamed"){this.startComputePass(e);for(let e=0;e<t.length;e++){const s=t[e];s.applyParameters(),s.impl.updateBindGroup()}for(let e=0;e<t.length;e++){const s=t[e];s.impl.dispatch(s.countX,s.countY,s.countZ)}this.endComputePass()}getCommandEncoder(){let t=this.commandEncoder;return t||(t=this.wgpu.createCommandEncoder(),this.commandEncoder=t),t}endCommandEncoder(){const{commandEncoder:t}=this;if(t){const e=t.finish();this.addCommandBuffer(e),this.commandEncoder=null}}addCommandBuffer(t,e=!1){e?this.commandBuffers.unshift(t):this.commandBuffers.push(t)}submit(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())}clear(t){t.flags&&this.clearRenderer.clear(this,this.renderTarget,t,this.defaultClearOptions)}setViewport(t,e,s,i){this.passEncoder&&(this.renderTarget.flipY||(e=this.renderTarget.height-e-i),this.vx=t,this.vy=e,this.vw=s,this.vh=i,this.passEncoder.setViewport(t,e,s,i,0,1))}setScissor(t,e,s,i){this.passEncoder&&(this.renderTarget.flipY||(e=this.renderTarget.height-e-i),this.sx=t,this.sy=e,this.sw=s,this.sh=i,this.passEncoder.setScissorRect(t,e,s,i))}clearStorageBuffer(t,e=0,s=t.byteSize){this.getCommandEncoder().clearBuffer(t.buffer,e,s)}readStorageBuffer(t,e=0,s=t.byteSize-e,i=null,n=!1){const r=this.createBufferImpl(9);r.allocate(this,s);const a=r.buffer;return this.getCommandEncoder().copyBufferToBuffer(t.buffer,e,a,0,s),this.readBuffer(r,s,i,n)}readBuffer(t,e,s=null,i=!1){const n=t.buffer;return new Promise(((r,a)=>{const o=()=>{n?.mapAsync(GPUMapMode.READ).then((()=>{s??=new Uint8Array(e);const i=n.getMappedRange(0,e),a=s.constructor;s.set(new a(i)),n.unmap(),t.destroy(this),r(s)}))};i?(this.submit(),o()):setTimeout((()=>{o()}))}))}writeStorageBuffer(t,e=0,s,i=0,n){this.wgpu.queue.writeBuffer(t.buffer,e,s,i,n)}copyRenderTarget(t,e,s,i){const n={width:t?t.width:e.width,height:t?t.height:e.height,depthOrArrayLayers:1},r=this.getCommandEncoder();if(s){const s={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},i={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};r.copyTextureToTexture(s,i,n)}if(i){const s=(t||this.renderTarget).impl.depthAttachment.depthTexture;if(t.samples>1){const t=e.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(r,s,t)}else{const t={texture:s,mipLevel:0},i={texture:e?e.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture,mipLevel:0};r.copyTextureToTexture(t,i,n)}}return!0}}class Ja{destroy(t){this.bufferId&&(t.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(t,e,s,i){const n=t.gl;if(this.bufferId)n.bindBuffer(s,this.bufferId),n.bufferSubData(s,0,i);else{let t;switch(e){case 0:t=n.STATIC_DRAW;break;case 1:t=n.DYNAMIC_DRAW;break;case 2:t=n.STREAM_DRAW;break;case 3:t=n.DYNAMIC_COPY}this.bufferId=n.createBuffer(),n.bindBuffer(s,this.bufferId),n.bufferData(s,i,t)}}constructor(){this.bufferId=null}}class to extends Ja{destroy(t){super.destroy(t),t.unbindVertexArray()}loseContext(){super.loseContext(),this.vao=null}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ARRAY_BUFFER,t.storage)}constructor(...t){super(...t),this.vao=null}}class eo extends Ja{constructor(t){super();const e=t.device.gl,s=t.format;0===s?this.glFormat=e.UNSIGNED_BYTE:1===s?this.glFormat=e.UNSIGNED_SHORT:2===s&&(this.glFormat=e.UNSIGNED_INT)}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ELEMENT_ARRAY_BUFFER,t.storage)}}class so{constructor(t,e,s,i){if(this.locationId=i,this.scopeId=t.scope.resolve(e),this.version=new En,"[0]"===e.substring(e.length-3))switch(s){case 2:s=17;break;case 1:s=Oi;break;case Ii:s=31;break;case 0:s=32;break;case 3:s=21;break;case 6:s=Fi;break;case Ri:s=34;break;case 9:s=35;break;case 4:s=22;break;case 7:s=Ni;break;case Mi:s=37;break;case 10:s=38;break;case 5:s=23;break;case 8:s=39;break;case ki:s=40;break;case 11:s=41}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}const io=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class no{destroy(t){this.map.forEach((e=>{t.gl.deleteShader(e)}))}loseContext(t){this.map.clear()}constructor(){this.map=new Map}}const ro=new ln,ao=new ln;class oo{constructor(t){this.compileDuration=0,this.init(),this.compile(t.device,t),this.link(t.device,t),t.device.shaders.push(t)}destroy(t){this.glProgram&&(t.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}loseContext(){this.init()}restoreContext(t,e){this.compile(t,e),this.link(t,e)}compile(t,e){const s=e.definition;this.glVertexShader=this._compileShaderSource(t,s.vshader,!0),this.glFragmentShader=this._compileShaderSource(t,s.fshader,!1)}link(t,e){if(this.glProgram)return;const s=t.gl;if(s.isContextLost())return;const i=s.createProgram();this.glProgram=i,s.attachShader(i,this.glVertexShader),s.attachShader(i,this.glFragmentShader);const n=e.definition,r=n.attributes;if(n.useTransformFeedback){const t=[];for(const e in r)r.hasOwnProperty(e)&&t.push(`out_${e}`);s.transformFeedbackVaryings(i,t,s.INTERLEAVED_ATTRIBS)}for(const t in r)if(r.hasOwnProperty(t)){const e=r[t],n=Ji[e];s.bindAttribLocation(i,n,t)}s.linkProgram(i)}_compileShaderSource(t,e,s){const i=t.gl;if(i.isContextLost())return null;const n=(s?ro:ao).get(t,(()=>new no));let r=n.map.get(e);return r||(r=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(r,e),i.compileShader(r),n.map.set(e,r)),r}finalize(t,e){const s=t.gl;if(s.isContextLost())return!0;const i=this.glProgram,n=e.definition;if(!s.getProgramParameter(i,s.LINK_STATUS)){if(!this._isCompiled(t,e,this.glVertexShader,n.vshader,"vertex"))return!1;if(!this._isCompiled(t,e,this.glFragmentShader,n.fshader,"fragment"))return!1;const r=`Failed to link shader program. Error: ${s.getProgramInfoLog(i)}`;return console.error(r),!1}const r=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);e.attributes.clear();for(let t=0;t<r;t++){const r=s.getActiveAttrib(i,t),a=s.getAttribLocation(i,r.name);io.has(r.name)||(void 0===n.attributes[r.name]?(console.error(`Vertex shader attribute "${r.name}" is not mapped to a semantic in shader definition, shader [${e.label}]`,e),e.failed=!0):e.attributes.set(a,r.name))}const a=t._samplerTypes,o=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(let e=0;e<o;e++){const n=s.getActiveUniform(i,e),r=s.getUniformLocation(i,n.name),o=new so(t,n.name,t.pcUniformType[n.type],r);a.has(n.type)?this.samplers.push(o):this.uniforms.push(o)}return e.ready=!0,!0}_isCompiled(t,e,s,i,n){const r=t.gl;if(!r.getShaderParameter(s,r.COMPILE_STATUS)){const t=r.getShaderInfoLog(s),[e,a]=this._processError(i,t),o=`Failed to compile ${n} shader:\n\n${t}\n${e} while rendering undefined`;return console.error(o),!1}return!0}isLinked(t){const{extParallelShaderCompile:e}=t;return!e||t.gl.getProgramParameter(this.glProgram,e.COMPLETION_STATUS_KHR)}_processError(t,e){const s={};let i="";if(t){const n=t.split("\n");let r=0,a=n.length;if(e&&e.startsWith("ERROR:")){const t=e.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);t&&(s.message=t[3],s.line=parseInt(t[2],10),r=Math.max(0,s.line-6),a=Math.min(n.length,s.line+5))}for(let t=r;t<a;t++){i+=`${t+1===s.line?"> ":"  "}${t+1}:\t${n[t]}\n`}s.source=t}return[i,s]}}function lo(t,e){const s=t.width,i=t.height;if(s>e||i>e){const n=e/Math.max(s,i),r=Math.floor(s*n),a=Math.floor(i*n),o=document.createElement("canvas");o.width=r,o.height=a;return o.getContext("2d").drawImage(t,0,0,s,i,0,0,r,a),o}return t}class ho{constructor(t){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=t}destroy(t){if(this._glTexture){for(let e=0;e<t.textureUnits.length;e++){const s=t.textureUnits[e];for(let t=0;t<s.length;t++)s[t]===this._glTexture&&(s[t]=null)}t.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(t){this.dirtyParameterFlags|=t}initialize(t,e){const s=t.gl;switch(this._glTexture=s.createTexture(),this._glTarget=e._cubemap?s.TEXTURE_CUBE_MAP:e._volume?s.TEXTURE_3D:e.array?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,e._format){case 0:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 1:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case 2:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 52:this._glFormat=s.RED,this._glInternalFormat=s.R8,this._glPixelType=s.UNSIGNED_BYTE;break;case 53:this._glFormat=s.RG,this._glInternalFormat=s.RG8,this._glPixelType=s.UNSIGNED_BYTE;break;case 3:this._glFormat=s.RGB,this._glInternalFormat=s.RGB565,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=s.RGBA,this._glInternalFormat=s.RGB5_A1,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA4,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=s.RGB,this._glInternalFormat=s.RGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 7:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 31:case 64:break;case 8:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Ds:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case Fs:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case Ns:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=s.RGB,this._glInternalFormat=t.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=s.RGB,this._glInternalFormat=t.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=s.RGBA,this._glInternalFormat=t.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=s.SRGB,this._glInternalFormat=t.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=t.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=t.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 61:this._glFormat=s.SRGB,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case 62:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=t.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=s.RGBA,this._glInternalFormat=t.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=s.RED,this._glInternalFormat=s.R16F,this._glPixelType=s.HALF_FLOAT;break;case 51:this._glFormat=s.RG,this._glInternalFormat=s.RG16F,this._glPixelType=s.HALF_FLOAT;break;case 11:this._glFormat=s.RGB,this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT;break;case Ps:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT;break;case 13:this._glFormat=s.RGB,this._glInternalFormat=s.RGB32F,this._glPixelType=s.FLOAT;break;case Ls:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA32F,this._glPixelType=s.FLOAT;break;case Is:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case Rs:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT;break;case zs:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT16,this._glPixelType=s.UNSIGNED_SHORT;break;case Ms:this._glFormat=s.DEPTH_STENCIL,this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8;break;case ks:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case Os:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 32:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8I,this._glPixelType=s.BYTE;break;case 33:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 34:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16I,this._glPixelType=s.SHORT;break;case 35:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 36:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32I,this._glPixelType=s.INT;break;case Bs:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32UI,this._glPixelType=s.UNSIGNED_INT;break;case 38:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8I,this._glPixelType=s.BYTE;break;case 39:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 40:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16I,this._glPixelType=s.SHORT;break;case 41:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 42:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32I,this._glPixelType=s.INT;break;case 43:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32UI,this._glPixelType=s.UNSIGNED_INT;break;case 44:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8I,this._glPixelType=s.BYTE;break;case 45:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 46:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16I,this._glPixelType=s.SHORT;break;case 47:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 48:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32I,this._glPixelType=s.INT;break;case Us:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32UI,this._glPixelType=s.UNSIGNED_INT}this._glCreated=!1}upload(t,e){const s=t.gl;if(!e._needsUpload&&(e._needsMipmapsUpload&&e._mipmapsUploaded||!e.pot))return;let i,n,r=0;const a=e.numLevels;for(e.array&&s.texStorage3D(s.TEXTURE_2D_ARRAY,a,this._glInternalFormat,e._width,e._height,e._arrayLength);e._levels[r]||0===r;)if(e._needsUpload||0!==r){if(r&&(!e._needsMipmapsUpload||!e._mipmaps))break;if(i=e._levels[r],n=1/Math.pow(2,r),1===r&&!e._compressed&&!e._integerFormat&&e._levels.length<a&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._cubemap){let a;if(t._isBrowserInterface(i[0]))for(a=0;a<6;a++){if(!e._levelsUpdated[0][a])continue;let n=i[a];t._isImageBrowserInterface(n)&&(n.width>t.maxCubeMapSize||n.height>t.maxCubeMapSize)&&(n=lo(n,t.maxCubeMapSize),0===r&&(e._width=n.width,e._height=n.height)),t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),this._glCreated?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,this._glFormat,this._glPixelType,n):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,this._glFormat,this._glPixelType,n)}else for(n=1/Math.pow(2,r),a=0;a<6;a++){if(!e._levelsUpdated[0][a])continue;const o=i[a];e._compressed?this._glCreated&&o?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,Math.max(e._width*n,1),Math.max(e._height*n,1),this._glInternalFormat,o):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,o):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),this._glCreated&&o?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,Math.max(e._width*n,1),Math.max(e._height*n,1),this._glFormat,this._glPixelType,o):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,this._glFormat,this._glPixelType,o))}}else if(e._volume)e._compressed?s.compressedTexImage3D(s.TEXTURE_3D,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),Math.max(e._depth*n,1),0,i):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),Math.max(e._depth*n,1),0,this._glFormat,this._glPixelType,i));else if(e.array&&"object"==typeof i){if(e._arrayLength===i.length)if(e._compressed)for(let t=0;t<e._arrayLength;t++)s.compressedTexSubImage3D(s.TEXTURE_2D_ARRAY,r,0,0,t,Math.max(Math.floor(e._width*n),1),Math.max(Math.floor(e._height*n),1),1,this._glInternalFormat,i[t]);else for(let t=0;t<e._arrayLength;t++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,r,0,0,t,Math.max(Math.floor(e._width*n),1),Math.max(Math.floor(e._height*n),1),1,this._glFormat,this._glPixelType,i[t])}else{if(t._isBrowserInterface(i)){t._isImageBrowserInterface(i)&&(i.width>t.maxTextureSize||i.height>t.maxTextureSize)&&(i=lo(i,t.maxTextureSize),0===r&&(e._width=i.width,e._height=i.height));const n=i.width||i.videoWidth,a=i.height||i.videoHeight;t.setUnpackFlipY(e._flipY),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),this._glCreated&&e._width===n&&e._height===a&&!t._isImageVideoInterface(i)?s.texSubImage2D(s.TEXTURE_2D,r,0,0,this._glFormat,this._glPixelType,i):(s.texImage2D(s.TEXTURE_2D,r,this._glInternalFormat,this._glFormat,this._glPixelType,i),0===r&&(e._width=n,e._height=a))}else n=1/Math.pow(2,r),e._compressed?this._glCreated&&i?s.compressedTexSubImage2D(s.TEXTURE_2D,r,0,0,Math.max(Math.floor(e._width*n),1),Math.max(Math.floor(e._height*n),1),this._glInternalFormat,i):s.compressedTexImage2D(s.TEXTURE_2D,r,this._glInternalFormat,Math.max(Math.floor(e._width*n),1),Math.max(Math.floor(e._height*n),1),0,i):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),this._glCreated&&i?s.texSubImage2D(s.TEXTURE_2D,r,0,0,Math.max(e._width*n,1),Math.max(e._height*n,1),this._glFormat,this._glPixelType,i):s.texImage2D(s.TEXTURE_2D,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,this._glFormat,this._glPixelType,i));e._mipmapsUploaded=0!==r}r++}else r++;if(e._needsUpload)if(e._cubemap)for(let t=0;t<6;t++)e._levelsUpdated[0][t]=!1;else e._levelsUpdated[0]=!1;!e._compressed&&!e._integerFormat&&e._mipmaps&&e._needsMipmapsUpload&&1===e._levels.length&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._gpuSize&&e.adjustVramSizeTracking(t._vram,-e._gpuSize),e._gpuSize=e.gpuSize,e.adjustVramSizeTracking(t._vram,e._gpuSize),this._glCreated=!0}read(t,e,s,i,n){const r=this.texture;return r.device.readTextureAsync(r,t,e,s,i,n)}write(t,e,s,i,n){const{texture:r}=this,{device:a}=r;return a.setTexture(r,0),a.writeTextureAsync(r,t,e,s,i,n)}}class co{constructor(t,e){this.msaaFB=t,this.resolveFB=e}destroy(t){this.msaaFB&&(t.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(t.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}}class uo{destroy(t){const e=t.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&e.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(e.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&e.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach((t=>{e.deleteRenderbuffer(t)})),this._glMsaaColorBuffers.length=0,this.colorMrtFramebuffers?.forEach((t=>{t.destroy(e)})),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&vr(t).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0}get initialized(){return this._isInitialized}init(t,e){const s=t.gl;this._isInitialized=!0;const i=[];if(void 0!==this.suppliedColorFramebuffer)this._glFrameBuffer=this.suppliedColorFramebuffer;else{this._glFrameBuffer=s.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);const n=e._colorBuffers?.length??0,r=s.COLOR_ATTACHMENT0;for(let a=0;a<n;++a){const n=e.getColorBuffer(a);n&&(n.impl._glTexture||(n._width=Math.min(n.width,t.maxRenderBufferSize),n._height=Math.min(n.height,t.maxRenderBufferSize),t.setTexture(n,0)),s.framebufferTexture2D(s.FRAMEBUFFER,r+a,n._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,n.impl._glTexture,e.mipLevel),i.push(r+a))}s.drawBuffers(i);const a=e._depthBuffer;if(a||e._depth){const i=e._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;if(a)a.impl._glTexture||(a._width=Math.min(a.width,t.maxRenderBufferSize),a._height=Math.min(a.height,t.maxRenderBufferSize),t.setTexture(a,0)),s.framebufferTexture2D(s.FRAMEBUFFER,i,a._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,e._depthBuffer.impl._glTexture,e.mipLevel);else{if(!(e._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer());const t=e._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F;s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),s.renderbufferStorage(s.RENDERBUFFER,t,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,i,s.RENDERBUFFER,this._glDepthBuffer),s.bindRenderbuffer(s.RENDERBUFFER,null)}}}}if(e._samples>1){this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);const n=e._colorBuffers?.length??0;if(void 0!==this.suppliedColorFramebuffer){const i=s.createRenderbuffer();this._glMsaaColorBuffers.push(i);const n=7===t.backBufferFormat?s.RGBA8:s.RGB8;s.bindRenderbuffer(s.RENDERBUFFER,i),s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,n,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,i)}else for(let t=0;t<n;++t){const i=e.getColorBuffer(t);if(i){const n=s.createRenderbuffer();this._glMsaaColorBuffers.push(n),s.bindRenderbuffer(s.RENDERBUFFER,n),s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,i.impl._glInternalFormat,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+t,s.RENDERBUFFER,n)}}if(e._depth){const i=e._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F,n=e._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;let r;const a=e._depthBuffer;a&&(r=`${a.id}:${e.width}:${e.height}:${e._samples}:${i}:${n}`,this._glMsaaDepthBuffer=vr(t).get(r)),this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer(),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,i,e.width,e.height),this._glMsaaDepthBuffer.destroy=function(){s.deleteRenderbuffer(this)},a&&vr(t).set(r,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=r,s.framebufferRenderbuffer(s.FRAMEBUFFER,n,s.RENDERBUFFER,this._glMsaaDepthBuffer)}n>1&&(this._createMsaaMrtFramebuffers(t,e,n),t.setFramebuffer(this._glFrameBuffer),s.drawBuffers(i))}}_createMsaaMrtFramebuffers(t,e,s){const i=t.gl;this.colorMrtFramebuffers=[];for(let n=0;n<s;++n){const s=e.getColorBuffer(n),r=i.createFramebuffer();t.setFramebuffer(r);const a=this._glMsaaColorBuffers[n];i.bindRenderbuffer(i.RENDERBUFFER,a),i.renderbufferStorageMultisample(i.RENDERBUFFER,e._samples,s.impl._glInternalFormat,e.width,e.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,a),i.drawBuffers([i.COLOR_ATTACHMENT0]);const o=i.createFramebuffer();t.setFramebuffer(o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,s._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:i.TEXTURE_2D,s.impl._glTexture,0),this.colorMrtFramebuffers[n]=new co(r,o)}}_checkFbo(t,e,s=""){const i=t.gl;i.checkFramebufferStatus(i.FRAMEBUFFER)}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}internalResolve(t,e,s,i,n){t.setScissor(0,0,i.width,i.height);const r=t.gl;r.bindFramebuffer(r.READ_FRAMEBUFFER,e),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,s),r.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,n,r.NEAREST)}resolve(t,e,s,i){const n=t.gl;if(this.colorMrtFramebuffers){if(s)for(let s=0;s<this.colorMrtFramebuffers.length;s++){const i=this.colorMrtFramebuffers[s];this.internalResolve(t,i.msaaFB,i.resolveFB,e,n.COLOR_BUFFER_BIT)}i&&this.internalResolve(t,this._glFrameBuffer,this._glResolveFrameBuffer,e,n.DEPTH_BUFFER_BIT)}else this.internalResolve(t,this._glFrameBuffer,this._glResolveFrameBuffer,e,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0));n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)}constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=!1}}class fo{destroy(t){this.queries.forEach((e=>t.deleteQuery(e))),this.queries=null}constructor(){this.queries=[]}}class po extends Wa{constructor(t){super(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=t,this.ext=t.extDisjointTimerQuery}destroy(){this.freeQueries.forEach((t=>this.device.gl.deleteQuery(t))),this.frameQueries.forEach((t=>this.device.gl.deleteQuery(t))),this.previousFrameQueries.forEach((t=>t.destroy(this.device.gl))),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]}restoreContext(){this.ext=this.device.extDisjointTimerQuery}getQuery(){return this.freeQueries.pop()??this.device.gl.createQuery()}start(t){if(this.ext){const e=this.getSlot(t),s=this.getQuery();return this.frameQueries[e]=s,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),e}}end(t){void 0!==t&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot)}request(){if(this._enabled){const t=this.ext,e=this.device.gl,s=this.device.renderVersion,i=this.frameQueries;if(i.length>0){this.frameQueries=[];const t=new fo;t.queries=i,t.renderVersion=s,this.previousFrameQueries.push(t)}if(this.previousFrameQueries.length>0){const s=this.previousFrameQueries[0],i=s.queries,n=i[i.length-1],r=e.getQueryParameter(n,e.QUERY_RESULT_AVAILABLE),a=e.getParameter(t.GPU_DISJOINT_EXT);if(r&&!a){this.previousFrameQueries.shift();const t=this.timings;t.length=0;for(let s=0;s<i.length;s++){const n=i[s],r=e.getQueryParameter(n,e.QUERY_RESULT);t[s]=1e-6*r,this.freeQueries.push(n)}this.report(s.renderVersion,t)}a&&(this.previousFrameQueries.forEach((t=>{this.report(t.renderVersion,null),t.destroy(e)})),this.previousFrameQueries.length=0)}super.request(s)}}}const mo=[];class _o extends zn{constructor(t,e={}){super(t,e),this._defaultFramebuffer=null,this._defaultFramebufferChanged=!1,e=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=!1,this._contextLostHandler=t=>{t.preventDefault(),this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored")};const s="undefined"!=typeof navigator&&navigator.userAgent;if(this.forceDisableMultisampling=s&&s.includes("AppleWebKit")&&(s.includes("15.4")||s.includes("15_4")),this.forceDisableMultisampling&&(e.antialias=!1),"firefox"===Ue.browserName){const t=("undefined"!=typeof navigator?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),s=t?t[1]:null;if(s){const t=parseFloat(s);("windows"===Ue.name&&(t>=120||115===t)||"android"===Ue.name&&t>=132)&&(e.antialias=!1)}}this.backBufferAntialias=e.antialias??!1,e.antialias=!1;const i=e.gl??t.getContext("webgl2",e);if(!i)throw new Error("WebGL not supported");this.gl=i,this.isWebGL2=!0,this._deviceType=Vi,this.updateBackbufferFormat(null);const n="chrome"===Ue.browserName,r="safari"===Ue.browserName,a=Ue.browser&&-1!==navigator.appVersion.indexOf("Mac");let o,l,h,c,d;this._tempEnableSafariTextureUnitWorkaround=r,this._tempMacChromeBlitFramebufferWorkaround=a&&n&&!e.alpha,t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!r&&"undefined"!=typeof ImageBitmap,this._samplerTypes=new Set([i.SAMPLER_2D,i.SAMPLER_CUBE,i.UNSIGNED_INT_SAMPLER_2D,i.INT_SAMPLER_2D,i.SAMPLER_2D_SHADOW,i.SAMPLER_CUBE_SHADOW,i.SAMPLER_3D,i.INT_SAMPLER_3D,i.UNSIGNED_INT_SAMPLER_3D,i.SAMPLER_2D_ARRAY,i.INT_SAMPLER_2D_ARRAY,i.UNSIGNED_INT_SAMPLER_2D_ARRAY]),this.glAddress=[i.REPEAT,i.CLAMP_TO_EDGE,i.MIRRORED_REPEAT],this.glBlendEquation=[i.FUNC_ADD,i.FUNC_SUBTRACT,i.FUNC_REVERSE_SUBTRACT,i.MIN,i.MAX],this.glBlendFunctionColor=[i.ZERO,i.ONE,i.SRC_COLOR,i.ONE_MINUS_SRC_COLOR,i.DST_COLOR,i.ONE_MINUS_DST_COLOR,i.SRC_ALPHA,i.SRC_ALPHA_SATURATE,i.ONE_MINUS_SRC_ALPHA,i.DST_ALPHA,i.ONE_MINUS_DST_ALPHA,i.CONSTANT_COLOR,i.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[i.ZERO,i.ONE,i.SRC_COLOR,i.ONE_MINUS_SRC_COLOR,i.DST_COLOR,i.ONE_MINUS_DST_COLOR,i.SRC_ALPHA,i.SRC_ALPHA_SATURATE,i.ONE_MINUS_SRC_ALPHA,i.DST_ALPHA,i.ONE_MINUS_DST_ALPHA,i.CONSTANT_ALPHA,i.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[i.NEVER,i.LESS,i.EQUAL,i.LEQUAL,i.GREATER,i.NOTEQUAL,i.GEQUAL,i.ALWAYS],this.glStencilOp=[i.KEEP,i.ZERO,i.REPLACE,i.INCR,i.INCR_WRAP,i.DECR,i.DECR_WRAP,i.INVERT],this.glClearFlag=[0,i.COLOR_BUFFER_BIT,i.DEPTH_BUFFER_BIT,i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT,i.STENCIL_BUFFER_BIT,i.STENCIL_BUFFER_BIT|i.COLOR_BUFFER_BIT,i.STENCIL_BUFFER_BIT|i.DEPTH_BUFFER_BIT,i.STENCIL_BUFFER_BIT|i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT],this.glCull=[0,i.BACK,i.FRONT,i.FRONT_AND_BACK],this.glFilter=[i.NEAREST,i.LINEAR,i.NEAREST_MIPMAP_NEAREST,i.NEAREST_MIPMAP_LINEAR,i.LINEAR_MIPMAP_NEAREST,i.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[i.POINTS,i.LINES,i.LINE_LOOP,i.LINE_STRIP,i.TRIANGLES,i.TRIANGLE_STRIP,i.TRIANGLE_FAN],this.glType=[i.BYTE,i.UNSIGNED_BYTE,i.SHORT,i.UNSIGNED_SHORT,i.INT,i.UNSIGNED_INT,i.FLOAT,i.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[i.BOOL]=0,this.pcUniformType[i.INT]=1,this.pcUniformType[i.FLOAT]=2,this.pcUniformType[i.FLOAT_VEC2]=3,this.pcUniformType[i.FLOAT_VEC3]=4,this.pcUniformType[i.FLOAT_VEC4]=5,this.pcUniformType[i.INT_VEC2]=6,this.pcUniformType[i.INT_VEC3]=7,this.pcUniformType[i.INT_VEC4]=8,this.pcUniformType[i.BOOL_VEC2]=9,this.pcUniformType[i.BOOL_VEC3]=10,this.pcUniformType[i.BOOL_VEC4]=11,this.pcUniformType[i.FLOAT_MAT2]=12,this.pcUniformType[i.FLOAT_MAT3]=Pi,this.pcUniformType[i.FLOAT_MAT4]=Li,this.pcUniformType[i.SAMPLER_2D]=15,this.pcUniformType[i.SAMPLER_CUBE]=16,this.pcUniformType[i.UNSIGNED_INT]=Ii,this.pcUniformType[i.UNSIGNED_INT_VEC2]=Ri,this.pcUniformType[i.UNSIGNED_INT_VEC3]=Mi,this.pcUniformType[i.UNSIGNED_INT_VEC4]=ki,this.pcUniformType[i.SAMPLER_2D_SHADOW]=18,this.pcUniformType[i.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[i.SAMPLER_2D_ARRAY]=25,this.pcUniformType[i.SAMPLER_3D]=20,this.pcUniformType[i.INT_SAMPLER_2D]=42,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_2D]=43,this.pcUniformType[i.INT_SAMPLER_CUBE]=44,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_2D]=45,this.pcUniformType[i.INT_SAMPLER_3D]=46,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_3D]=47,this.pcUniformType[i.INT_SAMPLER_2D_ARRAY]=48,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_2D_ARRAY]=49,this.targetToSlot={},this.targetToSlot[i.TEXTURE_2D]=0,this.targetToSlot[i.TEXTURE_CUBE_MAP]=1,this.targetToSlot[i.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(t,e){t.value!==e&&(i.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(t,e){t.value!==e&&(i.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[3]=function(t,e){d=t.value,o=e[0],l=e[1],d[0]===o&&d[1]===l||(i.uniform2fv(t.locationId,e),d[0]=o,d[1]=l)},this.commitFunction[4]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],d[0]===o&&d[1]===l&&d[2]===h||(i.uniform3fv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h)},this.commitFunction[5]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],c=e[3],d[0]===o&&d[1]===l&&d[2]===h&&d[3]===c||(i.uniform4fv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h,d[3]=c)},this.commitFunction[6]=function(t,e){d=t.value,o=e[0],l=e[1],d[0]===o&&d[1]===l||(i.uniform2iv(t.locationId,e),d[0]=o,d[1]=l)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],d[0]===o&&d[1]===l&&d[2]===h||(i.uniform3iv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],c=e[3],d[0]===o&&d[1]===l&&d[2]===h&&d[3]===c||(i.uniform4iv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h,d[3]=c)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(t,e){i.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[13]=function(t,e){i.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[14]=function(t,e){i.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[17]=function(t,e){i.uniform1fv(t.locationId,e)},this.commitFunction[21]=function(t,e){i.uniform2fv(t.locationId,e)},this.commitFunction[22]=function(t,e){i.uniform3fv(t.locationId,e)},this.commitFunction[23]=function(t,e){i.uniform4fv(t.locationId,e)},this.commitFunction[26]=function(t,e){t.value!==e&&(i.uniform1ui(t.locationId,e),t.value=e)},this.commitFunction[27]=function(t,e){d=t.value,o=e[0],l=e[1],d[0]===o&&d[1]===l||(i.uniform2uiv(t.locationId,e),d[0]=o,d[1]=l)},this.commitFunction[28]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],d[0]===o&&d[1]===l&&d[2]===h||(i.uniform3uiv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h)},this.commitFunction[29]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],c=e[3],d[0]===o&&d[1]===l&&d[2]===h&&d[3]===c||(i.uniform4uiv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h,d[3]=c)},this.commitFunction[30]=function(t,e){i.uniform1iv(t.locationId,e)},this.commitFunction[31]=function(t,e){i.uniform1uiv(t.locationId,e)},this.commitFunction[32]=this.commitFunction[30],this.commitFunction[33]=function(t,e){i.uniform2iv(t.locationId,e)},this.commitFunction[34]=function(t,e){i.uniform2uiv(t.locationId,e)},this.commitFunction[35]=this.commitFunction[33],this.commitFunction[36]=function(t,e){i.uniform3iv(t.locationId,e)},this.commitFunction[37]=function(t,e){i.uniform3uiv(t.locationId,e)},this.commitFunction[38]=this.commitFunction[36],this.commitFunction[39]=function(t,e){i.uniform4iv(t.locationId,e)},this.commitFunction[40]=function(t,e){i.uniform4uiv(t.locationId,e)},this.commitFunction[41]=this.commitFunction[39],this.commitFunction[24]=function(t,e){i.uniformMatrix4fv(t.locationId,!1,e)},this.constantTexSource=this.scope.resolve("source"),this.postInit()}postInit(){super.postInit(),this.gpuProfiler=new po(this)}destroy(){super.destroy();const t=this.gl;this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createBackbuffer(t){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new Hn({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=t}updateBackbufferFormat(t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t);const s=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=s?7:6}updateBackbuffer(){const t=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||t)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))}createVertexBufferImpl(t,e){return new to}createIndexBufferImpl(t){return new eo(t)}createShaderImpl(t){return new oo(t)}createTextureImpl(t){return new ho(t)}createRenderTargetImpl(t){return new uo}getPrecision(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT);if(s&&i&&n&&r){const t=s.precision>0&&n.precision>0,a=i.precision>0&&r.precision>0;t||(e=a?"mediump":"lowp")}}return e}getExtension(){for(let t=0;t<arguments.length;t++)if(-1!==this.supportedExtensions.indexOf(arguments[t]))return this.gl.getExtension(arguments[t]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){const t=this.gl;this.supportedExtensions=t.getSupportedExtensions()??[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float"),this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc")}initializeCapabilities(){const t=this.gl;let e;const s="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const i=t.getContextAttributes();this.supportsMsaa=i?.antialias??!1,this.supportsStencil=i?.stencil??!1,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&s.match(/SM-[a-zA-Z0-9]+/)||this.unmaskedRenderer.match(/\bMali-G52+/)),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;const n=!this.forceDisableMultisampling;this.maxSamples=n?t.getParameter(t.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=n&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!Ue.android,this.maxTextures<=8&&(this.supportsAreaLights=!1),this.initCapsDefines()}initializeRenderState(){super.initializeRenderState();const t=this.gl;t.disable(t.BLEND),t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0),t.enable(t.CULL_FACE),this.cullFace=t.BACK,t.cullFace(t.BACK),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearColor=new Ze(0,0,0,0),t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_ALIGNMENT,1)}initTextureUnits(t=16){this.textureUnits=[];for(let e=0;e<t;e++)this.textureUnits.push([null,null,null])}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)}loseContext(){super.loseContext();for(const t of this.shaders)t.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),super.restoreContext();for(const t of this.shaders)t.restoreContext()}setViewport(t,e,s,i){this.vx===t&&this.vy===e&&this.vw===s&&this.vh===i||(this.gl.viewport(t,e,s,i),this.vx=t,this.vy=e,this.vw=s,this.vh=i)}setScissor(t,e,s,i){this.sx===t&&this.sy===e&&this.sw===s&&this.sh===i||(this.gl.scissor(t,e,s,i),this.sx=t,this.sy=e,this.sw=s,this.sh=i)}setFramebuffer(t){if(this.activeFramebuffer!==t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.activeFramebuffer=t}}copyRenderTarget(t,e,s,i){const n=this.gl;if(t===this.backBuffer&&(t=null),s)if(e){if(t){if(!t._colorBuffer||!e._colorBuffer)return!1;if(t._colorBuffer._format!==e._colorBuffer._format)return!1}}else if(!t._colorBuffer)return!1;if(i&&t&&!t._depth){if(!t._depthBuffer||!e._depthBuffer)return!1;if(t._depthBuffer._format!==e._depthBuffer._format)return!1}const r=this.renderTarget;this.renderTarget=e,this.updateBegin();const a=t?t.impl._glFrameBuffer:this.backBuffer?.impl._glFrameBuffer,o=e?e.impl._glFrameBuffer:this.backBuffer?.impl._glFrameBuffer;n.bindFramebuffer(n.READ_FRAMEBUFFER,a),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,o);const l=t?t.width:e?e.width:this.width,h=t?t.height:e?e.height:this.height;return n.blitFramebuffer(0,0,l,h,0,0,l,h,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=r,n.bindFramebuffer(n.FRAMEBUFFER,r?r.impl._glFrameBuffer:null),!0}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart()}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()}startRenderPass(t){const e=t.renderTarget??this.backBuffer;this.renderTarget=e,this.updateBegin();const{width:s,height:i}=e;this.setViewport(0,0,s,i),this.setScissor(0,0,s,i);const n=t.colorOps,r=t.depthStencilOps;if(n?.clear||r.clearDepth||r.clearStencil){let t=0;const e={};n?.clear&&(t|=1,e.color=[n.clearValue.r,n.clearValue.g,n.clearValue.b,n.clearValue.a]),r.clearDepth&&(t|=2,e.depth=r.clearDepthValue),r.clearStencil&&(t|=4,e.stencil=r.clearStencilValue),e.flags=t,this.clear(e)}this.insideRenderPass=!0}endRenderPass(t){this.unbindVertexArray();const e=this.renderTarget,s=t.colorArrayOps.length;if(e){mo.length=0;const i=this.gl;for(let e=0;e<s;e++){const s=t.colorArrayOps[e];s.store||s.resolve||mo.push(i.COLOR_ATTACHMENT0+e)}e!==this.backBuffer&&(t.depthStencilOps.storeDepth||mo.push(i.DEPTH_ATTACHMENT),t.depthStencilOps.storeStencil||mo.push(i.STENCIL_ATTACHMENT)),mo.length>0&&t.fullSizeClearRect&&i.invalidateFramebuffer(i.DRAW_FRAMEBUFFER,mo),s&&t.colorOps?.resolve&&t.samples>1&&e.autoResolve&&e.resolve(!0,!1),e.depthBuffer&&t.depthStencilOps.resolveDepth&&t.samples>1&&e.autoResolve&&e.resolve(!1,!0);for(let i=0;i<s;i++){if(t.colorArrayOps[i].genMipmaps){const t=e._colorBuffers[i];t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}}this.insideRenderPass=!1}set defaultFramebuffer(t){this._defaultFramebuffer!==t&&(this._defaultFramebuffer=t,this._defaultFramebufferChanged=!0)}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let t=0;t<this.textureUnits.length;++t)for(let e=0;e<3;++e)this.textureUnits[t][e]=null;const t=this.renderTarget??this.backBuffer,e=t.impl;e.initialized||this.initRenderTarget(t),this.setFramebuffer(e._glFrameBuffer)}updateEnd(){this.unbindVertexArray();const t=this.renderTarget;if(t&&t!==this.backBuffer){t._samples>1&&t.autoResolve&&t.resolve();const e=t._colorBuffer;e&&e.impl._glTexture&&e.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),this.gl.generateMipmap(e.impl._glTarget))}}setUnpackFlipY(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}}setUnpackPremultiplyAlpha(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}}activeTexture(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)}bindTexture(t){const e=t.impl,s=e._glTarget,i=e._glTexture,n=this.textureUnit,r=this.targetToSlot[s];this.textureUnits[n][r]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][r]=i)}bindTextureOnUnit(t,e){const s=t.impl,i=s._glTarget,n=s._glTexture,r=this.targetToSlot[i];this.textureUnits[e][r]!==n&&(this.activeTexture(e),this.gl.bindTexture(i,n),this.textureUnits[e][r]=n)}setTextureParameters(t){const e=this.gl,s=t.impl.dirtyParameterFlags,i=t.impl._glTarget;if(1&s){let s=t._minFilter;(!t._mipmaps||t._compressed&&1===t._levels.length)&&(2===s||3===s?s=0:4!==s&&5!==s||(s=1)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,this.glFilter[s])}if(2&s&&e.texParameteri(i,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&s&&e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]),8&s&&e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]),16&s&&e.texParameteri(i,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&s&&e.texParameteri(i,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&s&&e.texParameteri(i,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&s){const s=this.extTextureFilterAnisotropic;s&&e.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,Qe.clamp(Math.round(t._anisotropy),1,this.maxAnisotropy))}}setTexture(t,e){const s=t.impl;s._glTexture||s.initialize(this,t),s.dirtyParameterFlags>0||t._needsUpload||t._needsMipmapsUpload?(this.activeTexture(e),this.bindTexture(t),s.dirtyParameterFlags&&(this.setTextureParameters(t),s.dirtyParameterFlags=0),(t._needsUpload||t._needsMipmapsUpload)&&(s.upload(this,t),t._needsUpload=!1,t._needsMipmapsUpload=!1)):this.bindTextureOnUnit(t,e)}createVertexArray(t){let e,s;const i=t.length>1;if(i){e="";for(let s=0;s<t.length;s++){const i=t[s];e+=i.id+i.format.renderingHash}s=this._vaoMap.get(e)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let e=0;e<t.length;e++){const s=t[e];n.bindBuffer(n.ARRAY_BUFFER,s.impl.bufferId);const i=s.format.elements;for(let t=0;t<i.length;t++){const e=i[t],r=Ji[e.name];e.asInt?n.vertexAttribIPointer(r,e.numComponents,this.glType[e.dataType],e.stride,e.offset):n.vertexAttribPointer(r,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset),n.enableVertexAttribArray(r),s.format.instancing&&n.vertexAttribDivisor(r,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(e,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(t){const e=this.gl;let s;if(1===this.vertexBuffers.length){const t=this.vertexBuffers[0];t.impl.vao||(t.impl.vao=this.createVertexArray(this.vertexBuffers)),s=t.impl.vao}else s=this.createVertexArray(this.vertexBuffers);this.boundVao!==s&&(this.boundVao=s,e.bindVertexArray(s));const i=t?t.impl.bufferId:null;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i)}draw(t,e,s,i,n=!0,r=!0){const a=this.shader;if(a&&(this.activateShader(),this.shaderValid)){const i=this.gl;n&&this.setBuffers(e);let r=0;const o=a.impl.samplers;for(let t=0,e=o.length;t<e;t++){const e=o[t];let s=e.scopeId.value;if(!s){const t=e.scopeId.name;"uSceneDepthMap"===t&&(s=mn(this,"white")),"uSceneColorMap"===t&&(s=mn(this,"pink")),s||(s=mn(this,"pink"))}if(s instanceof dn){const t=s;this.setTexture(t,r),e.slot!==r&&(i.uniform1i(e.locationId,r),e.slot=r),r++}else{e.array.length=0;const t=s.length;for(let i=0;i<t;i++){const t=s[i];this.setTexture(t,r),e.array[i]=r,r++}i.uniform1iv(e.locationId,e.array)}}const l=a.impl.uniforms;for(let t=0,e=l.length;t<e;t++){const e=l[t],s=e.scopeId,i=e.version,n=s.versionObject.version;if(i.globalId!==n.globalId||i.revision!==n.revision){i.globalId=n.globalId,i.revision=n.revision;const t=s.value;null!=t&&this.commitFunction[e.dataType](e,t)}}this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));const h=this.glPrimitive[t.type],c=t.count;if(t.indexed){const n=e.impl.glFormat,r=t.base*e.bytesPerIndex;s>0?i.drawElementsInstanced(h,c,n,r,s):i.drawElements(h,c,n,r)}else{const e=t.base;s>0?i.drawArraysInstanced(h,e,c,s):i.drawArrays(h,e,c)}this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}r&&this.clearVertexBuffer()}clear(t){const e=this.defaultClearOptions,s=(t=t||e).flags??e.flags;if(0!==s){const i=this.gl;if(1&s){const s=t.color??e.color,i=s[0],n=s[1],r=s[2],a=s[3],o=this.clearColor;i===o.r&&n===o.g&&r===o.b&&a===o.a||(this.gl.clearColor(i,n,r,a),this.clearColor.set(i,n,r,a)),this.setBlendState(Sn.NOBLEND)}if(2&s){const s=t.depth??e.depth;s!==this.clearDepth&&(this.gl.clearDepth(s),this.clearDepth=s),this.setDepthState(Tn.WRITEDEPTH)}if(4&s){const s=t.stencil??e.stencil;s!==this.clearStencil&&(this.gl.clearStencil(s),this.clearStencil=s),i.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255}i.clear(this.glClearFlag[s])}}submit(){this.gl.flush()}readPixels(t,e,s,i,n){const r=this.gl;r.readPixels(t,e,s,i,r.RGBA,r.UNSIGNED_BYTE,n)}clientWaitAsync(t,e){const s=this.gl,i=s.fenceSync(s.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise(((n,r)=>{!function a(){const o=s.clientWaitSync(i,t,0);o===s.TIMEOUT_EXPIRED?setTimeout(a,e):(s.deleteSync(i),o===s.WAIT_FAILED?r(new Error("webgl clientWaitSync sync failed")):n())}()}))}async readPixelsAsync(t,e,s,i,n){const r=this.gl,a=this.renderTarget.colorBuffer?.impl,o=a?._glFormat??r.RGBA,l=a?._glPixelType??r.UNSIGNED_BYTE,h=r.createBuffer();return r.bindBuffer(r.PIXEL_PACK_BUFFER,h),r.bufferData(r.PIXEL_PACK_BUFFER,n.byteLength,r.STREAM_READ),r.readPixels(t,e,s,i,o,l,0),r.bindBuffer(r.PIXEL_PACK_BUFFER,null),await this.clientWaitAsync(0,16),r.bindBuffer(r.PIXEL_PACK_BUFFER,h),r.getBufferSubData(r.PIXEL_PACK_BUFFER,0,n),r.bindBuffer(r.PIXEL_PACK_BUFFER,null),r.deleteBuffer(h),n}readTextureAsync(t,e,s,i,n,r){const a=r.face??0,o=r.renderTarget??new Hn({colorBuffer:t,depth:!1,face:a}),l=new ArrayBuffer(hn.calcLevelGpuSize(i,n,1,t._format)),h=r.data??new(Xs(t._format))(l);return this.setRenderTarget(o),this.initRenderTarget(o),new Promise(((t,a)=>{this.readPixelsAsync(e,s,i,n,h).then((e=>{r.renderTarget||o.destroy(),t(e)})).catch(a)}))}async writeTextureAsync(t,e,s,i,n,r){const a=this.gl,o=t.impl,l=o?._glFormat??a.RGBA,h=o?._glPixelType??a.UNSIGNED_BYTE,c=a.createBuffer();a.bindBuffer(a.PIXEL_UNPACK_BUFFER,c),a.bufferData(a.PIXEL_UNPACK_BUFFER,r,a.STREAM_DRAW),a.bindTexture(a.TEXTURE_2D,o._glTexture),a.texSubImage2D(a.TEXTURE_2D,0,e,s,i,n,l,h,0),a.bindBuffer(a.PIXEL_UNPACK_BUFFER,null),t._needsUpload=!1,t._mipmapsUploaded=!1,await this.clientWaitAsync(0,16)}setAlphaToCoverage(t){this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(t){if(this.transformFeedbackBuffer!==t){this.transformFeedbackBuffer=t;const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}}setRaster(t){this.raster!==t&&(this.raster=t,t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD))}setStencilTest(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}}setStencilFunc(t,e,s){this.stencilFuncFront===t&&this.stencilRefFront===e&&this.stencilMaskFront===s&&this.stencilFuncBack===t&&this.stencilRefBack===e&&this.stencilMaskBack===s||(this.gl.stencilFunc(this.glComparison[t],e,s),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[t],e,s),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=s}}setStencilFuncBack(t,e,s){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[t],e,s),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=s}}setStencilOperation(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=s),this.stencilWriteMaskFront===i&&this.stencilWriteMaskBack===i||(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(t,e,s,i){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendState(t){const e=this.blendState;if(!e.equals(t)){const s=this.gl,{blend:i,colorOp:n,alphaOp:r,colorSrcFactor:a,colorDstFactor:o,alphaSrcFactor:l,alphaDstFactor:h}=t;if(e.blend!==i&&(i?s.enable(s.BLEND):s.disable(s.BLEND)),e.colorOp!==n||e.alphaOp!==r){const t=this.glBlendEquation;s.blendEquationSeparate(t[n],t[r])}e.colorSrcFactor===a&&e.colorDstFactor===o&&e.alphaSrcFactor===l&&e.alphaDstFactor===h||s.blendFuncSeparate(this.glBlendFunctionColor[a],this.glBlendFunctionColor[o],this.glBlendFunctionAlpha[l],this.glBlendFunctionAlpha[h]),e.allWrite!==t.allWrite&&this.gl.colorMask(t.redWrite,t.greenWrite,t.blueWrite,t.alphaWrite),e.copy(t)}}setBlendColor(t,e,s,i){const n=this.blendColor;t===n.r&&e===n.g&&s===n.b&&i===n.a||(this.gl.blendColor(t,e,s,i),n.set(t,e,s,i))}setStencilState(t,e){t||e?(this.setStencilTest(!0),t===e?(this.setStencilFunc(t.func,t.ref,t.readMask),this.setStencilOperation(t.fail,t.zfail,t.zpass,t.writeMask)):(t??=Un.DEFAULT,this.setStencilFuncFront(t.func,t.ref,t.readMask),this.setStencilOperationFront(t.fail,t.zfail,t.zpass,t.writeMask),e??=Un.DEFAULT,this.setStencilFuncBack(e.func,e.ref,e.readMask),this.setStencilOperationBack(e.fail,e.zfail,e.zpass,e.writeMask))):this.setStencilTest(!1)}setDepthState(t){const e=this.depthState;if(!e.equals(t)){const s=this.gl,i=t.write;e.write!==i&&s.depthMask(i);let{func:n,test:r}=t;!r&&i&&(r=!0,n=7),e.func!==n&&s.depthFunc(this.glComparison[n]),e.test!==r&&(r?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST));const{depthBias:a,depthBiasSlope:o}=t;a||o?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),s.polygonOffset(o,a)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),e.copy(t)}}setCullMode(t){if(this.cullMode!==t){if(0===t)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}}setShader(t,e=!1){t!==this.shader&&(this.shader=t,this.shaderAsyncCompile=e,this.shaderValid=void 0)}activateShader(){const{shader:t}=this,{impl:e}=t;void 0===this.shaderValid&&(t.failed?this.shaderValid=!1:t.ready||(this.shaderAsyncCompile?e.isLinked(this)?e.finalize(this,t)||(t.failed=!0,this.shaderValid=!1):this.shaderValid=!1:e.finalize(this,t)||(t.failed=!0,this.shaderValid=!1))),void 0===this.shaderValid&&(this.gl.useProgram(e.glProgram),this.shaderValid=!0)}clearVertexArrayObjectCache(){const t=this.gl;this._vaoMap.forEach(((e,s,i)=>{t.deleteVertexArray(e)})),this._vaoMap.clear()}set fullscreen(t){if(t){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}}class go{unlock(t){}}class vo{destroy(t){}init(t,e){}loseContext(){}resolve(t,e,s,i){}}class bo{destroy(t){}loseContext(){}restoreContext(t,e){}}class yo{destroy(t){}propertyChanged(t){}loseContext(){}}class So{destroy(t){}unlock(t){}}class xo extends zn{constructor(t,e={}){super(t,e),e=this.initOptions,this.isNull=!0,this._deviceType=Gi,this.samples=1,this.backBuffer=new Hn({name:"Framebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.initDeviceCaps()}destroy(){super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=!1,this.supportsAreaLights=!0,this.supportsGpuParticles=!1,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!1}postInit(){super.postInit()}frameStart(){super.frameStart()}frameEnd(){super.frameEnd()}updateBegin(){}updateEnd(){}readPixels(t,e,s,i,n){}createVertexBufferImpl(t,e){return new So(t,e)}createIndexBufferImpl(t){return new go(t)}createShaderImpl(t){return new bo(t)}createTextureImpl(t){return new yo(t)}createRenderTargetImpl(t){return new vo(t)}draw(t,e,s,i,n=!0,r=!0){}setShader(t,e=!1){}setBlendState(t){}setDepthState(t){}setStencilState(t,e){}setBlendColor(t,e,s,i){}setCullMode(t){}setAlphaToCoverage(t){}initializeContextCaches(){super.initializeContextCaches()}clear(t){}setViewport(t,e,s,i){}setScissor(t,e,s,i){}copyRenderTarget(t,e,s,i){return!0}}let wo=0;class To{constructor(t,e,s,i=0,n,r){this.device=t,this.format=e,this.numIndices=s,this.usage=i,this.id=wo++,this.impl=t.createIndexBufferImpl(this,r);const a=Qi[e];this.bytesPerIndex=a,this.numBytes=this.numIndices*a,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(t._vram,this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this.storage.byteLength))}adjustVramSizeTracking(t,e){t.ib+=e}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}_lockTypedArray(){const t=this.lock();return 2===this.format?new Uint32Array(t):1===this.format?new Uint16Array(t):new Uint8Array(t)}writeData(t,e){const s=this._lockTypedArray();if(t.length>e)if(ArrayBuffer.isView(t))t=t.subarray(0,e),s.set(t);else for(let i=0;i<e;i++)s[i]=t[i];else s.set(t);this.unlock()}readData(t){const e=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(t))t.set(e);else{t.length=0;for(let i=0;i<s;i++)t[i]=e[i]}return s}}class Eo{constructor(){this.clearValue=new Ze(0,0,0,1),this.clearValueLinear=new Ze(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.genMipmaps=!1}}class Co{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.resolveDepth=!1,this.storeStencil=!1}}class Ao{get colorOps(){return this.colorArrayOps[0]}constructor(t){this._enabled=!0,this._skipStart=!1,this._skipEnd=!1,this.executeEnabled=!0,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=t}set name(t){this._name=t}get name(){return this._name||(this._name=this.constructor.name),this._name}set scaleX(t){this._options.scaleX=t}get scaleX(){return this._options.scaleX}set scaleY(t){this._options.scaleY=t}get scaleY(){return this._options.scaleY}set options(t){this._options=t,t&&(this.scaleX=this.scaleX??1,this.scaleY=this.scaleY??1)}get options(){return this._options}init(t=null,e){this.options=e,this.renderTarget=t,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit()}allocateAttachments(){const t=this.renderTarget;this.depthStencilOps=new Co,t?.depthBuffer&&(this.depthStencilOps.storeDepth=!0);const e=t?t._colorBuffers?.length??0:1;this.colorArrayOps.length=0;for(let t=0;t<e;t++){const e=new Eo;this.colorArrayOps[t]=e,1===this.samples&&(e.store=!0,e.resolve=!1);const s=this.renderTarget?._colorBuffers?.[t];if(this.renderTarget?.mipmaps&&s?.mipmaps){const t=Ws(s._format);e.genMipmaps=!t}}}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){const t=this._options.resizeSource??this.device.backBuffer,e=Math.floor(t.width*this.scaleX),s=Math.floor(t.height*this.scaleY);this.renderTarget.resize(e,s)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(t){this._enabled!==t&&(this._enabled=t,t?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(t){const e=this.colorArrayOps.length;for(let s=0;s<e;s++){const e=this.colorArrayOps[s];t&&(e.clearValue.copy(t),e.clearValueLinear.linear(t)),e.clear=!!t}}setClearDepth(t){t&&(this.depthStencilOps.clearDepthValue=t),this.depthStencilOps.clearDepth=void 0!==t}setClearStencil(t){t&&(this.depthStencilOps.clearStencilValue=t),this.depthStencilOps.clearStencil=void 0!==t}render(){if(this.enabled){const t=this.device,e=void 0!==this.renderTarget;this.before(),this.executeEnabled&&(e&&!this._skipStart&&t.startRenderPass(this),this.execute(),e&&!this._skipEnd&&t.endRenderPass(this)),this.after(),t.renderPassIndex++}}}function Do(t){this.array[this.index]=t}function Po(t,e){this.array[this.index]=t,this.array[this.index+1]=e}function Lo(t,e,s){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s}function Io(t,e,s,i){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s,this.array[this.index+3]=i}function Ro(t,e,s){this.array[t]=e[s]}function Mo(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1]}function ko(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2]}function Oo(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2],this.array[t+3]=e[s+3]}function Fo(t,e,s){e[s]=this.array[t]}function No(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1]}function Bo(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2]}function Uo(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2],e[s+3]=this.array[t+3]}class zo{constructor(t,e,s){switch(this.index=0,this.numComponents=e.numComponents,s.interleaved?this.array=new qi[e.dataType](t,e.offset):this.array=new qi[e.dataType](t,e.offset,s.vertexCount*e.numComponents),this.stride=e.stride/this.array.constructor.BYTES_PER_ELEMENT,e.numComponents){case 1:this.set=Do,this.getToArray=Fo,this.setFromArray=Ro;break;case 2:this.set=Po,this.getToArray=No,this.setFromArray=Mo;break;case 3:this.set=Lo,this.getToArray=Bo,this.setFromArray=ko;break;case 4:this.set=Io,this.getToArray=Uo,this.setFromArray=Oo}}get(t){return this.array[this.index+t]}set(t,e,s,i){}getToArray(t,e,s){}setFromArray(t,e,s){}}class Vo{constructor(t){this.vertexBuffer=t,this.vertexFormatSize=t.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const e=this.vertexBuffer.getFormat();for(let t=0;t<e.elements.length;t++){const s=e.elements[t];this.accessors[t]=new zo(this.buffer,s,e),this.element[s.name]=this.accessors[t]}}next(t=1){let e=0;const s=this.accessors,i=this.accessors.length;for(;e<i;){const i=s[e++];i.index+=t*i.stride}}end(){this.vertexBuffer.unlock()}writeData(t,e,s){const i=this.element[t];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const t=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let r=0;r<s;r++)i.setFromArray(n,e,r*t),n+=i.stride}else if(e.length>s*t){const n=s*t;if(ArrayBuffer.isView(e))e=e.subarray(0,n),i.array.set(e);else for(let t=0;t<n;t++)i.array[t]=e[t]}else i.array.set(e)}}readData(t,e){const s=this.element[t];let i=0;if(s){let t;i=this.vertexBuffer.numVertices;const n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(e)&&(e.length=0),s.index=0;let r=0;for(t=0;t<i;t++)s.getToArray(r,e,t*n),r+=s.stride}else if(ArrayBuffer.isView(e))e.set(s.array);else{e.length=0;const r=i*n;for(t=0;t<r;t++)e[t]=s.array[t]}}return i}}const Ho=new class{constructor(t,e){this.key=null,this.element=null,this.event=null,e&&(this.key=e.keyCode,this.element=e.target,this.event=e)}};function Go(t){return Ho.key=t.keyCode,Ho.element=t.target,Ho.event=t,Ho}function Wo(t){return"string"==typeof t?t.toUpperCase().charCodeAt(0):t}const jo={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class Xo extends Ve{static{this.EVENT_KEYDOWN="keydown"}static{this.EVENT_KEYUP="keyup"}constructor(t,e={}){super(),this._element=null,this._keymap={},this._lastmap={},this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),t&&this.attach(t),this.preventDefault=e.preventDefault||!1,this.stopPropagation=e.stopPropagation||!1}attach(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(t){t=Wo(t);const e=jo[t.toString()];if(e)return e;let s=t.toString(16).toUpperCase();const i=s.length;for(let t=0;t<4-i;t++)s=`0${s}`;return`U+${s}`}_handleKeyDown(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);this._keymap[s]=!0,this.fire("keydown",Go(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleKeyUp(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);delete this._keymap[s],this.fire("keyup",Go(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleKeyPress(t){this.fire("keypress",Go(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const t in this._lastmap)delete this._lastmap[t];for(const t in this._keymap)this._keymap.hasOwnProperty(t)&&(this._lastmap[t]=this._keymap[t])}isPressed(t){const e=Wo(t),s=this.toKeyIdentifier(e);return!!this._keymap[s]}wasPressed(t){const e=Wo(t),s=this.toKeyIdentifier(e);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(t){const e=Wo(t),s=this.toKeyIdentifier(e);return!this._keymap[s]&&!!this._lastmap[s]}}function $o(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}class qo{constructor(t,e){this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=-1,this.wheelDelta=0,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.metaKey=!1;let s={x:0,y:0};if(e){if(e instanceof qo)throw Error("Expected MouseEvent");s=t._getTargetCoords(e)}else e={};if(s)this.x=s.x,this.y=s.y;else{if(!$o())return;this.x=0,this.y=0}"wheel"===e.type&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1)),$o()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),"mousedown"!==e.type&&"mouseup"!==e.type||(this.button=e.button),this.buttons=t._buttons.slice(0),this.element=e.target,this.ctrlKey=e.ctrlKey??!1,this.altKey=e.altKey??!1,this.shiftKey=e.shiftKey??!1,this.metaKey=e.metaKey??!1,this.event=e}}class Ko extends Ve{static{this.EVENT_MOUSEMOVE="mousemove"}static{this.EVENT_MOUSEDOWN="mousedown"}static{this.EVENT_MOUSEUP="mouseup"}static{this.EVENT_MOUSEWHEEL="mousewheel"}constructor(t){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._target=null,this._attached=!1,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this.attach(t)}static isPointerLocked(){return $o()}attach(t){if(this._target=t,this._attached)return;this._attached=!0;const e=!!Ue.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const t=!!Ue.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(t,e){if(!document.body.requestPointerLock)return void(e&&e());const s=()=>{t(),document.removeEventListener("pointerlockchange",s)},i=()=>{e(),document.removeEventListener("pointerlockerror",i)};t&&document.addEventListener("pointerlockchange",s,!1),e&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(t){if(!document.exitPointerLock)return;const e=()=>{t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(t){return this._buttons[t]}wasPressed(t){return this._buttons[t]&&!this._lastbuttons[t]}wasReleased(t){return!this._buttons[t]&&this._lastbuttons[t]}_handleUp(t){this._buttons[t.button]=!1;const e=new qo(this,t);e.event&&this.fire("mouseup",e)}_handleDown(t){this._buttons[t.button]=!0;const e=new qo(this,t);e.event&&this.fire("mousedown",e)}_handleMove(t){const e=new qo(this,t);e.event&&(this.fire("mousemove",e),this._lastX=e.x,this._lastY=e.y)}_handleWheel(t){const e=new qo(this,t);e.event&&this.fire("mousewheel",e)}_getTargetCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);return t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?null:{x:t.clientX-s,y:t.clientY-i}}}class Yo{constructor(t){const e=function(t){let e=0,s=0,i=t.target;for(;!(i instanceof HTMLElement)&&i;)i=i.parentNode;for(;i;)e+=i.offsetLeft-i.scrollLeft,s+=i.offsetTop-i.scrollTop,i=i.offsetParent;return{x:t.pageX-e,y:t.pageY-s}}(t);this.id=t.identifier,this.x=e.x,this.y=e.y,this.target=t.target,this.touch=t}}class Qo{constructor(t,e){this.touches=[],this.changedTouches=[],this.element=e.target,this.event=e,this.touches=Array.from(e.touches).map((t=>new Yo(t))),this.changedTouches=Array.from(e.changedTouches).map((t=>new Yo(t)))}getTouchById(t,e){return e.find((e=>e.id===t))||null}}class Zo extends Ve{static{this.EVENT_TOUCHSTART="touchstart"}static{this.EVENT_TOUCHEND="touchend"}static{this.EVENT_TOUCHMOVE="touchmove"}static{this.EVENT_TOUCHCANCEL="touchcancel"}constructor(t){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(t)}attach(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(t){this.fire("touchstart",new Qo(this,t))}_handleTouchEnd(t){this.fire("touchend",new Qo(this,t))}_handleTouchMove(t){t.preventDefault(),this.fire("touchmove",new Qo(this,t))}_handleTouchCancel(t){this.fire("touchcancel",new Qo(this,t))}}class Jo{static{this.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"}}static{this.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"}}static{this.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"]}static{this.retryDelay=100}get(t,e,s){"function"==typeof e&&(s=e,e={});const i=this.request("GET",t,e,s),{progress:n}=e;if(n){const t=t=>{t.lengthComputable&&n.fire("progress",t.loaded,t.total)},e=s=>{t(s),i.removeEventListener("loadstart",t),i.removeEventListener("progress",t),i.removeEventListener("loadend",e)};i.addEventListener("loadstart",t),i.addEventListener("progress",t),i.addEventListener("loadend",e)}return i}post(t,e,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=e,this.request("POST",t,s,i)}put(t,e,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=e,this.request("PUT",t,s,i)}del(t,e,s){return"function"==typeof e&&(s=e,e={}),this.request("DELETE",t,e,s)}request(t,e,s,i){let n,r,a,o=!1;if("function"==typeof s&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)a=s.postdata;else if(s.postdata instanceof FormData)a=s.postdata;else if(s.postdata instanceof Object){let t=s.headers["Content-Type"];switch(void 0===t&&(s.headers["Content-Type"]=Jo.ContentType.FORM_URLENCODED,t=s.headers["Content-Type"]),t){case Jo.ContentType.FORM_URLENCODED:{a="";let t=!0;for(const e in s.postdata)if(s.postdata.hasOwnProperty(e)){t?t=!1:a+="&";a+=`${encodeURIComponent(e)}=${encodeURIComponent(s.postdata[e])}`}break}default:case Jo.ContentType.JSON:null==t&&(s.headers["Content-Type"]=Jo.ContentType.JSON),a=JSON.stringify(s.postdata)}}else a=s.postdata;if(!1===s.cache){const t=$e();n=new Ke(e),n.query?n.query=`${n.query}&ts=${t}`:n.query=`ts=${t}`,e=n.toString()}s.query&&(n=new Ke(e),r=Re(n.getQuery(),s.query),n.setQuery(r),e=n.toString());const l=new XMLHttpRequest;l.open(t,e,s.async),l.withCredentials=void 0!==s.withCredentials&&s.withCredentials,l.responseType=s.responseType||this._guessResponseType(e);for(const t in s.headers)s.headers.hasOwnProperty(t)&&l.setRequestHeader(t,s.headers[t]);l.onreadystatechange=()=>{this._onReadyStateChange(t,e,s,l)},l.onerror=()=>{this._onError(t,e,s,l),o=!0};try{l.send(a)}catch(t){o||s.error(l.status,l,t)}return l}_guessResponseType(t){const e=new Ke(t),s=ke.getExtension(e.path).toLowerCase();return Jo.binaryExtensions.indexOf(s)>=0?Jo.ResponseType.ARRAY_BUFFER:".json"===s?Jo.ResponseType.JSON:".xml"===s?Jo.ResponseType.DOCUMENT:Jo.ResponseType.TEXT}_isBinaryContentType(t){return[Jo.ContentType.BASIS,Jo.ContentType.BIN,Jo.ContentType.DDS,Jo.ContentType.GLB,Jo.ContentType.MP3,Jo.ContentType.MP4,Jo.ContentType.OGG,Jo.ContentType.OPUS,Jo.ContentType.WAV].indexOf(t)>=0}_isBinaryResponseType(t){return t===Jo.ResponseType.ARRAY_BUFFER||t===Jo.ResponseType.BLOB||t===Jo.ResponseType.JSON}_onReadyStateChange(t,e,s,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(t,e,s,i):this._onError(t,e,s,i);break;case 200:case 201:case 206:case 304:this._onSuccess(t,e,s,i);break;default:this._onError(t,e,s,i)}}_onSuccess(t,e,s,i){let n,r;const a=i.getResponseHeader("Content-Type");if(a){r=a.split(";")[0].trim()}try{n=this._isBinaryContentType(r)||this._isBinaryResponseType(i.responseType)?i.response:r===Jo.ContentType.JSON||e.split("?")[0].endsWith(".json")?JSON.parse(i.responseText):i.responseType===Jo.ResponseType.DOCUMENT||r===Jo.ContentType.XML?i.responseXML:i.responseText,s.callback(null,n)}catch(t){s.callback(t)}}_onError(t,e,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=Qe.clamp(Math.pow(2,s.retries)*Jo.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${t}: ${e} - Error ${i.status}. Retrying in ${n} ms`),setTimeout((()=>{s.retrying=!1,this.request(t,e,s,s.callback)}),n)}else s.callback(0===i.status?"Network error":i.status,null)}}const tl=new Jo,el=0,sl=1,il=2,nl=3,rl=4,al=5,ol=6,ll=7,hl=8,cl=9,dl=10,ul={[el]:"SUBTRACTIVE",[sl]:"ADDITIVE",[il]:"NORMAL",[nl]:"NONE",[rl]:"PREMULTIPLIED",[al]:"MULTIPLICATIVE",[ol]:"ADDITIVEALPHA",[ll]:"MULTIPLICATIVE2X",[hl]:"SCREEN",[cl]:"MIN",[dl]:"MAX"},fl="none",pl=0,ml=2,_l={[pl]:"NONE",[ml]:"SCHLICK"},gl=0,vl=1,bl=2,yl={[gl]:"DIRECTIONAL",[vl]:"OMNI",[bl]:"SPOT"},Sl=100,xl=0,wl=1,Tl=2,El=3,Cl={[xl]:"PUNCTUAL",[wl]:"RECT",[Tl]:"DISK",[El]:"SPHERE"},Al=0,Dl=1,Pl={[Al]:"LINEAR",[Dl]:"INVERSESQUARED"},Ll=new Map([[5,{name:"PCF1_32F",kind:"PCF1",format:Rs,pcf:!0}],[0,{name:"PCF3_32F",kind:"PCF3",format:Rs,pcf:!0}],[4,{name:"PCF5_32F",kind:"PCF5",format:Rs,pcf:!0}],[7,{name:"PCF1_16F",kind:"PCF1",format:zs,pcf:!0}],[8,{name:"PCF3_16F",kind:"PCF3",format:zs,pcf:!0}],[9,{name:"PCF5_16F",kind:"PCF5",format:zs,pcf:!0}],[2,{name:"VSM_16F",kind:"VSM",format:Ps,vsm:!0}],[3,{name:"VSM_32F",kind:"VSM",format:Ls,vsm:!0}],[6,{name:"PCSS_32F",kind:"PCSS",format:Is,pcss:!0}]]),Il=0,Rl=1,Ml={[Il]:"NONE",[Rl]:"BOX"},kl=0,Ol=1,Fl={[kl]:"NONE",[Ol]:"SRGB"},Nl=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],Bl=0,Ul=1,zl=2,Vl={[Bl]:"NONE",[Ul]:"AO",[zl]:"GLOSSDEPENDENT"},Hl="none",Gl="envAtlas",Wl="envAtlasHQ",jl="cubeMap",Xl="sphereMap",$l={[Hl]:"NONE",[Gl]:"ENVATLAS",[Wl]:"ENVATLASHQ",[jl]:"CUBEMAP",[Xl]:"SPHEREMAP"},ql="ambientSH",Kl="envAtlas",Yl="constant",Ql={[ql]:"AMBIENTSH",[Kl]:"ENVALATLAS",[Yl]:"CONSTANT"},Zl=1024,Jl=2048,th=8192,eh=16384,sh=0,ih=1,nh=2,rh={[sh]:"SIMPLE",[ih]:"SLICED",[nh]:"TILED"},ah="infinite",oh="dome",lh="none",hh="bayer8",ch="bluenoise",dh="ignnoise",uh={[lh]:"NONE",[hh]:"BAYER8",[ch]:"BLUENOISE",[dh]:"IGNNOISE"},fh="prerender",ph="postrender",mh="precull",_h="postcull";class gh{constructor(t,e,s){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[0]=t,this.bindGroupFormats[0]=e,this.vertexFormat=s}hasUniform(t){for(let e=0;e<this.uniformFormats.length;e++){const s=this.uniformFormats[e];if(s?.get(t))return!0}return!1}hasTexture(t){for(let e=0;e<this.bindGroupFormats.length;e++){const s=this.bindGroupFormats[e];if(s?.getTexture(t))return!0}return!1}getVertexElement(t){return this.vertexFormat?.elements.find((e=>e.name===t))}generateKey(t){let e=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);return t.isWebGPU&&(e+=this.vertexFormat?.shaderProcessingHashString),e}}const vh=new ln;function bh(t){return vh.get(t)}class yh{static definesHash(t){const e=Array.from(t).sort(((t,e)=>t[0]>e[0]?1:-1));return Rn(JSON.stringify(e))}}const Sh=new ln;class xh{constructor(t,e,s={}){this.defines=new Map,this.name=t,this.index=e,Object.assign(this,s),this.buildShaderDefines()}buildShaderDefines(){let t;this.isShadow?t="SHADOW":this.isForward?t="FORWARD":3===this.index&&(t="PICK"),this.defines.set(`${t}_PASS`,""),this.defines.set(`${this.name.toUpperCase()}_PASS`,"")}}class wh{constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;const t=(t,e,s)=>{this.allocate(t,s)};t("forward",0,{isForward:!0}),t("prepass"),t("shadow"),t("pick")}static get(t){return Sh.get(t,(()=>new wh))}allocate(t,e){let s=this.passesNamed.get(t);return void 0===s&&(s=new xh(t,this.nextIndex,e),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(t){return this.passesIndexed[t]}getByName(t){return this.passesNamed.get(t)}}class Th extends Map{set(t,e){return this.has(t)&&this.get(t)===e||this.markDirty(),super.set(t,e)}add(t){for(const[e,s]of Object.entries(t))this.set(e,s);return this}delete(t){const e=this.has(t),s=super.delete(t);return e&&s&&this.markDirty(),s}clear(){this.size>0&&this.markDirty(),super.clear()}markDirty(){this._dirty=!0,this._keyDirty=!0}isDirty(){return this._dirty}resetDirty(){this._dirty=!1}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=Array.from(this.entries()).sort((([t],[e])=>t<e?-1:t>e?1:0)).map((([t,e])=>`${t}=${Rn(e)}`)).join(",")),this._key}copy(t){this.clear();for(const[e,s]of t)this.set(e,s);return this}constructor(...t){super(...t),this._keyDirty=!1,this._key=""}}const Eh=new ln;class Ch{static get(t,e=Ai){const s=Eh.get(t,(()=>new Ch));return e===Ai?s.glsl:s.wgsl}get useWGSL(){return 0===this.glsl.size||this.wgsl.size>0}get key(){return`GLSL:${this.glsl.key}|WGSL:${this.wgsl.key}|API:${this.version}`}isDirty(){return this.glsl.isDirty()||this.wgsl.isDirty()}resetDirty(){this.glsl.resetDirty(),this.wgsl.resetDirty()}copy(t){return this.version=t.version,this.glsl.copy(t.glsl),this.wgsl.copy(t.wgsl),this}constructor(){this.glsl=new Th,this.wgsl=new Th,this.version=""}}class Ah{static merge(...t){const e=new Map(t[0]??[]);for(let s=1;s<t.length;s++){const i=t[s];if(i)for(const[t,s]of i)e.set(t,s)}return e}}class Dh extends yh{constructor(t,e){super(),this.key=t,this.shaderDefinition=e}generateKey(t){return this.key}createShaderDefinition(t,e){return this.shaderDefinition}}class Ph{static createShader(t,e){const s=bh(t);let i=s.getCachedShader(e.uniqueName);if(!i){const n=t.isWebGPU&&(!!e.vertexWGSL||!!e.vertexChunk)&&(!!e.fragmentWGSL||!!e.fragmentChunk),r=Ch.get(t,n?Di:Ai),a=e.vertexChunk?r.get(e.vertexChunk):n?e.vertexWGSL:e.vertexGLSL,o=e.fragmentChunk?r.get(e.fragmentChunk):n?e.fragmentWGSL:e.fragmentGLSL,l=Ah.merge(r,e.fragmentIncludes),h=Ah.merge(r,e.vertexIncludes);i=new Ra(t,La.createDefinition(t,{name:e.uniqueName,shaderLanguage:n?Di:Ai,attributes:e.attributes,vertexCode:a,fragmentCode:o,useTransformFeedback:e.useTransformFeedback,vertexIncludes:h,vertexDefines:e.vertexDefines,fragmentIncludes:l,fragmentDefines:e.fragmentDefines,fragmentOutputTypes:e.fragmentOutputTypes})),s.setCachedShader(e.uniqueName,i)}return i}static getCoreDefines(t,e){const s=new Map(t.defines);e.cameraShaderParams.defines.forEach(((t,e)=>s.set(e,t)));return wh.get(e.device).getByIndex(e.pass).defines.forEach(((t,e)=>s.set(e,t))),s}static processShader(t,e){const s=t.definition,i=`${s.name??"shader"}-id-${t.id}`,n=new Dh(i,s),r="shader",a=bh(t.device);a.register(r,n);const o=a.getProgram(r,{},e);return a.unregister(r),o}static addScreenDepthChunkDefines(t,e,s){e.sceneDepthMapLinear&&s.set("SCENE_DEPTHMAP_LINEAR",""),t.textureFloatRenderable&&s.set("SCENE_DEPTHMAP_FLOAT","")}}const Lh={type:5,base:0,baseVertex:0,count:4,indexed:!1},Ih=new ls,Rh=new ls,Mh=new gn;class kh{constructor(t){const e=t.device;if(this.shader=t,e.supportsUniformBuffers){const s=new gh;this.shader=Ph.processShader(t,s);const i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new Na(e,i,!1));const n=this.shader.meshBindGroupFormat;this.bindGroup=new vn(e,n)}}destroy(){this.uniformBuffer?.destroy(),this.uniformBuffer=null,this.bindGroup?.destroy(),this.bindGroup=null}render(t,e){const s=this.shader.device;t&&(Ih.set(s.vx,s.vy,s.vw,s.vh),Rh.set(s.sx,s.sy,s.sw,s.sh),e=e??t,s.setViewport(t.x,t.y,t.z,t.w),s.setScissor(e.x,e.y,e.z,e.w)),s.setVertexBuffer(s.quadVertexBuffer,0);const i=this.shader;if(s.setShader(i),s.supportsUniformBuffers){s.setBindGroup(0,s.emptyBindGroup);const t=this.bindGroup;t.update(),s.setBindGroup(1,t);const e=this.uniformBuffer;e?(e.update(Mh),s.setBindGroup(2,Mh.bindGroup,Mh.offsets)):s.setBindGroup(2,s.emptyBindGroup)}s.draw(Lh),t&&(s.setViewport(Ih.x,Ih.y,Ih.z,Ih.w),s.setScissor(Rh.x,Rh.y,Rh.z,Rh.w))}}class Oh extends Ao{constructor(t,e,s,i){super(t),this.quad=e,this.rect=s,this.scissorRect=i}execute(){const{device:t}=this;t.setCullMode(0),t.setDepthState(Tn.NODEPTH),t.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}}const Fh=new ls;function Nh(t,e,s,i,n){const r=new kh(s);i||((i=Fh).x=0,i.y=0,i.z=e?e.width:t.width,i.w=e?e.height:t.height);const a=new Oh(t,r,i,n);a.init(e),a.colorOps.clear=!1,a.depthStencilOps.clearDepth=!1,t.isWebGPU&&null===e&&t.samples>1&&(a.colorOps.store=!0),a.render(),r.destroy()}class Bh{constructor(t,e,s,i,n=[0]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=t,this.name=e,this.dynamic=s,this.maxAabbSize=i,this.layers=n}static{this.MODEL="model"}static{this.ELEMENT="element"}static{this.SPRITE="sprite"}static{this.RENDER="render"}}const Uh=new ps;class zh{constructor(t){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,t&&this.initSkin(t)}set rootBone(t){this._rootBone=t}get rootBone(){return this._rootBone}init(t,e){const s=3*e;let i=Math.ceil(Math.sqrt(s));i=Qe.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new dn(t,{width:i,height:n,format:Ls,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock()}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(t,e){this.rootBone=t;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const r=s.boneNames[n];let a=t.findByName(r);a||(a=e),i.push(a)}this.bones=i}initSkin(t){this.skin=t,this.bones=[];const e=t.inverseBindPose.length;this.init(t.device,e),this.matrices=[];for(let t=0;t<e;t++)this.matrices[t]=new ps}uploadBones(t){this.boneTexture.upload()}_updateMatrices(t,e){if(this._skinUpdateIndex!==e){this._skinUpdateIndex=e,Uh.copy(t.getWorldTransform()).invert();for(let t=this.bones.length-1;t>=0;t--)this.matrices[t].mulAffine2(Uh,this.bones[t].getWorldTransform()),this.matrices[t].mulAffine2(this.matrices[t],this.skin.inverseBindPose[t])}}updateMatrices(t,e){this._updateBeforeCull&&this._updateMatrices(t,e)}updateMatrixPalette(t,e){this._updateMatrices(t,e);const s=this.matrixPalette,i=this.bones.length;for(let t=0;t<i;t++){const e=this.matrices[t].data,i=12*t;s[i]=e[0],s[i+1]=e[4],s[i+2]=e[8],s[i+3]=e[12],s[i+4]=e[1],s[i+5]=e[5],s[i+6]=e[9],s[i+7]=e[13],s[i+8]=e[2],s[i+9]=e[6],s[i+10]=e[10],s[i+11]=e[14]}this.uploadBones(this.skin.device)}}let Vh=0;class Hh{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(t,e){this.vertexCount||(this.vertexCount=t)}static{this.DEFAULT_COMPONENTS_POSITION=3}static{this.DEFAULT_COMPONENTS_NORMAL=3}static{this.DEFAULT_COMPONENTS_UV=2}static{this.DEFAULT_COMPONENTS_COLORS=4}}class Gh{constructor(t,e,s,i,n){this.data=t,this.componentCount=e,this.dataType=s,this.dataTypeNormalize=i,this.asInt=n}}class Wh extends fr{constructor(t,e){super(),this.indexBuffer=[null],this.vertexBuffer=null,this.primitive=[{type:0,base:0,baseVertex:0,count:0}],this.skin=null,this.boneAabb=null,this._aabbVer=0,this._aabb=new Ss,this._geometryData=null,this._morph=null,this._storageIndex=!1,this._storageVertex=!1,this.id=Vh++,this.device=t,this._storageIndex=e?.storageIndex||!1,this._storageVertex=e?.storageVertex||!1}static fromGeometry(t,e,s={}){const i=new Wh(t,s),{positions:n,normals:r,tangents:a,colors:o,uvs:l,uvs1:h,blendIndices:c,blendWeights:d,indices:u}=e;return n&&i.setPositions(n),r&&i.setNormals(r),a&&i.setVertexStream(Ks,a,4),o&&i.setColors32(o),l&&i.setUvs(0,l),h&&i.setUvs(1,h),c&&i.setVertexStream(Qs,c,4,c.length/4,1),d&&i.setVertexStream(Ys,d,4),u&&i.setIndices(u),i.update(),i}set morph(t){t!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=t,t&&t.incRefCount())}get morph(){return this._morph}set aabb(t){this._aabb=t,this._aabbVer++}get aabb(){return this._aabb}destroy(){const t=this.morph;t&&(this.morph=null,t.refCount<1&&t.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(t){this.indexBuffer[t]&&(this.indexBuffer[t].destroy(),this.indexBuffer[t]=null)}_initBoneAabbs(t){let e,s,i,n,r;this.boneAabb=[],this.boneUsed=[];const a=[],o=[],l=this.boneUsed,h=this.skin.boneNames.length;let c,d,u;for(let t=0;t<h;t++)a[t]=new rs(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o[t]=new rs(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const f=new Vo(this.vertexBuffer),p=f.element[$s],m=f.element[Ys],_=f.element[Qs],g=this.vertexBuffer.numVertices;for(let h=0;h<g;h++){for(let f=0;f<4;f++){if(m.array[m.index+f]>0){const m=_.array[_.index+f];if(l[m]=!0,e=p.array[p.index],s=p.array[p.index+1],i=p.array[p.index+2],n=o[m],r=a[m],r.x>e&&(r.x=e),r.y>s&&(r.y=s),r.z>i&&(r.z=i),n.x<e&&(n.x=e),n.y<s&&(n.y=s),n.z<i&&(n.z=i),t){let a=c=e,o=d=s,l=u=i;for(let e=0;e<t.length;e++){const s=t[e],i=s.deltaPositions[3*h],n=s.deltaPositions[3*h+1],r=s.deltaPositions[3*h+2];i<0?a+=i:c+=i,n<0?o+=n:d+=n,r<0?l+=r:u+=r}r.x>a&&(r.x=a),r.y>o&&(r.y=o),r.z>l&&(r.z=l),n.x<c&&(n.x=c),n.y<d&&(n.y=d),n.z<u&&(n.z=u)}}}f.next()}const v=this.vertexBuffer.getFormat().elements.find((t=>t.name===$s));if(v&&v.normalize){const t=(()=>{switch(v.dataType){case 0:return t=>Math.max(t/127,-1);case 1:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})();for(let e=0;e<h;e++)if(l[e]){const s=a[e],i=o[e];s.set(t(s.x),t(s.y),t(s.z)),i.set(t(i.x),t(i.y),t(i.z))}}for(let t=0;t<h;t++){const e=new Ss;e.setMinMax(a[t],o[t]),this.boneAabb.push(e)}}_initGeometryData(){this._geometryData||(this._geometryData=new Hh,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(t,e,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=t?0:1,this._geometryData.indicesUsage=e?0:1}setVertexStream(t,e,s,i,n=6,r=!1,a=!1){this._initGeometryData();const o=i||e.length/s;this._geometryData._changeVertexCount(o,t),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[t]=new Gh(e,s,n,r,a)}getVertexStream(t,e){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[t];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(e)?e.set(n.data):(e.length=0,e.push(n.data)))}if(!i&&this.vertexBuffer){s=new Vo(this.vertexBuffer).readData(t,e)}return s}setPositions(t,e=Hh.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream($s,t,e,s,6,!1)}setNormals(t,e=Hh.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(qs,t,e,s,6,!1)}setUvs(t,e,s=Hh.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(Js+t,e,s,i,6,!1)}setColors(t,e=Hh.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(Zs,t,e,s,6,!1)}setColors32(t,e){this.setVertexStream(Zs,t,Hh.DEFAULT_COMPONENTS_COLORS,e,1,!0)}setIndices(t,e){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=t,this._geometryData.indexCount=e||t.length}getPositions(t){return this.getVertexStream($s,t)}getNormals(t){return this.getVertexStream(qs,t)}getUvs(t,e){return this.getVertexStream(Js+t,e)}getColors(t){return this.getVertexStream(Zs,t)}getIndices(t){let e=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;if(e=this._geometryData.indexCount,ArrayBuffer.isView(t))t.set(s);else{t.length=0;for(let e=0,i=s.length;e<i;e++)t.push(s[e])}}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){e=this.indexBuffer[0].readData(t)}return e}update(t=4,e=!0){if(this._geometryData){if(e){const t=this._geometryData.vertexStreamDictionary[$s];t&&3===t.componentCount&&(this._aabb.compute(t.data,this._geometryData.vertexCount),this._aabbVer++)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=t,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(t){const e=[];for(const t in this._geometryData.vertexStreamDictionary){const s=this._geometryData.vertexStreamDictionary[t];e.push({semantic:t,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize,asInt:s.asInt})}return new Nn(this.device,e,t)}_updateVertexBuffer(){if(!this.vertexBuffer){const t=this._geometryData.maxVertices,e=this._buildVertexFormat(t);this.vertexBuffer=new In(this.device,e,t,{usage:this._geometryData.verticesUsage,storage:this._storageVertex})}const t=new Vo(this.vertexBuffer),e=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];t.writeData(s,i.data,e),delete this._geometryData.vertexStreamDictionary[s]}t.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const t=this._geometryData.maxVertices,e=t>65535||0===t?2:1,s=this._storageIndex?{storage:!0}:void 0;this.indexBuffer[0]=new To(this.device,e,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,s)}const t=this._geometryData.indices;if(t){this.indexBuffer[0].writeData(t,this._geometryData.indexCount),this._geometryData.indices=null}}prepareRenderState(t){1===t?this.generateWireframe():2===t&&(this.primitive[2]={type:0,base:0,baseVertex:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);const t=this.vertexBuffer.numVertices,e=[];let s;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const i=[[0,1],[1,2],[2,0]],n=this.primitive[0].base,r=this.primitive[0].count,a=this.primitive[0].baseVertex||0,o=this.indexBuffer[0],l=new Yi[o.format](o.storage),h=new Set;for(let s=n;s<n+r;s+=3)for(let n=0;n<3;n++){const r=l[s+i[n][0]]+a,o=l[s+i[n][1]]+a,c=r>o?o*t+r:r*t+o;h.has(c)||(h.add(c),e.push(r,o))}s=o.format}else{for(let s=0;s<t;s+=3)e.push(s,s+1,s+1,s+2,s+2,s);s=e.length>65535?2:1}const i=new To(this.vertexBuffer.device,s,e.length);new Yi[i.format](i.storage).set(e),i.unlock(),this.primitive[1]={type:1,base:0,baseVertex:0,count:e.length,indexed:!0},this.indexBuffer[1]=i}}const jh=new ln;function Xh(t){return jh.get(t)}class $h{destroy(){this.cache.forEach(((t,e)=>{e.destroy()})),this.cache.clear()}incRef(t){const e=(this.cache.get(t)||0)+1;this.cache.set(t,e)}decRef(t){if(t){let e=this.cache.get(t);e&&(e--,0===e?(this.cache.delete(t),t.destroy()):this.cache.set(t,e))}}constructor(){this.cache=new Map}}class qh{static{this.cache=new $h}static incRef(t){this.cache.incRef(t)}static decRef(t){this.cache.decRef(t)}static destroy(){this.cache.destroy()}}let Kh=0;const Yh=new Ss,Qh=new Ss,Zh=new Ts,Jh=new Set,tc=new Uint32Array(4);class ec{constructor(t){this.vertexBuffer=null,this._destroyVertexBuffer=!1,this.count=t}destroy(){this._destroyVertexBuffer&&this.vertexBuffer?.destroy(),this.vertexBuffer=null}}class sc{get(t){return this.map.get(t)??this.map.get(null)}constructor(){this.map=new Map,this.meshMetaData=new Int32Array(4)}}class ic{getBindGroup(t){if(!this.bindGroup){const e=this.shader.meshBindGroupFormat;this.bindGroup=new vn(t,e)}return this.bindGroup}getUniformBuffer(t){if(!this.uniformBuffer){const e=this.shader.meshUniformBufferFormat;this.uniformBuffer=new Na(t,e,!1)}return this.uniformBuffer}destroy(){this.bindGroup?.destroy(),this.bindGroup=null,this.uniformBuffer?.destroy(),this.uniformBuffer=null}constructor(){this.bindGroup=null,this.uniformBuffer=null}}class nc{constructor(t,e,s=null){if(this.castShadow=!1,this.shadowCascadeMask=255,this.cull=!0,this.drawOrder=0,this._drawBucket=127,this.visible=!0,this.visibleThisFrame=!1,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=Kh++,this.isVisibleFunc=null,this.instancingData=null,this.indirectData=null,this.parameters={},this.pick=!0,this.stencilFront=null,this.stencilBack=null,this.transparent=!1,this._aabb=new Ss,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=!0,this._updateAabbFunc=null,this._sortKeyShadow=0,this._sortKeyForward=0,this._sortKeyDynamic=0,this._layer=15,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=!0,this._renderStyle=0,this._screenSpace=!1,this._shaderCache=new Map,this._shaderDefs=65536,this._calculateSortDistance=null,this.node=s,this._mesh=t,t.incRefCount(),this.material=e,t.vertexBuffer){const e=t.vertexBuffer.format;this._shaderDefs|=e.hasUv0?4:0,this._shaderDefs|=e.hasUv1?8:0,this._shaderDefs|=e.hasColor?16:0,this._shaderDefs|=e.hasTangents?512:0}this.updateKey()}set drawBucket(t){this._drawBucket=255&Math.floor(t),this.updateKey()}get drawBucket(){return this._drawBucket}set renderStyle(t){this._renderStyle=t,this.mesh.prepareRenderState(t)}get renderStyle(){return this._renderStyle}set mesh(t){t!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=t,t&&t.incRefCount())}get mesh(){return this._mesh}set aabb(t){this._aabb=t}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let t=this._customAabb,e=!!t;if(!t)if(t=Yh,this.skinInstance){if(!this.mesh.boneAabb){const t=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(t)}const s=this.mesh.boneUsed;let i=!0;for(let e=0;e<this.mesh.boneAabb.length;e++)s[e]&&(Qh.setFromTransformedAabb(this.mesh.boneAabb[e],this.skinInstance.matrices[e]),i?(i=!1,t.center.copy(Qh.center),t.halfExtents.copy(Qh.halfExtents)):t.add(Qh));e=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(t.center.copy(this.mesh.aabb.center),t.halfExtents.copy(this.mesh.aabb.halfExtents)):(t.center.set(0,0,0),t.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){const e=this.mesh.morph.aabb;t._expand(e.getMin(),e.getMax())}e=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}return e&&this._aabb.setFromTransformedAabb(t,this.node.getWorldTransform()),this._aabb}clearShaders(){this._shaderCache.forEach((t=>{t.destroy()})),this._shaderCache.clear()}getShaderInstance(t,e,s,i,n,r,a){const o=this._shaderDefs;tc[0]=t,tc[1]=e,tc[2]=o,tc[3]=i.hash;const l=Mn(tc);let h=this._shaderCache.get(l);if(!h){const e=this._material;if(h=new ic,h.shader=e.variants.get(l),h.hashes=new Uint32Array(tc),!h.shader){const c=e.getShaderVariant({device:this.mesh.device,scene:s,objDefs:o,cameraShaderParams:i,pass:t,sortedLights:a,viewUniformFormat:n,viewBindGroupFormat:r,vertexFormat:this.mesh.vertexBuffer?.format});e.variants.set(l,c),h.shader=c}this._shaderCache.set(l,h)}return h}set material(t){this.clearShaders();const e=this._material;e&&e.removeMeshInstanceRef(this),this._material=t,t&&(t.addMeshInstanceRef(this),this.transparent=t.transparent,this.updateKey())}get material(){return this._material}_updateShaderDefs(t){t!==this._shaderDefs&&(this._shaderDefs=t,this.clearShaders())}set calculateSortDistance(t){this._calculateSortDistance=t}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(t){this._receiveShadow!==t&&(this._receiveShadow=t,this._updateShaderDefs(t?-2&this._shaderDefs:1|this._shaderDefs))}get receiveShadow(){return this._receiveShadow}set batching(t){this._updateShaderDefs(t?this._shaderDefs|eh:-16385&this._shaderDefs)}get batching(){return 0!==(this._shaderDefs&eh)}set skinInstance(t){this._skinInstance=t,this._updateShaderDefs(t?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(t){this._morphInstance?.destroy(),this._morphInstance=t;let e=this._shaderDefs;e=t&&t.morph.morphPositions?e|Zl:-1025&e,e=t&&t.morph.morphNormals?e|Jl:-2049&e,e=t&&t.morph.intRenderFormat?e|th:-8193&e,this._updateShaderDefs(e)}get morphInstance(){return this._morphInstance}set screenSpace(t){this._screenSpace!==t&&(this._screenSpace=t,this._updateShaderDefs(t?256|this._shaderDefs:-257&this._shaderDefs))}get screenSpace(){return this._screenSpace}set key(t){this._sortKeyForward=t}get key(){return this._sortKeyForward}set mask(t){const e=65535&this._shaderDefs;this._updateShaderDefs(e|t<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(t){this.instancingData&&(this.instancingData.count=t)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){const t=this.mesh;t&&(this.mesh=null,t.refCount<1&&t.destroy()),this.setRealtimeLightmap(nc.lightmapParamNames[0],null),this.setRealtimeLightmap(nc.lightmapParamNames[1],null),this._skinInstance?.destroy(),this._skinInstance=null,this.morphInstance?.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,this.instancingData?.destroy()}static{this.lightmapParamNames=["texture_lightMap","texture_dirLightMap"]}static _prepareRenderStyleForArray(t,e){if(t){for(let s=0;s<t.length;s++){t[s]._renderStyle=e;const i=t[s].mesh;Jh.has(i)||(Jh.add(i),i.prepareRenderState(e))}Jh.clear()}}_isVisible(t){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(t):(Zh.center=this.aabb.center,Zh.radius=this._aabb.halfExtents.length(),t.frustum.containsSphere(Zh)>0))}updateKey(){const{material:t}=this;this._sortKeyForward=this._drawBucket<<23|(t.alphaToCoverage||t.alphaTest?4194304:0)|4194303&t.id}setInstancing(t,e=!1){t?(this.instancingData=new ec(t.numVertices),this.instancingData.vertexBuffer=t,t.format.instancing=!0,this.cull=e):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(t?32|this._shaderDefs:-33&this._shaderDefs)}setIndirect(t,e){this._allocIndirectData(),this.indirectData.map.set(t?.camera??null,e);this.mesh.device.mapsToClear.add(this.indirectData.map)}getIndirectMetaData(){this._allocIndirectData();const t=this.mesh?.primitive[this.renderStyle],e=this.indirectData.meshMetaData;return e[0]=t.count,e[1]=t.base,e[2]=t.baseVertex,e}_allocIndirectData(){this.indirectData||(this.indirectData=new sc)}ensureMaterial(t){this.material||(this.material=Xh(t))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(t){return this.parameters[t]}setParameter(t,e,s=4294967295){const i=this.parameters[t];i?(i.data=e,i.passFlags=s):this.parameters[t]={scopeId:null,data:e,passFlags:s}}setRealtimeLightmap(t,e){const s=this.getParameter(t);s!==e&&(s&&qh.decRef(s.data),e?(qh.incRef(e),this.setParameter(t,e)):this.deleteParameter(t))}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&e&&(n.scopeId||(n.scopeId=t.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(t){t?this.mask=-6&this.mask|2:(this.setRealtimeLightmap(nc.lightmapParamNames[0],null),this.setRealtimeLightmap(nc.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=-7&this.mask|1)}setCustomAabb(t){t?this._customAabb?this._customAabb.copy(t):this._customAabb=t.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}const rc="uSceneColorMap";class ac extends Ao{destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(t,e,s){const i=t?.colorBuffer.format;if(i!==s)return!0;const n=e?.width||this.device.width,r=e?.height||this.device.height;return!t||n!==t.width||r!==t.height}allocateRenderTarget(t,e,s,i){const n=new dn(s,{name:rc,format:i,width:e?e.colorBuffer.width:s.width,height:e?e.colorBuffer.height:s.height,mipmaps:!0,minFilter:5,magFilter:1,addressU:1,addressV:1});return t?(t.destroyFrameBuffers(),t._colorBuffer=n,t._colorBuffers=[n]):t=new Hn({name:"ColorGrabRT",colorBuffer:n,depth:!1,stencil:!1,autoResolve:!1}),t}releaseRenderTarget(t){t&&(t.destroyTextureBuffers(),t.destroy())}frameUpdate(){const t=this.device,e=this.source,s=e?.colorBuffer.format??this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,e?.colorBuffer,s)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,e,t,s));const i=this.colorRenderTarget.colorBuffer;t.scope.resolve(rc).setValue(i)}execute(){const t=this.device,e=this.source,s=this.colorRenderTarget.colorBuffer;t.isWebGPU?(t.copyRenderTarget(e,this.colorRenderTarget,!0,!1),t.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(t.copyRenderTarget(e,this.colorRenderTarget,!0,!1),t.activeTexture(t.maxCombinedTextures-1),t.bindTexture(s),t.gl.generateMipmap(s.impl._glTarget))}constructor(...t){super(...t),this.colorRenderTarget=null,this.source=null}}const oc="uSceneDepthMap";class lc extends Ao{constructor(t,e){super(t),this.depthRenderTarget=null,this.camera=null,this.camera=e}destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(t,e){const s=e?.width||this.device.width,i=e?.height||this.device.height;return!t||s!==t.width||i!==t.height}allocateRenderTarget(t,e,s,i,n){const r=new dn(s,{name:oc,format:i,width:e?e.colorBuffer.width:s.width,height:e?e.colorBuffer.height:s.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return t?(t.destroyFrameBuffers(),n?t._depthBuffer=r:(t._colorBuffer=r,t._colorBuffers=[r])):t=new Hn({name:"DepthGrabRT",colorBuffer:n?null:r,depthBuffer:n?r:null,depth:!n,stencil:s.supportsStencil,autoResolve:!1}),t}releaseRenderTarget(t){t&&(t.destroyTextureBuffers(),t.destroy())}before(){const t=this.camera,e=this.device,s=t?.renderTarget??e.backBuffer;let i=!0,n=s.stencil?Ms:Rs;if(e.isWebGPU){s.samples>1&&(n=Is,i=!1)}const r=t.renderTarget?.depthBuffer??t.renderTarget?.colorBuffer;this.shouldReallocate(this.depthRenderTarget,r)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,t.renderTarget,e,n,i));const a=i?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;e.scope.resolve(oc).setValue(a)}execute(){const t=this.device;if(t.isWebGL2&&t.renderTarget.samples>1){const e=t.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;t.renderTarget=s,t.updateBegin(),this.depthRenderTarget.impl.internalResolve(t,e,s.impl._glFrameBuffer,this.depthRenderTarget,t.gl.DEPTH_BUFFER_BIT)}else t.copyRenderTarget(t.renderTarget,this.depthRenderTarget,!1,!0)}}class hc{get hash(){if(void 0===this._hash){const t=`${this.gammaCorrection}_${this.toneMapping}_${this.srgbRenderTarget}_${this.fog}_${this.ssaoEnabled}_${this.sceneDepthMapLinear}`;this._hash=Rn(t)}return this._hash}get defines(){const t=this._defines;return this._definesDirty&&(this._definesDirty=!1,t.clear(),this._sceneDepthMapLinear&&t.set("SCENE_DEPTHMAP_LINEAR",!0),t.set("FOG",this._fog.toUpperCase()),t.set("TONEMAP",Nl[this._toneMapping]),t.set("GAMMA",Fl[this.shaderOutputGamma])),t}markDirty(){this._hash=void 0,this._definesDirty=!0}set fog(t){this._fog!==t&&(this._fog=t,this.markDirty())}get fog(){return this._fog}set ssaoEnabled(t){this._ssaoEnabled!==t&&(this._ssaoEnabled=t,this.markDirty())}get ssaoEnabled(){return this._ssaoEnabled}set gammaCorrection(t){this._gammaCorrectionAssigned=!0,this._gammaCorrection!==t&&(this._gammaCorrection=t,this.markDirty())}get gammaCorrection(){return this._gammaCorrection}set toneMapping(t){this._toneMapping!==t&&(this._toneMapping=t,this.markDirty())}get toneMapping(){return this._toneMapping}set srgbRenderTarget(t){this._srgbRenderTarget!==t&&(this._srgbRenderTarget=t,this.markDirty())}get srgbRenderTarget(){return this._srgbRenderTarget}set sceneDepthMapLinear(t){this._sceneDepthMapLinear!==t&&(this._sceneDepthMapLinear=t,this.markDirty())}get sceneDepthMapLinear(){return this._sceneDepthMapLinear}get shaderOutputGamma(){return 1===this._gammaCorrection&&!this._srgbRenderTarget?1:0}constructor(){this._gammaCorrection=1,this._toneMapping=0,this._srgbRenderTarget=!1,this._ssaoEnabled=!1,this._fog=fl,this._sceneDepthMapLinear=!1,this._defines=new Map,this._definesDirty=!0}}const cc=new rs,dc=new rs,uc=new rs,fc=new ps,pc=[new rs,new rs,new rs,new rs,new rs,new rs,new rs,new rs];class mc{constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new hc,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new Ze(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new ls(0,0,1,1),this._renderTarget=null,this._scissorRect=new ls(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new ps,this._projMatDirty=!0,this._projMatSkybox=new ps,this._viewMat=new ps,this._viewMatDirty=!0,this._viewProjMat=new ps,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new ps,this._viewProjCurrent=null,this._viewProjPrevious=new ps,this._jitters=[0,0,0,0],this.frustum=new Cs,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}destroy(){this.renderPassColorGrab?.destroy(),this.renderPassColorGrab=null,this.renderPassDepthGrab?.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(t,e,s,i){this._shaderMatricesVersion!==i&&(this._shaderMatricesVersion=i,this._viewProjPrevious.copy(this._viewProjCurrent??t),this._viewProjCurrent??=new ps,this._viewProjCurrent.copy(t),this._viewProjInverse.invert(t),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=e,this._jitters[1]=s)}get fullSizeClearRect(){const t=this._scissorRectClear?this.scissorRect:this._rect;return 0===t.x&&0===t.y&&1===t.z&&1===t.w}set aspectRatio(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._projMatDirty=!0)}get aspectRatio(){return this.xr?.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(t){this._aspectRatioMode!==t&&(this._aspectRatioMode=t,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(t){this._calculateProjection=t,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(t){this._calculateTransform=t}get calculateTransform(){return this._calculateTransform}set clearColor(t){this._clearColor.copy(t)}get clearColor(){return this._clearColor}set clearColorBuffer(t){this._clearColorBuffer=t}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(t){this._clearDepth=t}get clearDepth(){return this._clearDepth}set clearDepthBuffer(t){this._clearDepthBuffer=t}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(t){this._clearStencil=t}get clearStencil(){return this._clearStencil}set clearStencilBuffer(t){this._clearStencilBuffer=t}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(t){this._cullFaces=t}get cullFaces(){return this._cullFaces}set farClip(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}get farClip(){return this.xr?.active?this._xrProperties.farClip:this._farClip}set flipFaces(t){this._flipFaces=t}get flipFaces(){return this._flipFaces}set fov(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}get fov(){return this.xr?.active?this._xrProperties.fov:this._fov}set frustumCulling(t){this._frustumCulling=t}get frustumCulling(){return this._frustumCulling}set horizontalFov(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}get horizontalFov(){return this.xr?.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(t){this._layers=t.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}get nearClip(){return this.xr?.active?this._xrProperties.nearClip:this._nearClip}set node(t){this._node=t}get node(){return this._node}set orthoHeight(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(t){this._rect.copy(t)}get rect(){return this._rect}set renderTarget(t){this._renderTarget=t}get renderTarget(){return this._renderTarget}set scissorRect(t){this._scissorRect.copy(t)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const t=this._node.getWorldTransform();this._viewMat.copy(t).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(t){this._aperture=t}get aperture(){return this._aperture}set sensitivity(t){this._sensitivity=t}get sensitivity(){return this._sensitivity}set shutter(t){this._shutter=t}get shutter(){return this._shutter}set xr(t){this._xr!==t&&(this._xr=t,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return(new mc).copy(this)}copy(t){return this._aspectRatio=t._aspectRatio,this._farClip=t._farClip,this._fov=t._fov,this._horizontalFov=t._horizontalFov,this._nearClip=t._nearClip,this._xrProperties.aspectRatio=t._xrProperties.aspectRatio,this._xrProperties.farClip=t._xrProperties.farClip,this._xrProperties.fov=t._xrProperties.fov,this._xrProperties.horizontalFov=t._xrProperties.horizontalFov,this._xrProperties.nearClip=t._xrProperties.nearClip,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepth=t.clearDepth,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencil=t.clearStencil,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.flipFaces=t.flipFaces,this.frustumCulling=t.frustumCulling,this.layers=t.layers,this.orthoHeight=t.orthoHeight,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.aperture=t.aperture,this.shutter=t.shutter,this.sensitivity=t.sensitivity,this.shaderPassInfo=t.shaderPassInfo,this.jitter=t.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(t,e){e?this.renderPassColorGrab||(this.renderPassColorGrab=new ac(t)):(this.renderPassColorGrab?.destroy(),this.renderPassColorGrab=null)}_enableRenderPassDepthGrab(t,e,s){s?this.renderPassDepthGrab||(this.renderPassDepthGrab=new lc(t,this)):(this.renderPassDepthGrab?.destroy(),this.renderPassDepthGrab=null)}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(t,e,s,i=new rs){this._updateViewProjMat(),this._viewProjMat.transformPoint(t,i);const n=this._viewProjMat.data,r=t.x*n[3]+t.y*n[7]+t.z*n[11]+1*n[15];i.x=.5*(i.x/r+1),i.y=.5*(1-i.y/r);const{x:a,y:o,z:l,w:h}=this._rect;return i.x=i.x*l*e+a*e,i.y=i.y*h*s+(1-o-h)*s,i}screenToWorld(t,e,s,i,n,r=new rs){const{x:a,y:o,z:l,w:h}=this._rect,c=this.farClip-this.nearClip;if(cc.set((t-a*i)/(l*i),1-(e-(1-o-h)*n)/(h*n),s/c),cc.mulScalar(2),cc.sub(rs.ONE),0===this._projection){ps._getPerspectiveHalfSize(dc,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),dc.x*=cc.x,dc.y*=cc.y;const t=this._node.getWorldTransform();dc.z=-this.nearClip,t.transformPoint(dc,uc);const e=this._node.getPosition();r.sub2(uc,e),r.normalize(),r.mulScalar(s),r.add(e)}else this._updateViewProjMat(),fc.copy(this._viewProjMat).invert(),fc.transformPoint(cc,r);return r}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{const t=this._orthoHeight,e=t*this.aspectRatio;this._projMat.setOrtho(-e,e,-t,t,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){const t=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(1.2*Math.pow(2,t))}getScreenSize(t){if(0===this._projection){const e=this._node.getPosition().distance(t.center);if(e<t.radius)return 1;const s=Math.asin(t.radius/e),i=Math.tan(s),n=Math.tan(this.fov/2*Qe.DEG_TO_RAD);return Math.min(i/n,1)}return Qe.clamp(t.radius/this._orthoHeight,0,1)}getFrustumCorners(t=this.nearClip,e=this.farClip){const s=this.fov*Math.PI/180;let i,n;0===this.projection?this.horizontalFov?(i=t*Math.tan(s/2),n=i/this.aspectRatio):(n=t*Math.tan(s/2),i=n*this.aspectRatio):(n=this._orthoHeight,i=n*this.aspectRatio);const r=pc;return r[0].x=i,r[0].y=-n,r[0].z=-t,r[1].x=i,r[1].y=n,r[1].z=-t,r[2].x=-i,r[2].y=n,r[2].z=-t,r[3].x=-i,r[3].y=-n,r[3].z=-t,0===this._projection&&(this.horizontalFov?(i=e*Math.tan(s/2),n=i/this.aspectRatio):(n=e*Math.tan(s/2),i=n*this.aspectRatio)),r[4].x=i,r[4].y=-n,r[4].z=-e,r[5].x=i,r[5].y=n,r[5].z=-e,r[6].x=-i,r[6].y=n,r[6].z=-e,r[7].x=-i,r[7].y=-n,r[7].z=-e,r}setXrProperties(t){Object.assign(this._xrProperties,t),this._projMatDirty=!0}}const _c=new ps,gc=new rs,vc=new ms,bc=new ms,yc=new rs,Sc=new rs,xc=new ps,wc=new ms,Tc=new rs,Ec=new ps,Cc=new ms,Ac=new ms,Dc=new ps,Pc=new rs,Lc=new rs;function Ic(t,e){return t instanceof Function?t:s=>{let i=s[t];return i instanceof Function&&(i=i()),i===e}}function Rc(t,e){if(e(t))return t;const s=t._children,i=s.length;for(let t=0;t<i;++t){const i=Rc(s[t],e);if(i)return i}return null}class Mc extends Ve{constructor(t="Untitled"){super(),this.tags=new Xe(this),this.localPosition=new rs,this.localRotation=new ms,this.localScale=new rs(1,1,1),this.localEulerAngles=new rs,this.position=new rs,this.rotation=new ms,this.eulerAngles=new rs,this._scale=null,this.localTransform=new ps,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new ps,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new as,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=t}get right(){return this._right||(this._right=new rs),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new rs),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new rs),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){const t=this._normalMatrix;return this._dirtyNormal&&(t.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),t}set enabled(t){this._enabled!==t&&(this._enabled=t,(t&&this._parent?.enabled||!t)&&this._notifyHierarchyStateChanged(this,t))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let t=this._parent;if(!t)return"";let e=this.name;for(;t&&t._parent;)e=`${t.name}/${e}`,t=t._parent;return e}get root(){let t=this;for(;t._parent;)t=t._parent;return t}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(t,e){t._onHierarchyStateChanged(e);const s=t._children;for(let t=0,i=s.length;t<i;t++)s[t]._enabled&&this._notifyHierarchyStateChanged(s[t],e)}_onHierarchyStateChanged(t){this._enabledInHierarchy=t,t&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(t){t.name=this.name;const e=this.tags._list;t.tags.clear();for(let s=0;s<e.length;s++)t.tags.add(e[s]);t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t._enabledInHierarchy=!1}clone(){const t=new this.constructor;return this._cloneInternal(t),t}copy(t){return t._cloneInternal(this),this}destroy(){this.remove();const t=this._children;for(;t.length;){const e=t.pop();e._parent=null,e.destroy()}this.fire("destroy",this),this.off()}find(t,e){const s=[],i=Ic(t,e);return this.forEach((t=>{i(t)&&s.push(t)})),s}findOne(t,e){return Rc(this,Ic(t,e))}findByTag(...t){const e=[],s=(i,n)=>{n&&i.tags.has(...t)&&e.push(i);for(let t=0;t<i._children.length;t++)s(i._children[t],!0)};return s(this,!1),e}findByName(t){return this.findOne("name",t)}findByPath(t){const e=Array.isArray(t)?t:t.split("/");let s=this;for(let t=0,i=e.length;t<i;++t)if(s=s.children.find((s=>s.name===e[t])),!s)return null;return s}forEach(t,e){t.call(e,this);const s=this._children,i=s.length;for(let n=0;n<i;++n)s[n].forEach(t,e)}isDescendantOf(t){let e=this._parent;for(;e;){if(e===t)return!0;e=e._parent}return!1}isAncestorOf(t){return t.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new rs),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}get worldScaleSign(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){this._parent?.removeChild(this)}reparent(t,e){this.remove(),t&&(e>=0?t.insertChild(this,e):t.addChild(this))}setLocalEulerAngles(t,e,s){this.localRotation.setFromEulerAngles(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(t,e,s){t instanceof rs?this.localPosition.copy(t):this.localPosition.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(t,e,s,i){t instanceof ms?this.localRotation.copy(t):this.localRotation.set(t,e,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(t,e,s){t instanceof rs?this.localScale.copy(t):this.localScale.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let t=this._parent;for(;t;)t._frozen=!1,t=t._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let t=0;t<this._children.length;t++)this._children[t]._dirtyWorld||this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(t,e,s){t instanceof rs?Tc.copy(t):Tc.set(t,e,s),null===this._parent?this.localPosition.copy(Tc):(Ec.copy(this._parent.getWorldTransform()).invert(),Ec.transformPoint(Tc,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(t,e,s,i){if(t instanceof ms?Cc.copy(t):Cc.set(t,e,s,i),null===this._parent)this.localRotation.copy(Cc);else{const t=this._parent.getRotation();Ac.copy(t).invert(),this.localRotation.copy(Ac).mul(Cc)}this._dirtyLocal||this._dirtifyLocal()}setPositionAndRotation(t,e){if(null===this._parent)this.localPosition.copy(t),this.localRotation.copy(e);else{const s=this._parent.getWorldTransform();Ec.copy(s).invert(),Ec.transformPoint(t,this.localPosition),this.localRotation.setFromMat4(Ec).mul(e)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(t,e,s){if(this.localRotation.setFromEulerAngles(t,e,s),null!==this._parent){const t=this._parent.getRotation();Ac.copy(t).invert(),this.localRotation.mul2(Ac,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(t){this._prepareInsertChild(t),this._children.push(t),this._onInsertChild(t)}addChildAndSaveTransform(t){const e=t.getPosition(),s=t.getRotation();this._prepareInsertChild(t),t.setPosition(xc.copy(this.worldTransform).invert().transformPoint(e)),t.setRotation(wc.copy(this.getRotation()).invert().mul(s)),this._children.push(t),this._onInsertChild(t)}insertChild(t,e){this._prepareInsertChild(t),this._children.splice(e,0,t),this._onInsertChild(t)}_prepareInsertChild(t){t.remove()}_fireOnHierarchy(t,e,s){this.fire(t,s);for(let t=0;t<this._children.length;t++)this._children[t]._fireOnHierarchy(e,e,s)}_onInsertChild(t){t._parent=this;const e=t._enabled&&this.enabled;t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t._dirtifyWorld(),this._frozen&&t._unfreezeParentToRoot(),t._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",t)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()}removeChild(t){const e=this._children.indexOf(t);-1!==e&&(this._children.splice(e,1),t._parent=null,t._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",t))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let t;const e=this._parent;let s=this.localScale,i=e;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(t=i.worldTransform.getScale(),yc.mul2(t,this.localScale),s=yc))}bc.setFromMat4(e.worldTransform),vc.mul2(bc,this.localRotation);let n=e.worldTransform;e.scaleCompensation&&(Sc.mul2(t,e.getLocalScale()),_c.setTRS(e.worldTransform.getTranslation(gc),bc,Sc),n=_c),n.transformPoint(this.localPosition,gc),this.worldTransform.setTRS(gc,vc,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const t=this._children;for(let e=0,s=t.length;e<s;e++)t[e].syncHierarchy()}lookAt(t,e,s,i=0,n=1,r=0){if(t instanceof rs)Pc.copy(t),e instanceof rs?Lc.copy(e):Lc.copy(rs.UP);else{if(void 0===s)return;Pc.set(t,e,s),Lc.set(i,n,r)}Dc.setLookAt(this.getPosition(),Pc,Lc),Cc.setFromMat4(Dc),this.setRotation(Cc)}translate(t,e,s){t instanceof rs?Tc.copy(t):Tc.set(t,e,s),Tc.add(this.getPosition()),this.setPosition(Tc)}translateLocal(t,e,s){t instanceof rs?Tc.copy(t):Tc.set(t,e,s),this.localRotation.transformVector(Tc,Tc),this.localPosition.add(Tc),this._dirtyLocal||this._dirtifyLocal()}rotate(t,e,s){if(Cc.setFromEulerAngles(t,e,s),null===this._parent)this.localRotation.mul2(Cc,this.localRotation);else{const t=this.getRotation(),e=this._parent.getRotation();Ac.copy(e).invert(),Cc.mul2(Ac,Cc),this.localRotation.mul2(Cc,t)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(t,e,s){Cc.setFromEulerAngles(t,e,s),this.localRotation.mul(Cc),this._dirtyLocal||this._dirtifyLocal()}}const kc=new ps,Oc=new ps,Fc=new ps;class Nc{static{this.pointLightRotations=[(new ms).setFromEulerAngles(0,90,180),(new ms).setFromEulerAngles(0,-90,180),(new ms).setFromEulerAngles(90,0,0),(new ms).setFromEulerAngles(-90,0,0),(new ms).setFromEulerAngles(0,180,180),(new ms).setFromEulerAngles(0,0,180)]}static create(t,e,s){const i=new mc;switch(i.node=new Mc(t),i.aspectRatio=1,i.aspectRatioMode=1,i._scissorRectClear=!0,e){case 1:i.node.setRotation(Nc.pointLightRotations[s]),i.fov=90,i.projection=0;break;case 2:i.projection=0;break;case 0:i.projection=1}return i}static{this._spotCookieCamera=null}static evalSpotCookieMatrix(t){let e=Nc._spotCookieCamera;e||(e=Nc.create("SpotCookieCamera",2),Nc._spotCookieCamera=e),e.fov=2*t._outerConeAngle;const s=e._node;s.setPosition(t._node.getPosition()),s.setRotation(t._node.getRotation()),s.rotateLocal(-90,0,0),kc.setTRS(s.getPosition(),s.getRotation(),rs.ONE).invert(),Oc.mul2(e.projectionMatrix,kc);const i=t.cookieMatrix,n=t.atlasViewport;return Fc.setViewport(n.x,n.y,n.z,n.w),i.mul2(Fc,Oc),i}}const Bc=new rs,Uc=new Float32Array(6),zc=new rs(-.5,0,0),Vc=new rs(0,0,.5),Hc={POSITION_RANGE:0,DIRECTION_FLAGS:1,COLOR_ANGLES_BIAS:2,PROJ_MAT_0:3,ATLAS_VIEWPORT:3,PROJ_MAT_1:4,PROJ_MAT_2:5,PROJ_MAT_3:6,AREA_DATA_WIDTH:7,AREA_DATA_HEIGHT:8,COUNT:9},Gc={LIGHTSHAPE_PUNCTUAL:"0u",LIGHTSHAPE_RECT:"1u",LIGHTSHAPE_DISK:"2u",LIGHTSHAPE_SPHERE:"3u",LIGHT_COLOR_DIVIDER:"100.0"},Wc=(t,e)=>Object.keys(t).map((s=>`#define {${e}${s}} ${t[s]}`)).join("\n"),jc=`\n\n\t\t${Wc(Hc,"CLUSTER_TEXTURE_")}\n\t\t${Wc(Gc,"")}\n`;class Xc{constructor(t){this.areaLightsEnabled=!1,this.device=t,Ch.get(t,Ai).set("lightBufferDefinesPS",jc),Ch.get(t,Di).set("lightBufferDefinesPS",jc),this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;const e=Hc.COUNT;this.lightsFloat=new Float32Array(4*e*this.maxLights),this.lightsUint=new Uint32Array(this.lightsFloat.buffer),this.lightsTexture=this.createTexture(this.device,e,this.maxLights,Ls,"LightsTexture"),this._lightsTextureId=this.device.scope.resolve("lightsTexture"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new rs,this.boundsDelta=new rs}destroy(){this.lightsTexture?.destroy(),this.lightsTexture=null}createTexture(t,e,s,i,n){return new dn(t,{name:n,width:e,height:s,mipmaps:!1,format:i,addressU:1,addressV:1,type:mi,magFilter:0,minFilter:0,anisotropy:1})}setBounds(t,e){this.boundsMin.copy(t),this.boundsDelta.copy(e)}uploadTextures(){this.lightsTexture.lock().set(this.lightsFloat),this.lightsTexture.unlock()}updateUniforms(){this._lightsTextureId.setValue(this.lightsTexture)}getSpotDirection(t,e){e._node.getWorldTransform().getY(t).mulScalar(-1),t.normalize()}getLightAreaSizes(t){const e=t._node.getWorldTransform();return e.transformVector(zc,Bc),Uc[0]=Bc.x,Uc[1]=Bc.y,Uc[2]=Bc.z,e.transformVector(Vc,Bc),Uc[3]=Bc.x,Uc[4]=Bc.y,Uc[5]=Bc.z,Uc}addLightData(t,e){const s=2===t._type,i=t.atlasViewportAllocated,n=this.cookiesEnabled&&!!t._cookie&&i,r=this.areaLightsEnabled&&0!==t.shape,a=this.shadowsEnabled&&t.castShadows&&i,o=t._node.getPosition();let l=null,h=null;if(s)if(a){l=t.getRenderData(null,0).shadowMatrix}else n&&(l=Nc.evalSpotCookieMatrix(t));else(a||n)&&(h=t.atlasViewport);const c=this.lightsFloat,d=this.lightsUint,u=e*this.lightsTexture.width*4;c[u+4*Hc.POSITION_RANGE+0]=o.x,c[u+4*Hc.POSITION_RANGE+1]=o.y,c[u+4*Hc.POSITION_RANGE+2]=o.z,c[u+4*Hc.POSITION_RANGE+3]=t.attenuationEnd;const f=t.clusteredData;if(d[u+4*Hc.COLOR_ANGLES_BIAS+0]=f[0],d[u+4*Hc.COLOR_ANGLES_BIAS+1]=f[1],d[u+4*Hc.COLOR_ANGLES_BIAS+2]=f[2],t.castShadows){const e=t.getRenderData(null,0),s=t._getUniformBiasValues(e),i=ns.float2Half(s.bias),n=ns.float2Half(s.normalBias);d[u+4*Hc.COLOR_ANGLES_BIAS+3]=i|n<<16}if(s&&(this.getSpotDirection(Bc,t),c[u+4*Hc.DIRECTION_FLAGS+0]=Bc.x,c[u+4*Hc.DIRECTION_FLAGS+1]=Bc.y,c[u+4*Hc.DIRECTION_FLAGS+2]=Bc.z),d[u+4*Hc.DIRECTION_FLAGS+3]=t.getClusteredFlags(a,n),l){const t=l.data;for(let e=0;e<16;e++)c[u+4*Hc.PROJ_MAT_0+e]=t[e]}if(h&&(c[u+4*Hc.ATLAS_VIEWPORT+0]=h.x,c[u+4*Hc.ATLAS_VIEWPORT+1]=h.y,c[u+4*Hc.ATLAS_VIEWPORT+2]=h.z/3),r){const e=this.getLightAreaSizes(t);c[u+4*Hc.AREA_DATA_WIDTH+0]=e[0],c[u+4*Hc.AREA_DATA_WIDTH+1]=e[1],c[u+4*Hc.AREA_DATA_WIDTH+2]=e[2],c[u+4*Hc.AREA_DATA_HEIGHT+0]=e[3],c[u+4*Hc.AREA_DATA_HEIGHT+1]=e[4],c[u+4*Hc.AREA_DATA_HEIGHT+2]=e[5]}}}const $c=new rs,qc=new rs,Kc=new rs,Yc=new Ss;class Qc{constructor(){this.light=null,this.min=new rs,this.max=new rs}}class Zc{constructor(t){this.device=t,this.name="Untitled",this.reportCount=0,this.boundsMin=new rs,this.boundsMax=new rs,this.boundsDelta=new rs,this._cells=new rs(1,1,1),this._cellsLimit=new rs,this.cells=this._cells,this.maxCellLightCount=4,this._usedLights=[],this._usedLights.push(new Qc),this.lightsBuffer=new Xc(t),this.registerUniforms(t)}set maxCellLightCount(t){t!==this._maxCellLightCount&&(this._maxCellLightCount=t,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(t){$c.copy(t).floor(),this._cells.equals($c)||(this._cells.copy($c),this._cellsLimit.copy($c).sub(rs.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(t){this._clusterSkipId=t.scope.resolve("clusterSkip"),this._clusterMaxCellsId=t.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=t.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=t.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=t.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=t.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=t.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=t.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=t.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3)}updateParams(t){t&&(this.cells=t.cells,this.maxCellLightCount=t.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=t.cookiesEnabled,this.lightsBuffer.shadowsEnabled=t.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=t.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const t=this._cells.x,e=this._cells.y,s=this._cells.z,i=t*e*s,n=this.maxCellLightCount*i;let r=Math.ceil(Math.sqrt(n));r=Qe.roundUp(r,this.maxCellLightCount);const a=Math.ceil(n/r);this._clusterCellsMaxData[0]=t,this._clusterCellsMaxData[1]=e,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=t*s*this.maxCellLightCount,this._clusterCellsDotData[2]=t*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=r,this._clusterTextureSizeData[1]=1/r,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,r,a,52,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);const t=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/t.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/t.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/t.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=t.x,this._clusterBoundsDeltaData[1]=t.y,this._clusterBoundsDeltaData[2]=t.z,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData)}evalLightCellMinMax(t,e,s){e.copy(t.min),e.sub(this.boundsMin),e.div(this.boundsDelta),e.mul2(e,this.cells),e.floor(),s.copy(t.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),e.max(rs.ZERO),s.min(this._cellsLimit)}collectLights(t){const e=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;t.forEach((t=>{const n=!!(3&t.mask),r=2===t.type&&0===t._outerConeAngle;if(t.enabled&&0!==t.type&&t.visibleThisFrame&&t.intensity>0&&n&&!r&&i<e){let e;i<s.length?e=s[i]:(e=new Qc,s.push(e)),e.light=t,t.getBoundingBox(Yc),e.min.copy(Yc.getMin()),e.max.copy(Yc.getMax()),i++}})),s.length=i}evaluateBounds(){const t=this._usedLights,e=this.boundsMin,s=this.boundsMax;if(t.length>1){e.copy(t[1].min),s.copy(t[1].max);for(let i=2;i<t.length;i++)e.min(t[i].min),s.max(t[i].max)}else e.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,e),this.lightsBuffer.setBounds(e,this.boundsDelta)}updateClusters(t){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=!!t&&t.areaLightsEnabled;const e=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,r=this.clusters,a=this.maxCellLightCount,o=this._usedLights;for(let t=1;t<o.length;t++){const l=o[t],h=l.light;this.lightsBuffer.addLightData(h,t),this.evalLightCellMinMax(l,qc,Kc);const c=qc.x,d=Kc.x,u=qc.y,f=Kc.y,p=qc.z,m=Kc.z;for(let o=c;o<=d;o++)for(let l=p;l<=m;l++)for(let h=u;h<=f;h++){const c=o+e*(l+h*s),d=i[c];d<n&&(r[a*c+d]=t,i[c]=d+1)}}}update(t,e=null){this.updateParams(e),this.updateCells(),this.collectLights(t),this.evaluateBounds(),this.updateClusters(e),this.uploadTextures()}activate(){this.updateUniforms()}}let Jc=null;const td=()=>{if(!Jc){const t=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");Jc=Uint8Array.from(t,(t=>t.charCodeAt(0)))}},ed=()=>(td(),Jc);class sd{constructor(t=0){this.seed=0,this.seed=4*t,td()}_next(){this.seed=(this.seed+4)%Jc.length}value(){return this._next(),Jc[this.seed]/255}vec4(t=new ls){return this._next(),t.set(Jc[this.seed],Jc[this.seed+1],Jc[this.seed+2],Jc[this.seed+3]).mulScalar(1/255)}}const id=[new rs(-1,0,0),new rs(1,0,0),new rs(0,-1,0),new rs(0,1,0),new rs(0,0,-1),new rs(0,0,1)];class nd{update(t,e){const s=this.colors,{r:i,g:n,b:r}=t;for(let t=0;t<6;t++)s[3*t]=i,s[3*t+1]=n,s[3*t+2]=r;for(let t=0;t<e.length;t++){const i=e[t];if(0===i._type)for(let t=0;t<6;t++){const e=Math.max(id[t].dot(i._direction),0)*i._intensity,n=i._color;s[3*t]+=n.r*e,s[3*t+1]+=n.g*e,s[3*t+2]+=n.b*e}}}constructor(){this.colors=new Float32Array(18)}}const rd=new ln,ad=t=>rd.get(t,(()=>{const e=ed(),s=Math.sqrt(e.length/4);return((t,e,s,i)=>{const n=new dn(t,{name:`${e}${s}`,width:s,height:s,format:7,addressU:0,addressV:0,type:mi,magFilter:0,minFilter:0,anisotropy:1,mipmaps:!1});return n.lock().set(i),n.unlock(),n})(t,"BlueNoise",s,e)}));class od{constructor(t,e){this.texture=t,this.cached=!1,this.renderTargets=e}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const t=this.renderTargets;for(let e=0;e<t.length;e++)t[e].destroy();this.renderTargets.length=0}static create(t,e){let s=null;return s=1===e._type?this.createCubemap(t,e._shadowResolution,e._shadowType):this.create2dMap(t,e._shadowResolution,e._shadowType),s}static createAtlas(t,e,s){const i=this.create2dMap(t,e,s),n=i.renderTargets,r=n[0];for(let t=0;t<5;t++)n.push(r);return i}static create2dMap(t,e,s){const i=Ll.get(s);let n=i.format;n===Is&&!t.textureFloatRenderable&&t.textureHalfFloatRenderable&&(n=50);const r=Vs.get(n)?.name;let a=1;3===s&&(a=t.extTextureFloatLinear?1:0),6===s&&(a=0);const o=new dn(t,{format:n,width:e,height:e,mipmaps:!1,minFilter:a,magFilter:a,addressU:1,addressV:1,name:`ShadowMap2D_${r}`});let l=null;return i?.pcf?(o.compareOnRead=!0,o.compareFunc=1,l=new Hn({depthBuffer:o})):l=new Hn({colorBuffer:o,depth:!0}),t.isWebGPU&&(l.flipY=!0),new od(o,[l])}static createCubemap(t,e,s){const i=Ll.get(s),n=Vs.get(i.format)?.name,r=6===s,a=r?0:1,o=new dn(t,{format:i?.format,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:a,magFilter:a,addressU:1,addressV:1,name:`ShadowMapCube_${n}`});r||(o.compareOnRead=!0,o.compareFunc=1);const l=[];for(let t=0;t<6;t++)r?l.push(new Hn({colorBuffer:o,face:t,depth:!0})):l.push(new Hn({depthBuffer:o,face:t}));return new od(o,l)}}const ld=[],hd=[],cd=new ls,dd=new ls;class ud{constructor(t){this.size=Math.floor(1024*t.w),this.used=!1,this.lightId=-1,this.rect=t}}class fd{constructor(t){this.device=t,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new dn(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:Os,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new Hn({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new os(0,0),new os(0,1),new os(1,0),new os(1,1),new os(2,0),new os(2,1)],this.scissorVec=new ls,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){this.shadowAtlas?.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){this.cookieAtlas?.destroy(),this.cookieAtlas=null,this.cookieRenderTarget?.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(t,e=0){const s=this.shadowAtlas?.texture.format,i=Ll.get(e).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==t||s!==i){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=od.createAtlas(this.device,t,e),this.shadowAtlas.cached=!0;const s=4/this.shadowAtlasResolution;this.scissorVec.set(s,s,-2*s,-2*s)}}allocateCookieAtlas(t){this.cookieAtlas.width!==t&&(this.cookieRenderTarget.resize(t,t),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(t),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(t,e){let s=e.atlasSplit;if(!s){const e=Math.ceil(Math.sqrt(t));s=hd,s[0]=e,s.length=1}if(i=s,n=this.atlasSplit,i.length!==n.length||!i.every(((t,e)=>t===n[e]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const t=this.atlasSplit[0];if(t>1){const e=1/t;for(let s=0;s<t;s++)for(let i=0;i<t;i++){const n=new ls(s*e,i*e,e,e),r=this.atlasSplit[1+s*t+i];if(r>1)for(let t=0;t<r;t++)for(let s=0;s<r;s++){const i=e/r,a=new ls(n.x+t*i,n.y+s*i,i,i);this.slots.push(new ud(a))}else this.slots.push(new ud(n))}}else this.slots.push(new ud(new ls(0,0,1,1)));this.slots.sort(((t,e)=>e.size-t.size))}var i,n}collectLights(t,e){const s=e.cookiesEnabled,i=e.shadowsEnabled;let n=!1,r=!1;const a=ld;a.length=0;return(s||i)&&(t=>{for(let e=0;e<t.length;e++){const o=t[e];if(o.visibleThisFrame){const t=i&&o.castShadows,e=s&&!!o.cookie;n||=t,r||=e,(t||e)&&a.push(o)}}})(t),a.sort(((t,e)=>e.maxScreenSize-t.maxScreenSize)),n&&this.allocateShadowAtlas(this.shadowAtlasResolution,e.shadowType),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(n||r)&&this.subdivide(a.length,e),a}setupSlot(t,e){t.atlasViewport.copy(e);const s=t.numShadowFaces;for(let i=0;i<s;i++)if(t.castShadows||t._cookie){if(cd.copy(e),dd.copy(e),2===t._type&&cd.add(this.scissorVec),1===t._type){const t=cd.z/3,e=this.cubeSlotsOffsets[i];cd.x+=t*e.x,cd.y+=t*e.y,cd.z=t,cd.w=t,dd.copy(cd)}if(t.castShadows){const e=t.getRenderData(null,i);e.shadowViewport.copy(cd),e.shadowScissor.copy(dd)}}}assignSlot(t,e,s){t.atlasViewportAllocated=!0;const i=this.slots[e];i.lightId=t.id,i.used=!0,s&&(t.atlasSlotUpdated=!0,t.atlasVersion=this.version,t.atlasSlotIndex=e)}update(t,e){this.shadowAtlasResolution=e.shadowAtlasResolution,this.cookieAtlasResolution=e.cookieAtlasResolution;const s=this.collectLights(t,e);if(s.length>0){const t=this.slots;for(let e=0;e<t.length;e++)t[e].used=!1;const e=Math.min(s.length,t.length);for(let i=0;i<e;i++){const e=s[i];e.castShadows&&(e._shadowMap=this.shadowAtlas);const n=t[e.atlasSlotIndex];if(e.atlasVersion===this.version&&e.id===n?.lightId){const s=t[e.atlasSlotIndex];s.size!==t[i].size||s.used||this.assignSlot(e,e.atlasSlotIndex,!1)}}let i=0;for(let n=0;n<e;n++){for(;i<t.length&&t[i].used;)i++;const e=s[n];e.atlasViewportAllocated||this.assignSlot(e,i,!0);const r=t[e.atlasSlotIndex];this.setupSlot(e,r.rect)}}this.updateUniforms()}}const pd=[];pd[0]={src:1,dst:1,op:2},pd[3]={src:1,dst:0,op:0},pd[2]={src:6,dst:8,op:0,alphaSrc:1},pd[4]={src:1,dst:8,op:0},pd[1]={src:1,dst:1,op:0},pd[6]={src:6,dst:1,op:0},pd[7]={src:4,dst:2,op:0},pd[8]={src:5,dst:1,op:0},pd[5]={src:4,dst:0,op:0},pd[9]={src:1,dst:1,op:3},pd[10]={src:1,dst:1,op:4};let md=0;class _d{constructor(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=md++,this.variants=new Map,this.defines=new Map,this._definesDirty=!1,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Sn,this._depthState=new Tn,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._shaderChunks=null,this._oldChunks={},this._dirtyShader=!0,this._shaderVersion=0,this._scene=null,this.dirty=!0}get hasShaderChunks(){return null!=this._shaderChunks}get shaderChunks(){return this._shaderChunks||(this._shaderChunks=new Ch),this._shaderChunks}getShaderChunks(t=Ai){const e=this.shaderChunks;return t===Ai?e.glsl:e.wgsl}set shaderChunksVersion(t){this.shaderChunks.version=t}get shaderChunksVersion(){return this.shaderChunks.version}set chunks(t){this._oldChunks=t}get chunks(){return Object.assign(this._oldChunks,Object.fromEntries(this.shaderChunks.glsl)),this._oldChunks}set depthBias(t){this._depthState.depthBias=t}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(t){this._depthState.depthBiasSlope=t}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(t){this._blendState.redWrite=t}get redWrite(){return this._blendState.redWrite}set greenWrite(t){this._blendState.greenWrite=t}get greenWrite(){return this._blendState.greenWrite}set blueWrite(t){this._blendState.blueWrite=t}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(t){this._blendState.alphaWrite=t}get alphaWrite(){return this._blendState.alphaWrite}get transparent(){return this._blendState.blend}_updateTransparency(){const t=this.transparent,e=this.meshInstances;for(let s=0;s<e.length;s++)e[s].transparent=t}set blendState(t){this._blendState.copy(t),this._updateTransparency()}get blendState(){return this._blendState}set blendType(t){const e=pd[t];this._blendState.setColorBlend(e.op,e.src,e.dst),this._blendState.setAlphaBlend(e.alphaOp??e.op,e.alphaSrc??e.src,e.alphaDst??e.dst);const s=3!==t;this._blendState.blend!==s&&(this._blendState.blend=s,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return 3;const{colorOp:t,colorSrcFactor:e,colorDstFactor:s,alphaOp:i,alphaSrcFactor:n,alphaDstFactor:r}=this._blendState;for(let a=0;a<pd.length;a++){const o=pd[a];if(o.src===e&&o.dst===s&&o.op===t&&o.src===n&&o.dst===r&&o.op===i)return a}return 2}set depthState(t){this._depthState.copy(t)}get depthState(){return this._depthState}set depthTest(t){this._depthState.test=t}get depthTest(){return this._depthState.test}set depthFunc(t){this._depthState.func=t}get depthFunc(){return this._depthState.func}set depthWrite(t){this._depthState.write=t}get depthWrite(){return this._depthState.write}copy(t){this.name=t.name,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this._blendState.copy(t._blendState),this._depthState.copy(t._depthState),this.cull=t.cull,this.stencilFront=t.stencilFront?.clone(),t.stencilBack&&(this.stencilBack=t.stencilFront===t.stencilBack?this.stencilFront:t.stencilBack.clone()),this.clearParameters();for(const e in t.parameters)t.parameters.hasOwnProperty(e)&&this._setParameterSimple(e,t.parameters[e].data);return this.defines.clear(),t.defines.forEach(((t,e)=>this.defines.set(e,t))),this._shaderChunks=t.hasShaderChunks?new Ch:null,this._shaderChunks?.copy(t._shaderChunks),this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].updateKey()}updateUniforms(t,e){this._dirtyShader&&this.clearVariants()}getShaderVariant(t){}update(){if(Object.keys(this._oldChunks).length>0)for(const[t,e]of Object.entries(this._oldChunks))this.shaderChunks.glsl.set(t,e),delete this._oldChunks[t];(this._definesDirty||this._shaderChunks?.isDirty())&&(this._definesDirty=!1,this._shaderChunks?.resetDirty(),this.clearVariants()),this.dirty=!0}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();const t=this.meshInstances,e=t.length;for(let s=0;s<e;s++)t[s].clearShaders()}getParameter(t){return this.parameters[t]}_setParameterSimple(t,e){const s=this.parameters[t];s?s.data=e:this.parameters[t]={scopeId:null,data:e}}setParameter(t,e){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}this._setParameterSimple(t,e)}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;void 0===e&&(e=s);for(const i in e){const e=s[i];e&&(e.scopeId||(e.scopeId=t.scope.resolve(i)),e.scopeId.setValue(e.data))}}setDefine(t,e){let s=!1;const{defines:i}=this;void 0!==e&&!1!==e?(s=!i.has(t)||i.get(t)!==e,i.set(t,e)):(s=i.has(t),i.delete(t)),this._definesDirty||=s}getDefine(t){return this.defines.has(t)}destroy(){this.variants.clear();for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];if(e.clearShaders(),e._material=null,e.mesh){const t=Xh(e.mesh.device);this!==t&&(e.material=t)}}this.meshInstances.length=0}addMeshInstanceRef(t){this.meshInstances.push(t)}removeMeshInstanceRef(t){const e=this.meshInstances,s=e.indexOf(t);-1!==s&&e.splice(s,1)}}class gd{constructor(){this.cache=new Map}destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach((t=>{t.forEach((t=>{t.destroy()}))})),this.cache.clear()}getKey(t){return`${1===t._type}-${t._shadowType}-${t._shadowResolution}`}get(t,e){const s=this.getKey(e),i=this.cache.get(s);if(i&&i.length)return i.pop();const n=od.create(t,e);return n.cached=!0,n}add(t,e){const s=this.getKey(t),i=this.cache.get(s);i?i.push(e):this.cache.set(s,[e])}}class vd extends Ao{constructor(t,e,s,i,n){super(t),this.requiresCubemaps=!1,this.shadowRenderer=e,this.light=s,this.face=i,this.applyVsm=n,this.shadowCamera=e.prepareFace(s,null,i),e.setupRenderPass(this,this.shadowCamera,!0)}execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}}class bd{constructor(t,e){this.shadowLights=[],this.renderer=t,this.shadowRenderer=e,this.device=t.device}cull(t,e,s=null){const i=this.renderer.scene.clusteredLightingEnabled;t.visibleThisFrame=!0,i||t._shadowMap||(t._shadowMap=od.create(this.device,t));const n=t._type,r=2===n?1:6;for(let a=0;a<r;a++){const r=t.getRenderData(null,a),o=r.shadowCamera;o.nearClip=t.attenuationEnd/1e3,o.farClip=t.attenuationEnd;const l=o._node,h=t._node;if(l.setPosition(h.getPosition()),2===n)o.fov=2*t._outerConeAngle,l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);else if(1===n)if(i){const e=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*t.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;o.fov=Math.atan(1+e)*Qe.RAD_TO_DEG*2}else o.fov=90;this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(e,t,r.visibleCasters,o,s)}}prepareLights(t,e){let s;for(let i=0;i<e.length;i++){const n=e[i];if(this.shadowRenderer.needsShadowRendering(n)&&n.atlasViewportAllocated){t.push(n);for(let t=0;t<n.numShadowFaces;t++)s=this.shadowRenderer.prepareFace(n,null,t)}}return s}buildNonClusteredRenderPasses(t,e){for(let s=0;s<e.length;s++){const i=e[s];if(this.shadowRenderer.needsShadowRendering(i)){const e=2===i._type,s=i.numShadowFaces;for(let n=0;n<s;n++){const s=new vd(this.device,this.shadowRenderer,i,n,e);t.addRenderPass(s)}}}}}class yd extends Ao{constructor(t,e,s,i,n){super(t),this.shadowRenderer=e,this.light=s,this.camera=i,this.allCascadesRendering=n}execute(){const{light:t,camera:e,shadowRenderer:s,allCascadesRendering:i}=this,n=t.numShadowFaces,r=t.shadowUpdateOverrides;for(let a=0;a<n;a++)0!==r?.[a]&&s.renderFace(t,e,a,!i),1===r?.[a]&&(r[a]=0)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}}const Sd=new Ss,xd=new rs,wd=new ps,Td=[new rs,new rs,new rs,new rs,new rs,new rs,new rs,new rs],Ed={min:0,max:0};function Cd(t,e,s){Td[0].x=Td[1].x=Td[2].x=Td[3].x=e.x,Td[1].y=Td[3].y=Td[7].y=Td[5].y=e.y,Td[2].z=Td[3].z=Td[6].z=Td[7].z=e.z,Td[4].x=Td[5].x=Td[6].x=Td[7].x=s.x,Td[0].y=Td[2].y=Td[4].y=Td[6].y=s.y,Td[0].z=Td[1].z=Td[4].z=Td[5].z=s.z;let i=9999999999,n=-9999999999;for(let e=0;e<8;++e){t.transformPoint(Td[e],Td[e]);const s=Td[e].z;s<i&&(i=s),s>n&&(n=s)}return Ed.min=i,Ed.max=n,Ed}class Ad{constructor(t,e){this.renderer=t,this.shadowRenderer=e,this.device=t.device}cull(t,e,s,i=null){t.visibleThisFrame=!0,t._shadowMap||(t._shadowMap=od.create(this.device,t));const n=s._nearClip;this.generateSplitDistances(t,n,Math.min(s._farClip,t.shadowDistance));const r=t.shadowUpdateOverrides;for(let a=0;a<t.numCascades&&0!==r?.[a];a++){const r=t.getRenderData(s,a),o=r.shadowCamera;o.renderTarget=t._shadowMap.renderTargets[0],r.shadowViewport.copy(t.cascades[a]),r.shadowScissor.copy(t.cascades[a]);const l=o._node,h=t._node;l.setPosition(h.getPosition()),l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);const c=0===a?n:t._shadowCascadeDistances[a-1],d=t._shadowCascadeDistances[a],u=s.getFrustumCorners(c,d);xd.set(0,0,0);const f=s.node.getWorldTransform();for(let t=0;t<8;t++)f.transformPoint(u[t],u[t]),xd.add(u[t]);xd.mulScalar(1/8);let p=0;for(let t=0;t<8;t++){const e=u[t].sub(xd).length();e>p&&(p=e)}const m=l.right,_=l.up,g=l.forward,v=.25*t._shadowResolution/p,b=Math.ceil(xd.dot(_)*v)/v,y=Math.ceil(xd.dot(m)*v)/v,S=_.mulScalar(b),x=m.mulScalar(y),w=xd.dot(g),T=g.mulScalar(w);xd.add2(S,x).add(T),l.setPosition(xd),l.translateLocal(0,0,1e6),o.nearClip=.01,o.farClip=2e6,o.orthoHeight=p,this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(e,t,r.visibleCasters,o,i);const E=1<<a,C=r.visibleCasters,A=C.length;let D=0;for(let t=0;t<A;t++){const e=C[t];e.shadowCascadeMask&E&&(C[D++]=e,1===D?Sd.copy(e.aabb):Sd.add(e.aabb))}A!==D&&(C.length=D),wd.copy(l.getWorldTransform()).invert();const P=Cd(wd,Sd.getMin(),Sd.getMax());l.translateLocal(0,0,P.max+.1),o.farClip=P.max-P.min+.2,r.projectionCompensation=p}}generateSplitDistances(t,e,s){t._shadowCascadeDistances.fill(s);for(let i=1;i<t.numCascades;i++){const n=i/t.numCascades,r=e+(s-e)*n,a=e*(s/e)**n,o=Qe.lerp(r,a,t.cascadeDistribution);t._shadowCascadeDistances[i-1]=o}}getLightRenderPass(t,e){let s=null;if(this.shadowRenderer.needsShadowRendering(t)){const i=t.numShadowFaces,n=t.shadowUpdateOverrides;let r,a=!0;for(let s=0;s<i;s++)0===n?.[s]&&(a=!1),r=this.shadowRenderer.prepareFace(t,e,s);s=new yd(this.device,this.shadowRenderer,t,e,a),this.shadowRenderer.setupRenderPass(s,r,a)}return s}}const Dd=new Set,Pd=new ps,Ld=new ps,Id=new Float32Array(2),Rd=new ls(1,1,0,0),Md=new ps;function kd(t,e){return Math.exp(-t*t/(2*e*e))}class Od{constructor(t,e){this.shadowPassCache=[],this.device=t.device,this.renderer=t,this.lightTextureAtlas=e;const s=this.device.scope;this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Sn,this.blendStateNoWrite=new Sn,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}static createShadowCamera(t,e,s){const i=Nc.create("ShadowCamera",e,s),n=Ll.get(t),r=n?.vsm??!1,a=n?.pcf??!1;return i.clearColor=r?new Ze(0,0,0,0):new Ze(1,1,1,1),i.clearDepthBuffer=!0,i.clearStencilBuffer=!1,i.clearColorBuffer=!a,i}_cullShadowCastersInternal(t,e,s){const i=t.length;for(let n=0;n<i;n++){const i=t[n];i.castShadow&&(i.cull&&!i._isVisible(s)||(i.visibleThisFrame=!0,e.push(i)))}}cullShadowCasters(t,e,s,i,n){if(this.renderer.scene?.fire(mh,i),s.length=0,n)this._cullShadowCastersInternal(n,s,i);else{const n=t.layerList,r=n.length;for(let t=0;t<r;t++){const r=n[t];r._lightsSet.has(e)&&(Dd.has(r)||(Dd.add(r),this._cullShadowCastersInternal(r.shadowCasters,s,i)))}Dd.clear()}s.sort(this.sortCompareShader),this.renderer.scene?.fire(_h,i)}sortCompareShader(t,e){const s=t._sortKeyShadow,i=e._sortKeyShadow;return s===i?e.mesh.id-t.mesh.id:i-s}setupRenderState(t,e){const s=this.renderer.scene.clusteredLightingEnabled?e._isPcf:e._isPcf&&1!==e._type;t.setBlendState(s?this.blendStateNoWrite:this.blendStateWrite),t.setDepthState(e.shadowDepthState),t.setStencilState(null,null)}dispatchUniforms(t,e,s,i){const n=e._node;0!==t._type&&(this.renderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(t.attenuationEnd)),Pd.setTRS(n.getPosition(),n.getRotation(),rs.ONE).invert(),Ld.mul2(e.projectionMatrix,Pd);const r=s.shadowViewport;e.rect=r,e.scissorRect=s.shadowScissor,Md.setViewport(r.x,r.y,r.z,r.w),s.shadowMatrix.mul2(Md,Ld),0===t._type&&t._shadowMatrixPalette.set(s.shadowMatrix.data,16*i)}getShadowPass(t){const e=t._type,s=t._shadowType;let i=this.shadowPassCache[e]?.[s];if(!i){const t=`ShadowPass_${e}_${s}`;i=wh.get(this.device).allocate(t,{isShadow:!0,lightType:e,shadowType:s}),this.shadowPassCache[e]||(this.shadowPassCache[e]=[]),this.shadowPassCache[e][s]=i}return i.index}submitCasters(t,e,s){const i=this.device,n=this.renderer,r=n.scene,a=this.getShadowPass(e),o=s.shaderParams,l=s.renderTarget.flipY?-1:1,h=t.length;for(let e=0;e<h;e++){const h=t[e],c=h.mesh,d=h.instancingData;if(d&&d.count<=0)continue;h.ensureMaterial(i);const u=h.material;n.setBaseConstants(i,u),n.setSkinning(i,h),u.dirty&&(u.updateUniforms(i,r),u.dirty=!1),n.setupCullMode(!0,l,h),u.setParameters(i),h.setParameters(i,4);const f=h.getShaderInstance(a,0,r,o,this.viewUniformFormat,this.viewBindGroupFormat),p=f.shader;if(p.failed)continue;h._sortKeyShadow=p.id,i.setShader(p),n.setVertexBuffers(i,c),n.setMorphing(i,h.morphInstance),d&&i.setVertexBuffer(d.vertexBuffer),n.setMeshInstanceMatrices(h),n.setupMeshUniformBuffers(f);const m=h.renderStyle,_=h.indirectData?.get(s);i.draw(c.primitive[m],c.indexBuffer[m],d?.count,_),n._shadowDrawCalls++,d&&n._instancedDrawCalls++}}needsShadowRendering(t){const e=t.enabled&&t.castShadows&&0!==t.shadowUpdateMode&&t.visibleThisFrame;return 1===t.shadowUpdateMode&&(t.shadowUpdateMode=0),e&&(this.renderer._shadowMapUpdates+=t.numShadowFaces),e}getLightRenderData(t,e,s){return t.getRenderData(0===t._type?e:null,s)}setupRenderPass(t,e,s){const i=e.renderTarget;t.init(i),t.depthStencilOps.clearDepthValue=1,t.depthStencilOps.clearDepth=s,i.depthBuffer?t.depthStencilOps.storeDepth=!0:(t.colorOps.clearValue.copy(e.clearColor),t.colorOps.clear=s,t.depthStencilOps.storeDepth=!1),t.requiresCubemaps=!1}prepareFace(t,e,s){const i=t._type,n=this.getLightRenderData(t,e,s).shadowCamera,r=0===i?0:s;return n.renderTarget=t._shadowMap.renderTargets[r],n}renderFace(t,e,s,i,n=!0){const r=this.device,a=this.getLightRenderData(t,e,s),o=a.shadowCamera;this.dispatchUniforms(t,o,a,s);const l=o.renderTarget,h=this.renderer;h.setCameraUniforms(o,l),r.supportsUniformBuffers&&h.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,null),n?(h.setupViewport(o,l),i&&h.clear(o)):h.clearView(o,l,!0,!1),this.setupRenderState(r,t),this.submitCasters(a.visibleCasters,t,o)}render(t,e,s=!0){if(this.needsShadowRendering(t)){const i=t.numShadowFaces;for(let n=0;n<i;n++)this.prepareFace(t,e,n),this.renderFace(t,e,n,!0,s);this.renderVsm(t,e)}}renderVsm(t,e){if(t._isVsm&&t._vsmBlurSize>1){this.renderer.scene.clusteredLightingEnabled&&0!==t._type||this.applyVsmBlur(t,e)}}getVsmBlurShader(t,e){const s=this.blurVsmShader;let i=s[t][e];if(!i){this.blurVsmWeights[e]=function(t){const e=(t-1)/6,s=.5*(t-1),i=new Array(t);let n=0;for(let r=0;r<t;++r)i[r]=kd(r-s,e),n+=i[r];for(let e=0;e<t;++e)i[e]/=n;return i}(e);const n=new Map;n.set("{SAMPLES}",e),1===t&&n.set("GAUSS",""),i=Ph.createShader(this.device,{uniqueName:`blurVsm${t}${e}`,attributes:{vertex_position:$s},vertexChunk:"fullscreenQuadVS",fragmentChunk:"blurVSMPS",fragmentDefines:n}),s[t][e]=i}return i}applyVsmBlur(t,e){const s=this.device;s.setBlendState(Sn.NOBLEND);const i=t.getRenderData(0===t._type?e:null,0).shadowCamera.renderTarget,n=this.renderer.shadowMapCache.get(s,t),r=n.renderTargets[0],a=t.vsmBlurMode,o=t._vsmBlurSize,l=this.getVsmBlurShader(a,o);Rd.z=t._shadowResolution-2,Rd.w=Rd.z,this.sourceId.setValue(i.colorBuffer),Id[0]=1/t._shadowResolution,Id[1]=0,this.pixelOffsetId.setValue(Id),1===a&&this.weightId.setValue(this.blurVsmWeights[o]),Nh(s,r,l,null,Rd),this.sourceId.setValue(r.colorBuffer),Id[1]=Id[0],Id[0]=0,this.pixelOffsetId.setValue(Id),Nh(s,i,l,null,Rd),this.renderer.shadowMapCache.add(t,n)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Er(this.device,[new Tr("matrix_viewProjection",Li)]),this.viewBindGroupFormat=new on(this.device,[new sn(Xi,3)]))}frameUpdate(){this.initViewBindGroupFormat()}}const Fd=[];class Nd{constructor(t){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=t}destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach((t=>{t.destroy()})),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){const t=new Zc(this.device);t.name="ClusterEmpty",t.update([]),this._empty=t}return this._empty}assign(t){const e=this.empty;Fd.push(...this._allocated),this._allocated.length=0,this._clusters.clear();const s=t.length;for(let i=0;i<s;i++){const s=t[i].renderActions;if(s){const t=s.length;for(let i=0;i<t;i++){const t=s[i];t.lightClusters=null;const n=t.layer;if(n.hasClusteredLights&&n.meshInstances.length){const e=n.getLightIdHash(),s=this._clusters.get(e);let i=s?.lightClusters;i||(i=Fd.pop()??new Zc(this.device),this._allocated.push(i),this._clusters.set(e,t)),t.lightClusters=i}t.lightClusters||(t.lightClusters=e)}}}Fd.forEach((t=>t.destroy())),Fd.length=0}update(t,e){this.assign(t),this._clusters.forEach((t=>{const s=t.layer;t.lightClusters.update(s.clusteredLightsSet,e)}))}}const Bd=new ls,Ud=[];class zd extends Ao{constructor(t,e){super(t),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._forceCopy=!1,this._evtDeviceRestored=null,this._cubeSlotsOffsets=e,this.requiresCubemaps=!1,this.blitTextureId=t.scope.resolve("blitTexture"),this.invViewProjId=t.scope.resolve("invViewProj"),this._evtDeviceRestored=t.on("devicerestored",this.onDeviceRestored,this)}destroy(){this._quadRenderer2D?.destroy(),this._quadRenderer2D=null,this._quadRendererCube?.destroy(),this._quadRendererCube=null,this._evtDeviceRestored?.off(),this._evtDeviceRestored=null}static create(t,e){const s=new zd(t.device,e);return s.init(t),s.colorOps.clear=!1,s.depthStencilOps.clearDepth=!1,s}onDeviceRestored(){this._forceCopy=!0}update(t){const e=this._filteredLights;this.filter(t,e),this.executeEnabled=e.length>0}filter(t,e){for(let s=0;s<t.length;s++){const i=t[s];0!==i._type&&(i.atlasViewportAllocated&&(i.atlasSlotUpdated||this._forceCopy)&&i.enabled&&i.cookie&&i.visibleThisFrame&&e.push(i))}this._forceCopy=!1}initInvViewProjMatrices(){if(!Ud.length)for(let t=0;t<6;t++){const e=Nc.create(null,1,t),s=e.projectionMatrix,i=e.node.getLocalTransform().clone().invert();Ud[t]=(new ps).mul2(s,i).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){const t=Ph.createShader(this.device,{uniqueName:"cookieRenderer2d",attributes:{vertex_position:$s},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlit2DPS"});this._quadRenderer2D=new kh(t)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){const t=Ph.createShader(this.device,{uniqueName:"cookieRendererCube",attributes:{vertex_position:$s},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlitCubePS"});this._quadRendererCube=new kh(t)}return this._quadRendererCube}execute(){const t=this.device;t.setBlendState(Sn.NOBLEND),t.setCullMode(0),t.setDepthState(Tn.NODEPTH),t.setStencilState();const e=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,i=this._filteredLights;for(let t=0;t<i.length;t++){const n=i[t],r=n.numShadowFaces,a=r>1?this.quadRendererCube:this.quadRenderer2D;r>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(n.cookie);for(let t=0;t<r;t++){if(Bd.copy(n.atlasViewport),r>1){const e=Bd.z/3,i=s[t];Bd.x+=e*i.x,Bd.y+=e*i.y,Bd.z=e,Bd.w=e,this.invViewProjId.setValue(Ud[t].data)}Bd.mulScalar(e),a.render(Bd)}}i.length=0}}class Vd extends Ao{constructor(t,e,s){super(t),this.requiresCubemaps=!1,this.shadowRenderer=e,this.shadowRendererLocal=s}update(t){const e=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(e,t),i=e.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,s,!1)}execute(){const t=this.shadowRendererLocal.shadowLights,e=t.length;for(let s=0;s<e;s++){const e=t[s];for(let t=0;t<e.numShadowFaces;t++)this.shadowRenderer.renderFace(e,null,t,!0)}t.length=0}}class Hd extends Ao{constructor(t,e,s,i,n){super(t),this.renderer=e,this.frameGraph=null,this.cookiesRenderPass=zd.create(n.cookieRenderTarget,n.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new Vd(t,s,i),this.beforePasses.push(this.shadowRenderPass)}update(t,e,s,i,n){this.frameGraph=t,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=e,e&&this.shadowRenderPass.update(n)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){const{renderer:t}=this,{scene:e}=t;t.worldClustersAllocator.update(this.frameGraph.renderPasses,e.lighting)}}let Gd=0;const Wd=new ps,jd=new ps,Xd=new ps,$d=new as,qd=new Ts,Kd=(new ps).setScale(1,-1,1),Yd=new Set,Qd=new Set,Zd=new gn,Jd=(new ps).set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),tu=[new os(.5,.333333),new os(.25,.666667),new os(.75,.111111),new os(.125,.444444),new os(.625,.777778),new os(.375,.222222),new os(.875,.555556),new os(.0625,.888889),new os(.5625,.037037),new os(.3125,.37037),new os(.8125,.703704),new os(.1875,.148148),new os(.6875,.481481),new os(.4375,.814815),new os(.9375,.259259),new os(.03125,.592593)],eu=new ps,su=new ps,iu=new ps,nu=new ps,ru=new ps,au=new ps,ou=new Set,lu=[],hu=[];class cu{constructor(t){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new sd(123),this.device=t,this.scene=null,this.worldClustersAllocator=new Nd(t),this.lightTextureAtlas=new fd(t),this.shadowMapCache=new gd,this.shadowRenderer=new Od(this,this.lightTextureAtlas),this._shadowRendererLocal=new bd(this,this.shadowRenderer),this._shadowRendererDirectional=new Ad(this,this.shadowRenderer),this._renderPassUpdateClustered=new Hd(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;const e=t.scope;this.boneTextureId=e.resolve("texture_poseMap"),this.modelMatrixId=e.resolve("matrix_model"),this.normalMatrixId=e.resolve("matrix_normal"),this.viewInvId=e.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=e.resolve("view_position"),this.projId=e.resolve("matrix_projection"),this.projSkyboxId=e.resolve("matrix_projectionSkybox"),this.viewId=e.resolve("matrix_view"),this.viewId3=e.resolve("matrix_view3"),this.viewProjId=e.resolve("matrix_viewProjection"),this.flipYId=e.resolve("projectionFlipY"),this.tbnBasis=e.resolve("tbnBasis"),this.nearClipId=e.resolve("camera_near"),this.farClipId=e.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=e.resolve("camera_params"),this.viewIndexId=e.resolve("view_index"),this.viewIndexId.setValue(0),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new ls,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=e.resolve("blueNoiseJitter"),this.blueNoiseTextureId=e.resolve("blueNoiseTex32"),this.alphaTestId=e.resolve("alpha_ref"),this.opacityMapId=e.resolve("texture_opacityMap"),this.exposureId=e.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=e.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=e.resolve("morphPositionTex"),this.morphNormalTex=e.resolve("morphNormalTex"),this.morphTexParams=e.resolve("morph_tex_params"),this.lightCube=new nd,this.constantLightCube=e.resolve("lightCube[0]")}destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}setupViewport(t,e){const s=this.device,i=e?e.width:s.width,n=e?e.height:s.height,r=t.rect;let a=Math.floor(r.x*i),o=Math.floor(r.y*n),l=Math.floor(r.z*i),h=Math.floor(r.w*n);if(s.setViewport(a,o,l,h),t._scissorRectClear){const e=t.scissorRect;a=Math.floor(e.x*i),o=Math.floor(e.y*n),l=Math.floor(e.z*i),h=Math.floor(e.w*n)}s.setScissor(a,o,l,h)}setCameraUniforms(t,e){const s=e?.flipY;let i=null;if(t.xr&&t.xr.session){const e=t._node?.parent?.getWorldTransform()||null;i=t.xr.views.list;for(let s=0;s<i.length;s++){const n=i[s];n.updateTransforms(e),t.frustum.setFromMat4(n.projViewOffMat)}}else{let i=t.projectionMatrix;t.calculateProjection&&t.calculateProjection(i,0);let n=t.getProjectionMatrixSkybox();s&&(i=eu.mul2(Kd,i),n=su.mul2(Kd,n)),this.device.isWebGPU&&(i=iu.mul2(Jd,i),n=nu.mul2(Jd,n));const{jitter:r}=t;let a=0,o=0;if(r>0){const t=e?e.width:this.device.width,s=e?e.height:this.device.height,l=tu[this.device.renderVersion%tu.length];a=r*(2*l.x-1)/t,o=r*(2*l.y-1)/s,i=ru.copy(i),i.data[8]=a,i.data[9]=o,n=au.copy(n),n.data[8]=a,n.data[9]=o,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec))}const l=r>0?this.blueNoiseJitterVec:ls.ZERO;if(this.blueNoiseJitterData[0]=l.x,this.blueNoiseJitterData[1]=l.y,this.blueNoiseJitterData[2]=l.z,this.blueNoiseJitterData[3]=l.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(i.data),this.projSkyboxId.setValue(n.data),t.calculateTransform)t.calculateTransform(jd,0);else{const e=t._node.getPosition(),s=t._node.getRotation();jd.setTRS(e,s,rs.ONE)}this.viewInvId.setValue(jd.data),Xd.copy(jd).invert(),this.viewId.setValue(Xd.data),$d.setFromMat4(Xd),this.viewId3.setValue($d.data),Wd.mul2(i,Xd),this.viewProjId.setValue(Wd.data),t._storeShaderMatrices(Wd,a,o,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(t._node.getPosition()),t.frustum.setFromMat4(Wd)}this.tbnBasis.setValue(s?-1:1);const n=t._nearClip,r=t._farClip;return this.nearClipId.setValue(n),this.farClipId.setValue(r),this.cameraParams[0]=1/r,this.cameraParams[1]=r,this.cameraParams[2]=n,this.cameraParams[3]=1===t.projection?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?t.getExposure():this.scene.exposure),i}clear(t,e,s,i){const n=(e??t._clearColorBuffer?1:0)|(s??t._clearDepthBuffer?2:0)|(i??t._clearStencilBuffer?4:0);if(n){this.device.clear({color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,stencil:t._clearStencil,flags:n})}}setCamera(t,e,s,i=null){this.setCameraUniforms(t,e),this.clearView(t,e,s,!1)}clearView(t,e,s,i){const n=this.device;if(n.setRenderTarget(e),n.updateBegin(),i&&(n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0)),this.setupViewport(t,e),s){const e=t._clearOptions;n.clear(e||{color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,flags:(t._clearColorBuffer?1:0)|(t._clearDepthBuffer?2:0)|(t._clearStencilBuffer?4:0),stencil:t._clearStencil})}}setupCullMode(t,e,s){const i=s.material;let n=0;if(t){let t=1;2!==i.cull&&1!==i.cull||(t=e*s.flipFacesFactor*s.node.worldScaleSign),n=t<0?2===i.cull?1:2:i.cull}this.device.setCullMode(n),0===n&&0===i.cull&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(t){if(t.xr&&t.xr.views.list.length){const e=t.xr.views.list[0];return Wd.mul2(e.projMat,e.viewOffMat),void t.frustum.setFromMat4(Wd)}const e=t.projectionMatrix;if(t.calculateProjection&&t.calculateProjection(e,0),t.calculateTransform)t.calculateTransform(jd,0);else{const e=t._node.getPosition(),s=t._node.getRotation();jd.setTRS(e,s,rs.ONE),this.viewInvId.setValue(jd.data)}Xd.copy(jd).invert(),Wd.mul2(e,Xd),t.frustum.setFromMat4(Wd)}setBaseConstants(t,e){t.setCullMode(e.cull),e.opacityMap&&this.opacityMapId.setValue(e.opacityMap),(e.opacityMap||e.alphaTest>0)&&this.alphaTestId.setValue(e.alphaTest)}updateCpuSkinMatrices(t){Gd++;const e=t.length;if(0!==e)for(let s=0;s<e;s++){const e=t[s].skinInstance;e&&(e.updateMatrices(t[s].node,Gd),e._dirty=!0)}}updateGpuSkinMatrices(t){for(const e of t){const t=e.skinInstance;t&&t._dirty&&(t.updateMatrixPalette(e.node,Gd),t._dirty=!1)}}updateMorphing(t){for(const e of t){const t=e.morphInstance;t&&t._dirty&&t.update()}}updateGSplats(t){for(const e of t)e.gsplatInstance?.update()}gpuUpdate(t){this.updateGpuSkinMatrices(t),this.updateMorphing(t),this.updateGSplats(t)}setVertexBuffers(t,e){t.setVertexBuffer(e.vertexBuffer)}setMorphing(t,e){e&&(e.prepareRendering(t),t.setVertexBuffer(e.morph.vertexBufferIds),this.morphPositionTex.setValue(e.texturePositions),this.morphNormalTex.setValue(e.textureNormals),this.morphTexParams.setValue(e._textureParams))}setSkinning(t,e){const s=e.skinInstance;if(s){this._skinDrawCalls++;const t=s.boneTexture;this.boneTextureId.setValue(t)}}dispatchViewPos(t){const e=this.viewPos;e[0]=t.x,e[1]=t.y,e[2]=t.z,this.viewPosId.setValue(e)}initViewBindGroupFormat(t){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){const e=[new Tr("matrix_view",Li),new Tr("matrix_viewInverse",Li),new Tr("matrix_projection",Li),new Tr("matrix_projectionSkybox",Li),new Tr("matrix_viewProjection",Li),new Tr("matrix_view3",Pi),new Tr("cubeMapRotationMatrix",Pi),new Tr("view_position",4),new Tr("skyboxIntensity",2),new Tr("exposure",2),new Tr("textureBias",2),new Tr("view_index",2)];t&&e.push(new Tr("clusterCellsCountByBoundsSize",4),new Tr("clusterTextureSize",4),new Tr("clusterBoundsMin",4),new Tr("clusterBoundsDelta",4),new Tr("clusterCellsDot",4),new Tr("clusterCellsMax",4),new Tr("shadowAtlasParams",3),new Tr("clusterMaxCells",1),new Tr("clusterSkip",2)),this.viewUniformFormat=new Er(this.device,e);const s=[new sn(Xi,3)];this.viewBindGroupFormat=new on(this.device,s)}}setupViewUniforms(t,e){this.projId.setValue(t.projMat.data),this.projSkyboxId.setValue(t.projMat.data),this.viewId.setValue(t.viewOffMat.data),this.viewInvId.setValue(t.viewInvOffMat.data),this.viewId3.setValue(t.viewMat3.data),this.viewProjId.setValue(t.projViewOffMat.data),this.viewPosId.setValue(t.positionData),this.viewIndexId.setValue(e)}setupViewUniformBuffers(t,e,s,i){const{device:n}=this,r=i?.length??1;for(;t.length<r;){const i=new Na(n,e,!1),r=new vn(n,s,i);t.push(r)}if(i)for(let e=0;e<r;e++){const s=i[e];this.setupViewUniforms(s,e);const n=t[e];n.defaultUniformBuffer.update(),n.update()}else{const e=t[0];e.defaultUniformBuffer.update(),e.update()}i||n.setBindGroup(0,t[0])}setupMeshUniformBuffers(t){const e=this.device;if(e.supportsUniformBuffers){const s=t.getBindGroup(e);s.update(),e.setBindGroup(1,s);t.getUniformBuffer(e).update(Zd),e.setBindGroup(2,Zd.bindGroup,Zd.offsets)}}setMeshInstanceMatrices(t,e=!1){const s=t.node.worldTransform;this.modelMatrixId.setValue(s.data),e&&this.normalMatrixId.setValue(t.node.normalMatrix.data)}cull(t,e,s){const i=s.opaque;i.length=0;const n=s.transparent;n.length=0;const r=t.frustumCulling,a=e.length;for(let s=0;s<a;s++){const a=e[s];if(a.visible){if(!r||!a.cull||a._isVisible(t)){a.visibleThisFrame=!0;(a.transparent?n:i).push(a),(a.skinInstance||a.morphInstance||a.gsplatInstance)&&(this.processingMeshInstances.add(a),a.gsplatInstance&&a.gsplatInstance.cameras.push(t))}}}}collectLights(t){this.lights.length=0,this.localLights.length=0;const e=this.scene._stats,s=t.layerList.length;for(let e=0;e<s;e++){const s=t.layerList[e];if(!Qd.has(s)){Qd.add(s);const t=s._lights;for(let e=0;e<t.length;e++){const s=t[e];Yd.has(s)||(Yd.add(s),this.lights.push(s),0!==s._type&&this.localLights.push(s))}}}e.lights=this.lights.length,Yd.clear(),Qd.clear()}cullLights(t,e){const s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits;for(let n=0;n<e.length;n++){const r=e[n];if(r.enabled)if(0!==r._type)if(r.getBoundingSphere(qd),t.frustum.containsSphere(qd)){r.visibleThisFrame=!0,r.usePhysicalUnits=i;const e=t.getScreenSize(qd);r.maxScreenSize=Math.max(r.maxScreenSize,e)}else s||r.castShadows&&!r.shadowMap&&(r.visibleThisFrame=!0);else r.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(t){const e=this.scene.clusteredLightingEnabled;for(let s=0;s<this.localLights.length;s++){const i=this.localLights[s];0!==i._type&&(e?i.atlasSlotUpdated&&0===i.shadowUpdateMode&&(i.shadowUpdateMode=1):0===i.shadowUpdateMode&&i.castShadows&&(i.getRenderData(null,0).shadowCamera.renderTarget||(i.shadowUpdateMode=1)),i.visibleThisFrame&&i.castShadows&&0!==i.shadowUpdateMode&&this._shadowRendererLocal.cull(i,t))}this.cameraDirShadowLights.clear();const s=t.cameras;for(let e=0;e<s.length;e++){const i=s[e];if(i.enabled){const e=i.camera;let s;const n=e.layers;for(let i=0;i<n.length;i++){const r=t.getLayerById(n[i]);if(r){const i=r.splitLights[0];for(let n=0;n<i.length;n++){const r=i[n];r.castShadows&&!ou.has(r)&&(ou.add(r),s=s??[],s.push(r),this._shadowRendererDirectional.cull(r,t,e))}}}s&&this.cameraDirShadowLights.set(e,s),ou.clear()}}}cullComposition(t){const{scene:e}=this;this.processingMeshInstances.clear();const s=t.cameras.length;this._camerasRendered+=s;for(let i=0;i<s;i++){const s=t.cameras[i];e?.fire(mh,s);const n=s.renderTarget;s.frameUpdate(n),this.updateCameraFrustum(s.camera);const r=s.layers;for(let e=0;e<r.length;e++){const i=t.getLayerById(r[e]);if(i&&i.enabled){this.cullLights(s.camera,i._lights);const t=i.getCulledInstances(s.camera);this.cull(s.camera,i.meshInstances,t)}}e?.fire(_h,s)}e.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(t),e?.fire("cull:end")}updateShaders(t,e){const s=t.length;for(let i=0;i<s;i++){const s=t[i].material;if(s&&!ou.has(s)&&(ou.add(s),s.getShaderVariant!==_d.prototype.getShaderVariant)){if(e&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants()}}ou.clear()}updateFrameUniforms(){this.blueNoiseTextureId.setValue(ad(this.device))}beginFrame(t){const e=this.scene,s=e.updateShaders||this.device._shadersDirty,i=t.layerList,n=i.length;for(let t=0;t<n;t++){const e=i[t].meshInstances,n=e.length;for(let t=0;t<n;t++){const i=e[t];i.visibleThisFrame=!1,s&&lu.push(i),i.skinInstance&&hu.push(i)}}if(s){const t=!e.updateShaders||!this.device._shadersDirty;this.updateShaders(lu,t),e.updateShaders=!1,this.device._shadersDirty=!1,e._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(hu),lu.length=0,hu.length=0;const r=this.lights,a=r.length;for(let t=0;t<a;t++)r[t].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(t){const e=t.layerList.length,s=this.scene._shaderVersion;for(let i=0;i<e;i++){t.layerList[i]._shaderVersion=s}t._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}}class du{constructor(){this.camera=null,this.layer=null,this.transparent=!1,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}destroy(){this.viewBindGroups.forEach((t=>{t.defaultUniformBuffer.destroy(),t.destroy()})),this.viewBindGroups.length=0}setupClears(t,e){this.clearColor=t?.clearColorBuffer||e.clearColorBuffer,this.clearDepth=t?.clearDepthBuffer||e.clearDepthBuffer,this.clearStencil=t?.clearStencilBuffer||e.clearStencilBuffer}}class uu extends Ao{constructor(t,e,s,i){super(t),this.renderActions=[],this.noDepthClear=!1,this.layerComposition=e,this.scene=s,this.renderer=i}get rendersAnything(){return this.renderActions.length>0}addRenderAction(t){this.renderActions.push(t)}addLayer(t,e,s,i=!0){const n=new du;if(n.renderTarget=this.renderTarget,n.camera=t,n.layer=e,n.transparent=s,i){const s=0===this.renderActions.length;n.setupClears(s?t:void 0,e)}this.addRenderAction(n)}addLayers(t,e,s,i,n,r=!0){const{layerList:a,subLayerList:o}=t;let l=i,h=s;for(;h<a.length;){const t=a[h],s=o[h];if(e.camera.layersSet.has(t.id)&&(this.addLayer(e,t,s,l),l=!1),h++,t.id===n&&s===r)break}return h}updateDirectionalShadows(){const{renderer:t,renderActions:e}=this;for(let s=0;s<e.length;s++){const i=e[s].camera.camera,n=this.renderer.cameraDirShadowLights.get(i);if(n)for(let e=0;e<n.length;e++){const s=n[e];if(t.dirLightShadows.get(s)!==i){t.dirLightShadows.set(s,i);const e=t._shadowRendererDirectional.getLightRenderPass(s,i);e&&this.beforePasses.push(e)}}}}updateClears(){const t=this.renderActions[0];if(t){const e=t.camera.camera,s=e.fullSizeClearRect;this.setClearColor(s&&t.clearColor?e.clearColor:void 0),this.setClearDepth(s&&t.clearDepth&&!this.noDepthClear?e.clearDepth:void 0),this.setClearStencil(s&&t.clearStencil?e.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){const{renderActions:t}=this;for(let e=0;e<t.length;e++){const s=t[e];s.firstCameraUse&&this.scene.fire(fh,s.camera)}}execute(){const{layerComposition:t,renderActions:e}=this;for(let s=0;s<e.length;s++){const i=e[s],n=i.layer;t.isEnabled(n,i.transparent)&&this.renderRenderAction(i,0===s)}}after(){for(let t=0;t<this.renderActions.length;t++){const e=this.renderActions[t];e.lastCameraUse&&this.scene.fire(ph,e.camera)}this.beforePasses.length=0}renderRenderAction(t,e){const{renderer:s,scene:i}=this,n=s.device,{layer:r,transparent:a,camera:o}=t;if(o){const l=o.gammaCorrection,h=o.toneMapping;void 0!==this.gammaCorrection&&(o.gammaCorrection=this.gammaCorrection),void 0!==this.toneMapping&&(o.toneMapping=this.toneMapping),i.fire("prerender:layer",o,r,a);const c={lightClusters:t.lightClusters},d=o.camera.shaderPassInfo?.index??0;e&&o.camera.fullSizeClearRect||(c.clearColor=t.clearColor,c.clearDepth=t.clearDepth,c.clearStencil=t.clearStencil);const u=t.renderTarget??n.backBuffer;s.renderForwardLayer(o.camera,u,r,a,d,t.viewBindGroups,c),n.setBlendState(Sn.NOBLEND),n.setStencilState(null,null),n.setAlphaToCoverage(!1),i.fire("postrender:layer",o,r,a),void 0!==this.gammaCorrection&&(o.gammaCorrection=l),void 0!==this.toneMapping&&(o.toneMapping=h)}}}class fu extends Ao{constructor(t,e,s){super(t),this.renderer=e,this.renderAction=s,this.requiresCubemaps=!1}execute(){this.renderAction.camera.onPostprocessing()}}const pu=[[],[],[]],mu=new Ze,_u={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};class gu extends cu{constructor(t){super(t);const e=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;const s=e.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.lightSoftShadowParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.shadowCascadeBlendId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=function(t){const e=[];for(let s=0;s<t;++s){const i=Math.sqrt(s+.5)/Math.sqrt(t);e.push(i)}return e}(16),this.pcssSphereSamples=function(t){const e=[];for(let s=0;s<t;s++){const i=s/t,n=Math.sqrt(i*i);e.push(n)}return e}(16)}destroy(){super.destroy()}dispatchGlobalLights(t){const e=this.ambientColor;if(mu.linear(t.ambientLight),e[0]=mu.r,e[1]=mu.g,e[2]=mu.b,t.physicalUnits)for(let s=0;s<3;s++)e[s]*=t.ambientLuminance;this.ambientId.setValue(e),this.skyboxIntensityId.setValue(t.physicalUnits?t.skyboxLuminance:t.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(t._skyboxRotationMat3.data)}_resolveLight(t,e){const s=`light${e}`;this.lightColorId[e]=t.resolve(`${s}_color`),this.lightDir[e]=new Float32Array(3),this.lightDirId[e]=t.resolve(`${s}_direction`),this.lightShadowMapId[e]=t.resolve(`${s}_shadowMap`),this.lightShadowMatrixId[e]=t.resolve(`${s}_shadowMatrix`),this.lightShadowParamsId[e]=t.resolve(`${s}_shadowParams`),this.lightShadowIntensity[e]=t.resolve(`${s}_shadowIntensity`),this.lightShadowSearchAreaId[e]=t.resolve(`${s}_shadowSearchArea`),this.lightRadiusId[e]=t.resolve(`${s}_radius`),this.lightPos[e]=new Float32Array(3),this.lightPosId[e]=t.resolve(`${s}_position`),this.lightWidth[e]=new Float32Array(3),this.lightWidthId[e]=t.resolve(`${s}_halfWidth`),this.lightHeight[e]=new Float32Array(3),this.lightHeightId[e]=t.resolve(`${s}_halfHeight`),this.lightInAngleId[e]=t.resolve(`${s}_innerConeAngle`),this.lightOutAngleId[e]=t.resolve(`${s}_outerConeAngle`),this.lightCookieId[e]=t.resolve(`${s}_cookie`),this.lightCookieIntId[e]=t.resolve(`${s}_cookieIntensity`),this.lightCookieMatrixId[e]=t.resolve(`${s}_cookieMatrix`),this.lightCookieOffsetId[e]=t.resolve(`${s}_cookieOffset`),this.lightCameraParamsId[e]=t.resolve(`${s}_cameraParams`),this.lightSoftShadowParamsId[e]=t.resolve(`${s}_softShadowParams`),this.shadowMatrixPaletteId[e]=t.resolve(`${s}_shadowMatrixPalette[0]`),this.shadowCascadeDistancesId[e]=t.resolve(`${s}_shadowCascadeDistances`),this.shadowCascadeCountId[e]=t.resolve(`${s}_shadowCascadeCount`),this.shadowCascadeBlendId[e]=t.resolve(`${s}_shadowCascadeBlend`)}setLTCDirectionalLight(t,e,s,i,n){this.lightPos[e][0]=i.x-s.x*n,this.lightPos[e][1]=i.y-s.y*n,this.lightPos[e][2]=i.z-s.z*n,this.lightPosId[e].setValue(this.lightPos[e]);const r=t.transformVector(new rs(-.5,0,0));this.lightWidth[e][0]=r.x*n,this.lightWidth[e][1]=r.y*n,this.lightWidth[e][2]=r.z*n,this.lightWidthId[e].setValue(this.lightWidth[e]);const a=t.transformVector(new rs(0,0,.5));this.lightHeight[e][0]=a.x*n,this.lightHeight[e][1]=a.y*n,this.lightHeight[e][2]=a.z*n,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchDirectLights(t,e,s){let i=0;const n=this.device.scope;for(let r=0;r<t.length;r++){if(!(t[r].mask&e))continue;const a=t[r],o=a._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(n,i),this.lightColorId[i].setValue(a._colorLinear),o.getY(a._direction).mulScalar(-1),a._direction.normalize(),this.lightDir[i][0]=a._direction.x,this.lightDir[i][1]=a._direction.y,this.lightDir[i][2]=a._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),0!==a.shape&&this.setLTCDirectionalLight(o,i,a._direction,s._node.getPosition(),s.farClip),a.castShadows){const t=a.getRenderData(s,0),e=a._getUniformBiasValues(t);this.lightShadowMapId[i].setValue(t.shadowBuffer),this.lightShadowMatrixId[i].setValue(t.shadowMatrix.data),this.shadowMatrixPaletteId[i].setValue(a._shadowMatrixPalette),this.shadowCascadeDistancesId[i].setValue(a._shadowCascadeDistances),this.shadowCascadeCountId[i].setValue(a.numCascades),this.shadowCascadeBlendId[i].setValue(1-a.cascadeBlend),this.lightShadowIntensity[i].setValue(a.shadowIntensity),this.lightSoftShadowParamsId[i].setValue(a._softShadowParams);t.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[i].setValue(a.penumbraSize/t.shadowCamera.renderTarget.width*t.projectionCompensation);const n=a._shadowCameraParams;n.length=4,n[0]=0,n[1]=t.shadowCamera._farClip,n[2]=t.shadowCamera._nearClip,n[3]=1,this.lightCameraParamsId[i].setValue(n);const r=a._shadowRenderParams;r.length=4,r[0]=a._shadowResolution,r[1]=e.normalBias,r[2]=e.bias,r[3]=0,this.lightShadowParamsId[i].setValue(r)}i++}return i}setLTCPositionalLight(t,e){const s=t.transformVector(new rs(-.5,0,0));this.lightWidth[e][0]=s.x,this.lightWidth[e][1]=s.y,this.lightWidth[e][2]=s.z,this.lightWidthId[e].setValue(this.lightWidth[e]);const i=t.transformVector(new rs(0,0,.5));this.lightHeight[e][0]=i.x,this.lightHeight[e][1]=i.y,this.lightHeight[e][2]=i.z,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchOmniLight(t,e,s){const i=e._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(t,s),this.lightRadiusId[s].setValue(e.attenuationEnd),this.lightColorId[s].setValue(e._colorLinear),i.getTranslation(e._position),this.lightPos[s][0]=e._position.x,this.lightPos[s][1]=e._position.y,this.lightPos[s][2]=e._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==e.shape&&this.setLTCPositionalLight(i,s),e.castShadows){const t=e.getRenderData(null,0);this.lightShadowMapId[s].setValue(t.shadowBuffer);const i=e._getUniformBiasValues(t),n=e._shadowRenderParams;n.length=4,n[0]=e._shadowResolution,n[1]=i.normalBias,n[2]=i.bias,n[3]=1/e.attenuationEnd,this.lightShadowParamsId[s].setValue(n),this.lightShadowIntensity[s].setValue(e.shadowIntensity);const r=e.penumbraSize/t.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[s].setValue(r);const a=e._shadowCameraParams;a.length=4,a[0]=0,a[1]=t.shadowCamera._farClip,a[2]=t.shadowCamera._nearClip,a[3]=0,this.lightCameraParamsId[s].setValue(a)}e._cookie&&(this.lightCookieId[s].setValue(e._cookie),this.lightShadowMatrixId[s].setValue(i.data),this.lightCookieIntId[s].setValue(e.cookieIntensity))}dispatchSpotLight(t,e,s){const i=e._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(t,s),this.lightInAngleId[s].setValue(e._innerConeAngleCos),this.lightOutAngleId[s].setValue(e._outerConeAngleCos),this.lightRadiusId[s].setValue(e.attenuationEnd),this.lightColorId[s].setValue(e._colorLinear),i.getTranslation(e._position),this.lightPos[s][0]=e._position.x,this.lightPos[s][1]=e._position.y,this.lightPos[s][2]=e._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==e.shape&&this.setLTCPositionalLight(i,s),i.getY(e._direction).mulScalar(-1),e._direction.normalize(),this.lightDir[s][0]=e._direction.x,this.lightDir[s][1]=e._direction.y,this.lightDir[s][2]=e._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),e.castShadows){const t=e.getRenderData(null,0);this.lightShadowMapId[s].setValue(t.shadowBuffer),this.lightShadowMatrixId[s].setValue(t.shadowMatrix.data);const i=e._getUniformBiasValues(t),n=e._shadowRenderParams;n.length=4,n[0]=e._shadowResolution,n[1]=i.normalBias,n[2]=i.bias,n[3]=1/e.attenuationEnd,this.lightShadowParamsId[s].setValue(n),this.lightShadowIntensity[s].setValue(e.shadowIntensity);const r=e.penumbraSize/t.shadowCamera.renderTarget.width,a=t.shadowCamera._fov*Math.PI/180,o=1/Math.tan(a/2);this.lightShadowSearchAreaId[s].setValue(r*o);const l=e._shadowCameraParams;l.length=4,l[0]=0,l[1]=t.shadowCamera._farClip,l[2]=t.shadowCamera._nearClip,l[3]=0,this.lightCameraParamsId[s].setValue(l)}if(e._cookie){if(!e.castShadows){const t=Nc.evalSpotCookieMatrix(e);this.lightShadowMatrixId[s].setValue(t.data)}this.lightCookieId[s].setValue(e._cookie),this.lightCookieIntId[s].setValue(e.cookieIntensity),e._cookieTransform&&(e._cookieTransformUniform[0]=e._cookieTransform.x,e._cookieTransformUniform[1]=e._cookieTransform.y,e._cookieTransformUniform[2]=e._cookieTransform.z,e._cookieTransformUniform[3]=e._cookieTransform.w,this.lightCookieMatrixId[s].setValue(e._cookieTransformUniform),e._cookieOffsetUniform[0]=e._cookieOffset.x,e._cookieOffsetUniform[1]=e._cookieOffset.y,this.lightCookieOffsetId[s].setValue(e._cookieOffsetUniform))}}dispatchLocalLights(t,e,s){let i=s;const n=this.device.scope,r=t[1],a=r.length;for(let t=0;t<a;t++){const s=r[t];s.mask&e&&(this.dispatchOmniLight(n,s,i),i++)}const o=t[2],l=o.length;for(let t=0;t<l;t++){const s=o[t];s.mask&e&&(this.dispatchSpotLight(n,s,i),i++)}}renderForwardPrepareMaterials(t,e,s,i,n,r){const a=t.fogParams??this.scene.fog,o=t.shaderParams;o.fog=a.type,o.srgbRenderTarget=e?.isColorBufferSrgb(0)??!1;const l=(t,e,s,i)=>{_u.drawCalls.push(t),_u.shaderInstances.push(e),_u.isNewMaterial.push(s),_u.lightMaskChanged.push(i)};_u.clear();const h=this.device,c=this.scene,d=c.clusteredLightingEnabled,u=n?.getLightHash(d)??0;let f,p,m=null;const _=s.length;for(let t=0;t<_;t++){const e=s[t],n=e.instancingData;if(n&&n.count<=0)continue;e.ensureMaterial(h);const a=e.material,d=e._shaderDefs,_=e.mask;a&&a===m&&d!==f&&(m=null),a!==m&&(this._materialSwitches++,a._scene=c,a.dirty&&(a.updateUniforms(h,c),a.dirty=!1));const g=e.getShaderInstance(r,u,c,o,this.viewUniformFormat,this.viewBindGroupFormat,i);l(e,g,a!==m,!m||_!==p),m=a,f=d,p=_}return _u}renderForwardInternal(t,e,s,i,n,r,a){const o=this.device,l=1<<i,h=r?-1:1,c=this.scene.clusteredLightingEnabled,d=t.xr?.session&&t.xr.views.list.length?t.xr.views.list:null,u=e.drawCalls.length;for(let i=0;i<u;i++){const r=e.drawCalls[i],f=e.isNewMaterial[i],p=e.lightMaskChanged[i],m=e.shaderInstances[i],_=r.material,g=r.mask;if(m.shader.failed)continue;if(f){const e=!1;if(o.setShader(m.shader,e),_.setParameters(o),p){const e=this.dispatchDirectLights(s[0],g,t);c||this.dispatchLocalLights(s,g,e)}this.alphaTestId.setValue(_.alphaTest),o.setBlendState(_.blendState),o.setDepthState(_.depthState),o.setAlphaToCoverage(_.alphaToCoverage)}this.setupCullMode(t._cullFaces,h,r);const v=r.stencilFront??_.stencilFront,b=r.stencilBack??_.stencilBack;o.setStencilState(v,b),r.setParameters(o,l),o.scope.resolve("meshInstanceId").setValue(r.id);const y=r.mesh;this.setVertexBuffers(o,y),this.setMorphing(o,r.morphInstance),this.setSkinning(o,r);const S=r.instancingData;S&&o.setVertexBuffer(S.vertexBuffer),this.setMeshInstanceMatrices(r,!0),this.setupMeshUniformBuffers(m);const x=r.renderStyle,w=y.indexBuffer[x];n?.(r,i);const T=r.indirectData?.get(t);if(d)for(let t=0;t<d.length;t++){const e=d[t];if(o.setViewport(e.viewport.x,e.viewport.y,e.viewport.z,e.viewport.w),o.supportsUniformBuffers){const e=a[t];o.setBindGroup(0,e)}else this.setupViewUniforms(e,t);const s=0===t,i=t===d.length-1;o.draw(y.primitive[x],w,S?.count,T,s,i),this._forwardDrawCalls++,r.instancingData&&this._instancedDrawCalls++}else o.draw(y.primitive[x],w,S?.count,T),this._forwardDrawCalls++,r.instancingData&&this._instancedDrawCalls++;i<u-1&&!e.isNewMaterial[i+1]&&_.setParameters(o,r.parameters)}}renderForward(t,e,s,i,n,r,a,o,l){const h=this.renderForwardPrepareMaterials(t,e,s,i,a,n);this.renderForwardInternal(t,h,i,n,r,o,l),_u.clear()}renderForwardLayer(t,e,s,i,n,r,a={}){const{scene:o,device:l}=this,h=o.clusteredLightingEnabled;let c,d;if(this.setupViewport(t,e),s){s.sortVisible(t,i);const e=s.getCulledInstances(t);c=i?e.transparent:e.opaque,o.immediate.onPreRenderLayer(s,c,i),s.requiresLightCube&&(this.lightCube.update(o.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),d=s.splitLights}else c=a.meshInstances,d=a.splitLights??pu;if(h){(a.lightClusters??this.worldClustersAllocator.empty).activate(),s&&(this.clustersDebugRendered||o.lighting.debugLayer!==s.id||(this.clustersDebugRendered=!0))}o._activeCamera=t;const u=t.fogParams??this.scene.fog;this.setFogConstants(u);const f=this.setCameraUniforms(t,e);l.supportsUniformBuffers&&this.setupViewUniformBuffers(r,this.viewUniformFormat,this.viewBindGroupFormat,f);const p=a.clearColor??!1,m=a.clearDepth??!1,_=a.clearStencil??!1;(p||m||_)&&this.clear(t,p,m,_);const g=!!(t._flipFaces^e?.flipY),v=this._forwardDrawCalls;this.renderForward(t,e,c,d,n,null,s,g,r),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-v)}setFogConstants(t){if(t.type!==fl){mu.linear(t.color);const e=this.fogColor;e[0]=mu.r,e[1]=mu.g,e[2]=mu.b,this.fogColorId.setValue(e),"linear"===t.type?(this.fogStartId.setValue(t.start),this.fogEndId.setValue(t.end)):this.fogDensityId.setValue(t.density)}}setSceneConstants(){const t=this.scene;this.dispatchGlobalLights(t);const e=this.device;this._screenSize[0]=e.width,this._screenSize[1]=e.height,this._screenSize[2]=1/e.width,this._screenSize[3]=1/e.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(t,e){const s=this.scene;if(t.reset(),s.clusteredLightingEnabled){const{shadowsEnabled:e,cookiesEnabled:i}=s.lighting;this._renderPassUpdateClustered.update(t,e,i,this.lights,this.localLights),t.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(t,this.localLights);let i=0,n=!0,r=null;const a=e._renderActions;for(let s=i;s<a.length;s++){const o=a[s],{layer:l,camera:h}=o;if(o.useCameraPasses)h.camera.renderPasses.forEach((e=>{t.addRenderPass(e)}));else{const c=1===l.id,d=c&&(h.renderSceneColorMap||h.renderSceneDepthMap);n&&(n=!1,i=s,r=o.renderTarget);const u=a[s+1],f=!!u&&(!u.useCameraPasses&&1===u.layer.id)&&(h.renderSceneColorMap||h.renderSceneDepthMap),p=!!u&&(u.firstCameraUse&&this.cameraDirShadowLights.has(u.camera.camera));if(!u||u.renderTarget!==r||p||f||d){if(c&&i===s||this.addMainRenderPass(t,e,r,i,s),c){if(h.renderSceneColorMap){const e=h.camera.renderPassColorGrab;e.source=h.renderTarget,t.addRenderPass(e)}h.renderSceneDepthMap&&t.addRenderPass(h.camera.renderPassDepthGrab)}if(o.triggerPostprocess&&h?.onPostprocessing){const e=new fu(this.device,this,o);t.addRenderPass(e)}n=!0}}}}addMainRenderPass(t,e,s,i,n){const r=new uu(this.device,e,this.scene,this);r.init(s);const a=e._renderActions;for(let t=i;t<=n;t++)r.addRenderAction(a[t]);t.addRenderPass(r)}update(t){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(t),this.collectLights(t),this.beginFrame(t),this.setSceneConstants(),this.cullComposition(t),this.gpuUpdate(this.processingMeshInstances)}}let vu=0;const bu=[],yu=new Set;const Su=[null,function(t,e){return t.drawOrder-e.drawOrder},function(t,e){const s=t._sortKeyForward,i=e._sortKeyForward;return s===i?e.mesh.id-t.mesh.id:i-s},function(t,e){return e._sortKeyDynamic-t._sortKeyDynamic},function(t,e){return t._sortKeyDynamic-e._sortKeyDynamic}];class xu{constructor(){this.opaque=[],this.transparent=[]}}class wu{constructor(t={}){this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,void 0!==t.id?(this.id=t.id,vu=Math.max(this.id+1,vu)):this.id=vu++,this.name=t.name,this._enabled=t.enabled??!0,this._refCounter=this._enabled?1:0,this.opaqueSortMode=t.opaqueSortMode??2,this.transparentSortMode=t.transparentSortMode??3,t.renderTarget&&(this.renderTarget=t.renderTarget),this._clearColorBuffer=!!t.clearColorBuffer,this._clearDepthBuffer=!!t.clearDepthBuffer,this._clearStencilBuffer=!!t.clearStencilBuffer,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}set enabled(t){t!==this._enabled&&(this._dirtyComposition=!0,this._enabled=t,t?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(t){this._clearColorBuffer=t,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(t){this._clearDepthBuffer=t,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(t){this._clearStencilBuffer=t,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(t,e){const s=this.meshInstances,i=this.meshInstancesSet;for(let e=0;e<t.length;e++){const n=t[e];i.has(n)||(s.push(n),i.add(n),yu.add(n.material))}if(e||this.addShadowCasters(t),yu.size>0){const t=this._shaderVersion;yu.forEach((e=>{t>=0&&e._shaderVersion!==t&&(e.getShaderVariant!==_d.prototype.getShaderVariant&&e.clearVariants(),e._shaderVersion=t)})),yu.clear()}}removeMeshInstances(t,e){const s=this.meshInstances,i=this.meshInstancesSet;for(let e=0;e<t.length;e++){const n=t[e];if(i.has(n)){i.delete(n);const t=s.indexOf(n);t>=0&&s.splice(t,1)}}e||this.removeShadowCasters(t)}addShadowCasters(t){const e=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<t.length;i++){const n=t[i];n.castShadow&&!s.has(n)&&(s.add(n),e.push(n))}}removeShadowCasters(t){const e=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<t.length;i++){const n=t[i];if(s.has(n)){s.delete(n);const t=e.indexOf(n);t>=0&&e.splice(t,1)}}}clearMeshInstances(t=!1){this.meshInstances.length=0,this.meshInstancesSet.clear(),t||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}hasLight(t){return this._lightsSet.has(t)}addLight(t){const e=t.light;this._lightsSet.has(e)||(this._lightsSet.add(e),this._lights.push(e),this.markLightsDirty()),0!==e.type&&this._clusteredLightsSet.add(e)}removeLight(t){const e=t.light;this._lightsSet.has(e)&&(this._lightsSet.delete(e),this._lights.splice(this._lights.indexOf(e),1),this.markLightsDirty()),0!==e.type&&this._clusteredLightsSet.delete(e)}clearLights(){this._lightsSet.forEach((t=>t.removeLayer(this))),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;const t=this._splitLights;for(let e=0;e<t.length;e++)t[e].length=0;const e=this._lights;for(let s=0;s<e.length;s++){const i=e[s];i.enabled&&t[i._type].push(i)}for(let e=0;e<t.length;e++)t[e].sort(((t,e)=>t.key-e.key))}return this._splitLights}evaluateLightHash(t,e,s){let i=0;const n=this._lights;for(let i=0;i<n.length;i++){const r=0!==n[i].type;(t&&r||e&&!r)&&bu.push(s?n[i].id:n[i].key)}return bu.length>0&&(bu.sort(),i=Mn(bu),bu.length=0),i}getLightHash(t){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!t,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(t){this.camerasSet.has(t.camera)||(this.camerasSet.add(t.camera),this.cameras.push(t),this._dirtyComposition=!0)}removeCamera(t){if(this.camerasSet.has(t.camera)){this.camerasSet.delete(t.camera);const e=this.cameras.indexOf(t);this.cameras.splice(e,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(t,e,s){const i=t.length,{x:n,y:r,z:a}=e,{x:o,y:l,z:h}=s;for(let c=0;c<i;c++){const i=t[c];let d;if(i.calculateSortDistance)d=i.calculateSortDistance(i,e,s);else{const t=i.aabb.center;d=(t.x-n)*o+(t.y-r)*l+(t.z-a)*h}const u=1e9*i._drawBucket;i._sortKeyDynamic=u+d}}getCulledInstances(t){let e=this._visibleInstances.get(t);return e||(e=new xu,this._visibleInstances.set(t,e)),e}sortVisible(t,e){const s=e?this.transparentSortMode:this.opaqueSortMode;if(0===s)return;const i=this.getCulledInstances(t),n=e?i.transparent:i.opaque,r=t.node;if(5===s){const t=r.getPosition(),e=r.forward;this.customCalculateSortValues&&this.customCalculateSortValues(n,n.length,t,e),this.customSortCallback&&n.sort(this.customSortCallback)}else{if(3===s||4===s){const t=r.getPosition(),e=r.forward;this._calculateSortDistances(n,t,e)}n.sort(Su[s])}}}const Tu=(t,e)=>t.priority-e.priority,Eu=t=>t.sort(Tu);class Cu extends Ve{constructor(t="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this._renderActions=[],this._dirty=!1,this.name=t,this._opaqueOrder={},this._transparentOrder={}}destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach((t=>t.destroy())),this._renderActions.length=0}markDirty(){this._dirty=!0}_update(){const t=this.layerList.length;if(!this._dirty)for(let e=0;e<t;e++)if(this.layerList[e]._dirtyComposition){this._dirty=!0;break}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(let e=0;e<t;e++){const t=this.layerList[e];t._dirtyComposition=!1;for(let e=0;e<t.cameras.length;e++){const s=t.cameras[e];this.cameras.indexOf(s)<0&&this.cameras.push(s)}}this.cameras.length>1&&Eu(this.cameras);let e=0;this.destroyRenderActions();for(let s=0;s<this.cameras.length;s++){const i=this.cameras[s];if(i.camera.renderPasses.length>0){this.addDummyRenderAction(e,i),e++;continue}let n=!0;const r=e;let a=null,o=!1;for(let s=0;s<t;s++){const t=this.layerList[s];if(t.enabled&&this.subLayerEnabled[s]&&t.cameras.length>0&&i.layers.indexOf(t.id)>=0){o||t.id!==i.disablePostEffectsLayer||(o=!0,a&&(a.triggerPostprocess=!0));const r=this.subLayerList[s];a=this.addRenderAction(e,t,r,i,n,o),e++,n=!1}}r<e&&(a.lastCameraUse=!0),!o&&a&&(a.triggerPostprocess=!0),i.renderTarget&&i.postEffectsEnabled&&this.propagateRenderTarget(r-1,i)}this._logRenderActions()}}getNextRenderAction(t){const e=new du;return this._renderActions.push(e),e}addDummyRenderAction(t,e){const s=this.getNextRenderAction(t);s.camera=e,s.useCameraPasses=!0}addRenderAction(t,e,s,i,n,r){let a=1!==e.id?i.renderTarget:null,o=!1;const l=this._renderActions;for(let e=t-1;e>=0;e--)if(l[e].camera===i&&l[e].renderTarget===a){o=!0;break}r&&i.postEffectsEnabled&&(a=null);const h=this.getNextRenderAction(t);h.triggerPostprocess=!1,h.layer=e,h.transparent=s,h.camera=i,h.renderTarget=a,h.firstCameraUse=n,h.lastCameraUse=!1;const c=n||!o,d=e.clearColorBuffer||e.clearDepthBuffer||e.clearStencilBuffer;return(c||d)&&h.setupClears(c?i:void 0,e),h}propagateRenderTarget(t,e){for(let s=t;s>=0;s--){const t=this._renderActions[s],i=t.layer;if(t.renderTarget&&1!==i.id)break;if(1===i.id)continue;if(t.useCameraPasses)break;const n=t?.camera.camera;if(n&&(!e.camera.rect.equals(n.rect)||!e.camera.scissorRect.equals(n.scissorRect)))break;t.renderTarget=e.renderTarget}}_logRenderActions(){}_isLayerAdded(t){return this.layerIdMap.get(t.id)===t}_isSublayerAdded(t,e){return void 0!==(e?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(t)}push(t){this._isLayerAdded(t)||(this.layerList.push(t),this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t))}insert(t,e){if(this._isLayerAdded(t))return;this.layerList.splice(e,0,t,t),this.subLayerList.splice(e,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(e,s-1),this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t)}remove(t){let e=this.layerList.indexOf(t);for(delete this._opaqueOrder[e],delete this._transparentOrder[e];e>=0;)this.layerList.splice(e,1),this.subLayerList.splice(e,1),this.subLayerEnabled.splice(e,1),e=this.layerList.indexOf(t),this._dirty=!0,this.fire("remove",t);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps()}pushOpaque(t){this._isSublayerAdded(t,!1)||(this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t))}insertOpaque(t,e){if(this._isSublayerAdded(t,!1))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t)}removeOpaque(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&!this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this.layerList.indexOf(t)<0&&this.fire("remove",t);break}this._updateLayerMaps()}pushTransparent(t){this._isSublayerAdded(t,!0)||(this.layerList.push(t),this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t))}insertTransparent(t,e){if(this._isSublayerAdded(t,!0))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t)}removeTransparent(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this.layerList.indexOf(t)<0&&this.fire("remove",t);break}this._updateLayerMaps()}getOpaqueIndex(t){return this.layerOpaqueIndexMap.get(t)??-1}getTransparentIndex(t){return this.layerTransparentIndexMap.get(t)??-1}isEnabled(t,e){if(t.enabled){const s=e?this.getTransparentIndex(t):this.getOpaqueIndex(t);if(s>=0)return this.subLayerEnabled[s]}return!1}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let t=0;t<this.layerList.length;t++){const e=this.layerList[t];this.layerIdMap.set(e.id,e),this.layerNameMap.set(e.name,e);(this.subLayerList[t]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(e,t)}}getLayerById(t){return this.layerIdMap.get(t)??null}getLayerByName(t){return this.layerNameMap.get(t)??null}_updateOpaqueOrder(t,e){for(let s=t;s<=e;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(t,e){for(let s=t;s<=e;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(t,e,s){let i=-1,n=-1;for(let e=0,n=t.length;e<n;e++){const n=t[e];s.hasOwnProperty(n)&&(i=Math.max(i,s[n]))}for(let t=0,i=e.length;t<i;t++){const i=e[t];s.hasOwnProperty(i)&&(n=Math.max(n,s[i]))}return-1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(t,e){return this._sortLayersDescending(t,e,this._transparentOrder)}sortOpaqueLayers(t,e){return this._sortLayersDescending(t,e,this._opaqueOrder)}}const Au=new rs,Du={bias:0,normalBias:0},Pu=new Ze,Lu={r:0,g:1,b:2,a:3},Iu={directional:0,omni:1,point:1,spot:2},Ru=[[new ls(0,0,1,1)],[new ls(0,0,.5,.5),new ls(0,.5,.5,.5)],[new ls(0,0,.5,.5),new ls(0,.5,.5,.5),new ls(.5,0,.5,.5)],[new ls(0,0,.5,.5),new ls(0,.5,.5,.5),new ls(.5,0,.5,.5),new ls(.5,.5,.5,.5)]],Mu={rrr:1,ggg:2,bbb:4,aaa:8,rgb:7};let ku=0;class Ou{constructor(t,e,s){this.light=s,this.camera=t,this.shadowCamera=Od.createShadowCamera(s._shadowType,s._type,e),this.shadowMatrix=new ps,this.shadowViewport=new ls(0,0,1,1),this.shadowScissor=new ls(0,0,1,1),this.projectionCompensation=0,this.face=e,this.visibleCasters=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach((t=>{t.defaultUniformBuffer.destroy(),t.destroy()})),this.viewBindGroups.length=0}get shadowBuffer(){const t=this.shadowCamera.renderTarget;return t?this.light._isPcf?t.depthBuffer:t.colorBuffer:null}}class Fu{constructor(t,e){this.layers=new Set,this.shadowDepthState=Tn.DEFAULT.clone(),this.clusteredFlags=0,this.clusteredData=new Uint32Array(3),this.clusteredData16=new Uint16Array(this.clusteredData.buffer),this._evtDeviceRestored=null,this.device=t,this.clusteredLighting=e,this.id=ku++,this._evtDeviceRestored=t.on("devicerestored",this.onDeviceRestored,this),this._type=0,this._color=new Ze(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=0,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new rs(0,0,0),this._direction=new rs(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this._shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._isVsm=!1,this._isPcf=!0,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}destroy(){this._evtDeviceRestored?.off(),this._evtDeviceRestored=null,this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}onDeviceRestored(){0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}releaseRenderData(){if(this._renderData){for(let t=0;t<this._renderData.length;t++)this._renderData[t].destroy();this._renderData.length=0}}addLayer(t){this.layers.add(t)}removeLayer(t){this.layers.delete(t)}set shadowSamples(t){this._softShadowParams[0]=t}get shadowSamples(){return this._softShadowParams[0]}set shadowBlockerSamples(t){this._softShadowParams[1]=t}get shadowBlockerSamples(){return this._softShadowParams[1]}set shadowBias(t){this._shadowBias!==t&&(this._shadowBias=t,this._updateShadowBias())}get shadowBias(){return this._shadowBias}set numCascades(t){this.cascades&&this.numCascades===t||(this.cascades=Ru[t-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set cascadeBlend(t){this._cascadeBlend!==t&&(this._cascadeBlend=t,this.updateKey())}get cascadeBlend(){return this._cascadeBlend}set shadowMap(t){this._shadowMap!==t&&(this._destroyShadowMap(),this._shadowMap=t)}get shadowMap(){return this._shadowMap}set mask(t){this._mask!==t&&(this._mask=t,this.updateKey(),this.updateClusteredFlags())}get mask(){return this._mask}get numShadowFaces(){const t=this._type;return 0===t?this.numCascades:1===t?6:1}set type(t){if(this._type===t)return;this._type=t,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey(),this.updateClusteredFlags();const e=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=e}get type(){return this._type}set shape(t){if(this._shape===t)return;this._shape=t,this._destroyShadowMap(),this.updateKey(),this.updateClusteredFlags();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get shape(){return this._shape}set usePhysicalUnits(t){this._usePhysicalUnits!==t&&(this._usePhysicalUnits=t,this._updateLinearColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(t){if(this._shadowType===t)return;let e=Ll.get(t);e||(t=0);const s=this.device;6!==t||s.textureFloatRenderable||s.textureHalfFloatRenderable||(t=0),1===this._type&&5!==t&&0!==t&&7!==t&&8!==t&&6!==t&&(t=0),3!==t||s.textureFloatRenderable&&s.textureFloatFilterable||(t=2),2!==t||s.textureHalfFloatRenderable||(t=0),e=Ll.get(t),this._isVsm=e?.vsm??!1,this._isPcf=e?.pcf??!1,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(t){this._enabled!==t&&(this._enabled=t,this.layersDirty())}get enabled(){return this._enabled}set castShadows(t){this._castShadows!==t&&(this._castShadows=t,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&4!==this._mask&&0!==this._mask}set shadowIntensity(t){this._shadowIntensity!==t&&(this._shadowIntensity=t,this.updateKey())}get shadowIntensity(){return this._shadowIntensity}get bakeShadows(){return this._castShadows&&4===this._mask}set shadowResolution(t){this._shadowResolution!==t&&(t=1===this._type?Math.min(t,this.device.maxCubeMapSize):Math.min(t,this.device.maxTextureSize),this._shadowResolution=t,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(t){if(this._normalOffsetBias!==t){const e=!this._normalOffsetBias&&t||this._normalOffsetBias&&!t;this._normalOffsetBias=t,e&&this.updateKey()}}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey(),this.updateClusteredFlags())}get falloffMode(){return this._falloffMode}set innerConeAngle(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180),this.updateClusterData(!1,!0),this._usePhysicalUnits&&this._updateLinearColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._updateOuterAngle(t),this._usePhysicalUnits&&this._updateLinearColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(t){this._penumbraSize=t,this._softShadowParams[2]=t}get penumbraSize(){return this._penumbraSize}set penumbraFalloff(t){this._softShadowParams[3]=t}get penumbraFalloff(){return this._softShadowParams[3]}_updateOuterAngle(t){const e=t*Math.PI/180;this._outerConeAngleCos=Math.cos(e),this._outerConeAngleSin=Math.sin(e),this.updateClusterData(!1,!0)}set intensity(t){this._intensity!==t&&(this._intensity=t,this._updateLinearColor())}get intensity(){return this._intensity}set affectSpecularity(t){0===this._type&&(this._affectSpecularity=t,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(t){this._luminance!==t&&(this._luminance=t,this._updateLinearColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new ps),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new ls(0,0,1,1)),this._atlasViewport}set cookie(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(t){if(this._cookieChannel!==t){if(t.length<3){const e=t.charAt(t.length-1),s=3-t.length;for(let i=0;i<s;i++)t+=e}this._cookieChannel=t,this.updateKey(),this.updateClusteredFlags()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new os,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(t){if(this._cookieOffset===t)return;!(!this._cookieTransformSet&&!t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new ls(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(let t=0;t<this.shadowUpdateOverrides.length;t++)0===this.shadowUpdateOverrides[t]&&(this.shadowUpdateOverrides[t]=1)}getRenderData(t,e){for(let s=0;s<this._renderData.length;s++){const i=this._renderData[s];if(i.camera===t&&i.face===e)return i}const s=new Ou(t,e,this);return this._renderData.push(s),s}clone(){const t=new Fu(this.device,this.clusteredLighting);return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.affectSpecularity=this._affectSpecularity,t.luminance=this._luminance,t.castShadows=this.castShadows,t._enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,this.shadowUpdateOverrides&&(t.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.numCascades=this.numCascades,t.cascadeDistribution=this.cascadeDistribution,t.cascadeBlend=this._cascadeBlend,t.shape=this._shape,t.shadowDepthState.copy(this.shadowDepthState),t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t.shadowIntensity=this.shadowIntensity,t.shadowSamples=this.shadowSamples,t.shadowBlockerSamples=this.shadowBlockerSamples,t.penumbraSize=this.penumbraSize,t.penumbraFalloff=this.penumbraFalloff,t}static getLightUnitConversion(t,e=Math.PI/4,s=0){switch(t){case 2:{const t=Math.cos(e),i=Math.cos(s);return 2*Math.PI*(1-i+(i-t)/2)}case 1:return 4*Math.PI;case 0:return 1}}_getUniformBiasValues(t){const e=t.shadowCamera._farClip;switch(this._type){case 1:Du.bias=this.shadowBias,Du.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?Du.bias=-2e-4:Du.bias=20*this.shadowBias,Du.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?Du.bias=-2e-4:Du.bias=this.shadowBias/e*100,Du.normalBias=this._isVsm?this.vsmBias/(e/7):this._normalOffsetBias}return Du}getColor(){return this._color}getBoundingSphere(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,n=this._node;Au.copy(n.up),s>45?(t.radius=e*this._outerConeAngleSin,Au.mulScalar(-e*i)):(t.radius=e/(2*i),Au.mulScalar(-t.radius)),t.center.add2(n.getPosition(),Au)}else 1===this._type&&(t.center=this._node.getPosition(),t.radius=this.attenuationEnd)}getBoundingBox(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*Qe.DEG_TO_RAD)*e);t.center.set(0,.5*-e,0),t.halfExtents.set(n,.5*e,n),t.setFromTransformedAabb(t,i.getWorldTransform(),!0)}else 1===this._type&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateShadowBias(){if(1!==this._type||this.clusteredLighting){const t=-1e3*this.shadowBias;this.shadowDepthState.depthBias=t,this.shadowDepthState.depthBiasSlope=t}else this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0}_updateLinearColor(){let t=this._intensity;this._usePhysicalUnits&&(t=this._luminance/Fu.getLightUnitConversion(this._type,this._outerConeAngle*Qe.DEG_TO_RAD,this._innerConeAngle*Qe.DEG_TO_RAD));const e=this._color,s=this._colorLinear;t>=1?Pu.linear(e).mulScalar(t):Pu.copy(e).mulScalar(t).linear(),s[0]=Pu.r,s[1]=Pu.g,s[2]=Pu.b,this.updateClusterData(!0)}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor()}layersDirty(){this.layers.forEach((t=>{t.hasLight(this)&&t.markLightsDirty()}))}updateKey(){let t=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|Lu[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|(this.numCascades>0?1:0)<<9|(this._cascadeBlend>0?1:0)<<8|(this.affectSpecularity?1:0)<<7|this.mask<<6|(this._castShadows?1:0)<<3;3===this._cookieChannel.length&&(t|=Lu[this._cookieChannel.charAt(1)]<<16,t|=Lu[this._cookieChannel.charAt(2)]<<14),t!==this.key&&this.layersDirty(),this.key=t}updateClusteredFlags(){const t=!!(1&this.mask),e=!!(2&this.mask);this.clusteredFlags=(2===this.type?1:0)<<30|(3&this._shape)<<28|(1&this._falloffMode)<<27|(Mu[this._cookieChannel]??0)<<23|(t?1:0)<<22|(e?1:0)<<21}getClusteredFlags(t,e){return this.clusteredFlags|255&(t?Math.floor(255*this.shadowIntensity):0)|(255&(e?Math.floor(255*this.cookieIntensity):0))<<8}updateClusterData(t,e){const{clusteredData16:s}=this,i=ns.float2Half;t&&(s[0]=i(Qe.clamp(this._colorLinear[0]/Sl,0,65504)),s[1]=i(Qe.clamp(this._colorLinear[1]/Sl,0,65504)),s[2]=i(Qe.clamp(this._colorLinear[2]/Sl,0,65504))),e&&(s[4]=i(this._innerConeAngleCos),s[5]=i(this._outerConeAngleCos))}}class Nu{constructor(t,e,s){this._areaLightsEnabled=!1,this._cells=new rs(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=t,this._maxTextureSize=e,this._dirtyLightsFnc=s}applySettings(t){this.shadowsEnabled=t.lightingShadowsEnabled??this.shadowsEnabled,this.cookiesEnabled=t.lightingCookiesEnabled??this.cookiesEnabled,this.areaLightsEnabled=t.lightingAreaLightsEnabled??this.areaLightsEnabled,this.shadowAtlasResolution=t.lightingShadowAtlasResolution??this.shadowAtlasResolution,this.cookieAtlasResolution=t.lightingCookieAtlasResolution??this.cookieAtlasResolution,this.maxLightsPerCell=t.lightingMaxLightsPerCell??this.maxLightsPerCell,this.shadowType=t.lightingShadowType??this.shadowType,t.lightingCells&&(this.cells=new rs(t.lightingCells))}set cells(t){this._cells.copy(t)}get cells(){return this._cells}set maxLightsPerCell(t){this._maxLightsPerCell=Qe.clamp(t,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(t){this._cookieAtlasResolution=Qe.clamp(t,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(t){this._shadowAtlasResolution=Qe.clamp(t,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(t){this._shadowType!==t&&(this._shadowType=t,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(t){this._cookiesEnabled!==t&&(this._cookiesEnabled=t,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(t){this._supportsAreaLights&&this._areaLightsEnabled!==t&&(this._areaLightsEnabled=t,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}class Bu{constructor(t){this.morph=t,t.incRefCount(),this.device=t.device;const e=t._targets.length;this.shader=this._createShader(e),this._weights=[],this._weightMap=new Map;for(let e=0;e<t._targets.length;e++){const s=t._targets[e];s.name&&this._weightMap.set(s.name,e),this.setWeight(e,s.defaultWeight)}this._shaderMorphWeights=new Float32Array(e),this._shaderMorphIndex=new Uint32Array(e);const s=(e,s)=>(this[s]=t._createTexture(e,t._renderTextureFormat),new Hn({colorBuffer:this[s],depth:!1}));t.morphPositions&&(this.rtPositions=s("MorphRTPos","texturePositions")),t.morphNormals&&(this.rtNormals=s("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([t.morphTextureWidth,t.morphTextureHeight]);const i=t.aabb.halfExtents;this._aabbSize=new Float32Array([4*i.x,4*i.y,4*i.z]);const n=t.aabb.getMin();this._aabbMin=new Float32Array([2*n.x,2*n.y,2*n.z]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin"),this.morphTextureId=this.device.scope.resolve("morphTexture"),this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.morphIndex=this.device.scope.resolve("morphIndex[0]"),this.countId=this.device.scope.resolve("count"),this.zeroTextures=!1}destroy(){this.shader=null;const t=this.morph;t&&(this.morph=null,t.decRefCount(),t.refCount<1&&t.destroy()),this.rtPositions?.destroy(),this.rtPositions=null,this.texturePositions?.destroy(),this.texturePositions=null,this.rtNormals?.destroy(),this.rtNormals=null,this.textureNormals?.destroy(),this.textureNormals=null}clone(){return new Bu(this.morph)}_getWeightIndex(t){if("string"==typeof t){return this._weightMap.get(t)}return t}getWeight(t){const e=this._getWeightIndex(t);return this._weights[e]}setWeight(t,e){const s=this._getWeightIndex(t);this._weights[s]=e,this._dirty=!0}_createShader(t){const e=new Map;e.set("{MORPH_TEXTURE_MAX_COUNT}",t),this.morph.intRenderFormat&&e.set("MORPH_INT","");const s=this.morph.intRenderFormat?"uvec4":"vec4";return Ph.createShader(this.device,{uniqueName:`TextureMorphShader_${t}-${this.morph.intRenderFormat?"int":"float"}`,attributes:{vertex_position:$s},vertexChunk:"morphVS",fragmentChunk:"morphPS",fragmentDefines:e,fragmentOutputTypes:[s]})}_updateTextureRenderTarget(t,e,s){const{morph:i,device:n}=this;this.setAabbUniforms(s),this.morphTextureId.setValue(s?i.targetsTexturePositions:i.targetsTextureNormals),n.setBlendState(Sn.NOBLEND),this.countId.setValue(e),this.morphFactor.setValue(this._shaderMorphWeights),this.morphIndex.setValue(this._shaderMorphIndex),Nh(n,t,this.shader)}_updateTextureMorph(t){(t>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,t,!0),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,t,!1),this.zeroTextures=0===t)}setAabbUniforms(t=!0){this.aabbSizeId.setValue(t?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(t?this._aabbMin:this._aabbNrmMin)}prepareRendering(t){this.setAabbUniforms()}update(){this._dirty=!1;const t=this.morph._targets,e=this._shaderMorphWeights,s=this._shaderMorphIndex;let i=0;for(let n=0;n<t.length;n++)Math.abs(this.getWeight(n))>1e-5&&(e[i]=this.getWeight(n),s[i]=n,i++);this._updateTextureMorph(i)}}class Uu{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(t){this.graph=t}getCameras(){return this.cameras}setCameras(t){this.cameras=t}getLights(){return this.lights}setLights(t){this.lights=t}getMaterials(){const t=[];for(let e=0;e<this.meshInstances.length;e++){const s=this.meshInstances[e];-1===t.indexOf(s.material)&&t.push(s.material)}return t}clone(){const t=[],e=[],s=function(i){const n=i.clone();t.push(i),e.push(n);for(let t=0;t<i._children.length;t++)n.addChild(s(i._children[t]));return n},i=s(this.graph),n=[],r=[],a=[];for(let t=0;t<this.skinInstances.length;t++){const e=this.skinInstances[t].skin,s=new zh(e),n=[];for(let t=0;t<e.boneNames.length;t++){const s=e.boneNames[t],r=i.findByName(s);n.push(r)}s.bones=n,r.push(s)}for(let t=0;t<this.morphInstances.length;t++){const e=this.morphInstances[t].morph,s=new Bu(e);a.push(s)}for(let s=0;s<this.meshInstances.length;s++){const i=this.meshInstances[s],o=t.indexOf(i.node),l=new nc(i.mesh,i.material,e[o]);if(i.skinInstance){const t=this.skinInstances.indexOf(i.skinInstance);l.skinInstance=r[t]}if(i.morphInstance){const t=this.morphInstances.indexOf(i.morphInstance);l.morphInstance=a[t]}n.push(l)}const o=new Uu;return o.graph=i,o.meshInstances=n,o.skinInstances=r,o.morphInstances=a,o.getGraph().syncHierarchy(),o}destroy(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].destroy();this.meshInstances.length=0}generateWireframe(){nc._prepareRenderStyleForArray(this.meshInstances,1)}}class zu extends fr{constructor(t,e,{preferHighPrecision:s=!1}={}){super(),this.device=e;const i=e;this.preferHighPrecision=s,this._targets=t.slice();const n=i.textureHalfFloatRenderable?Ps:void 0,r=i.textureFloatRenderable?Ls:void 0;this._renderTextureFormat=this.preferHighPrecision?r??n:n??r,this._renderTextureFormat=this._renderTextureFormat??47,this.intRenderFormat=Ws(this._renderTextureFormat),this._textureFormat=this.preferHighPrecision?Ls:Ps,this._init(),this._updateMorphFlags()}destroy(){this.vertexBufferIds?.destroy(),this.vertexBufferIds=null,this.targetsTexturePositions?.destroy(),this.targetsTexturePositions=null,this.targetsTextureNormals?.destroy(),this.targetsTextureNormals=null}get aabb(){if(!this._aabb){const t=new rs,e=new rs;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;t.min(i.getMin()),e.max(i.getMax())}this._aabb=new Ss,this._aabb.setMinMax(t,e)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}_init(){this._initTextureBased();for(let t=0;t<this._targets.length;t++)this._targets[t]._postInit()}_findSparseSet(t,e,s){let i=1;const n=t[0].length;for(let r=0;r<n;r+=3){let n=!1;for(let e=0;e<t.length;e++){const s=t[e];if(0!==s[r]||0!==s[r+1]||0!==s[r+2]){n=!0;break}}n?(e.push(i),s.push(r/3),i++):e.push(0)}return i}_initTextureBased(){const t=[],e=[],s=this._targets;for(let i=0;i<s.length;i++){const n=s[i];n.options.deltaPositions&&(t.push(n.options.deltaPositions),e.push(!0)),n.options.deltaNormals&&(t.push(n.options.deltaNormals),e.push(!1))}const i=[],n=[],r=this._findSparseSet(t,i,n),a=this.device.maxTextureSize;let o=Math.ceil(Math.sqrt(r));o=Math.min(o,a);const l=Math.ceil(r/o);if(l>a)return;this.morphTextureWidth=o,this.morphTextureHeight=l;let h=!1;const c=ns.float2Half;this._textureFormat===Ps&&(h=!0);const d=[],u=[],f=o*l*4;for(let s=0;s<t.length;s++){const i=t[s],r=this._textureFormat===Ps?new Uint16Array(f):new Float32Array(f);if((e[s]?d:u).push(r),h)for(let t=0;t<n.length;t++){const e=3*n[t],s=4*t+4;r[s]=c(i[e]),r[s+1]=c(i[e+1]),r[s+2]=c(i[e+2])}else for(let t=0;t<n.length;t++){const e=3*n[t],s=4*t+4;r[s]=i[e],r[s+1]=i[e+1],r[s+2]=i[e+2]}}d.length>0&&(this.targetsTexturePositions=this._createTexture("MorphPositionsTexture",this._textureFormat,s.length,[d]),this.targetsTexturePositions.upload()),u.length>0&&(this.targetsTextureNormals=this._createTexture("MorphNormalsTexture",this._textureFormat,s.length,[u]),this.targetsTextureNormals.upload());const p=[{semantic:pi,components:1,type:5,asInt:!0}];return this.vertexBufferIds=new In(this.device,new Nn(this.device,p,i.length),i.length,{data:new Uint32Array(i)}),!0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let t=0;t<this._targets.length;t++){const e=this._targets[t];e.morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)}}_createTexture(t,e,s,i){return new dn(this.device,{levels:i,arrayLength:s,width:this.morphTextureWidth,height:this.morphTextureHeight,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})}}class Vu{constructor(t){this.used=!1,this.options=t,this._name=t.name,this._defaultWeight=t.defaultWeight||0,this._aabb=t.aabb,this.deltaPositions=t.deltaPositions,this.morphPositions=!!t.deltaPositions,this.morphNormals=!!t.deltaNormals}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new Ss,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}clone(){return new Vu(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}}const Hu=new class extends yh{generateKey(t){const e=t.shaderDesc,s=e.vertexGLSL?Rn(e.vertexGLSL):0,i=e.fragmentGLSL?Rn(e.fragmentGLSL):0,n=e.vertexWGSL?Rn(e.vertexWGSL):0,r=e.fragmentWGSL?Rn(e.fragmentWGSL):0,a=yh.definesHash(t.defines),o=t.shaderChunks?.key??"";let l=`${e.uniqueName}_${a}_${s}_${i}_${n}_${r}_${o}`;return t.skin&&(l+="_skin"),t.useInstancing&&(l+="_inst"),t.useMorphPosition&&(l+="_morphp"),t.useMorphNormal&&(l+="_morphn"),t.useMorphTextureBasedInt&&(l+="_morphi"),l}createAttributesDefinition(t,e){const s=e.shaderDesc.attributes,i=s?{...s}:void 0;e.skin&&(i.vertex_boneWeights=Ys,i.vertex_boneIndices=Qs),(e.useMorphPosition||e.useMorphNormal)&&(i.morph_vertex_id=pi),t.attributes=i}createVertexDefinition(t,e,s,i){const n=e.shaderDesc,r=new Map(s);r.set("transformInstancingVS","");const a=new Map(e.defines);e.skin&&a.set("SKIN",!0),e.useInstancing&&a.set("INSTANCING",!0),(e.useMorphPosition||e.useMorphNormal)&&(a.set("MORPHING",!0),e.useMorphTextureBasedInt&&a.set("MORPHING_INT",!0),e.useMorphPosition&&a.set("MORPHING_POSITION",!0),e.useMorphNormal&&a.set("MORPHING_NORMAL",!0)),t.vertexCode=i?n.vertexWGSL:n.vertexGLSL,t.vertexIncludes=r,t.vertexDefines=a}createFragmentDefinition(t,e,s,i){const n=e.shaderDesc,r=new Map(s),a=new Map(e.defines);t.fragmentCode=i?n.fragmentWGSL:n.fragmentGLSL,t.fragmentIncludes=r,t.fragmentDefines=a}createShaderDefinition(t,e){const s=e.shaderDesc,i=t.isWebGPU&&!!s.vertexWGSL&&!!s.fragmentWGSL&&(e.shaderChunks?.useWGSL??!0),n={name:`ShaderMaterial-${s.uniqueName}`,shaderLanguage:i?Di:Ai,fragmentOutputTypes:s.fragmentOutputTypes,meshUniformBufferFormat:s.meshUniformBufferFormat,meshBindGroupFormat:s.meshBindGroupFormat},r=i?Di:Ai,a=Ah.merge(Ch.get(t,r),e.shaderChunks[r]);return this.createAttributesDefinition(n,e),this.createVertexDefinition(n,e,a,i),this.createFragmentDefinition(n,e,a,i),La.createDefinition(t,n)}};class Gu extends _d{constructor(t){super(),this.shaderDesc=t}set shaderDesc(t){if(this._shaderDesc=void 0,t&&(this._shaderDesc={uniqueName:t.uniqueName,attributes:t.attributes,fragmentOutputTypes:t.fragmentOutputTypes,vertexGLSL:t.vertexGLSL,fragmentGLSL:t.fragmentGLSL,vertexWGSL:t.vertexWGSL,fragmentWGSL:t.fragmentWGSL},t.vertexCode||t.fragmentCode||t.shaderLanguage)){const e=t.shaderLanguage??Ai;e===Ai?(this._shaderDesc.vertexGLSL=t.vertexCode,this._shaderDesc.fragmentGLSL=t.fragmentCode):e===Di&&(this._shaderDesc.vertexWGSL=t.vertexCode,this._shaderDesc.fragmentWGSL=t.fragmentCode)}this.clearVariants()}get shaderDesc(){return this._shaderDesc}copy(t){return super.copy(t),this.shaderDesc=t.shaderDesc,this}getShaderVariant(t){const{objDefs:e}=t,s={defines:Ph.getCoreDefines(this,t),skin:!!(2&e),useInstancing:!!(32&e),useMorphPosition:0!==(e&Zl),useMorphNormal:0!==(e&Jl),useMorphTextureBasedInt:0!==(e&th),pass:t.pass,gamma:t.cameraShaderParams.shaderOutputGamma,toneMapping:t.cameraShaderParams.toneMapping,fog:t.cameraShaderParams.fog,shaderDesc:this.shaderDesc,shaderChunks:this.shaderChunks},i=new gh(t.viewUniformFormat,t.viewBindGroupFormat,t.vertexFormat),n=bh(t.device);return n.register("shader-material",Hu),n.getProgram("shader-material",s,i,this.userId)}}const Wu={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP",xy:"unpackNormalXY",xyz:"unpackNormalXYZ"},ju={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class Xu{static decodeFunc(t){return Wu[t]??"decodeGamma"}static encodeFunc(t){return ju[t]??"encodeGamma"}}const $u=(t,e)=>{const s=e.length/3,i=t.length/3,n=new rs,r=new rs,a=new rs,o=new rs,l=new rs,h=new rs,c=[];for(let e=0;e<t.length;e++)c[e]=0;for(let i=0;i<s;i++){const s=e[3*i],d=e[3*i+1],u=e[3*i+2];n.set(t[3*s],t[3*s+1],t[3*s+2]),r.set(t[3*d],t[3*d+1],t[3*d+2]),a.set(t[3*u],t[3*u+1],t[3*u+2]),o.sub2(r,n),l.sub2(a,n),h.cross(o,l).normalize(),c[3*s]+=h.x,c[3*s+1]+=h.y,c[3*s+2]+=h.z,c[3*d]+=h.x,c[3*d+1]+=h.y,c[3*d+2]+=h.z,c[3*u]+=h.x,c[3*u+1]+=h.y,c[3*u+2]+=h.z}for(let t=0;t<i;t++){const e=c[3*t],s=c[3*t+1],i=c[3*t+2],n=1/Math.sqrt(e*e+s*s+i*i);c[3*t]*=n,c[3*t+1]*=n,c[3*t+2]*=n}return c},qu=(t,e,s,i)=>{const n=i.length/3,r=t.length/3,a=new rs,o=new rs,l=new rs,h=new os,c=new os,d=new os,u=new rs,f=new rs,p=new Float32Array(3*r),m=new Float32Array(3*r),_=[];for(let e=0;e<n;e++){const n=i[3*e],r=i[3*e+1],_=i[3*e+2];a.set(t[3*n],t[3*n+1],t[3*n+2]),o.set(t[3*r],t[3*r+1],t[3*r+2]),l.set(t[3*_],t[3*_+1],t[3*_+2]),h.set(s[2*n],s[2*n+1]),c.set(s[2*r],s[2*r+1]),d.set(s[2*_],s[2*_+1]);const g=o.x-a.x,v=l.x-a.x,b=o.y-a.y,y=l.y-a.y,S=o.z-a.z,x=l.z-a.z,w=c.x-h.x,T=d.x-h.x,E=c.y-h.y,C=d.y-h.y,A=w*C-T*E;if(0===A)u.set(0,1,0),f.set(1,0,0);else{const t=1/A;u.set((C*g-E*v)*t,(C*b-E*y)*t,(C*S-E*x)*t),f.set((w*v-T*g)*t,(w*y-T*b)*t,(w*x-T*S)*t)}p[3*n+0]+=u.x,p[3*n+1]+=u.y,p[3*n+2]+=u.z,p[3*r+0]+=u.x,p[3*r+1]+=u.y,p[3*r+2]+=u.z,p[3*_+0]+=u.x,p[3*_+1]+=u.y,p[3*_+2]+=u.z,m[3*n+0]+=f.x,m[3*n+1]+=f.y,m[3*n+2]+=f.z,m[3*r+0]+=f.x,m[3*r+1]+=f.y,m[3*r+2]+=f.z,m[3*_+0]+=f.x,m[3*_+1]+=f.y,m[3*_+2]+=f.z}const g=new rs,v=new rs,b=new rs,y=new rs;for(let t=0;t<r;t++){b.set(e[3*t],e[3*t+1],e[3*t+2]),g.set(p[3*t],p[3*t+1],p[3*t+2]),v.set(m[3*t],m[3*t+1],m[3*t+2]);const s=b.dot(g);y.copy(b).mulScalar(s),y.sub2(g,y).normalize(),_[4*t]=y.x,_[4*t+1]=y.y,_[4*t+2]=y.z,y.cross(b,g),_[4*t+3]=y.dot(v)<0?-1:1}return _};class Ku{calculateNormals(){this.normals=$u(this.positions,this.indices)}calculateTangents(){this.tangents=qu(this.positions,this.normals,this.uvs,this.indices)}}const Yu=4/64;class Qu extends Ku{constructor(t={}){super();const e=t.halfExtents??new rs(.5,.5,.5),s=t.widthSegments??1,i=t.lengthSegments??1,n=t.heightSegments??1,r=t.yOffset??0,a=-e.y+r,o=e.y+r,l=[new rs(-e.x,a,e.z),new rs(e.x,a,e.z),new rs(e.x,o,e.z),new rs(-e.x,o,e.z),new rs(e.x,a,-e.z),new rs(-e.x,a,-e.z),new rs(-e.x,o,-e.z),new rs(e.x,o,-e.z)],h=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],c=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],d=1,u=2,f=3,p=4,m=5,_=[],g=[],v=[],b=[];let y=0;const S=(t,e,s)=>{const i=new rs,n=new rs,r=new rs,a=new rs;for(let o=0;o<=e;o++)for(let d=0;d<=s;d++){i.lerp(l[h[t][0]],l[h[t][1]],o/e),n.lerp(l[h[t][0]],l[h[t][2]],d/s),r.sub2(n,l[h[t][0]]),a.add2(i,r);let u=o/e,f=d/s;_.push(a.x,a.y,a.z),g.push(c[t][0],c[t][1],c[t][2]),v.push(u,1-f),u=.875*u+Yu,f=.875*f+Yu,u/=3,f/=3,u+=t%3/3,f+=Math.floor(t/3)/3,o<e&&d<s&&(b.push(y+s+1,y+1,y),b.push(y+s+1,y+s+2,y+1)),y++}};S(0,s,n),S(d,s,n),S(u,s,i),S(f,s,i),S(p,i,n),S(m,i,n),this.positions=_,this.normals=g,this.uvs=v,this.uvs1=v,this.indices=b,t.calculateTangents&&(this.tangents=qu(_,g,v,b))}}class Zu extends Ku{constructor(t={}){super();const e=t.radius??.5,s=t.latitudeBands??16,i=t.longitudeBands??16,n=[],r=[],a=[],o=[];for(let t=0;t<=s;t++){const o=t*Math.PI/s,l=Math.sin(o),h=Math.cos(o);for(let o=0;o<=i;o++){const c=2*o*Math.PI/i-Math.PI/2,d=Math.sin(c),u=Math.cos(c)*l,f=h,p=d*l,m=1-o/i,_=1-t/s;n.push(u*e,f*e,p*e),r.push(u,f,p),a.push(m,1-_)}}for(let t=0;t<s;++t)for(let e=0;e<i;++e){const s=t*(i+1)+e,n=s+i+1;o.push(s+1,n,s),o.push(s+1,n+1,n)}this.positions=n,this.normals=r,this.uvs=a,this.uvs1=a,this.indices=o,t.calculateTangents&&(this.tangents=qu(n,r,a,o))}}class Ju extends Zu{constructor(t={}){const e=.5;super({radius:e,latitudeBands:t.latitudeBands??16,longitudeBands:t.longitudeBands??16});const s=this.positions;for(let t=0;t<s.length;t+=3){const i=s[t]/e;let n=s[t+1]/e;const r=s[t+2]/e;n<0&&(n*=.3,i*i+r*r<.9025&&(n=-.1)),n+=.1,n*=e,s[t+1]=n}}}class tf{static create(t,e){switch(e){case"box":return tf.box(t);case oh:return tf.dome(t)}return tf.infinite(t)}static infinite(t){return Wh.fromGeometry(t,new Qu(t))}static box(t){return Wh.fromGeometry(t,new Qu({yOffset:.5}))}static dome(t){const e=new Ju({latitudeBands:50,longitudeBands:50});return e.normals=void 0,e.uvs=void 0,Wh.fromGeometry(t,e)}}class ef{constructor(t,e,s,i,n){this.meshInstance=null,this._depthWrite=!1;const r=new Gu({uniqueName:"SkyMaterial",vertexGLSL:Ch.get(t,Ai).get("skyboxVS"),fragmentGLSL:Ch.get(t,Ai).get("skyboxPS"),vertexWGSL:Ch.get(t,Di).get("skyboxVS"),fragmentWGSL:Ch.get(t,Di).get("skyboxPS"),attributes:{aPosition:$s}});r.setDefine("{SKYBOX_DECODE_FNC}",Xu.decodeFunc(i.encoding)),n!==ah&&r.setDefine("SKYMESH",""),i.cubemap&&r.setDefine("SKY_CUBEMAP",""),r.setParameter("skyboxHighlightMultiplier",e.skyboxHighlightMultiplier),i.cubemap?r.setParameter("texture_cubeMap",i):(r.setParameter("texture_envAtlas",i),r.setParameter("mipLevel",e.skyboxMip)),r.cull=2,r.depthWrite=this._depthWrite;const a=e.layers.getLayerById(2);if(a){const e=tf.create(t,n),i=new nc(e,r,s);this.meshInstance=i,i.cull=!1,i.pick=!1,a.addMeshInstances([i]),this.skyLayer=a}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}set depthWrite(t){this._depthWrite=t,this.meshInstance&&(this.meshInstance.material.depthWrite=t)}get depthWrite(){return this._depthWrite}}class sf{constructor(t){this._type=ah,this._center=new rs(0,1,0),this.skyMesh=null,this._depthWrite=!1,this.node=new Mc("SkyMeshNode"),this.device=t.device,this.scene=t,this.center=new rs(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}applySettings(t){this.type=t.skyType??ah,this.node.setLocalPosition(new rs(t.skyMeshPosition??[0,0,0])),this.node.setLocalEulerAngles(new rs(t.skyMeshRotation??[0,0,0])),this.node.setLocalScale(new rs(t.skyMeshScale??[1,1,1])),t.skyCenter&&(this._center=new rs(t.skyCenter))}set type(t){this._type!==t&&(this._type=t,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(t){this._center.copy(t)}get center(){return this._center}set depthWrite(t){this._depthWrite!==t&&(this._depthWrite=t,this.skyMesh&&(this.skyMesh.depthWrite=t))}get depthWrite(){return this._depthWrite}updateSkyMesh(){const t=this.scene._getSkyboxTex();t&&(this.resetSkyMesh(),this.skyMesh=new ef(this.device,this.scene,this.node,t,this.type),this.skyMesh.depthWrite=this._depthWrite,this.scene.fire("set:skybox",t))}resetSkyMesh(){this.skyMesh?.destroy(),this.skyMesh=null}update(){if(this.type!==ah){const{center:t,centerArray:e}=this,s=new rs;this.node.getWorldTransform().transformPoint(t,s),e[0]=s.x,e[1]=s.y,e[2]=s.z,this.projectedSkydomeCenterId.setValue(e)}}}const nf=new Mc;nf.worldTransform=ps.IDENTITY,nf._dirtyWorld=nf._dirtyNormal=!1;class rf{constructor(t,e,s){this.material=e,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Wh(t),this.meshInstance=null}addLines(t,e){const s=this.positions,i=t.length;for(let e=0;e<i;e++){const i=t[e];s.push(i.x,i.y,i.z)}const n=this.colors;if(e.length)for(let t=0;t<i;t++){const s=e[t];n.push(s.r,s.g,s.b,s.a)}else for(let t=0;t<i;t++)n.push(e.r,e.g,e.b,e.a)}addLinesArrays(t,e){const s=this.positions;for(let e=0;e<t.length;e+=3)s.push(t[e],t[e+1],t[e+2]);const i=this.colors;if(e.length)for(let t=0;t<e.length;t+=4)i.push(e[t],e[t+1],e[t+2],e[t+3]);else{const s=t.length/3;for(let t=0;t<s;t++)i.push(e.r,e.g,e.b,e.a)}}onPreRender(t,e){this.positions.length>0&&this.material.transparent===e&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new nc(this.mesh,this.material,nf)),t.push(this.meshInstance))}clear(){this.positions.length=0,this.colors.length=0}}class af{constructor(t){this.device=t,this.map=new Map}getBatch(t,e){let s=this.map.get(t);return s||(s=new rf(this.device,t,e),this.map.set(t,s)),s}onPreRender(t,e){this.map.forEach((s=>{s.onPreRender(t,e)}))}clear(){this.map.forEach((t=>t.clear()))}}const of=[],lf=new rs;class hf{constructor(t){this.shaderDescs=new Map,this.device=t,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(t){const e=new Gu({uniqueName:"ImmediateLine",vertexGLSL:Ch.get(this.device,Ai).get("immediateLineVS"),fragmentGLSL:Ch.get(this.device,Ai).get("immediateLinePS"),vertexWGSL:Ch.get(this.device,Di).get("immediateLineVS"),fragmentWGSL:Ch.get(this.device,Di).get("immediateLinePS"),attributes:{vertex_position:$s,vertex_color:Zs}});return e.blendType=2,e.depthTest=t,e.update(),e}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(t,e){let s=this.batchesMap.get(t);s||(s=new af(this.device),this.batchesMap.set(t,s)),this.allBatches.add(s);const i=e?this.materialDepth:this.materialNoDepth;return s.getBatch(i,t)}getShaderDesc(t,e,s){return this.shaderDescs.has(t)||this.shaderDescs.set(t,{uniqueName:`DebugShader:${t}`,vertexGLSL:"\n\t\t\t\t\tattribute vec2 vertex_position;\n\t\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\tvoid main(void) {\n\t\t\t\t\t\tgl_Position = matrix_model * vec4(vertex_position, 0, 1);\n\t\t\t\t\t\tuv0 = vertex_position.xy + 0.5;\n\t\t\t\t\t}\n\t\t\t\t",vertexWGSL:"\n\t\t\t\t\tattribute vertex_position: vec2f;\n\t\t\t\t\tuniform matrix_model: mat4x4f;\n\t\t\t\t\tvarying uv0: vec2f;\n\t\t\t\t\t@vertex fn vertexMain(input: VertexInput) -> VertexOutput {\n\t\t\t\t\t\tvar output: VertexOutput;\n\t\t\t\t\t\toutput.position = uniform.matrix_model * vec4f(input.vertex_position, 0.0, 1.0);\n\t\t\t\t\t\toutput.uv0 = input.vertex_position.xy + vec2f(0.5);\n\t\t\t\t\t\treturn output;\n\t\t\t\t\t}\n\t\t\t\t",fragmentGLSL:e,fragmentWGSL:s,attributes:{vertex_position:$s}}),this.shaderDescs.get(t)}getTextureShaderDesc(t){const e=Xu.decodeFunc(t);return this.getShaderDesc(`textureShader-${t}`,`\n\t\t\t#include "gammaPS"\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tvec3 linearColor = ${e}(texture2D(colorMap, uv0));\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);\n\t\t\t}\n\t\t`,`\n\t\t\t#include "gammaPS"\n\t\t\tvarying uv0: vec2f;\n\t\t\tvar colorMap: texture_2d<f32>;\n\t\t\tvar colorMapSampler: sampler;\n\t\t\t@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\t\t\tvar output: FragmentOutput;\n\t\t\t\tlet sampledTex = textureSample(colorMap, colorMapSampler, input.uv0);\n\t\t\t\tlet linearColor: vec3f = ${e}(sampledTex);\n\t\t\t\toutput.color = vec4f(gammaCorrectOutput(linearColor), 1.0);\n\t\t\t\treturn output;\n\t\t\t}\n\t\t`)}getUnfilterableTextureShaderDesc(){return this.getShaderDesc("textureShaderUnfilterable","\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform highp sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));\n\t\t\t\tgl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);\n\t\t\t}\n\t\t","\n\t\t\tvarying uv0: vec2f;\n\t\t\tvar colorMap: texture_2d<uff>;\n\t\t\t@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\t\t\tvar output: FragmentOutput;\n\t\t\t\tlet uv : vec2<i32> = vec2<i32>(input.uv0 * vec2f(textureDimensions(colorMap, 0)));\n\t\t\t\tlet fetchedColor : vec4f = textureLoad(colorMap, uv, 0);\n\t\t\t\toutput.color = vec4f(fetchedColor.xyz, 1.0);\n\t\t\t\treturn output;\n\t\t\t}\n\t\t")}getDepthTextureShaderDesc(){return this.getShaderDesc("depthTextureShader",'\n\t\t\t#include "screenDepthPS"\n\t\t\t#include "gammaPS"\n\t\t\tvarying vec2 uv0;\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);\n\t\t\t}\n\t\t','\n\t\t\t#include "screenDepthPS"\n\t\t\t#include "gammaPS"\n\t\t\tvarying uv0: vec2f;\n\t\t\t@fragment fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t\t\t\tvar output: FragmentOutput;\n\t\t\t\tlet depth: f32 = getLinearScreenDepth(getImageEffectUV(input.uv0)) * uniform.camera_params.x;\n\t\t\t\toutput.color = vec4f(gammaCorrectOutput(vec3f(depth)), 1.0);\n\t\t\t\treturn output;\n\t\t\t}\n\t\t')}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Wh(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(t,e,s,i,n){if(!i){const n=this.getGraphNode(e);i=new nc(s,t,n)}let r=this.layerMeshInstances.get(n);r||(r=[],this.layerMeshInstances.set(n,r)),r.push(i)}drawWireAlignedBox(t,e,s,i,n,r){if(r){const s=(t,e,s)=>{lf.set(t,e,s),r.transformPoint(lf,lf),of.push(lf.x,lf.y,lf.z)};s(t.x,t.y,t.z),s(t.x,e.y,t.z),s(t.x,e.y,t.z),s(e.x,e.y,t.z),s(e.x,e.y,t.z),s(e.x,t.y,t.z),s(e.x,t.y,t.z),s(t.x,t.y,t.z),s(t.x,t.y,e.z),s(t.x,e.y,e.z),s(t.x,e.y,e.z),s(e.x,e.y,e.z),s(e.x,e.y,e.z),s(e.x,t.y,e.z),s(e.x,t.y,e.z),s(t.x,t.y,e.z),s(t.x,t.y,t.z),s(t.x,t.y,e.z),s(t.x,e.y,t.z),s(t.x,e.y,e.z),s(e.x,e.y,t.z),s(e.x,e.y,e.z),s(e.x,t.y,t.z),s(e.x,t.y,e.z)}else of.push(t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z);this.getBatch(n,i).addLinesArrays(of,s),of.length=0}drawWireSphere(t,e,s,i,n,r){const a=2*Math.PI/i;let o=0;for(let s=0;s<i;s++){const s=Math.sin(o),i=Math.cos(o);o+=a;const n=Math.sin(o),r=Math.cos(o);of.push(t.x+e*s,t.y,t.z+e*i),of.push(t.x+e*n,t.y,t.z+e*r),of.push(t.x+e*s,t.y+e*i,t.z),of.push(t.x+e*n,t.y+e*r,t.z),of.push(t.x,t.y+e*s,t.z+e*i),of.push(t.x,t.y+e*n,t.z+e*r)}this.getBatch(r,n).addLinesArrays(of,s),of.length=0}getGraphNode(t){const e=new Mc("ImmediateDebug");return e.worldTransform=t,e._dirtyWorld=e._dirtyNormal=!1,e}onPreRenderLayer(t,e,s){if(this.batchesMap.forEach(((i,n)=>{n===t&&i.onPreRender(e,s)})),!this.updatedLayers.has(t)){this.updatedLayers.add(t);const s=this.layerMeshInstances.get(t);if(s){for(let t=0;t<s.length;t++)e.push(s[t]);s.length=0}}}onPostRender(){this.allBatches.forEach((t=>t.clear())),this.allBatches.clear(),this.updatedLayers.clear()}}const cf=2.399963229728653,df={circlePoint(t){const e=Math.sqrt(Math.random()),s=2*Math.random()*Math.PI;t.x=e*Math.cos(s),t.y=e*Math.sin(s)},circlePointDeterministic(t,e,s){const i=e*cf,n=Math.sqrt(e)/Math.sqrt(s);t.x=n*Math.cos(i),t.y=n*Math.sin(i)},spherePointDeterministic(t,e,s,i=0,n=1){i=1-2*i,n=1-2*n;const r=Qe.lerp(i,n,e/s),a=Math.sqrt(1-r*r),o=cf*e;t.x=Math.cos(o)*a,t.y=r,t.z=Math.sin(o)*a},radicalInverse(t){let e=(t<<16|t>>>16)>>>0;return e=((1431655765&e)<<1|(2863311530&e)>>>1)>>>0,e=((858993459&e)<<2|(3435973836&e)>>>2)>>>0,e=((252645135&e)<<4|(4042322160&e)>>>4)>>>0,e=((16711935&e)<<8|(4278255360&e)>>>8)>>>0,2.3283064365386963e-10*e}},uf=t=>{switch(t){case Ei:return"Cubemap";case"octahedral":return"Octahedral";default:return"Equirect"}},ff=(t,e,s)=>{if(t<=0)e[s+0]=0,e[s+1]=0,e[s+2]=0,e[s+3]=0;else if(t>=1)e[s+0]=255,e[s+1]=0,e[s+2]=0,e[s+3]=0;else{let i=1*t%1,n=255*t%1,r=65025*t%1;const a=16581375*t%1;i-=n/255,n-=r/255,r-=a/255,e[s+0]=Math.min(255,Math.floor(256*i)),e[s+1]=Math.min(255,Math.floor(256*n)),e[s+2]=Math.min(255,Math.floor(256*r)),e[s+3]=Math.min(255,Math.floor(256*a))}},pf=(t,e,s,i)=>{const n=2*s*Math.PI,r=Math.pow(1-e,1/(i+1)),a=Math.sqrt(1-r*r);t.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize()},mf=(t,e,s)=>{const i=2*s*Math.PI,n=Math.sqrt(1-e),r=Math.sqrt(e);t.set(Math.cos(i)*r,Math.sin(i)*r,n).normalize()},_f=(t,e,s,i)=>{const n=2*s*Math.PI,r=Math.sqrt((1-e)/(1+(i*i-1)*e)),a=Math.sqrt(1-r*r);t.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize()},gf=(t,e)=>{const s=t*e,i=e/(1-t*t+s*s);return i*i*(1/Math.PI)},vf={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},bf=(t,e,s)=>{const i=s/t,n=1-Math.log2(e)/11,r=n*n,a=new rs,o=new rs,l=new rs(0,0,1),h=[],c=((t,e)=>{const s=vf[t];return s&&s[e]||t})(t,e);for(let t=0;t<c;++t){_f(a,t/c,df.radicalInverse(t),r);const e=a.z;if(o.set(a.x,a.y,a.z).mulScalar(2*e).sub(l),o.z>0){const t=gf(Math.min(1,e),r)/4+.001,s=.5*Math.log2(i/t);h.push(o.x,o.y,o.z,s)}}for(;h.length<4*t;)h.push(0,0,0,0);return h},yf=(t,e,s)=>{const i=(t=>{const e=t.length,s=Math.min(e,512),i=Math.ceil(e/s),n=new Uint8Array(s*i*4);let r=0;for(let s=0;s<e;s+=4)ff(.5*t[s+0]+.5,n,r+0),ff(.5*t[s+1]+.5,n,r+4),ff(.5*t[s+2]+.5,n,r+8),ff(t[s+3]/8,n,r+12),r+=16;return{width:s,height:i,data:n}})(s);return new dn(t,{name:e,width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[i.data]})};class Sf{constructor(t=!0){this.map=new Map,this.destroyContent=t}destroy(){this.destroyContent&&this.map.forEach(((t,e)=>{t.destroy()}))}get(t,e){if(!this.map.has(t)){const s=e();return this.map.set(t,s),s}return this.map.get(t)}}const xf=new Sf(!1),wf=new ln,Tf=(t,e,s)=>wf.get(t,(()=>new Sf)).get(e,(()=>yf(t,e,xf.get(e,s)))),Ef=(t,e,s)=>Tf(t,`lambert-samples-${e}-${s}`,(()=>((t,e)=>{const s=e/t,i=new rs,n=[];for(let e=0;e<t;++e){mf(i,e/t,df.radicalInverse(e));const r=i.z/Math.PI,a=.5*Math.log2(s/r);n.push(i.x,i.y,i.z,a)}return n})(e,s))),Cf=(t,e,s)=>Tf(t,`phong-samples-${e}-${s}`,(()=>((t,e)=>{const s=new rs,i=[];for(let n=0;n<t;++n)pf(s,n/t,df.radicalInverse(n),e),i.push(s.x,s.y,s.z,0);return i})(e,s)));function Af(t,e,s={}){const i=s.seamPixels??0,n=(s.rect?.z??e.width)-2*i,r=(s.rect?.w??e.height)-2*i;if(n<1||r<1)return!1;const a=s.hasOwnProperty("specularPower")?s.specularPower:1,o=s.hasOwnProperty("face")?s.face:null,l=s.hasOwnProperty("distribution")?s.distribution:1===a?"none":"phong",h={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[l]||"reproject",c=h.startsWith("prefilterSamples"),d=Xu.decodeFunc(t.encoding),u=Xu.encodeFunc(e.encoding),f=`sample${uf(t.projection)}`,p=`getDirection${uf(e.projection)}`,m=s.hasOwnProperty("numSamples")?s.numSamples:1024,_=`ReprojectShader:${h}_${d}_${u}_${f}_${p}_${m}`,g=t.device;let v=bh(g).getCachedShader(_);if(!v){const e=new Map;c&&e.set("USE_SAMPLES_TEX",""),t.cubemap&&e.set("CUBEMAP_SOURCE",""),e.set("{PROCESS_FUNC}",h),e.set("{DECODE_FUNC}",d),e.set("{ENCODE_FUNC}",u),e.set("{SOURCE_FUNC}",f),e.set("{TARGET_FUNC}",p),e.set("{NUM_SAMPLES}",m),e.set("{NUM_SAMPLES_SQRT}",Math.round(Math.sqrt(m)).toFixed(1));const s=g.isWebGPU,i=Ch.get(g,s?Di:Ai),n=new Map;n.set("decodePS",i.get("decodePS")),n.set("encodePS",i.get("encodePS")),v=Ph.createShader(g,{uniqueName:_,attributes:{vertex_position:$s},vertexChunk:"reprojectVS",fragmentChunk:"reprojectPS",fragmentIncludes:n,fragmentDefines:e})}g.setBlendState(Sn.NOBLEND);g.scope.resolve(t.cubemap?"sourceCube":"sourceTex").setValue(t);const b=g.scope.resolve("params"),y=g.scope.resolve("uvMod");i>0?y.setValue([(n+2*i)/n,(r+2*i)/r,-i/n,-i/r]):y.setValue([1,1,0,0]);const S=[0,e.width*e.height*(e.cubemap?6:1),t.width*t.height*(t.cubemap?6:1)];if(c){const e=t.width*t.height*(t.cubemap?6:1),s="ggx"===l?((t,e,s,i)=>Tf(t,`ggx-samples-${e}-${s}-${i}`,(()=>bf(e,s,i))))(g,m,a,e):"lambert"===l?Ef(g,m,e):Cf(g,m,a);g.scope.resolve("samplesTex").setValue(s),g.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height])}for(let t=0;t<(e.cubemap?6:1);t++)if(null===o||t===o){const i=new Hn({colorBuffer:e,face:t,depth:!1,flipY:g.isWebGPU});S[0]=t,b.setValue(S),Nh(g,i,v,s?.rect),i.destroy()}return!0}const Df=(t,e=0)=>1+Math.floor(Math.log2(Math.max(t,e)));class Pf{static generateSkyboxCubemap(t,e){const s=((t,e,s)=>new dn(t,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:s,type:vi,addressU:1,addressV:1,mipmaps:!1}))(t.device,e||(t.cubemap?t.width:t.width/4),7);return Af(t,s,{numSamples:1024}),s}static generateLightingSource(t,e){const s=t.device,i=(t=>(t=>t.textureHalfFloatRenderable)(t)?Ps:(t=>t.textureFloatRenderable)(t)?Ls:7)(s),n=e?.target||new dn(s,{name:"lighting-source",cubemap:!0,width:e?.size||128,height:e?.size||128,format:i,type:7===i?vi:mi,addressU:1,addressV:1,mipmaps:!0});return Af(t,n,{numSamples:t.mipmaps?1:1024}),n}static generateAtlas(t,e){const s=t.device,i=e?.target||new dn(s,{name:"envAtlas",width:e?.size||512,height:e?.size||512,format:7,type:vi,projection:Ci,addressU:1,addressV:1,mipmaps:!1}),n=i.width/512,r=new ls(0,0,512*n,256*n),a=Df(256)-Df(4);for(let e=0;e<a;++e)Af(t,i,{numSamples:1,rect:r,seamPixels:n}),r.x+=r.w,r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));r.set(0,256*n,256*n,128*n);for(let s=1;s<7;++s)Af(t,i,{numSamples:e?.numReflectionSamples||1024,distribution:e?.distribution||"ggx",specularPower:Math.max(1,2048>>2*s),rect:r,seamPixels:n}),r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));return r.set(128*n,384*n,64*n,32*n),Af(t,i,{numSamples:e?.numAmbientSamples||2048,distribution:"lambert",rect:r,seamPixels:n}),i}static generatePrefilteredAtlas(t,e){const s=t[0].device,i=t[0].format,n=t[0].type,r=e?.target||new dn(s,{name:"envPrefilteredAtlas",width:e?.size||512,height:e?.size||512,format:i,type:n,projection:Ci,addressU:1,addressV:1,mipmaps:!1}),a=r.width/512,o=new ls(0,0,512*a,256*a),l=Df(512);for(let e=0;e<l;++e)Af(t[0],r,{numSamples:1,rect:o,seamPixels:a}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*a,256*a,128*a);for(let e=1;e<t.length;++e)Af(t[e],r,{numSamples:1,rect:o,seamPixels:a}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*a,384*a,64*a,32*a),e?.legacyAmbient?Af(t[5],r,{numSamples:1,rect:o,seamPixels:a}):Af(t[0],r,{numSamples:e?.numSamples||2048,distribution:"lambert",rect:o,seamPixels:a}),r}}class Lf{constructor(){this.type=fl,this.color=new Ze(0,0,0),this.density=0,this.start=1,this.end=1e3}}class If extends Ve{static{this.EVENT_SETLAYERS="set:layers"}static{this.EVENT_SETSKYBOX="set:skybox"}static{this.EVENT_PRERENDER="prerender"}static{this.EVENT_POSTRENDER="postrender"}static{this.EVENT_PRERENDER_LAYER="prerender:layer"}static{this.EVENT_POSTRENDER_LAYER="postrender:layer"}static{this.EVENT_PRECULL="precull"}static{this.EVENT_POSTCULL="postcull"}constructor(t){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new Ze(0,0,0),this.ambientLuminance=0,this.exposure=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this._fogParams=new Lf,this.forcePassThroughSpecular=!1,this.device=t,this._gravity=new rs(0,-9.8,0),this._layers=null,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxHighlightMultiplier=1,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new ms,this._skyboxRotationMat3=new as,this._skyboxRotationMat4=new ps,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new Nu(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this.updateShaders=!0})),this._sky=new sf(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new hf(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(t){this._ambientBakeNumSamples=Qe.clamp(Math.floor(t),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(t){this._ambientBakeSpherePart=Qe.clamp(t,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(t){this.device.isWebGPU&&!t||(this._clusteredLightingEnabled||!t?this._clusteredLightingEnabled=t:console.error("Turning on disabled clustered lighting is not currently supported"))}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(t){t!==this._envAtlas&&(this._envAtlas=t,t&&(t.addressU=1,t.addressV=1,t.minFilter=1,t.magFilter=1,t.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set layers(t){const e=this._layers;this._layers=t,this.fire("set:layers",e,t)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}get fog(){return this._fogParams}set lightmapFilterRange(t){this._lightmapFilterRange=Math.max(t,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(t){this._lightmapFilterSmoothness=Math.max(t,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(t){t=t||[];const e=this._prefilteredCubemaps,s=e.length!==t.length||e.some(((e,s)=>e!==t[s]));if(s){const e=6===t.length&&t.every((t=>!!t));e?(this._internalEnvAtlas=Pf.generatePrefilteredAtlas(t,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=t.slice(),this._resetSkyMesh()}}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(t){t!==this._skyboxCubeMap&&(this._skyboxCubeMap=t,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(t){t!==this._skyboxIntensity&&(this._skyboxIntensity=t,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(t){t!==this._skyboxLuminance&&(this._skyboxLuminance=t,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(t){t!==this._skyboxMip&&(this._skyboxMip=t,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxHighlightMultiplier(t){t!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=t,this._resetSkyMesh())}get skyboxHighlightMultiplier(){return this._skyboxHighlightMultiplier}set skyboxRotation(t){if(!this._skyboxRotation.equals(t)){const e=t.equals(ms.IDENTITY);this._skyboxRotation.copy(t),e?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(rs.ZERO,t,rs.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||e||(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(t,e,s=Ze.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([t,e],[s,s])}drawLines(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(t,e)}drawLineArrays(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(t,e)}applySettings(t){const e=t.physics,s=t.render;this._gravity.set(e.gravity[0],e.gravity[1],e.gravity[2]),this.ambientLight.set(s.global_ambient[0],s.global_ambient[1],s.global_ambient[2]),this.ambientLuminance=s.ambientLuminance,this.fog.type=s.fog,this.fog.color.set(s.fog_color[0],s.fog_color[1],s.fog_color[2]),this.fog.start=s.fog_start,this.fog.end=s.fog_end,this.fog.density=s.fog_density,this.lightmapSizeMultiplier=s.lightmapSizeMultiplier,this.lightmapMaxResolution=s.lightmapMaxResolution,this.lightmapMode=s.lightmapMode,this.exposure=s.exposure,this._skyboxIntensity=s.skyboxIntensity??1,this._skyboxLuminance=s.skyboxLuminance??2e4,this._skyboxMip=s.skyboxMip??0,s.skyboxRotation&&(this.skyboxRotation=(new ms).setFromEulerAngles(s.skyboxRotation[0],s.skyboxRotation[1],s.skyboxRotation[2])),this.sky.applySettings(s),this.clusteredLightingEnabled=s.clusteredLightingEnabled??!1,this.lighting.applySettings(s),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach((t=>{s.hasOwnProperty(t)&&(this[t]=s[t])})),this._resetSkyMesh()}_getSkyboxTex(){const t=this._prefilteredCubemaps;if(this._skyboxMip){return t[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||t[0]||this._skyboxCubeMap}return this._skyboxCubeMap||t[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(t){t?(this.skybox=t[0]||null,t[1]&&!t[1].cubemap?this.envAtlas=t[1]:this.prefilteredCubemaps=t.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}}class Rf{constructor(t,e,s){this.device=t,this.inverseBindPose=e,this.boneNames=s}}class Mf extends Ao{set shader(t){this.quadRender?.destroy(),this.quadRender=null,this._shader=t,t&&(this.quadRender=new kh(t))}get shader(){return this._shader}execute(){const t=this.device;t.setBlendState(this.blendState),t.setCullMode(this.cullMode),t.setDepthState(this.depthState),t.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render()}constructor(...t){super(...t),this._shader=null,this.quadRender=null,this.cullMode=0,this.blendState=Sn.NOBLEND,this.depthState=Tn.NODEPTH,this.stencilFront=null,this.stencilBack=null}}class kf{constructor(){this.hasTangents=!1,this.shaderChunks=null,this.pass=0,this.alphaTest=!1,this.blendType=3,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.batch=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBasedInt=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.pixelSnap=!1,this.ambientSH=!1,this.ssao=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=lh,this.opacityShadowDither=lh,this.cubeMapProjection=0,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.dispersion=!1,this.fog=fl,this.gamma=0,this.toneMap=-1,this.reflectionSource=Hl,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=!1,this.shadowCatcher=!1}}class Of{static update(t,e,s,i,n,r,a){Of.updateSharedOptions(t,e,s,n,r),Of.updateMaterialOptions(t,e),Of.updateEnvOptions(t,e,s,i),Of.updateLightingOptions(t,e,s,n,a)}static updateSharedOptions(t,e,s,i,n){t.shaderChunks=e.shaderChunks,t.pass=n,t.alphaTest=e.alphaTest>0,t.blendType=e.blendType,t.screenSpace=i&&!!(256&i),t.skin=i&&!!(2&i),t.useInstancing=i&&!!(32&i),t.useMorphPosition=i&&0!==(i&Zl),t.useMorphNormal=i&&0!==(i&Jl),t.useMorphTextureBasedInt=i&&0!==(i&th),t.hasTangents=i&&!!(512&i),t.nineSlicedMode=e.nineSlicedMode||0,e.useLighting&&s.clusteredLightingEnabled?(t.clusteredLightingEnabled=!0,t.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,t.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,t.clusteredLightingShadowType=s.lighting.shadowType,t.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(t.clusteredLightingEnabled=!1,t.clusteredLightingCookiesEnabled=!1,t.clusteredLightingShadowsEnabled=!1,t.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(t,e){t.separateAmbient=!1,t.pixelSnap=e.pixelSnap,t.ambientSH=e.ambientSH,t.twoSidedLighting=e.twoSidedLighting,t.occludeDirect=e.occludeDirect,t.occludeSpecular=e.occludeSpecular,t.occludeSpecularFloat=1!==e.occludeSpecularIntensity,t.useMsdf=!1,t.msdfTextAttribute=!1,t.alphaToCoverage=e.alphaToCoverage,t.opacityFadesSpecular=e.opacityFadesSpecular,t.opacityDither=e.opacityDither,t.cubeMapProjection=0,t.useSpecular=e.hasSpecular,t.useSpecularityFactor=e.hasSpecularityFactor,t.enableGGXSpecular=e.ggxSpecular,t.fresnelModel=e.fresnelModel,t.useRefraction=e.hasRefraction,t.useClearCoat=e.hasClearCoat,t.useSheen=e.hasSheen,t.useIridescence=e.hasIrridescence,t.useMetalness=e.hasMetalness,t.useDynamicRefraction=e.dynamicRefraction,t.dispersion=e.dispersion>0,t.vertexColors=!1,t.lightMapEnabled=e.hasLighting,t.dirLightMapEnabled=e.dirLightMap,t.useHeights=e.hasHeights,t.useNormals=e.hasNormals,t.useClearCoatNormals=e.hasClearCoatNormals,t.useAo=e.hasAo,t.diffuseMapEnabled=e.hasDiffuseMap}static updateEnvOptions(t,e,s,i){t.fog=e.useFog?i.fog:fl,t.gamma=i.shaderOutputGamma,t.toneMap=e.useTonemap?i.toneMapping:6,e.useSkybox&&s.envAtlas&&s.skybox?(t.reflectionSource=Wl,t.reflectionEncoding=s.envAtlas.encoding,t.reflectionCubemapEncoding=s.skybox.encoding):e.useSkybox&&s.envAtlas?(t.reflectionSource=Gl,t.reflectionEncoding=s.envAtlas.encoding):e.useSkybox&&s.skybox?(t.reflectionSource=jl,t.reflectionEncoding=s.skybox.encoding):(t.reflectionSource=Hl,t.reflectionEncoding=null),e.ambientSH?(t.ambientSource=ql,t.ambientEncoding=null):t.reflectionSource!==Hl&&s.envAtlas?(t.ambientSource=Kl,t.ambientEncoding=s.envAtlas.encoding):(t.ambientSource=Yl,t.ambientEncoding=null);const n=t.reflectionSource!==Hl;t.skyboxIntensity=n,t.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}static updateLightingOptions(t,e,s,i,n){if(t.lightMapWithoutAmbient=!1,e.useLighting){const e=[],r=i?i>>16:1;t.lightMaskDynamic=!!(1&r),t.lightMapWithoutAmbient=!1,n&&(Of.collectLights(0,n[0],e,r),s.clusteredLightingEnabled||(Of.collectLights(1,n[1],e,r),Of.collectLights(2,n[2],e,r))),t.lights=e}else t.lights=[];(0===t.lights.length&&!s.clusteredLightingEnabled||1&i)&&(t.noShadow=!0)}static collectLights(t,e,s,i){for(let t=0;t<e.length;t++){const n=e[t];n.enabled&&n.mask&i&&s.push(n)}}}const Ff={vertex_normal:qs,vertex_tangent:Ks,vertex_texCoord0:ti,vertex_texCoord1:ei,vertex_color:Zs,vertex_boneWeights:Ys,vertex_boneIndices:Qs};class Nf{constructor(t,e,s=!0){this.varyingsCode="",this.vDefines=new Map,this.fDefines=new Map,this.includes=new Map,this.chunks=null,this.device=t,this.options=e;const i=e.shaderChunks;if(this.shaderLanguage=t.isWebGPU&&s&&i?.useWGSL?Di:Ai,this.attributes={vertex_position:$s},e.userAttributes)for(const[t,s]of Object.entries(e.userAttributes))this.attributes[s]=t;const n=Ch.get(t,this.shaderLanguage);if(this.chunks=new Map(n),i){(this.shaderLanguage===Ai?i.glsl:i.wgsl).forEach(((t,e)=>{for(const e in Ff)Ff.hasOwnProperty(e)&&t.indexOf(e)>=0&&(this.attributes[e]=Ff[e]);this.chunks.set(e,t)}))}this.shaderPassInfo=wh.get(this.device).getByIndex(e.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=e.lights.length>0||e.dirLightMapEnabled||e.clusteredLightingEnabled,this.reflections=e.reflectionSource!==Hl,this.needsNormal=this.lighting||this.reflections||e.useSpecular||e.ambientSH||e.useHeights||e.enableGGXSpecular||e.clusteredLightingEnabled&&!this.shadowPass||e.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=e.useDynamicRefraction,this.needsScreenSize=e.useDynamicRefraction,this.needsTransforms=e.useDynamicRefraction,this.vshader=null,this.fshader=null}fDefineSet(t,e,s=""){t&&this.fDefines.set(e,s)}generateVertexShader(t,e,s){const{options:i,vDefines:n,attributes:r}=this,a=new Map;if(a.set("vPositionW","vec3"),1!==i.nineSlicedMode&&2!==i.nineSlicedMode||n.set("NINESLICED",!0),this.options.linearDepth&&(n.set("LINEAR_DEPTH",!0),a.set("vLinearDepth","float")),this.needsNormal&&n.set("NORMALS",!0),this.options.useInstancing){const t=Ch.get(this.device,this.shaderLanguage);this.chunks.get("transformInstancingVS")===t.get("transformInstancingVS")&&(r.instance_line1=ci,r.instance_line2=di,r.instance_line3=fi,r.instance_line4=pi)}this.needsNormal&&(r.vertex_normal=qs,a.set("vNormalW","vec3"),i.hasTangents&&(i.useHeights||i.useNormals||i.useClearCoatNormals||i.enableGGXSpecular)?(n.set("TANGENTS",!0),r.vertex_tangent=Ks,a.set("vTangentW","vec3"),a.set("vBinormalW","vec3")):i.enableGGXSpecular&&(n.set("GGX_SPECULAR",!0),a.set("vObjectSpaceUpW","vec3")));for(let s=0;s<2;s++)t[s]&&(n.set(`UV${s}`,!0),r[`vertex_texCoord${s}`]=`TEXCOORD${s}`),e[s]&&(n.set(`UV${s}_UNMODIFIED`,!0),a.set(`vUv${s}`,"vec2"));let o=0;const l=new Set;s.forEach((t=>{const{id:e,uv:s,name:i}=t,r=e+100*s;if(!l.has(r)){l.add(r),a.set(`vUV${s}_${e}`,"vec2");const t=`texture_${i}MapTransform`;n.set(`{TRANSFORM_NAME_${o}}`,t),n.set(`{TRANSFORM_UV_${o}}`,s),n.set(`{TRANSFORM_ID_${o}}`,e),o++}})),n.set("UV_TRANSFORMS_COUNT",o),i.vertexColors&&(r.vertex_color=Zs,n.set("VERTEX_COLOR",!0),a.set("vVertexColor","vec4")),i.useMsdf&&i.msdfTextAttribute&&(r.vertex_outlineParameters=li,r.vertex_shadowParameters=hi,n.set("MSDF",!0)),(i.useMorphPosition||i.useMorphNormal)&&(n.set("MORPHING",!0),i.useMorphTextureBasedInt&&n.set("MORPHING_INT",!0),i.useMorphPosition&&n.set("MORPHING_POSITION",!0),i.useMorphNormal&&n.set("MORPHING_NORMAL",!0),r.morph_vertex_id=pi),i.skin&&(r.vertex_boneIndices=Qs,i.batch?n.set("BATCH",!0):(r.vertex_boneWeights=Ys,n.set("SKIN",!0))),i.useInstancing&&n.set("INSTANCING",!0),i.screenSpace&&n.set("SCREENSPACE",!0),i.pixelSnap&&n.set("PIXELSNAP",!0),a.forEach(((t,e)=>{this.varyingsCode+=`#define VARYING_${e.toUpperCase()}\n`,this.varyingsCode+=this.shaderLanguage===Di?`varying ${e}: ${Zi.get(t)};\n`:`varying ${t} ${e};\n`})),this.includes.set("varyingsVS",this.varyingsCode),this.includes.set("varyingsPS",this.varyingsCode),this.vshader='\n\t\t\t\t\t\t#include "litMainVS"\n\t\t\t\t'}_setupLightingDefines(t,e){const s=this.fDefines,i=this.options;if(this.fDefines.set("LIGHT_COUNT",i.lights.length),t&&s.set("AREA_LIGHTS",!0),e&&this.lighting&&(s.set("LIT_CLUSTERED_LIGHTS",!0),i.clusteredLightingCookiesEnabled&&s.set("CLUSTER_COOKIES",!0),i.clusteredLightingAreaLightsEnabled&&s.set("CLUSTER_AREALIGHTS",!0),i.lightMaskDynamic&&s.set("CLUSTER_MESH_DYNAMIC_LIGHTS",!0),i.clusteredLightingShadowsEnabled&&!i.noShadow)){const t=Ll.get(i.clusteredLightingShadowType);s.set("CLUSTER_SHADOWS",!0),s.set(`SHADOW_KIND_${t.kind}`,!0),s.set(`CLUSTER_SHADOW_TYPE_${t.kind}`,!0)}for(let n=0;n<i.lights.length;n++){const r=i.lights[n],a=r._type;if(e&&0!==a)continue;const o=t&&r._shape?r._shape:0,l=r._shadowType,h=r.castShadows&&!i.noShadow,c=Ll.get(l);s.set(`LIGHT${n}`,!0),s.set(`LIGHT${n}TYPE`,`${yl[a]}`),s.set(`LIGHT${n}SHADOWTYPE`,`${c.name}`),s.set(`LIGHT${n}SHAPE`,`${Cl[o]}`),s.set(`LIGHT${n}FALLOFF`,`${Pl[r._falloffMode]}`),r.affectSpecularity&&s.set(`LIGHT${n}AFFECT_SPECULARITY`,!0),r._cookie&&(2===a&&!r._cookie._cubemap||1===a&&r._cookie._cubemap)&&(s.set(`LIGHT${n}COOKIE`,!0),s.set(`{LIGHT${n}COOKIE_CHANNEL}`,r._cookieChannel),2===a&&(r._cookieTransform&&s.set(`LIGHT${n}COOKIE_TRANSFORM`,!0),r._cookieFalloff&&s.set(`LIGHT${n}COOKIE_FALLOFF`,!0))),h&&(s.set(`LIGHT${n}CASTSHADOW`,!0),c.pcf&&s.set(`LIGHT${n}SHADOW_PCF`,!0),r._normalOffsetBias&&!r._isVsm&&s.set(`LIGHT${n}_SHADOW_SAMPLE_NORMAL_OFFSET`,!0),0===a&&(s.set(`LIGHT${n}_SHADOW_SAMPLE_ORTHO`,!0),r.cascadeBlend>0&&s.set(`LIGHT${n}_SHADOW_CASCADE_BLEND`,!0),r.numCascades>1&&s.set(`LIGHT${n}_SHADOW_CASCADES`,!0)),(c.pcf||c.pcss||this.device.isWebGPU)&&s.set(`LIGHT${n}_SHADOW_SAMPLE_SOURCE_ZBUFFER`,!0),1===a&&s.set(`LIGHT${n}_SHADOW_SAMPLE_POINT`,!0)),h&&(s.set(`SHADOW_KIND_${c.kind}`,!0),0===a&&s.set("SHADOW_DIRECTIONAL",!0))}}prepareForwardPass(t){const{options:e}=this,s=e.clusteredLightingEnabled&&e.clusteredLightingAreaLightsEnabled||e.lights.some((t=>t._shape&&0!==t._shape)),i=!e.lightMapEnabled||e.lightMapWithoutAmbient,n=this.needsNormal&&(e.useNormals||e.useClearCoatNormals||e.enableGGXSpecular&&!e.useHeights);e.useSpecular&&(this.fDefineSet(!0,"LIT_SPECULAR"),this.fDefineSet(this.reflections,"LIT_REFLECTIONS"),this.fDefineSet(e.useClearCoat,"LIT_CLEARCOAT"),this.fDefineSet(e.fresnelModel>0,"LIT_SPECULAR_FRESNEL"),this.fDefineSet(e.useSheen,"LIT_SHEEN"),this.fDefineSet(e.useIridescence,"LIT_IRIDESCENCE")),this.fDefineSet(this.lighting&&e.useSpecular||this.reflections,"LIT_SPECULAR_OR_REFLECTION"),this.fDefineSet(this.needsSceneColor,"LIT_SCENE_COLOR"),this.fDefineSet(this.needsScreenSize,"LIT_SCREEN_SIZE"),this.fDefineSet(this.needsTransforms,"LIT_TRANSFORMS"),this.fDefineSet(this.needsNormal,"LIT_NEEDS_NORMAL"),this.fDefineSet(this.lighting,"LIT_LIGHTING"),this.fDefineSet(e.useMetalness,"LIT_METALNESS"),this.fDefineSet(e.enableGGXSpecular,"LIT_GGX_SPECULAR"),this.fDefineSet(e.useSpecularityFactor,"LIT_SPECULARITY_FACTOR"),this.fDefineSet(e.useCubeMapRotation,"CUBEMAP_ROTATION"),this.fDefineSet(e.occludeSpecularFloat,"LIT_OCCLUDE_SPECULAR_FLOAT"),this.fDefineSet(e.separateAmbient,"LIT_SEPARATE_AMBIENT"),this.fDefineSet(e.twoSidedLighting,"LIT_TWO_SIDED_LIGHTING"),this.fDefineSet(e.lightMapEnabled,"LIT_LIGHTMAP"),this.fDefineSet(e.dirLightMapEnabled,"LIT_DIR_LIGHTMAP"),this.fDefineSet(e.skyboxIntensity>0,"LIT_SKYBOX_INTENSITY"),this.fDefineSet(e.clusteredLightingShadowsEnabled,"LIT_CLUSTERED_SHADOWS"),this.fDefineSet(e.clusteredLightingAreaLightsEnabled,"LIT_CLUSTERED_AREA_LIGHTS"),this.fDefineSet(n,"LIT_TBN"),this.fDefineSet(i,"LIT_ADD_AMBIENT"),this.fDefineSet(e.hasTangents,"LIT_TANGENTS"),this.fDefineSet(e.useNormals,"LIT_USE_NORMALS"),this.fDefineSet(e.useClearCoatNormals,"LIT_USE_CLEARCOAT_NORMALS"),this.fDefineSet(e.useRefraction,"LIT_REFRACTION"),this.fDefineSet(e.useDynamicRefraction,"LIT_DYNAMIC_REFRACTION"),this.fDefineSet(e.dispersion,"LIT_DISPERSION"),this.fDefineSet(e.useHeights,"LIT_HEIGHTS"),this.fDefineSet(e.opacityFadesSpecular,"LIT_OPACITY_FADES_SPECULAR"),this.fDefineSet(e.alphaToCoverage,"LIT_ALPHA_TO_COVERAGE"),this.fDefineSet(e.alphaTest,"LIT_ALPHA_TEST"),this.fDefineSet(e.useMsdf,"LIT_MSDF"),this.fDefineSet(e.ssao,"LIT_SSAO"),this.fDefineSet(e.useAo,"LIT_AO"),this.fDefineSet(e.occludeDirect,"LIT_OCCLUDE_DIRECT"),this.fDefineSet(e.msdfTextAttribute,"LIT_MSDF_TEXT_ATTRIBUTE"),this.fDefineSet(e.diffuseMapEnabled,"LIT_DIFFUSE_MAP"),this.fDefineSet(e.shadowCatcher,"LIT_SHADOW_CATCHER"),this.fDefineSet(!0,"LIT_FRESNEL_MODEL",_l[e.fresnelModel]),this.fDefineSet(!0,"LIT_NONE_SLICE_MODE",rh[e.nineSlicedMode]),this.fDefineSet(!0,"LIT_BLEND_TYPE",ul[e.blendType]),this.fDefineSet(!0,"LIT_CUBEMAP_PROJECTION",Ml[e.cubeMapProjection]),this.fDefineSet(!0,"LIT_OCCLUDE_SPECULAR",Vl[e.occludeSpecular]),this.fDefineSet(!0,"LIT_REFLECTION_SOURCE",$l[e.reflectionSource]),this.fDefineSet(!0,"LIT_AMBIENT_SOURCE",Ql[e.ambientSource]),this.fDefineSet(!0,"{lightingUv}",t??""),this.fDefineSet(!0,"{reflectionDecode}",Xu.decodeFunc(e.reflectionEncoding)),this.fDefineSet(!0,"{reflectionCubemapDecode}",Xu.decodeFunc(e.reflectionCubemapEncoding)),this.fDefineSet(!0,"{ambientDecode}",Xu.decodeFunc(e.ambientEncoding)),this._setupLightingDefines(s,e.clusteredLightingEnabled)}prepareShadowPass(){const{options:t}=this,e=this.shaderPassInfo.lightType,s=this.shaderPassInfo.shadowType,i=Ll.get(s),n=0===e||!i.vsm&&2===e;this.fDefineSet(n,"PERSPECTIVE_DEPTH"),this.fDefineSet(!0,"LIGHT_TYPE",`${yl[e]}`),this.fDefineSet(!0,"SHADOW_TYPE",`${i.name}`),this.fDefineSet(t.alphaTest,"LIT_ALPHA_TEST")}generateFragmentShader(t,e,s){const i=this.options;this.includes.set("frontendDeclPS",t??""),this.includes.set("frontendCodePS",e??""),3===i.pass||1===i.pass||(this.shadowPass?this.prepareShadowPass():this.prepareForwardPass(s)),this.fshader='\n\t\t\t\t\t\t#include "litMainPS"\n\t\t\t\t'}}const Bf={generateKey:t=>`lit${Object.keys(t).sort().map((e=>"shaderChunks"===e?t.shaderChunks?.key??"":"lights"===e?Bf.generateLightsKey(t):e+t[e])).join("\n")}`,generateLightsKey:t=>`lights:${t.lights.map((e=>t.clusteredLightingEnabled&&0!==e._type?"":`${e.key},`)).join("")}`};class Uf{get pass(){return this.litOptions.pass}constructor(){this.defines=new Map,this.forceUv1=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.normalDetailPackedNormal=!1,this.clearCoatPackedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.useAO=!1,this.litOptions=new kf}}const zf=[],Vf=t=>Object.keys(t).filter((t=>"litOptions"!==t)).sort();const Hf=new class extends yh{generateKey(t){let e;t===this.optionsContextMin?(this.propsMin||(this.propsMin=Vf(t)),e=this.propsMin):t===this.optionsContext?(this.props||(this.props=Vf(t)),e=this.props):e=Vf(t);return`standard:\n${yh.definesHash(t.defines)}\n${e.map((e=>e+t[e])).join("\n")}${Bf.generateKey(t.litOptions)}`}_getUvSourceExpression(t,e,s){const i=s[t],n=s[e],r=0===s.litOptions.pass;let a;return r&&1===s.litOptions.nineSlicedMode||r&&2===s.litOptions.nineSlicedMode?a="nineSlicedUv":(a=0===i?`vUv${n}`:`vUV${n}_${i}`,s.heightMap&&"heightMapTransform"!==t&&(a+=" + dUvOffset")),a}_validateMapChunk(t,e,s){}_addMapDefines(t,e,s,i,n,r,a=null){const o=`${e}Map`,l=e.toUpperCase(),h=`${o}Uv`,c=`${o}Identifier`,d=`${o}Transform`,u=`${o}Channel`,f=`${e}VertexColorChannel`,p=`${e}VertexColor`,m=`${e}Mode`,_=`${e}Invert`,g=i[`${e}Tint`],v=i[p],b=i[o],y=i[c],S=i[m],x=n.get(s);if(b){t.set(`STD_${l}_TEXTURE`,"");const e=this._getUvSourceExpression(d,h,i);t.set(`{STD_${l}_TEXTURE_UV}`,e),t.set(`{STD_${l}_TEXTURE_CHANNEL}`,i[u]);const s=`{STD_${l}_TEXTURE_NAME}`;if(x.includes(s)){let e=`texture_${o}`;const i=r[y];i?e=i:(r[y]=e,t.set(`STD_${l}_TEXTURE_ALLOCATE`,"")),t.set(s,e)}if(a){const e="aaa"===i[u]?"passThrough":Xu.decodeFunc(a);t.set(`{STD_${l}_TEXTURE_DECODE}`,e)}}v&&(t.set(`STD_${l}_VERTEX`,""),t.set(`{STD_${l}_VERTEX_CHANNEL}`,i[f])),S&&t.set(`{STD_${l}_DETAILMODE}`,S),g&&t.set(`STD_${l}_CONSTANT`,""),i[_]&&t.set(`STD_${l}_INVERT`,"")}_correctChannel(t,e,s){if(s[t]>0){if(s[t]<e.length)return e.substring(0,s[t]);if(s[t]>e.length){let i=e;const n=i.charAt(i.length-1),r=s[t]-i.length;for(let t=0;t<r;t++)i+=n;return i}return e}}createVertexShader(t,e){const s=[],i=[],n=[];for(const t in zf){const r=`${t}Map`;if(e[`${t}VertexColor`]){const s=`${t}VertexColorChannel`;e[s]=this._correctChannel(t,e[s],zf)}if(e[r]){const a=`${r}Channel`,o=`${r}Transform`,l=`${r}Uv`;e[l]=Math.min(e[l],1),e[a]=this._correctChannel(t,e[a],zf);const h=e[l];s[h]=!0,i[h]=i[h]||e[r]&&!e[o],e[o]&&n.push({name:t,id:e[o],uv:e[l]})}}e.forceUv1&&(s[1]=!0,i[1]=void 0===i[1]||i[1]),t.generateVertexShader(s,i,n)}prepareFragmentDefines(t,e,s){const i=(t,s,i="")=>{t&&e.set(s,i)};i(t.lightMap,"STD_LIGHTMAP",""),i(t.lightVertexColor,"STD_LIGHT_VERTEX_COLOR",""),i(t.dirLightMap&&t.litOptions.useSpecular,"STD_LIGHTMAP_DIR",""),i(t.heightMap,"STD_HEIGHT_MAP",""),i(t.useSpecularColor,"STD_SPECULAR_COLOR",""),i(t.aoMap||t.aoVertexColor||t.useAO,"STD_AO",""),i(!0,"STD_OPACITY_DITHER",uh[s.isForward?t.litOptions.opacityDither:t.litOptions.opacityShadowDither])}createShaderDefinition(t,e){const s=wh.get(t).getByIndex(e.litOptions.pass),i=s.isForward,n=new Nf(t,e.litOptions);this.createVertexShader(n,e);const r={};e.litOptions.fresnelModel=0===e.litOptions.fresnelModel?2:e.litOptions.fresnelModel;const a=n.fDefines;this.prepareFragmentDefines(e,a,s);let o="";if(i){if(e.heightMap&&this._addMapDefines(a,"height","parallaxPS",e,n.chunks,r),(3!==e.litOptions.blendType||e.litOptions.alphaTest||e.litOptions.alphaToCoverage||e.litOptions.opacityDither!==lh)&&this._addMapDefines(a,"opacity","opacityPS",e,n.chunks,r),n.needsNormal){if((e.normalMap||e.clearCoatNormalMap)&&!e.litOptions.hasTangents){const t=e.normalMap?"normalMap":"clearCoatNormalMap";o=this._getUvSourceExpression(`${t}Transform`,`${t}Uv`,e)}this._addMapDefines(a,"normalDetail","normalMapPS",e,n.chunks,r,e.normalDetailPackedNormal?"xy":"xyz"),this._addMapDefines(a,"normal","normalMapPS",e,n.chunks,r,e.packedNormal?"xy":"xyz")}e.diffuseDetail&&this._addMapDefines(a,"diffuseDetail","diffusePS",e,n.chunks,r,e.diffuseDetailEncoding),this._addMapDefines(a,"diffuse","diffusePS",e,n.chunks,r,e.diffuseEncoding),e.litOptions.useRefraction&&(this._addMapDefines(a,"refraction","transmissionPS",e,n.chunks,r),this._addMapDefines(a,"thickness","thicknessPS",e,n.chunks,r)),e.litOptions.useIridescence&&(this._addMapDefines(a,"iridescence","iridescencePS",e,n.chunks,r),this._addMapDefines(a,"iridescenceThickness","iridescenceThicknessPS",e,n.chunks,r)),(n.lighting&&e.litOptions.useSpecular||n.reflections)&&(e.litOptions.useSheen&&(this._addMapDefines(a,"sheen","sheenPS",e,n.chunks,r,e.sheenEncoding),this._addMapDefines(a,"sheenGloss","sheenGlossPS",e,n.chunks,r)),e.litOptions.useMetalness&&(this._addMapDefines(a,"metalness","metalnessPS",e,n.chunks,r),this._addMapDefines(a,"ior","iorPS",e,n.chunks,r)),e.litOptions.useSpecularityFactor&&this._addMapDefines(a,"specularityFactor","specularityFactorPS",e,n.chunks,r),e.useSpecularColor&&this._addMapDefines(a,"specular","specularPS",e,n.chunks,r,e.specularEncoding),this._addMapDefines(a,"gloss","glossPS",e,n.chunks,r)),e.aoDetail&&this._addMapDefines(a,"aoDetail","aoPS",e,n.chunks,r),(e.aoMap||e.aoVertexColor||e.useAO)&&this._addMapDefines(a,"ao","aoPS",e,n.chunks,r),this._addMapDefines(a,"emissive","emissivePS",e,n.chunks,r,e.emissiveEncoding),e.litOptions.useClearCoat&&(this._addMapDefines(a,"clearCoat","clearCoatPS",e,n.chunks,r),this._addMapDefines(a,"clearCoatGloss","clearCoatGlossPS",e,n.chunks,r),this._addMapDefines(a,"clearCoatNormal","clearCoatNormalPS",e,n.chunks,r,e.clearCoatPackedNormal?"xy":"xyz")),e.litOptions.enableGGXSpecular&&this._addMapDefines(a,"anisotropy","anisotropyPS",e,n.chunks,r),(e.lightMap||e.lightVertexColor)&&this._addMapDefines(a,"light","lightmapPS",e,n.chunks,r,e.lightMapEncoding)}else{const t=e.litOptions.opacityShadowDither;(e.litOptions.alphaTest||t)&&this._addMapDefines(a,"opacity","opacityPS",e,n.chunks,r)}n.generateFragmentShader(n.chunks.get("stdDeclarationPS"),n.chunks.get("stdFrontEndPS"),o);const l=Ah.merge(n.chunks,n.includes),h=n.vDefines;e.defines.forEach(((t,e)=>h.set(e,t))),e.defines.forEach(((t,e)=>a.set(e,t)));const c=La.createDefinition(t,{name:"StandardShader",attributes:n.attributes,shaderLanguage:n.shaderLanguage,vertexCode:n.vshader,fragmentCode:n.fshader,vertexIncludes:l,fragmentIncludes:l,fragmentDefines:a,vertexDefines:h});return n.shaderPassInfo.isForward&&(c.tag=1),c}constructor(...t){super(...t),this.optionsContext=new Uf,this.optionsContextMin=new Uf}},Gf=(t,e)=>{if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0};class Wf{constructor(){this._mapXForms=null}updateMinRef(t,e,s,i,n,r){this._updateSharedOptions(t,e,s,i,n),this._updateMinOptions(t,s,n),this._updateUVOptions(t,s,i,!0)}updateRef(t,e,s,i,n,r,a){this._updateSharedOptions(t,e,i,n,r),this._updateEnvOptions(t,i,e,s),this._updateMaterialOptions(t,i,e),t.litOptions.hasTangents=n&&!!(512&n),this._updateLightOptions(t,e,i,n,a),this._updateUVOptions(t,i,n,!1,s)}_updateSharedOptions(t,e,s,i,n){t.forceUv1=s.forceUv1,s.userAttributes&&(t.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),t.litOptions.shaderChunks=s.shaderChunks,t.litOptions.pass=n,t.litOptions.alphaTest=s.alphaTest>0,t.litOptions.blendType=s.blendType,t.litOptions.screenSpace=i&&!!(256&i),t.litOptions.skin=i&&!!(2&i),t.litOptions.batch=i&&0!==(i&eh),t.litOptions.useInstancing=i&&!!(32&i),t.litOptions.useMorphPosition=i&&0!==(i&Zl),t.litOptions.useMorphNormal=i&&0!==(i&Jl),t.litOptions.useMorphTextureBasedInt=i&&0!==(i&th),t.litOptions.nineSlicedMode=s.nineSlicedMode||0,e.clusteredLightingEnabled&&s.useLighting?(t.litOptions.clusteredLightingEnabled=!0,t.litOptions.clusteredLightingCookiesEnabled=e.lighting.cookiesEnabled,t.litOptions.clusteredLightingShadowsEnabled=e.lighting.shadowsEnabled,t.litOptions.clusteredLightingShadowType=e.lighting.shadowType,t.litOptions.clusteredLightingAreaLightsEnabled=e.lighting.areaLightsEnabled):(t.litOptions.clusteredLightingEnabled=!1,t.litOptions.clusteredLightingCookiesEnabled=!1,t.litOptions.clusteredLightingShadowsEnabled=!1,t.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(t,e,s,i,n){let r=!1,a=!1,o=!1;s&&(r=!!(4&s),a=!!(8&s),o=!!(16&s)),t.litOptions.vertexColors=!1,this._mapXForms=[];const l={};for(const s in zf)this._updateTexOptions(t,e,s,r,a,o,i,l);this._mapXForms=null,t.litOptions.ssao=n?.ssaoEnabled,t.useAO=t.litOptions.ssao,t.litOptions.lightMapEnabled=t.lightMap,t.litOptions.dirLightMapEnabled=t.dirLightMap,t.litOptions.useHeights=t.heightMap,t.litOptions.useNormals=t.normalMap,t.litOptions.useClearCoatNormals=t.clearCoatNormalMap,t.litOptions.useAo=t.aoMap||t.aoVertexColor||t.litOptions.ssao,t.litOptions.diffuseMapEnabled=t.diffuseMap}_updateTexOptions(t,e,s,i,n,r,a,o){const l="opacity"===s;if(!a||l){const a=`${s}Map`,h=`${s}VertexColor`,c=`${s}VertexColorChannel`,d=`${a}Channel`,u=`${a}Transform`,f=`${a}Uv`,p=`${a}Identifier`;if("light"!==s&&(t[a]=!1,t[p]=void 0,t[d]="",t[u]=0,t[f]=0),t[h]=!1,t[c]="",l&&3===e.blendType&&0===e.alphaTest&&!e.alphaToCoverage&&e.opacityDither===lh)return;if("height"!==s&&e[h]&&r&&(t[h]=e[h],t[c]=e[c],t.litOptions.vertexColors=!0),e[a]){let r=!0;if(0!==e[f]||i||(r=!1),1!==e[f]||n||(r=!1),r){const i=e[a].id;let n=o[i];void 0===n&&(o[i]=s,n=s),t[a]=!!e[a],t[p]=n,t[u]=this._getMapTransformID(e.getUniform(u),e[f]),t[d]=e[d],t[f]=e[f]}}}}_updateMinOptions(t,e,s){const i=1===s;t.litOptions.opacityShadowDither=i?e.opacityDither:e.opacityShadowDither,t.litOptions.linearDepth=i,t.litOptions.lights=[]}_updateMaterialOptions(t,e,s){const i=!!(e.useMetalness||e.specularMap||e.sphereMap||e.cubeMap||(n=e.specular,0!==n.r||0!==n.g||0!==n.b)||e.specularityFactor>0&&e.useMetalness||e.enableGGXSpecular||e.clearCoat>0);var n;const r=!e.useMetalness||e.useMetalnessSpecularColor,a=i&&(e.specularTint||!e.specularMap&&!e.specularVertexColor)&&(t=>1!==t.r||1!==t.g||1!==t.b)(e.specular),o=i&&e.useMetalnessSpecularColor&&(e.specularityFactorTint||e.specularityFactor<1&&!e.specularityFactorMap),l=t=>!!t&&(t.format===Ds||t.type===bi),h=(t,e)=>Math.abs(t-e)<1e-4;t.specularTint=a,t.specularityFactorTint=o,t.metalnessTint=e.useMetalness&&e.metalness<1,t.glossTint=!0,t.diffuseEncoding=e.diffuseMap?.encoding,t.diffuseDetailEncoding=e.diffuseDetailMap?.encoding,t.emissiveEncoding=e.emissiveMap?.encoding,t.lightMapEncoding=e.lightMap?.encoding,t.packedNormal=l(e.normalMap),t.refractionTint=h(e.refraction,1),t.refractionIndexTint=h(e.refractionIndex,1/1.5),t.thicknessTint=e.useDynamicRefraction&&1!==e.thickness,t.specularEncoding=e.specularMap?.encoding,t.sheenEncoding=e.sheenMap?.encoding,t.aoMapUv=e.aoUvSet,t.aoDetail=!!e.aoDetailMap,t.diffuseDetail=!!e.diffuseDetailMap,t.normalDetail=!!e.normalMap,t.normalDetailPackedNormal=l(e.normalDetailMap),t.diffuseDetailMode=e.diffuseDetailMode,t.aoDetailMode=e.aoDetailMode,t.clearCoatGloss=!!e.clearCoatGloss,t.clearCoatPackedNormal=l(e.clearCoatNormalMap),t.iorTint=h(e.refractionIndex,1/1.5),s.forcePassThroughSpecular&&(t.specularEncoding="linear",t.sheenEncoding="linear"),t.iridescenceTint=1!==e.iridescence,t.glossInvert=e.glossInvert,t.sheenGlossInvert=e.sheenGlossInvert,t.clearCoatGlossInvert=e.clearCoatGlossInvert,t.useSpecularColor=r,t.litOptions.separateAmbient=!1,t.litOptions.pixelSnap=e.pixelSnap,t.litOptions.ambientSH=!!e.ambientSH,t.litOptions.twoSidedLighting=e.twoSidedLighting,t.litOptions.occludeSpecular=e.occludeSpecular,t.litOptions.occludeSpecularFloat=1!==e.occludeSpecularIntensity,t.litOptions.useMsdf=!!e.msdfMap,t.litOptions.msdfTextAttribute=!!e.msdfTextAttribute,t.litOptions.alphaToCoverage=e.alphaToCoverage,t.litOptions.opacityFadesSpecular=e.opacityFadesSpecular,t.litOptions.opacityDither=e.opacityDither,t.litOptions.cubeMapProjection=e.cubeMapProjection,t.litOptions.occludeDirect=e.occludeDirect,t.litOptions.useSpecular=i,t.litOptions.useSpecularityFactor=(o||!!e.specularityFactorMap)&&e.useMetalnessSpecularColor,t.litOptions.enableGGXSpecular=e.enableGGXSpecular,t.litOptions.fresnelModel=e.fresnelModel,t.litOptions.useRefraction=(e.refraction||!!e.refractionMap)&&(e.useDynamicRefraction||t.litOptions.reflectionSource!==Hl),t.litOptions.useClearCoat=!!e.clearCoat,t.litOptions.useSheen=e.useSheen,t.litOptions.useIridescence=e.useIridescence&&0!==e.iridescence,t.litOptions.useMetalness=e.useMetalness,t.litOptions.useDynamicRefraction=e.useDynamicRefraction,t.litOptions.dispersion=e.dispersion>0,t.litOptions.shadowCatcher=e.shadowCatcher}_updateEnvOptions(t,e,s,i){t.litOptions.fog=e.useFog?i.fog:fl,t.litOptions.gamma=i.shaderOutputGamma,t.litOptions.toneMap=e.useTonemap?i.toneMapping:6;let n=!1;if(e.envAtlas&&e.cubeMap?(t.litOptions.reflectionSource=Wl,t.litOptions.reflectionEncoding=e.envAtlas.encoding,t.litOptions.reflectionCubemapEncoding=e.cubeMap.encoding):e.envAtlas?(t.litOptions.reflectionSource=Gl,t.litOptions.reflectionEncoding=e.envAtlas.encoding):e.cubeMap?(t.litOptions.reflectionSource=jl,t.litOptions.reflectionEncoding=e.cubeMap.encoding):e.sphereMap?(t.litOptions.reflectionSource=Xl,t.litOptions.reflectionEncoding=e.sphereMap.encoding):e.useSkybox&&s.envAtlas&&s.skybox?(t.litOptions.reflectionSource=Wl,t.litOptions.reflectionEncoding=s.envAtlas.encoding,t.litOptions.reflectionCubemapEncoding=s.skybox.encoding,n=!0):e.useSkybox&&s.envAtlas?(t.litOptions.reflectionSource=Gl,t.litOptions.reflectionEncoding=s.envAtlas.encoding,n=!0):e.useSkybox&&s.skybox?(t.litOptions.reflectionSource=jl,t.litOptions.reflectionEncoding=s.skybox.encoding,n=!0):(t.litOptions.reflectionSource=Hl,t.litOptions.reflectionEncoding=null),e.ambientSH)t.litOptions.ambientSource=ql,t.litOptions.ambientEncoding=null;else{const i=e.envAtlas||(e.useSkybox&&s.envAtlas?s.envAtlas:null);i&&!e.sphereMap?(t.litOptions.ambientSource=Kl,t.litOptions.ambientEncoding=i.encoding):(t.litOptions.ambientSource=Yl,t.litOptions.ambientEncoding=null)}t.litOptions.skyboxIntensity=n,t.litOptions.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}_updateLightOptions(t,e,s,i,n){if(t.lightMap=!1,t.lightMapChannel="",t.lightMapUv=0,t.lightMapTransform=0,t.litOptions.lightMapWithoutAmbient=!1,t.dirLightMap=!1,i&&(t.litOptions.noShadow=!!(1&i),64&i&&(t.lightMapEncoding=7===e.lightmapPixelFormat?"rgbm":"linear",t.lightMap=!0,t.lightMapChannel="rgb",t.lightMapUv=1,t.lightMapTransform=0,t.litOptions.lightMapWithoutAmbient=!s.lightMap,128&i&&(t.dirLightMap=!0),4096&i&&(t.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){const s=[],r=i?i>>16:1;t.litOptions.lightMaskDynamic=!!(1&r),n&&(Of.collectLights(0,n[0],s,r),e.clusteredLightingEnabled||(Of.collectLights(1,n[1],s,r),Of.collectLights(2,n[2],s,r))),t.litOptions.lights=s}else t.litOptions.lights=[];0!==t.litOptions.lights.length||e.clusteredLightingEnabled||(t.litOptions.noShadow=!0)}_getMapTransformID(t,e){if(!t)return 0;let s=this._mapXForms[e];s||(s=[],this._mapXForms[e]=s);for(let e=0;e<s.length;e++)if(Gf(s[e][0].value,t[0].value)&&Gf(s[e][1].value,t[1].value))return e+1;return s.push(t)}}function jf(t,e=!0,s=!0){const i={};return i[`${t}Map`]="texture",i[`${t}MapTiling`]="vec2",i[`${t}MapOffset`]="vec2",i[`${t}MapRotation`]="number",i[`${t}MapUv`]="number",e&&(i[`${t}MapChannel`]="string",s&&(i[`${t}VertexColor`]="boolean",i[`${t}VertexColorChannel`]="string")),i}const Xf={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",...jf("ao"),...jf("aoDetail",!0,!1),aoDetailMode:"string",aoIntensity:"number",diffuse:"rgb",...jf("diffuse"),...jf("diffuseDetail",!0,!1),diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",...jf("specular"),occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean",...jf("specularityFactor"),useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",metalnessTint:"boolean",...jf("metalness"),useMetalnessSpecularColor:"boolean",anisotropyIntensity:"number",anisotropyRotation:"number",...jf("anisotropy"),shininess:"number",gloss:"number",glossInvert:"boolean",...jf("gloss"),clearCoat:"number",...jf("clearCoat"),clearCoatGloss:"number",clearCoatGlossInvert:"boolean",...jf("clearCoatGloss"),clearCoatBumpiness:"number",...jf("clearCoatNormal",!1),useSheen:"boolean",sheen:"rgb",...jf("sheen"),sheenGloss:"number",sheenGlossInvert:"boolean",...jf("sheenGloss"),fresnelModel:"number",emissive:"rgb",...jf("emissive"),emissiveIntensity:"number",...jf("normal",!1),bumpiness:"number",...jf("normalDetail",!1),normalDetailMapBumpiness:"number",...jf("height",!0,!1),heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",...jf("opacity"),opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean",...jf("refraction"),refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean",...jf("thickness"),attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean",...jf("iridescence"),iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number",...jf("iridescenceThickness"),...jf("light"),depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean",shadowCatcher:"boolean"},$f=[];for(const t in Xf){"texture"===Xf[t]&&$f.push(t)}const qf=[];for(const t in Xf){"cubemap"===Xf[t]&&qf.push(t)}const Kf={},Yf={};let Qf=new Set;const Zf=new Ze;class Jf extends _d{static{this.TEXTURE_PARAMETERS=$f}static{this.CUBEMAP_PARAMETERS=qf}constructor(){super(),this.userAttributes=new Map,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new Wf,this.reset()}reset(){Object.keys(Kf).forEach((t=>{this[`_${t}`]=Kf[t].value()})),this._uniformCache={}}copy(t){return super.copy(t),Object.keys(Kf).forEach((e=>{this[e]=t[e]})),this.userAttributes=new Map(t.userAttributes),this}setAttribute(t,e){this.userAttributes.set(e,t)}_setParameter(t,e){Qf.add(t),this.setParameter(t,e)}_setParameters(t){t.forEach((t=>{this._setParameter(t.name,t.value)}))}_processParameters(t){const e=this[t];e.forEach((t=>{Qf.has(t)||delete this.parameters[t]})),this[t]=Qf,Qf=e,Qf.clear()}_updateMap(t){const e=`${t}Map`,s=this[e];if(s){this._setParameter(`texture_${e}`,s);const t=`${e}Transform`,i=this.getUniform(t);i&&this._setParameters(i)}}_allocUniform(t,e){let s=this._uniformCache[t];return s||(s=e(),this._uniformCache[t]=s),s}getUniform(t,e,s){return Yf[t](this,e,s)}updateUniforms(t,e){const s=s=>this.getUniform(s,t,e);this._setParameter("material_ambient",s("ambient")),this._setParameter("material_diffuse",s("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.specularityFactorMap&&!this.specularityFactorTint||this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",s("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&(this._setParameter("material_anisotropyIntensity",this.anisotropyIntensity),this._setParameter("material_anisotropyRotation",[Math.cos(this.anisotropyRotation*Qe.DEG_TO_RAD),Math.sin(this.anisotropyRotation*Qe.DEG_TO_RAD)])),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",s("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox"));for(const t in zf)this._updateMap(t);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),super.updateUniforms(t,e)}updateEnvUniforms(t,e){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(e.envAtlas&&e.skybox?(this._setParameter("texture_envAtlas",e.envAtlas),this._setParameter("texture_cubeMap",e.skybox)):e.envAtlas?this._setParameter("texture_envAtlas",e.envAtlas):e.skybox&&this._setParameter("texture_cubeMap",e.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(t){const{device:e,scene:s,pass:i,objDefs:n,sortedLights:r,cameraShaderParams:a}=t;this.updateEnvUniforms(e,s);const o=wh.get(e).getByIndex(i),l=3===i||1===i||o.isShadow;let h=l?Hf.optionsContextMin:Hf.optionsContext;h.defines=Ph.getCoreDefines(this,t),l?this.shaderOptBuilder.updateMinRef(h,s,this,n,i,r):this.shaderOptBuilder.updateRef(h,s,a,this,n,i,r),this.useFog||h.defines.set("FOG","NONE"),h.defines.set("TONEMAP",Nl[h.litOptions.toneMap]),this.onUpdateShader&&(h=this.onUpdateShader(h));const c=new gh(t.viewUniformFormat,t.viewBindGroupFormat,t.vertexFormat),d=bh(e);d.register("standard",Hf);const u=d.getProgram("standard",h,c,this.userId);return this._dirtyShader=!1,u}destroy(){for(const t in this._assetReferences)this._assetReferences[t]._unbind();this._assetReferences=null,super.destroy()}}const tp=(t,e)=>{Yf[t]=e},ep=(t,e,s,i)=>{Object.defineProperty(Jf.prototype,t,{get:i||function(){return this[`_${t}`]},set:s}),Kf[t]={value:e}},sp=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);ep(t.name,(()=>t.defaultValue),(function(t){const i=this[e];i!==t&&(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=t)}),t.getterFunc)},ip=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);ep(t.name,(()=>t.defaultValue.clone()),(function(t){const i=this[e];i.equals(t)||(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=i.copy(t))}),t.getterFunc)},np=t=>t.defaultValue&&t.defaultValue.clone?ip(t):sp(t);function rp(t,e="rgb",s=!0,i=0){zf[t]=e.length||-1,np({name:`${t}Map`,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t!=!!e||t&&(t.type!==e.type||t.format!==e.format)}),np({name:`${t}MapTiling`,defaultValue:new os(1,1)}),np({name:`${t}MapOffset`,defaultValue:new os(0,0)}),np({name:`${t}MapRotation`,defaultValue:0}),np({name:`${t}MapUv`,defaultValue:i}),e&&(np({name:`${t}MapChannel`,defaultValue:e}),s&&(np({name:`${t}VertexColor`,defaultValue:!1}),np({name:`${t}VertexColorChannel`,defaultValue:e})));const n=`${t}MapTiling`,r=`${t}MapOffset`,a=`${t}MapRotation`,o=`${t}MapTransform`;tp(o,((t,e,s)=>{const i=t[n],l=t[r],h=t[a];if(1===i.x&&1===i.y&&0===l.x&&0===l.y&&0===h)return null;const c=t._allocUniform(o,(()=>[{name:`texture_${o}0`,value:new Float32Array(3)},{name:`texture_${o}1`,value:new Float32Array(3)}])),d=Math.cos(h*Qe.DEG_TO_RAD),u=Math.sin(h*Qe.DEG_TO_RAD),f=c[0].value;f[0]=d*i.x,f[1]=-u*i.y,f[2]=l.x;const p=c[1].value;return p[0]=u*i.x,p[1]=d*i.y,p[2]=1-i.y-l.y,c}))}function ap(t,e){np({name:t,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${t}`]}}),tp(t,((e,s,i)=>{const n=e._allocUniform(t,(()=>new Float32Array(3))),r=e[t];return Zf.linear(r),n[0]=Zf.r,n[1]=Zf.g,n[2]=Zf.b,n}))}function op(t,e,s){np({name:t,defaultValue:e,dirtyShaderFunc:(t,e)=>(0===t||1===t)!=(0===e||1===e)}),tp(t,s)}function lp(t,e){np({name:t,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t==!!e}),tp(t,e)}function hp(t,e){np({name:t,defaultValue:e})}!function(){ap("ambient",new Ze(1,1,1)),ap("diffuse",new Ze(1,1,1)),ap("specular",new Ze(0,0,0)),ap("emissive",new Ze(0,0,0)),ap("sheen",new Ze(1,1,1)),ap("attenuation",new Ze(1,1,1)),op("emissiveIntensity",1),op("specularityFactor",1),op("sheenGloss",0),op("gloss",.25),op("aoIntensity",1),op("heightMapFactor",1,((t,e,s)=>.025*t.heightMapFactor)),op("opacity",1),op("alphaFade",1),op("alphaTest",0),op("bumpiness",1),op("normalDetailMapBumpiness",1),op("reflectivity",1),op("occludeSpecularIntensity",1),op("refraction",0),op("refractionIndex",1/1.5),op("dispersion",0),op("thickness",0),op("attenuationDistance",0),op("metalness",1),op("anisotropyIntensity",0),op("anisotropyRotation",0),op("clearCoat",0),op("clearCoatGloss",1),op("clearCoatBumpiness",1),op("aoUvSet",0,null),op("iridescence",0),op("iridescenceRefractionIndex",1/1.5),op("iridescenceThicknessMin",0),op("iridescenceThicknessMax",0),lp("ambientSH"),lp("cubeMapProjectionBox",((t,e,s)=>{const i=t._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),n=t.cubeMapProjectionBox.getMin(),r=i[0].value;r[0]=n.x,r[1]=n.y,r[2]=n.z;const a=t.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=a.x,o[1]=a.y,o[2]=a.z,i})),hp("specularTint",!1),hp("specularityFactorTint",!1),hp("useMetalness",!1),hp("useMetalnessSpecularColor",!1),hp("useSheen",!1),hp("enableGGXSpecular",!1),hp("occludeDirect",!1),hp("opacityFadesSpecular",!0),hp("occludeSpecular",1),hp("fresnelModel",2),hp("useDynamicRefraction",!1),hp("cubeMapProjection",0),hp("useFog",!0),hp("useLighting",!0),hp("useTonemap",!0),hp("useSkybox",!0),hp("forceUv1",!1),hp("pixelSnap",!1),hp("twoSidedLighting",!1),hp("nineSlicedMode",void 0),hp("msdfTextAttribute",!1),hp("useIridescence",!1),hp("glossInvert",!1),hp("sheenGlossInvert",!1),hp("clearCoatGlossInvert",!1),hp("opacityDither",lh),hp("opacityShadowDither",lh),hp("shadowCatcher",!1),rp("diffuse"),rp("specular"),rp("emissive"),rp("thickness","g"),rp("specularityFactor","g"),rp("normal",""),rp("metalness","g"),rp("gloss","g"),rp("opacity","a"),rp("refraction","g"),rp("height","g",!1),rp("ao","g"),rp("light","rgb",!0,1),rp("msdf",""),rp("diffuseDetail","rgb",!1),rp("normalDetail",""),rp("aoDetail","g",!1),rp("clearCoat","g"),rp("clearCoatGloss","g"),rp("clearCoatNormal",""),rp("sheen","rgb"),rp("sheenGloss","g"),rp("iridescence","g"),rp("iridescenceThickness","g"),rp("anisotropy",""),hp("diffuseDetailMode","mul"),hp("aoDetailMode","mul"),lp("cubeMap"),lp("sphereMap"),lp("envAtlas");const t=[null,null,null,null,null,null];ep("prefilteredCubemaps",(()=>t.slice()),(function(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let n=0;n<6;++n){const r=t[n]||null;e[n]!==r&&(e[n]=r,s=!0),i=i&&!!e[n]}s&&(i?this.envAtlas=Pf.generatePrefilteredAtlas(e,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();const cp=4/64,dp=.875;class up extends Ku{constructor(t,e,s,i,n,r){super();const a=new rs,o=new rs,l=new rs,h=new rs,c=new rs,d=new rs,u=[],f=[],p=[],m=[],_=[];let g;if(s>0)for(let r=0;r<=i;r++)for(let g=0;g<=n;g++){const v=g/n*2*Math.PI-Math.PI,b=Math.sin(v),y=Math.cos(v);c.set(b*t,-s/2,y*t),h.set(b*e,s/2,y*e),a.lerp(c,h,r/i),o.sub2(h,c).normalize(),d.set(y,0,-b),l.cross(d,o).normalize(),u.push(a.x,a.y,a.z),f.push(l.x,l.y,l.z);let S=g/n,x=r/i;p.push(S,1-x);const w=x;if(x=S,S=w,S=S*dp+cp,x=x*dp+cp,S/=3,m.push(S,1-x),r<i&&g<n){const t=r*(n+1)+g,e=r*(n+1)+(g+1),s=(r+1)*(n+1)+g,i=(r+1)*(n+1)+(g+1);_.push(t,e,s),_.push(e,i,s)}}if(r){const t=Math.floor(n/2),r=n,a=s/2;for(let s=0;s<=t;s++){const i=s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=r;i++){const l=2*i*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=o,_=h*n;let g=1-i/r,v=1-s/t;u.push(c*e,d*e+a,_*e),f.push(c,d,_),p.push(g,1-v),g=g*dp+cp,v=v*dp+cp,g/=3,v/=3,g+=1/3,m.push(g,1-v)}}g=(i+1)*(n+1);for(let e=0;e<t;++e)for(let t=0;t<r;++t){const s=e*(r+1)+t,i=s+r+1;_.push(g+s+1,g+i,g+s),_.push(g+s+1,g+i+1,g+i)}for(let s=0;s<=t;s++){const i=.5*Math.PI+s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=r;i++){const l=2*i*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=o,_=h*n;let g=1-i/r,v=1-s/t;u.push(c*e,d*e-a,_*e),f.push(c,d,_),p.push(g,1-v),g=g*dp+cp,v=v*dp+cp,g/=3,v/=3,g+=2/3,m.push(g,1-v)}}g=(i+1)*(n+1)+(r+1)*(t+1);for(let e=0;e<t;++e)for(let t=0;t<r;++t){const s=e*(r+1)+t,i=s+r+1;_.push(g+s+1,g+i,g+s),_.push(g+s+1,g+i+1,g+i)}}else{if(g=(i+1)*(n+1),t>0)for(let e=0;e<n;e++){const i=e/n*2*Math.PI,r=Math.sin(i),a=-s/2,o=Math.cos(i);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*t,a,o*t),f.push(0,-1,0),p.push(l,1-h),l=l*dp+cp,h=h*dp+cp,l/=3,h/=3,l+=1/3,m.push(l,1-h),e>1&&_.push(g,g+e,g+e-1)}if(g+=n,e>0)for(let t=0;t<n;t++){const i=t/n*2*Math.PI,r=Math.sin(i),a=s/2,o=Math.cos(i);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*e,a,o*e),f.push(0,1,0),p.push(l,1-h),l=l*dp+cp,h=h*dp+cp,l/=3,h/=3,l+=2/3,m.push(l,1-h),t>1&&_.push(g,g+t-1,g+t)}}this.positions=u,this.normals=f,this.uvs=p,this.uvs1=m,this.indices=_}}class fp extends up{constructor(t={}){const e=t.radius??.3;super(e,e,(t.height??1)-2*e,t.heightSegments??1,t.sides??20,!0),t.calculateTangents&&(this.tangents=qu(this.positions,this.normals,this.uvs,this.indices))}}class pp extends up{constructor(t={}){super(t.baseRadius??.5,t.peakRadius??0,t.height??1,t.heightSegments??5,t.capSegments??18,!1),t.calculateTangents&&(this.tangents=qu(this.positions,this.normals,this.uvs,this.indices))}}class mp extends up{constructor(t={}){const e=t.radius??.5;super(e,e,t.height??1,t.heightSegments??5,t.capSegments??20,!1),t.calculateTangents&&(this.tangents=qu(this.positions,this.normals,this.uvs,this.indices))}}class _p extends Ku{constructor(t={}){super();const e=t.halfExtents??new os(.5,.5),s=t.widthSegments??5,i=t.lengthSegments??5,n=[],r=[],a=[],o=[];let l=0;for(let t=0;t<=s;t++)for(let h=0;h<=i;h++){const c=-e.x+2*e.x*t/s,d=0,u=-(-e.y+2*e.y*h/i),f=t/s,p=h/i;n.push(c,d,u),r.push(0,1,0),a.push(f,1-p),t<s&&h<i&&(o.push(l+i+1,l+1,l),o.push(l+i+1,l+i+2,l+1)),l++}this.positions=n,this.normals=r,this.uvs=a,this.uvs1=a,this.indices=o,t.calculateTangents&&(this.tangents=qu(n,r,a,o))}}class gp extends Ku{constructor(t={}){super();const e=t.tubeRadius??.2,s=t.ringRadius??.3,i=(t.sectorAngle??360)*Qe.DEG_TO_RAD,n=t.segments??30,r=t.sides??20,a=[],o=[],l=[],h=[];for(let t=0;t<=r;t++)for(let c=0;c<=n;c++){const d=Math.cos(i*c/n)*(s+e*Math.cos(2*Math.PI*t/r)),u=Math.sin(2*Math.PI*t/r)*e,f=Math.sin(i*c/n)*(s+e*Math.cos(2*Math.PI*t/r)),p=Math.cos(i*c/n)*Math.cos(2*Math.PI*t/r),m=Math.sin(2*Math.PI*t/r),_=Math.sin(i*c/n)*Math.cos(2*Math.PI*t/r),g=t/r,v=1-c/n;if(a.push(d,u,f),o.push(p,m,_),l.push(g,1-v),t<r&&c<n){const e=t*(n+1)+c,s=(t+1)*(n+1)+c,i=t*(n+1)+(c+1),r=(t+1)*(n+1)+(c+1);h.push(e,s,i),h.push(s,r,i)}}this.positions=a,this.normals=o,this.uvs=l,this.uvs1=l,this.indices=h,t.calculateTangents&&(this.tangents=qu(a,o,l,h))}}class vp{constructor(t,e){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=t,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new Uf,this._defaultStdMatOptionMin=new Uf;const s=new hc;e.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},s,e,null,[],0,null),e.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},e,null,2,null),t.on("destroy:shader",(t=>{this.removeFromCache(t)}))}destroy(){this.clearCache()}register(t,e){this._generators.has(t)||this._generators.set(t,e)}unregister(t){this._generators.has(t)&&this._generators.delete(t)}isRegistered(t){return this._generators.has(t)}generateShaderDefinition(t,e,s,i){let n=this.definitionsCache.get(s);if(!n){let r;i.litOptions?.lights&&(r=i.litOptions.lights,i.litOptions.lights=r.map((t=>{const e=t.clone?t.clone():t;return e.key=t.key,e}))),this.storeNewProgram(e,i),i.litOptions?.lights&&(i.litOptions.lights=r);const a=this._device;n=t.createShaderDefinition(a,i),n.name=n.name??(i.pass?`${e}-pass:${i.pass}`:e),this.definitionsCache.set(s,n)}return n}getCachedShader(t){return this.processedCache.get(t)}setCachedShader(t,e){this.processedCache.set(t,e)}getProgram(t,e,s,i){const n=this._generators.get(t);if(!n)return null;const r=Rn(n.generateKey(e)),a=`${r}#${Rn(s.generateKey(this._device))}`;let o=this.getCachedShader(a);if(!o){const l=this.generateShaderDefinition(n,t,r,e);let h,c="";void 0!==e.pass&&(h=wh.get(this._device).getByIndex(e.pass),c=`-${h.name}`),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:h,definition:l});const d={name:`${l.name}${c}-proc`,attributes:l.attributes,vshader:l.vshader,vincludes:l.vincludes,fincludes:l.fincludes,fshader:l.fshader,processingOptions:s,shaderLanguage:l.shaderLanguage,meshUniformBufferFormat:l.meshUniformBufferFormat,meshBindGroupFormat:l.meshBindGroupFormat};o=new Ra(this._device,d),this.setCachedShader(a,o)}return o}storeNewProgram(t,e){let s={};if("standard"===t){const t=this._getDefaultStdMatOptions(e.pass);for(const i in e)(e.hasOwnProperty(i)&&t[i]!==e[i]||"pass"===i)&&(s[i]=e[i]);for(const t in e.litOptions)s[t]=e.litOptions[t]}else s=e;this._programsCollection.push(JSON.stringify({name:t,options:s}))}dumpPrograms(){let t="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";t+="let shaders = [",this._programsCollection[0]&&(t+=`\n\t${this._programsCollection[0]}`);for(let e=1;e<this._programsCollection.length;++e)t+=`,\n\t${this._programsCollection[e]}`;t+="\n];\n",t+="pc.getProgramLibrary(device).precompile(shaders);\n",t+=`if (pc.version != "${Le}" || pc.revision != "${Ie}")\n`,t+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const e=document.createElement("a");e.setAttribute("href",`data:text/plain;charset=utf-8,${encodeURIComponent(t)}`),e.setAttribute("download","precompile-shaders.js"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach((t=>{t.destroy()})),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(t){this._isClearingCache||this.processedCache.forEach(((e,s)=>{t===e&&this.processedCache.delete(s)}))}_getDefaultStdMatOptions(t){const e=wh.get(this._device).getByIndex(t);return 3===t||1===t||e.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(t){if(t){const e=new Array(t.length);for(let s=0;s<t.length;s++){if("standard"===t[s].name){const e=t[s].options,i=this._getDefaultStdMatOptions(e.pass);for(const t in i)i.hasOwnProperty(t)&&void 0===e[t]&&(e[t]=i[t])}e[s]=this.getProgram(t[s].name,t[s].options)}}this._precached=!0}}const bp=new ps,yp=new ms,Sp=new Ss,xp=new Ss,wp=new Ze(1,1,0,.4),Tp=.28209479177387814;class Ep{constructor(t,e,s,i,n){const r=t.getProp("x"),a=t.getProp("y"),o=t.getProp("z"),l=t.getProp("rot_1"),h=t.getProp("rot_2"),c=t.getProp("rot_3"),d=t.getProp("rot_0"),u=t.getProp("scale_0"),f=t.getProp("scale_1"),p=t.getProp("scale_2"),m=t.getProp("f_dc_0"),_=t.getProp("f_dc_1"),g=t.getProp("f_dc_2"),v=t.getProp("opacity");this.read=t=>{e&&(e.x=r[t],e.y=a[t],e.z=o[t]),s&&s.set(l[t],h[t],c[t],d[t]),i&&i.set(Math.exp(u[t]),Math.exp(f[t]),Math.exp(p[t])),n&&n.set(.5+m[t]*Tp,.5+_[t]*Tp,.5+g[t]*Tp,(t=>{if(t>0)return 1/(1+Math.exp(-t));const e=Math.exp(t);return e/(1+e)})(v[t]))}}}const Cp=(t,e,s)=>{yp.set(s.x,s.y,s.z,s.w).normalize(),t.setTRS(e,yp,rs.ONE)};class Ap{constructor(t,e=[]){this.elements=t,this.numSplats=this.getElement("vertex").count,this.comments=e}static calcSplatAabb(t,e,s,i){Cp(bp,e,s),Sp.center.set(0,0,0),Sp.halfExtents.set(2*i.x,2*i.y,2*i.z),t.setFromTransformedAabb(Sp,bp)}getProp(t,e="vertex"){return this.getElement(e)?.properties.find((e=>e.name===t))?.storage}getElement(t){return this.elements.find((e=>e.name===t))}addProp(t,e){this.getElement("vertex").properties.push({type:"float",name:t,storage:e,byteSize:4})}createIter(t,e,s,i){return new Ep(this,t,e,s,i)}calcAabb(t,e){let s,i,n,r,a,o,l=!0;const h=this.getProp("x"),c=this.getProp("y"),d=this.getProp("z"),u=this.getProp("scale_0"),f=this.getProp("scale_1"),p=this.getProp("scale_2");for(let t=0;t<this.numSplats;++t){if(e&&!e(t))continue;const m=h[t],_=c[t],g=d[t],v=Math.max(u[t],f[t],p[t]);if(!(isFinite(m)&&isFinite(_)&&isFinite(g)&&isFinite(v)))continue;const b=2*Math.exp(v);l?(l=!1,s=m-b,i=_-b,n=g-b,r=m+b,a=_+b,o=g+b):(s=Math.min(s,m-b),i=Math.min(i,_-b),n=Math.min(n,g-b),r=Math.max(r,m+b),a=Math.max(a,_+b),o=Math.max(o,g+b))}return l||(t.center.set(.5*(s+r),.5*(i+a),.5*(n+o)),t.halfExtents.set(.5*(r-s),.5*(a-i),.5*(o-n))),!l}calcAabbExact(t,e){const s=new rs,i=new ms,n=new rs,r=this.createIter(s,i,n);let a=!0;for(let o=0;o<this.numSplats;++o)e&&!e(o)||(r.read(o),a?(a=!1,Ap.calcSplatAabb(t,s,i,n)):(Ap.calcSplatAabb(xp,s,i,n),t.add(xp)));return!a}getCenters(t){const e=this.getProp("x"),s=this.getProp("y"),i=this.getProp("z");for(let n=0;n<this.numSplats;++n)t[3*n+0]=e[n],t[3*n+1]=s[n],t[3*n+2]=i[n]}calcFocalPoint(t,e){const s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),r=this.getProp("scale_0"),a=this.getProp("scale_1"),o=this.getProp("scale_2");t.x=0,t.y=0,t.z=0;let l=0;for(let h=0;h<this.numSplats;++h){if(e&&!e(h))continue;const c=s[h],d=i[h],u=n[h];if(!isFinite(c)||!isFinite(d)||!isFinite(u))continue;const f=1/(1+Math.exp(Math.max(r[h],a[h],o[h])));t.x+=c*f,t.y+=d*f,t.z+=u*f,l+=f}t.mulScalar(1/l)}renderWireframeBounds(t,e){const s=new rs,i=new ms,n=new rs,r=new rs,a=new rs,o=this.createIter(s,i,n);for(let l=0;l<this.numSplats;++l)o.read(l),Cp(bp,s,i),bp.mul2(e,bp),r.set(-2*n.x,-2*n.y,-2*n.z),a.set(2*n.x,2*n.y,2*n.z),t.immediate.drawWireAlignedBox(r,a,wp,!0,t.defaultDrawLayer,bp)}get isCompressed(){return!1}get shBands(){return{9:1,24:2,45:3}[(()=>{for(let t=0;t<45;++t)if(!this.getProp(`f_rest_${t}`))return t;return 45})()]??0}calcMortonOrder(){const t=t=>{let e=t[0],s=t[0];for(let i=1;i<t.length;i++)t[i]<e&&(e=t[i]),t[i]>s&&(s=t[i]);return{min:e,max:s}},e=(t,e,s)=>{const i=t=>t=153391689&((t=51130563&((t=50393103&((t=4278190335&((t&=1023)^t<<16))^t<<8))^t<<4))^t<<2);return(i(s)<<2)+(i(e)<<1)+i(t)},s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),{min:r,max:a}=t(s),{min:o,max:l}=t(i),{min:h,max:c}=t(n),d=r===a?0:1024/(a-r),u=o===l?0:1024/(l-o),f=h===c?0:1024/(c-h),p=new Map;for(let t=0;t<this.numSplats;t++){const a=e(Math.min(1023,Math.floor((s[t]-r)*d)),Math.min(1023,Math.floor((i[t]-o)*u)),Math.min(1023,Math.floor((n[t]-h)*f))),l=p.get(a);l?l.push(t):p.set(a,[t])}const m=Array.from(p.keys()).sort(((t,e)=>t-e)),_=new Uint32Array(this.numSplats);let g=0;for(let t=0;t<m.length;++t){const e=p.get(m[t]);for(let t=0;t<e.length;++t)_[g++]=e[t]}return _}reorder(t){const e=new Map,s=s=>{const i=new s.constructor((t=>{if(e.has(t)){const s=e.get(t);return e.delete(t),s}return new ArrayBuffer(t)})(s.byteLength));for(let e=0;e<t.length;e++)i[e]=s[t[e]];var n;return n=s.buffer,e.set(n.byteLength,n),i};this.elements.forEach((t=>{t.properties.forEach((t=>{t.storage&&(t.storage=s(t.storage))}))}))}reorderData(){this.reorder(this.calcMortonOrder())}}class Dp{constructor(t,e){this.device=t,this.gsplatData=e,this.centers=new Float32Array(3*e.numSplats),e.getCenters(this.centers),this.aabb=new Ss,e.calcAabb(this.aabb);const s=128,i=Math.ceil(e.numSplats/s)*s/s,n=new Uint32Array(i);for(let t=0;t<i;++t)n[t]=t*s;const r=new Nn(t,[{semantic:ui,components:1,type:5,asInt:!0}]),a=new Float32Array(1536),o=new Uint32Array(768);for(let t=0;t<s;++t){a.set([-1,-1,t,1,-1,t,1,1,t,-1,1,t],12*t);const e=4*t;o.set([0+e,1+e,2+e,0+e,2+e,3+e],6*t)}this.mesh=new Wh(t),this.mesh.setPositions(a,3),this.mesh.setIndices(o),this.mesh.update(),this.mesh.incRefCount(),this.mesh.aabb.copy(this.aabb),this.instanceIndices=new In(t,r,i,{usage:0,data:n.buffer})}destroy(){this.mesh?.destroy(),this.instanceIndices?.destroy()}get instanceSize(){return 128}get numSplats(){return this.gsplatData.numSplats}configureMaterial(t){}evalTextureSize(t){return os.ZERO}createTexture(t,e,s,i){return new dn(this.device,{name:t,width:s.x,height:s.y,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,...i?{levels:[i]}:{}})}instantiate(){}}class Pp extends Dp{constructor(t,e){super(t,e);const s=e.numSplats,i=this.evalTextureSize(s);this.colorTexture=this.createTexture("splatColor",Ps,i),this.transformATexture=this.createTexture("transformA",Us,i),this.transformBTexture=this.createTexture("transformB",Ps,i),this.updateColorData(e),this.updateTransformData(e),this.shBands=e.shBands,this.shBands>0&&(this.sh1to3Texture=this.createTexture("splatSH_1to3",Us,i),this.shBands>1&&(this.sh4to7Texture=this.createTexture("splatSH_4to7",Us,i),this.shBands>2?(this.sh8to11Texture=this.createTexture("splatSH_8to11",Us,i),this.sh12to15Texture=this.createTexture("splatSH_12to15",Us,i)):this.sh8to11Texture=this.createTexture("splatSH_8to11",Bs,i)),this.updateSHData(e))}destroy(){this.colorTexture?.destroy(),this.transformATexture?.destroy(),this.transformBTexture?.destroy(),this.sh1to3Texture?.destroy(),this.sh4to7Texture?.destroy(),this.sh8to11Texture?.destroy(),this.sh12to15Texture?.destroy(),super.destroy()}configureMaterial(t){t.setParameter("splatColor",this.colorTexture),t.setParameter("transformA",this.transformATexture),t.setParameter("transformB",this.transformBTexture),t.setDefine("SH_BANDS",this.shBands),this.sh1to3Texture&&t.setParameter("splatSH_1to3",this.sh1to3Texture),this.sh4to7Texture&&t.setParameter("splatSH_4to7",this.sh4to7Texture),this.sh8to11Texture&&t.setParameter("splatSH_8to11",this.sh8to11Texture),this.sh12to15Texture&&t.setParameter("splatSH_12to15",this.sh12to15Texture)}evalTextureSize(t){const e=Math.ceil(Math.sqrt(t)),s=Math.ceil(t/e);return new os(e,s)}updateColorData(t){const e=this.colorTexture;if(!e)return;const s=ns.float2Half,i=e.lock(),n=t.getProp("f_dc_0"),r=t.getProp("f_dc_1"),a=t.getProp("f_dc_2"),o=t.getProp("opacity"),l=.28209479177387814;for(let t=0;t<this.numSplats;++t){const e=n[t]*l+.5,h=r[t]*l+.5,c=a[t]*l+.5,d=1/(1+Math.exp(-o[t]));i[4*t+0]=s(e),i[4*t+1]=s(h),i[4*t+2]=s(c),i[4*t+3]=s(d)}e.unlock()}updateTransformData(t){const e=ns.float2Half;if(!this.transformATexture)return;const s=this.transformATexture.lock(),i=new Float32Array(s.buffer),n=this.transformBTexture.lock(),r=new rs,a=new ms,o=new rs,l=t.createIter(r,a,o);for(let t=0;t<this.numSplats;t++)l.read(t),a.normalize(),a.w<0&&a.mulScalar(-1),i[4*t+0]=r.x,i[4*t+1]=r.y,i[4*t+2]=r.z,s[4*t+3]=e(a.x)|e(a.y)<<16,n[4*t+0]=e(o.x),n[4*t+1]=e(o.y),n[4*t+2]=e(o.z),n[4*t+3]=e(a.z);this.transformATexture.unlock(),this.transformBTexture.unlock()}updateSHData(t){const e=this.sh1to3Texture.lock(),s=this.sh4to7Texture?.lock(),i=this.sh8to11Texture?.lock(),n=this.sh12to15Texture?.lock(),r={1:3,2:8,3:15}[this.shBands],a=((t,e)=>{const s=[];for(let i=0;i<e;++i)s.push(t.getProp(`f_rest_${i}`));return s})(t,3*r),o=2047,l=new Float32Array(1),h=new Uint32Array(l.buffer),c=new Array(3*r).fill(0);for(let d=0;d<t.numSplats;++d){for(let t=0;t<r;++t)c[3*t]=a[t][d],c[3*t+1]=a[t+r][d],c[3*t+2]=a[t+2*r][d];let t=c[0];for(let e=1;e<3*r;++e)t=Math.max(t,Math.abs(c[e]));if(0!==t){for(let e=0;e<r;++e)c[3*e+0]=Math.max(0,Math.min(o,Math.floor((c[3*e+0]/t*.5+.5)*o+.5))),c[3*e+1]=Math.max(0,Math.min(1023,Math.floor(1023*(c[3*e+1]/t*.5+.5)+.5))),c[3*e+2]=Math.max(0,Math.min(o,Math.floor((c[3*e+2]/t*.5+.5)*o+.5)));l[0]=t,e[4*d+0]=h[0],e[4*d+1]=c[0]<<21|c[1]<<11|c[2],e[4*d+2]=c[3]<<21|c[4]<<11|c[5],e[4*d+3]=c[6]<<21|c[7]<<11|c[8],this.shBands>1&&(s[4*d+0]=c[9]<<21|c[10]<<11|c[11],s[4*d+1]=c[12]<<21|c[13]<<11|c[14],s[4*d+2]=c[15]<<21|c[16]<<11|c[17],s[4*d+3]=c[18]<<21|c[19]<<11|c[20],this.shBands>2?(i[4*d+0]=c[21]<<21|c[22]<<11|c[23],i[4*d+1]=c[24]<<21|c[25]<<11|c[26],i[4*d+2]=c[27]<<21|c[28]<<11|c[29],i[4*d+3]=c[30]<<21|c[31]<<11|c[32],n[4*d+0]=c[33]<<21|c[34]<<11|c[35],n[4*d+1]=c[36]<<21|c[37]<<11|c[38],n[4*d+2]=c[39]<<21|c[40]<<11|c[41],n[4*d+3]=c[42]<<21|c[43]<<11|c[44]):i[d]=c[21]<<21|c[22]<<11|c[23])}}this.sh1to3Texture.unlock(),this.sh4to7Texture?.unlock(),this.sh8to11Texture?.unlock(),this.sh12to15Texture?.unlock()}}let Lp=class extends Ao{execute(){this.executeCallback?.()}constructor(...t){super(...t),this.executeCallback=null}};const Ip=new ps,Rp=new rs;class Mp{constructor(t,e){this.prevDir=new rs,this.updateMode="enable",this.device=t,this.gsplatInstance=e;const{resource:s}=e,i=new Map(Ch.get(t,t.isWebGPU?"wgsl":"glsl"));this.shader=Ph.createShader(t,{uniqueName:"gsplatResolveSH",vertexGLSL:"\n\tattribute vec2 vertex_position;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.0, 1.0);\n\t}\n",fragmentGLSL:'\n\t#include "gsplatEvalSHVS"\n\tvec4 packRgb(vec3 v) {\n\t\tuvec3 vb = uvec3(clamp(v, vec3(0.0), vec3(1.0)) * vec3(2047.0, 2047.0, 1023.0));\n\t\tuint bits = (vb.x << 21) | (vb.y << 10) | vb.z;\n\t\treturn vec4((uvec4(bits) >> uvec4(24, 16, 8, 0)) & uvec4(0xff)) / vec4(255.0);\n\t}\n\tuniform mediump vec3 dir;\n\tuniform mediump sampler2D centroids;\n\tuniform mediump float shN_mins;\n\tuniform mediump float shN_maxs;\n\tvoid main(void) {\n\t\tivec2 uv = ivec2(gl_FragCoord.xy) * ivec2(SH_COEFFS, 1);\n\t\tmediump vec3 coefficients[SH_COEFFS];\n\t\tfor (int i = 0; i < SH_COEFFS; i++) {\n\t\t\tvec3 s = texelFetch(centroids, ivec2(uv.x + i, uv.y), 0).xyz;\n\t\t\tcoefficients[i] = mix(vec3(shN_mins), vec3(shN_maxs), s);\n\t\t}\n\t\tgl_FragColor = packRgb(evalSH(coefficients, dir) * 0.25 + 0.5);\n\t}\n',vertexWGSL:"\n\tattribute vertex_position: vec2f;\n\t@vertex\n\tfn vertexMain(input: VertexInput) -> VertexOutput {\n\t\tvar output: VertexOutput;\n\t\toutput.position = vec4f(vertex_position, 0.0, 1.0);\n\t\treturn output;\n\t}\n",fragmentWGSL:'\n\t#include "gsplatEvalSHVS"\n\tfn packRgb(v: vec3f) -> vec4f {\n\t\tlet vb = vec3u(clamp(v, vec3f(0.0), vec3f(1.0)) * vec3f(2047.0, 2047.0, 1023.0));\n\t\tlet bits = dot(vb, vec3u(1 << 21, 1 << 10, 1));\n\t\treturn vec4f((vec4u(bits) >> vec4u(24, 16, 8, 0)) & vec4u(0xff)) / vec4f(255.0);\n\t}\n\tuniform dir: vec3f;\n\tuniform shN_mins: f32;\n\tuniform shN_maxs: f32;\n\tvar centroids: texture_2d<f32>;\n\t@fragment\n\tfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\tvar uv = vec2i(input.position.xy) * vec2i(SH_COEFFS, 1);\n\t\tvar coefficients: array<vec3f, SH_COEFFS>;\n\t\tfor (var i: i32 = 0; i < SH_COEFFS; i++) {\n\t\t\tlet s: vec3f = textureLoad(centroids, vec2i(uv.x + i, uv.y), 0).xyz;\n\t\t\tcoefficients[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), s);\n\t\t}\n\t\toutput.color = packRgb(evalSH(&coefficients, uniform.dir) * 0.25 + 0.5);\n\t\treturn output;\n\t}\n',vertexIncludes:i,fragmentIncludes:i,fragmentDefines:new Map([["SH_BANDS",s.gsplatData.shBands.toString()]]),attributes:{vertex_position:$s}}),this.texture=s.createTexture("centroids",7,new os(64,1024)),this.renderTarget=new Hn({colorBuffer:this.texture,depth:!1}),this.renderPass=new Lp(t),this.renderPass.init(this.renderTarget,{}),this.renderPass.colorOps.clear=!0,this.quadRender=new kh(this.shader);const{material:n}=e;n.setDefine("SH_BANDS","0");const{shaderChunks:r}=n;r.glsl.set("gsplatSogsColorVS","\n\tuniform mediump sampler2D sh0;\n\tuniform highp sampler2D sh_labels;\n\tuniform mediump sampler2D sh_result;\n\tuniform vec4 sh0_mins;\n\tuniform vec4 sh0_maxs;\n\tfloat SH_C0 = 0.28209479177387814;\n\tvec3 unpackRgb(vec4 v) {\n\t\tuvec4 uv = uvec4(v * 255.0);\n\t\tuint bits = (uv.x << 24) | (uv.y << 16) | (uv.z << 8) | uv.w;\n\t\tuvec3 vb = (uvec3(bits) >> uvec3(21, 10, 0)) & uvec3(0x7ffu, 0x7ffu, 0x3ffu);\n\t\treturn vec3(vb) / vec3(2047.0, 2047.0, 1023.0);\n\t}\n\tvec4 readColor(in SplatSource source) {\n\t\tvec4 baseSample = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0));\n\t\tvec4 base = vec4(vec3(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));\n\t\tivec2 labelSample = ivec2(texelFetch(sh_labels, source.uv, 0).xy * 255.0);\n\t\tint n = labelSample.x + labelSample.y * 256;\n\t\tvec4 shSample = texelFetch(sh_result, ivec2(n % 64, n / 64), 0);\n\t\tvec3 sh = (unpackRgb(shSample) - vec3(0.5)) * 4.0;\n\t\treturn vec4(base.xyz + sh, base.w);\n\t}\n"),r.wgsl.set("gsplatSogsColorVS","\n\tvar sh0: texture_2d<f32>;\n\tvar sh_labels: texture_2d<f32>;\n\tvar sh_result: texture_2d<f32>;\n\tuniform sh0_mins: vec4f;\n\tuniform sh0_maxs: vec4f;\n\tconst SH_C0: f32 = 0.28209479177387814;\n\tfn unpackRgb(v: vec4f) -> vec3f {\n\t\tlet bits = dot(vec4u(v * 255.0), vec4u(1u << 24, 1u << 16, 1u << 8, 1u));\n\t\tlet vb = (vec3u(bits) >> vec3u(21, 10, 0)) & vec3u(0x7ffu, 0x7ffu, 0x3ffu);\n\t\treturn vec3f(vb) / vec3f(2047.0, 2047.0, 1023.0);\n\t}\n\tfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n\t\tlet baseSample: vec4f = mix(uniform.sh0_mins, uniform.sh0_maxs, textureLoad(sh0, source.uv, 0));\n\t\tlet base = vec4f(vec3f(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));\n\t\tlet labelSample: vec2i = vec2i(textureLoad(sh_labels, source.uv, 0).xy * 255.0);\n\t\tlet n = labelSample.x + labelSample.y * 256;\n\t\tlet shSample: vec4f = textureLoad(sh_result, vec2i(n % 64, n / 64), 0);\n\t\tlet sh: vec3f = (unpackRgb(shSample) - vec3f(0.5)) * 4.0;\n\t\treturn vec4f(base.xyz + sh, base.w);\n\t}\n"),n.update(),t.scope.resolve("sh_result").setValue(this.texture)}destroy(){const{gsplatInstance:t}=this,{material:e}=t;e.setDefine("SH_BANDS",t.resource.gsplatData.shBands.toString());const{shaderChunks:s}=e;s.glsl.delete("gsplatSogsColorVS"),s.wgsl.delete("gsplatSogsColorVS"),e.update(),this.quadRender.destroy(),this.renderPass.destroy(),this.renderTarget.destroy(),this.texture.destroy(),this.shader.destroy()}render(t,e){const{prevDir:s,updateMode:i}=this;if("disable"===i)return;if(Ip.invert(e),Ip.transformVector(t.forward,Rp),Rp.normalize(),"enable"===i&&Rp.equalsApprox(s,.001))return;s.copy(Rp);this.renderPass.executeCallback=()=>{const{device:t}=this,{sh_centroids:e,meta:s}=this.gsplatInstance.resource.gsplatData;((t,e)=>{for(const s in e)t.resolve(s).setValue(e[s])})(t.scope,{dir:Rp.toArray(),centroids:e,shN_mins:s.shN.mins,shN_maxs:s.shN.maxs}),t.setCullMode(0),t.setDepthState(Tn.NODEPTH),t.setStencilState(null,null),t.setBlendState(Sn.NOBLEND),this.quadRender.render()},this.renderPass.render()}}function kp(){const t="undefined"!=typeof self&&self||require("node:worker_threads").parentPort;let e,s,i,n,r,a,o=!1;const l={x:0,y:0,z:0},h={x:0,y:0,z:0},c={x:0,y:0,z:0},d={x:0,y:0,z:0};let u,f;const p=32,m=new Array(p).fill(0),_=new Array(p).fill(0),g=new Array(p).fill(0);t.addEventListener("message",(v=>{const b=v.data??v;if(b.order&&(e=new Uint32Array(b.order)),b.centers)if(s=new Float32Array(b.centers),o=!0,b.chunks){const t=new Float32Array(b.chunks);i=new Float32Array(b.chunks,0,4*t.length/6),c.x=t[0],c.y=t[1],c.z=t[2],d.x=t[3],d.y=t[4],d.z=t[5];for(let e=0;e<t.length/6;++e){const s=t[6*e+0],n=t[6*e+1],r=t[6*e+2],a=t[6*e+3],o=t[6*e+4],l=t[6*e+5];i[4*e+0]=.5*(s+a),i[4*e+1]=.5*(n+o),i[4*e+2]=.5*(r+l),i[4*e+3]=.5*Math.sqrt((a-s)**2+(o-n)**2+(l-r)**2),s<c.x&&(c.x=s),n<c.y&&(c.y=n),r<c.z&&(c.z=r),a>d.x&&(d.x=a),o>d.y&&(d.y=o),l>d.z&&(d.z=l)}}else{const t=s.length/3,e=Math.ceil(t/256);let n,r,a,o,l,h;i=new Float32Array(4*e),c.x=c.y=c.z=1/0,d.x=d.y=d.z=-1/0;for(let u=0;u<e;++u){n=r=a=1/0,o=l=h=-1/0;const e=256*u,f=Math.min(t,256*(u+1));for(let t=e;t<f;++t){const e=s[3*t+0],i=s[3*t+1],u=s[3*t+2],f=Number.isFinite(e),p=Number.isFinite(i),m=Number.isFinite(u);f||(s[3*t+0]=0),p||(s[3*t+1]=0),m||(s[3*t+2]=0),f&&p&&m&&(e<n?n=e:e>o&&(o=e),i<r?r=i:i>l&&(l=i),u<a?a=u:u>h&&(h=u),e<c.x?c.x=e:e>d.x&&(d.x=e),i<c.y?c.y=i:i>d.y&&(d.y=i),u<c.z?c.z=u:u>d.z&&(d.z=u))}i[4*u+0]=.5*(n+o),i[4*u+1]=.5*(r+l),i[4*u+2]=.5*(a+h),i[4*u+3]=.5*Math.sqrt((o-n)**2+(l-r)**2+(h-a)**2)}}b.hasOwnProperty("mapping")&&(n=b.mapping?new Uint32Array(b.mapping):null,o=!0),b.cameraPosition&&(r=b.cameraPosition),b.cameraDirection&&(a=b.cameraDirection),(()=>{if(!(e&&s&&0!==s.length&&r&&a))return;const v=r.x,b=r.y,y=r.z,S=a.x,x=a.y,w=a.z,T=.001;if(!o&&Math.abs(v-l.x)<T&&Math.abs(b-l.y)<T&&Math.abs(y-l.z)<T&&Math.abs(S-h.x)<T&&Math.abs(x-h.y)<T&&Math.abs(w-h.z)<T)return;let E,C;o=!1,l.x=v,l.y=b,l.z=y,h.x=S,h.y=x,h.z=w;for(let t=0;t<8;++t){const e=1&t?c.x:d.x,s=2&t?c.y:d.y,i=4&t?c.z:d.z,n=e*S+s*x+i*w;0===t?E=C=n:(E=Math.min(E,n),C=Math.max(C,n))}const A=s.length/3,D=2**Math.max(10,Math.min(20,Math.round(Math.log2(A/4))))+1;u?.length!==A&&(u=new Uint32Array(A)),f&&f.length===D?f.fill(0):f=new Uint32Array(D);const P=C-E;if(P<1e-6)for(let t=0;t<A;++t)u[t]=0,f[0]++;else{const t=i.length/4;m.fill(0);for(let e=0;e<t;++e){const t=i[4*e+0],s=i[4*e+1],n=i[4*e+2],r=i[4*e+3],a=t*S+s*x+n*w-E,o=Math.max(0,Math.floor((a-r)*p/P)),l=Math.min(p,Math.ceil((a+r)*p/P));for(let t=o;t<l;++t)m[t]++}const e=m.reduce(((t,e)=>t+e),0);for(let t=0;t<p;++t)g[t]=m[t]/e*D>>>0;for(let t=0;t<p;++t)_[t]=0===t?0:_[t-1]+g[t-1];const n=P/p;let r=0;for(let t=0;t<A;++t){const e=s[r++],i=s[r++],a=s[r++],o=(e*S+i*x+a*w-E)/n,l=o>>>0,h=_[l]+g[l]*(o-l)>>>0;u[t]=h,f[h]++}}for(let t=1;t<D;t++)f[t]+=f[t-1];for(let t=0;t<A;t++){const s=u[t],i=--f[s];e[i]=t}const L=v*S+b*x+y*w,I=t=>{let i=3*e[t];return s[i++]*S+s[i++]*x+s[i]*w-L},R=I(A-1)>=0?(()=>{const t=((t,e,s)=>{for(;t<=e;){const i=e+t>>1,n=s(i);if(n>0)t=i+1;else{if(!(n<0))return i;e=i-1}}return~t})(0,A-1,(t=>-I(t)));return Math.min(A,Math.abs(t))})():A;if(n)for(let t=0;t<A;++t)e[t]=n[e[t]];t.postMessage({order:e.buffer,count:R},[e.buffer]),e=null})()}))}class Op extends Ve{constructor(){super();const t=t=>{const e=t.data??t,s=e.order,i=this.orderTexture._levels[0].buffer;this.worker.postMessage({order:i},[i]),this.orderTexture._levels[0]=new Uint32Array(s),this.orderTexture.upload(),this.fire("updated",e.count)},e=`(${kp.toString()})()`;"node"===Ue.environment?(this.worker=new Worker(e,{eval:!0}),this.worker.on("message",t)):(this.worker=new Worker(URL.createObjectURL(new Blob([e],{type:"application/javascript"}))),this.worker.addEventListener("message",t))}destroy(){this.worker.terminate(),this.worker=null}init(t,e,s){this.orderTexture=t,this.centers=e.slice();const i=this.orderTexture.lock({mode:1}).slice();this.orderTexture.unlock();for(let t=0;t<i.length;++t)i[t]=t;const n={order:i.buffer,centers:e.buffer,chunks:s?.buffer},r=[i.buffer,e.buffer].concat(s?[s.buffer]:[]);this.worker.postMessage(n,r)}setMapping(t){if(t){const e=new Float32Array(3*t.length);for(let s=0;s<t.length;++s){const i=3*t[s],n=3*s;e[n+0]=this.centers[i+0],e[n+1]=this.centers[i+1],e[n+2]=this.centers[i+2]}this.worker.postMessage({centers:e.buffer,mapping:t.buffer},[e.buffer,t.buffer])}else{const t=this.centers.slice();this.worker.postMessage({centers:t.buffer,mapping:null},[t.buffer])}}setCamera(t,e){this.worker.postMessage({cameraPosition:{x:t.x,y:t.y,z:t.z},cameraDirection:{x:e.x,y:e.y,z:e.z}})}}const Fp=.28209479177387814,Np=t=>t.read(0,0,t.width,t.height,{mipLevel:0,face:0,immediate:!0});class Bp{constructor(t,e,s,i,n,r){const a=(t,e,s)=>t*(1-s)+e*s,{meta:o}=t,{means:l,scales:h,sh0:c,shN:d}=o,u=e&&t.means_l._levels[0],f=e&&t.means_u._levels[0],p=s&&t.quats._levels[0],m=i&&t.scales._levels[0],_=n&&t.sh0._levels[0],g=r&&t.sh_labels._levels[0],v=r&&t.sh_centroids._levels[0],b=2/Math.sqrt(2);this.read=o=>{if(e){const t=a(l.mins[0],l.maxs[0],((f[4*o+0]<<8)+u[4*o+0])/65535),s=a(l.mins[1],l.maxs[1],((f[4*o+1]<<8)+u[4*o+1])/65535),i=a(l.mins[2],l.maxs[2],((f[4*o+2]<<8)+u[4*o+2])/65535);e.x=Math.sign(t)*(Math.exp(Math.abs(t))-1),e.y=Math.sign(s)*(Math.exp(Math.abs(s))-1),e.z=Math.sign(i)*(Math.exp(Math.abs(i))-1)}if(s){const t=(p[4*o+0]/255-.5)*b,e=(p[4*o+1]/255-.5)*b,i=(p[4*o+2]/255-.5)*b,n=Math.sqrt(Math.max(0,1-(t*t+e*e+i*i)));switch(p[4*o+3]-252){case 0:s.set(t,e,i,n);break;case 1:s.set(n,e,i,t);break;case 2:s.set(e,n,i,t);break;case 3:s.set(e,i,n,t)}}if(i){const t=a(h.mins[0],h.maxs[0],m[4*o+0]/255),e=a(h.mins[1],h.maxs[1],m[4*o+1]/255),s=a(h.mins[2],h.maxs[2],m[4*o+2]/255);i.set(t,e,s)}if(n){const t=a(c.mins[0],c.maxs[0],_[4*o+0]/255),e=a(c.mins[1],c.maxs[1],_[4*o+1]/255),s=a(c.mins[2],c.maxs[2],_[4*o+2]/255),i=a(c.mins[3],c.maxs[3],_[4*o+3]/255);n.set(.5+t*Fp,.5+e*Fp,.5+s*Fp,1/(1+Math.exp(-i)))}if(r){const e=g[4*o+0]+(g[4*o+1]<<8),s=e%64*15,i=Math.floor(e/64);for(let e=0;e<3;++e)for(let n=0;n<15;++n)r[15*e+n]=a(d.mins,d.maxs,v[4*(s+n)+e+i*t.sh_centroids.width*4]/255)}}}}class Up{destroy(){this.means_l?.destroy(),this.means_u?.destroy(),this.quats?.destroy(),this.scales?.destroy(),this.sh0?.destroy(),this.sh_centroids?.destroy(),this.sh_labels?.destroy(),this.packedTexture?.destroy()}createIter(t,e,s,i,n){return new Bp(this,t,e,s,i,n)}calcAabb(t){const{mins:e,maxs:s}=this.meta.means,i=t=>Math.sign(t)*(Math.exp(Math.abs(t))-1);t.center.set(.5*(i(e[0])+i(s[0])),.5*(i(e[1])+i(s[1])),.5*(i(e[2])+i(s[2]))),t.halfExtents.set(.5*(i(s[0])-i(e[0])),.5*(i(s[1])-i(e[1])),.5*(i(s[2])-i(e[2])))}getCenters(t){const{meta:e,means_l:s,means_u:i,numSplats:n}=this,{means:r}=e,a=new Uint32Array(i._levels[0].buffer),o=new Uint32Array(s._levels[0].buffer),l=r.mins[0]/65535,h=r.mins[1]/65535,c=r.mins[2]/65535,d=r.maxs[0]/65535,u=r.maxs[1]/65535,f=r.maxs[2]/65535;for(let e=0;e<n;e++){const s=e,i=a[s],n=o[s],r=i<<8&65280|255&n,p=65280&i|n>>>8&255,m=i>>>8&65280|n>>>16&255,_=l*(65535-r)+d*r,g=h*(65535-p)+u*p,v=c*(65535-m)+f*m,b=_<0?-_:_,y=g<0?-g:g,S=v<0?-v:v;t[3*e]=(_<0?-1:1)*(Math.exp(b)-1),t[3*e+1]=(g<0?-1:1)*(Math.exp(y)-1),t[3*e+2]=(v<0?-1:1)*(Math.exp(S)-1)}}calcFocalPoint(t,e){t.set(0,0,0)}get isSogs(){return!0}get shBands(){return{192:1,512:2,960:3}[this.sh_centroids?.width]??0}async decompress(){const t=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:e}=this,{means_l:s,means_u:i,quats:n,scales:r,sh0:a,sh_labels:o,sh_centroids:l}=this;if(s._levels[0]=await Np(s),i._levels[0]=await Np(i),n._levels[0]=await Np(n),r._levels[0]=await Np(r),a._levels[0]=await Np(a),e>0){o._levels[0]=await Np(o),l._levels[0]=await Np(l);const e=[];for(let t=0;t<45;++t)e.push(`f_rest_${t}`);t.splice(t.indexOf("f_dc_0")+1,0,...e)}const h={};t.forEach((t=>{h[t]=new Float32Array(this.numSplats)}));const c=new rs,d=new ms,u=new rs,f=new ls,p=e>0?new Float32Array(45):null,m=this.createIter(c,d,u,f,p);for(let t=0;t<this.numSplats;++t)if(m.read(t),h.x[t]=c.x,h.y[t]=c.y,h.z[t]=c.z,h.rot_1[t]=d.x,h.rot_2[t]=d.y,h.rot_3[t]=d.z,h.rot_0[t]=d.w,h.scale_0[t]=u.x,h.scale_1[t]=u.y,h.scale_2[t]=u.z,h.f_dc_0[t]=(f.x-.5)/Fp,h.f_dc_1[t]=(f.y-.5)/Fp,h.f_dc_2[t]=(f.z-.5)/Fp,h.opacity[t]=f.w<=0?-40:f.w>=1?40:-Math.log(1/f.w-1),p)for(let e=0;e<45;++e)h[`f_rest_${e}`][t]=p[e];return new Ap([{name:"vertex",count:this.numSplats,properties:t.map((t=>({name:t,type:"float",byteSize:4,storage:h[t]})))}])}packGpuMemory(){const{means_l:t,means_u:e,quats:s,scales:i,sh_labels:n,numSplats:r}=this,{device:a}=t,{scope:o}=a,l=Ph.createShader(a,{uniqueName:"GsplatSogsReorderShader",attributes:{vertex_position:$s},vertexChunk:"fullscreenQuadVS",fragmentGLSL:"\n\tuniform highp sampler2D means_l;\n\tuniform highp sampler2D means_u;\n\tuniform highp sampler2D quats;\n\tuniform highp sampler2D scales;\n\tuniform highp sampler2D sh_labels;\n\tuniform highp uint numSplats;\n\tuint packU32(vec4 v) {\n\t\treturn uint(v.x * 255.0) << 24u |\n\t\t\t   uint(v.y * 255.0) << 16u |\n\t\t\t   uint(v.z * 255.0) << 8u |\n\t\t\t   uint(v.w * 255.0);\n\t}\n\tuvec4 packU32(vec4 a, vec4 b, vec4 c, vec4 d) {\n\t\treturn uvec4(packU32(a), packU32(b), packU32(c), packU32(d));\n\t}\n\tvoid main(void) {\n\t\tint w = int(textureSize(means_l, 0).x);\n\t\tivec2 uv = ivec2(gl_FragCoord.xy);\n\t\tif (uint(uv.x + uv.y * w) >= numSplats) {\n\t\t\tdiscard;\n\t\t}\n\t\tvec3 meansLSample = texelFetch(means_l, uv, 0).xyz;\n\t\tvec3 meansUSample = texelFetch(means_u, uv, 0).xyz;\n\t\tvec4 quatsSample = texelFetch(quats, uv, 0);\n\t\tvec3 scalesSample = texelFetch(scales, uv, 0).xyz;\n\t\tvec2 shLabelsSample = texelFetch(sh_labels, uv, 0).xy;\n\t\tpcFragColor0 = packU32(\n\t\t\tvec4(meansLSample, shLabelsSample.x),\n\t\t\tvec4(meansUSample, shLabelsSample.y),\n\t\t\tvec4(quatsSample),\n\t\t\tvec4(scalesSample, 0.0)\n\t\t);\n\t}\n",fragmentWGSL:"\n\tvar means_l: texture_2d<f32>;\n\tvar means_u: texture_2d<f32>;\n\tvar quats: texture_2d<f32>;\n\tvar scales: texture_2d<f32>;\n\tvar sh_labels: texture_2d<f32>;\n\tuniform numSplats: u32;\n\tfn packU32(v: vec4<f32>) -> u32 {\n\t\treturn (u32(v.x * 255.0) << 24u)  |\n\t\t\t   (u32(v.y * 255.0) << 16u)  |\n\t\t\t   (u32(v.z * 255.0) << 8u) |\n\t\t\t   u32(v.w * 255.0);\n\t}\n\tfn packUVec32(a: vec4<f32>, b: vec4<f32>, c: vec4<f32>, d: vec4<f32>) -> vec4<u32> {\n\t\treturn vec4<u32>(packU32(a), packU32(b), packU32(c), packU32(d));\n\t}\n\t@fragment\n\tfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\tlet w: u32 = textureDimensions(means_l, 0).x;\n\t\tlet uv: vec2<u32> = vec2<u32>(pcPosition.xy);\n\t\tif (uv.x + uv.y * w >= uniform.numSplats) {\n\t\t\tdiscard;\n\t\t\treturn output;\n\t\t}\n\t\tlet meansLSample: vec3<f32> = textureLoad(means_l, uv, 0).xyz;\n\t\tlet meansUSample: vec3<f32> = textureLoad(means_u, uv, 0).xyz;\n\t\tlet quatsSample: vec4<f32> = textureLoad(quats, uv, 0);\n\t\tlet scalesSample: vec3<f32> = textureLoad(scales, uv, 0).xyz;\n\t\tlet shLabelsSample: vec2<f32> = textureLoad(sh_labels, uv, 0).xy;\n\t\toutput.color = packUVec32(\n\t\t\tvec4(meansLSample, shLabelsSample.x),\n\t\t\tvec4(meansUSample, shLabelsSample.y),\n\t\t\tvec4(quatsSample),\n\t\t\tvec4(scalesSample, 0.0)\n\t\t);\n\t\treturn output;\n\t}\n",fragmentOutputTypes:["uvec4"]}),h=new Hn({colorBuffer:this.packedTexture,depth:!1,mipLevel:0});a.setCullMode(0),a.setBlendState(Sn.NOBLEND),a.setDepthState(Tn.NODEPTH),((t,e)=>{for(const s in e)t.resolve(s).setValue(e[s])})(o,{means_l:t,means_u:e,quats:s,scales:i,sh_labels:n??t,numSplats:r}),Nh(a,h,l),h.destroy(),l.destroy()}async prepareGpuData(){const{device:t,height:e,width:s}=this.means_l;this.means_l._levels[0]=await Np(this.means_l),this.means_u._levels[0]=await Np(this.means_u),this.packedTexture=new dn(t,{name:"sogsPackedTexture",width:s,height:e,format:Us,mipmaps:!1}),t.on("devicerestored",(()=>{this.packGpuMemory()})),this.packGpuMemory()}reorderData(){return this.prepareGpuData()}}const zp=new ps,Vp=new rs,Hp=new rs,Gp=[0,0];class Wp{constructor(t,e={}){this.options={},this.sorter=null,this.lastCameraPosition=new rs,this.lastCameraDirection=new rs,this.resolveSH=null,this.cameras=[],this.resource=t,this.orderTexture=t.createTexture("splatOrder",Bs,t.evalTextureSize(t.numSplats)),e.material?(this._material=e.material,this._material.setParameter("splatOrder",this.orderTexture)):(this._material=new Gu({uniqueName:"SplatMaterial",vertexGLSL:'#include "gsplatVS"',fragmentGLSL:'#include "gsplatPS"',vertexWGSL:'#include "gsplatVS"',fragmentWGSL:'#include "gsplatPS"',attributes:{vertex_position:$s,vertex_id_attrib:ui}}),this.configureMaterial(this._material),this._material.update()),this.meshInstance=new nc(t.mesh,this._material),this.meshInstance.setInstancing(t.instanceIndices,!0),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0;const s=t.centers.slice(),i=t.chunks?.slice();this.sorter=new Op,this.sorter.init(this.orderTexture,s,i),this.sorter.on("updated",(e=>{this.meshInstance.instancingCount=Math.ceil(e/t.instanceSize),this.material.setParameter("numSplats",e)})),this.setHighQualitySH(e.highQualitySH??!1)}destroy(){this.resolveSH?.destroy(),this.material?.destroy(),this.meshInstance?.destroy(),this.sorter?.destroy()}set material(t){this._material!==t&&(this._material=t,this._material.setParameter("splatOrder",this.orderTexture),this.meshInstance&&(this.meshInstance.material=t))}get material(){return this._material}configureMaterial(t,e={}){this.resource.configureMaterial(t),t.setParameter("numSplats",0),t.setParameter("splatOrder",this.orderTexture),t.setParameter("alphaClip",.3),t.setDefine("DITHER_"+(e.dither?"BLUENOISE":"NONE"),""),t.cull=0,t.blendType=e.dither?3:4,t.depthWrite=!!e.dither}updateViewport(t){const e=t?.camera,s=e?.renderTarget,{width:i,height:n}=s??this.resource.device;Gp[0]=i,Gp[1]=n;const r=e?.camera?.xr;r?.active&&2===r.views.list.length&&(Gp[0]*=.5),this.material.setParameter("viewport",Gp)}sort(t){if(this.sorter){const e=t.getWorldTransform();e.getTranslation(Vp),e.getZ(Hp);const s=this.meshInstance.node.getWorldTransform(),i=zp.invert(s);i.transformPoint(Vp,Vp),i.transformVector(Hp,Hp),Vp.equalsApprox(this.lastCameraPosition)&&Hp.equalsApprox(this.lastCameraDirection)||(this.lastCameraPosition.copy(Vp),this.lastCameraDirection.copy(Hp),this.sorter.setCamera(Vp,Hp))}this.updateViewport(t)}update(){if(this.cameras.length>0){const t=this.cameras[0];this.sort(t._node),this.resolveSH?.render(t._node,this.meshInstance.node.getWorldTransform()),this.cameras.length=0}}setHighQualitySH(t){const{resource:e}=this,{gsplatData:s}=e;s instanceof Up&&s.shBands>0&&t===!!this.resolveSH&&(this.resolveSH?(this.resolveSH.destroy(),this.resolveSH=null):this.resolveSH=new Mp(e.device,this))}}class jp extends Dp{destroy(){this.gsplatData.destroy(),super.destroy()}configureMaterial(t){const{gsplatData:e}=this;t.setDefine("GSPLAT_SOGS_DATA",!0),t.setDefine("SH_BANDS",this.gsplatData.shBands),["packedTexture","sh0","sh_centroids"].forEach((s=>{e[s]&&t.setParameter(s,e[s])})),["means","scales","sh0","shN"].forEach((s=>{const i=e.meta[s];i&&(t.setParameter(`${s}_mins`,i.mins),t.setParameter(`${s}_maxs`,i.maxs))}))}evalTextureSize(t){return new os(this.gsplatData.means_l.width,this.gsplatData.means_l.height)}}const Xp="KEEP_ASPECT",$p="AUTO";let qp;function Kp(){return qp}function Yp(t){qp=t}class Qp{addRenderPass(t){t.frameUpdate();const e=t.beforePasses;for(let t=0;t<e.length;t++){const s=e[t];s.enabled&&this.addRenderPass(s)}t.enabled&&this.renderPasses.push(t);const s=t.afterPasses;for(let t=0;t<s.length;t++){const e=s[t];e.enabled&&this.addRenderPass(e)}}reset(){this.renderPasses.length=0}compile(){const t=this.renderTargetMap,e=this.renderPasses;for(let s=0;s<e.length;s++){const i=e[s],n=i.renderTarget;if(void 0!==n){const e=t.get(n);if(e){const t=i.colorArrayOps.length;for(let s=0;s<t;s++){i.colorArrayOps[s].clear||(e.colorArrayOps[s].store=!0)}i.depthStencilOps.clearDepth||(e.depthStencilOps.storeDepth=!0),i.depthStencilOps.clearStencil||(e.depthStencilOps.storeStencil=!0)}t.set(n,i)}}for(let t=0;t<e.length-1;t++){const s=e[t],i=s.renderTarget,n=e[t+1];i===n.renderTarget&&void 0!==i&&(n.depthStencilOps.clearDepth||n.depthStencilOps.clearStencil||n.colorArrayOps.some((t=>t.clear))||s.afterPasses.length>0||n.beforePasses.length>0||(s._skipEnd=!0,n._skipStart=!0))}let s=null,i=null;for(let t=0;t<e.length;t++){const n=e[t],r=n.renderTarget,a=r?.colorBuffer;if(a?.cubemap){if(s===a){const t=i.colorArrayOps.length;for(let e=0;e<t;e++)i.colorArrayOps[e].mipmaps=!1}s=r.colorBuffer,i=n}else n.requiresCubemaps&&(s=null,i=null)}t.clear()}render(t){this.compile();const e=this.renderPasses;for(let t=0;t<e.length;t++)e[t].render()}constructor(){this.renderPasses=[],this.renderTargetMap=new Map}}class Zp{constructor(t,e){this.texture0=t,this.texture1=e}destroy(){this.texture0?.destroy(),this.texture1?.destroy()}}const Jp=new ln;class tm{static createTexture(t,e,s,i=""){return new dn(t,{name:`AreaLightLUT${i}`,width:s,height:s,format:e,addressU:1,addressV:1,type:mi,magFilter:1,minFilter:0,anisotropy:1,mipmaps:!1})}static applyTextures(t,e,s){Jp.remove(t),Jp.get(t,(()=>new Zp(e,e===s?null:s))),t.scope.resolve("areaLightsLutTex1").setValue(e),t.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(t){const e=tm.createTexture(t,Ps,2,"placeholder");e.lock().fill(0),e.unlock(),tm.applyTextures(t,e,e)}static set(t,e,s){function i(t,e,s){const i=tm.createTexture(t,s,64);return i.lock().set(e),i.unlock(),i}function n(t){const e=t.length,s=new Uint16Array(e),i=ns.float2Half;for(let n=0;n<e;n++)s[n]=i(t[n]);return s}const r=s,a=n(e),o=n(r),l=i(t,a,Ps),h=i(t,o,Ps);tm.applyTextures(t,l,h)}}const em="en-US",sm={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},im={};function nm(t,e){for(let s=0,i=t.length;s<i;s++)im[t[s]]=e}function rm(t){const e=t.indexOf("-");return-1!==e?t.substring(0,e):t}function am(t,e){if(e[t])return t;let s=sm[t];if(s&&e[s])return s;const i=rm(t);return s=sm[i],e[s]?s:e[i]?i:em}nm(["ja","ko","th","vi","zh","id"],(t=>0)),nm(["fa","hi"],(t=>t>=0&&t<=1?0:1)),nm(["fr","pt"],(t=>t>=0&&t<2?0:1)),nm(["da"],(t=>1===t||!Number.isInteger(t)&&t>=0&&t<=1?0:1)),nm(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(t=>1===t?0:1)),nm(["ru","uk"],(t=>{if(Number.isInteger(t)){const e=t%10,s=t%100;if(1===e&&11!==s)return 0;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(0===e||e>=5&&e<=9||s>=11&&s<=14)return 2}return 3})),nm(["pl"],(t=>{if(Number.isInteger(t)){if(1===t)return 0;const e=t%10,s=t%100;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||s>=12&&s<=14)return 2}return 3})),nm(["ar"],(t=>{if(0===t)return 0;if(1===t)return 1;if(2===t)return 2;if(Number.isInteger(t)){const e=t%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5}));const om=im[rm(em)];function lm(t){return im[t]||om}const hm=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i");class cm{constructor(t="",e="",s=null,i=null,n=null,r=null){this.url=t,this.filename=e,this.hash=s,this.size=i,this.opt=n,this.contents=r}equals(t){return this.url===t.url&&this.filename===t.filename&&this.hash===t.hash&&this.size===t.size&&this.opt===t.opt&&this.contents===t.contents}}let dm=-1;const um={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},fm=["pvr","dxt","etc2","etc1","basis"];class pm extends Ve{static{this.EVENT_LOAD="load"}static{this.EVENT_UNLOAD="unload"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_ERROR="error"}static{this.EVENT_CHANGE="change"}static{this.EVENT_PROGRESS="progress"}static{this.EVENT_ADDLOCALIZED="add:localized"}static{this.EVENT_REMOVELOCALIZED="remove:localized"}constructor(t,e,s,i={},n={}){super(),this._file=null,this._i18n={},this._preload=!1,this._resources=[],this.id=dm--,this.loaded=!1,this.loading=!1,this.options={},this.registry=null,this.tags=new Xe(this),this.urlObject=null,this._name=t||"",this.type=e,this._data=i||{},this.options=n||{},s&&(this.file=s)}set name(t){if(this._name===t)return;const e=this._name;this._name=t,this.fire("name",this,this._name,e)}get name(){return this._name}set file(t){if(t&&t.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){const e=this.registry?._loader?._app||Kp(),s=e?.graphicsDevice;if(s)for(let i=0,n=fm.length;i<n;i++){const n=fm[i];if(t.variants[n]&&s[um[n]]){t=t.variants[n];break}if(e.enableBundles){const t=e.bundles.listBundlesForAsset(this);if(t&&t.find((t=>t?.file?.variants[n])))break}}}const e=this._file,s=t?new cm(t.url,t.filename,t.hash,t.size,t.opt,t.contents):null;(!!s!=!!e||s&&!s.equals(e))&&(this._file=s,this.fire("change",this,"file",s,e),this.reload())}get file(){return this._file}set data(t){const e=this._data;this._data=t,t!==e&&(this.fire("change",this,"data",t,e),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(t){const e=this._resources[0];this._resources[0]=t,this.fire("change",this,"resource",t,e)}get resource(){return this._resources[0]}set resources(t){const e=this._resources;this._resources=t,this.fire("change",this,"resources",t,e)}get resources(){return this._resources}set preload(t){t=!!t,this._preload!==t&&(this._preload=t,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(t){t=!!t,this.hasOwnProperty("_loadFaces")&&t===this._loadFaces||(this._loadFaces=t,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const t=this.file;if(!t||!t.url)return null;let e=t.url;if(this.registry&&this.registry.prefix&&!hm.test(e)&&(e=this.registry.prefix+e),"script"!==this.type&&t.hash){const s=-1!==e.indexOf("?")?"&":"?";e+=`${s}t=${t.hash}`}return e}getAbsoluteUrl(t){if(t.startsWith("blob:")||t.startsWith("data:"))return t;const e=ke.getDirectory(this.file.url);return ke.join(e,t)}getLocalizedAssetId(t){return t=am(t,this._i18n),this._i18n[t]||null}addLocalizedAssetId(t,e){this._i18n[t]=e,this.fire("add:localized",t,e)}removeLocalizedAssetId(t){const e=this._i18n[t];e&&(delete this._i18n[t],this.fire("remove:localized",t,e))}ready(t,e){e=e||this,this.loaded?t.call(e,this):this.once("load",(s=>{t.call(e,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire(`unload:${this.id}`,this);const t=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let e=0;e<t.length;++e){const s=t[e];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(t,e,s,i=0){s?.file?.contents?setTimeout((()=>{e(null,s.file.contents)})):tl.get(t,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},e)}}class mm{constructor(t=null){this._index={},this._key=t}addItem(t){const e=t.tags._list;for(const s of e)this.add(s,t)}removeItem(t){const e=t.tags._list;for(const s of e)this.remove(s,t)}add(t,e){this._index[t]&&-1!==this._index[t].list.indexOf(e)||(this._index[t]||(this._index[t]={list:[]},this._key&&(this._index[t].keys={})),this._index[t].list.push(e),this._key&&(this._index[t].keys[e[this._key]]=e))}remove(t,e){if(!this._index[t])return;if(this._key&&!this._index[t].keys[e[this._key]])return;const s=this._index[t].list.indexOf(e);-1!==s&&(this._index[t].list.splice(s,1),this._key&&delete this._index[t].keys[e[this._key]],0===this._index[t].list.length&&delete this._index[t])}find(t){const e={},s=[];let i,n,r,a,o;const l=(t,e)=>this._index[t].list.length-this._index[e].list.length;for(let h=0;h<t.length;h++){if(n=t[h],n instanceof Array){if(0===n.length)continue;if(1!==n.length){o=!1;for(let t=0;t<n.length;t++)if(!this._index[n[t]]){o=!0;break}if(o)continue;r=n.slice(0).sort(l),a=r.slice(1),1===a.length&&(a=a[0]);for(let t=0;t<this._index[r[0]].list.length;t++)i=this._index[r[0]].list[t],(this._key?!e[i[this._key]]:-1===s.indexOf(i))&&i.tags.has(a)&&(this._key&&(e[i[this._key]]=!0),s.push(i));continue}n=n[0]}if(n&&"string"==typeof n&&this._index[n])for(let t=0;t<this._index[n].list.length;t++)i=this._index[n].list[t],this._key?e[i[this._key]]||(e[i[this._key]]=!0,s.push(i)):-1===s.indexOf(i)&&s.push(i)}return s}}class _m extends Ve{static{this.EVENT_LOAD="load"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_ERROR="error"}constructor(t){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new mm("id"),this.prefix=null,this.bundles=null,this._loader=t}list(t={}){const e=Array.from(this._assets);return void 0!==t.preload?e.filter((e=>e.preload===t.preload)):e}add(t){this._assets.has(t)||(this._assets.add(t),this._idToAsset.set(t.id,t),t.file?.url&&this._urlToAsset.set(t.file.url,t),this._nameToAsset.has(t.name)||this._nameToAsset.set(t.name,new Set),this._nameToAsset.get(t.name).add(t),t.on("name",this._onNameChange,this),t.registry=this,this._tags.addItem(t),t.tags.on("add",this._onTagAdd,this),t.tags.on("remove",this._onTagRemove,this),this.fire("add",t),this.fire(`add:${t.id}`,t),t.file?.url&&this.fire(`add:url:${t.file.url}`,t),t.preload&&this.load(t))}remove(t){if(!this._assets.has(t))return!1;if(this._assets.delete(t),this._idToAsset.delete(t.id),t.file?.url&&this._urlToAsset.delete(t.file.url),t.off("name",this._onNameChange,this),this._nameToAsset.has(t.name)){const e=this._nameToAsset.get(t.name);e.delete(t),0===e.size&&this._nameToAsset.delete(t.name)}return this._tags.removeItem(t),t.tags.off("add",this._onTagAdd,this),t.tags.off("remove",this._onTagRemove,this),t.fire("remove",t),this.fire("remove",t),this.fire(`remove:${t.id}`,t),t.file?.url&&this.fire(`remove:url:${t.file.url}`,t),!0}get(t){return this._idToAsset.get(Number(t))}getByUrl(t){return this._urlToAsset.get(t)}load(t,e){if((t.loading||t.loaded)&&!e?.force)return;const s=t.file,i=()=>{this.fire("load",t),this.fire(`load:${t.id}`,t),s&&s.url&&this.fire(`load:url:${s.url}`,t),t.fire("load",t)},n=e=>{if(e instanceof Array?t.resources=e:t.resource=e,this._loader.patch(t,this),"bundle"===t.type){const e=t.data.assets;for(let t=0;t<e.length;t++){const s=this._idToAsset.get(e[t]);s&&!s.loaded&&this.load(s,{force:!0})}t.resource.loaded?i():(this.fire("load:start",t),this.fire(`load:start:${t.id}`,t),s&&s.url&&this.fire(`load:start:url:${s.url}`,t),t.fire("load:start",t),t.resource.on("load",i))}else i()},r=(e,s,i)=>{if(t.loaded=!0,t.loading=!1,e)this.fire("error",e,t),this.fire(`error:${t.id}`,e,t),t.fire("error",e,t);else{if("script"===t.type){const e=this._loader.getHandler("script");e._cache[t.id]&&e._cache[t.id].parentNode===document.head&&document.head.removeChild(e._cache[t.id]),e._cache[t.id]=i}n(s)}};if(s||"cubemap"===t.type){this.fire("load:start",t),this.fire(`load:${t.id}:start`,t),t.loading=!0;const s=t.getFileUrl();if("bundle"===t.type){const e=t.data.assets;for(let t=0;t<e.length;t++){const s=this._idToAsset.get(e[t]);s&&(s.loaded||s.resource||s.loading||(s.loading=!0))}}this._loader.load(s,t.type,r,t,e)}else{const e=this._loader.open(t.type,t.data);t.loaded=!0,n(e)}}loadFromUrl(t,e,s){this.loadFromUrlAndFilename(t,null,e,s)}loadFromUrlAndFilename(t,e,s,i){const n=ke.getBasename(e||t),r={filename:e||n,url:t};let a=this.getByUrl(t);if(a){if(a.loaded)return void i(a.loadFromUrlError||null,a)}else a=new pm(n,s,r),this.add(a);const o=t=>{t.once("load",(t=>{"material"===s?this._loadTextures(t,((e,s)=>{i(e,t)})):i(null,t)})),t.once("error",(e=>{e&&(this.loadFromUrlError=e),i(e,t)})),this.load(t)};a.resource?i(null,a):"model"===s?this._loadModel(a,o):o(a)}_loadModel(t,e){const s=t.getFileUrl(),i=ke.getExtension(s);if(".json"===i||".glb"===i){const n=ke.getDirectory(s),r=ke.getBasename(s),a=ke.join(n,r.replace(i,".mapping.json"));this._loader.load(a,"json",((s,i)=>{s?(t.data={mapping:[]},e(t)):this._loadMaterials(t,i,((s,n)=>{t.data=i,e(t)}))}))}else e(t)}_loadMaterials(t,e,s){const i=[];let n=0;const r=(t,e)=>{this._loadTextures(e,((t,r)=>{i.push(e),i.length===n&&s(null,i)}))};for(let s=0;s<e.mapping.length;s++){const i=e.mapping[s].path;if(i){n++;const e=t.getAbsoluteUrl(i);this.loadFromUrl(e,"material",r)}}0===n&&s(null,i)}_loadTextures(t,e){const s=[];let i=0;const n=t.data;if("path"!==n.mappingFormat)return void e(null,s);const r=(t,n)=>{t&&console.error(t),s.push(n),s.length===i&&e(null,s)},a=$f;for(let e=0;e<a.length;e++){const s=n[a[e]];if(s&&"string"==typeof s){i++;const e=t.getAbsoluteUrl(s);this.loadFromUrl(e,"texture",r)}}0===i&&e(null,s)}_onTagAdd(t,e){this._tags.add(t,e)}_onTagRemove(t,e){this._tags.remove(t,e)}_onNameChange(t,e,s){if(this._nameToAsset.has(s)){const e=this._nameToAsset.get(s);e.delete(t),0===e.size&&this._nameToAsset.delete(s)}this._nameToAsset.has(t.name)||this._nameToAsset.set(t.name,new Set),this._nameToAsset.get(t.name).add(t)}findByTag(...t){return this._tags.find(t)}filter(t){return Array.from(this._assets).filter((e=>t(e)))}find(t,e){const s=this._nameToAsset.get(t);if(!s)return null;for(const t of s)if(!e||t.type===e)return t;return null}findAll(t,e){const s=this._nameToAsset.get(t);if(!s)return[];const i=Array.from(s);return e?i.filter((t=>t.type===e)):i}}class gm{constructor(t){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=t,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}_onAssetAdd(t){if("bundle"===t.type){this._idToBundle.set(t.id,t),this._assets.on(`load:start:${t.id}`,this._onBundleLoadStart,this),this._assets.on(`load:${t.id}`,this._onBundleLoad,this),this._assets.on(`error:${t.id}`,this._onBundleError,this);const e=t.data.assets;for(let s=0;s<e.length;s++)this._indexAssetInBundle(e[s],t)}else this._assetToBundles.has(t.id)&&this._indexAssetFileUrls(t)}_unbindAssetEvents(t){this._assets.off(`load:start:${t}`,this._onBundleLoadStart,this),this._assets.off(`load:${t}`,this._onBundleLoad,this),this._assets.off(`error:${t}`,this._onBundleError,this)}_indexAssetInBundle(t,e){let s=this._assetToBundles.get(t);s||(s=new Set,this._assetToBundles.set(t,s)),s.add(e);const i=this._assets.get(t);i&&this._indexAssetFileUrls(i)}_indexAssetFileUrls(t){const e=this._getAssetFileUrls(t);if(e)for(let s=0;s<e.length;s++){const i=this._assetToBundles.get(t.id);i&&this._urlsToBundles.set(e[s],i)}}_getAssetFileUrls(t){let e=t.getFileUrl();if(!e)return null;e=e.split("?")[0];const s=[e];if("font"===t.type){const i=t.data.info.maps.length;for(let t=1;t<i;t++)s.push(e.replace(".png",`${t}.png`))}return s}_onAssetRemove(t){if("bundle"===t.type){this._idToBundle.delete(t.id),this._unbindAssetEvents(t.id);const e=t.data.assets;for(let s=0;s<e.length;s++){const i=this._assetToBundles.get(e[s]);if(i&&(i.delete(t),0===i.size)){this._assetToBundles.delete(e[s]);for(const[t,e]of this._urlsToBundles)e===i&&this._urlsToBundles.delete(t)}}this._onBundleError(`Bundle ${t.id} was removed`)}else{if(!this._assetToBundles.get(t.id))return;this._assetToBundles.delete(t.id);const e=this._getAssetFileUrls(t);if(!e)return;for(let t=0;t<e.length;t++)this._urlsToBundles.delete(e[t])}}_onBundleLoadStart(t){t.resource.on("add",((t,e)=>{const s=this._fileRequests.get(t);if(s){for(let t=0;t<s.length;t++)s[t](null,e);this._fileRequests.delete(t)}}))}_onBundleLoad(t){if(t.resource){if(this._fileRequests)for(const[e,s]of this._fileRequests){const i=this._urlsToBundles.get(e);if(!i||!i.has(t))continue;const n=decodeURIComponent(e);let r,a;if(t.resource.has(n))a=t.resource.get(n);else{if(!t.resource.loaded)continue;r=`Bundle ${t.id} does not contain URL ${e}`}for(let t=0;t<s.length;t++)s[t](r,r||a);this._fileRequests.delete(e)}}else this._onBundleError(`Bundle ${t.id} failed to load`)}_onBundleError(t){for(const[e,s]of this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(e)){for(let e=0;e<s.length;e++)s[e](t);this._fileRequests.delete(e)}}}_findLoadedOrLoadingBundleForUrl(t){const e=this._urlsToBundles.get(t);if(!e)return null;let s=null;for(const t of e){if(t.loaded&&t.resource)return t;t.loading&&(s=t)}return s}listBundlesForAsset(t){const e=this._assetToBundles.get(t.id);return e?Array.from(e):null}list(){return Array.from(this._idToBundle.values())}hasUrl(t){return this._urlsToBundles.has(t)}urlIsLoadedOrLoading(t){return!!this._findLoadedOrLoadingBundleForUrl(t)}loadUrl(t,e){const s=this._findLoadedOrLoadingBundleForUrl(t);if(!s)return void e(`URL ${t} not found in any bundles`);if(s.loaded){const i=decodeURIComponent(t);if(s.resource.has(i))return void e(null,s.resource.get(i));if(s.resource.loaded)return void e(`Bundle ${s.id} does not contain URL ${t}`)}let i=this._fileRequests.get(t);i||(i=[],this._fileRequests.set(t,i)),i.push(e)}destroy(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(const t of this._idToBundle.keys())this._unbindAssetEvents(t);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}}class vm extends Ve{constructor(){super(),this.list=[]}add(t){const e=t.id;if(this[e])throw new Error(`ComponentSystem name '${e}' already registered or not allowed`);this[e]=t,this.list.push(t)}remove(t){const e=t.id;if(!this[e])throw new Error(`No ComponentSystem named '${e}' registered`);delete this[e];const s=this.list.indexOf(this[e]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(let t=0;t<this.list.length;t++)this.list[t].destroy()}}class bm extends Ve{static{this.EVENT_ADD="add"}static{this.EVENT_LOAD="load"}addFile(t,e){this._index.has(t)||(this._index.set(t,e),this.fire("add",t,e))}has(t){return this._index.has(t)}get(t){return this._index.get(t)||null}destroy(){this._index.clear()}set loaded(t){t&&!this._loaded&&(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}constructor(...t){super(...t),this._index=new Map,this._loaded=!1}}class ym extends Ve{constructor(t,e=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=e||"",this.reader=t.body.getReader(),this.reader.read().then((t=>{this.pump(t.done,t.value)})).catch((t=>{this.fire("error",t)}))}pump(t,e){if(t)return this.fire("done"),null;this.bytesReceived+=e.byteLength;const s=new Uint8Array(this.data.length+e.length);for(s.set(this.data),s.set(e,this.data.length),this.data=s;this.readFile(););return this.reader.read().then((t=>{this.pump(t.done,t.value)})).catch((t=>{this.fire("error",t)}))}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=!0;const t=new DataView(this.data.buffer,this.bytesRead,this.headerSize);this.decoder??=new TextDecoder("windows-1252");const e=this.decoder.decode(t);if(this.fileName=e.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(e.substring(124,136),8),this.fileType=e.substring(156,157),this.ustarFormat=e.substring(257,263),-1!==this.ustarFormat.indexOf("ustar")){const t=e.substring(345,500).replace(/\0/g,"");t.length>0&&(this.fileName=t.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(""===this.fileType||"0"===this.fileType){const t=new DataView(this.data.buffer,this.bytesRead,this.fileSize),e={name:this.prefix+this.fileName,size:this.fileSize,data:t};this.fire("file",e)}this.bytesRead+=this.fileSize,this.headerRead=!1;const t=this.bytesRead%this.paddingSize;return 0!==t&&(this.bytesRead+=this.paddingSize-t),!0}return!1}}class Sm{constructor(t,e){this.handlerType="",this._maxRetries=0,this._app=t,this.handlerType=e}set maxRetries(t){this._maxRetries=t}get maxRetries(){return this._maxRetries}load(t,e,s){}open(t,e,s){return e}patch(t,e){}}class xm extends Sm{constructor(t){super(t,"bundle"),this._assets=t.assets}_fetchRetries(t,e,s=0){return new Promise(((i,n)=>{const r=()=>{fetch(t,e).then(i).catch((t=>{++s<this.maxRetries?r():n(t)}))};r()}))}load(t,e){"string"==typeof t&&(t={load:t,original:t}),this._fetchRetries(t.load,{mode:"cors"},this.maxRetries).then((t=>{const s=new bm;e(null,s);const i=new ym(t,this._assets.prefix);i.on("file",(t=>{s.addFile(t.name,t.data)})),i.on("done",(()=>{s.loaded=!0})),i.on("error",(t=>{e(t)}))})).catch((t=>{e(t)}))}open(t,e){return e}}class wm{constructor(t){this._handlers={},this._requests={},this._cache={},this._app=t}addHandler(t,e){this._handlers[t]=e,e._loader=this}removeHandler(t){delete this._handlers[t]}getHandler(t){return this._handlers[t]}static makeKey(t,e){return`${t}-${e}`}load(t,e,s,i,n){const r=this._handlers[e];if(!r){return void s(`No resource handler for asset type: '${e}' when loading [${t}]`)}if(!t)return void this._loadNull(r,s,i);const a=wm.makeKey(t,e);if(void 0!==this._cache[a])s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else{this._requests[a]=[s];const e=this,o=function(t,s){if(t)e._onFailure(a,t);else{if(s.load instanceof DataView){if(r.openBinary){if(!e._requests[a])return;try{const t=r.openBinary(s.load);e._onSuccess(a,t)}catch(t){e._onFailure(a,t)}return}s.load=URL.createObjectURL(new Blob([s.load])),i&&(i.urlObject&&URL.revokeObjectURL(i.urlObject),i.urlObject=s.load)}r.load(s,((t,n,o)=>{if(e._requests[a])if(t)e._onFailure(a,t);else try{e._onSuccess(a,r.open(s.original,n,i),o)}catch(t){e._onFailure(a,t)}}),i)}},l=t.split("?")[0];if(!this._app.enableBundles||!this._app.bundles.hasUrl(l)||n&&n.bundlesIgnore)o(null,{load:t,original:i&&i.file.filename||t});else{if(!this._app.bundles.urlIsLoadedOrLoading(l)){const t=this._app.bundles.listBundlesForAsset(i);let e;n&&n.bundlesFilter&&(e=n.bundlesFilter(t)),e||(t?.sort(((t,e)=>t.file.size-e.file.size)),e=t?.[0]),e&&this._app.assets?.load(e)}this._app.bundles.loadUrl(l,((t,e)=>{o(t,{load:e,original:l})}))}}}_loadNull(t,e,s){t.load(null,(function(i,n,r){if(i)e(i);else try{e(null,t.open(null,n,s),r)}catch(t){e(t)}}),s)}_onSuccess(t,e,s){null!==e?this._cache[t]=e:delete this._cache[t];for(let i=0;i<this._requests[t].length;i++)this._requests[t][i](null,e,s);delete this._requests[t]}_onFailure(t,e){if(console.error(e),this._requests[t]){for(let s=0;s<this._requests[t].length;s++)this._requests[t][s](e);delete this._requests[t]}}open(t,e){const s=this._handlers[t];return s?s.open(null,e):(console.warn(`No resource handler found for: ${t}`),e)}patch(t,e){const s=this._handlers[t.type];s?s.patch&&s.patch(t,e):console.warn(`No resource handler found for: ${t.type}`)}clearCache(t,e){const s=wm.makeKey(t,e);delete this._cache[s]}getFromCache(t,e){const s=wm.makeKey(t,e);if(this._cache[s])return this._cache[s]}enableRetry(t=5){t=Math.max(0,t)||0;for(const e in this._handlers)this._handlers[e].maxRetries=t}disableRetry(){for(const t in this._handlers)this._handlers[t].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class Tm{_validate(t){if(!t.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!t.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==t.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!t.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(t.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(let e=0,s=t.data.length;e<s;e++){const s=t.data[e];if(!s.info)throw new Error(`pc.I18n#addData: missing "data[${e}].info" field`);if(!s.info.locale)throw new Error(`pc.I18n#addData: missing "data[${e}].info.locale" field`);if("string"!=typeof s.info.locale)throw new Error(`pc.I18n#addData: "data[${e}].info.locale" must be a string`);if(!s.messages)throw new Error(`pc.I18n#addData: missing "data[${e}].messages" field`)}}parse(t){return t.data}}class Em extends Ve{static{this.EVENT_CHANGE="change"}constructor(t){super(),this.locale=em,this._translations={},this._availableLangs={},this._app=t,this._assets=[],this._parser=new Tm}set assets(t){const e={};for(let s=0,i=t.length;s<i;s++){e[t[s]instanceof pm?t[s].id:t[s]]=!0}let s=this._assets.length;for(;s--;){const t=this._assets[s];if(!e[t]){this._app.assets.off(`add:${t}`,this._onAssetAdd,this);const e=this._app.assets.get(t);e&&this._onAssetRemove(e),this._assets.splice(s,1)}}for(const t in e){const e=parseInt(t,10);if(-1!==this._assets.indexOf(e))continue;this._assets.push(e);const s=this._app.assets.get(e);s?this._onAssetAdd(s):this._app.assets.once(`add:${e}`,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(t){if(this._locale===t)return;let e=rm(t);if("in"===e&&(e="id",t=function(t,e){const s=t.indexOf("-");return-1!==s?e+t.substring(s):e}(t,e),this._locale===t))return;const s=this._locale;this._locale=t,this._lang=e,this._pluralFn=lm(this._lang),this.fire(Em.EVENT_CHANGE,t,s)}get locale(){return this._locale}static findAvailableLocale(t,e){return am(t,e)}findAvailableLocale(t){if(this._translations[t])return t;const e=rm(t);return this._findFallbackLocale(t,e)}getText(t,e){let s,i=t;e||(e=this._locale,s=this._lang);let n=this._translations[e];return n||(s||(s=rm(e)),e=this._findFallbackLocale(e,s),n=this._translations[e]),n&&n.hasOwnProperty(t)&&(i=n[t],Array.isArray(i)&&(i=i[0]),null==i&&(i=t)),i}getPluralText(t,e,s){let i,n,r=t;s?(i=rm(s),n=lm(i)):(s=this._locale,i=this._lang,n=this._pluralFn);let a=this._translations[s];if(a||(i=rm(s=this._findFallbackLocale(s,i)),n=lm(i),a=this._translations[s]),a&&a[t]&&n){const s=n(e);r=a[t][s],null==r&&(r=t)}return r}addData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],i=s.info.locale,n=s.messages;if(!this._translations[i]){this._translations[i]={};const t=rm(i);this._availableLangs[t]||(this._availableLangs[t]=i)}Object.assign(this._translations[i],n),this.fire("data:add",i,n)}}removeData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],i=s.info.locale,n=this._translations[i];if(!n)continue;const r=s.messages;for(const t in r)delete n[t];0===Object.keys(n).length&&(delete this._translations[i],delete this._availableLangs[rm(i)]),this.fire("data:remove",i,r)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(t,e){let s=sm[t];return s&&this._translations[s]?s:(s=sm[e],s&&this._translations[s]?s:(s=this._availableLangs[e],s&&this._translations[s]?s:em))}_onAssetAdd(t){t.on("load",this._onAssetLoad,this),t.on("change",this._onAssetChange,this),t.on("remove",this._onAssetRemove,this),t.on("unload",this._onAssetUnload,this),t.resource&&this._onAssetLoad(t)}_onAssetLoad(t){this.addData(t.resource)}_onAssetChange(t){t.resource&&this.addData(t.resource)}_onAssetRemove(t){t.off("load",this._onAssetLoad,this),t.off("change",this._onAssetChange,this),t.off("remove",this._onAssetRemove,this),t.off("unload",this._onAssetUnload,this),t.resource&&this.removeData(t.resource),this._app.assets.once(`add:${t.id}`,this._onAssetAdd,this)}_onAssetUnload(t){t.resource&&this.removeData(t.resource)}}class Cm extends Ve{constructor(t){super(),this._scripts={},this._list=[],this._scriptSchemas=new Map,this.app=t}destroy(){this.app=null,this.off()}addSchema(t,e){e&&this._scriptSchemas.set(t,e)}getSchema(t){return this._scriptSchemas.get(t)}add(t){const e=t.__name;return this._scripts.hasOwnProperty(e)?(setTimeout((()=>{if(t.prototype.swap){const s=this._scripts[e],i=this._list.indexOf(s);this._list[i]=t,this._scripts[e]=t,this.fire("swap",e,t),this.fire(`swap:${e}`,t)}else console.warn(`script registry already has '${e}' script, define 'swap' method for new script type to enable code hot swapping`)})),!1):(this._scripts[e]=t,this._list.push(t),this.fire("add",e,t),this.fire(`add:${e}`,t),setTimeout((()=>{if(!this._scripts.hasOwnProperty(e))return;if(!this.app||!this.app.systems||!this.app.systems.script)return;const t=this.app.systems.script._components;let s;const i=[],n=[];for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const n=t.items[t.loopIndex];if(n._scriptsIndex[e]&&n._scriptsIndex[e].awaiting){n._scriptsData&&n._scriptsData[e]&&(s=n._scriptsData[e].attributes);const t=n.create(e,{preloading:!0,ind:n._scriptsIndex[e].ind,attributes:s});t&&i.push(t);for(const t of n.scripts)n.initializeAttributes(t)}}for(let t=0;t<i.length;t++)i[t].enabled&&(i[t]._initialized=!0,n.push(i[t]),i[t].initialize&&i[t].initialize());for(let t=0;t<n.length;t++)n[t].enabled&&!n[t]._postInitialized&&(n[t]._postInitialized=!0,n[t].postInitialize&&n[t].postInitialize())})),!0)}remove(t){let e=t,s=t;if("string"!=typeof s?s=e.__name:e=this.get(s),this.get(s)!==e)return!1;delete this._scripts[s];const i=this._list.indexOf(e);return this._list.splice(i,1),this.fire("remove",s,e),this.fire(`remove:${s}`,e),!0}get(t){return this._scripts[t]||null}has(t){if("string"==typeof t)return this._scripts.hasOwnProperty(t);if(!t)return!1;const e=t.__name;return this._scripts[e]===t}list(){return this._list}}const Am=(t,e)=>t.constructor.order-e.constructor.order,Dm=[],Pm=[],Lm=t=>{t.length=0,Pm.push(t)};class Im extends Mc{static{this.EVENT_DESTROY="destroy"}constructor(t,e=Kp()){super(t),this.c={},this._destroying=!1,this._guid=null,this._template=!1,this._app=e}addComponent(t,e){const s=this._app.systems[t];return s?this.c[t]?null:s.addComponent(this,e):null}removeComponent(t){const e=this._app.systems[t];e&&this.c[t]&&e.removeComponent(this)}findComponent(t){const e=this.findOne((e=>e.c?.[t]));return e&&e.c[t]}findComponents(t){return this.find((e=>e.c?.[t])).map((e=>e.c[t]))}findScript(t){const e=this.findOne((e=>e.c?.script?.has(t)));return e?.c.script.get(t)}findScripts(t){return this.find((e=>e.c?.script?.has(t))).map((e=>e.c.script.get(t)))}getGuid(){return this._guid||this.setGuid(Me.create()),this._guid}setGuid(t){const e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this}_notifyHierarchyStateChanged(t,e){let s=!1;t===this&&0===Dm.length&&(s=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&Dm.push(t);const i=t._children;for(let t=0,s=i.length;t<s;t++)i[t]._enabled&&this._notifyHierarchyStateChanged(i[t],e);if(t._beingEnabled=!1,s){for(let t=0;t<Dm.length;t++)Dm[t]._onHierarchyStatePostChanged();Dm.length=0}}_onHierarchyStateChanged(t){super._onHierarchyStateChanged(t);const e=this._getSortedComponents();for(let s=0;s<e.length;s++){const i=e[s];i.enabled&&(t?i.onEnable():i.onDisable())}Lm(e)}_onHierarchyStatePostChanged(){const t=this._getSortedComponents();for(let e=0;e<t.length;e++)t[e].onPostStateChange();Lm(t)}findByGuid(t){if(this._guid===t)return this;const e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null}destroy(){this._destroying=!0;for(const t in this.c)this.c[t].enabled=!1;for(const t in this.c)this.c[t].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,Rm(this,this,e,t),e}_getSortedComponents(){const t=this.c,e=Pm.pop()??[];let s=0;for(const i in t)if(t.hasOwnProperty(i)){const n=t[i];s|=0!==n.constructor.order,e.push(n)}return s&&e.length>1&&e.sort(Am),e}_cloneRecursively(t){const e=new this.constructor(void 0,this._app);super._cloneInternal(e);for(const t in this.c){this.c[t].system.cloneComponent(this,e)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof Im){const s=i._cloneRecursively(t);e.addChild(s),t[i.getGuid()]=s}}return e}}function Rm(t,e,s,i){if(e instanceof Im){const n=e.c;for(const e in n){const r=n[e],a=r.system.getPropertiesOfType("entity");for(let n=0,o=a.length;n<o;n++){const o=a[n].name,l=r[o];if(!!t.findByGuid(l)){const t=i[l].getGuid();t&&(s.c[e][o]=t)}}}n.script&&s.script.resolveDuplicatedEntityReferenceProperties(n.script,i),n.render&&s.render.resolveDuplicatedEntityReferenceProperties(n.render,i),n.button&&s.button.resolveDuplicatedEntityReferenceProperties(n.button,i),n.scrollview&&s.scrollview.resolveDuplicatedEntityReferenceProperties(n.scrollview,i),n.scrollbar&&s.scrollbar.resolveDuplicatedEntityReferenceProperties(n.scrollbar,i),n.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(n.anim,i);const r=e.children.filter((t=>t instanceof Im)),a=s.children.filter((t=>t instanceof Im));for(let e=0,s=r.length;e<s;e++)Rm(t,r[e],a[e],i)}}class Mm{constructor(t,e){this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=t,this.url=e}get loaded(){return!!this.data}get loading(){return this._loading}}class km{constructor(t){this._list=[],this._index={},this._urlIndex={},this._app=t}destroy(){this._app=null}list(){return this._list}add(t,e){if(this._index.hasOwnProperty(t))return!1;const s=new Mm(t,e),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null}findByUrl(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null}remove(t){if(this._index.hasOwnProperty(t)){const e=this._index[t];let s=this._list[e];delete this._urlIndex[s.url],delete this._index[t],this._list.splice(e,1);for(let t=0;t<this._list.length;t++)s=this._list[t],this._index[s.name]=t,this._urlIndex[s.url]=t}}_loadSceneData(t,e,s){const i=this._app;let n=t;if("string"==typeof t&&(t=this.findByUrl(n)||this.find(n)||new Mm("Untitled",n)),n=t.url,n)if(t.loaded)s(null,t);else{if(i.assets&&i.assets.prefix&&!hm.test(n)&&(n=ke.join(i.assets.prefix,n)),t._onLoadedCallbacks.push(s),!t._loading){i.loader.getHandler("hierarchy").load(n,((s,i)=>{t.data=i,t._loading=!1;for(let e=0;e<t._onLoadedCallbacks.length;e++)t._onLoadedCallbacks[e](s,t);e||(t.data=null),t._onLoadedCallbacks.length=0}))}t._loading=!0}else s("Cannot find scene to load")}loadSceneData(t,e){this._loadSceneData(t,!0,e)}unloadSceneData(t){"string"==typeof t&&(t=this.findByUrl(t)),t&&(t.data=null)}_loadSceneHierarchy(t,e,s){this._loadSceneData(t,!1,((t,i)=>{if(t)return void(s&&s(t));e&&e(i);const n=this._app;n._preloadScripts(i.data,(()=>{const t=n.loader.getHandler("hierarchy");n.systems.script.preloading=!0;const e=t.open(i.url,i.data);n.systems.script.preloading=!1,n.loader.clearCache(i.url,"hierarchy"),n.root.addChild(e),n.systems.fire("initialize",e),n.systems.fire("postInitialize",e),n.systems.fire("postPostInitialize",e),s&&s(null,e)}))}))}loadSceneHierarchy(t,e){this._loadSceneHierarchy(t,null,e)}loadSceneSettings(t,e){this._loadSceneData(t,!1,((t,s)=>{t?e&&e(t):(this._app.applySceneSettings(s.data.settings),e&&e(null))}))}changeScene(t,e){const s=this._app;this._loadSceneHierarchy(t,(t=>{const{children:e}=s.root;for(;e.length;)e[0].destroy();s.applySceneSettings(t.data.settings)}),e)}loadScene(t,e){const s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!hm.test(t)&&(t=ke.join(s.assets.prefix,t)),i.load(t,((n,r)=>{if(n)e&&e(n);else{const n=()=>{s.systems.script.preloading=!0;const n=i.open(t,r),a=this.findByUrl(t);a&&!a.loaded&&(a.data=r),s.systems.script.preloading=!1,s.loader.clearCache(t,"scene"),s.loader.patch({resource:n,type:"scene"},s.assets),s.root.addChild(n.root),s.systems.rigidbody&&"undefined"!=typeof Ammo&&s.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),e&&e(null,n)};s._preloadScripts(r,n)}}))}}class Om{constructor(t){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=t._shaderStats,this.vram=t._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return Kp().scene._stats}get lightmapper(){return Kp().lightmapper?.stats}get batcher(){const t=Kp()._batcher;return t?t._stats:null}}const Fm={alphaTestPS:"\nuniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientPS:'\n#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\tuniform vec3 ambientSH[9];\n#endif\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t#include "envAtlasPS"\n\t#ifndef ENV_ATLAS\n\t#define ENV_ATLAS\n\t\tuniform sampler2D texture_envAtlas;\n\t#endif\n#endif\nvoid addAmbient(vec3 worldNormal) {\n\t#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\t\tvec3 n = cubeMapRotate(worldNormal);\n\t\tvec3 color =\n\t\t\tambientSH[0] +\n\t\t\tambientSH[1] * n.x +\n\t\t\tambientSH[2] * n.y +\n\t\t\tambientSH[3] * n.z +\n\t\t\tambientSH[4] * n.x * n.z +\n\t\t\tambientSH[5] * n.z * n.y +\n\t\t\tambientSH[6] * n.y * n.x +\n\t\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\t\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t\tvec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));\n\t\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\t\tvec4 raw = texture2D(texture_envAtlas, uv);\n\t\tvec3 linear = {ambientDecode}(raw);\n\t\tdDiffuseLight += processEnvironment(linear);\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == CONSTANT\n\t\tdDiffuseLight += light_globalAmbient;\n\t#endif\n}\n',anisotropyPS:"\n#ifdef LIT_GGX_SPECULAR\n\tuniform float material_anisotropyIntensity;\n\tuniform vec2 material_anisotropyRotation;\n#endif\nvoid getAnisotropy() {\n\tdAnisotropy = 0.0;\n\tdAnisotropyRotation = vec2(1.0, 0.0);\n#ifdef LIT_GGX_SPECULAR\n\tdAnisotropy = material_anisotropyIntensity;\n\tdAnisotropyRotation = material_anisotropyRotation;\n#endif\n\t#ifdef STD_ANISOTROPY_TEXTURE\n\tvec3 anisotropyTex = texture2DBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_UV}, textureBias).rgb;\n\tdAnisotropy *= anisotropyTex.b;\n\tvec2 anisotropyRotationFromTex = anisotropyTex.rg * 2.0 - vec2(1.0);\n\tmat2 rotationMatrix = mat2(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);\n\tdAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;\n\t#endif\n\t\n\tdAnisotropy = clamp(dAnisotropy, 0.0, 1.0);\n}\n",aoPS:'\n#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\tuniform float material_aoIntensity;\n#endif\n#ifdef STD_AODETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nvoid getAO() {\n\tdAo = 1.0;\n\t#ifdef STD_AO_TEXTURE\n\t\tfloat aoBase = texture2DBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_UV}, textureBias).{STD_AO_TEXTURE_CHANNEL};\n\t\t#ifdef STD_AODETAIL_TEXTURE\n\t\t\tfloat aoDetail = texture2DBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_UV}, textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};\n\t\t\taoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3(aoBase), vec3(aoDetail)).r;\n\t\t#endif\n\t\tdAo *= aoBase;\n\t#endif\n\t#ifdef STD_AO_VERTEX\n\t\tdAo *= saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});\n\t#endif\n\t#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\t\tdAo = mix(1.0, dAo, material_aoIntensity);\n\t#endif\n}\n',aoDiffuseOccPS:"\nvoid occludeDiffuse(float ao) {\n\tdDiffuseLight *= ao;\n}\n",aoSpecOccPS:"\n#if LIT_OCCLUDE_SPECULAR != NONE\n\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\tuniform float material_occludeSpecularIntensity;\n\t#endif\n#endif\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\t#if LIT_OCCLUDE_SPECULAR == AO\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tfloat specOcc = mix(1.0, ao, material_occludeSpecularIntensity);\n\t\t#else\n\t\t\tfloat specOcc = ao;\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT\n\t\tfloat specPow = exp2(gloss * 11.0);\n\t\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\tdSpecularLight *= specOcc;\n\t\tdReflection *= specOcc;\n\t\t#ifdef LIT_SHEEN\n\t\t\tsSpecularLight *= specOcc;\n\t\t\tsReflection *= specOcc;\n\t\t#endif\n\t#endif\n}\n",bakeDirLmEndPS:"\n\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001 ? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n\tdDiffuseLight = ((dDiffuseLight - 0.5) * max(ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;\n\tdDiffuseLight += vec3(ambientBakeOcclusionBrightness);\n\tdDiffuseLight = saturate(dDiffuseLight);\n\tdDiffuseLight *= dAmbientLight;\n#endif\n#ifdef LIGHTMAP_RGBM\n\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n#else\n\tgl_FragColor = vec4(dDiffuseLight, 1.0);\n#endif\n",basePS:"\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseNineSlicedPS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",bayerPS:"\nfloat bayer2(vec2 p) {\n\treturn mod(2.0 * p.y + p.x + 1.0, 4.0);\n}\nfloat bayer4(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\treturn 4.0 * bayer2(p1) + bayer2(p2);\n}\nfloat bayer8(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\tvec2 p4 = floor(0.25 * mod(p, 8.0));\n\treturn 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\n\tuniform float weight[{SAMPLES}];\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float({SAMPLES}) * 0.5);\n\tfor (int i = 0; i < {SAMPLES}; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef GAUSS\n\t\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\t\tmoments *= 1.0 / float({SAMPLES});\n\t#endif\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n}\n",clearCoatPS:"\nuniform float material_clearCoat;\nvoid getClearCoat() {\n\tccSpecularity = material_clearCoat;\n\t#ifdef STD_CLEARCOAT_TEXTURE\n\tccSpecularity *= texture2DBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_UV}, textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOAT_VERTEX\n\tccSpecularity *= saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});\n\t#endif\n}\n",clearCoatGlossPS:"\nuniform float material_clearCoatGloss;\nvoid getClearCoatGlossiness() {\n\tccGlossiness = material_clearCoatGloss;\n\t#ifdef STD_CLEARCOATGLOSS_TEXTURE\n\tccGlossiness *= texture2DBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_UV}, textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_VERTEX\n\tccGlossiness *= saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_INVERT\n\tccGlossiness = 1.0 - ccGlossiness;\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n\tvec3 normalMap = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(texture2DBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_UV}, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n\tccNormalW = normalize(dTBN * normalMap);\n#else\n\tccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, vec4 cookieChannel) {\n\tvec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);\n\tbool isRgb = dot(cookieChannel.rgb, vec3(1.0)) == 3.0;\n\treturn isRgb ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, vec4 cookieChannel) {\n\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, cookieChannel);\n}\nvec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nvec3 _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\treturn projPos.xyz;\n}\nvec3 getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {\n\tvec3 wPos = vPositionW + normal * shadowParams.y;\n\treturn _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\tfloat distScale = length(lightDir);\n\tvec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - lightPos;\n\treturn dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn textureShadow(shadowMap, vec3(uv, shadowZ));\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n",clusteredLightUtilsPS:"\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\tvec3 vAbs = abs(dir);\n\tfloat ma;\n\tvec2 uv;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\t\ttileOffset.x = 2.0;\n\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\t} else if(vAbs.y >= vAbs.x) {\n\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\t\ttileOffset.x = 1.0;\n\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\t} else {\n\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\t\ttileOffset.x = 0.0;\n\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\t}\n\treturn uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\tfloat faceIndex;\n\tvec2 tileOffset;\n\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\tfloat atlasFaceSize = omniAtlasViewport.z;\n\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\tfloat offset = shadowEdgePixels / tileSize;\n\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\tuv *= atlasFaceSize;\n\tuv += tileOffset * atlasFaceSize;\n\tuv += omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:'\n#include "lightBufferDefinesPS"\n#include "clusteredLightUtilsPS"\n#ifdef CLUSTER_COOKIES\n\t#include "clusteredLightCookiesPS"\n#endif\n#ifdef CLUSTER_SHADOWS\n\t#include "clusteredLightShadowsPS"\n#endif\nuniform highp sampler2D clusterWorldTexture;\nuniform highp sampler2D lightsTexture;\n#ifdef CLUSTER_SHADOWS\n\tuniform sampler2DShadow shadowAtlasTexture;\n#endif\n#ifdef CLUSTER_COOKIES\n\tuniform sampler2D cookieAtlasTexture;\n#endif\nuniform int clusterMaxCells;\nuniform float clusterSkip;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 shadowAtlasParams;\nstruct ClusterLightData {\n\tuint flags;\n\tvec3 halfWidth;\n\tbool isSpot;\n\tvec3 halfHeight;\n\tint lightIndex;\n\tvec3 position;\n\tuint shape;\n\tvec3 direction;\n\tbool falloffModeLinear;\n\tvec3 color;\n\tfloat shadowIntensity;\n\tvec3 omniAtlasViewport;\n\tfloat range;\n\tvec4 cookieChannelMask;\n\tfloat biasesData;\n\tfloat shadowBias;\n\tfloat shadowNormalBias;\n\tfloat anglesData;\n\tfloat innerConeAngleCos;\n\tfloat outerConeAngleCos;\n\tfloat cookieIntensity;\n\tbool isDynamic;\n\tbool isLightmapped;\n};\nmat4 lightProjectionMatrix;\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {\n\treturn texelFetch(lightsTexture, ivec2(index, clusterLightData.lightIndex), 0);\n}\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\tclusterLightData.lightIndex = int(lightIndex);\n\tvec4 halfData = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});\n\tclusterLightData.anglesData = halfData.z;\n\tclusterLightData.biasesData = halfData.w;\n\tvec2 colorRG = unpackHalf2x16(floatBitsToUint(halfData.x));\n\tvec2 colorB_ = unpackHalf2x16(floatBitsToUint(halfData.y));\n\tclusterLightData.color = vec3(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};\n\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_POSITION_RANGE});\n\tclusterLightData.position = lightPosRange.xyz;\n\tclusterLightData.range = lightPosRange.w;\n\tvec4 lightDir_Flags = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_DIRECTION_FLAGS});\n\tclusterLightData.direction = lightDir_Flags.xyz;\n\tclusterLightData.flags = floatBitsToUint(lightDir_Flags.w);\n\tclusterLightData.isSpot = (clusterLightData.flags & (1u << 30u)) != 0u;\n\tclusterLightData.shape = (clusterLightData.flags >> 28u) & 0x3u;\n\tclusterLightData.falloffModeLinear = (clusterLightData.flags & (1u << 27u)) == 0u;\n\tclusterLightData.shadowIntensity = float((clusterLightData.flags >> 0u) & 0xFFu) / 255.0;\n\tclusterLightData.cookieIntensity = float((clusterLightData.flags >> 8u) & 0xFFu) / 255.0;\n\tclusterLightData.isDynamic = (clusterLightData.flags & (1u << 22u)) != 0u;\n\tclusterLightData.isLightmapped = (clusterLightData.flags & (1u << 21u)) != 0u;\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\tvec2 angles = unpackHalf2x16(floatBitsToUint(clusterLightData.anglesData));\n\tclusterLightData.innerConeAngleCos = angles.x;\n\tclusterLightData.outerConeAngleCos = angles.y;\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;\n\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t\n\tvec4 m0 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0});\n\tvec4 m1 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_1});\n\tvec4 m2 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_2});\n\tvec4 m3 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_3});\n\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\t\n\tvec2 biases = unpackHalf2x16(floatBitsToUint(clusterLightData.biasesData));\n\tclusterLightData.shadowBias = biases.x;\n\tclusterLightData.shadowNormalBias = biases.y;\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\tuint cookieFlags = (clusterLightData.flags >> 23u) & 0x0Fu;\n\tclusterLightData.cookieChannelMask = vec4(uvec4(cookieFlags) & uvec4(1u, 2u, 4u, 8u));\n\tclusterLightData.cookieChannelMask = step(1.0, clusterLightData.cookieChannelMask);\n}\nvoid evaluateLight(\n\tClusterLightData light, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir,\n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tvec3 cookieAttenuation = vec3(1.0);\n\tfloat diffuseAttenuation = 1.0;\n\tfloat falloffAttenuation = 1.0;\n\tvec3 lightDirW = evalOmniLight(light.position);\n\tvec3 lightDirNormW = normalize(lightDirW);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tfalloffAttenuation = getFalloffWindow(light.range, lightDirW);\n\t} else\n\t#endif\n\t{\n\t\tif (light.falloffModeLinear)\n\t\t\tfalloffAttenuation = getFalloffLinear(light.range, lightDirW);\n\t\telse\n\t\t\tfalloffAttenuation = getFalloffInvSquared(light.range, lightDirW);\n\t}\n\tif (falloffAttenuation > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\tdiffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\tdiffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else {\n\t\t\t\tdiffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tfalloffAttenuation *= getLightDiffuse(worldNormal, viewDir, lightDirNormW); \n\t\t}\n\t\tif (light.isSpot) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tfalloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n\t\tif (falloffAttenuation > 0.00001) {\n\t\t\tif (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {\n\t\t\t\tif (light.isSpot) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (light.cookieIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tcookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (light.shadowIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tvec3 shadowCoord = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n\t\t\t\t\t\t\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvec3 dir = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\t{\n\t\t\t\tvec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tfloat areaLightSpecular;\n\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n\t\t\t\t}\n\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\tfloat areaLightSpecularCC;\n\t\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);\n\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t}\n\t \n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 halfDir = normalize(-lightDirNormW + viewDir);\n\t\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tdSpecularLight += \n\t\t\t\t\t\tgetLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * \n\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\tdot(viewDir, halfDir), \n\t\t\t\t\t\t\tgloss, \n\t\t\t\t\t\t\tspecularity\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\tiridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t);\n\t\t\t\t#else\n\t\t\t\t\tdSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n\t\t\t\t\t#else\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; \n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n\tdAtten = falloffAttenuation;\n\tdLightDirNormW = lightDirNormW;\n}\nvoid evaluateClusterLight(\n\tfloat lightIndex, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tClusterLightData clusterLightData;\n\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\t#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t\tbool acceptLightMask = clusterLightData.isDynamic;\n\t#else\n\t\tbool acceptLightMask = clusterLightData.isLightmapped;\n\t#endif\n\tif (acceptLightMask)\n\t\tevaluateLight(\n\t\t\tclusterLightData, \n\t\t\tworldNormal, \n\t\t\tviewDir, \n\t\t\treflectionDir, \n#if defined(LIT_CLEARCOAT)\n\t\t\tclearcoatReflectionDir, \n#endif\n\t\t\tgloss, \n\t\t\tspecularity, \n\t\t\tgeometricNormal, \n\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel,\n#endif\n\t\t\tclearcoat_worldNormal,\n\t\t\tclearcoat_gloss,\n\t\t\tsheen_gloss,\n\t\t\tiridescence_intensity\n\t\t);\n}\nvoid addClusteredLights(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tif (clusterSkip > 0.5)\n\t\treturn;\n\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\t\tfor (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {\n\t\t\tfloat lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;\n\t\t\tif (lightIndex <= 0.0)\n\t\t\t\tbreak;\n\t\t\tevaluateClusterLight(\n\t\t\t\tlightIndex * 255.0, \n\t\t\t\tworldNormal, \n\t\t\t\tviewDir, \n\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\tgloss, \n\t\t\t\tspecularity, \n\t\t\t\tgeometricNormal, \n\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\tclearcoat_worldNormal,\n\t\t\t\tclearcoat_gloss,\n\t\t\t\tsheen_gloss,\n\t\t\t\tiridescence_intensity\n\t\t\t); \n\t\t}\n\t}\n}\n',combinePS:"\nvec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {\n\tvec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n\tret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;\n#else\n\tret += albedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n\tret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n\tret += dReflection.rgb * dReflection.a;\n#endif\n#ifdef LIT_SHEEN\n\tfloat sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n\tret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n#endif\n#ifdef LIT_CLEARCOAT\n\tfloat clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;\n\tret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;\n#endif\n\treturn ret;\n}\n",cookieBlit2DPS:"\n\tvarying vec2 uv0;\n\tuniform sampler2D blitTexture;\n\tvoid main(void) {\n\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t}\n",cookieBlitCubePS:"\n\tvarying vec2 uv0;\n\tuniform samplerCube blitTexture;\n\tuniform mat4 invViewProj;\n\tvoid main(void) {\n\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\tvec4 worldPos = invViewProj * projPos;\n\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t}\n",cookieBlitVS:"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t#ifndef WEBGPU\n\t\t\tuv0.y = 1.0 - uv0.y;\n\t\t#endif\n\t}\n",cookiePS:"\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectPS:"\n#if LIT_CUBEMAP_PROJECTION == BOX\n\tuniform vec3 envBoxMin;\n\tuniform vec3 envBoxMax;\n#endif\nvec3 cubeMapProject(vec3 nrdir) {\n\t#if LIT_CUBEMAP_PROJECTION == NONE\n\t\treturn cubeMapRotate(nrdir);\n\t#endif\n\t#if LIT_CUBEMAP_PROJECTION == BOX\n\t\tnrdir = cubeMapRotate(nrdir);\n\t\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\t\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\t\tvec3 rbminmax = mix(rbmin, rbmax, vec3(greaterThan(nrdir, vec3(0.0))));\n\t\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\t\tvec3 posonbox = vPositionW + nrdir * fa;\n\t\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\t\treturn normalize(posonbox - envBoxPos);\n\t#endif\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\ngl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\ngl_FragColor = vec4(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\ngl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\ngl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\ngl_FragColor = vec4(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\ngl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\ngl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\ngl_FragColor = vec4(vec3(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\nlitArgs_albedo = vec3(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\nlitArgs_albedo = vec3(vUv0, 0);\n#else\nlitArgs_albedo = vec3(0);\n#endif\n#endif\n",detailModesPS:"\n#ifndef _DETAILMODES_INCLUDED_\n#define _DETAILMODES_INCLUDED_\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n#endif\n",diffusePS:'\nuniform vec3 material_diffuse;\n#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nvoid getAlbedo() {\n\tdAlbedo = material_diffuse.rgb;\n\t#ifdef STD_DIFFUSE_TEXTURE\n\t\tvec3 albedoTexture = {STD_DIFFUSE_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_UV}, textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t\t\tvec3 albedoDetail = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_UV}, textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};\n\t\t\talbedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);\n\t\t#endif\n\t\tdAlbedo *= albedoTexture;\n\t#endif\n\t#ifdef STD_DIFFUSE_VERTEX\n\t\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));\n\t#endif\n}\n',decodePS:"\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\nvec3 decodeLinear(vec4 raw) {\n\treturn raw.rgb;\n}\nfloat decodeGamma(float raw) {\n\treturn pow(raw, 2.2);\n}\nvec3 decodeGamma(vec3 raw) {\n\treturn pow(raw, vec3(2.2));\n}\nvec3 decodeGamma(vec4 raw) {\n\treturn pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nvec3 decodeRGBP(vec4 raw) {\n\tvec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n\treturn color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n\tif (raw.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t}\n}\nvec4 passThrough(vec4 raw) {\n\treturn raw;\n}\nvec3 unpackNormalXYZ(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackNormalXY(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n\treturn normal;\n}\n#endif\n",emissivePS:"\nuniform vec3 material_emissive;\nuniform float material_emissiveIntensity;\nvoid getEmission() {\n\tdEmission = material_emissive * material_emissiveIntensity;\n\t#ifdef STD_EMISSIVE_TEXTURE\n\tdEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(texture2DBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_UV}, textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_EMISSIVE_VERTEX\n\tdEmission *= gammaCorrectInput(saturate(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));\n\t#endif\n}\n",encodePS:"\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec4 encodeRGBP(vec3 source) {\n\tvec3 gamma = pow(source, vec3(0.5));\n\tfloat maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\tfloat v = 1.0 - ((maxVal - 1.0) / 7.0);\n\tv = ceil(v * 255.0) / 255.0;\n\treturn vec4(gamma / (-v * 7.0 + 8.0), v);\t\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\n",endPS:"\n\tgl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\tgl_FragColor.rgb += litArgs_emission;\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n",envAtlasPS:"\n#ifndef _ENVATLAS_INCLUDED_\n#define _ENVATLAS_INCLUDED_\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapShinyUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n#endif\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n\tuniform float skyboxIntensity;\n#endif\nvec3 processEnvironment(vec3 color) {\n\t#ifdef LIT_SKYBOX_INTENSITY\n\t\treturn color * skyboxIntensity;\n\t#else\n\t\treturn color;\n\t#endif\n}\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square(saturate(1.0 - square(sqrDist * square(invRadius))));\n}\nfloat getFalloffInvSquared(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square(saturate(1.0 - square(sqrDist * square(invRadius))));\n\treturn falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius, vec3 lightDir) {\n\tfloat d = length(lightDir);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatAsUintPS:"\n#ifndef FLOAT_AS_UINT\n#define FLOAT_AS_UINT\nvec4 float2uint(float value) {\n\tuint intBits = floatBitsToUint(value);\n\treturn vec4(\n\t\tfloat((intBits >> 24u) & 0xFFu) / 255.0,\n\t\tfloat((intBits >> 16u) & 0xFFu) / 255.0,\n\t\tfloat((intBits >> 8u) & 0xFFu) / 255.0,\n\t\tfloat(intBits & 0xFFu) / 255.0\n\t);\n}\nfloat uint2float(vec4 value) {\n\tuint intBits = \n\t\t(uint(value.r * 255.0) << 24u) |\n\t\t(uint(value.g * 255.0) << 16u) |\n\t\t(uint(value.b * 255.0) << 8u) |\n\t\tuint(value.a * 255.0);\n\treturn uintBitsToFloat(intBits);\n}\nvec4 float2vec4(float value) {\n\t#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)\n\t\treturn vec4(value, 1.0, 1.0, 1.0);\n\t#else\n\t\treturn float2uint(value);\n\t#endif\n}\n#endif\n",fogPS:"\nfloat dBlendModeFogFactor = 1.0;\n#if (FOG != NONE)\n\tuniform vec3 fog_color;\n\t#if (FOG == LINEAR)\n\t\tuniform float fog_start;\n\t\tuniform float fog_end;\n\t#else\n\t\tuniform float fog_density;\n\t#endif\n#endif\nfloat getFogFactor() {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = 0.0;\n\t#if (FOG == LINEAR)\n\t\tfogFactor = (fog_end - depth) / (fog_end - fog_start);\n\t#elif (FOG == EXP)\n\t\tfogFactor = exp(-depth * fog_density);\n\t#elif (FOG == EXP2)\n\t\tfogFactor = exp(-depth * depth * fog_density * fog_density);\n\t#endif\n\treturn clamp(fogFactor, 0.0, 1.0);\n}\nvec3 addFog(vec3 color) {\n\t#if (FOG != NONE)\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, getFogFactor());\n\t#endif\n\treturn color;\n}\n",fresnelSchlickPS:"\nvec3 getFresnel(\n\t\tfloat cosTheta, \n\t\tfloat gloss, \n\t\tvec3 specularity\n#if defined(LIT_IRIDESCENCE)\n\t\t, vec3 iridescenceFresnel, \n\t\tfloat iridescenceIntensity\n#endif\n\t) {\n\tfloat fresnel = pow(1.0 - saturate(cosTheta), 5.0);\n\tfloat glossSq = gloss * gloss;\n\tvec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;\n#if defined(LIT_IRIDESCENCE)\n\treturn mix(ret, iridescenceFresnel, iridescenceIntensity);\n#else\n\treturn ret;\n#endif\t\n}\nfloat getFresnelCC(float cosTheta) {\n\tfloat fresnel = pow(1.0 - saturate(cosTheta), 5.0);\n\treturn 0.04 + (1.0 - 0.04) * fresnel;\n}\n",frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:"\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy * 0.5 + 0.5;\n}\n",gammaPS:'\n#include "decodePS"\n#if (GAMMA == SRGB)\n\tfloat gammaCorrectInput(float color) {\n\t\treturn decodeGamma(color);\n\t}\n\tvec3 gammaCorrectInput(vec3 color) {\n\t\treturn decodeGamma(color);\n\t}\n\tvec4 gammaCorrectInput(vec4 color) {\n\t\treturn vec4(decodeGamma(color.xyz), color.w);\n\t}\n\tvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn pow(color + 0.0000001, vec3(1.0 / 2.2));\n\t}\n#else\n\tfloat gammaCorrectInput(float color) {\n\t\treturn color;\n\t}\n\tvec3 gammaCorrectInput(vec3 color) {\n\t\treturn color;\n\t}\n\tvec4 gammaCorrectInput(vec4 color) {\n\t\treturn color;\n\t}\n\tvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn color;\n\t}\n#endif\n',gles3PS:xa,gles3VS:wa,glossPS:"\n#ifdef STD_GLOSS_CONSTANT\nuniform float material_gloss;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef STD_GLOSS_CONSTANT\n\tdGlossiness *= material_gloss;\n\t#endif\n\t#ifdef STD_GLOSS_TEXTURE\n\tdGlossiness *= texture2DBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_UV}, textureBias).{STD_GLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_GLOSS_VERTEX\n\tdGlossiness *= saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_GLOSS_INVERT\n\tdGlossiness = 1.0 - dGlossiness;\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",gsplatCenterVS:"\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\nbool initCenter(vec3 modelCenter, out SplatCenter center) {\n\tmat4 modelView = matrix_view * matrix_model;\n\tvec4 centerView = modelView * vec4(modelCenter, 1.0);\n\tif (centerView.z > 0.0) {\n\t\treturn false;\n\t}\n\tvec4 centerProj = matrix_projection * centerView;\n\t#if WEBGPU\n\t\tcenterProj.z = clamp(centerProj.z, 0, abs(centerProj.w));\n\t#else\n\t\tcenterProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));\n\t#endif\n\tcenter.view = centerView.xyz / centerView.w;\n\tcenter.proj = centerProj;\n\tcenter.projMat00 = matrix_projection[0][0];\n\tcenter.modelView = modelView;\n\treturn true;\n}\n",gsplatCornerVS:"\nuniform vec2 viewport;\nuniform vec4 camera_params;\nbool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {\n\tvec3 covA, covB;\n\treadCovariance(source, covA, covB);\n\tmat3 Vrk = mat3(\n\t\tcovA.x, covA.y, covA.z, \n\t\tcovA.y, covB.x, covB.y,\n\t\tcovA.z, covB.y, covB.z\n\t);\n\tfloat focal = viewport.x * center.projMat00;\n\tvec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;\n\tfloat J1 = focal / v.z;\n\tvec2 J2 = -J1 / v.z * v.xy;\n\tmat3 J = mat3(\n\t\tJ1, 0.0, J2.x, \n\t\t0.0, J1, J2.y, \n\t\t0.0, 0.0, 0.0\n\t);\n\tmat3 W = transpose(mat3(center.modelView));\n\tmat3 T = W * J;\n\tmat3 cov = transpose(T) * Vrk * T;\n\t#if GSPLAT_AA\n\t\tfloat detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[0][1];\n\t\tfloat detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[0][1];\n\t\tcorner.aaFactor = sqrt(max(detOrig / detBlur, 0.0));\n\t#endif\n\tfloat diagonal1 = cov[0][0] + 0.3;\n\tfloat offDiagonal = cov[0][1];\n\tfloat diagonal2 = cov[1][1] + 0.3;\n\tfloat mid = 0.5 * (diagonal1 + diagonal2);\n\tfloat radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n\tfloat lambda1 = mid + radius;\n\tfloat lambda2 = max(mid - radius, 0.1);\n\tfloat vmin = min(1024.0, min(viewport.x, viewport.y));\n\tfloat l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);\n\tfloat l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);\n\tif (l1 < 2.0 && l2 < 2.0) {\n\t\treturn false;\n\t}\n\tvec2 c = center.proj.ww / viewport;\n\tif (any(greaterThan(abs(center.proj.xy) - vec2(max(l1, l2)) * c, center.proj.ww))) {\n\t\treturn false;\n\t}\n\tvec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n\tvec2 v1 = l1 * diagonalVector;\n\tvec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);\n\tcorner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;\n\tcorner.uv = source.cornerUV;\n\treturn true;\n}\n",gsplatColorVS:"\nuniform mediump sampler2D splatColor;\nvec4 readColor(in SplatSource source) {\n\treturn texelFetch(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\nstruct SplatSource {\n\tuint order;\n\tuint id;\n\tivec2 uv;\n\tvec2 cornerUV;\n};\nstruct SplatCenter {\n\tvec3 view;\n\tvec4 proj;\n\tmat4 modelView;\n\tfloat projMat00;\n};\nstruct SplatCorner {\n\tvec2 offset;\n\tvec2 uv;\n\t#if GSPLAT_AA\n\t\tfloat aaFactor;\n\t#endif\n\tvec2 v;\n\tfloat dlen;\n};\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#if GSPLAT_COMPRESSED_DATA == true\n\t#include "gsplatCompressedDataVS"\n\t#if SH_COEFFS > 0\n\t\t#include "gsplatCompressedSHVS"\n\t#endif\n#elif GSPLAT_SOGS_DATA == true\n\t#include "gsplatSogsDataVS"\n\t#include "gsplatSogsColorVS"\n\t#if SH_COEFFS > 0\n\t\t#include "gsplatSogsSHVS"\n\t#endif\n#else\n\t#include "gsplatDataVS"\n\t#include "gsplatColorVS"\n\t#if SH_COEFFS > 0\n\t\t#include "gsplatSHVS"\n\t#endif\n#endif\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nvoid clipCorner(inout SplatCorner corner, float alpha) {\n\tfloat clip = min(1.0, sqrt(-log(1.0 / 255.0 / alpha)) / 2.0);\n\tcorner.offset *= clip;\n\tcorner.uv *= clip;\n}\n',gsplatCompressedDataVS:"\nuniform highp usampler2D packedTexture;\nuniform highp sampler2D chunkTexture;\nvec4 chunkDataA;\nvec4 chunkDataB;\nvec4 chunkDataC;\nvec4 chunkDataD;\nvec4 chunkDataE;\nuvec4 packedData;\nvec3 unpack111011(uint bits) {\n\treturn vec3(\n\t\tfloat(bits >> 21u) / 2047.0,\n\t\tfloat((bits >> 11u) & 0x3ffu) / 1023.0,\n\t\tfloat(bits & 0x7ffu) / 2047.0\n\t);\n}\nvec4 unpack8888(uint bits) {\n\treturn vec4(\n\t\tfloat(bits >> 24u) / 255.0,\n\t\tfloat((bits >> 16u) & 0xffu) / 255.0,\n\t\tfloat((bits >> 8u) & 0xffu) / 255.0,\n\t\tfloat(bits & 0xffu) / 255.0\n\t);\n}\nconst float norm = 1.0 / (sqrt(2.0) * 0.5);\nvec4 unpackRotation(uint bits) {\n\tfloat a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat m = sqrt(1.0 - (a * a + b * b + c * c));\n\tuint mode = bits >> 30u;\n\tif (mode == 0u) return vec4(m, a, b, c);\n\tif (mode == 1u) return vec4(a, m, b, c);\n\tif (mode == 2u) return vec4(a, b, m, c);\n\treturn vec4(a, b, c, m);\n}\nvec3 readCenter(SplatSource source) {\n\tuint w = uint(textureSize(chunkTexture, 0).x) / 5u;\n\tuint chunkId = source.id / 256u;\n\tivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);\n\tchunkDataA = texelFetch(chunkTexture, chunkUV, 0);\n\tchunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);\n\tchunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);\n\tchunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);\n\tchunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);\n\tpackedData = texelFetch(packedTexture, source.uv, 0);\n\treturn mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nvec4 readColor(in SplatSource source) {\n\tvec4 r = unpack8888(packedData.w);\n\treturn vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nvec4 getRotation() {\n\treturn unpackRotation(packedData.y);\n}\nvec3 getScale() {\n\treturn exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tmat3 rot = quatToMat3(getRotation());\n\tvec3 scale = getScale();\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nuniform highp usampler2D shTexture0;\nuniform highp usampler2D shTexture1;\nuniform highp usampler2D shTexture2;\nvec4 unpack8888s(in uint bits) {\n\treturn vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;\n}\nvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\tuvec4 shData0 = texelFetch(shTexture0, source.uv, 0);\n\tuvec4 shData1 = texelFetch(shTexture1, source.uv, 0);\n\tuvec4 shData2 = texelFetch(shTexture2, source.uv, 0);\n\tvec4 r0 = unpack8888s(shData0.x);\n\tvec4 r1 = unpack8888s(shData0.y);\n\tvec4 r2 = unpack8888s(shData0.z);\n\tvec4 r3 = unpack8888s(shData0.w);\n\tvec4 g0 = unpack8888s(shData1.x);\n\tvec4 g1 = unpack8888s(shData1.y);\n\tvec4 g2 = unpack8888s(shData1.z);\n\tvec4 g3 = unpack8888s(shData1.w);\n\tvec4 b0 = unpack8888s(shData2.x);\n\tvec4 b1 = unpack8888s(shData2.y);\n\tvec4 b2 = unpack8888s(shData2.z);\n\tvec4 b3 = unpack8888s(shData2.w);\n\tsh[0] =  vec3(r0.x, g0.x, b0.x);\n\tsh[1] =  vec3(r0.y, g0.y, b0.y);\n\tsh[2] =  vec3(r0.z, g0.z, b0.z);\n\tsh[3] =  vec3(r0.w, g0.w, b0.w);\n\tsh[4] =  vec3(r1.x, g1.x, b1.x);\n\tsh[5] =  vec3(r1.y, g1.y, b1.y);\n\tsh[6] =  vec3(r1.z, g1.z, b1.z);\n\tsh[7] =  vec3(r1.w, g1.w, b1.w);\n\tsh[8] =  vec3(r2.x, g2.x, b2.x);\n\tsh[9] =  vec3(r2.y, g2.y, b2.y);\n\tsh[10] = vec3(r2.z, g2.z, b2.z);\n\tsh[11] = vec3(r2.w, g2.w, b2.w);\n\tsh[12] = vec3(r3.x, g3.x, b3.x);\n\tsh[13] = vec3(r3.y, g3.y, b3.y);\n\tsh[14] = vec3(r3.z, g3.z, b3.z);\n\tscale = 1.0;\n}\n#endif\n",gsplatEvalSHVS:"\n\t#if SH_BANDS == 1\n\t\t#define SH_COEFFS 3\n\t#elif SH_BANDS == 2\n\t\t#define SH_COEFFS 8\n\t#elif SH_BANDS == 3\n\t\t#define SH_COEFFS 15\n\t#else\n\t\t#define SH_COEFFS 0\n\t#endif\n\t#if SH_BANDS > 0\n\tconst float SH_C1 = 0.4886025119029199f;\n\t#if SH_BANDS > 1\n\t\tconst float SH_C2_0 = 1.0925484305920792f;\n\t\tconst float SH_C2_1 = -1.0925484305920792f;\n\t\tconst float SH_C2_2 = 0.31539156525252005f;\n\t\tconst float SH_C2_3 = -1.0925484305920792f;\n\t\tconst float SH_C2_4 = 0.5462742152960396f;\n\t#endif\n\t#if SH_BANDS > 2\n\t\tconst float SH_C3_0 = -0.5900435899266435f;\n\t\tconst float SH_C3_1 = 2.890611442640554f;\n\t\tconst float SH_C3_2 = -0.4570457994644658f;\n\t\tconst float SH_C3_3 = 0.3731763325901154f;\n\t\tconst float SH_C3_4 = -0.4570457994644658f;\n\t\tconst float SH_C3_5 = 1.445305721320277f;\n\t\tconst float SH_C3_6 = -0.5900435899266435f;\n\t#endif\n\tvec3 evalSH(in vec3 sh[SH_COEFFS], in vec3 dir) {\n\t\tfloat x = dir.x;\n\t\tfloat y = dir.y;\n\t\tfloat z = dir.z;\n\t\tvec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n\t\t#if SH_BANDS > 1\n\t\t\tfloat xx = x * x;\n\t\t\tfloat yy = y * y;\n\t\t\tfloat zz = z * z;\n\t\t\tfloat xy = x * y;\n\t\t\tfloat yz = y * z;\n\t\t\tfloat xz = x * z;\n\t\t\tresult +=\n\t\t\t\tsh[3] * (SH_C2_0 * xy) +\n\t\t\t\tsh[4] * (SH_C2_1 * yz) +\n\t\t\t\tsh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n\t\t\t\tsh[6] * (SH_C2_3 * xz) +\n\t\t\t\tsh[7] * (SH_C2_4 * (xx - yy));\n\t\t#endif\n\t\t#if SH_BANDS > 2\n\t\t\tresult +=\n\t\t\t\tsh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n\t\t\t\tsh[9]  * (SH_C3_1 * xy * z) +\n\t\t\t\tsh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n\t\t\t\tsh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n\t\t\t\tsh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n\t\t\t\tsh[13] * (SH_C3_5 * z * (xx - yy)) +\n\t\t\t\tsh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));\n\t\t#endif\n\t\treturn result;\n\t}\n\t#endif\n",gsplatQuatToMat3VS:"\nmat3 quatToMat3(vec4 R) {\n\tvec4 R2 = R + R;\n\tfloat X = R2.x * R.w;\n\tvec4 Y  = R2.y * R;\n\tvec4 Z  = R2.z * R;\n\tfloat W = R2.w * R.w;\n\treturn mat3(\n\t\t1.0 - Z.z - W,\n\t\t\t  Y.z + X,\n\t\t\t  Y.w - Z.x,\n\t\t\t  Y.z - X,\n\t\t1.0 - Y.y - W,\n\t\t\t  Z.w + Y.x,\n\t\t\t  Y.w + Z.x,\n\t\t\t  Z.w - Y.x,\n\t\t1.0 - Y.y - Z.z\n\t);\n}\n",gsplatSogsColorVS:"\nuniform mediump sampler2D sh0;\nuniform vec4 sh0_mins;\nuniform vec4 sh0_maxs;\nfloat SH_C0 = 0.28209479177387814;\nvec4 readColor(in SplatSource source) {\n\tvec4 clr = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0));\n\treturn vec4(vec3(0.5) + clr.xyz * SH_C0, 1.0 / (1.0 + exp(-clr.w)));\n}\n",gsplatSogsDataVS:"\nuniform highp usampler2D packedTexture;\nuniform vec3 means_mins;\nuniform vec3 means_maxs;\nuniform vec3 scales_mins;\nuniform vec3 scales_maxs;\nvec4 unpackU32(uint v) {\n\treturn vec4(\n\t\tfloat((v >> 24u) & 0xFFu) / 255.0,\n\t\tfloat((v >> 16u) & 0xFFu) / 255.0,\n\t\tfloat((v >> 8u) & 0xFFu) / 255.0,\n\t\tfloat(v & 0xFFu) / 255.0\n\t);\n}\nuvec4 packedSample;\nvec3 readCenter(SplatSource source) {\n\tpackedSample = texelFetch(packedTexture, source.uv, 0);\n\tvec3 l = unpackU32(packedSample.x).xyz;\n\tvec3 u = unpackU32(packedSample.y).xyz;\n\tvec3 n = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;\n\tvec3 v = mix(means_mins, means_maxs, n);\n\treturn sign(v) * (exp(abs(v)) - 1.0);\n}\nconst float norm = 2.0 / sqrt(2.0);\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tvec4 qdata = unpackU32(packedSample.z);\n\tvec3 sdata = unpackU32(packedSample.w).xyz;\n\tvec3 abc = (qdata.xyz - 0.5) * norm;\n\tfloat d = sqrt(max(0.0, 1.0 - dot(abc, abc)));\n\tuint mode = uint(qdata.w * 255.0 + 0.5) - 252u;\n\tvec4 quat = (mode == 0u) ? vec4(d, abc) :\n\t\t\t\t((mode == 1u) ? vec4(abc.x, d, abc.yz) :\n\t\t\t\t((mode == 2u) ? vec4(abc.xy, d, abc.z) : vec4(abc, d)));\n\tmat3 rot = quatToMat3(quat);\n\tvec3 scale = exp(mix(scales_mins, scales_maxs, sdata));\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatSogsSHVS:"\nuniform highp sampler2D sh_centroids;\nuniform float shN_mins;\nuniform float shN_maxs;\nvoid readSHData(in SplatSource source, out vec3 sh[SH_COEFFS], out float scale) {\n\tivec2 t = ivec2(packedSample.x & 255u, packedSample.y & 255u);\n\tint n = t.x + t.y * 256;\n\tint u = (n % 64) * SH_COEFFS;\n\tint v = n / 64;\n\tfor (int i = 0; i < SH_COEFFS; i++) {\n\t\tsh[i] = mix(vec3(shN_mins), vec3(shN_maxs), texelFetch(sh_centroids, ivec2(u + i, v), 0).xyz);\n\t}\n\tscale = 1.0;\n}\n",gsplatDataVS:"\nuniform highp usampler2D transformA;\nuniform highp sampler2D transformB;\nuint tAw;\nvec3 readCenter(SplatSource source) {\n\tuvec4 tA = texelFetch(transformA, source.uv, 0);\n\ttAw = tA.w;\n\treturn uintBitsToFloat(tA.xyz);\n}\nvec4 unpackRotation(vec3 packed) {\n\treturn vec4(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tvec4 tB = texelFetch(transformB, source.uv, 0);\n\tmat3 rot = quatToMat3(unpackRotation(vec3(unpackHalf2x16(tAw), tB.w)).wxyz);\n\tvec3 scale = tB.xyz;\n\t\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#include "decodePS"\n#include "gammaPS"\nvec3 prepareOutputFromGamma(vec3 gammaColor) {\n\t#if TONEMAP == NONE\n\t\t#if GAMMA == NONE\n\t\t\treturn decodeGamma(gammaColor);\n\t\t#else\n\t\t\treturn gammaColor;\n\t\t#endif\n\t#else\n\t\treturn gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));\n\t#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n\t#include "bayerPS"\n\t#include "opacityDitherPS"\n\tvarying float id;\n#endif\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\tuniform float alphaClip;\n#endif\n#ifdef PREPASS_PASS\n\tvarying float vLinearDepth;\n\t#include "floatAsUintPS"\n#endif\nconst float  EXP_A\t  = 12102203.0;\nconst int\tEXP_BC_RMS = 1064866808;\nfloat fastExp(float x) {\n\tint i = int(EXP_A * x) + EXP_BC_RMS;\n\treturn intBitsToFloat(i);\n}\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\nvoid main(void) {\n\tmediump float A = dot(gaussianUV, gaussianUV);\n\tif (A > 1.0) {\n\t\tdiscard;\n\t}\n\tmediump float alpha = fastExp(-A * 4.0) * gaussianColor.a;\n\t#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\t\tif (alpha < alphaClip) {\n\t\t\tdiscard;\n\t\t}\n\t#endif\n\t#ifdef PICK_PASS\n\t\tgl_FragColor = getPickOutput();\n\t#elif SHADOW_PASS\n\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t#elif PREPASS_PASS\n\t\tgl_FragColor = float2vec4(vLinearDepth);\n\t#else\n\t\tif (alpha < 1.0 / 255.0) {\n\t\t\tdiscard;\n\t\t}\n\t\t#ifndef DITHER_NONE\n\t\t\topacityDither(alpha, id * 0.013);\n\t\t#endif\n\t\tgl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);\n\t#endif\n}\n',gsplatSHVS:"\n#if SH_BANDS > 0\nvec3 unpack111011s(uint bits) {\n\treturn vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;\n}\nvoid fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {\n\tscale = uintBitsToFloat(t.x);\n\ta = unpack111011s(t.y);\n\tb = unpack111011s(t.z);\n\tc = unpack111011s(t.w);\n}\nvoid fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {\n\ta = unpack111011s(t.x);\n\tb = unpack111011s(t.y);\n\tc = unpack111011s(t.z);\n\td = unpack111011s(t.w);\n}\nvoid fetch(in uint t, out vec3 a) {\n\ta = unpack111011s(t);\n}\n#if SH_BANDS == 1\n\tuniform highp usampler2D splatSH_1to3;\n\tvoid readSHData(in SplatSource source, out vec3 sh[3], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t}\n#elif SH_BANDS == 2\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tvoid readSHData(in SplatSource source, out vec3 sh[8], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);\n\t}\n#else\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tuniform highp usampler2D splatSH_12to15;\n\tvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);\n\t\tfetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);\n\t}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vec3 vertex_position;\nattribute uint vertex_id_attrib;\nuniform uint numSplats;\nuniform highp usampler2D splatOrder;\nbool initSource(out SplatSource source) {\n\tuint w = uint(textureSize(splatOrder, 0).x);\n\tsource.order = vertex_id_attrib + uint(vertex_position.z);\n\tif (source.order >= numSplats) {\n\t\treturn false;\n\t}\n\tivec2 orderUV = ivec2(source.order % w, source.order / w);\n\tsource.id = texelFetch(splatOrder, orderUV, 0).r;\n\tsource.uv = ivec2(source.id % w, source.id / w);\n\tsource.cornerUV = vertex_position.xy;\n\treturn true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\n#ifndef DITHER_NONE\n\tvarying float id;\n#endif\nmediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);\n#ifdef PREPASS_PASS\n\tvarying float vLinearDepth;\n#endif\nvoid main(void) {\n\tSplatSource source;\n\tif (!initSource(source)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tvec3 modelCenter = readCenter(source);\n\tSplatCenter center;\n\tif (!initCenter(modelCenter, center)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tSplatCorner corner;\n\tif (!initCorner(source, center, corner)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tvec4 clr = readColor(source);\n\t#if GSPLAT_AA\n\t\tclr.a *= corner.aaFactor;\n\t#endif\n\t#if SH_BANDS > 0\n\t\tvec3 dir = normalize(center.view * mat3(center.modelView));\n\t\tvec3 sh[SH_COEFFS];\n\t\tfloat scale;\n\t\treadSHData(source, sh, scale);\n\t\tclr.xyz += evalSH(sh, dir) * scale;\n\t#endif\n\tclipCorner(corner, clr.w);\n\tgl_Position = center.proj + vec4(corner.offset, 0, 0);\n\tgaussianUV = corner.uv;\n\tgaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);\n\t#ifndef DITHER_NONE\n\t\tid = float(source.id);\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\tvLinearDepth = -center.view.z;\n\t#endif\n}\n',quadVS:"\n\tattribute vec2 aPosition;\n\tvarying vec2 uv0;\n\tvoid main(void)\n\t{\n\t\tgl_Position = vec4(aPosition, 0.0, 1.0);\n\t\tuv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);\n\t}\n",immediateLinePS:'\n\t\t#include "gammaPS"\n\t\tvarying vec4 color;\n\t\tvoid main(void) {\n\t\t\tgl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);\n\t\t}\n',immediateLineVS:"\n\tattribute vec4 vertex_position;\n\tattribute vec4 vertex_color;\n\tuniform mat4 matrix_model;\n\tuniform mat4 matrix_viewProjection;\n\tvarying vec4 color;\n\tvoid main(void) {\n\t\tcolor = vertex_color;\n\t\tgl_Position = matrix_viewProjection * matrix_model * vertex_position;\n\t}\n",iridescenceDiffractionPS:"\nuniform float material_iridescenceRefractionIndex;\nfloat iridescence_iorToFresnel(float transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nvec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));\n}\nvec3 iridescence_fresnelToIor(vec3 f0) {\n\tvec3 sqrtF0 = sqrt(f0);\n\treturn (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);\n}\nvec3 iridescence_sensitivity(float opd, vec3 shift) {\n\tfloat PI = 3.141592653589793;\n\tfloat phase = 2.0 * PI * opd * 1.0e-9;\n\tconst vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n\tconst vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n\tconst vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n\tvec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);\n\txyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n\txyz /= vec3(1.0685e-07);\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t3.2404542, -0.9692660,  0.0556434,\n\t   -1.5371385,  1.8760108, -0.2040259,\n\t   -0.4985314,  0.0415560,  1.0572252\n\t);\n\treturn XYZ_TO_REC709 * xyz;\n}\nfloat iridescence_fresnel(float cosTheta, float f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2;\n\treturn f0 + (1.0 - f0) * x5;\n} \nvec3 iridescence_fresnel(float cosTheta, vec3 f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2; \n\treturn f0 + (vec3(1.0) - f0) * x5;\n}\nvec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {\n\tfloat PI = 3.141592653589793;\n\tfloat iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n\tfloat sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\tif (cosTheta2Sq < 0.0) {\n\t\treturn vec3(1.0);\n\t}\n\tfloat cosTheta2 = sqrt(cosTheta2Sq);\n\tfloat r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);\n\tfloat r12 = iridescence_fresnel(cosTheta, r0);\n\tfloat r21 = r12;\n\tfloat t121 = 1.0 - r12;\n\tfloat phi12 = iridescenceIor < outsideIor ? PI : 0.0;\n\tfloat phi21 = PI - phi12;\n\tvec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));\n\tvec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);\n\tvec3 r23 = iridescence_fresnel(cosTheta2, r1);\n\tvec3 phi23 = vec3(0.0);\n\tif (baseIor[0] < iridescenceIor) phi23[0] = PI;\n\tif (baseIor[1] < iridescenceIor) phi23[1] = PI;\n\tif (baseIor[2] < iridescenceIor) phi23[2] = PI;\n\tfloat opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n\tvec3 phi = vec3(phi21) + phi23; \n\tvec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);\n\tvec3 r123 = sqrt(r123Sq);\n\tvec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);\n\tvec3 c0 = r12 + rs;\n\tvec3 i = c0;\n\tvec3 cm = rs - t121;\n\tfor (int m = 1; m <= 2; m++) {\n\t\tcm *= r123;\n\t\tvec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);\n\t\ti += cm * sm;\n\t}\n\treturn max(i, vec3(0.0));\n}\nvec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {\n\treturn calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef STD_IRIDESCENCE_CONSTANT\nuniform float material_iridescence;\n#endif\nvoid getIridescence() {\n\tfloat iridescence = 1.0;\n\t#ifdef STD_IRIDESCENCE_CONSTANT\n\tiridescence *= material_iridescence;\n\t#endif\n\t#ifdef STD_IRIDESCENCE_TEXTURE\n\tiridescence *= texture2DBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_UV}, textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};\n\t#endif\n\tdIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform float material_iridescenceThicknessMax;\n#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\nuniform float material_iridescenceThicknessMin;\n#endif\nvoid getIridescenceThickness() {\n\t#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n\t\tfloat blend = texture2DBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};\n\t\tfloat iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);\n\t#else\n\t\tfloat iridescenceThickness = material_iridescenceThicknessMax;\n\t#endif\n\tdIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef STD_IOR_CONSTANT\nuniform float material_refractionIndex;\n#endif\nvoid getIor() {\n#ifdef STD_IOR_CONSTANT\n\tdIor = material_refractionIndex;\n#else\n\tdIor = 1.0 / 1.5;\n#endif\n}\n",lightDeclarationPS:"\n#if defined(LIGHT{i})\n\tuniform vec3 light{i}_color;\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tuniform vec3 light{i}_direction;\n\t#else\n\t\t#define LIT_CODE_LIGHTS_POINT\n\t\tuniform vec3 light{i}_position;\n\t\tuniform float light{i}_radius;\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#define LIT_CODE_LIGHTS_SPOT\n\t\t\tuniform vec3 light{i}_direction;\n\t\t\tuniform float light{i}_innerConeAngle;\n\t\t\tuniform float light{i}_outerConeAngle;\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform vec3 light{i}_position;\n\t\t#endif\n\t\tuniform vec3 light{i}_halfWidth;\n\t\tuniform vec3 light{i}_halfHeight;\n\t#else\n\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t#define LIT_CODE_FALLOFF_LINEAR\n\t\t#endif\n\t\t#if LIGHT{i}FALLOFF == INVERSESQUARED\n\t\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}CASTSHADOW)\n\t\tuniform mat4 light{i}_shadowMatrix;\n\t\tuniform float light{i}_shadowIntensity;\n\t\tuniform vec4 light{i}_shadowParams;\n\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\tuniform float light{i}_shadowSearchArea;\n\t\t\tuniform vec4 light{i}_cameraParams;\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t\tuniform vec4 light{i}_softShadowParams;\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform mat4 light{i}_shadowMatrixPalette[4];\n\t\t\tuniform vec4 light{i}_shadowCascadeDistances;\n\t\t\tuniform int light{i}_shadowCascadeCount;\n\t\t\tuniform float light{i}_shadowCascadeBlend;\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t#if defined(LIGHT{i}SHADOW_PCF)\n\t\t\t\tuniform samplerCubeShadow light{i}_shadowMap;\n\t\t\t#else\n\t\t\t\tuniform samplerCube light{i}_shadowMap;\n\t\t\t#endif\n\t\t#else\n\t\t\t#if defined(LIGHT{i}SHADOW_PCF)\n\t\t\t\tuniform sampler2DShadow light{i}_shadowMap;\n\t\t\t#else\n\t\t\t\tuniform sampler2D light{i}_shadowMap;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}COOKIE)\n\t\t#define LIT_CODE_COOKIE\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\tuniform samplerCube light{i}_cookie;\n\t\t\tuniform float light{i}_cookieIntensity;\n\t\t\t#if !defined(LIGHT{i}CASTSHADOW)\n\t\t\t\tuniform mat4 light{i}_shadowMatrix;\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\tuniform sampler2D light{i}_cookie;\n\t\t\tuniform float light{i}_cookieIntensity;\n\t\t\t#if !defined(LIGHT{i}CASTSHADOW)\n\t\t\t\tuniform mat4 light{i}_shadowMatrix;\n\t\t\t#endif\n\t\t\t#if defined(LIGHT{i}COOKIE_TRANSFORM)\n\t\t\t\tuniform vec4 light{i}_cookieMatrix;\n\t\t\t\tuniform vec2 light{i}_cookieOffset;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n#endif\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm) {\n\treturn max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nvec3 evalOmniLight(vec3 lightPosW) {\n\treturn vPositionW - lightPosW;\n}\n",lightEvaluationPS:"\n#if defined(LIGHT{i})\n\tevaluateLight{i}(\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel\n\t\t#endif\n\t);\n#endif\n",lightFunctionLightPS:"\n#if defined(LIGHT{i})\nvoid evaluateLight{i}(\n\t#if defined(LIT_IRIDESCENCE)\n\t\tvec3 iridescenceFresnel\n\t#endif\n) {\n\tvec3 lightColor = light{i}_color;\n\t#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)\n\t\tif (all(equal(lightColor, vec3(0.0)))) {\n\t\t\treturn;\n\t\t}\n\t#endif\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tdLightDirNormW = light{i}_direction;\n\t\tdAtten = 1.0;\n\t#else\n\t\t\n\t\tvec3 lightDirW = evalOmniLight(light{i}_position);\n\t\tdLightDirNormW = normalize(lightDirW);\n\t\t#if defined(LIGHT{i}COOKIE)\n\t\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t\t#ifdef LIGHT{i}COOKIE_FALLOFF\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2DXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2D(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2DClipXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2DClip(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t\tvec3 cookieAttenuation = getCookieCube(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t#endif\n\t\t\tlightColor *= cookieAttenuation;\n\t\t#endif\n\t\t#if LIGHT{i}SHAPE == PUNCTUAL\n\t\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t\tdAtten = getFalloffLinear(light{i}_radius, lightDirW);\n\t\t\t#else\n\t\t\t\tdAtten = getFalloffInvSquared(light{i}_radius, lightDirW);\n\t\t\t#endif\n\t\t#else\n\t\t\tdAtten = getFalloffWindow(light{i}_radius, lightDirW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)\n\t\t\t\tdAtten *= getSpotEffect(light{i}_direction, light{i}_innerConeAngle, light{i}_outerConeAngle, dLightDirNormW);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tif (dAtten < 0.00001) {\n\t\treturn;\n\t}\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\tcalcRectLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\tcalcDiskLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\tcalcSphereLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tfloat attenDiffuse = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);\n\t\t#else\n\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\tfloat attenDiffuse = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\tfloat attenDiffuse = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\tfloat attenDiffuse = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tdAtten *= getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);\n\t#endif\n\t#ifdef LIGHT{i}CASTSHADOW\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tfloat shadow = getShadow{i}(vec3(0.0));\n\t\t#else\n\t\t\tfloat shadow = getShadow{i}(lightDirW);\n\t\t#endif\n\t\tshadow = mix(1.0, shadow, light{i}_shadowIntensity);\n\t\tdAtten *= shadow;\n\t\t#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tdShadowCatcher *= shadow;\n\t\t#endif\t\t\t\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight += ((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres);\n\t\t#else\n\t\t\tdDiffuseLight += (attenDiffuse * dAtten) * lightColor;\n\t\t#endif\t\t\t\t\t\t\n\t#else\n\t\t#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)\n\t\t\tdDiffuseLight += (dAtten * lightColor) * (1.0 - litArgs_specularity);\n\t\t#else\n\t\t\tdDiffuseLight += dAtten * lightColor;\n\t\t#endif\n\t#endif\n\t#ifdef LIGHT{i}AFFECT_SPECULARITY\n\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tdSpecularLight += dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tdSpecularLight += dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tdSpecularLight += dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#else\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE\n\t\t\t\t#define LIGHT{i}FRESNEL\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 halfDirW = normalize(-dLightDirNormW + dViewDirW);\n\t\t\t#endif\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tvec3 lightspecularCC = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\tlightspecularCC *= getFresnelCC(dot(dViewDirW, halfDirW));\n\t\t\t\t#endif\n\t\t\t\tccSpecularLight += lightspecularCC;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 lightSpecular = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tlightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);\n\t\t\t\t\t#else\n\t\t\t\t\t\tlightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\tlightSpecular *= litArgs_specularity;\n\t\t\t\t#endif\n\t\t\t\t\n\t\t\t\tdSpecularLight += lightSpecular;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n}\n#endif\n",lightFunctionShadowPS:"\n#ifdef LIGHT{i}CASTSHADOW\n\tvec3 getShadowSampleCoord{i}(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\t\tvec3 surfacePosition = worldPosition;\n\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\tfloat distScale = length(lightDir);\n\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\tlightDir = surfacePosition - lightPos;\n\t\t\t\treturn lightDir;\n\t\t\t#endif\n\t\t#else\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y;\n\t\t\t\t#endif\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\t\t\tfloat distScale = 1.0;\n\t\t\t\t\t#else\n\t\t\t\t\t\tfloat distScale = abs(dot(vPositionW - lightPos, lightDirNorm));\n\t\t\t\t\t#endif\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\tvec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\tpositionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t\tpositionInShadowSpace.xyz /= positionInShadowSpace.w;\n\t\t\t\t#else\n\t\t\t\t\tpositionInShadowSpace.xy /= positionInShadowSpace.w;\n\t\t\t\t\tpositionInShadowSpace.z = length(lightDir) * shadowParams.w;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef SHADOW_SAMPLE_Z_BIAS\n\t\t\t#endif\n\t\t\tsurfacePosition = positionInShadowSpace.xyz;\n\t\t#endif\n\t\treturn surfacePosition;\n\t}\n\tfloat getShadow{i}(vec3 lightDirW) {\n\t\t#ifdef LIGHT{i}_SHADOW_CASCADES\n\t\t\tint cascadeIndex = getShadowCascadeIndex(light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount);\n\t\t\t#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND\n\t\t\t\tcascadeIndex = ditherShadowCascadeIndex(cascadeIndex, light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount, light{i}_shadowCascadeBlend);\n\t\t\t#endif\n\t\t\tmat4 shadowMatrix = light{i}_shadowMatrixPalette[cascadeIndex];\n\t\t#else\n\t\t\tmat4 shadowMatrix = light{i}_shadowMatrix;\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tvec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, vec3(0.0), lightDirW, dLightDirNormW, dVertexNormalW);\n\t\t#else\n\t\t\tvec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tshadowCoord = fadeShadow(shadowCoord, light{i}_shadowCascadeDistances);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n\t\t\t\t\treturn getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n\t\t\t\t#else\n\t\t\t\t\treturn getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, light{i}_softShadowParams, lightDirW);\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowSpotVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowSpotVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowSpotPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowSpotPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowSpotPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowOmniPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowOmniPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowOmniPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n\t\t\t#endif\n\t\t#endif\n\t}\n#endif\n",lightingPS:'\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#define LIT_CODE_FALLOFF_LINEAR\n\t#define LIT_CODE_FALLOFF_SQUARED\n\t#define LIT_CODE_LIGHTS_POINT\n\t#define LIT_CODE_LIGHTS_SPOT\n#endif\n#ifdef AREA_LIGHTS\n\tuniform highp sampler2D areaLightsLutTex1;\n\tuniform highp sampler2D areaLightsLutTex2;\n#endif\n#ifdef LIT_LIGHTING\n\t#include "lightDiffuseLambertPS"\n\t#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n\t\t#include "ltcPS"\n\t#endif\n#endif\n#ifdef SHADOW_DIRECTIONAL\n\t#include "shadowCascadesPS"\n#endif\n#if defined(SHADOW_KIND_PCF1)\n\t#include "shadowPCF1PS"\n#endif\n#if defined(SHADOW_KIND_PCF3)\n\t#include "shadowPCF3PS"\n#endif\n#if defined(SHADOW_KIND_PCF5)\n\t#include "shadowPCF5PS"\n#endif\n#if defined(SHADOW_KIND_PCSS)\n\t#include "linearizeDepthPS"\n\t#include "shadowPCSSPS"\n\t#include "shadowSoftPS"\n#endif\n#if defined(SHADOW_KIND_VSM)\n\t#include "shadowEVSMPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_LINEAR\n\t#include "falloffLinearPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_SQUARED\n\t#include "falloffInvSquaredPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_POINT\n\t#include "lightDirPointPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_SPOT\n\t#include "spotPS"\n#endif\n#ifdef LIT_CODE_COOKIE\n\t#include "cookiePS"\n#endif\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#include "clusteredLightPS"\n#endif\n#ifdef LIGHT_COUNT > 0\n\t#include "lightFunctionShadowPS, LIGHT_COUNT"\n\t#include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',lightmapAddPS:"\nvoid addLightMap(\n\tvec3 lightmap, \n\tvec3 dir, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 vertexNormal, \n\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel, \n\tfloat iridescenceIntensity\n#endif\n) {\n\t#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)\n\t\tif (dot(dir, dir) < 0.0001) {\n\t\t\t\tdDiffuseLight += lightmap;\n\t\t} else {\n\t\t\tfloat vlight = saturate(dot(dir, -vertexNormal));\n\t\t\tfloat flight = saturate(dot(dir, -worldNormal));\n\t\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\t\tdDiffuseLight += lightmap * nlight * 2.0;\n\t\t\tvec3 halfDir = normalize(-dir + viewDir);\n\t\t\tvec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\tspecularLight *= \n\t\t\t\t\tgetFresnel(dot(viewDir, halfDir), \n\t\t\t\t\tgloss, \n\t\t\t\t\tspecularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\tiridescenceIntensity\n\t\t\t\t#endif\n\t\t\t\t\t);\n\t\t\t#endif\n\t\t\tdSpecularLight += specularLight;\n\t\t}\n\t#else\n\t\tdDiffuseLight += lightmap;\n\t#endif\n}\n",lightmapPS:"\n#ifdef STD_LIGHTMAP_DIR\n\tvec3 dLightmapDir;\n\tuniform sampler2D texture_dirLightMap;\n#endif\nvoid getLightMap() {\n\tdLightmap = vec3(1.0);\n\t#ifdef STD_LIGHT_TEXTURE\n\t\tdLightmap *= {STD_LIGHT_TEXTURE_DECODE}(texture2DBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_UV}, textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};\n\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\tvec3 dir = texture2DBias(texture_dirLightMap, {STD_LIGHT_TEXTURE_UV}, textureBias).xyz * 2.0 - 1.0;\n\t\t\tfloat dirDot = dot(dir, dir);\n\t\t\tdLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n\t\t#endif\n\t#endif\n\t#ifdef STD_LIGHT_VERTEX\n\t\tdLightmap *= saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});\n\t#endif\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\tfloat alphaRoughness = roughness * roughness;\n\tfloat anisotropy = dAnisotropy;\n\tvec2 direction = dAnisotropyRotation;\n\tfloat at = mix(alphaRoughness, 1.0, anisotropy * anisotropy);\n\tfloat ab = clamp(alphaRoughness, 0.001, 1.0);\n\tvec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));\n\tvec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));\n\tfloat NoH = dot(worldNormal, h);\n\tfloat ToH = dot(anisotropicT, h);\n\tfloat BoH = dot(anisotropicB, h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(anisotropicT, viewDir);\n\tfloat BoV = dot(anisotropicB, viewDir);\n\tfloat ToL = dot(anisotropicT, -lightDirNorm);\n\tfloat BoL = dot(anisotropicB, -lightDirNorm);\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat NoL = dot(worldNormal, -lightDirNorm);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {\n\tfloat nh = max( dot( h, worldNormal ), 0.0 );\n\tfloat specPow = exp2(gloss * 11.0);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n\tconst float PI = 3.141592653589793;\n\tfloat invR = 1.0 / (roughness * roughness);\n\tfloat cos2h = max(dot(normal, h), 0.0);\n\tcos2h *= cos2h;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\n\treturn (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfloat sheenV(vec3 normal, vec3 viewDir, vec3 light) {\n\tfloat NoV = max(dot(normal, viewDir), 0.000001);\n\tfloat NoL = max(dot(normal, light), 0.000001);\n\treturn 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfloat getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {\n\tfloat D = sheenD(worldNormal, h, sheenGloss);\n\tfloat V = sheenV(worldNormal, viewDir, -lightDirNorm);\n\treturn D * V;\n}\n",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfloat linearizeDepthWithParams(float z, vec4 cameraParams) {\n\tif (cameraParams.w == 0.0)\n\t\treturn (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n\telse\n\t\treturn cameraParams.z + z * (cameraParams.y - cameraParams.z);\n}\n#ifndef CAMERAPLANES\n\t#define CAMERAPLANES\n\tuniform vec4 camera_params;\n#endif\nfloat linearizeDepth(float z) {\n\treturn linearizeDepthWithParams(z, camera_params);\n}\n#endif\n",litForwardBackendPS:'\nvoid evaluateBackend() {\n\t#ifdef LIT_SSAO\n\t\tlitArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tgetReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t#ifdef LIT_METALNESS\n\t\t\tfloat f0 = 1.0 / litArgs_ior;\n\t\t\tf0 = (f0 - 1.0) / (f0 + 1.0);\n\t\t\tf0 *= f0;\n\t\t\tlitArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n\t\t\tlitArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tvec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_ADD_AMBIENT\n\t\taddAmbient(litArgs_worldNormal);\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n\t\t#endif\n\t\t#ifdef LIT_SEPARATE_AMBIENT\n\t\t\tvec3 dAmbientLight = dDiffuseLight;\n\t\t\tdDiffuseLight = vec3(0);\n\t\t#endif\n\t#endif\n\t#ifndef LIT_OLD_AMBIENT\n\t\tdDiffuseLight *= material_ambient;\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifndef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_LIGHTMAP\n\t\taddLightMap(\n\t\t\tlitArgs_lightmap, \n\t\t\tlitArgs_lightmapDir, \n\t\t\tlitArgs_worldNormal, \n\t\t\tdViewDirW, \n\t\t\tdReflDirW, \n\t\t\tlitArgs_gloss, \n\t\t\tlitArgs_specularity, \n\t\t\tdVertexNormalW,\n\t\t\tdTBN\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tlitArgs_iridescence_intensity\n\t\t#endif\n\t\t);\n\t#endif\n\t#ifdef LIT_LIGHTING || LIT_REFLECTIONS\n\t\t#ifdef LIT_REFLECTIONS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\taddReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t\t\t\tccReflection *= ccFresnel;\n\t\t\t\t#else\n\t\t\t\t\tccFresnel = 0.0;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tccReflection *= litArgs_specularityFactor;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\taddReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n\t\t\t#endif\n\t\t\taddReflection(dReflDirW, litArgs_gloss);\n\t\t\t#ifdef LIT_FRESNEL_MODEL\n\t\t\t\tdReflection.rgb *= getFresnel(\n\t\t\t\t\tdot(dViewDirW, litArgs_worldNormal), \n\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\tlitArgs_specularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t#endif\n\t\t\t\t\t);\n\t\t\t#else\n\t\t\t\tdReflection.rgb *= litArgs_specularity;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tdReflection.rgb *= litArgs_specularityFactor;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\tdSpecularLight *= litArgs_specularity;\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tcalcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n\t\t\t#endif\n\t\t#endif\n\t\t\n\t\t#ifdef LIGHT_COUNT > 0\n\t\t\t#include "lightEvaluationPS, LIGHT_COUNT"\n\t\t#endif\n\t\t#ifdef LIT_CLUSTERED_LIGHTS\n\t\t\taddClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n\t\t\t\t#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\tccReflDirW,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tiridescenceFresnel,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n\t\t\t);\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tlitArgs_clearcoat_specularity = 1.0;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tlitArgs_specularity = vec3(1);\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\taddRefraction(\n\t\t\t\tlitArgs_worldNormal, \n\t\t\t\tdViewDirW, \n\t\t\t\tlitArgs_thickness, \n\t\t\t\tlitArgs_gloss, \n\t\t\t\tlitArgs_specularity, \n\t\t\t\tlitArgs_albedo, \n\t\t\t\tlitArgs_transmission,\n\t\t\t\tlitArgs_ior,\n\t\t\t\tlitArgs_dispersion\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t#endif\n\t\t\t);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifdef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\t\toccludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULARITY_FACTOR\n\t\tdSpecularLight *= litArgs_specularityFactor;\n\t#endif\n\t#if !defined(LIT_OPACITY_FADES_SPECULAR)\n\t\t#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n\t\t\tfloat specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tspecLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#endif\n\t\t\tlitArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n\t\t#endif\n\t\tlitArgs_opacity *= material_alphaFade;\n\t#endif\n\t#ifdef LIT_LIGHTMAP_BAKING\n\t\t#ifdef LIT_LIGHTMAP_BAKING_COLOR\n\t\t\t#include "bakeLmEndPS"\n\t\t#endif\n\t\t#ifdef LIT_LIGHTMAP_BAKING_DIR\n\t\t\t#include "bakeDirLmEndPS"\n\t\t#endif\n\t#else\n\t\t#include "endPS"\n\t\t#include "outputAlphaPS"\n\t#endif\n\t#ifdef LIT_MSDF\n\t\tgl_FragColor = applyMsdf(gl_FragColor);\n\t#endif\n\t#include "outputPS"\n\t#include "debugOutputPS"\n\t#ifdef LIT_SHADOW_CATCHER\n\t\tgl_FragColor.rgb = vec3(dShadowCatcher);\n\t#endif\n}\n',litForwardDeclarationPS:'\nvec3 sReflection;\nvec3 dVertexNormalW;\nvec3 dTangentW;\nvec3 dBinormalW;\nvec3 dViewDirW;\nvec3 dReflDirW;\nvec3 ccReflDirW;\nvec3 dLightDirNormW;\nfloat dAtten;\nmat3 dTBN;\nvec4 dReflection;\nvec3 dDiffuseLight;\nvec3 dSpecularLight;\nfloat ccFresnel;\nvec3 ccReflection;\nvec3 ccSpecularLight;\nfloat ccSpecularityNoFres;\nvec3 sSpecularLight;\n#ifdef LIT_DISPERSION\n\tuniform float material_dispersion;\n#endif\n#ifndef LIT_OPACITY_FADES_SPECULAR\n\tuniform float material_alphaFade;\n#endif\n#ifdef LIT_SSAO\n\tuniform sampler2D ssaoTexture;\n\tuniform vec2 ssaoTextureSizeInv;\n#endif\n#ifdef LIT_SHADOW_CATCHER\n\tfloat dShadowCatcher = 1.0;\n#endif\n#if LIGHT_COUNT > 0\n\t#include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n#ifdef LIT_SPECULAR\n\t#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n\t\t#define LIT_OLD_AMBIENT\n\t#endif\n#endif\n#ifdef STD_LIGHTMAP_DIR\n\tuniform float bakeDir;\n#endif\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n\tuniform float ambientBakeOcclusionContrast;\n\tuniform float ambientBakeOcclusionBrightness;\n#endif\n',litForwardMainPS:'\nvoid main(void) {\n\t#include "litUserMainStartPS"\n\tdReflection = vec4(0);\n\t#ifdef LIT_CLEARCOAT\n\t\tccSpecularLight = vec3(0);\n\t\tccReflection = vec3(0);\n\t#endif\n\t#if LIT_NONE_SLICE_MODE == SLICED\n\t\t#include "startNineSlicedPS"\n\t#elif LIT_NONE_SLICE_MODE == TILED\n\t\t#include "startNineSlicedTiledPS"\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\tdVertexNormalW = normalize(vNormalW);\n\t\t#ifdef LIT_TANGENTS\n\t\t\t#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)\n\t\t\t\tdTangentW = vTangentW;\n\t\t\t\tdBinormalW = vBinormalW;\n\t\t\t#endif\n\t\t#endif\n\t\tgetViewDir();\n\t\t#ifdef LIT_TBN\n\t\t\tgetTBN(dTangentW, dBinormalW, dVertexNormalW);\n\t\t\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t\t\thandleTwoSidedLighting();\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tevaluateFrontend();\n\t#include "debugProcessFrontendPS"\n\tevaluateBackend();\n\t#include "litUserMainEndPS"\n}\n',litForwardPostCodePS:'\n#ifdef LIT_NEEDS_NORMAL\n\t#include "cubeMapRotatePS"\n\t#include "cubeMapProjectPS"\n\t#include "envProcPS"\n#endif\n#ifdef LIT_SPECULAR_OR_REFLECTION\n\t#ifdef LIT_METALNESS\n\t\t#include "metalnessModulatePS"\n\t#endif\n\t#if LIT_FRESNEL_MODEL == SCHLICK\n\t\t#include "fresnelSchlickPS"\n\t#endif\n\t#ifdef LIT_IRIDESCENCE\n\t\t#include "iridescenceDiffractionPS"\n\t#endif\n#endif\n#ifdef LIT_AO\n\t#include "aoDiffuseOccPS"\n\t#include "aoSpecOccPS"\n#endif\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n\t#include "envAtlasPS"\n\t#include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n\t#include "envAtlasPS"\n\t#include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n\t#include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n\t#include "reflectionSpherePS"\n#endif\n#ifdef LIT_REFLECTIONS\n\t#ifdef LIT_CLEARCOAT\n\t\t#include "reflectionCCPS"\n\t#endif\n\t#ifdef LIT_SHEEN\n\t\t#include "reflectionSheenPS"\n\t#endif\n#endif\n#ifdef LIT_REFRACTION\n\t#if defined(LIT_DYNAMIC_REFRACTION)\n\t\t#include "refractionDynamicPS"\n\t#elif defined(LIT_REFLECTIONS)\n\t\t#include "refractionCubePS"\n\t#endif\n#endif\n#ifdef LIT_SHEEN\n\t#include "lightSheenPS"\n#endif\nuniform vec3 material_ambient;\n#ifdef LIT_SPECULAR\n\t#ifdef LIT_LIGHTING\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "lightSpecularAnisoGGXPS"\n\t\t#else\n\t\t\t#include "lightSpecularBlinnPS"\n\t\t#endif\n\t#endif\n#endif\n#include "combinePS"\n#ifdef LIT_LIGHTMAP\n\t#include "lightmapAddPS"\n#endif\n#ifdef LIT_ADD_AMBIENT\n\t#include "ambientPS"\n#endif\n#ifdef LIT_MSDF\n\t#include "msdfPS"\n#endif\n#ifdef LIT_NEEDS_NORMAL\n\t#include "viewDirPS"\n\t#ifdef LIT_SPECULAR\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "reflDirAnisoPS"\n\t\t#else\n\t\t\t#include "reflDirPS"\n\t\t#endif\n\t#endif\n#endif\n#include "lightingPS"\n',litForwardPreCodePS:'\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n#if LIT_NONE_SLICE_MODE == SLICED\n\t#include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n\t#include "baseNineSlicedTiledPS"\n#endif\n#ifdef LIT_TBN\n\t#include "TBNPS"\n\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t#include "twoSidedLightingPS"\n\t#endif\n#endif\n',litMainPS:'\n#include "varyingsPS"\n#include "litUserDeclarationPS"\n#include "frontendDeclPS"\n#if defined(PICK_PASS) || defined(PREPASS_PASS)\n\t#include "frontendCodePS"\n\t#include "litUserCodePS"\n\t#include "litOtherMainPS"\n#elif defined(SHADOW_PASS)\n\t#include "frontendCodePS"\n\t#include "litUserCodePS"\n\t#include "litShadowMainPS"\n#else\n\t#include "litForwardDeclarationPS"\n\t#include "litForwardPreCodePS"\n\t#include "frontendCodePS"\n\t#include "litForwardPostCodePS"\n\t#include "litForwardBackendPS"\n\t#include "litUserCodePS"\n\t#include "litForwardMainPS"\n#endif\n',litMainVS:'\n#include "varyingsVS"\n#include  "litUserDeclarationVS"\n#ifdef VERTEX_COLOR\n\tattribute vec4 vertex_color;\n#endif\n#ifdef NINESLICED\n\tvarying vec2 vMask;\n\tvarying vec2 vTiledUv;\n\tuniform mediump vec4 innerOffset;\n\tuniform mediump vec2 outerScale;\n\tuniform mediump vec4 atlasRect;\n#endif\nvec3 dPositionW;\nmat4 dModelMatrix;\n#include "transformCoreVS"\n#ifdef UV0\n\tattribute vec2 vertex_texCoord0;\n\t#include "uv0VS"\n#endif\n#ifdef UV1\n\tattribute vec2 vertex_texCoord1;\n\t#include "uv1VS"\n#endif\n#ifdef LINEAR_DEPTH\n\t#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\t\tuniform mat4 matrix_view;\n\t#endif\n#endif\n#include "transformVS"\n#ifdef NORMALS\n\t#include "normalCoreVS"\n\t#include "normalVS"\n#endif\n#ifdef TANGENTS\n\tattribute vec4 vertex_tangent;\n#endif\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n#ifdef MSDF\n\t#include "msdfVS"\n#endif\n#include  "litUserCodeVS"\nvoid main(void) {\n\t#include "litUserMainStartVS"\n\tgl_PointSize = 1.0;\n\tgl_Position = getPosition();\n\tvPositionW = getWorldPosition();\n\t#ifdef NORMALS\n\t\tvNormalW = getNormal();\n\t#endif\n\t#ifdef TANGENTS\n\t\tvTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);\n\t\tvBinormalW = cross(vNormalW, vTangentW) * vertex_tangent.w;\n\t#elif defined(GGX_SPECULAR)\n\t\tvObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));\n\t#endif\n\t#ifdef UV0\n\t\tvec2 uv0 = getUv0();\n\t\t#ifdef UV0_UNMODIFIED\n\t\t\tvUv0 = uv0;\n\t\t#endif\n\t#endif\n\t#ifdef UV1\n\t\tvec2 uv1 = getUv1();\n\t\t#ifdef UV1_UNMODIFIED\n\t\t\tvUv1 = uv1;\n\t\t#endif\n\t#endif\n\t#include "uvTransformVS, UV_TRANSFORMS_COUNT"\n\t#ifdef VERTEX_COLOR\n\t\tvVertexColor = vertex_color;\n\t#endif\n\t#ifdef LINEAR_DEPTH\n\t\tvLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;\n\t#endif\n\t#ifdef MSDF\n\t\tunpackMsdfParams();\n\t#endif\n\t#include "litUserMainEndVS"\n}\n',litOtherMainPS:'\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#ifdef PREPASS_PASS\n\t#include "floatAsUintPS"\n#endif\nvoid main(void) {\n\t#include "litUserMainStartPS"\n\tevaluateFrontend();\n\t#ifdef PICK_PASS\n\t\tgl_FragColor = getPickOutput();\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\tgl_FragColor = float2vec4(vLinearDepth);\n\t#endif\n\t#include "litUserMainEndPS"\n}\n',litShaderArgsPS:"\nvec3 litArgs_albedo;\nfloat litArgs_opacity;\nvec3 litArgs_emission;\nvec3 litArgs_worldNormal;\nfloat litArgs_ao;\nvec3 litArgs_lightmap;\nvec3 litArgs_lightmapDir;\nfloat litArgs_metalness;\nvec3 litArgs_specularity;\nfloat litArgs_specularityFactor;\nfloat litArgs_gloss;\nfloat litArgs_sheen_gloss;\nvec3 litArgs_sheen_specularity;\nfloat litArgs_transmission;\nfloat litArgs_thickness;\nfloat litArgs_ior;\nfloat litArgs_dispersion;\nfloat litArgs_iridescence_intensity;\nfloat litArgs_iridescence_thickness;\nvec3 litArgs_clearcoat_worldNormal;\nfloat litArgs_clearcoat_specularity;\nfloat litArgs_clearcoat_gloss;\n",litShaderCorePS:'\n\t#if LIT_NONE_SLICE_MODE == TILED\n\t\tconst float textureBias = -1000.0;\n\t#else\n\t\tuniform float textureBias;\n\t#endif\n\t#include "litShaderArgsPS"\n',litShadowMainPS:'\n#if LIGHT_TYPE != DIRECTIONAL\n\tuniform vec3 view_position;\n\tuniform float light_radius;\n#endif\n#if SHADOW_TYPE == PCSS_32F\n\t#include "linearizeDepthPS"\n#endif\nvoid main(void) {\n\t#include "litUserMainStartPS"\n\tevaluateFrontend();\n\t#ifdef PERSPECTIVE_DEPTH\n\t\tfloat depth = gl_FragCoord.z;\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\t#if LIGHT_TYPE != DIRECTIONAL\n\t\t\t\tdepth = linearizeDepthWithParams(depth, camera_params);\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tfloat depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n\t\t#define MODIFIED_DEPTH\n\t#endif\n\t#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F\n\t\t#if SHADOW_TYPE == VSM_32F\n\t\t\tfloat exponent = 15.0;\n\t\t#else\n\t\t\tfloat exponent = 5.54;\n\t\t#endif\n\t\tdepth = 2.0 * depth - 1.0;\n\t\tdepth =  exp(exponent * depth);\n\t\tgl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n\t#else\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\tgl_FragColor.r = depth;\n\t\t#else\n\t\t\t#ifdef MODIFIED_DEPTH\n\t\t\t\tgl_FragDepth = depth;\n\t\t\t#endif\n\t\t\tgl_FragColor = vec4(1.0);\n\t\t#endif\n\t#endif\n\t#include "litUserMainEndPS"\n}\n',litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\t\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\n\tvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)\n{\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\treturn LTC_Uv( worldNormal, viewDir, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\n\tvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)\n{\n\tvec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);\n\treturn specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;\n}\nvoid calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)\n{\n\tdLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); \n#ifdef LIT_CLEARCOAT\n\tccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1 = normalize(V - N * dot(V, N));\n\tvec3 T2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = normalize(cross(V1, V2));\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n\t\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;\n\treturn formFactor*scale;\n}\nfloat FixNan(float value) {\n\t#ifdef WEBGPU\n\t\treturn value != value ? 0.0 : value;\n\t#else\n\t\treturn isnan(value) ? 0.0 : value;\n\t#endif\n}\nfloat getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords ));\n}\nfloat getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\tfloat falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n\treturn FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef STD_METALNESS_CONSTANT\nuniform float material_metalness;\n#endif\nvoid getMetalness() {\n\tfloat metalness = 1.0;\n\t#ifdef STD_METALNESS_CONSTANT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef STD_METALNESS_TEXTURE\n\tmetalness *= texture2DBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_UV}, textureBias).{STD_METALNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_METALNESS_VERTEX\n\tmetalness *= saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});\n\t#endif\n\tdMetalness = metalness;\n}\n",metalnessModulatePS:"\nvec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {\n\tvec3 dielectricF0 = f0 * specularity;\n\treturn mix(dielectricF0, albedo, metalness);\n}\nvec3 getAlbedoModulate(in vec3 albedo, in float metalness) {\n\treturn albedo * (1.0 - metalness);\n}\n",morphPS:"\n\tvarying vec2 uv0;\n\tuniform sampler2DArray morphTexture;\n\tuniform highp float morphFactor[{MORPH_TEXTURE_MAX_COUNT}];\n\tuniform highp uint morphIndex[{MORPH_TEXTURE_MAX_COUNT}];\n\tuniform int count;\n\t#ifdef MORPH_INT\n\t\tuniform vec3 aabbSize;\n\t\tuniform vec3 aabbMin;\n\t#endif\n\tvoid main (void) {\n\t\thighp vec3 color = vec3(0, 0, 0);\n\t\tivec2 pixelCoords = ivec2(uv0 * vec2(textureSize(morphTexture, 0).xy));\n\t\t\n\t\tfor (int i = 0; i < count; i++) {\n\t\t\tuint textureIndex = morphIndex[i];\n\t\t\tvec3 delta = texelFetch(morphTexture, ivec3(pixelCoords, int(textureIndex)), 0).xyz;\n\t\t\tcolor += morphFactor[i] * delta;\n\t\t}\n\t\t#ifdef MORPH_INT\n\t\t\tcolor = (color - aabbMin) / aabbSize * 65535.0;\n\t\t\tgl_FragColor = uvec4(color, 1u);\n\t\t#else\n\t\t\tgl_FragColor = vec4(color, 1.0);\n\t\t#endif\n\t}\n",morphVS:"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\n#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n\tuniform vec4 outline_color;\n\tuniform float outline_thickness;\n\tuniform vec4 shadow_color;\n\tuniform vec2 shadow_offset;\n#else\n\tvarying vec4 outline_color;\n\tvarying float outline_thickness;\n\tvarying vec4 shadow_color;\n\tvarying vec2 shadow_offset;\n#endif\nvec4 applyMsdf(vec4 color) {\n\tcolor.rgb = gammaCorrectInput(color.rgb);\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\tfloat smoothingMax = 0.2;\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\ttcolor.rgb = gammaCorrectOutput(tcolor.rgb);\n\t\n\treturn tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\nvoid unpackMsdfParams() {\n\tvec3 little = mod(vertex_outlineParameters, 256.);\n\tvec3 big = (vertex_outlineParameters - little) / 256.;\n\toutline_color.rb = little.xy / 255.;\n\toutline_color.ga = big.xy / 255.;\n\toutline_thickness = little.z / 255. * 0.2;\n\tlittle = mod(vertex_shadowParameters, 256.);\n\tbig = (vertex_shadowParameters - little) / 256.;\n\tshadow_color.rb = little.xy / 255.;\n\tshadow_color.ga = big.xy / 255.;\n\tshadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;\n}\n",normalVS:"\nmat3 dNormalMatrix;\nvec3 getNormal() {\n\tdNormalMatrix = getNormalMatrix(dModelMatrix);\n\tvec3 localNormal = getLocalNormal(vertex_normal);\n\treturn normalize(dNormalMatrix * localNormal);\n}\n",normalCoreVS:"\nattribute vec3 vertex_normal;\nuniform mat3 matrix_normal;\n#ifdef MORPHING_NORMAL\n\t#ifdef MORPHING_INT\n\t\tuniform highp usampler2D morphNormalTex;\n\t#else\n\t\tuniform highp sampler2D morphNormalTex;\n\t#endif\n#endif\nvec3 getLocalNormal(vec3 vertexNormal) {\n\tvec3 localNormal = vertex_normal;\n\t#ifdef MORPHING_NORMAL\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;\n\t\t#else\n\t\t\tvec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalNormal += morphNormal;\n\t#endif\n\treturn localNormal;\n}\n#if defined(SKIN) || defined(BATCH)\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#elif defined(INSTANCING)\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#else\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn matrix_normal;\n\t}\n#endif\n",normalMapPS:"\n#ifdef STD_NORMAL_TEXTURE\n\tuniform float material_bumpiness;\n#endif\n#ifdef STD_NORMALDETAIL_TEXTURE\n\tuniform float material_normalDetailMapBumpiness;\n\tvec3 blendNormals(vec3 n1, vec3 n2) {\n\t\tn1 += vec3(0, 0, 1);\n\t\tn2 *= vec3(-1, -1, 1);\n\t\treturn n1 * dot(n1, n2) / n1.z - n2;\n\t}\n#endif\nvoid getNormal() {\n#ifdef STD_NORMAL_TEXTURE\n\tvec3 normalMap = {STD_NORMAL_TEXTURE_DECODE}(texture2DBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_UV}, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n\t#ifdef STD_NORMALDETAIL_TEXTURE\n\t\tvec3 normalDetailMap = {STD_NORMALDETAIL_TEXTURE_DECODE}(texture2DBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_UV}, textureBias));\n\t\tnormalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n\t\tnormalMap = blendNormals(normalMap, normalDetailMap);\n\t#endif\n\tdNormalW = normalize(dTBN * normalMap);\n#else\n\tdNormalW = dVertexNormalW;\n#endif\n}\n",opacityPS:"\nuniform float material_opacity;\nvoid getOpacity() {\n\tdAlpha = material_opacity;\n\t#ifdef STD_OPACITY_TEXTURE\n\tdAlpha *= texture2DBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_UV}, textureBias).{STD_OPACITY_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_OPACITY_VERTEX\n\tdAlpha *= clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);\n\t#endif\n}\n",opacityDitherPS:'\n#if STD_OPACITY_DITHER == BAYER8\n\t#include "bayerPS"\n#endif\nuniform vec4 blueNoiseJitter;\n#if STD_OPACITY_DITHER == BLUENOISE\n\tuniform sampler2D blueNoiseTex32;\n#endif\nvoid opacityDither(float alpha, float id) {\n\t#if STD_OPACITY_DITHER == BAYER8\n\t\tfloat noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;\n\t#else\n\t\t#if STD_OPACITY_DITHER == BLUENOISE\n\t\t\tvec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);\n\t\t\tfloat noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;\n\t\t#endif\n\t\t#if STD_OPACITY_DITHER == IGNNOISE\n\t\t\tvec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);\n\t\t\tfloat noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));\n\t\t#endif\n\t#endif\n\tnoise = pow(noise, 2.2);\n\tif (alpha < noise)\n\t\tdiscard;\n}\n',outputPS:"\n",outputAlphaPS:"\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n\tgl_FragColor.a = litArgs_opacity;\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n\tgl_FragColor.rgb *= litArgs_opacity;\n\tgl_FragColor.a = litArgs_opacity;\n#else\n\tgl_FragColor.a = 1.0;\n#endif\n",outputTex2DPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",sheenPS:"\nuniform vec3 material_sheen;\nvoid getSheen() {\n\tvec3 sheenColor = material_sheen;\n\t#ifdef STD_SHEEN_TEXTURE\n\tsheenColor *= {STD_SHEEN_TEXTURE_DECODE}(texture2DBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_UV}, textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEEN_VERTEX\n\tsheenColor *= saturate(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});\n\t#endif\n\tsSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform float material_sheenGloss;\nvoid getSheenGlossiness() {\n\tfloat sheenGlossiness = material_sheenGloss;\n\t#ifdef STD_SHEENGLOSS_TEXTURE\n\tsheenGlossiness *= texture2DBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_UV}, textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEENGLOSS_VERTEX\n\tsheenGlossiness *= saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_SHEENGLOSS_INVERT\n\tsheenGlossiness = 1.0 - sheenGlossiness;\n\t#endif\n\tsGlossiness = sheenGlossiness + 0.0000001;\n}\n",parallaxPS:"\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2DBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_UV}, textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};\n\theight = height * parallaxScale - parallaxScale * 0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",pickPS:"\nuniform uint meshInstanceId;\nvec4 getPickOutput() {\n\tconst vec4 inv = vec4(1.0 / 255.0);\n\tconst uvec4 shifts = uvec4(16, 8, 0, 24);\n\tuvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);\n\treturn vec4(col) * inv;\n}\n",reflDirPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tdReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tfloat roughness = sqrt(1.0 - min(gloss, 1.0));\n\tvec2 direction = dAnisotropyRotation;\n\tvec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));\n\tvec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));\n\tfloat anisotropy = dAnisotropy;\n\tvec3 anisotropicDirection = anisotropicB;\n\tvec3 anisotropicTangent = cross(anisotropicDirection, viewDir);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tfloat bendFactor = 1.0 - anisotropy * (1.0 - roughness);\n\tfloat bendFactor4 = bendFactor * bendFactor * bendFactor * bendFactor;\n\tvec3 bentNormal = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));\n\tdReflDirW = reflect(-viewDir, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nvoid addReflectionCC(vec3 reflDir, float gloss) {\n\tccReflection += calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 lookupVec = cubeMapProject(reflDir);\n\tlookupVec.x *= -1.0;\n\treturn {reflectionDecode}(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n\t#define ENV_ATLAS\n\tuniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat flevel = level - ilevel;\n\tvec3 sharp = {reflectionCubemapDecode}(textureCube(texture_cubeMap, dir));\n\tvec3 roughA = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n\tvec3 roughB = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\n\tuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n\tvec2 dx = dFdx(uv);\n\tvec2 dy = dFdy(uv);\n\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\tvec2 dx2 = dFdx(uv2);\n\tvec2 dy2 = dFdy(uv2);\n\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\tfloat ilevel2 = floor(level2);\n\tvec2 uv0, uv1;\n\tfloat weight;\n\tif (ilevel == 0.0) {\n\t\tuv0 = mapShinyUv(uv, ilevel2);\n\t\tuv1 = mapShinyUv(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\tweight = 0.0;\n\t}\n\tvec3 linearA = {reflectionDecode}(texture2D(texture_envAtlas, uv0));\n\tvec3 linearB = {reflectionDecode}(texture2D(texture_envAtlas, uv1));\n\tvec3 linear0 = mix(linearA, linearB, weight);\n\tvec3 linear1 = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\tuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 reflDirV = (mat3(matrix_view) * reflDir);\n\tfloat m = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn {reflectionDecode}(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSheenPS:"\nvoid addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat alphaG = gloss * gloss;\n\tfloat a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;\n\tfloat b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;\n\tfloat DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );\n\tsReflection += calcReflection(worldNormal, 0.0) * saturate(DG);\n}\n",refractionCubePS:"\nvec3 refract2(vec3 viewVec, vec3 normal, float IOR) {\n\tfloat vn = dot(viewVec, normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n\treturn refrVec;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif \n) {\n\tvec4 tmpRefl = dReflection;\n\tvec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);\n\tdReflection = vec4(0);\n\taddReflection(reflectionDir, gloss);\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n\tdReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\nvec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {\n\tvec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n\tvec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n\tvec2 uv = getGrabScreenPos(projectionPoint);\n\tfloat iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n\tfloat refractionLod = log2(uScreenSize.x) * iorToRoughness;\n\tvec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;\n\treturn refraction;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif\n) {\n\tvec3 modelScale;\n\tmodelScale.x = length(vec3(matrix_model[0].xyz));\n\tmodelScale.y = length(vec3(matrix_model[1].xyz));\n\tmodelScale.z = length(vec3(matrix_model[2].xyz));\n\tvec3 scale = thickness * modelScale;\n\tvec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n\tvec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n\t#ifdef LIT_DISPERSION\n\t\tfloat halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n\t\tfloat refractionIndexR = refractionIndex - halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n\t\trefraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n\t\tfloat refractionIndexB = refractionIndex + halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n\t\trefraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n\t#endif\n\tvec3 transmittance;\n\tif (material_invAttenuationDistance != 0.0)\n\t{\n\t\tvec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n\t\ttransmittance = exp(-attenuation * length(refractionVector));\n\t}\n\telse\n\t{\n\t\ttransmittance = refraction;\n\t}\n\tvec3 fresnel = vec3(1.0) - \n\t\tgetFresnel(\n\t\t\tdot(viewDir, worldNormal), \n\t\t\tgloss, \n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t);\n\tdDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:'\nvarying vec2 vUv0;\n#ifdef CUBEMAP_SOURCE\n\tuniform samplerCube sourceCube;\n#else\n\tuniform sampler2D sourceTex;\n#endif\n#ifdef USE_SAMPLES_TEX\n\tuniform sampler2D samplesTex;\n\tuniform vec2 samplesTexInverseSize;\n#endif\nuniform vec3 params;\nfloat targetFace() { return params.x; }\nfloat targetTotalPixels() { return params.y; }\nfloat sourceTotalPixels() { return params.z; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#include "decodePS"\n#include "encodePS"\nvec3 modifySeams(vec3 dir, float scale) {\n\tvec3 adir = abs(dir);\n\tfloat M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3(\n\t\tadir.x == M ? 1.0 : scale,\n\t\tadir.y == M ? 1.0 : scale,\n\t\tadir.z == M ? 1.0 : scale\n\t);\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\n#ifdef CUBEMAP_SOURCE\n\tvec4 sampleCubemap(vec3 dir) {\n\t\treturn textureCube(sourceCube, modifySeams(dir, 1.0));\n\t}\n\tvec4 sampleCubemap(vec2 sph) {\n\t\treturn sampleCubemap(fromSpherical(sph));\n\t}\n\tvec4 sampleCubemap(vec3 dir, float mipLevel) {\n\t\treturn textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);\n\t}\n\tvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\t\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n\t}\n#else\n\tvec4 sampleEquirect(vec2 sph) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleEquirect(vec3 dir) {\n\t\treturn sampleEquirect(toSpherical(dir));\n\t}\n\tvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\t\treturn sampleEquirect(toSpherical(dir), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec3 dir) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleOctahedral(vec2 sph) {\n\t\treturn sampleOctahedral(fromSpherical(sph));\n\t}\n\tvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\t\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n\t}\n#endif\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\tvec3 x = normalize(cross(up, n));\n\tvec3 y = cross(n, x);\n\treturn mat3(x, y, n);\n}\nvec4 reproject() {\n\tif ({NUM_SAMPLES} <= 1) {\n\t\treturn {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}({TARGET_FUNC}())));\n\t} else {\n\t\tvec3 t = {TARGET_FUNC}();\n\t\tvec3 tu = dFdx(t);\n\t\tvec3 tv = dFdy(t);\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < {NUM_SAMPLES_SQRT}; ++u) {\n\t\t\tfor (float v = 0.0; v < {NUM_SAMPLES_SQRT}; ++v) {\n\t\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}(normalize(t +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n\t\t\t}\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n\t}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n\tvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\t\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\t\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\t\tvec4 raw;\n\t\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\t\tL.xyz = raw.xyz * 2.0 - 1.0;\n\t\tmipLevel = raw.w * 8.0;\n\t}\n\tvec4 prefilterSamples() {\n\t\tmat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < {NUM_SAMPLES}; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel)) * L.z;\n\t\t\ttotalWeight += L.z;\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / totalWeight);\n\t}\n\tvec4 prefilterSamplesUnweighted() {\n\t\tmat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < {NUM_SAMPLES}; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel));\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / float({NUM_SAMPLES}));\n\t}\n#endif\nvoid main(void) {\n\tgl_FragColor = {PROCESS_FUNC}();\n}\n',reprojectVS:"\nattribute vec2 vertex_position;\nuniform vec4 uvMod;\nvarying vec2 vUv0;\nvoid main(void) {\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);\n}\n",screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n#ifndef SCREENSIZE\n\t#define SCREENSIZE\n\tuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\tuniform mat4 matrix_view;\n#endif\n#ifndef LINEARIZE_DEPTH\n\t#define LINEARIZE_DEPTH\n\t\n\t#ifndef CAMERAPLANES\n\t\t#define CAMERAPLANES\n\t\tuniform vec4 camera_params;\n\t#endif\n\tfloat linearizeDepth(float z) {\n\t\tif (camera_params.w == 0.0)\n\t\t\treturn (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n\t\telse\n\t\t\treturn camera_params.z + z * (camera_params.y - camera_params.z);\n\t}\n#endif\nfloat delinearizeDepth(float linearDepth) {\n\tif (camera_params.w == 0.0) {\n\t\treturn (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));\n\t} else {\n\t\treturn (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);\n\t}\n}\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef SCENE_DEPTHMAP_LINEAR\n\t\t#ifdef SCENE_DEPTHMAP_FLOAT\n\t\t\treturn texture2D(uSceneDepthMap, uv).r;\n\t\t#else\n\t\t\tivec2 textureSize = textureSize(uSceneDepthMap, 0);\n\t\t\tivec2 texel = ivec2(uv * vec2(textureSize));\n\t\t\tvec4 data = texelFetch(uSceneDepthMap, texel, 0);\n\t\t\tuint intBits = \n\t\t\t\t(uint(data.r * 255.0) << 24u) |\n\t\t\t\t(uint(data.g * 255.0) << 16u) |\n\t\t\t\t(uint(data.b * 255.0) << 8u) |\n\t\t\t\tuint(data.a * 255.0);\n\t\t\treturn uintBitsToFloat(intBits);\n\t\t#endif\n\t#else\n\t\treturn linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n\t#endif\n}\n#ifndef VERTEXSHADER\n\tfloat getLinearScreenDepth() {\n\t\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\t\treturn getLinearScreenDepth(uv);\n\t}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nint getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tvec4 comparisons = step(shadowCascadeDistances, vec4(depth));\n\tint cascadeIndex = int(dot(comparisons, vec4(1.0)));\n\treturn min(cascadeIndex, shadowCascadeCount - 1);\n}\nint ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {\n \n\tif (cascadeIndex < shadowCascadeCount - 1) {\n\t\tfloat currentRangeEnd = shadowCascadeDistances[cascadeIndex];\n\t\tfloat transitionStart = blendFactor * currentRangeEnd;\n\t\tfloat depth = 1.0 / gl_FragCoord.w;\n\t\tif (depth > transitionStart) {\n\t\t\tfloat transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);\n\t\t\tfloat dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);\n\t\t\tif (dither < transitionFactor) {\n\t\t\t\tcascadeIndex += 1;\n\t\t\t}\n\t\t}\n\t}\n\treturn cascadeIndex;\n}\nvec3 fadeShadow(vec3 shadowCoord, vec4 shadowCascadeDistances) {\t\t\t\t  \n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances.w) {\n\t\tshadowCoord.z = -9999999.0;\n\t}\n\treturn shadowCoord;\n}\n",shadowEVSMPS:"\nfloat linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n\t return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\nfloat VSM16(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n\treturn VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\nfloat VSM32(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\t#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE\n\t\tvec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n\t#else\n\t\tfloat pixelSize = 1.0 / resolution;\n\t\ttexCoords -= vec2(pixelSize);\n\t\tvec3 s00 = texture2DLod(tex, texCoords, 0.0).xyz;\n\t\tvec3 s10 = texture2DLod(tex, texCoords + vec2(pixelSize, 0), 0.0).xyz;\n\t\tvec3 s01 = texture2DLod(tex, texCoords + vec2(0, pixelSize), 0.0).xyz;\n\t\tvec3 s11 = texture2DLod(tex, texCoords + vec2(pixelSize), 0.0).xyz;\n\t\tvec2 fr = fract(texCoords * resolution);\n\t\tvec3 h0 = mix(s00, s10, fr.x);\n\t\tvec3 h1 = mix(s01, s11, fr.x);\n\t\tvec3 moments = mix(h0, h1, fr.y);\n\t#endif\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n\treturn VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\tfloat Z = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);\n}\n",shadowPCF1PS:"\nfloat getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\nfloat getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn texture(shadowMap, vec4(lightDir, shadowZ));\n}\n#endif\n",shadowPCF3PS:"\nfloat _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y); \n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {\n\t\n\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\tfloat z = 1.0 / float(textureSize(shadowMap, 0));\n\tvec3 tc = normalize(dir);\n\tmediump vec4 shadows;\n\tshadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));\n\tshadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));\n\tshadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));\n\tshadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));\n\treturn dot(shadows, vec4(0.25));\n}\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\treturn getShadowOmniPCF3x3(shadowMap, shadowParams, lightDir);\n}\n#endif\n",shadowPCF5PS:"\nfloat _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n",shadowPCSSPS:"\n#define PCSS_SAMPLE_COUNT 16\nuniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];\nuniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];\nvec2 vogelDisk(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat sine = sin(theta);\n\tfloat cosine = cos(theta);\n\treturn vec2(r * cosine, r * sine);\n}\nvec3 vogelSphere(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat weight = float(sampleIndex) / count;\n\treturn vec3(cos(theta) * r, weight, sin(theta) * r);\n}\nfloat noise(vec2 screenPos) {\n\tconst float PHI = 1.61803398874989484820459;\n\treturn fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);\n}\nfloat viewSpaceDepth(float depth, mat4 invProjection) {\n\tfloat z = depth * 2.0 - 1.0;\n\tvec4 clipSpace = vec4(0.0, 0.0, z, 1.0);\n\tvec4 viewSpace = invProjection * clipSpace;\n\treturn viewSpace.z;\n}\nfloat PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec2 offset = sampleCoords[i] * searchSize;\n\t\tvec2 sampleUV = shadowCoords + offset;\n\t\tfloat blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker / blockers;\n\treturn -1.0;\n}\nfloat PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {\n\tfloat receiverDepth = linearizeDepthWithParams(shadowCoords.z, cameraParams);\n\tvec2 samplePoints[PCSS_SAMPLE_COUNT];\n\tconst float PI = 3.141592653589793;\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat pcssPresample = pcssDiskSamples[i];\n\t\tsamplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);\n\t}\n\tfloat averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat depthDifference = (receiverDepth - averageBlocker) / 3.0;\n\t\tvec2 filterRadius = depthDifference * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)\n\t\t{\n\t\t\tvec2 sampleUV = samplePoints[i] * filterRadius;\n\t\t\tsampleUV = shadowCoords.xy + sampleUV;\n\t\t\tfloat depth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t} \n}\n#ifndef WEBGPU\nfloat PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;\n\t\tsampleDir = normalize(sampleDir);\n\t\tfloat blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker / blockers;\n\treturn -1.0;\n}\nfloat PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {\n\t\n\tvec3 samplePoints[PCSS_SAMPLE_COUNT];\n\tconst float PI = 3.141592653589793;\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat r = pcssSphereSamples[i];\n\t\tsamplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);\n\t}\n\tfloat receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 lightDirNorm = normalize(lightDir);\n\t\n\tfloat averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++)\n\t\t{\n\t\t\tvec3 offset = samplePoints[i] * filterRadius;\n\t\t\tvec3 sampleDir = lightDirNorm + offset;\n\t\t\tsampleDir = normalize(sampleDir);\n\t\t\tfloat depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t}\n}\nfloat getShadowOmniPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);\n}\n#endif\nfloat getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n",shadowSoftPS:"\nhighp float fractSinRand(const in vec2 uv) {\n\tconst float PI = 3.141592653589793;\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);\n\treturn fract(sin(sn) * c);\n}\nstruct VogelDiskData {\n\tfloat invNumSamples;\n\tfloat initialAngle;\n\tfloat currentPointId;\n};\nvoid prepareDiskConstants(out VogelDiskData data, int sampleCount, float randomSeed) {\n\tconst float pi2 = 6.28318530718;\n\tdata.invNumSamples = 1.0 / float(sampleCount);\n\tdata.initialAngle = randomSeed * pi2;\n\tdata.currentPointId = 0.0;\n}\nvec2 generateDiskSample(inout VogelDiskData data) {\n\tconst float GOLDEN_ANGLE = 2.399963;\n\tfloat r = sqrt((data.currentPointId + 0.5) * data.invNumSamples);\n\tfloat theta = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;\n\tvec2 offset = vec2(cos(theta), sin(theta)) * pow(r, 1.33);\n\tdata.currentPointId += 1.0;\n\treturn offset;\n}\nvoid PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,\n\tvec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {\n\tVogelDiskData diskData;\n\tprepareDiskConstants(diskData, shadowBlockerSamples, randomSeed);\n\tfloat searchWidth = penumbraSize * invShadowMapSize;\n\tfloat blockerSum = 0.0;\n\tnumBlockers = 0;\n\tfor( int i = 0; i < shadowBlockerSamples; ++i ) {\n\t\tvec2 diskUV = generateDiskSample(diskData);\n\t\tvec2 sampleUV = shadowCoords + diskUV * searchWidth;\n\t\tfloat shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\tif ( shadowMapDepth < z ) {\n\t\t\tblockerSum += shadowMapDepth;\n\t\t\tnumBlockers++;\n\t\t}\n\t}\n\tavgBlockerDepth = blockerSum / float(numBlockers);\n}\nfloat PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {\n\tVogelDiskData diskData;\n\tprepareDiskConstants(diskData, shadowSamples, randomSeed);\n\tfloat sum = 0.0;\n\tfor (int i = 0; i < shadowSamples; i++) {\n\t\tvec2 offsetUV = generateDiskSample(diskData) * filterRadius;\n\t\tfloat depth = texture2DLod(shadowMap, uv + offsetUV, 0.0).r;\n\t\tsum += step(receiverDepth, depth);\n\t}\n\treturn sum / float(shadowSamples);\n}\nfloat getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {\n\tfloat dist = dreceiver - dblocker;\n\tfloat penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);\n\treturn penumbra * penumbraSize;\n}\nfloat PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {\n\tfloat receiverDepth = shadowCoords.z;\n\tfloat randomSeed = fractSinRand(gl_FragCoord.xy);\n\tint shadowSamples = int(softShadowParams.x);\n\tint shadowBlockerSamples = int(softShadowParams.y);\n\tfloat penumbraSize = softShadowParams.z;\n\tfloat penumbraFalloff = softShadowParams.w;\n\tint shadowMapSize = textureSize(shadowMap, 0).x;\n\tfloat invShadowMapSize = 1.0 / float(shadowMapSize);\n\tinvShadowMapSize *= float(shadowMapSize) / 2048.0;\n\tfloat penumbra;\n\tif (shadowBlockerSamples > 0) {\n\t\tfloat avgBlockerDepth = 0.0;\n\t\tint numBlockers = 0;\n\t\tPCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);\n\t\tif (numBlockers < 1)\n\t\t\treturn 1.0f;\n\t\tpenumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);\n\t} else {\n\t\tpenumbra = penumbraSize;\n\t}\n\tfloat filterRadius = penumbra * invShadowMapSize;\n\treturn PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);\n}\nfloat getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {\n\treturn PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);\n}\n",skinBatchVS:"\nattribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nmat4 getBoneMatrix(const in float indexFloat) {\n\tint width = textureSize(texture_poseMap, 0).x;\n\tint index = int(indexFloat + 0.5) * 3;\n\tint iy = index / width;\n\tint ix = index % width;\n\tvec4 v1 = texelFetch(texture_poseMap, ivec2(ix + 0, iy), 0);\n\tvec4 v2 = texelFetch(texture_poseMap, ivec2(ix + 1, iy), 0);\n\tvec4 v3 = texelFetch(texture_poseMap, ivec2(ix + 2, iy), 0);\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nvoid getBoneMatrix(const in int width, const in int index, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tint v = index / width;\n\tint u = index % width;\n\tv1 = texelFetch(texture_poseMap, ivec2(u + 0, v), 0);\n\tv2 = texelFetch(texture_poseMap, ivec2(u + 1, v), 0);\n\tv3 = texelFetch(texture_poseMap, ivec2(u + 2, v), 0);\n}\nmat4 getSkinMatrix(const in vec4 indicesFloat, const in vec4 weights) {\n\tint width = textureSize(texture_poseMap, 0).x;\n\tivec4 indices = ivec4(indicesFloat + 0.5) * 3;\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(width, indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(width, indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(width, indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(width, indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:'\n\t#define LIT_SKYBOX_INTENSITY\n\t#include "envProcPS"\n\t#include "gammaPS"\n\t#include "tonemappingPS"\n\t#ifdef PREPASS_PASS\n\t\tvarying float vLinearDepth;\n\t\t#include "floatAsUintPS"\n\t#endif\n\tvarying vec3 vViewDir;\n\tuniform float skyboxHighlightMultiplier;\n\t#ifdef SKY_CUBEMAP\n\t\tuniform samplerCube texture_cubeMap;\n\t\t#ifdef SKYMESH\n\t\t\tvarying vec3 vWorldPos;\n\t\t\tuniform mat3 cubeMapRotationMatrix;\n\t\t\tuniform vec3 projectedSkydomeCenter;\n\t\t#endif\n\t#else\n\t\t#include "sphericalPS"\n\t\t#include "envAtlasPS"\n\t\tuniform sampler2D texture_envAtlas;\n\t\tuniform float mipLevel;\n\t#endif\n\tvoid main(void) {\n\t\t#ifdef PREPASS_PASS\n\t\t\tgl_FragColor = float2vec4(vLinearDepth);\n\t\t#else\n\t\t\t#ifdef SKY_CUBEMAP\n\t\t\t\t#ifdef SKYMESH\n\t\t\t\t\tvec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);\n\t\t\t\t\tvec3 dir = envDir * cubeMapRotationMatrix;\n\t\t\t\t#else\n\t\t\t\t\tvec3 dir = vViewDir;\n\t\t\t\t#endif\n\t\t\t\tdir.x *= -1.0;\n\t\t\t\tvec3 linear = {SKYBOX_DECODE_FNC}(textureCube(texture_cubeMap, dir));\n\t\t\t#else\n\t\t\t\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\t\t\t\tvec2 uv = toSphericalUv(normalize(dir));\n\t\t\t\tvec3 linear = {SKYBOX_DECODE_FNC}(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\t\t\t#endif\n\t\t\tif (any(greaterThanEqual(linear, vec3(64.0)))) {\n\t\t\t\tlinear *= skyboxHighlightMultiplier;\n\t\t\t}\n\t\t\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n\t\t#endif\n\t}\n',skyboxVS:"\nattribute vec4 aPosition;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\n#ifdef PREPASS_PASS\n\tvarying float vLinearDepth;\n#endif\n#ifdef SKYMESH\n\tuniform mat4 matrix_model;\n\tvarying vec3 vWorldPos;\n#endif\nvoid main(void) {\n\tmat4 view = matrix_view;\n\t#ifdef SKYMESH\n\t\tvec4 worldPos = matrix_model * aPosition;\n\t\tvWorldPos = worldPos.xyz;\n\t\tgl_Position = matrix_projectionSkybox * (view * worldPos);\n\t\t#ifdef PREPASS_PASS\n\t\t\tvLinearDepth = -(matrix_view * vec4(vWorldPos, 1.0)).z;\n\t\t#endif\n\t#else\n\t\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\t\tgl_Position = matrix_projectionSkybox * (view * aPosition);\n\t\tvViewDir = aPosition.xyz * cubeMapRotationMatrix;\n\t\t#ifdef PREPASS_PASS\n\t\t\tvLinearDepth = -gl_Position.w;\n\t\t#endif\n\t#endif\n\tgl_Position.z = gl_Position.w - 1.0e-7;\n}\n",specularPS:"\n#ifdef STD_SPECULAR_CONSTANT\nuniform vec3 material_specular;\n#endif\nvoid getSpecularity() {\n\tvec3 specularColor = vec3(1,1,1);\n\t#ifdef STD_SPECULAR_CONSTANT\n\tspecularColor *= material_specular;\n\t#endif\n\t#ifdef STD_SPECULAR_TEXTURE\n\tspecularColor *= {STD_SPECULAR_TEXTURE_DECODE}(texture2DBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_UV}, textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULAR_VERTEX\n\tspecularColor *= saturate(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularity = specularColor;\n}\n",sphericalPS:"\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n\tconst float PI = 3.141592653589793;\n\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\treturn vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef STD_SPECULARITYFACTOR_CONSTANT\nuniform float material_specularityFactor;\n#endif\nvoid getSpecularityFactor() {\n\tfloat specularityFactor = 1.0;\n\t#ifdef STD_SPECULARITYFACTOR_CONSTANT\n\tspecularityFactor *= material_specularityFactor;\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_TEXTURE\n\tspecularityFactor *= texture2DBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_UV}, textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_VERTEX\n\tspecularityFactor *= saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {\n\tfloat cosAngle = dot(lightDirNorm, lightSpotDir);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startNineSlicedPS:"\n\tnineSlicedUv = vec2(vUv0.x, 1.0 - vUv0.y);\n",startNineSlicedTiledPS:"\n\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\t\n",stdDeclarationPS:'\n\tfloat dAlpha = 1.0;\n\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t#ifdef STD_OPACITY_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_opacityMap;\n\t\t#endif\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\tvec3 dAlbedo;\n\t\tvec3 dNormalW;\n\t\tvec3 dSpecularity = vec3(0.0);\n\t\tfloat dGlossiness = 0.0;\n\t\t#ifdef LIT_REFRACTION\n\t\t\tfloat dTransmission;\n\t\t\tfloat dThickness;\n\t\t#endif\n\t\t#ifdef LIT_SCENE_COLOR\n\t\t\tuniform sampler2D uSceneColorMap;\n\t\t#endif\n\t\t#ifdef LIT_SCREEN_SIZE\n\t\t\tuniform vec4 uScreenSize;\n\t\t#endif\n\t\t#ifdef LIT_TRANSFORMS\n\t\t\tuniform mat4 matrix_viewProjection;\n\t\t\tuniform mat4 matrix_model;\n\t\t#endif\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\tvec2 dUvOffset;\n\t\t\t#ifdef STD_HEIGHT_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_heightMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_diffuseMap;\n\t\t#endif\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_diffuseDetailMap;\n\t\t#endif\n\t\t#ifdef STD_NORMAL_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_normalMap;\n\t\t#endif\n\t\t#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_normalDetailMap;\n\t\t#endif\n\t\t#ifdef STD_THICKNESS_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_thicknessMap;\n\t\t#endif\n\t\t#ifdef STD_REFRACTION_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_refractionMap;\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tfloat dIridescence;\n\t\t\tfloat dIridescenceThickness;\n\t\t\t#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_iridescenceThicknessMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_iridescenceMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tfloat ccSpecularity;\n\t\t\tfloat ccGlossiness;\n\t\t\tvec3 ccNormalW;\n\t\t#endif\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\tfloat dAnisotropy;\n\t\t\tvec2 dAnisotropyRotation;\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tvec3 sSpecularity;\n\t\t\t\tfloat sGlossiness;\n\t\t\t\t#ifdef STD_SHEEN_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_sheenMap;\n\t\t\t\t#endif\n\t\t\t\t#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_sheenGlossMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\tfloat dMetalness;\n\t\t\t\tfloat dIor;\n\t\t\t\t#ifdef STD_METALNESS_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_metalnessMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tfloat dSpecularityFactor;\n\t\t\t\t#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_specularityFactorMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#ifdef STD_SPECULAR_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_specularMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_GLOSS_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_glossMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\tfloat dAo;\n\t\t\t#ifdef STD_AO_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_aoMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_AODETAIL_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_aoDetailMap;\n\t\t\t#endif\n\t\t#endif\n\t\tvec3 dEmission;\n\t\t#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_emissiveMap;\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_clearCoatMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_clearCoatGlossMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_clearCoatNormalMap;\n\t\t\t#endif\n\t\t#endif\n\t\t\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_anisotropyMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\tvec3 dLightmap;\n\t\t\t#ifdef STD_LIGHT_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_lightMap;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#include "litShaderCorePS"\n',stdFrontEndPS:'\n\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t#include "opacityPS"\n\t\t#if defined(LIT_ALPHA_TEST)\n\t\t\t#include "alphaTestPS"\n\t\t#endif\n\t\t#if STD_OPACITY_DITHER != NONE\n\t\t\t#include "opacityDitherPS"\n\t\t#endif\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t#include "parallaxPS"\n\t\t#endif\n\t\t#include  "diffusePS"\n\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t#include "normalMapPS"\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\t#include "transmissionPS"\n\t\t\t#include "thicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t#include "iridescencePS"\n\t\t\t#include "iridescenceThicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t#include "sheenPS"\n\t\t\t\t#include "sheenGlossPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t#include "metalnessPS"\n\t\t\t\t#include "iorPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t#include "specularityFactorPS"\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#include "specularPS"\n\t\t\t#else\n\t\t\t\tvoid getSpecularity() { \n\t\t\t\t\tdSpecularity = vec3(1);\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#include "glossPS"\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\t#include "aoPS"\n\t\t#endif\n\t\t#include "emissivePS"\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#include "clearCoatPS"\n\t\t\t#include "clearCoatGlossPS"\n\t\t\t#include "clearCoatNormalPS"\n\t\t#endif\n\t\t#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n\t\t\t#include "anisotropyPS"\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t#include "lightmapPS"\n\t\t#endif\n\t#endif\n\tvoid evaluateFrontend() {\n\t\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t\tgetOpacity();\n\t\t\t#if defined(LIT_ALPHA_TEST)\n\t\t\t\talphaTest(dAlpha);\n\t\t\t#endif\n\t\t\t#if STD_OPACITY_DITHER != NONE\n\t\t\t\topacityDither(dAlpha, 0.0);\n\t\t\t#endif\n\t\t\tlitArgs_opacity = dAlpha;\n\t\t#endif\n\t\t#ifdef FORWARD_PASS\n\t\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t\tgetParallax();\n\t\t\t#endif\n\t\t\tgetAlbedo();\n\t\t\tlitArgs_albedo = dAlbedo;\n\t\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t\tgetNormal();\n\t\t\t\tlitArgs_worldNormal = dNormalW;\n\t\t\t#endif\n\t\t\t#ifdef LIT_REFRACTION\n\t\t\t\tgetRefraction();\n\t\t\t\tlitArgs_transmission = dTransmission;\n\t\t\t\tgetThickness();\n\t\t\t\tlitArgs_thickness = dThickness;\n\t\t\t\t#ifdef LIT_DISPERSION\n\t\t\t\t\tlitArgs_dispersion = material_dispersion;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t\tgetIridescence();\n\t\t\t\tgetIridescenceThickness();\n\t\t\t\tlitArgs_iridescence_intensity = dIridescence;\n\t\t\t\tlitArgs_iridescence_thickness = dIridescenceThickness;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tgetSheen();\n\t\t\t\t\tlitArgs_sheen_specularity = sSpecularity;\n\t\t\t\t\tgetSheenGlossiness();\n\t\t\t\t\tlitArgs_sheen_gloss = sGlossiness;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t\tgetMetalness();\n\t\t\t\t\tlitArgs_metalness = dMetalness;\n\t\t\t\t\tgetIor();\n\t\t\t\t\tlitArgs_ior = dIor;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t\tgetSpecularityFactor();\n\t\t\t\t\tlitArgs_specularityFactor = dSpecularityFactor;\n\t\t\t\t#endif\n\t\t\t\tgetGlossiness();\n\t\t\t\tgetSpecularity();\n\t\t\t\tlitArgs_specularity = dSpecularity;\n\t\t\t\tlitArgs_gloss = dGlossiness;\n\t\t\t#endif\n\t\t\t#ifdef STD_AO\n\t\t\t\tgetAO();\n\t\t\t\tlitArgs_ao = dAo;\n\t\t\t#endif\n\t\t\tgetEmission();\n\t\t\tlitArgs_emission = dEmission;\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tgetClearCoat();\n\t\t\t\tgetClearCoatGlossiness();\n\t\t\t\tgetClearCoatNormal();\n\t\t\t\tlitArgs_clearcoat_specularity = ccSpecularity;\n\t\t\t\tlitArgs_clearcoat_gloss = ccGlossiness;\n\t\t\t\tlitArgs_clearcoat_worldNormal = ccNormalW;\n\t\t\t#endif\n\t\t\t#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n\t\t\t\tgetAnisotropy();\n\t\t\t#endif\n\t\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t\tgetLightMap();\n\t\t\t\tlitArgs_lightmap = dLightmap;\n\t\t\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\t\t\tlitArgs_lightmapDir = dLightmapDir;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#endif\n\t}\n',TBNPS:"\n#ifdef LIT_TANGENTS\n\t#define TBN_TANGENTS\n#else\n\t#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n\t\t#define TBN_DERIVATIVES\n\t#endif\n#endif\n#if defined(TBN_DERIVATIVES)\n\tuniform float tbnBasis;\n#endif\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\t#ifdef TBN_TANGENTS\n\t\tdTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));\n\t#elif defined(TBN_DERIVATIVES)\n\t\tvec2 uv = {lightingUv};\n\t\tvec3 dp1 = dFdx( vPositionW );\n\t\tvec3 dp2 = dFdy( vPositionW );\n\t\tvec2 duv1 = dFdx( uv );\n\t\tvec2 duv2 = dFdy( uv );\n\t\tvec3 dp2perp = cross( dp2, normal );\n\t\tvec3 dp1perp = cross( normal, dp1 );\n\t\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\t\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\t\tfloat denom = max( dot(T,T), dot(B,B) );\n\t\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\t\tdTBN = mat3(T * invmax, -B * invmax, normal );\n\t#else\n\t\tvec3 B = cross(normal, vObjectSpaceUpW);\n\t\tvec3 T = cross(normal, B);\n\t\tif (dot(B,B)==0.0)\n\t\t{\n\t\t\tfloat major=max(max(normal.x, normal.y), normal.z);\n\t\t\tif (normal.x == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3(0,1,0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse if (normal.y == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3(0,0,1));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse if (normal.z == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3(1,0,0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t}\n\t\tdTBN = mat3(normalize(T), normalize(B), normalize(normal));\n\t#endif\n}\n",thicknessPS:"\n#ifdef STD_THICKNESS_CONSTANT\nuniform float material_thickness;\n#endif\nvoid getThickness() {\n\tdThickness = 1.0;\n\t#ifdef STD_THICKNESS_CONSTANT\n\tdThickness *= material_thickness;\n\t#endif\n\t#ifdef STD_THICKNESS_TEXTURE\n\tdThickness *= texture2DBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_UV}, textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_THICKNESS_VERTEX\n\tdThickness *= saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});\n\t#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n\t#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n\t#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n\t#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n\t#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n\t#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n\t#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n\t#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure / 0.6;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n\t return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNeutralPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tfloat startCompression = 0.8 - 0.04;\n\tfloat desaturation = 0.15;\n\tfloat x = min(color.r, min(color.g, color.b));\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max(color.r, max(color.g, color.b));\n\tif (peak < startCompression) return color;\n\tfloat d = 1. - startCompression;\n\tfloat newPeak = 1. - d * d / (peak + d - startCompression);\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);\n\treturn mix(color, newPeak * vec3(1, 1, 1), g);\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\nvec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {\n\tvec3 localPos = getLocalPosition(vertexPosition);\n\t#ifdef NINESLICED\n\t\tlocalPos.xz *= outerScale;\n\t\tvec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\t\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\t\tlocalPos.xz *= -0.5;\n\t\tlocalPos = localPos.xzy;\n\t#endif\n\tvec4 posW = modelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\t\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\treturn posW;\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\t\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t\t#ifdef WEBGPU\n\t\t\tscreenPos.y *= -1.0;\n\t\t#endif\n\t#else\n\t\t#ifdef SCREENSPACE\n\t\t\tscreenPos = posW;\n\t\t\tscreenPos.y *= projectionFlipY;\n\t\t#else\n\t\t\tscreenPos = matrix_viewProjection * posW;\n\t\t#endif\n\t\t#ifdef PIXELSNAP\n\t\t\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\t\t\tscreenPos.xy *= uScreenSize.xy;\n\t\t\tscreenPos.xy = floor(screenPos.xy);\n\t\t\tscreenPos.xy *= uScreenSize.zw;\n\t\t\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformCoreVS:'\nattribute vec4 vertex_position;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifdef MORPHING\n\tuniform vec2 morph_tex_params;\n\tattribute uint morph_vertex_id;\n\tivec2 getTextureMorphCoords() {\n\t\tivec2 textureSize = ivec2(morph_tex_params);\n\t\tint morphGridV = int(morph_vertex_id) / textureSize.x;\n\t\tint morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);\n\t\t#ifdef WEBGPU\n\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t#endif\n\t\treturn ivec2(morphGridU, morphGridV);\n\t}\n\t#ifdef MORPHING_POSITION\n\t\t#ifdef MORPHING_INT\n\t\t\tuniform vec3 aabbSize;\n\t\t\tuniform vec3 aabbMin;\n\t\t\tuniform usampler2D morphPositionTex;\n\t\t#else\n\t\t\tuniform highp sampler2D morphPositionTex;\n\t\t#endif\n\t#endif\n#endif\n#ifdef defined(BATCH)\n\t#include "skinBatchVS"\n\tmat4 getModelMatrix() {\n\t\treturn getBoneMatrix(vertex_boneIndices);\n\t}\n#elif defined(SKIN)\n\t#include "skinVS"\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t}\n#elif defined(INSTANCING)\n\t#include "transformInstancingVS"\n#else\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model;\n\t}\n#endif\nvec3 getLocalPosition(vec3 vertexPosition) {\n\tvec3 localPos = vertexPosition;\n\t#ifdef MORPHING_POSITION\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;\n\t\t#else\n\t\t\tvec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalPos += morphPos;\n\t#endif\n\treturn localPos;\n}\n',transformInstancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\nmat4 getModelMatrix() {\n\treturn matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef STD_REFRACTION_CONSTANT\nuniform float material_refraction;\n#endif\nvoid getRefraction() {\n\tfloat refraction = 1.0;\n\t#ifdef STD_REFRACTION_CONSTANT\n\trefraction = material_refraction;\n\t#endif\n\t#ifdef STD_REFRACTION_TEXTURE\n\trefraction *= texture2DBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_UV}, textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_REFRACTION_VERTEX\n\trefraction *= saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});\n\t#endif\n\tdTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform float twoSidedLightingNegScaleFactor;\nvoid handleTwoSidedLighting() {\n\tdTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;\n}\n",uv0VS:"\n#ifdef NINESLICED\n\tvec2 getUv0() {\n\t\tvec2 uv = vertex_position.xz;\n\t\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\t\tuv = uv * -0.5 + 0.5;\n\t\tuv = uv * atlasRect.zw + atlasRect.xy;\n\t\tvMask = vertex_texCoord0.xy;\n\t\treturn uv;\n\t}\n#else\n\tvec2 getUv0() {\n\t\treturn vertex_texCoord0;\n\t}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",uvTransformVS:"\nvUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2(\n\tdot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),\n\tdot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n\tuniform vec3 {TRANSFORM_NAME_{i}}0;\n\tuniform vec3 {TRANSFORM_NAME_{i}}1;\n",viewDirPS:"\nvoid getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",webgpuPS:Ta,webgpuVS:Ea};const Nm={alphaTestPS:"\nuniform alpha_ref: f32;\nfn alphaTest(a: f32) {\n\tif (a < uniform.alpha_ref) {\n\t\tdiscard;\n\t}\n}\n",ambientPS:'\n#if LIT_AMBIENT_SOURCE == AMBIENTSH\n\tuniform ambientSH: array<vec3f, 9>;\n#endif\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t#include "envAtlasPS"\n\t#ifndef ENV_ATLAS\n\t\t#define ENV_ATLAS\n\t\tvar texture_envAtlas: texture_2d<f32>;\n\t\tvar texture_envAtlasSampler: sampler;\n\t#endif\n#endif\nfn addAmbient(worldNormal: vec3f) {\n\t#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\t\tlet n: vec3f = cubeMapRotate(worldNormal);\n\t\tlet color: vec3f =\n\t\t\tuniform.ambientSH[0] +\n\t\t\tuniform.ambientSH[1] * n.x +\n\t\t\tuniform.ambientSH[2] * n.y +\n\t\t\tuniform.ambientSH[3] * n.z +\n\t\t\tuniform.ambientSH[4] * n.x * n.z +\n\t\t\tuniform.ambientSH[5] * n.z * n.y +\n\t\t\tuniform.ambientSH[6] * n.y * n.x +\n\t\t\tuniform.ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\t\tuniform.ambientSH[8] * (n.x * n.x - n.y * n.y);\n\t\tdDiffuseLight += processEnvironment(max(color, vec3f(0.0)));\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t\tlet dir: vec3f = normalize(cubeMapRotate(worldNormal) * vec3f(-1.0, 1.0, 1.0));\n\t\tlet uv: vec2f = mapUv(toSphericalUv(dir), vec4f(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\t\tlet raw: vec4f = textureSample(texture_envAtlas, texture_envAtlasSampler, uv);\n\t\tlet linear: vec3f = {ambientDecode}(raw);\n\t\tdDiffuseLight += processEnvironment(linear);\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == CONSTANT\n\t\tdDiffuseLight += uniform.light_globalAmbient;\n\t#endif\n}\n',anisotropyPS:"\n#ifdef LIT_GGX_SPECULAR\n\tuniform material_anisotropyIntensity: f32;\n\tuniform material_anisotropyRotation: vec2f;\n#endif\nfn getAnisotropy() {\n\tdAnisotropy = 0.0;\n\tdAnisotropyRotation = vec2f(1.0, 0.0);\n#ifdef LIT_GGX_SPECULAR\n\tdAnisotropy = uniform.material_anisotropyIntensity;\n\tdAnisotropyRotation = uniform.material_anisotropyRotation;\n#endif\n#ifdef STD_ANISOTROPY_TEXTURE\n\tlet anisotropyTex: vec3f = textureSampleBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_NAME}Sampler, {STD_ANISOTROPY_TEXTURE_UV}, uniform.textureBias).rgb;\n\tdAnisotropy *= anisotropyTex.b;\n\tlet anisotropyRotationFromTex: vec2f = anisotropyTex.rg * 2.0 - vec2f(1.0);\n\tlet rotationMatrix: mat2x2f = mat2x2f(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);\n\tdAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;\n#endif\n\tdAnisotropy = clamp(dAnisotropy, 0.0, 1.0);\n}\n",aoPS:'\n#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\tuniform material_aoIntensity: f32;\n#endif\n#ifdef STD_AODETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nfn getAO() {\n\tdAo = 1.0;\n\t#ifdef STD_AO_TEXTURE\n\t\tvar aoBase: f32 = textureSampleBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_NAME}Sampler, {STD_AO_TEXTURE_UV}, uniform.textureBias).{STD_AO_TEXTURE_CHANNEL};\n\t\t#ifdef STD_AODETAIL_TEXTURE\n\t\t\tvar aoDetail: f32 = textureSampleBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_NAME}Sampler, {STD_AODETAIL_TEXTURE_UV}, uniform.textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};\n\t\t\taoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3f(aoBase), vec3f(aoDetail)).r;\n\t\t#endif\n\t\tdAo = dAo * aoBase;\n\t#endif\n\t#ifdef STD_AO_VERTEX\n\t\tdAo = dAo * saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});\n\t#endif\n\t#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\t\tdAo = mix(1.0, dAo, uniform.material_aoIntensity);\n\t#endif\n}\n',aoDiffuseOccPS:"\nfn occludeDiffuse(ao: f32) {\n\tdDiffuseLight = dDiffuseLight * ao;\n}\n",aoSpecOccPS:"\n#if LIT_OCCLUDE_SPECULAR != NONE\n\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\tuniform material_occludeSpecularIntensity: f32;\n\t#endif\n#endif\nfn occludeSpecular(gloss: f32, ao: f32, worldNormal: vec3f, viewDir: vec3f) {\n\t#if LIT_OCCLUDE_SPECULAR == AO\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tvar specOcc: f32 = mix(1.0, ao, uniform.material_occludeSpecularIntensity);\n\t\t#else\n\t\t\tvar specOcc: f32 = ao;\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT\n\t\tvar specPow: f32 = exp2(gloss * 11.0);\n\t\tvar specOcc: f32 = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tspecOcc = mix(1.0, specOcc, uniform.material_occludeSpecularIntensity);\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\tdSpecularLight = dSpecularLight * specOcc;\n\t\tdReflection = dReflection * specOcc;\n\t\t#ifdef LIT_SHEEN\n\t\t\tsSpecularLight = sSpecularLight * specOcc;\n\t\t\tsReflection = sReflection * specOcc;\n\t\t#endif\n\t#endif\n}\n",bakeDirLmEndPS:"\n\tlet dirLm = textureSample(texture_dirLightMap, texture_dirLightMapSampler, vUv1);\n\tif (uniform.bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tlet unpacked_dir = dirLm.xyz * 2.0 - vec3f(1.0);\n\t\t\tdAtten = clamp(dAtten, 0.0, 1.0);\n\t\t\tlet combined_dir = dLightDirNormW.xyz * dAtten + unpacked_dir * dirLm.w;\n\t\t\tlet finalRgb = normalize(combined_dir) * 0.5 + vec3f(0.5);\n\t\t\tlet finalA = max(dirLm.w + dAtten, 1.0 / 255.0);\n\t\t\toutput.color = vec4f(finalRgb, finalA);\n\t\t} else {\n\t\t\toutput.color = dirLm;\n\t\t}\n\t} else {\n\t\tlet alpha_min = select(0.0, 1.0 / 255.0, dAtten > 0.00001);\n\t\tlet finalA = max(dirLm.w, alpha_min);\n\t\toutput.color = vec4f(dirLm.rgb, finalA);\n\t}\n",bakeLmEndPS:"\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n\tdDiffuseLight = ((dDiffuseLight - 0.5) * max(uniform.ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;\n\tdDiffuseLight = dDiffuseLight + vec3f(uniform.ambientBakeOcclusionBrightness);\n\tdDiffuseLight = saturate3(dDiffuseLight);\n\tdDiffuseLight = dDiffuseLight * dAmbientLight;\n#endif\n#ifdef LIGHTMAP_RGBM\n\tvar temp_color_rgbm = vec4f(dDiffuseLight, 1.0);\n\ttemp_color_rgbm = vec4f(pow(temp_color_rgbm.rgb, vec3f(0.5)), temp_color_rgbm.a);\n\ttemp_color_rgbm = vec4f(temp_color_rgbm.rgb / 8.0, temp_color_rgbm.a);\n\tlet max_g_b = max(temp_color_rgbm.g, max(temp_color_rgbm.b, 1.0 / 255.0));\n\tlet max_rgb = max(temp_color_rgbm.r, max_g_b);\n\ttemp_color_rgbm.a = clamp(max_rgb, 0.0, 1.0);\n\ttemp_color_rgbm.a = ceil(temp_color_rgbm.a * 255.0) / 255.0;\n\ttemp_color_rgbm = vec4f(temp_color_rgbm.rgb / temp_color_rgbm.a, temp_color_rgbm.a);\n\toutput.color = temp_color_rgbm;\n#else\n\toutput.color = vec4f(dDiffuseLight, 1.0);\n#endif\n",basePS:"\nuniform view_position: vec3f;\nuniform light_globalAmbient: vec3f;\nfn square(x: f32) -> f32 {\n\treturn x*x;\n}\nfn saturate(x: f32) -> f32 {\n\treturn clamp(x, 0.0, 1.0);\n}\nfn saturate3(x: vec3f) -> vec3f {\n\treturn clamp(x, vec3f(0.0), vec3f(1.0));\n}\n",baseNineSlicedPS:"\n#define NINESLICED\nvarying vMask: vec2f;\nvarying vTiledUv: vec2f;\nuniform innerOffset: vec4f;\nuniform outerScale: vec2f;\nuniform atlasRect: vec4f;\nvar<private> nineSlicedUv: vec2f;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vMask: vec2f;\nvarying vTiledUv: vec2f;\nuniform innerOffset: vec4f;\nuniform outerScale: vec2f;\nuniform atlasRect: vec4f;\nvar<private> nineSlicedUv: vec2f;\n",bayerPS:"\nfn bayer2(p: vec2f) -> f32 {\n\treturn (2.0 * p.y + p.x + 1.0) % 4.0;\n}\nfn bayer4(p: vec2f) -> f32 {\n\tlet p1: vec2f = p % vec2f(2.0);\n\tlet p2: vec2f = floor(0.5 * (p % vec2f(4.0)));\n\treturn 4.0 * bayer2(p1) + bayer2(p2);\n}\nfn bayer8(p: vec2f) -> f32 {\n\tlet p1: vec2f = p % vec2f(2.0);\n\tlet p2: vec2f = floor(0.5 * (p % vec2f(4.0)));\n\tlet p4: vec2f = floor(0.25 * (p % vec2f(8.0)));\n\treturn 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\n#ifdef GAUSS\n\tuniform weight: array<f32, {SAMPLES}>;\n#endif\nuniform pixelOffset: vec2f;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\tvar moments: vec3f = vec3f(0.0);\n\tlet uv: vec2f = input.vUv0 - uniform.pixelOffset * (f32({SAMPLES}) * 0.5);\n\tfor (var i: i32 = 0; i < {SAMPLES}; i = i + 1) {\n\t\tlet c: vec4f = textureSample(source, sourceSampler, uv + uniform.pixelOffset * f32(i));\n\t\t#ifdef GAUSS\n\t\t\tmoments = moments + c.xyz * uniform.weight[i].element;\n\t\t#else\n\t\t\tmoments = moments + c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\t\tmoments = moments * (1.0 / f32({SAMPLES}));\n\t#endif\n\toutput.color = vec4f(moments, 1.0);\n\treturn output;\n}\n",clearCoatPS:"\nuniform material_clearCoat: f32;\nfn getClearCoat() {\n\tccSpecularity = uniform.material_clearCoat;\n\t#ifdef STD_CLEARCOAT_TEXTURE\n\tccSpecularity = ccSpecularity * textureSampleBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_NAME}Sampler, {STD_CLEARCOAT_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOAT_VERTEX\n\tccSpecularity = ccSpecularity * saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});\n\t#endif\n}\n",clearCoatGlossPS:"\n\tuniform material_clearCoatGloss: f32;\nfn getClearCoatGlossiness() {\n\tccGlossiness = uniform.material_clearCoatGloss;\n\t#ifdef STD_CLEARCOATGLOSS_TEXTURE\n\tccGlossiness = ccGlossiness * textureSampleBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_NAME}Sampler, {STD_CLEARCOATGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_VERTEX\n\tccGlossiness = ccGlossiness * saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_INVERT\n\tccGlossiness = 1.0 - ccGlossiness;\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n\tuniform material_clearCoatBumpiness: f32;\n#endif\nfn getClearCoatNormal() {\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n\tvar normalMap: vec3f = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(textureSampleBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_NAME}Sampler, {STD_CLEARCOATNORMAL_TEXTURE_UV}, uniform.textureBias));\n\tnormalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_clearCoatBumpiness);\n\tccNormalW = normalize(dTBN * normalMap);\n#else\n\tccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nfn _getCookieClustered(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, intensity: f32, cookieChannel: vec4f) -> vec3f {\n\tlet pixel: vec4f = mix(vec4f(1.0), textureSampleLevel(tex, texSampler, uv, 0.0), intensity);\n\tlet isRgb: bool = dot(cookieChannel.rgb, vec3f(1.0)) == 3.0;\n\treturn select(vec3f(dot(pixel, cookieChannel)), pixel.rgb, isRgb);\n}\nfn getCookie2DClustered(tex: texture_2d<f32>, texSampler: sampler, transform: mat4x4f, worldPosition: vec3f, intensity: f32, cookieChannel: vec4f) -> vec3f {\n\tlet projPos: vec4f = transform * vec4f(worldPosition, 1.0);\n\treturn _getCookieClustered(tex, texSampler, projPos.xy / projPos.w, intensity, cookieChannel);\n}\nfn getCookieCubeClustered(tex: texture_2d<f32>, texSampler: sampler, dir: vec3f, intensity: f32, cookieChannel: vec4f, shadowTextureResolution: f32, shadowEdgePixels: f32, omniAtlasViewport: vec3f) -> vec3f {\n\tlet uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(tex, texSampler, uv, intensity, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nfn _getShadowCoordPerspZbuffer(shadowMatrix: mat4x4f, shadowParams: vec4f, wPos: vec3f) -> vec3f {\n\tvar projPos = shadowMatrix * vec4f(wPos, 1.0);\n\treturn projPos.xyz / projPos.w;\n}\nfn getShadowCoordPerspZbufferNormalOffset(shadowMatrix: mat4x4f, shadowParams: vec4f, normal: vec3f) -> vec3f {\n\tlet wPos: vec3f = vPositionW + normal * shadowParams.y;\n\treturn _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nfn normalOffsetPointShadow(shadowParams: vec4f, lightPos: vec3f, lightDir: vec3f, lightDirNorm: vec3f, normal: vec3f) -> vec3f {\n\tlet distScale: f32 = length(lightDir);\n\tlet wPos: vec3f = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\tlet dir: vec3f = wPos - lightPos;\n\treturn dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfn getShadowOmniClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {\n\t\tlet shadowTextureResolution: f32 = shadowParams.x;\n\t\tlet uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tlet shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\treturn textureSampleCompareLevel(shadowMap, shadowMapSampler, uv, shadowZ);\n\t}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfn getShadowOmniClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {\n\t\tlet shadowTextureResolution: f32 = shadowParams.x;\n\t\tlet uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tlet shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\tlet shadowCoord: vec3f = vec3f(uv, shadowZ);\n\t\treturn getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n\t}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfn getShadowOmniClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {\n\t\tlet shadowTextureResolution: f32 = shadowParams.x;\n\t\tlet uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tlet shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\tlet shadowCoord: vec3f = vec3f(uv, shadowZ);\n\t\treturn getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n\t}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfn getShadowSpotClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\t\treturn textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);\n\t}\n#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfn getShadowSpotClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\t\treturn getShadowSpotPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n\t}\n#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfn getShadowSpotClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\t\treturn getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n\t}\n#endif\n",clusteredLightUtilsPS:"\nstruct FaceCoords {\n\tuv: vec2f,\n\tfaceIndex: f32,\n\ttileOffset: vec2f,\n}\nfn getCubemapFaceCoordinates(dir: vec3f) -> FaceCoords {\n\tvar faceIndex: f32;\n\tvar tileOffset: vec2f;\n\tvar uv: vec2f;\n\tlet vAbs: vec3f = abs(dir);\n\tvar ma: f32;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tlet is_neg_z = dir.z < 0.0;\n\t\tfaceIndex = select(4.0, 5.0, is_neg_z);\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2f(select(dir.x, -dir.x, is_neg_z), -dir.y);\n\t\ttileOffset = vec2f(2.0, select(0.0, 1.0, is_neg_z));\n\t} else if (vAbs.y >= vAbs.x) {\n\t\tlet is_neg_y = dir.y < 0.0;\n\t\tfaceIndex = select(2.0, 3.0, is_neg_y);\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2f(dir.x, select(dir.z, -dir.z, is_neg_y));\n\t\ttileOffset = vec2f(1.0, select(0.0, 1.0, is_neg_y));\n\t} else {\n\t\tlet is_neg_x = dir.x < 0.0;\n\t\tfaceIndex = select(0.0, 1.0, is_neg_x);\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2f(select(-dir.z, dir.z, is_neg_x), -dir.y);\n\t\ttileOffset = vec2f(0.0, select(0.0, 1.0, is_neg_x));\n\t}\n\tuv = uv * ma + 0.5;\n\treturn FaceCoords(uv, faceIndex, tileOffset);\n}\nfn getCubemapAtlasCoordinates(omniAtlasViewport: vec3f, shadowEdgePixels: f32, shadowTextureResolution: f32, dir: vec3f) -> vec2f {\n\tlet faceData: FaceCoords = getCubemapFaceCoordinates(dir);\n\tvar uv: vec2f = faceData.uv;\n\tlet tileOffset: vec2f = faceData.tileOffset;\n\tlet atlasFaceSize: f32 = omniAtlasViewport.z;\n\tlet tileSize: f32 = shadowTextureResolution * atlasFaceSize;\n\tvar offset: f32 = shadowEdgePixels / tileSize;\n\tuv = uv * (1.0 - offset * 2.0) + offset;\n\tuv = uv * atlasFaceSize;\n\tuv = uv + tileOffset * atlasFaceSize;\n\tuv = uv + omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:'\n#include "lightBufferDefinesPS"\n#include "clusteredLightUtilsPS"\n#ifdef CLUSTER_COOKIES\n\t#include "clusteredLightCookiesPS"\n#endif\n#ifdef CLUSTER_SHADOWS\n\t#include "clusteredLightShadowsPS"\n#endif\nvar clusterWorldTexture: texture_2d<f32>;\nvar lightsTexture: texture_2d<f32>;\n#ifdef CLUSTER_SHADOWS\n\tvar shadowAtlasTexture: texture_depth_2d;\n\tvar shadowAtlasTextureSampler: sampler_comparison;\n#endif\n#ifdef CLUSTER_COOKIES\n\tvar cookieAtlasTexture: texture_2d<f32>;\n\tvar cookieAtlasTextureSampler: sampler;\n#endif\nuniform clusterMaxCells: i32;\nuniform clusterSkip: f32;\nuniform clusterCellsCountByBoundsSize: vec3f;\nuniform clusterTextureSize: vec3f;\nuniform clusterBoundsMin: vec3f;\nuniform clusterBoundsDelta: vec3f;\nuniform clusterCellsDot: vec3f;\nuniform clusterCellsMax: vec3f;\nuniform shadowAtlasParams: vec2f;\nstruct ClusterLightData {\n\tflags: u32,\n\thalfWidth: vec3f,\n\tisSpot: bool,\n\thalfHeight: vec3f,\n\tlightIndex: i32,\n\tposition: vec3f,\n\tshape: u32,\n\tdirection: vec3f,\n\tfalloffModeLinear: bool,\n\tcolor: vec3f,\n\tshadowIntensity: f32,\n\tomniAtlasViewport: vec3f,\n\trange: f32,\n\tcookieChannelMask: vec4f,\n\tbiasesData: f32,\n\tshadowBias: f32,\n\tshadowNormalBias: f32,\n\tanglesData: f32,\n\tinnerConeAngleCos: f32,\n\touterConeAngleCos: f32,\n\tcookieIntensity: f32,\n\tisDynamic: bool,\n\tisLightmapped: bool\n}\nvar<private> lightProjectionMatrix: mat4x4f;\nfn sampleLightTextureF(lightIndex: i32, index: i32) -> vec4f {\n\treturn textureLoad(lightsTexture, vec2<i32>(index, lightIndex), 0);\n}\nfn decodeClusterLightCore(clusterLightData: ptr<function, ClusterLightData>, lightIndex: f32) {\n\tclusterLightData.lightIndex = i32(lightIndex);\n\tlet halfData: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});\n\tclusterLightData.anglesData = halfData.z;\n\tclusterLightData.biasesData = halfData.w;\n\tlet colorRG: vec2f = unpack2x16float(bitcast<u32>(halfData.x));\n\tlet colorB_: vec2f = unpack2x16float(bitcast<u32>(halfData.y));\n\tclusterLightData.color = vec3f(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};\n\tlet lightPosRange: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_POSITION_RANGE});\n\tclusterLightData.position = lightPosRange.xyz;\n\tclusterLightData.range = lightPosRange.w;\n\tlet lightDir_Flags: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_DIRECTION_FLAGS});\n\tclusterLightData.direction = lightDir_Flags.xyz;\n\tlet flags_uint: u32 = bitcast<u32>(lightDir_Flags.w);\n\tclusterLightData.flags = flags_uint;\n\tclusterLightData.isSpot = (flags_uint & (1u << 30u)) != 0u;\n\tclusterLightData.shape = (flags_uint >> 28u) & 0x3u;\n\tclusterLightData.falloffModeLinear = (flags_uint & (1u << 27u)) == 0u;\n\tclusterLightData.shadowIntensity = f32((flags_uint >> 0u) & 0xFFu) / 255.0;\n\tclusterLightData.cookieIntensity = f32((flags_uint >> 8u) & 0xFFu) / 255.0;\n\tclusterLightData.isDynamic = (flags_uint & (1u << 22u)) != 0u;\n\tclusterLightData.isLightmapped = (flags_uint & (1u << 21u)) != 0u;\n}\nfn decodeClusterLightSpot(clusterLightData: ptr<function, ClusterLightData>) {\n\tlet angles: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.anglesData));\n\tclusterLightData.innerConeAngleCos = angles.x;\n\tclusterLightData.outerConeAngleCos = angles.y;\n}\nfn decodeClusterLightOmniAtlasViewport(clusterLightData: ptr<function, ClusterLightData>) {\n\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;\n}\nfn decodeClusterLightAreaData(clusterLightData: ptr<function, ClusterLightData>) {\n\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;\n\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;\n}\nfn decodeClusterLightProjectionMatrixData(clusterLightData: ptr<function, ClusterLightData>) {\n\tlet m0: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0});\n\tlet m1: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_1});\n\tlet m2: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_2});\n\tlet m3: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_3});\n\tlightProjectionMatrix = mat4x4f(m0, m1, m2, m3);\n}\nfn decodeClusterLightShadowData(clusterLightData: ptr<function, ClusterLightData>) {\n\tlet biases: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.biasesData));\n\tclusterLightData.shadowBias = biases.x;\n\tclusterLightData.shadowNormalBias = biases.y;\n}\nfn decodeClusterLightCookieData(clusterLightData: ptr<function, ClusterLightData>) {\n\tlet cookieFlags: u32 = (clusterLightData.flags >> 23u) & 0x0Fu;\n\tlet mask_uvec: vec4<u32> = vec4<u32>(cookieFlags) & vec4<u32>(1u, 2u, 4u, 8u);\n\tclusterLightData.cookieChannelMask = step(vec4f(1.0), vec4f(mask_uvec));\n}\nfn evaluateLight(\n\tlight: ptr<function, ClusterLightData>,\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\treflectionDir: vec3f,\n#if defined(LIT_CLEARCOAT)\n\tclearcoatReflectionDir: vec3f,\n#endif\n\tgloss: f32,\n\tspecularity: vec3f,\n\tgeometricNormal: vec3f,\n\ttbn: mat3x3f,\n#if defined(LIT_IRIDESCENCE)\n\tiridescenceFresnel: vec3f,\n#endif\n\tclearcoat_worldNormal: vec3f,\n\tclearcoat_gloss: f32,\n\tsheen_gloss: f32,\n\tiridescence_intensity: f32\n) {\n\tvar cookieAttenuation: vec3f = vec3f(1.0);\n\tvar diffuseAttenuation: f32 = 1.0;\n\tvar falloffAttenuation: f32 = 1.0;\n\tlet lightDirW: vec3f = evalOmniLight(light.position);\n\tlet lightDirNormW: vec3f = normalize(lightDirW);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tfalloffAttenuation = getFalloffWindow(light.range, lightDirW);\n\t} else\n\t#endif\n\t{\n\t\tif (light.falloffModeLinear) {\n\t\t\tfalloffAttenuation = getFalloffLinear(light.range, lightDirW);\n\t\t} else {\n\t\t\tfalloffAttenuation = getFalloffInvSquared(light.range, lightDirW);\n\t\t}\n\t}\n\tif (falloffAttenuation > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\tdiffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\tdiffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else {\n\t\t\t\tdiffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tfalloffAttenuation = falloffAttenuation * getLightDiffuse(worldNormal, viewDir, lightDirNormW);\n\t\t}\n\t\tif (light.isSpot) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tfalloffAttenuation = falloffAttenuation * getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n\t\tif (falloffAttenuation > 0.00001) {\n\t\t\tif (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {\n\t\t\t\tif (light.isSpot) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tlet shadowTextureResolution: f32 = uniform.shadowAtlasParams.x;\n\t\t\t\tlet shadowEdgePixels: f32 = uniform.shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (light.cookieIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tcookieAttenuation = getCookie2DClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcookieAttenuation = getCookieCubeClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (light.shadowIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tlet shadowParams: vec4f = vec4f(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tlet shadowCoord: vec3f = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowSpotClusteredPCSS(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlet dir: vec3f = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\t{\n\t\t\t\tvar areaDiffuse: vec3f = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3f(0.0), dLTCSpecFres);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight = dDiffuseLight + areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvar areaLightSpecular: f32;\n\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n\t\t\t\t}\n\t\t\t\tdSpecularLight = dSpecularLight + dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\tvar areaLightSpecularCC: f32;\n\t\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight = ccSpecularLight + ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvar punctualDiffuse: vec3f = falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3f(0.0), specularity);\n\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight = dDiffuseLight + punctualDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tlet halfDir: vec3f = normalize(-lightDirNormW + viewDir);\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tdSpecularLight = dSpecularLight +\n\t\t\t\t\t\tgetLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation *\n\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\tdot(viewDir, halfDir),\n\t\t\t\t\t\t\tgloss,\n\t\t\t\t\t\t\tspecularity\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\tiridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t);\n\t\t\t\t#else\n\t\t\t\t\tdSpecularLight = dSpecularLight + getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\tccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n\t\t\t\t\t#else\n\t\t\t\t\t\tccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tsSpecularLight = sSpecularLight + getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n\tdAtten = falloffAttenuation;\n\tdLightDirNormW = lightDirNormW;\n}\nfn evaluateClusterLight(\n\tlightIndex: f32,\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\treflectionDir: vec3f,\n#if defined(LIT_CLEARCOAT)\n\tclearcoatReflectionDir: vec3f,\n#endif\n\tgloss: f32,\n\tspecularity: vec3f,\n\tgeometricNormal: vec3f,\n\ttbn: mat3x3f,\n#if defined(LIT_IRIDESCENCE)\n\tiridescenceFresnel: vec3f,\n#endif\n\tclearcoat_worldNormal: vec3f,\n\tclearcoat_gloss: f32,\n\tsheen_gloss: f32,\n\tiridescence_intensity: f32\n) {\n\tvar clusterLightData: ClusterLightData;\n\tdecodeClusterLightCore(&clusterLightData, lightIndex);\n\t#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t\tlet acceptLightMask: bool = clusterLightData.isDynamic;\n\t#else\n\t\tlet acceptLightMask: bool = clusterLightData.isLightmapped;\n\t#endif\n\tif (acceptLightMask) {\n\t\tevaluateLight(\n\t\t\t&clusterLightData,\n\t\t\tworldNormal,\n\t\t\tviewDir,\n\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\tgloss,\n\t\t\tspecularity,\n\t\t\tgeometricNormal,\n\t\t\ttbn,\n#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel,\n#endif\n\t\t\tclearcoat_worldNormal,\n\t\t\tclearcoat_gloss,\n\t\t\tsheen_gloss,\n\t\t\tiridescence_intensity\n\t\t);\n\t}\n}\nfn addClusteredLights(\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\treflectionDir: vec3f,\n#if defined(LIT_CLEARCOAT)\n\tclearcoatReflectionDir: vec3f,\n#endif\n\tgloss: f32,\n\tspecularity: vec3f,\n\tgeometricNormal: vec3f,\n\ttbn: mat3x3f,\n#if defined(LIT_IRIDESCENCE)\n\tiridescenceFresnel: vec3f,\n#endif\n\tclearcoat_worldNormal: vec3f,\n\tclearcoat_gloss: f32,\n\tsheen_gloss: f32,\n\tiridescence_intensity: f32\n) {\n\tif (uniform.clusterSkip > 0.5) {\n\t\treturn;\n\t}\n\tlet cellCoords: vec3f = floor((vPositionW - uniform.clusterBoundsMin) * uniform.clusterCellsCountByBoundsSize);\n\tif (!(any(cellCoords < vec3f(0.0)) || any(cellCoords >= uniform.clusterCellsMax))) {\n\t\tlet cellIndex: f32 = dot(uniform.clusterCellsDot, cellCoords);\n\t\tlet clusterV: f32 = floor(cellIndex * uniform.clusterTextureSize.y);\n\t\tlet clusterU: f32 = cellIndex - (clusterV * uniform.clusterTextureSize.x);\n\t\tfor (var lightCellIndex: i32 = 0; lightCellIndex < uniform.clusterMaxCells; lightCellIndex = lightCellIndex + 1) {\n\t\t\tlet lightIndexPacked: f32 = textureLoad(clusterWorldTexture, vec2<i32>(i32(clusterU) + lightCellIndex, i32(clusterV)), 0).r;\n\t\t\tif (lightIndexPacked <= 0.0) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tevaluateClusterLight(\n\t\t\t\tlightIndexPacked * 255.0,\n\t\t\t\tworldNormal,\n\t\t\t\tviewDir,\n\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\tgloss,\n\t\t\t\tspecularity,\n\t\t\t\tgeometricNormal,\n\t\t\t\ttbn,\n#if defined(LIT_IRIDESCENCE)\n\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\tclearcoat_worldNormal,\n\t\t\t\tclearcoat_gloss,\n\t\t\t\tsheen_gloss,\n\t\t\t\tiridescence_intensity\n\t\t\t);\n\t\t}\n\t}\n}',combinePS:"\nfn combineColor(albedo: vec3f, sheenSpecularity: vec3f, clearcoatSpecularity: f32) -> vec3f {\n\tvar ret: vec3f = vec3f(0.0);\n\t#ifdef LIT_OLD_AMBIENT\n\t\tret = ret + ((dDiffuseLight - uniform.light_globalAmbient) * albedo + uniform.material_ambient * uniform.light_globalAmbient);\n\t#else\n\t\tret = ret + (albedo * dDiffuseLight);\n\t#endif\n\t#ifdef LIT_SPECULAR\n\t\tret = ret + dSpecularLight;\n\t#endif\n\t#ifdef LIT_REFLECTIONS\n\t\tret = ret + (dReflection.rgb * dReflection.a);\n\t#endif\n\t#ifdef LIT_SHEEN\n\t\tlet sheenScaling: f32 = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n\t\tret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n\t#endif\n\t#ifdef LIT_CLEARCOAT\n\t\tlet clearCoatScaling: f32 = 1.0 - ccFresnel * clearcoatSpecularity;\n\t\tret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;\n\t#endif\n\treturn ret;\n}\n",cookieBlit2DPS:"\n\tvarying uv0: vec2f;\n\tvar blitTexture: texture_2d<f32>;\n\tvar blitTextureSampler : sampler;\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\toutput.color = textureSample(blitTexture, blitTextureSampler, input.uv0);\n\t\treturn output;\n\t}\n",cookieBlitCubePS:"\n\tvarying uv0: vec2f;\n\tuniform invViewProj: mat4x4<f32>;\n\tvar blitTexture: texture_cube<f32>;\n\tvar blitTextureSampler : sampler;\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\tvar projPos = vec4f(input.uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\tvar worldPos = uniform.invViewProj * projPos;\n\t\toutput.color = textureSample(blitTexture, blitTextureSampler, worldPos.xyz);\n\t\treturn output;\n\t}\n",cookieBlitVS:"\n\tattribute vertex_position: vec2f;\n\tvarying uv0: vec2f;\n\t@vertex\n\tfn vertexMain(input: VertexInput) -> VertexOutput {\n\t\tvar output: VertexOutput;\n\t\toutput.position = vec4f(input.vertex_position, 0.5, 1.0);\n\t\toutput.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n\t\toutput.uv0.y = 1.0 - output.uv0.y;\n\t\treturn output;\n\t}\n",cubeMapProjectPS:"\n#if LIT_CUBEMAP_PROJECTION == BOX\n\tuniform envBoxMin: vec3f;\n\tuniform envBoxMax: vec3f;\n#endif\nfn cubeMapProject(nrdir: vec3f) -> vec3f {\n\t#if LIT_CUBEMAP_PROJECTION == NONE\n\t\treturn cubeMapRotate(nrdir);\n\t#endif\n\t#if LIT_CUBEMAP_PROJECTION == BOX\n\t\tlet nrdir_rotated: vec3f = cubeMapRotate(nrdir);\n\t\tlet rbmax: vec3f = (uniform.envBoxMax - vPositionW) / nrdir_rotated;\n\t\tlet rbmin: vec3f = (uniform.envBoxMin - vPositionW) / nrdir_rotated;\n\t\tlet rbminmax: vec3f = select(rbmin, rbmax, nrdir_rotated > vec3f(0.0));\n\t\tlet fa: f32 = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\t\tlet posonbox: vec3f = vPositionW + nrdir_rotated * fa;\n\t\tlet envBoxPos: vec3f = (uniform.envBoxMin + uniform.envBoxMax) * 0.5;\n\t\treturn normalize(posonbox - envBoxPos);\n\t#endif\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform cubeMapRotationMatrix: mat3x3f;\n#endif\nfn cubeMapRotate(refDir: vec3f) -> vec3f {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * uniform.cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\noutput.color = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\noutput.color = vec4f(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\noutput.color = vec4f(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\noutput.color = vec4f(vec3f(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\noutput.color = vec4f(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\noutput.color = vec4f(vec3f(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\noutput.color = vec4f(vec3f(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\noutput.color = vec4f(vec3f(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\noutput.color = vec4f(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\n\tlitArgs_albedo = vec3f(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\n\tlitArgs_albedo = vec3f(vUv0, 0.0);\n#else\n\tlitArgs_albedo = vec3f(0.0);\n#endif\n#endif\n",detailModesPS:"\n#ifndef _DETAILMODES_INCLUDED_\n#define _DETAILMODES_INCLUDED_\nfn detailMode_mul(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn c1 * c2;\n}\nfn detailMode_add(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn c1 + c2;\n}\nfn detailMode_screen(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nfn detailMode_overlay(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3f(0.5)));\n}\nfn detailMode_min(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn min(c1, c2);\n}\nfn detailMode_max(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn max(c1, c2);\n}\n#endif\n",diffusePS:'\nuniform material_diffuse: vec3f;\n#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nfn getAlbedo() {\n\tdAlbedo = uniform.material_diffuse.rgb;\n\t#ifdef STD_DIFFUSE_TEXTURE\n\t\tvar albedoTexture: vec3f = {STD_DIFFUSE_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_NAME}Sampler, {STD_DIFFUSE_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t\t\tvar albedoDetail: vec3f = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_NAME}Sampler, {STD_DIFFUSEDETAIL_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};\n\t\t\talbedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);\n\t\t#endif\n\t\tdAlbedo = dAlbedo * albedoTexture;\n\t#endif\n\t#ifdef STD_DIFFUSE_VERTEX\n\t\tdAlbedo = dAlbedo * gammaCorrectInputVec3(saturate3(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));\n\t#endif\n}\n',decodePS:"\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\nfn decodeLinear(raw: vec4f) -> vec3f {\n\treturn raw.rgb;\n}\nfn decodeGammaFloat(raw: f32) -> f32 {\n\treturn pow(raw, 2.2);\n}\nfn decodeGamma3(raw: vec3f) -> vec3f {\n\treturn pow(raw, vec3f(2.2));\n}\nfn decodeGamma(raw: vec4f) -> vec3f {\n\treturn pow(raw.xyz, vec3f(2.2));\n}\nfn decodeRGBM(raw: vec4f) -> vec3f {\n\tlet color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nfn decodeRGBP(raw: vec4f) -> vec3f {\n\tlet color = raw.rgb * (-raw.a * 7.0 + 8.0);\n\treturn color * color;\n}\nfn decodeRGBE(raw: vec4f) -> vec3f {\n\treturn select(vec3f(0.0), raw.xyz * pow(2.0, raw.w * 255.0 - 128.0), raw.a != 0.0);\n}\nfn passThrough(raw: vec4f) -> vec4f {\n\treturn raw;\n}\nfn unpackNormalXYZ(nmap: vec4f) -> vec3f {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\nfn unpackNormalXY(nmap: vec4f) -> vec3f {\n\tvar xy = nmap.wy * 2.0 - 1.0;\n\treturn vec3f(xy, sqrt(1.0 - clamp(dot(xy, xy), 0.0, 1.0)));\n}\n#endif\n",emissivePS:"\nuniform material_emissive: vec3f;\nuniform material_emissiveIntensity: f32;\nfn getEmission() {\n\tdEmission = uniform.material_emissive * uniform.material_emissiveIntensity;\n\t#ifdef STD_EMISSIVE_TEXTURE\n\tdEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(textureSampleBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_NAME}Sampler, {STD_EMISSIVE_TEXTURE_UV}, uniform.textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_EMISSIVE_VERTEX\n\tdEmission = dEmission * gammaCorrectInputVec3(saturate3(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));\n\t#endif\n}\n",encodePS:"\nfn encodeLinear(source: vec3f) -> vec4f {\n\treturn vec4f(source, 1.0);\n}\nfn encodeGamma(source: vec3f) -> vec4f {\n\treturn vec4f(pow(source + vec3f(0.0000001), vec3f(1.0 / 2.2)), 1.0);\n}\nfn encodeRGBM(source: vec3f) -> vec4f {\n\tvar color: vec3f = pow(source, vec3f(0.5));\n\tcolor *= 1.0 / 8.0;\n\tvar a: f32 = saturate(max(max(color.r, color.g), max(color.b, 1.0 / 255.0)));\n\ta = ceil(a * 255.0) / 255.0;\n\tcolor /= a;\n\treturn vec4f(color, a);\n}\nfn encodeRGBP(source: vec3f) -> vec4f {\n\tvar gamma: vec3f = pow(source, vec3f(0.5));\n\tvar maxVal: f32 = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\tvar v: f32 = 1.0 - ((maxVal - 1.0) / 7.0);\n\tv = ceil(v * 255.0) / 255.0;\n\treturn vec4f(gamma / (-v * 7.0 + 8.0), v);\n}\nfn encodeRGBE(source: vec3f) -> vec4f {\n\tvar maxVal: f32 = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4f(0.0, 0.0, 0.0, 0.0);\n\t} else {\n\t\tvar e: f32 = ceil(log2(maxVal));\n\t\treturn vec4f(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\n",endPS:"\n\tvar finalRgb: vec3f = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\tfinalRgb = finalRgb + litArgs_emission;\n\tfinalRgb = addFog(finalRgb);\n\tfinalRgb = toneMap(finalRgb);\n\tfinalRgb = gammaCorrectOutput(finalRgb);\n\toutput.color = vec4f(finalRgb, output.color.a);\n",envAtlasPS:"\n#ifndef _ENVATLAS_INCLUDED_\n#define _ENVATLAS_INCLUDED_\nconst atlasSize : f32 = 512.0;\nconst seamSize : f32 = 1.0 / atlasSize;\nfn mapUv(uv : vec2f, rect : vec4f) -> vec2f {\n\treturn vec2f(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\t mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nfn mapRoughnessUv(uv : vec2f, level : f32) -> vec2f {\n\tlet t : f32 = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4f(0.0, 1.0 - t, t, t * 0.5));\n}\nfn mapShinyUv(uv : vec2f, level : f32) -> vec2f {\n\tlet t : f32 = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4f(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n#endif\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n\tuniform skyboxIntensity : f32;\n#endif\nfn processEnvironment(color : vec3f) -> vec3f {\n\t#ifdef LIT_SKYBOX_INTENSITY\n\t\treturn color * uniform.skyboxIntensity;\n\t#else\n\t\treturn color;\n\t#endif\n}\n",falloffInvSquaredPS:"\nfn getFalloffWindow(lightRadius: f32, lightDir: vec3f) -> f32 {\n\tlet sqrDist: f32 = dot(lightDir, lightDir);\n\tlet invRadius: f32 = 1.0 / lightRadius;\n\treturn square(saturate(1.0 - square(sqrDist * square(invRadius))));\n}\nfn getFalloffInvSquared(lightRadius: f32, lightDir: vec3f) -> f32 {\n\tlet sqrDist: f32 = dot(lightDir, lightDir);\n\tvar falloff: f32 = 1.0 / (sqrDist + 1.0);\n\tlet invRadius: f32 = 1.0 / lightRadius;\n\tfalloff = falloff * 16.0;\n\tfalloff = falloff * square(saturate(1.0 - square(sqrDist * square(invRadius))));\n\treturn falloff;\n}\n",falloffLinearPS:"\nfn getFalloffLinear(lightRadius: f32, lightDir: vec3f) -> f32 {\n\tlet d: f32 = length(lightDir);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatAsUintPS:"\n#ifndef FLOAT_AS_UINT\n#define FLOAT_AS_UINT\nfn float2uint(value: f32) -> vec4f {\n\tlet intBits = bitcast<u32>(value);\n\treturn vec4f(\n\t\tf32((intBits >> 24u) & 0xffu),\n\t\tf32((intBits >> 16u) & 0xffu),\n\t\tf32((intBits >> 8u) & 0xffu),\n\t\tf32(intBits & 0xffu)\n\t) / 255.0;\n}\nfn uint2float(value: vec4f) -> f32 {\n\tlet rgba_u32 = vec4<u32>(value * 255.0);\n\tlet intBits: u32 =\n\t\t(rgba_u32.r << 24u) |\n\t\t(rgba_u32.g << 16u) |\n\t\t(rgba_u32.b << 8u)  |\n\t\t rgba_u32.a;\n\treturn bitcast<f32>(intBits);\n}\nfn float2vec4(value: f32) -> vec4f {\n\t#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)\n\t\treturn vec4f(value, 1.0, 1.0, 1.0);\n\t#else\n\t\treturn float2uint(value);\n\t#endif\n}\n#endif\n",fogPS:"\nvar<private> dBlendModeFogFactor : f32 = 1.0;\n#if (FOG != NONE)\n\tuniform fog_color : vec3f;\n\t\n\t#if (FOG == LINEAR)\n\t\tuniform fog_start : f32;\n\t\tuniform fog_end : f32;\n\t#else\n\t\tuniform fog_density : f32;\n\t#endif\n#endif\nfn getFogFactor() -> f32 {\n\tlet depth = pcPosition.z / pcPosition.w;\n\tvar fogFactor : f32 = 0.0;\n\t#if (FOG == LINEAR)\n\t\tfogFactor = (uniform.fog_end - depth) / (uniform.fog_end - uniform.fog_start);\n\t#elif (FOG == EXP)\n\t\tfogFactor = exp(-depth * uniform.fog_density);\n\t#elif (FOG == EXP2)\n\t\tfogFactor = exp(-depth * depth * uniform.fog_density * uniform.fog_density);\n\t#endif\n\treturn clamp(fogFactor, 0.0, 1.0);\n}\nfn addFog(color : vec3f) -> vec3f {\n\t#if (FOG != NONE)\n\t\treturn mix(uniform.fog_color * dBlendModeFogFactor, color, getFogFactor());\n\t#else\n\t\treturn color;\n\t#endif\n}\n",fresnelSchlickPS:"\nfn getFresnel(\n\t\tcosTheta: f32,\n\t\tgloss: f32,\n\t\tspecularity: vec3f\n\t#if defined(LIT_IRIDESCENCE)\n\t\t, iridescenceFresnel: vec3f,\n\t\tiridescenceIntensity: f32\n\t#endif\n) -> vec3f {\n\tlet fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);\n\tlet glossSq: f32 = gloss * gloss;\n\tlet ret: vec3f = specularity + (max(vec3f(glossSq), specularity) - specularity) * fresnel;\n\t#if defined(LIT_IRIDESCENCE)\n\t\treturn mix(ret, iridescenceFresnel, iridescenceIntensity);\n\t#else\n\t\treturn ret;\n\t#endif\n}\nfn getFresnelCC(cosTheta: f32) -> f32 {\n\tlet fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);\n\treturn 0.04 + (1.0 - 0.04) * fresnel;\n}",frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:"\nattribute vertex_position: vec2f;\nvarying vUv0: vec2f;\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n\tvar output: VertexOutput;\n\toutput.position = vec4f(input.vertex_position, 0.5, 1.0);\n\toutput.vUv0 = input.vertex_position.xy * 0.5 + vec2f(0.5);\n\treturn output;\n}\n",gammaPS:'\n#include "decodePS"\n#if (GAMMA == SRGB)\n\tfn gammaCorrectInput(color: f32) -> f32 {\n\t\treturn decodeGammaFloat(color);\n\t}\n\tfn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n\t\treturn decodeGamma3(color);\n\t}\n\tfn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n\t\treturn vec4f(decodeGamma3(color.xyz), color.w);\n\t}\n\tfn gammaCorrectOutput(color: vec3f) -> vec3f {\n\t\treturn pow(color + 0.0000001, vec3f(1.0 / 2.2));\n\t}\n#else\n\tfn gammaCorrectInput(color: f32) -> f32 {\n\t\treturn color;\n\t}\n\tfn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n\t\treturn color;\n\t}\n\tfn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n\t\treturn color;\n\t}\n\tfn gammaCorrectOutput(color: vec3f) -> vec3f {\n\t\treturn color;\n\t}\n#endif\n',glossPS:"\n#ifdef STD_GLOSS_CONSTANT\n\tuniform material_gloss: f32;\n#endif\nfn getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef STD_GLOSS_CONSTANT\n\tdGlossiness = dGlossiness * uniform.material_gloss;\n\t#endif\n\t#ifdef STD_GLOSS_TEXTURE\n\tdGlossiness = dGlossiness * textureSampleBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_NAME}Sampler, {STD_GLOSS_TEXTURE_UV}, uniform.textureBias).{STD_GLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_GLOSS_VERTEX\n\tdGlossiness = dGlossiness * saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_GLOSS_INVERT\n\tdGlossiness = 1.0 - dGlossiness;\n\t#endif\n\tdGlossiness = dGlossiness + 0.0000001;\n}\n",gsplatCenterVS:"\nuniform matrix_model: mat4x4f;\nuniform matrix_view: mat4x4f;\nuniform matrix_projection: mat4x4f;\nfn initCenter(modelCenter: vec3f, center: ptr<function, SplatCenter>) -> bool {\n\tlet modelView: mat4x4f = uniform.matrix_view * uniform.matrix_model;\n\tlet centerView: vec4f = modelView * vec4f(modelCenter, 1.0);\n\tif (centerView.z > 0.0) {\n\t\treturn false;\n\t}\n\tvar centerProj: vec4f = uniform.matrix_projection * centerView;\n\tcenterProj.z = clamp(centerProj.z, 0.0, abs(centerProj.w));\n\tcenter.view = centerView.xyz / centerView.w;\n\tcenter.proj = centerProj;\n\tcenter.projMat00 = uniform.matrix_projection[0][0];\n\tcenter.modelView = modelView;\n\treturn true;\n}\n",gsplatCornerVS:"\nuniform viewport: vec2f;\nuniform camera_params: vec4f;\nfn initCorner(source: ptr<function, SplatSource>, center: ptr<function, SplatCenter>, corner: ptr<function, SplatCorner>) -> bool {\n\tvar covA: vec3f;\n\tvar covB: vec3f;\n\treadCovariance(source, &covA, &covB);\n\tlet Vrk = mat3x3f(\n\t\tvec3f(covA.x, covA.y, covA.z),\n\t\tvec3f(covA.y, covB.x, covB.y),\n\t\tvec3f(covA.z, covB.y, covB.z)\n\t);\n\tlet focal = uniform.viewport.x * center.projMat00;\n\tlet v = select(center.view.xyz, vec3f(0.0, 0.0, 1.0), uniform.camera_params.w == 1.0);\n\tlet J1 = focal / v.z;\n\tlet J2 = -J1 / v.z * v.xy;\n\tlet J = mat3x3f(\n\t\tvec3f(J1, 0.0, J2.x),\n\t\tvec3f(0.0, J1, J2.y),\n\t\tvec3f(0.0, 0.0, 0.0)\n\t);\n\tlet W = transpose(mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz));\n\tlet T = W * J;\n\tlet cov = transpose(T) * Vrk * T;\n\t#if GSPLAT_AA\n\t\tlet detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[1][0];\n\t\tlet detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[1][0];\n\t\tcorner.aaFactor = sqrt(detOrig / detBlur);\n\t#endif\n\tlet diagonal1 = cov[0][0] + 0.3;\n\tlet offDiagonal = cov[0][1];\n\tlet diagonal2 = cov[1][1] + 0.3;\n\tlet mid = 0.5 * (diagonal1 + diagonal2);\n\tlet radius = length(vec2f((diagonal1 - diagonal2) / 2.0, offDiagonal));\n\tlet lambda1 = mid + radius;\n\tlet lambda2 = max(mid - radius, 0.1);\n\tlet vmin = min(1024.0, min(uniform.viewport.x, uniform.viewport.y));\n\tlet l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);\n\tlet l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);\n\tif (l1 < 2.0 && l2 < 2.0) {\n\t\treturn false;\n\t}\n\tlet c = center.proj.ww / uniform.viewport;\n\tif (any((abs(center.proj.xy) - vec2f(max(l1, l2)) * c) > center.proj.ww)) {\n\t\treturn false;\n\t}\n\tlet diagonalVector = normalize(vec2f(offDiagonal, lambda1 - diagonal1));\n\tlet v1 = l1 * diagonalVector;\n\tlet v2 = l2 * vec2f(diagonalVector.y, -diagonalVector.x);\n\tcorner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;\n\tcorner.uv = source.cornerUV;\n\treturn true;\n}\n",gsplatColorVS:"\nvar splatColor: texture_2d<f32>;\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n\treturn textureLoad(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\nstruct SplatSource {\n\torder: u32,\n\tid: u32,\n\tuv: vec2<i32>,\n\tcornerUV: vec2f,\n}\nstruct SplatCenter {\n\tview: vec3f,\n\tproj: vec4f,\n\tmodelView: mat4x4f,\n\tprojMat00: f32,\n}\nstruct SplatCorner {\n\toffset: vec2f,\n\tuv: vec2f,\n\t#if GSPLAT_AA\n\t\taaFactor: f32,\n\t#endif\n}\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#if GSPLAT_COMPRESSED_DATA\n\t#include "gsplatCompressedDataVS"\n\t#if SH_BANDS > 0\n\t\t#include "gsplatCompressedSHVS"\n\t#endif\n#elif GSPLAT_SOGS_DATA\n\t#include "gsplatSogsDataVS"\n\t#include "gsplatSogsColorVS"\n\t#if SH_BANDS > 0\n\t\t#include "gsplatSogsSHVS"\n\t#endif\n#else\n\t#include "gsplatDataVS"\n\t#include "gsplatColorVS"\n\t#if SH_BANDS > 0\n\t\t#include "gsplatSHVS"\n\t#endif\n#endif\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nfn clipCorner(corner: ptr<function, SplatCorner>, alpha: f32) {\n\tlet clip: f32 = min(1.0, sqrt(-log(1.0 / (255.0 * alpha))) / 2.0);\n\tcorner.offset = corner.offset * clip;\n\tcorner.uv = corner.uv * clip;\n}\n',gsplatCompressedDataVS:"\nvar packedTexture: texture_2d<u32>;\nvar chunkTexture: texture_2d<f32>;\nvar<private> chunkDataA: vec4f;\nvar<private> chunkDataB: vec4f;\nvar<private> chunkDataC: vec4f;\nvar<private> chunkDataD: vec4f;\nvar<private> chunkDataE: vec4f;\nvar<private> packedData: vec4u;\nfn unpack111011(bits: u32) -> vec3f {\n\treturn (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu))) / vec3f(2047.0, 1023.0, 2047.0);\n}\nfn unpack8888(bits: u32) -> vec4f {\n\treturn vec4f(\n\t\tf32((bits >> 24u) & 0xffu),\n\t\tf32((bits >> 16u) & 0xffu),\n\t\tf32((bits >> 8u)  & 0xffu),\n\t\tf32(bits\t\t & 0xffu)\n\t) / 255.0;\n}\nconst norm_const: f32 = 1.0 / (sqrt(2.0) * 0.5);\nfn unpackRotation(bits: u32) -> vec4f {\n\tlet a = (f32((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;\n\tlet b = (f32((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;\n\tlet c = (f32(bits & 0x3ffu) / 1023.0 - 0.5) * norm_const;\n\tlet m = sqrt(1.0 - (a * a + b * b + c * c));\n\tlet mode = bits >> 30u;\n\tif (mode == 0u) { return vec4f(m, a, b, c); }\n\tif (mode == 1u) { return vec4f(a, m, b, c); }\n\tif (mode == 2u) { return vec4f(a, b, m, c); }\n\treturn vec4f(a, b, c, m);\n}\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n\tlet tex_size_u = textureDimensions(chunkTexture, 0);\n\tlet w: u32 = tex_size_u.x / 5u;\n\tlet chunkId: u32 = source.id / 256u;\n\tlet chunkUV: vec2<i32> = vec2<i32>(i32((chunkId % w) * 5u), i32(chunkId / w));\n\tchunkDataA = textureLoad(chunkTexture, chunkUV + vec2<i32>(0, 0), 0);\n\tchunkDataB = textureLoad(chunkTexture, chunkUV + vec2<i32>(1, 0), 0);\n\tchunkDataC = textureLoad(chunkTexture, chunkUV + vec2<i32>(2, 0), 0);\n\tchunkDataD = textureLoad(chunkTexture, chunkUV + vec2<i32>(3, 0), 0);\n\tchunkDataE = textureLoad(chunkTexture, chunkUV + vec2<i32>(4, 0), 0);\n\tpackedData = textureLoad(packedTexture, source.uv, 0);\n\treturn mix(chunkDataA.xyz, vec3f(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n\tlet r = unpack8888(packedData.w);\n\treturn vec4f(mix(chunkDataD.xyz, vec3f(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nfn getRotation() -> vec4f {\n\treturn unpackRotation(packedData.y);\n}\nfn getScale() -> vec3f {\n\treturn exp(mix(vec3f(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nfn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {\n\tlet rot = quatToMat3(getRotation());\n\tlet scale = getScale();\n\tlet M = transpose(mat3x3f(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\t*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\t*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nvar shTexture0: texture_2d<u32>;\nvar shTexture1: texture_2d<u32>;\nvar shTexture2: texture_2d<u32>;\nfn unpack8888s(bits: u32) -> vec4f {\n\tlet unpacked_u = (vec4<u32>(bits) >> vec4<u32>(0u, 8u, 16u, 24u)) & vec4<u32>(0xffu);\n\treturn vec4f(unpacked_u) * (8.0 / 255.0) - 4.0;\n}\nfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {\n\tlet shData0: vec4<u32> = textureLoad(shTexture0, source.uv, 0);\n\tlet shData1: vec4<u32> = textureLoad(shTexture1, source.uv, 0);\n\tlet shData2: vec4<u32> = textureLoad(shTexture2, source.uv, 0);\n\tlet r0 = unpack8888s(shData0.x);\n\tlet r1 = unpack8888s(shData0.y);\n\tlet r2 = unpack8888s(shData0.z);\n\tlet r3 = unpack8888s(shData0.w);\n\tlet g0 = unpack8888s(shData1.x);\n\tlet g1 = unpack8888s(shData1.y);\n\tlet g2 = unpack8888s(shData1.z);\n\tlet g3 = unpack8888s(shData1.w);\n\tlet b0 = unpack8888s(shData2.x);\n\tlet b1 = unpack8888s(shData2.y);\n\tlet b2 = unpack8888s(shData2.z);\n\tlet b3 = unpack8888s(shData2.w);\n\tsh[0] =  vec3f(r0.x, g0.x, b0.x);\n\tsh[1] =  vec3f(r0.y, g0.y, b0.y);\n\tsh[2] =  vec3f(r0.z, g0.z, b0.z);\n\tsh[3] =  vec3f(r0.w, g0.w, b0.w);\n\tsh[4] =  vec3f(r1.x, g1.x, b1.x);\n\tsh[5] =  vec3f(r1.y, g1.y, b1.y);\n\tsh[6] =  vec3f(r1.z, g1.z, b1.z);\n\tsh[7] =  vec3f(r1.w, g1.w, b1.w);\n\tsh[8] =  vec3f(r2.x, g2.x, b2.x);\n\tsh[9] =  vec3f(r2.y, g2.y, b2.y);\n\tsh[10] = vec3f(r2.z, g2.z, b2.z);\n\tsh[11] = vec3f(r2.w, g2.w, b2.w);\n\tsh[12] = vec3f(r3.x, g3.x, b3.x);\n\tsh[13] = vec3f(r3.y, g3.y, b3.y);\n\tsh[14] = vec3f(r3.z, g3.z, b3.z);\n\t*scale = 1.0;\n}\n#endif\n",gsplatEvalSHVS:"\n\t#if SH_BANDS == 1\n\t\tconst SH_COEFFS: i32 = 3;\n\t#elif SH_BANDS == 2\n\t\tconst SH_COEFFS: i32 = 8;\n\t#elif SH_BANDS == 3\n\t\tconst SH_COEFFS: i32 = 15;\n\t#else\n\t\tconst SH_COEFFS: i32 = 0;\n\t#endif\n\t#if SH_BANDS > 0\n\tconst SH_C1: f32 = 0.4886025119029199;\n\t#if SH_BANDS > 1\n\t\tconst SH_C2_0: f32 = 1.0925484305920792;\n\t\tconst SH_C2_1: f32 = -1.0925484305920792;\n\t\tconst SH_C2_2: f32 = 0.31539156525252005;\n\t\tconst SH_C2_3: f32 = -1.0925484305920792;\n\t\tconst SH_C2_4: f32 = 0.5462742152960396;\n\t#endif\n\t#if SH_BANDS > 2\n\t\tconst SH_C3_0: f32 = -0.5900435899266435;\n\t\tconst SH_C3_1: f32 = 2.890611442640554;\n\t\tconst SH_C3_2: f32 = -0.4570457994644658;\n\t\tconst SH_C3_3: f32 = 0.3731763325901154;\n\t\tconst SH_C3_4: f32 = -0.4570457994644658;\n\t\tconst SH_C3_5: f32 = 1.445305721320277;\n\t\tconst SH_C3_6: f32 = -0.5900435899266435;\n\t#endif\n\tfn evalSH(sh: ptr<function, array<vec3f, SH_COEFFS>>, dir: vec3f) -> vec3f {\n\t\tlet x = dir.x;\n\t\tlet y = dir.y;\n\t\tlet z = dir.z;\n\t\tvar result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n\t\t#if SH_BANDS > 1\n\t\t\tlet xx = x * x;\n\t\t\tlet yy = y * y;\n\t\t\tlet zz = z * z;\n\t\t\tlet xy = x * y;\n\t\t\tlet yz = y * z;\n\t\t\tlet xz = x * z;\n\t\t\tresult = result + (\n\t\t\t\tsh[3] * (SH_C2_0 * xy) +\n\t\t\t\tsh[4] * (SH_C2_1 * yz) +\n\t\t\t\tsh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n\t\t\t\tsh[6] * (SH_C2_3 * xz) +\n\t\t\t\tsh[7] * (SH_C2_4 * (xx - yy))\n\t\t\t);\n\t\t#endif\n\t\t#if SH_BANDS > 2\n\t\t\tresult = result + (\n\t\t\t\tsh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n\t\t\t\tsh[9]  * (SH_C3_1 * xy * z) +\n\t\t\t\tsh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n\t\t\t\tsh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n\t\t\t\tsh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n\t\t\t\tsh[13] * (SH_C3_5 * z * (xx - yy)) +\n\t\t\t\tsh[14] * (SH_C3_6 * x * (xx - 3.0 * yy))\n\t\t\t);\n\t\t#endif\n\t\treturn result;\n\t}\n\t#endif\n",gsplatQuatToMat3VS:"\nfn quatToMat3(R: vec4<f32>) -> mat3x3<f32> {\n\tlet R2: vec4<f32> = R + R;\n\tlet X: f32\t   = R2.x * R.w;\n\tlet Y: vec4<f32> = R2.y * R;\n\tlet Z: vec4<f32> = R2.z * R;\n\tlet W: f32\t   = R2.w * R.w;\n\treturn mat3x3<f32>(\n\t\t1.0 - Z.z - W,  Y.z + X,\t  Y.w - Z.x,\n\t\tY.z - X,\t\t1.0 - Y.y - W, Z.w + Y.x,\n\t\tY.w + Z.x,\t  Z.w - Y.x,\t 1.0 - Y.y - Z.z\n\t);\n}\n",gsplatSogsColorVS:"\nvar sh0: texture_2d<f32>;\nuniform sh0_mins: vec4f;\nuniform sh0_maxs: vec4f;\nconst SH_C0: f32 = 0.28209479177387814;\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n\tlet clr: vec4f = mix(uniform.sh0_mins, uniform.sh0_maxs, textureLoad(sh0, source.uv, 0));\n\treturn vec4f(vec3f(0.5) + clr.xyz * SH_C0, 1.0 / (1.0 + exp(-clr.w)));\n}\n",gsplatSogsDataVS:"\nvar packedTexture: texture_2d<u32>;\nuniform means_mins: vec3f;\nuniform means_maxs: vec3f;\nuniform scales_mins: vec3f;\nuniform scales_maxs: vec3f;\nfn unpackU32(u: u32) -> vec4f {\n\treturn vec4f(\n\t\tf32((u >> 24u) & 0xFFu) / 255.0,\n\t\tf32((u >> 16u) & 0xFFu) / 255.0,\n\t\tf32((u >> 8u) & 0xFFu) / 255.0,\n\t\tf32(u & 0xFFu) / 255.0\n\t);\n}\nvar<private> packedSample: vec4<u32>;\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n\tpackedSample = textureLoad(packedTexture, source.uv, 0);\n\tlet l: vec3f = unpackU32(packedSample.x).xyz;\n\tlet u: vec3f = unpackU32(packedSample.y).xyz;\n\tlet n: vec3f = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;\n\tlet v: vec3f = mix(uniform.means_mins, uniform.means_maxs, n);\n\treturn sign(v) * (exp(abs(v)) - 1.0);\n}\nconst norm: f32 = 2.0 / sqrt(2.0);\nfn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {\n\tlet qdata: vec4f = unpackU32(packedSample.z);\n\tlet sdata: vec3f = unpackU32(packedSample.w).xyz;\n\tlet abc: vec3f = (qdata.xyz - 0.5) * norm;\n\tlet d: f32 = sqrt(max(0.0, 1.0 - dot(abc, abc)));\n\tlet mode: u32 = u32(qdata.w * 255.0 + 0.5) - 252u;\n\tvar quat: vec4f;\n\tif (mode == 0u) {\n\t\tquat = vec4f(d, abc);\n\t} else if (mode == 1u) {\n\t\tquat = vec4f(abc.x, d, abc.y, abc.z);\n\t} else if (mode == 2u) {\n\t\tquat = vec4f(abc.x, abc.y, d, abc.z);\n\t} else {\n\t\tquat = vec4f(abc.x, abc.y, abc.z, d);\n\t}\n\tlet rot: mat3x3f = quatToMat3(quat);\n\tlet scale: vec3f = exp(mix(uniform.scales_mins, uniform.scales_maxs, sdata));\n\tlet M: mat3x3f = transpose(mat3x3f(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\t*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\t*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatSogsSHVS:"\nvar sh_centroids: texture_2d<f32>;\nuniform shN_mins: f32;\nuniform shN_maxs: f32;\nfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, SH_COEFFS>>, scale: ptr<function, f32>) {\n\tlet t: vec2<i32> = vec2<i32>(i32(packedSample.x & 255u), i32(packedSample.y & 255u));\n\tlet n: i32 = t.x + t.y * 256;\n\tlet u: i32 = (n % 64) * SH_COEFFS;\n\tlet v: i32 = n / 64;\n\tfor (var i: i32 = 0; i < SH_COEFFS; i = i + 1) {\n\t\tsh[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), textureLoad(sh_centroids, vec2<i32>(u + i, v), 0).xyz);\n\t}\n\t*scale = 1.0;\n}\n",gsplatDataVS:"\nvar transformA: texture_2d<u32>;\nvar transformB: texture_2d<f32>;\nvar<private> tAw: u32;\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n\tlet tA: vec4<u32> = textureLoad(transformA, source.uv, 0);\n\ttAw = tA.w;\n\treturn bitcast<vec3f>(tA.xyz);\n}\nfn unpackRotation(packed: vec3f) -> vec4f {\n\treturn vec4f(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));\n}\nfn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {\n\tlet tB: vec4f = textureLoad(transformB, source.uv, 0);\n\tlet rot: mat3x3f = quatToMat3(unpackRotation(vec3f(unpack2x16float(bitcast<u32>(tAw)), tB.w)).wxyz);\n\tlet scale: vec3f = tB.xyz;\n\tlet M = transpose(mat3x3f(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\t*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\t*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#include "decodePS"\n#include "gammaPS"\nfn prepareOutputFromGamma(gammaColor: vec3f) -> vec3f {\n\t#if TONEMAP == NONE\n\t\t#if GAMMA == NONE\n\t\t\treturn decodeGamma3(gammaColor);\n\t\t#else \n\t\t\treturn gammaColor;\n\t\t#endif\n\t#else\n\t\treturn gammaCorrectOutput(toneMap(decodeGamma3(gammaColor)));\n\t#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n\t#include "bayerPS"\n\t#include "opacityDitherPS"\n\tvarying id: f32;\n#endif\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\tuniform alphaClip: f32;\n#endif\n#ifdef PREPASS_PASS\n\tvarying vLinearDepth: f32;\n\t#include "floatAsUintPS"\n#endif\nconst EXP_A: f32\t  = 12102203.0;\nconst EXP_BC_RMS: i32 = 1064866808;\nfn fastExp(x: f32) -> f32 {\n\tvar i: i32 = i32(EXP_A * x) + EXP_BC_RMS;\n\treturn bitcast<f32>(i);\n}\nvarying gaussianUV: vec2f;\nvarying gaussianColor: vec4f;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\tlet A: f32 = dot(gaussianUV, gaussianUV);\n\tif (A > 1.0) {\n\t\tdiscard;\n\t\treturn output;\n\t}\n\tvar alpha: f32 = fastExp(-A * 4.0) * gaussianColor.a;\n\t#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\t\tif (alpha < uniform.alphaClip) {\n\t\t\tdiscard;\n\t\t\treturn output;\n\t\t}\n\t#endif\n\t#ifdef PICK_PASS\n\t\toutput.color = getPickOutput();\n\t#elif SHADOW_PASS\n\t\toutput.color = vec4f(0.0, 0.0, 0.0, 1.0);\n\t#elif PREPASS_PASS\n\t\toutput.color = float2vec4(vLinearDepth);\n\t#else\n\t\tif (alpha < (1.0 / 255.0)) {\n\t\t\tdiscard;\n\t\t\treturn output;\n\t\t}\n\t\t#ifndef DITHER_NONE\n\t\t\topacityDither(&alpha, id * 0.013);\n\t\t#endif\n\t\toutput.color = vec4f(input.gaussianColor.xyz * alpha, alpha);\n\t#endif\n\treturn output;\n}',gsplatSHVS:"\n#if SH_BANDS > 0\nfn unpack111011s(bits: u32) -> vec3f {\n\treturn (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu)) / vec3f(2047.0, 1023.0, 2047.0)) * 2.0 - 1.0;\n}\nstruct ScaleAndSH {\n\tscale: f32,\n\ta: vec3f,\n\tb: vec3f,\n\tc: vec3f\n};\nfn fetchScale(t_in: vec4<u32>) -> ScaleAndSH {\n\tvar result: ScaleAndSH;\n\tresult.scale = bitcast<f32>(t_in.x);\n\tresult.a = unpack111011s(t_in.y);\n\tresult.b = unpack111011s(t_in.z);\n\tresult.c = unpack111011s(t_in.w);\n\treturn result;\n}\nstruct SH {\n\ta: vec3f,\n\tb: vec3f,\n\tc: vec3f,\n\td: vec3f\n};\nfn fetch4(t_in: vec4<u32>) -> SH {\n\tvar result: SH;\n\tresult.a = unpack111011s(t_in.x);\n\tresult.b = unpack111011s(t_in.y);\n\tresult.c = unpack111011s(t_in.z);\n\tresult.d = unpack111011s(t_in.w);\n\treturn result;\n}\nfn fetch1(t_in: u32) -> vec3f {\n\treturn unpack111011s(t_in);\n}\n#if SH_BANDS == 1\n\tvar splatSH_1to3: texture_2d<u32>;\n\tfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 3>>, scale: ptr<function, f32>) {\n\t\tlet result = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));\n\t\t*scale = result.scale;\n\t\tsh[0] = result.a;\n\t\tsh[1] = result.b;\n\t\tsh[2] = result.c;\n\t}\n#elif SH_BANDS == 2\n\tvar splatSH_1to3: texture_2d<u32>;\n\tvar splatSH_4to7: texture_2d<u32>;\n\tvar splatSH_8to11: texture_2d<u32>;\n\tfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 8>>, scale: ptr<function, f32>) {\n\t\tlet first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));\n\t\t*scale = first.scale;\n\t\tsh[0] = first.a;\n\t\tsh[1] = first.b;\n\t\tsh[2] = first.c;\n\t\tlet second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));\n\t\tsh[3] = second.a;\n\t\tsh[4] = second.b;\n\t\tsh[5] = second.c;\n\t\tsh[6] = second.d;\n\t\tsh[7] = fetch1(textureLoad(splatSH_8to11, source.uv, 0).x);\n\t}\n#else\n\tvar splatSH_1to3: texture_2d<u32>;\n\tvar splatSH_4to7: texture_2d<u32>;\n\tvar splatSH_8to11: texture_2d<u32>;\n\tvar splatSH_12to15: texture_2d<u32>;\n\tfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {\n\t\tlet first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));\n\t\t*scale = first.scale;\n\t\tsh[0] = first.a;\n\t\tsh[1] = first.b;\n\t\tsh[2] = first.c;\n\t\tlet second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));\n\t\tsh[3] = second.a;\n\t\tsh[4] = second.b;\n\t\tsh[5] = second.c;\n\t\tsh[6] = second.d;\n\t\tlet third: SH = fetch4(textureLoad(splatSH_8to11, source.uv, 0));\n\t\tsh[7] = third.a;\n\t\tsh[8] = third.b;\n\t\tsh[9] = third.c;\n\t\tsh[10] = third.d;\n\t\tlet fourth: SH = fetch4(textureLoad(splatSH_12to15, source.uv, 0));\n\t\tsh[11] = fourth.a;\n\t\tsh[12] = fourth.b;\n\t\tsh[13] = fourth.c;\n\t\tsh[14] = fourth.d;\n\t}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vertex_position: vec3f;\nattribute vertex_id_attrib: u32;\nuniform numSplats: u32;\nvar splatOrder: texture_2d<u32>;\nfn initSource(source: ptr<function, SplatSource>) -> bool {\n\tlet w: u32 = textureDimensions(splatOrder, 0).x;\n\tsource.order = vertex_id_attrib + u32(vertex_position.z);\n\tif (source.order >= uniform.numSplats) {\n\t\treturn false;\n\t}\n\tlet orderUV = vec2i(vec2u(source.order % w, source.order / w));\n\tsource.id = textureLoad(splatOrder, orderUV, 0).r;\n\tsource.uv = vec2i(vec2u(source.id % w, source.id / w));\n\tsource.cornerUV = vertex_position.xy;\n\treturn true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying gaussianUV: vec2f;\nvarying gaussianColor: vec4f;\n#ifndef DITHER_NONE\n\tvarying id: f32;\n#endif\nconst discardVec: vec4f = vec4f(0.0, 0.0, 2.0, 1.0);\n#ifdef PREPASS_PASS\n\tvarying vLinearDepth: f32;\n#endif\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n\tvar output: VertexOutput;\n\tvar source: SplatSource;\n\tif (!initSource(&source)) {\n\t\toutput.position = discardVec;\n\t\treturn output;\n\t}\n\tlet modelCenter: vec3f = readCenter(&source);\n\tvar center: SplatCenter;\n\tif (!initCenter(modelCenter, &center)) {\n\t\toutput.position = discardVec;\n\t\treturn output;\n\t}\n\tvar corner: SplatCorner;\n\tif (!initCorner(&source, &center, &corner)) {\n\t\toutput.position = discardVec;\n\t\treturn output;\n\t}\n\tvar clr: vec4f = readColor(&source);\n\t#if GSPLAT_AA\n\t\tclr.a = clr.a * corner.aaFactor;\n\t#endif\n\t#if SH_BANDS > 0\n\t\tlet modelView3x3 = mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz);\n\t\tlet dir = normalize(modelView3x3 * center.view);\n\t\tvar sh: array<vec3f, SH_COEFFS>;\n\t\tvar scale: f32;\n\t\treadSHData(&source, &sh, &scale);\n\t\tclr = vec4f(clr.xyz + evalSH(&sh, dir) * scale, clr.a);\n\t#endif\n\tclipCorner(&corner, clr.w);\n\toutput.position = center.proj + vec4f(corner.offset, 0.0, 0.0);\n\toutput.gaussianUV = corner.uv;\n\toutput.gaussianColor = vec4f(prepareOutputFromGamma(max(clr.xyz, vec3f(0.0))), clr.w);\n\t#ifndef DITHER_NONE\n\t\toutput.id = f32(source.id);\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\toutput.vLinearDepth = -center.view.z;\n\t#endif\n\treturn output;\n}\n',quadVS:"\n\tattribute aPosition: vec2f;\n\tvarying uv0: vec2f;\n\t@vertex fn vertexMain(input: VertexInput) -> VertexOutput {\n\t\tvar output: VertexOutput;\n\t\toutput.position = vec4f(input.aPosition, 0.0, 1.0);\n\t\toutput.uv0 = getImageEffectUV((input.aPosition + 1.0) * 0.5);\n\t\treturn output;\n\t}\n",indirectCoreCS:"\nstruct DrawIndexedIndirectArgs {\n\tindexCount: u32,\n\tinstanceCount: u32,\n\tfirstIndex: u32,\n\tbaseVertex: i32,\n\tfirstInstance: u32\n};\nstruct DrawIndirectArgs {\n\tvertexCount: u32,\n\tinstanceCount: u32,\n\tfirstVertex: u32,\n\tfirstInstance: u32,\n\t_pad: u32\n};\n",immediateLinePS:'\n\t#include "gammaPS"\n\tvarying color: vec4f;\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\toutput.color = vec4f(gammaCorrectOutput(decodeGamma3(input.color.rgb)), input.color.a);\n\t\treturn output;\n\t}\n',immediateLineVS:"\n\tattribute vertex_position: vec4f;\n\tattribute vertex_color: vec4f;\n\tuniform matrix_model: mat4x4f;\n\tuniform matrix_viewProjection: mat4x4f;\n\tvarying color: vec4f;\n\t@vertex\n\tfn vertexMain(input : VertexInput) -> VertexOutput {\n\t\tvar output : VertexOutput;\n\t\toutput.color = input.vertex_color;\n\t\toutput.position = uniform.matrix_viewProjection * uniform.matrix_model * input.vertex_position;\n\t\treturn output;\n\t}\n",iridescenceDiffractionPS:"\nuniform material_iridescenceRefractionIndex: f32;\nfn iridescence_iorToFresnelScalar(transmittedIor: f32, incidentIor: f32) -> f32 {\n\treturn pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nfn iridescence_iorToFresnelVec3(transmittedIor: vec3f, incidentIor: f32) -> vec3f {\n\treturn pow((transmittedIor - vec3f(incidentIor)) / (transmittedIor + vec3f(incidentIor)), vec3f(2.0));\n}\nfn iridescence_fresnelToIor(f0: vec3f) -> vec3f {\n\tlet sqrtF0: vec3f = sqrt(f0);\n\treturn (vec3f(1.0) + sqrtF0) / (vec3f(1.0) - sqrtF0);\n}\nconst XYZ_TO_REC709: mat3x3f = mat3x3f(\n\tvec3f(3.2404542, -1.5371385, -0.4985314),\n\tvec3f(-0.9692660,  1.8760108,  0.0415560),\n\tvec3f(0.0556434, -0.2040259,  1.0572252)\n);\nfn iridescence_sensitivity(opd: f32, shift: vec3f) -> vec3f {\n\tlet PI: f32 = 3.141592653589793;\n\tlet phase: f32 = 2.0 * PI * opd * 1.0e-9;\n\tconst val: vec3f = vec3f(5.4856e-13, 4.4201e-13, 5.2481e-13);\n\tconst pos: vec3f = vec3f(1.6810e+06, 1.7953e+06, 2.2084e+06);\n\tconst var_: vec3f = vec3f(4.3278e+09, 9.3046e+09, 6.6121e+09);\n\tvar xyz: vec3f = val * sqrt(2.0 * PI * var_) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var_);\n\txyz.x = xyz.x + 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n\txyz = xyz / vec3f(1.0685e-07);\n\treturn XYZ_TO_REC709 * xyz;\n}\nfn iridescence_fresnelScalar(cosTheta: f32, f0: f32) -> f32 {\n\tlet x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tlet x2: f32 = x * x;\n\tlet x5: f32 = x * x2 * x2;\n\treturn f0 + (1.0 - f0) * x5;\n}\nfn iridescence_fresnelVec3(cosTheta: f32, f0: vec3f) -> vec3f {\n\tlet x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tlet x2: f32 = x * x;\n\tlet x5: f32 = x * x2 * x2;\n\treturn f0 + (vec3f(1.0) - f0) * x5;\n}\nfn calcIridescence(outsideIor: f32, cosTheta: f32, base_f0: vec3f, iridescenceThickness: f32) -> vec3f {\n\tlet PI: f32 = 3.141592653589793;\n\tlet iridescenceIor: f32 = mix(outsideIor, uniform.material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n\tlet sinTheta2Sq: f32 = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n\tlet cosTheta2Sq: f32 = 1.0 - sinTheta2Sq;\n\tif (cosTheta2Sq < 0.0) {\n\t\treturn vec3f(1.0);\n\t}\n\tlet cosTheta2: f32 = sqrt(cosTheta2Sq);\n\tlet r0: f32 = iridescence_iorToFresnelScalar(iridescenceIor, outsideIor);\n\tlet r12: f32 = iridescence_fresnelScalar(cosTheta, r0);\n\tlet r21: f32 = r12;\n\tlet t121: f32 = 1.0 - r12;\n\tlet phi12: f32 = select(0.0, PI, iridescenceIor < outsideIor);\n\tlet phi21: f32 = PI - phi12;\n\tlet baseIor: vec3f = iridescence_fresnelToIor(base_f0 + vec3f(0.0001));\n\tlet r1: vec3f = iridescence_iorToFresnelVec3(baseIor, iridescenceIor);\n\tlet r23: vec3f = iridescence_fresnelVec3(cosTheta2, r1);\n\tlet phi23: vec3f = select(vec3f(0.0), vec3f(PI), baseIor < vec3f(iridescenceIor));\n\tlet opd: f32 = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n\tlet phi: vec3f = vec3f(phi21) + phi23;\n\tlet r123Sq: vec3f = clamp(vec3f(r12) * r23, vec3f(1e-5), vec3f(0.9999));\n\tlet r123: vec3f = sqrt(r123Sq);\n\tlet rs: vec3f = pow(vec3f(t121), vec3f(2.0)) * r23 / (vec3f(1.0) - r123Sq);\n\tlet c0: vec3f = vec3f(r12) + rs;\n\tvar i_irid: vec3f = c0;\n\tvar cm: vec3f = rs - vec3f(t121);\n\tcm = cm * r123;\n\tlet sm1: vec3f = 2.0 * iridescence_sensitivity(1.0 * opd, 1.0 * phi);\n\ti_irid = i_irid + cm * sm1;\n\tcm = cm * r123;\n\tlet sm2: vec3f = 2.0 * iridescence_sensitivity(2.0 * opd, 2.0 * phi);\n\ti_irid = i_irid + cm * sm2;\n\treturn max(i_irid, vec3f(0.0));\n}\nfn getIridescenceDiffraction(cosTheta: f32, specularity: vec3f, iridescenceThickness: f32) -> vec3f {\n\treturn calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef STD_IRIDESCENCE_CONSTANT\n\tuniform material_iridescence: f32;\n#endif\nfn getIridescence() {\n\tvar iridescence = 1.0;\n\t#ifdef STD_IRIDESCENCE_CONSTANT\n\tiridescence = iridescence * uniform.material_iridescence;\n\t#endif\n\t#ifdef STD_IRIDESCENCE_TEXTURE\n\tiridescence = iridescence * textureSampleBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_NAME}Sampler, {STD_IRIDESCENCE_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};\n\t#endif\n\tdIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform material_iridescenceThicknessMax: f32;\n#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n\tuniform material_iridescenceThicknessMin: f32;\n#endif\nfn getIridescenceThickness() {\n\t#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n\t\tvar blend: f32 = textureSampleBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}Sampler, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};\n\t\tvar iridescenceThickness: f32 = mix(uniform.material_iridescenceThicknessMin, uniform.material_iridescenceThicknessMax, blend);\n\t#else\n\t\tvar iridescenceThickness: f32 = uniform.material_iridescenceThicknessMax;\n\t#endif\n\tdIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef STD_IOR_CONSTANT\n\tuniform material_refractionIndex: f32;\n#endif\nfn getIor() {\n#ifdef STD_IOR_CONSTANT\n\tdIor = uniform.material_refractionIndex;\n#else\n\tdIor = 1.0 / 1.5;\n#endif\n}\n",lightDeclarationPS:"\n#if defined(LIGHT{i})\n\tuniform light{i}_color: vec3f;\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tuniform light{i}_direction: vec3f;\n\t#else\n\t\t#define LIT_CODE_LIGHTS_POINT\n\t\tuniform light{i}_position: vec3f;\n\t\tuniform light{i}_radius: f32;\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#define LIT_CODE_LIGHTS_SPOT\n\t\t\tuniform light{i}_direction: vec3f;\n\t\t\tuniform light{i}_innerConeAngle: f32;\n\t\t\tuniform light{i}_outerConeAngle: f32;\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform light{i}_position: vec3f;\n\t\t#endif\n\t\tuniform light{i}_halfWidth: vec3f;\n\t\tuniform light{i}_halfHeight: vec3f;\n\t#else\n\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t#define LIT_CODE_FALLOFF_LINEAR\n\t\t#endif\n\t\t#if LIGHT{i}FALLOFF == INVERSESQUARED\n\t\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}CASTSHADOW)\n\t\tuniform light{i}_shadowMatrix: mat4x4f;\n\t\tuniform light{i}_shadowIntensity: f32;\n\t\tuniform light{i}_shadowParams: vec4f;\n\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\tuniform light{i}_shadowSearchArea: f32;\n\t\t\tuniform light{i}_cameraParams: vec4f;\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t\tuniform light{i}_softShadowParams: vec4f;\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform light{i}_shadowMatrixPalette: array<mat4x4f, 4>;\n\t\t\tuniform light{i}_shadowCascadeDistances: vec4f;\n\t\t\tuniform light{i}_shadowCascadeCount: i32;\n\t\t\tuniform light{i}_shadowCascadeBlend: f32;\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\tNOT SUPPORTED\n\t\t\t\n\t\t#else\n\t\t\t#if defined(LIGHT{i}SHADOW_PCF)\n\t\t\t\tvar light{i}_shadowMap: texture_depth_2d;\n\t\t\t\tvar light{i}_shadowMapSampler: sampler_comparison;\n\t\t\t#else\n\t\t\t\tvar light{i}_shadowMap: texture_2d<f32>;\n\t\t\t\tvar light{i}_shadowMapSampler: sampler;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}COOKIE)\n\t\t#define LIT_CODE_COOKIE\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\tNOT SUPPORTED\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\tNOT SUPPORTED\n\t\t#endif\n\t#endif\n#endif\n",lightDiffuseLambertPS:"\nfn getLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f) -> f32 {\n\treturn max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nfn evalOmniLight(lightPosW: vec3f) -> vec3f {\n\treturn vPositionW - lightPosW;\n}\n",lightEvaluationPS:"\n#if defined(LIGHT{i})\n\tevaluateLight{i}(\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel\n\t\t#endif\n\t);\n#endif\n",lightFunctionLightPS:"\n#if defined(LIGHT{i})\nfn evaluateLight{i}(\n\t#if defined(LIT_IRIDESCENCE)\n\t\tiridescenceFresnel: vec3f\n\t#endif\n) {\n\tvar lightColor: vec3f = uniform.light{i}_color;\n\t#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)\n\t\tif (all(lightColor == vec3f(0.0, 0.0, 0.0))) {\n\t\t\treturn;\n\t\t}\n\t#endif\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tdLightDirNormW = uniform.light{i}_direction;\n\t\tdAtten = 1.0;\n\t#else\n\t\tvar lightDirW: vec3f = evalOmniLight(uniform.light{i}_position);\n\t\tdLightDirNormW = normalize(lightDirW);\n\t\t#if defined(LIGHT{i}COOKIE)\n\t\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t\t#ifdef LIGHT{i}COOKIE_FALLOFF\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvar cookieAttenuation: vec3f = getCookie2DXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvar cookieAttenuation: vec3f = getCookie2D(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvar cookieAttenuation: vec3f = getCookie2DClipXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvar cookieAttenuation: vec3f = getCookie2DClip(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t\tvar cookieAttenuation: vec3f = getCookieCube(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t#endif\n\t\t\tlightColor = lightColor * cookieAttenuation;\n\t\t#endif\n\t\t#if LIGHT{i}SHAPE == PUNCTUAL\n\t\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t\tdAtten = getFalloffLinear(uniform.light{i}_radius, lightDirW);\n\t\t\t#else\n\t\t\t\tdAtten = getFalloffInvSquared(uniform.light{i}_radius, lightDirW);\n\t\t\t#endif\n\t\t#else\n\t\t\tdAtten = getFalloffWindow(uniform.light{i}_radius, lightDirW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)\n\t\t\t\tdAtten = dAtten * getSpotEffect(uniform.light{i}_direction, uniform.light{i}_innerConeAngle, uniform.light{i}_outerConeAngle, dLightDirNormW);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tif (dAtten < 0.00001) {\n\t\treturn;\n\t}\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\tcalcRectLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\tcalcDiskLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\tcalcSphereLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tvar attenDiffuse: f32 = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);\n\t\t#else\n\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\tvar attenDiffuse: f32 = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\tvar attenDiffuse: f32 = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\tvar attenDiffuse: f32 = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tdAtten = dAtten * getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);\n\t#endif\n\t#ifdef LIGHT{i}CASTSHADOW\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tvar shadow: f32 = getShadow{i}(vec3(0.0));\n\t\t#else\n\t\t\tvar shadow: f32 = getShadow{i}(lightDirW);\n\t\t#endif\n\t\tshadow = mix(1.0, shadow, uniform.light{i}_shadowIntensity);\n\t\tdAtten = dAtten * shadow;\n\t\t#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tdShadowCatcher = dShadowCatcher * shadow;\n\t\t#endif\t\t\t\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight = dDiffuseLight + (((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres));\n\t\t#else\n\t\t\tdDiffuseLight = dDiffuseLight + ((attenDiffuse * dAtten) * lightColor);\n\t\t#endif\t\t\t\t\t\t\n\t#else\n\t\t#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)\n\t\t\tdDiffuseLight = dDiffuseLight + ((dAtten * lightColor) * (1.0 - litArgs_specularity));\n\t\t#else\n\t\t\tdDiffuseLight = dDiffuseLight + (dAtten * lightColor);\n\t\t#endif\n\t#endif\n\t#ifdef LIGHT{i}AFFECT_SPECULARITY\n\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tdSpecularLight = dSpecularLight + (dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tdSpecularLight = dSpecularLight + (dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tdSpecularLight = dSpecularLight + (dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#else\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE\n\t\t\t\t#define LIGHT{i}FRESNEL\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvar halfDirW: vec3f = normalize(-dLightDirNormW + dViewDirW);\n\t\t\t#endif\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tvar lightspecularCC: vec3f = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\tlightspecularCC = lightspecularCC * getFresnelCC(dot(dViewDirW, halfDirW));\n\t\t\t\t#endif\n\t\t\t\tccSpecularLight = ccSpecularLight + lightspecularCC;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tsSpecularLight = sSpecularLight + (getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor);\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvar lightSpecular: vec3f = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tlightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);\n\t\t\t\t\t#else\n\t\t\t\t\t\tlightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\tlightSpecular = lightSpecular * litArgs_specularity;\n\t\t\t\t#endif\n\t\t\t\t\n\t\t\t\tdSpecularLight = dSpecularLight + lightSpecular;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n}\n#endif\n",lightFunctionShadowPS:"\n#ifdef LIGHT{i}CASTSHADOW\n\tfn getShadowSampleCoord{i}(shadowTransform: mat4x4f, shadowParams: vec4f, worldPosition: vec3f, lightPos: vec3f, lightDir: ptr<function, vec3f>, lightDirNorm: vec3f, normal: vec3f) -> vec3f {\n\t\tvar surfacePosition = worldPosition;\n\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\tlet distScale: f32 = length(*lightDir);\n\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\t*lightDir = surfacePosition - lightPos;\n\t\t\t\treturn *lightDir;\n\t\t\t#endif\n\t\t#else\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y;\n\t\t\t\t#endif\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\t\t\tvar distScale: f32 = 1.0;\n\t\t\t\t\t#else\n\t\t\t\t\t\tvar distScale: f32 = abs(dot(vPositionW - lightPos, lightDirNorm));\n\t\t\t\t\t#endif\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\tvar positionInShadowSpace: vec4f = shadowTransform * vec4f(surfacePosition, 1.0);\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\tpositionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t\tpositionInShadowSpace.xyz = positionInShadowSpace.xyz / positionInShadowSpace.w;\n\t\t\t\t#else\n\t\t\t\t\tpositionInShadowSpace.xy = positionInShadowSpace.xy / positionInShadowSpace.w;\n\t\t\t\t\tpositionInShadowSpace.z = length(*lightDir) * shadowParams.w;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef SHADOW_SAMPLE_Z_BIAS\n\t\t\t#endif\n\t\t\tsurfacePosition = positionInShadowSpace.xyz;\n\t\t#endif\n\t\treturn surfacePosition;\n\t}\n\tfn getShadow{i}(lightDirW_in: vec3f) -> f32 {\n\t\t#ifdef LIGHT{i}_SHADOW_CASCADES\n\t\t\tvar cascadeIndex: i32 = getShadowCascadeIndex(uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount);\n\t\t\t#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND\n\t\t\t\tcascadeIndex = ditherShadowCascadeIndex(cascadeIndex, uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount, uniform.light{i}_shadowCascadeBlend);\n\t\t\t#endif\n\t\t\tvar shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrixPalette[cascadeIndex];\n\t\t#else\n\t\t\tvar shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrix;\n\t\t#endif\n\t\tvar lightDirArg = lightDirW_in;\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tvar shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, vec3f(0.0), &lightDirArg, dLightDirNormW, dVertexNormalW);\n\t\t#else\n\t\t\t var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, uniform.light{i}_position, &lightDirArg, dLightDirNormW, dVertexNormalW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tshadowCoord = fadeShadow(shadowCoord, uniform.light{i}_shadowCascadeDistances);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tlet shadowSearchArea = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;\n\t\t\t\t\treturn getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);\n\t\t\t\t#else\n\t\t\t\t\treturn getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, uniform.light{i}_softShadowParams, lightDirW_in);\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowSpotVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowSpotVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvar shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvar shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowSpotPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowSpotPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowSpotPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowSpotPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t var shadowSearchArea: vec2f;\n\t\t\t\t #if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvar shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvar shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowOmniPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowOmniPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowOmniPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);\n\t\t\t#endif\n\t\t#endif\n\t}\n#endif\n",lightingPS:'\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#define LIT_CODE_FALLOFF_LINEAR\n\t#define LIT_CODE_FALLOFF_SQUARED\n\t#define LIT_CODE_LIGHTS_POINT\n\t#define LIT_CODE_LIGHTS_SPOT\n#endif\n#ifdef AREA_LIGHTS\n\tvar areaLightsLutTex1: texture_2d<f32>;\n\tvar areaLightsLutTex1Sampler: sampler;\n\tvar areaLightsLutTex2: texture_2d<f32>;\n\tvar areaLightsLutTex2Sampler: sampler;\n#endif\n#ifdef LIT_LIGHTING\n\t#include "lightDiffuseLambertPS"\n\t#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n\t\t#include "ltcPS"\n\t#endif\n#endif\n#ifdef SHADOW_DIRECTIONAL\n\t#include "shadowCascadesPS"\n#endif\n#if defined(SHADOW_KIND_PCF1)\n\t#include "shadowPCF1PS"\n#endif\n#if defined(SHADOW_KIND_PCF3)\n\t#include "shadowPCF3PS"\n#endif\n#if defined(SHADOW_KIND_PCF5)\n\t#include "shadowPCF5PS"\n#endif\n#if defined(SHADOW_KIND_PCSS)\n\t#include "linearizeDepthPS"\n\t#include "shadowSoftPS"\n#endif\n#if defined(SHADOW_KIND_VSM)\n\t#include "shadowEVSMPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_LINEAR\n\t#include "falloffLinearPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_SQUARED\n\t#include "falloffInvSquaredPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_POINT\n\t#include "lightDirPointPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_SPOT\n\t#include "spotPS"\n#endif\n#ifdef LIT_CODE_COOKIE\n\t#include "cookiePS"\n#endif\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#include "clusteredLightPS"\n#endif\n#ifdef LIGHT_COUNT > 0\n\t#include "lightFunctionShadowPS, LIGHT_COUNT"\n\t#include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',lightmapAddPS:"\nfn addLightMap(\n\tlightmap: vec3f,\n\tdir: vec3f,\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\treflectionDir: vec3f,\n\tgloss: f32,\n\tspecularity: vec3f,\n\tvertexNormal: vec3f,\n\ttbn: mat3x3f\n#if defined(LIT_IRIDESCENCE)\n\t, iridescenceFresnel: vec3f,\n\tiridescenceIntensity: f32\n#endif\n) {\n\t#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)\n\t\tif (dot(dir, dir) < 0.0001) {\n\t\t\t\tdDiffuseLight = dDiffuseLight + lightmap;\n\t\t} else {\n\t\t\tlet vlight: f32 = saturate(dot(dir, -vertexNormal));\n\t\t\tlet flight: f32 = saturate(dot(dir, -worldNormal));\n\t\t\tlet nlight: f32 = (flight / max(vlight, 0.01)) * 0.5;\n\t\t\tdDiffuseLight = dDiffuseLight + lightmap * nlight * 2.0;\n\t\t\tlet halfDir: vec3f = normalize(-dir + viewDir);\n\t\t\tvar specularLight: vec3f = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\tspecularLight = specularLight *\n\t\t\t\t\tgetFresnel(dot(viewDir, halfDir),\n\t\t\t\t\tgloss,\n\t\t\t\t\tspecularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\tiridescenceIntensity\n\t\t\t\t#endif\n\t\t\t\t\t);\n\t\t\t#endif\n\t\t\tdSpecularLight = dSpecularLight + specularLight;\n\t\t}\n\t#else\n\t\tdDiffuseLight = dDiffuseLight + lightmap;\n\t#endif\n}\n",lightmapPS:"\n#ifdef STD_LIGHTMAP_DIR\n\tvar<private> dLightmapDir: vec3f;\n\tvar texture_dirLightMap: texture_2d<f32>;\n\tvar texture_dirLightMapSampler: sampler;\n#endif\nfn getLightMap() {\n\tdLightmap = vec3f(1.0);\n\t#ifdef STD_LIGHT_TEXTURE\n\t\tdLightmap = dLightmap * {STD_LIGHT_TEXTURE_DECODE}(textureSampleBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_NAME}Sampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};\n\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\tvar dir: vec3f = textureSampleBias(texture_dirLightMap, texture_dirLightMapSampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias).xyz * 2.0 - 1.0;\n\t\t\tvar dirDot = dot(dir, dir);\n\t\t\tdLightmapDir = select(vec3(0.0), dir / sqrt(dirDot), dirDot > 0.001);\n\t\t#endif\n\t#endif\n\t#ifdef STD_LIGHT_VERTEX\n\t\tdLightmap = dLightmap * saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});\n\t#endif\n}\n",lightSpecularAnisoGGXPS:"\nfn calcLightSpecular(gloss: f32, worldNormal: vec3f, viewDir: vec3f, h: vec3f, lightDirNorm: vec3f, tbn: mat3x3f) -> f32 {\n\tlet PI: f32 = 3.141592653589793;\n\tlet roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\tlet alphaRoughness: f32 = roughness * roughness;\n\tlet anisotropy: f32 = dAnisotropy;\n\tlet direction: vec2f = dAnisotropyRotation;\n\tlet at: f32 = mix(alphaRoughness, 1.0, anisotropy * anisotropy);\n\tlet ab: f32 = clamp(alphaRoughness, 0.001, 1.0);\n\tlet anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));\n\tlet anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));\n\tlet NoH: f32 = dot(worldNormal, h);\n\tlet ToH: f32 = dot(anisotropicT, h);\n\tlet BoH: f32 = dot(anisotropicB, h);\n\tlet a2: f32 = at * ab;\n\tlet v: vec3f = vec3f(ab * ToH, at * BoH, a2 * NoH);\n\tlet v2: f32 = dot(v, v);\n\tlet w2: f32 = a2 / v2;\n\tlet D: f32 = a2 * w2 * w2 * (1.0 / PI);\n\tlet ToV: f32 = dot(anisotropicT, viewDir);\n\tlet BoV: f32 = dot(anisotropicB, viewDir);\n\tlet ToL: f32 = dot(anisotropicT, -lightDirNorm);\n\tlet BoL: f32 = dot(anisotropicB, -lightDirNorm);\n\tlet NoV: f32 = dot(worldNormal, viewDir);\n\tlet NoL: f32 = dot(worldNormal, -lightDirNorm);\n\tlet lambdaV: f32 = NoL * length(vec3f(at * ToV, ab * BoV, NoV));\n\tlet lambdaL: f32 = NoV * length(vec3f(at * ToL, ab * BoL, NoL));\n\tlet G: f32 = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {\n\treturn calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfn calcLightSpecular(gloss: f32, worldNormal: vec3f, h: vec3f) -> f32 {\n\tlet nh: f32 = max( dot( h, worldNormal ), 0.0 );\n\tvar specPow: f32 = exp2(gloss * 11.0);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {\n\treturn calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfn sheenD(normal: vec3f, h: vec3f, roughness: f32) -> f32 {\n\tlet PI: f32 = 3.141592653589793;\n\tlet invR: f32 = 1.0 / (roughness * roughness);\n\tvar cos2h: f32 = max(dot(normal, h), 0.0);\n\tcos2h = cos2h * cos2h;\n\tlet sin2h: f32 = max(1.0 - cos2h, 0.0078125);\n\treturn (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfn sheenV(normal: vec3f, viewDir: vec3f, light: vec3f) -> f32 {\n\tlet NoV: f32 = max(dot(normal, viewDir), 0.000001);\n\tlet NoL: f32 = max(dot(normal, light), 0.000001);\n\treturn 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfn getLightSpecularSheen(h: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, sheenGloss: f32) -> f32 {\n\tlet D: f32 = sheenD(worldNormal, h, sheenGloss);\n\tlet V: f32 = sheenV(worldNormal, viewDir, -lightDirNorm);\n\treturn D * V;\n}",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfn linearizeDepthWithParams(z: f32, cameraParams: vec4f) -> f32 {\n\tif (cameraParams.w == 0.0) {\n\t\treturn (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n\t} else {\n\t\treturn cameraParams.z + z * (cameraParams.y - cameraParams.z);\n\t}\n}\n#ifndef CAMERAPLANES\n\t#define CAMERAPLANES\n\tuniform camera_params: vec4f;\n#endif\nfn linearizeDepth(z: f32) -> f32 {\n\treturn linearizeDepthWithParams(z, uniform.camera_params);\n}\n#endif\n",litForwardBackendPS:'\nfn evaluateBackend() -> FragmentOutput {\n\tvar output: FragmentOutput;\n\t#ifdef LIT_SSAO\n\t\tlitArgs_ao = litArgs_ao * textureSampleLevel(ssaoTexture, ssaoTextureSampler, pcPosition.xy * uniform.ssaoTextureSizeInv, 0.0).r;\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tgetReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t#ifdef LIT_METALNESS\n\t\t\tvar f0: f32 = 1.0 / litArgs_ior;\n\t\t\tf0 = (f0 - 1.0) / (f0 + 1.0);\n\t\t\tf0 = f0 * f0;\n\t\t\tlitArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n\t\t\tlitArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tvar iridescenceFresnel: vec3f = getIridescenceDiffraction(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_ADD_AMBIENT\n\t\taddAmbient(litArgs_worldNormal);\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n\t\t#endif\n\t\t#ifdef LIT_SEPARATE_AMBIENT\n\t\t\tvar dAmbientLight: vec3f = dDiffuseLight;\n\t\t\tdDiffuseLight = vec3(0.0);\n\t\t#endif\n\t#endif\n\t#ifndef LIT_OLD_AMBIENT\n\t\tdDiffuseLight = dDiffuseLight * uniform.material_ambient;\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifndef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_LIGHTMAP\n\t\taddLightMap(\n\t\t\tlitArgs_lightmap, \n\t\t\tlitArgs_lightmapDir, \n\t\t\tlitArgs_worldNormal, \n\t\t\tdViewDirW, \n\t\t\tdReflDirW, \n\t\t\tlitArgs_gloss, \n\t\t\tlitArgs_specularity, \n\t\t\tdVertexNormalW,\n\t\t\tdTBN\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tlitArgs_iridescence_intensity\n\t\t#endif\n\t\t);\n\t#endif\n\t#ifdef LIT_LIGHTING || LIT_REFLECTIONS\n\t\t#ifdef LIT_REFLECTIONS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\taddReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t\t\t\tccReflection = ccReflection * ccFresnel;\n\t\t\t\t#else\n\t\t\t\t\tccFresnel = 0.0;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tccReflection = ccReflection * litArgs_specularityFactor;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\taddReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n\t\t\t#endif\n\t\t\taddReflection(dReflDirW, litArgs_gloss);\n\t\t\t#ifdef LIT_FRESNEL_MODEL\n\t\t\t\tdReflection = vec4f(\n\t\t\t\t\tdReflection.rgb * getFresnel(\n\t\t\t\t\t\tdot(dViewDirW, litArgs_worldNormal),\n\t\t\t\t\t\tlitArgs_gloss,\n\t\t\t\t\t\tlitArgs_specularity\n\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t#endif\n\t\t\t\t\t\t),\n\t\t\t\t\tdReflection.a\n\t\t\t\t);\n\t\t\t#else\n\t\t\t\tdReflection = vec4f(dReflection.rgb * litArgs_specularity, dReflection.a);\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tdReflection = vec4f(dReflection.rgb * litArgs_specularityFactor, dReflection.a);\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\tdSpecularLight = dSpecularLight * litArgs_specularity;\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tcalcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n\t\t\t#endif\n\t\t#endif\n\t\t\n\t\t#ifdef LIGHT_COUNT > 0\n\t\t\t#include "lightEvaluationPS, LIGHT_COUNT"\n\t\t#endif\n\t\t#ifdef LIT_CLUSTERED_LIGHTS\n\t\t\taddClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n\t\t\t\t#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\tccReflDirW,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tiridescenceFresnel,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n\t\t\t);\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tlitArgs_clearcoat_specularity = 1.0;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tlitArgs_specularity = vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\taddRefraction(\n\t\t\t\tlitArgs_worldNormal, \n\t\t\t\tdViewDirW, \n\t\t\t\tlitArgs_thickness, \n\t\t\t\tlitArgs_gloss, \n\t\t\t\tlitArgs_specularity, \n\t\t\t\tlitArgs_albedo, \n\t\t\t\tlitArgs_transmission,\n\t\t\t\tlitArgs_ior,\n\t\t\t\tlitArgs_dispersion\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t#endif\n\t\t\t);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifdef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\t\toccludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULARITY_FACTOR\n\t\tdSpecularLight = dSpecularLight * litArgs_specularityFactor;\n\t#endif\n\t#if !defined(LIT_OPACITY_FADES_SPECULAR)\n\t\t#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n\t\t\tvar specLum: f32 = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3f( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tspecLum = specLum + dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3f( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#endif\n\t\t\tlitArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n\t\t#endif\n\t\tlitArgs_opacity = litArgs_opacity * uniform.material_alphaFade;\n\t#endif\n\t#ifdef LIT_LIGHTMAP_BAKING\n\t\t#ifdef LIT_LIGHTMAP_BAKING_COLOR\n\t\t\t#include "bakeLmEndPS"\n\t\t#endif\n\t\t#ifdef LIT_LIGHTMAP_BAKING_DIR\n\t\t\t#include "bakeDirLmEndPS"\n\t\t#endif\n\t#else\n\t\t#include "endPS"\n\t\t#include "outputAlphaPS"\n\t#endif\n\t#ifdef LIT_MSDF\n\t\toutput.color = applyMsdf(output.color);\n\t#endif\n\t#include "outputPS"\n\t#include "debugOutputPS"\n\t#ifdef LIT_SHADOW_CATCHER\n\t\toutput.color = vec4f(vec3f(dShadowCatcher), output.color.a);\n\t#endif\n\treturn output;\n}\n',litForwardDeclarationPS:'\nvar<private> sReflection: vec3f;\nvar<private> dVertexNormalW: vec3f;\nvar<private> dTangentW: vec3f;\nvar<private> dBinormalW: vec3f;\nvar<private> dViewDirW: vec3f;\nvar<private> dReflDirW: vec3f;\nvar<private> ccReflDirW: vec3f;\nvar<private> dLightDirNormW: vec3f;\nvar<private> dAtten: f32;\nvar<private> dTBN: mat3x3f;\nvar<private> dReflection: vec4f;\nvar<private> dDiffuseLight: vec3f;\nvar<private> dSpecularLight: vec3f;\nvar<private> ccFresnel: f32;\nvar<private> ccReflection: vec3f;\nvar<private> ccSpecularLight: vec3f;\nvar<private> ccSpecularityNoFres: f32;\nvar<private> sSpecularLight: vec3f;\n#ifdef LIT_DISPERSION\n\tuniform material_dispersion: f32;\n#endif\n#ifndef LIT_OPACITY_FADES_SPECULAR\n\tuniform material_alphaFade: f32;\n#endif\n#ifdef LIT_SSAO\n\tvar ssaoTexture : texture_2d<f32>;\n\tvar ssaoTextureSampler : sampler;\n\tuniform ssaoTextureSizeInv: vec2f;\n#endif\n#ifdef LIT_SHADOW_CATCHER\n\tvar<private> dShadowCatcher: f32 = 1.0;\n#endif\n#if LIGHT_COUNT > 0\n\t#include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n#ifdef LIT_SPECULAR\n\t#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n\t\t#define LIT_OLD_AMBIENT\n\t#endif\n#endif\n#ifdef STD_LIGHTMAP_DIR\n\tuniform bakeDir: f32;\n#endif\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n\tuniform ambientBakeOcclusionContrast: f32;\n\tuniform ambientBakeOcclusionBrightness: f32;\n#endif\n',litForwardMainPS:'\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t#include "litUserMainStartPS"\n\tdReflection = vec4f(0.0);\n\t#ifdef LIT_CLEARCOAT\n\t\tccSpecularLight = vec3f(0.0);\n\t\tccReflection = vec3f(0.0);\n\t#endif\n\t#if LIT_NONE_SLICE_MODE == SLICED\n\t\t#include "startNineSlicedPS"\n\t#elif LIT_NONE_SLICE_MODE == TILED\n\t\t#include "startNineSlicedTiledPS"\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\tdVertexNormalW = normalize(vNormalW);\n\t\t#ifdef LIT_TANGENTS\n\t\t\t#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)\n\t\t\t\tdTangentW = vTangentW;\n\t\t\t\tdBinormalW = vBinormalW;\n\t\t\t#endif\n\t\t#endif\n\t\tgetViewDir();\n\t\t#ifdef LIT_TBN\n\t\t\tgetTBN(dTangentW, dBinormalW, dVertexNormalW);\n\t\t\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t\t\thandleTwoSidedLighting();\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tevaluateFrontend();\n\t#include "debugProcessFrontendPS"\n\tvar output: FragmentOutput = evaluateBackend();\n\t#include "litUserMainEndPS"\n\treturn output;\n}\n',litForwardPostCodePS:'\n#ifdef LIT_NEEDS_NORMAL\n\t#include "cubeMapRotatePS"\n\t#include "cubeMapProjectPS"\n\t#include "envProcPS"\n#endif\n#ifdef LIT_SPECULAR_OR_REFLECTION\n\t#ifdef LIT_METALNESS\n\t\t#include "metalnessModulatePS"\n\t#endif\n\t#if LIT_FRESNEL_MODEL == SCHLICK\n\t\t#include "fresnelSchlickPS"\n\t#endif\n\t#ifdef LIT_IRIDESCENCE\n\t\t#include "iridescenceDiffractionPS"\n\t#endif\n#endif\n#ifdef LIT_AO\n\t#include "aoDiffuseOccPS"\n\t#include "aoSpecOccPS"\n#endif\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n\t#include "envAtlasPS"\n\t#include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n\t#include "envAtlasPS"\n\t#include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n\t#include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n\t#include "reflectionSpherePS"\n#endif\n#ifdef LIT_REFLECTIONS\n\t#ifdef LIT_CLEARCOAT\n\t\t#include "reflectionCCPS"\n\t#endif\n\t#ifdef LIT_SHEEN\n\t\t#include "reflectionSheenPS"\n\t#endif\n#endif\n#ifdef LIT_REFRACTION\n\t#if defined(LIT_DYNAMIC_REFRACTION)\n\t\t#include "refractionDynamicPS"\n\t#elif defined(LIT_REFLECTIONS)\n\t\t#include "refractionCubePS"\n\t#endif\n#endif\n#ifdef LIT_SHEEN\n\t#include "lightSheenPS"\n#endif\nuniform material_ambient: vec3f;\n#ifdef LIT_SPECULAR\n\t#ifdef LIT_LIGHTING\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "lightSpecularAnisoGGXPS"\n\t\t#else\n\t\t\t#include "lightSpecularBlinnPS"\n\t\t#endif\n\t#endif\n#endif\n#include "combinePS"\n#ifdef LIT_LIGHTMAP\n\t#include "lightmapAddPS"\n#endif\n#ifdef LIT_ADD_AMBIENT\n\t#include "ambientPS"\n#endif\n#ifdef LIT_MSDF\n\t#include "msdfPS"\n#endif\n#ifdef LIT_NEEDS_NORMAL\n\t#include "viewDirPS"\n\t#ifdef LIT_SPECULAR\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "reflDirAnisoPS"\n\t\t#else\n\t\t\t#include "reflDirPS"\n\t\t#endif\n\t#endif\n#endif\n#include "lightingPS"\n',litForwardPreCodePS:'\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n#if LIT_NONE_SLICE_MODE == SLICED\n\t#include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n\t#include "baseNineSlicedTiledPS"\n#endif\n#ifdef LIT_TBN\n\t#include "TBNPS"\n\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t#include "twoSidedLightingPS"\n\t#endif\n#endif\n',litMainPS:'\n#include "varyingsPS"\n#include "litUserDeclarationPS"\n#include "frontendDeclPS"\n#if defined(PICK_PASS) || defined(PREPASS_PASS)\n\t#include "frontendCodePS"\n\t#include "litUserCodePS"\n\t#include "litOtherMainPS"\n#elif defined(SHADOW_PASS)\n\t#include "frontendCodePS"\n\t#include "litUserCodePS"\n\t#include "litShadowMainPS"\n#else\n\t#include "litForwardDeclarationPS"\n\t#include "litForwardPreCodePS"\n\t#include "frontendCodePS"\n\t#include "litForwardPostCodePS"\n\t#include "litForwardBackendPS"\n\t#include "litUserCodePS"\n\t#include "litForwardMainPS"\n#endif\n',litMainVS:'\n#include "varyingsVS"\n#include  "litUserDeclarationVS"\n#ifdef VERTEX_COLOR\n\tattribute vertex_color: vec4f;\n#endif\n#ifdef NINESLICED\n\tvarying vMask: vec2f;\n\tvarying vTiledUv: vec2f;\n\tvar<private> dMaskGlobal: vec2f;\n\tvar<private> dTiledUvGlobal: vec2f;\n\tuniform innerOffset: vec4f;\n\tuniform outerScale: vec2f;\n\tuniform atlasRect: vec4f;\n#endif\nvar<private> dPositionW: vec3f;\nvar<private> dModelMatrix: mat4x4f;\n#include "transformCoreVS"\n#ifdef UV0\n\tattribute vertex_texCoord0: vec2f;\n\t#include "uv0VS"\n#endif\n#ifdef UV1\n\tattribute vertex_texCoord1: vec2f;\n\t#include "uv1VS"\n#endif\n#ifdef LINEAR_DEPTH\n\t#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\t\tuniform matrix_view: mat4x4f;\n\t#endif\n#endif\n#include "transformVS"\n#ifdef NORMALS\n\t#include "normalCoreVS"\n\t#include "normalVS"\n#endif\n#ifdef TANGENTS\n\tattribute vertex_tangent: vec4f;\n#endif\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n#ifdef MSDF\n\t#include "msdfVS"\n#endif\n#include  "litUserCodeVS"\n@vertex\nfn vertexMain(input : VertexInput) -> VertexOutput {\n\t#include "litUserMainStartVS"\n\tvar output : VertexOutput;\n\toutput.position = getPosition();\n\toutput.vPositionW = getWorldPosition();\n\t#ifdef NORMALS\n\t\toutput.vNormalW = getNormal();\n\t#endif\n\t#ifdef TANGENTS\n\t\toutput.vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);\n\t\toutput.vBinormalW = cross(output.vNormalW, output.vTangentW) * vertex_tangent.w;\n\t#elif defined(GGX_SPECULAR)\n\t\toutput.vObjectSpaceUpW = normalize(dNormalMatrix * vec3f(0.0, 1.0, 0.0));\n\t#endif\n\t#ifdef UV0\n\t\tvar uv0: vec2f = getUv0();\n\t\t#ifdef UV0_UNMODIFIED\n\t\t\toutput.vUv0 = uv0;\n\t\t#endif\n\t#endif\n\t#ifdef UV1\n\t\tvar uv1: vec2f = getUv1();\n\t\t#ifdef UV1_UNMODIFIED\n\t\t\toutput.vUv1 = uv1;\n\t\t#endif\n\t#endif\n\t#include "uvTransformVS, UV_TRANSFORMS_COUNT"\n\t#ifdef VERTEX_COLOR\n\t\toutput.vVertexColor = vertex_color;\n\t#endif\n\t#ifdef LINEAR_DEPTH\n\t\toutput.vLinearDepth = -(uniform.matrix_view * vec4f(output.vPositionW, 1.0)).z;\n\t#endif\n\t#ifdef MSDF\n\t\tunpackMsdfParams();\n\t\toutput.outline_color = dOutlineColor;\n\t\toutput.outline_thickness = dOutlineThickness;\n\t\toutput.shadow_color = dShadowColor;\n\t\toutput.shadow_offset = dShadowOffset;\n\t#endif\n\t#ifdef NINESLICED\n\t\toutput.vMask = dMaskGlobal;\n\t\toutput.vTiledUv = dTiledUvGlobal;\n\t#endif\n\t#include "litUserMainEndVS"\n\treturn output;\n}\n',litOtherMainPS:'\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#ifdef PREPASS_PASS\n\t#include "floatAsUintPS"\n#endif\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t#include "litUserMainStartPS"\n\tvar output: FragmentOutput;\n\t\n\tevaluateFrontend();\n\t#ifdef PICK_PASS\n\t\toutput.color = getPickOutput();\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\toutput.color = float2vec4(vLinearDepth);\n\t#endif\n\t#include "litUserMainEndPS"\n\treturn output;\n}\n',litShaderArgsPS:"\nvar<private> litArgs_albedo: vec3f;\nvar<private> litArgs_opacity: f32;\nvar<private> litArgs_emission: vec3f;\nvar<private> litArgs_worldNormal: vec3f;\nvar<private> litArgs_ao: f32;\nvar<private> litArgs_lightmap: vec3f;\nvar<private> litArgs_lightmapDir: vec3f;\nvar<private> litArgs_metalness: f32;\nvar<private> litArgs_specularity: vec3f;\nvar<private> litArgs_specularityFactor: f32;\nvar<private> litArgs_gloss: f32;\nvar<private> litArgs_sheen_gloss: f32;\nvar<private> litArgs_sheen_specularity: vec3f;\nvar<private> litArgs_transmission: f32;\nvar<private> litArgs_thickness: f32;\nvar<private> litArgs_ior: f32;\nvar<private> litArgs_dispersion: f32;\nvar<private> litArgs_iridescence_intensity: f32;\nvar<private> litArgs_iridescence_thickness: f32;\nvar<private> litArgs_clearcoat_worldNormal: vec3f;\nvar<private> litArgs_clearcoat_specularity: f32;\nvar<private> litArgs_clearcoat_gloss: f32;\n",litShaderCorePS:'\n\t#if LIT_NONE_SLICE_MODE == TILED\n\t\tvar<private> textureBias: f32 = -1000.0;\n\t#else\n\t\tuniform textureBias: f32;\n\t#endif\n\t#include "litShaderArgsPS"\n',litShadowMainPS:'\n#if LIGHT_TYPE != DIRECTIONAL\n\tuniform view_position: vec3f;\n\tuniform light_radius: f32;\n#endif\n#if SHADOW_TYPE == PCSS_32F\n\t#include "linearizeDepthPS"\n#endif\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t#include "litUserMainStartPS"\n\tvar output: FragmentOutput;\n\tevaluateFrontend();\n\t#ifdef PERSPECTIVE_DEPTH\n\t\tvar depth: f32 = input.position.z;\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\t#if LIGHT_TYPE != DIRECTIONAL\n\t\t\t\tdepth = linearizeDepthWithParams(depth, camera_params);\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tvar depth: f32 = min(distance(uniform.view_position, input.vPositionW) / uniform.light_radius, 0.99999);\n\t\t#define MODIFIED_DEPTH\n\t#endif\n\t#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F\n\t\t#if SHADOW_TYPE == VSM_32F\n\t\t\tvar exponent: f32 = 15.0;\n\t\t#else\n\t\t\tvar exponent: f32 = 5.54;\n\t\t#endif\n\t\tvar depth_vsm = 2.0 * depth - 1.0;\n\t\tdepth_vsm = exp(exponent * depth_vsm);\n\t\toutput.color = vec4f(depth_vsm, depth_vsm * depth_vsm, 1.0, 1.0);\n\t#else\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\toutput.color = vec4f(depth, 0.0, 0.0, 1.0);\n\t\t#else\n\t\t\t#ifdef MODIFIED_DEPTH\n\t\t\t\toutput.fragDepth = depth;\n\t\t\t#endif\n\t\t\toutput.color = vec4f(1.0);\n\t\t#endif\n\t#endif\n\t#include "litUserMainEndPS"\n\t\n\treturn output;\n}\n',litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:"\nfn LTC_Uv(N: vec3f, V: vec3f, roughness: f32) -> vec2f {\n\tconst LUT_SIZE: f32 = 64.0;\n\tconst LUT_SCALE: f32 = (LUT_SIZE - 1.0) / LUT_SIZE;\n\tconst LUT_BIAS: f32 = 0.5 / LUT_SIZE;\n\tlet dotNV: f32 = saturate(dot( N, V ));\n\tlet uv: vec2f = vec2f( roughness, sqrt( 1.0 - dotNV ) );\n\treturn uv * LUT_SCALE + LUT_BIAS;\n}\nfn LTC_ClippedSphereFormFactor( f: vec3f ) -> f32 {\n\tlet l: f32 = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nfn LTC_EdgeVectorFormFactor( v1: vec3f, v2: vec3f ) -> vec3f {\n\tlet x: f32 = dot( v1, v2 );\n\tlet y: f32 = abs( x );\n\tlet a: f32 = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tlet b: f32 = 3.4175940 + ( 4.1616724 + y ) * y;\n\tlet v: f32 = a / b;\n\tlet inv_sqrt_term = inverseSqrt( max( 1.0 - x * x, 1e-7f ) );\n\tlet theta_sintheta: f32 = select( (0.5 * inv_sqrt_term - v), v, x > 0.0 );\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tcoord0: vec3f,\n\tcoord1: vec3f,\n\tcoord2: vec3f,\n\tcoord3: vec3f,\n}\nfn LTC_EvaluateRect( N: vec3f, V: vec3f, P: vec3f, mInv: mat3x3f, rectCoords: Coords) -> f32 {\n\tlet v1: vec3f = rectCoords.coord1 - rectCoords.coord0;\n\tlet v2: vec3f = rectCoords.coord3 - rectCoords.coord0;\n\tlet lightNormal: vec3f = cross( v1, v2 );\n\tlet factor: f32 = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tlet T1: vec3f = normalize( V - N * dot( V, N ) );\n\tlet T2: vec3f = factor * cross( N, T1 );\n\tlet mat: mat3x3f = mInv * transpose( mat3x3f( T1, T2, N ) );\n\tvar coords: array<vec3f, 4>;\n\tcoords[0] = mat * ( rectCoords.coord0 - P );\n\tcoords[1] = mat * ( rectCoords.coord1 - P );\n\tcoords[2] = mat * ( rectCoords.coord2 - P );\n\tcoords[3] = mat * ( rectCoords.coord3 - P );\n\tcoords[0] = normalize( coords[0] );\n\tcoords[1] = normalize( coords[1] );\n\tcoords[2] = normalize( coords[2] );\n\tcoords[3] = normalize( coords[3] );\n\tvar vectorFormFactor: vec3f = vec3f( 0.0 );\n\tvectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[0], coords[1] );\n\tvectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[1], coords[2] );\n\tvectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[2], coords[3] );\n\tvectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[3], coords[0] );\n\tlet result: f32 = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nvar<private> dLTCCoords: Coords;\nfn getLTCLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {\n\tvar coords: Coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nvar<private> dSphereRadius: f32;\nfn getSphereLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tlet f: vec3f = reflect(normalize(lightPos - uniform.view_position), vNormalW);\n\tlet w: vec3f = normalize(cross(f, halfHeight));\n\tlet h: vec3f = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvar<private> dLTCUV: vec2f;\n#ifdef LIT_CLEARCOAT\n\tvar<private> ccLTCUV: vec2f;\n#endif\nfn getLTCLightUV(gloss: f32, worldNormal: vec3f, viewDir: vec3f) -> vec2f {\n\tlet roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\treturn LTC_Uv( worldNormal, viewDir, roughness );\n}\nvar<private> dLTCSpecFres: vec3f;\n#ifdef LIT_CLEARCOAT\n\tvar<private> ccLTCSpecFres: vec3f;\n#endif\nfn getLTCLightSpecFres(uv: vec2f, specularity: vec3f) -> vec3f {\n\tlet t2: vec4f = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0);\n\treturn specularity * t2.x + ( vec3f( 1.0 ) - specularity) * t2.y;\n}\nfn calcLTCLightValues(gloss: f32, worldNormal: vec3f, viewDir: vec3f, specularity: vec3f, clearcoatGloss: f32, clearcoatWorldNormal: vec3f, clearcoatSpecularity: f32) {\n\tdLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity);\n\t#ifdef LIT_CLEARCOAT\n\t\tccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n\t\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3f(clearcoatSpecularity));\n\t#endif\n}\nfn calcRectLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nfn calcDiskLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nfn calcSphereLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nfn SolveCubic(Coefficient_in: vec4f) -> vec3f {\n\tlet pi: f32 = 3.14159;\n\tvar Coefficient = Coefficient_in;\n\tCoefficient = vec4f(Coefficient.xyz / Coefficient.w, Coefficient.w);\n\tlet new_yz: vec2f = Coefficient.yz / 3.0;\n\tCoefficient = vec4f(Coefficient.x, new_yz.x, new_yz.y, Coefficient.w);\n\t\n\tlet A: f32 = Coefficient.w;\n\tlet B: f32 = Coefficient.z;\n\tlet C: f32 = Coefficient.y;\n\tlet D: f32 = Coefficient.x;\n\tlet Delta: vec3f = vec3f(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2f(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tlet Discriminant: f32 = dot(vec2f(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvar xlc: vec2f;\n\tvar xsc: vec2f;\n\t{\n\t\tlet A_a: f32 = 1.0;\n\t\tlet C_a: f32 = Delta.x;\n\t\tlet D_a: f32 = -2.0 * B * Delta.x + Delta.y;\n\t\tlet Theta: f32 = atan2(sqrt(Discriminant), -D_a) / 3.0;\n\t\tlet sqrt_neg_Ca = sqrt(-C_a);\n\t\tlet x_1a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta);\n\t\tlet x_3a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta + (2.0 / 3.0) * pi);\n\t\tlet xl: f32 = select(x_3a, x_1a, (x_1a + x_3a) > 2.0 * B);\n\t\txlc = vec2f(xl - B, A);\n\t}\n\t{\n\t\tlet A_d: f32 = D;\n\t\tlet C_d: f32 = Delta.z;\n\t\tlet D_d: f32 = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tlet Theta: f32 = atan2(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tlet sqrt_neg_Cd = sqrt(-C_d);\n\t\tlet x_1d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta);\n\t\tlet x_3d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta + (2.0 / 3.0) * pi);\n\t\tlet xs: f32 = select(x_3d, x_1d, x_1d + x_3d < 2.0 * C);\n\t\txsc = vec2f(-D, xs + C);\n\t}\n\tlet E: f32 =  xlc.y * xsc.y;\n\tlet F: f32 = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tlet G: f32 =  xlc.x * xsc.x;\n\tlet xmc: vec2f = vec2f(C * F - B * G, -B * F + C * E);\n\tvar Root: vec3f = vec3f(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z) {\n\t\tRoot = Root.yxz;\n\t} else if (Root.z < Root.x && Root.z < Root.y) {\n\t\tRoot = Root.xzy;\n\t}\n\treturn Root;\n}\nfn LTC_EvaluateDisk(N: vec3f, V: vec3f, P: vec3f, Minv: mat3x3f, points: Coords) -> f32 {\n\tlet T1: vec3f = normalize(V - N * dot(V, N));\n\tlet T2: vec3f = cross(N, T1);\n\tlet R: mat3x3f = transpose( mat3x3f( T1, T2, N ) );\n\tvar L_: array<vec3f, 3>;\n\tL_[0] = R * ( points.coord0 - P );\n\tL_[1] = R * ( points.coord1 - P );\n\tL_[2] = R * ( points.coord2 - P );\n\tlet C: vec3f  = 0.5 * (L_[0] + L_[2]);\n\tvar V1: vec3f = 0.5 * (L_[1] - L_[2]);\n\tvar V2: vec3f = 0.5 * (L_[1] - L_[0]);\n\tlet C_Minv: vec3f  = Minv * C;\n\tlet V1_Minv: vec3f = Minv * V1;\n\tlet V2_Minv: vec3f = Minv * V2;\n\tvar a: f32;\n\tvar b: f32;\n\tlet d11: f32 = dot(V1_Minv, V1_Minv);\n\tlet d22: f32 = dot(V2_Minv, V2_Minv);\n\tlet d12: f32 = dot(V1_Minv, V2_Minv);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001) {\n\t\tlet tr: f32 = d11 + d22;\n\t\tlet det_inner: f32 = -d12 * d12 + d11 * d22;\n\t\tlet det: f32 = sqrt(det_inner);\n\t\tlet u: f32 = 0.5 * sqrt(tr - 2.0 * det);\n\t\tlet v: f32 = 0.5 * sqrt(tr + 2.0 * det);\n\t\tlet e_max: f32 = (u + v) * (u + v);\n\t\tlet e_min: f32 = (u - v) * (u - v);\n\t\tvar V1_: vec3f;\n\t\tvar V2_: vec3f;\n\t\tif (d11 > d22) {\n\t\t\tV1_ = d12 * V1_Minv + (e_max - d11) * V2_Minv;\n\t\t\tV2_ = d12 * V1_Minv + (e_min - d11) * V2_Minv;\n\t\t} else {\n\t\t\tV1_ = d12*V2_Minv + (e_max - d22)*V1_Minv;\n\t\t\tV2_ = d12*V2_Minv + (e_min - d22)*V1_Minv;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t} else {\n\t\ta = 1.0 / dot(V1_Minv, V1_Minv);\n\t\tb = 1.0 / dot(V2_Minv, V2_Minv);\n\t\tV1 = V1_Minv * sqrt(a);\n\t\tV2 = V2_Minv * sqrt(b);\n\t}\n\tvar V3: vec3f = normalize(cross(V1, V2));\n\tif (dot(C_Minv, V3) < 0.0) {\n\t\tV3 = V3 * -1.0;\n\t}\n\tlet L: f32  = dot(V3, C_Minv);\n\tlet x0: f32 = dot(V1, C_Minv) / L;\n\tlet y0: f32 = dot(V2, C_Minv) / L;\n\tlet E1: f32 = inverseSqrt(a);\n\tlet E2: f32 = inverseSqrt(b);\n\tlet a_scaled = a * L * L;\n\tlet b_scaled = b * L * L;\n\tlet c0: f32 = a_scaled * b_scaled;\n\tlet c1: f32 = a_scaled * b_scaled * (1.0 + x0 * x0 + y0 * y0) - a_scaled - b_scaled;\n\tlet c2: f32 = 1.0 - a_scaled * (1.0 + x0 * x0) - b_scaled * (1.0 + y0 * y0);\n\tlet c3: f32 = 1.0;\n\tlet roots: vec3f = SolveCubic(vec4f(c0, c1, c2, c3));\n\tlet e1: f32 = roots.x;\n\tlet e2: f32 = roots.y;\n\tlet e3: f32 = roots.z;\n\tvar avgDir: vec3f = vec3f(a_scaled * x0 / (a_scaled - e2), b_scaled * y0 / (b_scaled - e2), 1.0);\n\tlet rotate: mat3x3f = mat3x3f(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tlet L1: f32 = sqrt(-e2 / e3);\n\tlet L2: f32 = sqrt(-e2 / e1);\n\tlet formFactor: f32 = max(0.0, L1 * L2 * inverseSqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n\tconst LUT_SIZE_disk: f32 = 64.0;\n\tconst LUT_SCALE_disk: f32 = ( LUT_SIZE_disk - 1.0 ) / LUT_SIZE_disk;\n\tconst LUT_BIAS_disk: f32 = 0.5 / LUT_SIZE_disk;\n\tvar uv: vec2f = vec2f(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv * LUT_SCALE_disk + LUT_BIAS_disk;\n\tlet scale: f32 = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0).w;\n\treturn formFactor * scale;\n}\nfn FixNan(value: f32) -> f32 {\n\treturn select(value, 0.0, value != value);\n}\nfn getRectLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {\n\tlet identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords );\n}\nfn getDiskLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {\n\tlet identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));\n\treturn FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords ));\n}\nfn getSphereLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {\n\tlet falloff: f32 = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n\treturn FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);\n}\nfn getLTCLightInvMat(uv: vec2f) -> mat3x3f {\n\tlet t1: vec4f = textureSampleLevel(areaLightsLutTex1, areaLightsLutTex1Sampler, uv, 0.0);\n\treturn mat3x3f(\n\t\tvec3f( t1.x, 0.0, t1.y ),\n\t\tvec3f( 0.0, 1.0, 0.0 ),\n\t\tvec3f( t1.z, 0.0, t1.w )\n\t);\n}\nfn calcRectLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {\n\tlet mInv: mat3x3f = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfn getRectLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {\n\treturn calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfn calcDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {\n\tlet mInv: mat3x3f = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfn getDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfn getSphereLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef STD_METALNESS_CONSTANT\nuniform material_metalness: f32;\n#endif\nfn getMetalness() {\n\tvar metalness: f32 = 1.0;\n\t#ifdef STD_METALNESS_CONSTANT\n\t\tmetalness = metalness * uniform.material_metalness;\n\t#endif\n\t#ifdef STD_METALNESS_TEXTURE\n\t\tmetalness = metalness * textureSampleBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_NAME}Sampler, {STD_METALNESS_TEXTURE_UV}, uniform.textureBias).{STD_METALNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_METALNESS_VERTEX\n\tmetalness = metalness * saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});\n\t#endif\n\tdMetalness = metalness;\n}\n",metalnessModulatePS:"\nfn getSpecularModulate(specularity: vec3f, albedo: vec3f, metalness: f32, f0: f32) -> vec3f {\n\tlet dielectricF0: vec3f = f0 * specularity;\n\treturn mix(dielectricF0, albedo, metalness);\n}\nfn getAlbedoModulate(albedo: vec3f, metalness: f32) -> vec3f {\n\treturn albedo * (1.0 - metalness);\n}\n",morphPS:"\n\tvarying uv0: vec2f;\n\tvar morphTexture: texture_2d_array<f32>;\n\tuniform morphFactor: array<f32, {MORPH_TEXTURE_MAX_COUNT}>;\n\tuniform morphIndex: array<u32, {MORPH_TEXTURE_MAX_COUNT}>;\n\tuniform count: u32;\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar color = vec3f(0, 0, 0);\n\t\tlet textureDims = textureDimensions(morphTexture);\n\t\tlet pixelCoords = vec2i(input.uv0 * vec2f(textureDims));\n\t\t\n\t\tfor (var i: u32 = 0; i < uniform.count; i = i + 1) {\n\t\t\tvar textureIndex: u32 = uniform.morphIndex[i].element;\n\t\t\tvar delta = textureLoad(morphTexture, pixelCoords, textureIndex, 0).xyz;\n\t\t\tcolor += uniform.morphFactor[i].element * delta;\n\t\t}\n\t\tvar output: FragmentOutput;\n\t\toutput.color = vec4f(color, 1.0);\n\t\treturn output;\n\t}\n",morphVS:"\n\tattribute vertex_position: vec2f;\n\tvarying uv0: vec2f;\n\t@vertex\n\tfn vertexMain(input: VertexInput) -> VertexOutput {\n\t\tvar output: VertexOutput;\n\t\toutput.position = vec4f(input.vertex_position, 0.5, 1.0);\n\t\toutput.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n\t\treturn output;\n\t}\n",msdfPS:"\nvar texture_msdfMap: texture_2d<f32>;\nvar texture_msdfMapSampler: sampler;\nfn median(r: f32, g: f32, b: f32) -> f32 {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfn map(min: f32, max: f32, v: f32) -> f32 {\n\treturn (v - min) / (max - min);\n}\nuniform font_sdfIntensity: f32;\nuniform font_pxrange: f32;\nuniform font_textureWidth: f32;\n#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n\tuniform outline_color: vec4f;\n\tuniform outline_thickness: f32;\n\tuniform shadow_color: vec4f;\n\tuniform shadow_offset: vec2f;\n#else\n\tvarying outline_color: vec4f;\n\tvarying outline_thickness: f32;\n\tvarying shadow_color: vec4f;\n\tvarying shadow_offset: vec2f;\n#endif\nfn applyMsdf(color_in: vec4f) -> vec4f {\n\t#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n\t\tvar outline_colorValue = uniform.outline_color;\n\t\tvar outline_thicknessValue = uniform.outline_thickness;\n\t\tvar shadow_colorValue = uniform.shadow_color;\n\t\tvar shadow_offsetValue = uniform.shadow_offset;\n\t#else\n\t\tvar outline_colorValue = outline_color;\n\t\tvar outline_thicknessValue = outline_thickness;\n\t\tvar shadow_colorValue = shadow_color;\n\t\tvar shadow_offsetValue = shadow_offset;\n\t#endif\n\tvar color = vec4f(gammaCorrectInputVec3(color_in.rgb), color_in.a);\n\tlet tsample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, vUv0).rgb;\n\tlet uvShdw: vec2f = vUv0 - shadow_offsetValue;\n\tlet ssample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, uvShdw).rgb;\n\tlet sigDist: f32 = median(tsample.r, tsample.g, tsample.b);\n\tvar sigDistShdw: f32 = median(ssample.r, ssample.g, ssample.b);\n\tlet smoothingMax: f32 = 0.2;\n\tlet w: vec2f = abs(dpdx(vUv0)) + abs(dpdy(vUv0));\n\tlet smoothing: f32 = clamp(w.x * uniform.font_textureWidth / uniform.font_pxrange, 0.0, smoothingMax);\n\tlet mapMin: f32 = 0.05;\n\tlet mapMax: f32 = clamp(1.0 - uniform.font_sdfIntensity, mapMin, 1.0);\n\tlet sigDistInner: f32 = map(mapMin, mapMax, sigDist);\n\tlet sigDistOutline: f32 = map(mapMin, mapMax, sigDist + outline_thicknessValue);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thicknessValue);\n\tlet center: f32 = 0.5;\n\tlet inside: f32 = smoothstep(center - smoothing, center + smoothing, sigDistInner);\n\tlet outline: f32 = smoothstep(center - smoothing, center + smoothing, sigDistOutline);\n\tlet shadow: f32 = smoothstep(center - smoothing, center + smoothing, sigDistShdw);\n\tlet tcolor_outline: vec4f = outline * vec4f(outline_colorValue.a * outline_colorValue.rgb, outline_colorValue.a);\n\tvar tcolor: vec4f = select(vec4f(0.0), tcolor_outline, outline > inside);\n\ttcolor = mix(tcolor, color, inside);\n\tlet scolor_shadow: vec4f = shadow * vec4f(shadow_colorValue.a * shadow_colorValue.rgb, shadow_colorValue.a);\n\tlet scolor: vec4f = select(tcolor, scolor_shadow, shadow > outline);\n\ttcolor = mix(scolor, tcolor, outline);\n\ttcolor = vec4f(gammaCorrectOutput(tcolor.rgb), tcolor.a);\n\treturn tcolor;\n}\n",msdfVS:"\nattribute vertex_outlineParameters: vec3f;\nattribute vertex_shadowParameters: vec3f;\nvarying outline_color: vec4f;\nvarying outline_thickness: f32;\nvarying shadow_color: vec4f;\nvarying shadow_offset: vec2f;\nvar<private> dOutlineColor: vec4f;\nvar<private> dOutlineThickness: f32;\nvar<private> dShadowColor: vec4f;\nvar<private> dShadowOffset: vec2f;\nfn unpackMsdfParams() {\n\tlet little: vec3f = vertex_outlineParameters % vec3f(256.0);\n\tlet big: vec3f = (vertex_outlineParameters - little) / 256.0;\n\tdOutlineColor = vec4f(little.x, big.x, little.y, big.y) / 255.0;\n\tdOutlineThickness = little.z / 255.0 * 0.2;\n\tlet little_shadow = vertex_shadowParameters % vec3f(256.0);\n\tlet big_shadow = (vertex_shadowParameters - little_shadow) / 256.0;\n\tdShadowColor = vec4f(little_shadow.x, big_shadow.x, little_shadow.y, big_shadow.y) / 255.0;\n\tdShadowOffset = (vec2f(little_shadow.z, big_shadow.z) / 127.0 - 1.0) * 0.005;\n}\n",normalVS:"\nvar<private> dNormalMatrix: mat3x3f;\nfn getNormal() -> vec3f {\n\tdNormalMatrix = getNormalMatrix(dModelMatrix);\n\tlet localNormal: vec3f = getLocalNormal(vertex_normal);\n\treturn normalize(dNormalMatrix * localNormal);\n}",normalCoreVS:"\nattribute vertex_normal: vec3f;\nuniform matrix_normal: mat3x3f;\n#ifdef MORPHING_NORMAL\n\t#ifdef MORPHING_INT\n\t\tvar morphNormalTex: texture_2d<u32>;\n\t\tvar morphNormalTexSampler: sampler;\n\t#else\n\t\tvar morphNormalTex: texture_2d<f32>;\n\t\tvar morphNormalTexSampler: sampler;\n\t#endif\n#endif\nfn getLocalNormal(vertexNormal: vec3f) -> vec3f {\n\tvar localNormal: vec3f = vertexNormal;\n\t#ifdef MORPHING_NORMAL\n\t\tlet morphUV: vec2i = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tlet morphNormalInt: vec4u = textureLoad(morphNormalTex, morphUV, 0);\n\t\t\tlet morphNormalF: vec3f = vec3f(morphNormalInt.xyz) / 65535.0 * 2.0 - 1.0;\n\t\t\tlocalNormal = localNormal + morphNormalF;\n\t\t#else\n\t\t\tlet morphNormal: vec3f = textureLoad(morphNormalTex, morphUV, 0).xyz;\n\t\t\tlocalNormal = localNormal + morphNormal;\n\t\t#endif\n\t#endif\n\treturn localNormal;\n}\n#if defined(SKIN) || defined(BATCH)\n\tfn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n\t\treturn mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#elif defined(INSTANCING)\n\tfn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n\t\treturn mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#else\n\tfn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n\t\treturn uniform.matrix_normal;\n\t}\n#endif\n",normalMapPS:"\n#ifdef STD_NORMAL_TEXTURE\n\tuniform material_bumpiness: f32;\n#endif\n#ifdef STD_NORMALDETAIL_TEXTURE\n\tuniform material_normalDetailMapBumpiness: f32;\n\tfn blendNormals(inN1: vec3f, inN2: vec3f) -> vec3f {\n\t\tlet n1: vec3f = inN1 + vec3f(0.0, 0.0, 1.0);\n\t\tlet n2: vec3f = inN2 * vec3f(-1.0, -1.0, 1.0);\n\t\treturn n1 * dot(n1, n2) / n1.z - n2;\n\t}\n#endif\nfn getNormal() {\n#ifdef STD_NORMAL_TEXTURE\n\tvar normalMap: vec3f = {STD_NORMAL_TEXTURE_DECODE}(textureSampleBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_NAME}Sampler, {STD_NORMAL_TEXTURE_UV}, uniform.textureBias));\n\tnormalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_bumpiness);\n\t#ifdef STD_NORMALDETAIL_TEXTURE\n\t\tvar normalDetailMap: vec3f = {STD_NORMALDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_NAME}Sampler, {STD_NORMALDETAIL_TEXTURE_UV}, uniform.textureBias));\n\t\tnormalDetailMap = mix(vec3f(0.0, 0.0, 1.0), normalDetailMap, uniform.material_normalDetailMapBumpiness);\n\t\tnormalMap = blendNormals(normalMap, normalDetailMap);\n\t#endif\n\tdNormalW = normalize(dTBN * normalMap);\n#else\n\tdNormalW = dVertexNormalW;\n#endif\n}\n",opacityPS:"\nuniform material_opacity: f32;\nfn getOpacity() {\n\tdAlpha = uniform.material_opacity;\n\t#ifdef STD_OPACITY_TEXTURE\n\tdAlpha = dAlpha * textureSampleBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_NAME}Sampler, {STD_OPACITY_TEXTURE_UV}, uniform.textureBias).{STD_OPACITY_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_OPACITY_VERTEX\n\tdAlpha = dAlpha * clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);\n\t#endif\n}\n",opacityDitherPS:'\n#if STD_OPACITY_DITHER == BAYER8\n\t#include "bayerPS"\n#endif\nuniform blueNoiseJitter: vec4f;\n#if STD_OPACITY_DITHER == BLUENOISE\n\tvar blueNoiseTex32 : texture_2d<f32>;\n\tvar blueNoiseTex32Sampler : sampler;\n#endif\nfn opacityDither(alpha: f32, id: f32) {\n\t#if STD_OPACITY_DITHER == BAYER8\n\t\tvar noise: f32 = bayer8(floor((pcPosition.xy + uniform.blueNoiseJitter.xy + id) % vec2f(8.0))) / 64.0;\n\t#else\n\t\t#if STD_OPACITY_DITHER == BLUENOISE\n\t\t\tvar uv = fract(pcPosition.xy / 32.0 + uniform.blueNoiseJitter.xy + id);\n\t\t\tvar noise: f32 = textureSampleLevel(blueNoiseTex32, blueNoiseTex32Sampler, uv, 0.0).y;\n\t\t#endif\n\t\t#if STD_OPACITY_DITHER == IGNNOISE\n\t\t\tvar magic = vec3f(0.06711056, 0.00583715, 52.9829189);\n\t\t\tvar noise: f32 = fract(magic.z * fract(dot(pcPosition.xy + uniform.blueNoiseJitter.xy + id, magic.xy)));\n\t\t#endif\n\t#endif\n\tnoise = pow(noise, 2.2);\n\tif (alpha < noise) {\n\t\tdiscard;\n\t}\n}\n',outputPS:"\n",outputAlphaPS:"\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n\toutput.color = vec4f(output.color.rgb, litArgs_opacity);\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n\toutput.color = vec4f(output.color.rgb * litArgs_opacity, litArgs_opacity);\n#else\n\toutput.color = vec4f(output.color.rgb, 1.0);\n#endif\n",outputTex2DPS:"\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\n@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\toutput.color = textureSample(source, sourceSampler, input.vUv0);\n\treturn output;\n}\n",sheenPS:"\nuniform material_sheen: vec3f;\nfn getSheen() {\n\tvar sheenColor = uniform.material_sheen;\n\t#ifdef STD_SHEEN_TEXTURE\n\tsheenColor = sheenColor * {STD_SHEEN_TEXTURE_DECODE}(textureSampleBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_NAME}Sampler, {STD_SHEEN_TEXTURE_UV}, uniform.textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEEN_VERTEX\n\tsheenColor = sheenColor * saturate3(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});\n\t#endif\n\tsSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform material_sheenGloss: f32;\nfn getSheenGlossiness() {\n\tvar sheenGlossiness = uniform.material_sheenGloss;\n\t#ifdef STD_SHEENGLOSS_TEXTURE\n\tsheenGlossiness = sheenGlossiness * textureSampleBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_NAME}Sampler, {STD_SHEENGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEENGLOSS_VERTEX\n\tsheenGlossiness = sheenGlossiness * saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_SHEENGLOSS_INVERT\n\tsheenGlossiness = 1.0 - sheenGlossiness;\n\t#endif\n\tsGlossiness = sheenGlossiness + 0.0000001;\n}\n",parallaxPS:"\nuniform material_heightMapFactor: f32;\nfn getParallax() {\n\tvar parallaxScale = uniform.material_heightMapFactor;\n\tvar height: f32 = textureSampleBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_NAME}Sampler, {STD_HEIGHT_TEXTURE_UV}, uniform.textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};\n\theight = height * parallaxScale - parallaxScale * 0.5;\n\tvar viewDirT: vec3f = dViewDirW * dTBN;\n\tviewDirT.z = viewDirT.z + 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",pickPS:"\nuniform meshInstanceId: u32;\nfn getPickOutput() -> vec4f {\n\tlet inv: vec4f = vec4f(1.0 / 255.0);\n\tlet shifts: vec4u = vec4u(16u, 8u, 0u, 24u);\n\tlet col: vec4u = (vec4u(uniform.meshInstanceId) >> shifts) & vec4u(0xffu);\n\treturn vec4f(col) * inv;\n}",reflDirPS:"\nfn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {\n\tdReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nfn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {\n\tlet roughness: f32 = sqrt(1.0 - min(gloss, 1.0));\n\tlet direction: vec2f = dAnisotropyRotation;\n\tlet anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));\n\tlet anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));\n\tlet anisotropy: f32 = dAnisotropy;\n\tlet anisotropicDirection: vec3f = anisotropicB;\n\tlet anisotropicTangent: vec3f = cross(anisotropicDirection, viewDir);\n\tlet anisotropicNormal: vec3f = cross(anisotropicTangent, anisotropicDirection);\n\tlet bendFactor: f32 = 1.0 - anisotropy * (1.0 - roughness);\n\tlet bendFactor4: f32 = bendFactor * bendFactor * bendFactor * bendFactor;\n\tlet bentNormal: vec3f = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));\n\tdReflDirW = reflect(-viewDir, bentNormal);\n}",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nfn addReflectionCC(reflDir: vec3f, gloss: f32) {\n\tccReflection = ccReflection + calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nvar texture_cubeMap: texture_cube<f32>;\nvar texture_cubeMapSampler: sampler;\nuniform material_reflectivity: f32;\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n\tvar lookupVec: vec3f = cubeMapProject(reflDir);\n\tlookupVec.x = lookupVec.x * -1.0;\n\treturn {reflectionDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, lookupVec));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n\tdReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n\t#define ENV_ATLAS\n\tvar texture_envAtlas: texture_2d<f32>;\n\tvar texture_envAtlasSampler: sampler;\n#endif\nvar texture_cubeMap: texture_cube<f32>;\nvar texture_cubeMapSampler: sampler;\nuniform material_reflectivity: f32;\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n\tlet dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);\n\tlet uv: vec2f = toSphericalUv(dir);\n\tlet level: f32 = saturate(1.0 - gloss) * 5.0;\n\tlet ilevel: f32 = floor(level);\n\tlet flevel: f32 = level - ilevel;\n\tlet sharp: vec3f = {reflectionCubemapDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, dir));\n\tlet roughA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel)));\n\tlet roughB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n\tdReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\n\tvar texture_envAtlas: texture_2d<f32>;\n\tvar texture_envAtlasSampler: sampler;\n#endif\nuniform material_reflectivity: f32;\nfn shinyMipLevel(uv: vec2f) -> f32 {\n\tlet dx: vec2f = dpdx(uv);\n\tlet dy: vec2f = dpdy(uv);\n\tlet uv2: vec2f = vec2f(fract(uv.x + 0.5), uv.y);\n\tlet dx2: vec2f = dpdx(uv2);\n\tlet dy2: vec2f = dpdy(uv2);\n\tlet maxd: f32 = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0 + uniform.textureBias, 0.0, 5.0);\n}\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n\tlet dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);\n\tlet uv: vec2f = toSphericalUv(dir);\n\tlet level: f32 = saturate(1.0 - gloss) * 5.0;\n\tlet ilevel: f32 = floor(level);\n\tlet level2: f32 = shinyMipLevel(uv * atlasSize);\n\tlet ilevel2: f32 = floor(level2);\n\tvar uv0: vec2f;\n\tvar uv1: vec2f;\n\tvar weight: f32;\n\tif (ilevel == 0.0) {\n\t\tuv0 = mapShinyUv(uv, ilevel2);\n\t\tuv1 = mapShinyUv(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = mapRoughnessUv(uv, ilevel);\n\t\tuv1 = uv0;\n\t\tweight = 0.0;\n\t}\n\tlet linearA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv0));\n\tlet linearB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv1));\n\tlet linear0: vec3f = mix(linearA, linearB, weight);\n\tlet linear1: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n\tdReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\tuniform matrix_view: mat4x4f;\n#endif\nvar texture_sphereMap: texture_2d<f32>;\nvar texture_sphereMapSampler: sampler;\nuniform material_reflectivity: f32;\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n\tlet viewRotationMatrix = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);\n\tlet reflDirV: vec3f = viewRotationMatrix * reflDir;\n\tlet m: f32 = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));\n\tlet sphereMapUv: vec2f = reflDirV.xy / m + 0.5;\n\treturn {reflectionDecode}(textureSample(texture_sphereMap, texture_sphereMapSampler, sphereMapUv));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n\tdReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionSheenPS:"\nfn addReflectionSheen(worldNormal: vec3f, viewDir: vec3f, gloss: f32) {\n\tlet NoV: f32 = dot(worldNormal, viewDir);\n\tlet alphaG: f32 = gloss * gloss;\n\tlet a: f32 = select(\n\t\t-8.48 * alphaG + 14.3 * gloss - 9.95,\n\t\t-339.2 * alphaG + 161.4 * gloss - 25.9,\n\t\tgloss < 0.25\n\t);\n\tlet b: f32 = select(\n\t\t1.97 * alphaG - 3.27 * gloss + 0.72,\n\t\t44.0 * alphaG - 23.7 * gloss + 3.26,\n\t\tgloss < 0.25\n\t);\n\tlet dg_add: f32 = select(\n\t\t0.1 * ( gloss - 0.25 ),\n\t\t0.0,\n\t\tgloss < 0.25\n\t);\n\tlet dg: f32 = exp( a * NoV + b ) + dg_add;\n\tsReflection = sReflection + (calcReflection(worldNormal, 0.0) * saturate(dg));\n}",refractionCubePS:"\nfn refract2(viewVec: vec3f, normal: vec3f, IOR: f32) -> vec3f {\n\tlet vn: f32 = dot(viewVec, normal);\n\tlet k: f32 = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tlet refrVec: vec3f = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n\treturn refrVec;\n}\nfn addRefraction(\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\tthickness: f32,\n\tgloss: f32,\n\tspecularity: vec3f,\n\talbedo: vec3f,\n\ttransmission: f32,\n\trefractionIndex: f32,\n\tdispersion: f32\n#if defined(LIT_IRIDESCENCE)\n\t, iridescenceFresnel: vec3f,\n\tiridescenceIntensity: f32\n#endif\n) {\n\tlet tmpRefl: vec4f = dReflection;\n\tlet reflectionDir: vec3f = refract2(-viewDir, worldNormal, refractionIndex);\n\tdReflection = vec4f(0.0);\n\taddReflection(reflectionDir, gloss);\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n\tdReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform material_invAttenuationDistance: f32;\nuniform material_attenuation: vec3f;\nfn evalRefractionColor(refractionVector: vec3f, gloss: f32, refractionIndex: f32) -> vec3f {\n\tlet pointOfRefraction: vec4f = vec4f(vPositionW + refractionVector, 1.0);\n\tlet projectionPoint: vec4f = uniform.matrix_viewProjection * pointOfRefraction;\n\tlet uv: vec2f = getGrabScreenPos(projectionPoint);\n\tlet iorToRoughness: f32 = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n\tlet refractionLod: f32 = log2(uniform.uScreenSize.x) * iorToRoughness;\n\tlet refraction: vec3f = textureSampleLevel(uSceneColorMap, uSceneColorMapSampler, uv, refractionLod).rgb;\n\treturn refraction;\n}\nfn addRefraction(\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\tthickness: f32,\n\tgloss: f32,\n\tspecularity: vec3f,\n\talbedo: vec3f,\n\ttransmission: f32,\n\trefractionIndex: f32,\n\tdispersion: f32,\n#if defined(LIT_IRIDESCENCE)\n\tiridescenceFresnel: vec3f,\n\tiridescenceIntensity: f32\n#endif\n) {\n\tvar modelScale: vec3f;\n\tmodelScale.x = length(uniform.matrix_model[0].xyz);\n\tmodelScale.y = length(uniform.matrix_model[1].xyz);\n\tmodelScale.z = length(uniform.matrix_model[2].xyz);\n\tlet scale: vec3f = thickness * modelScale;\n\tvar refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n\tvar refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n\t#ifdef LIT_DISPERSION\n\t\tlet halfSpread: f32 = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n\t\tlet refractionIndexR: f32 = refractionIndex - halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n\t\trefraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n\t\tlet refractionIndexB: f32 = refractionIndex + halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n\t\trefraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n\t#endif\n\tvar transmittance: vec3f;\n\tif (uniform.material_invAttenuationDistance != 0.0)\n\t{\n\t\tlet attenuation: vec3f = -log(uniform.material_attenuation) * uniform.material_invAttenuationDistance;\n\t\ttransmittance = exp(-attenuation * length(refractionVector));\n\t}\n\telse\n\t{\n\t\ttransmittance = refraction;\n\t}\n\tlet fresnel: vec3f = vec3f(1.0) -\n\t\tgetFresnel(\n\t\t\tdot(viewDir, worldNormal),\n\t\t\tgloss,\n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t);\n\tdDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:'\nvarying vUv0: vec2f;\n#ifdef CUBEMAP_SOURCE\n\tvar sourceCube: texture_cube<f32>;\n\tvar sourceCubeSampler : sampler;\n#else\n\tvar sourceTex: texture_2d<f32>;\n\tvar sourceTexSampler : sampler;\n#endif\n#ifdef USE_SAMPLES_TEX\n\tvar samplesTex: texture_2d<f32>;\n\tvar samplesTexSampler : sampler;\n\tuniform samplesTexInverseSize: vec2f;\n#endif\nuniform params: vec3f;\nfn targetFace() -> f32 { return uniform.params.x; }\nfn targetTotalPixels() -> f32 { return uniform.params.y; }\nfn sourceTotalPixels() -> f32 { return uniform.params.z; }\nconst PI: f32 = 3.141592653589793;\nfn saturate(x: f32) -> f32 {\n\treturn clamp(x, 0.0, 1.0);\n}\n#include "decodePS"\n#include "encodePS"\nfn modifySeams(dir: vec3f, scale: f32) -> vec3f {\n\tlet adir = abs(dir);\n\tlet M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3f(\n\t\tselect(scale, 1.0, adir.x == M),\n\t\tselect(scale, 1.0, adir.y == M),\n\t\tselect(scale, 1.0, adir.z == M)\n\t);\n}\nfn toSpherical(dir: vec3f) -> vec2f {\n\tlet nonZeroXZ = any(dir.xz != vec2f(0.0, 0.0));\n\treturn vec2f(select(0.0, atan2(dir.x, dir.z), nonZeroXZ), asin(dir.y));\n}\nfn fromSpherical(uv: vec2f) -> vec3f {\n\treturn vec3f(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nfn getDirectionEquirect(uv: vec2f) -> vec3f {\n\treturn fromSpherical((vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0) * vec2f(PI, PI * 0.5));\n}\nfn signNotZero(k: f32) -> f32 {\n\treturn select(-1.0, 1.0, k >= 0.0);\n}\nfn signNotZeroVec2(v: vec2f) -> vec2f {\n\treturn vec2f(signNotZero(v.x), signNotZero(v.y));\n}\nfn octDecode(o: vec2f) -> vec3f {\n\tvar v = vec3f(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tvar temp: vec2f = (1.0 - abs(v.zx)) * signNotZeroVec2(v.xz);\n\t\tv = vec3f(temp.x, v.y, temp.y);\n\t}\n\treturn normalize(v);\n}\nfn getDirectionOctahedral(uv: vec2f) -> vec3f {\n\treturn octDecode(vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0);\n}\nfn octEncode(v: vec3f) -> vec2f {\n\tlet l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvar result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZeroVec2(result.xy);\n\t}\n\treturn result;\n}\n#ifdef CUBEMAP_SOURCE\n\tfn sampleCubemapDir(dir: vec3f) -> vec4f {\n\t\treturn textureSample(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0));\n\t}\n\tfn sampleCubemapSph(sph: vec2f) -> vec4f {\n\t\treturn sampleCubemapDir(fromSpherical(sph));\n\t}\n\tfn sampleCubemapDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n\t\treturn textureSampleLevel(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0), mipLevel);\n\t}\n\tfn sampleCubemapSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n\t\treturn sampleCubemapDirLod(fromSpherical(sph), mipLevel);\n\t}\n#else\n\tfn sampleEquirectSph(sph: vec2f) -> vec4f {\n\t\tlet uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n\t\treturn textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n\t}\n\tfn sampleEquirectDir(dir: vec3f) -> vec4f {\n\t\treturn sampleEquirectSph(toSpherical(dir));\n\t}\n\tfn sampleEquirectSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n\t\tlet uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n\t\treturn textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tfn sampleEquirectDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n\t\treturn sampleEquirectSphLod(toSpherical(dir), mipLevel);\n\t}\n\tfn sampleOctahedralDir(dir: vec3f) -> vec4f {\n\t\tlet uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n\t}\n\tfn sampleOctahedralSph(sph: vec2f) -> vec4f {\n\t\treturn sampleOctahedralDir(fromSpherical(sph));\n\t}\n\tfn sampleOctahedralDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n\t\tlet uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tfn sampleOctahedralSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n\t\treturn sampleOctahedralDirLod(fromSpherical(sph), mipLevel);\n\t}\n#endif\nfn getDirectionCubemap(uv: vec2f) -> vec3f {\n\tlet st = uv * 2.0 - 1.0;\n\tlet face = targetFace();\n\tvar vec: vec3f;\n\tif (face == 0.0) {\n\t\tvec = vec3f(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3f(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3f(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3f(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3f(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3f(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0));\n}\nfn matrixFromVector(n: vec3f) -> mat3x3f {\n\tlet a = 1.0 / (1.0 + n.z);\n\tlet b = -n.x * n.y * a;\n\tlet b1 = vec3f(1.0 - n.x * n.x * a, b, -n.x);\n\tlet b2 = vec3f(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3x3f(b1, b2, n);\n}\nfn matrixFromVectorSlow(n: vec3f) -> mat3x3f {\n\tlet up = select(vec3f(0.0, 0.0, select(-1.0, 1.0, n.y > 0.0)), vec3f(0.0, 1.0, 0.0), abs(n.y) > 0.0000001);\n\tlet x = normalize(cross(up, n));\n\tlet y = cross(n, x);\n\treturn mat3x3f(x, y, n);\n}\nfn reproject(uv: vec2f) -> vec4f {\n\tif ({NUM_SAMPLES} <= 1) {\n\t\treturn {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}Dir({TARGET_FUNC}(uv))));\n\t} else {\n\t\tlet t = {TARGET_FUNC}(uv);\n\t\tlet tu = dpdx(t);\n\t\tlet tv = dpdy(t);\n\t\tvar result = vec3f(0.0);\n\t\tfor (var u = 0.0; u < {NUM_SAMPLES_SQRT}; u += 1.0) {\n\t\t\tfor (var v = 0.0; v < {NUM_SAMPLES_SQRT}; v += 1.0) {\n\t\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}Dir(normalize(t +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n\t\t\t}\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n\t}\n}\nconst unpackFloat: vec4f = vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n\tfn unpackSample(i: i32, L: ptr<function, vec3f>, mipLevel: ptr<function, f32>) {\n\t\tvar u = (f32(i * 4) + 0.5) * uniform.samplesTexInverseSize.x;\n\t\tvar v = (floor(u) + 0.5) * uniform.samplesTexInverseSize.y;\n\t\tvar raw: vec4f;\n\t\traw.x = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n\t\traw.y = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n\t\traw.z = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n\t\traw.w = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat);\n\t\t*L = raw.xyz * 2.0 - 1.0;\n\t\t*mipLevel = raw.w * 8.0;\n\t}\n\tfn prefilterSamples(uv: vec2f) -> vec4f {\n\t\tlet vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n\t\tvar L: vec3f;\n\t\tvar mipLevel: f32;\n\t\tvar result = vec3f(0.0);\n\t\tvar totalWeight = 0.0;\n\t\tfor (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n\t\t\tunpackSample(i, &L, &mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel)) * L.z;\n\t\t\ttotalWeight += L.z;\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / totalWeight);\n\t}\n\tfn prefilterSamplesUnweighted(uv: vec2f) -> vec4f {\n\t\tlet vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n\t\tvar L: vec3f;\n\t\tvar mipLevel: f32;\n\t\tvar result = vec3f(0.0);\n\t\tfor (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n\t\t\tunpackSample(i, &L, &mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel));\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / f32({NUM_SAMPLES}));\n\t}\n#endif\n@fragment\nfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\toutput.color = {PROCESS_FUNC}(input.vUv0);\n\treturn output;\n}\n',reprojectVS:"\nattribute vertex_position: vec2f;\nuniform uvMod: vec4f;\nvarying vUv0: vec2f;\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n\tvar output: VertexOutput;\n\toutput.position = vec4f(input.vertex_position, 0.5, 1.0);\n\toutput.vUv0 = getImageEffectUV((input.vertex_position * 0.5 + vec2f(0.5, 0.5)) * uniform.uvMod.xy + uniform.uvMod.zw);\n\treturn output;\n}\n",screenDepthPS:"\nvar uSceneDepthMap: texture_2d<f32>;\nvar uSceneDepthMapSampler: sampler;\n#ifndef SCREENSIZE\n\t#define SCREENSIZE\n\tuniform uScreenSize: vec4f;\n#endif\n#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\tuniform matrix_view: mat4x4f;\n#endif\n#ifndef LINEARIZE_DEPTH\n\t#define LINEARIZE_DEPTH\n\t#ifndef CAMERAPLANES\n\t\t#define CAMERAPLANES\n\t\tuniform camera_params: vec4f;\n\t#endif\n\tfn linearizeDepth(z: f32) -> f32 {\n\t\tif (uniform.camera_params.w == 0.0) {\n\t\t\treturn (uniform.camera_params.z * uniform.camera_params.y) / (uniform.camera_params.y + z * (uniform.camera_params.z - uniform.camera_params.y));\n\t\t} else {\n\t\t\treturn uniform.camera_params.z + z * (uniform.camera_params.y - uniform.camera_params.z);\n\t\t}\n\t}\n#endif\nfn delinearizeDepth(linearDepth: f32) -> f32 {\n\tif (uniform.camera_params.w == 0.0) {\n\t\treturn (uniform.camera_params.y * (uniform.camera_params.z - linearDepth)) / (linearDepth * (uniform.camera_params.z - uniform.camera_params.y));\n\t} else {\n\t\treturn (linearDepth - uniform.camera_params.z) / (uniform.camera_params.y - uniform.camera_params.z);\n\t}\n}\nfn getLinearScreenDepth(uv: vec2f) -> f32 {\n\t#ifdef SCENE_DEPTHMAP_LINEAR\n\t\t#ifdef SCENE_DEPTHMAP_FLOAT\n\t\t\treturn textureSample(uSceneDepthMap, uSceneDepthMapSampler, uv).r;\n\t\t#else\n\t\t\tlet textureSize = textureDimensions(uSceneDepthMap, 0);\n\t\t\tlet texel: vec2i = vec2i(uv * vec2f(textureSize));\n\t\t\tlet data: vec4f = textureLoad(uSceneDepthMap, texel, 0);\n\t\t\tlet data_u32: vec4u = vec4u(data * 255.0);\n\t\t\tlet intBits: u32 = (data_u32.r << 24u) | (data_u32.g << 16u) | (data_u32.b << 8u) | data_u32.a;\n\t\t\treturn bitcast<f32>(intBits);\n\t\t#endif\n\t#else\n\t\treturn linearizeDepth(textureSample(uSceneDepthMap, uSceneDepthMapSampler, uv).r);\n\t#endif\n}\n#ifndef VERTEXSHADER\n\tfn getLinearScreenDepthFrag() -> f32 {\n\t\tlet uv: vec2f = pcPosition.xy * uniform.uScreenSize.zw;\n\t\treturn getLinearScreenDepth(uv);\n\t}\n#endif\nfn getLinearDepth(pos: vec3f) -> f32 {\n\treturn -(uniform.matrix_view * vec4f(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nfn getShadowCascadeIndex(shadowCascadeDistances: vec4f, shadowCascadeCount: i32) -> i32 {\n\tlet depth: f32 = 1.0 / pcPosition.w;\n\tlet comparisons: vec4f = step(shadowCascadeDistances, vec4f(depth));\n\tlet cascadeIndex: i32 = i32(dot(comparisons, vec4f(1.0)));\n\treturn min(cascadeIndex, shadowCascadeCount - 1);\n}\nfn ditherShadowCascadeIndex(cascadeIndex_in: i32, shadowCascadeDistances: vec4f, shadowCascadeCount: i32, blendFactor: f32) -> i32 {\n\tvar cascadeIndex: i32 = cascadeIndex_in;\n\tif (cascadeIndex < shadowCascadeCount - 1) {\n\t\tlet currentRangeEnd: f32 = shadowCascadeDistances[cascadeIndex];\n\t\tlet transitionStart: f32 = blendFactor * currentRangeEnd;\n\t\tlet depth: f32 = 1.0 / pcPosition.w;\n\t\tif (depth > transitionStart) {\n\t\t\tlet transitionFactor: f32 = smoothstep(transitionStart, currentRangeEnd, depth);\n\t\t\tlet dither: f32 = fract(sin(dot(pcPosition.xy, vec2f(12.9898, 78.233))) * 43758.5453);\n\t\t\tif (dither < transitionFactor) {\n\t\t\t\tcascadeIndex = cascadeIndex + 1;\n\t\t\t}\n\t\t}\n\t}\n\treturn cascadeIndex;\n}\nfn fadeShadow(shadowCoord_in: vec3f, shadowCascadeDistances: vec4f) -> vec3f {\n\tvar shadowCoord: vec3f = shadowCoord_in;\n\tlet depth: f32 = 1.0 / pcPosition.w;\n\tif (depth > shadowCascadeDistances.w) {\n\t\tshadowCoord.z = -9999999.0;\n\t}\n\treturn shadowCoord;\n}\n",shadowEVSMPS:"\nfn linstep(a: f32, b: f32, v: f32) -> f32 {\n\treturn clamp((v - a) / (b - a), 0.0, 1.0);\n}\nfn reduceLightBleeding(pMax: f32, amount: f32) -> f32 {\n\t return linstep(amount, 1.0, pMax);\n}\nfn chebyshevUpperBound(moments: vec2f, mean: f32, minVariance: f32, lightBleedingReduction: f32) -> f32 {\n\tvar variance: f32 = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tlet d: f32 = mean - moments.x;\n\tvar pMax: f32 = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn select(pMax, 1.0, mean <= moments.x);\n}\nfn calculateEVSM(moments_in: vec3f, Z_in: f32, vsmBias: f32, exponent: f32) -> f32 {\n\tlet Z: f32 = 2.0 * Z_in - 1.0;\n\tlet warpedDepth: f32 = exp(exponent * Z);\n\tlet moments: vec2f = moments_in.xy + vec2f(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments_in.z);\n\tlet VSMBias: f32 = vsmBias;\n\tlet depthScale: f32 = VSMBias * exponent * warpedDepth;\n\tlet minVariance1: f32 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments, warpedDepth, minVariance1, 0.1);\n}\nfn VSM16(tex: texture_2d<f32>, texSampler: sampler, texCoords: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {\n\tlet moments: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfn getShadowVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {\n\treturn VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfn getShadowSpotVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {\n\tlet Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);\n}\nfn VSM32(tex: texture_2d<f32>, texSampler: sampler, texCoords_in: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {\n\t#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE\n\t\tvar moments: vec3f = textureSampleLevel(tex, texSampler, texCoords_in, 0.0).xyz;\n\t#else\n\t\tvar pixelSize : f32 = 1.0 / resolution;\n\t\tlet texCoords: vec2f = texCoords_in - vec2f(pixelSize);\n\t\tlet s00: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;\n\t\tlet s10: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize, 0.0), 0.0).xyz;\n\t\tlet s01: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(0.0, pixelSize), 0.0).xyz;\n\t\tlet s11: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize), 0.0).xyz;\n\t\tlet fr: vec2f = fract(texCoords * resolution);\n\t\tlet h0: vec3f = mix(s00, s10, fr.x);\n\t\tlet h1: vec3f = mix(s01, s11, fr.x);\n\t\tvar moments: vec3f = mix(h0, h1, fr.y);\n\t#endif\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfn getShadowVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {\n\treturn VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfn getShadowSpotVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {\n\tlet Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);\n}\n",shadowPCF1PS:"\nfn getShadowPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);\n}\nfn getShadowSpotPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);\n}\n",shadowPCF3PS:"\nfn _getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {\n\tlet z: f32 = shadowCoord.z;\n\tlet uv: vec2f = shadowCoord.xy * shadowParams.x;\n\tlet shadowMapSizeInv: f32 = 1.0 / shadowParams.x;\n\tlet base_uv_temp: vec2f = floor(uv + 0.5);\n\tlet s: f32 = (uv.x + 0.5 - base_uv_temp.x);\n\tlet t: f32 = (uv.y + 0.5 - base_uv_temp.y);\n\tlet base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;\n\tvar sum: f32 = 0.0;\n\tlet uw0: f32 = (3.0 - 2.0 * s);\n\tlet uw1: f32 = (1.0 + 2.0 * s);\n\tlet u0_offset: f32 = (2.0 - s) / uw0 - 1.0;\n\tlet u1_offset: f32 = s / uw1 + 1.0;\n\tlet vw0: f32 = (3.0 - 2.0 * t);\n\tlet vw1: f32 = (1.0 + 2.0 * t);\n\tlet v0_offset: f32 = (2.0 - t) / vw0 - 1.0;\n\tlet v1_offset: f32 = t / vw1 + 1.0;\n\tlet u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;\n\tlet v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;\n\tlet u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;\n\tlet v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;\n\tsum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);\n\tsum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);\n\tsum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);\n\tsum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);\n\tsum = sum * (1.0 / 16.0);\n\treturn sum;\n}\nfn getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\nfn getShadowSpotPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\n",shadowPCF5PS:"\nfn _getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {\n\tlet z: f32 = shadowCoord.z;\n\tlet uv: vec2f = shadowCoord.xy * shadowParams.x;\n\tlet shadowMapSizeInv: f32 = 1.0 / shadowParams.x;\n\tlet base_uv_temp: vec2f = floor(uv + 0.5);\n\tlet s: f32 = (uv.x + 0.5 - base_uv_temp.x);\n\tlet t: f32 = (uv.y + 0.5 - base_uv_temp.y);\n\tlet base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;\n\tlet uw0: f32 = (4.0 - 3.0 * s);\n\tlet uw1: f32 = 7.0;\n\tlet uw2: f32 = (1.0 + 3.0 * s);\n\tlet u0_offset: f32 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tlet u1_offset: f32 = (3.0 + s) / uw1;\n\tlet u2_offset: f32 = s / uw2 + 2.0;\n\tlet vw0: f32 = (4.0 - 3.0 * t);\n\tlet vw1: f32 = 7.0;\n\tlet vw2: f32 = (1.0 + 3.0 * t);\n\tlet v0_offset: f32 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tlet v1_offset: f32 = (3.0 + t) / vw1;\n\tlet v2_offset: f32 = t / vw2 + 2.0;\n\tvar sum: f32 = 0.0;\n\tlet u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;\n\tlet v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;\n\tlet u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;\n\tlet v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;\n\tlet u2: f32 = u2_offset * shadowMapSizeInv + base_uv.x;\n\tlet v2: f32 = v2_offset * shadowMapSizeInv + base_uv.y;\n\tsum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);\n\tsum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);\n\tsum = sum + uw2 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v0), z);\n\tsum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);\n\tsum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);\n\tsum = sum + uw2 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v1), z);\n\tsum = sum + uw0 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v2), z);\n\tsum = sum + uw1 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v2), z);\n\tsum = sum + uw2 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v2), z);\n\tsum = sum * (1.0 / 144.0);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfn getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\nfn getShadowSpotPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\n",shadowSoftPS:"\nfn fractSinRand(uv: vec2f) -> f32 {\n\tlet PI: f32 = 3.141592653589793;\n\tlet a: f32 = 12.9898; let b: f32 = 78.233; let c: f32 = 43758.5453;\n\tlet dt: f32 = dot(uv.xy, vec2f(a, b));\n\tlet sn: f32 = dt % PI;\n\treturn fract(sin(sn) * c);\n}\nstruct VogelDiskData {\n\tinvNumSamples: f32,\n\tinitialAngle: f32,\n\tcurrentPointId: f32,\n}\nfn prepareDiskConstants(data: ptr<function, VogelDiskData>, sampleCount: i32, randomSeed: f32) {\n\tlet pi2: f32 = 6.28318530718;\n\tdata.invNumSamples = 1.0 / f32(sampleCount);\n\tdata.initialAngle = randomSeed * pi2;\n\tdata.currentPointId = 0.0;\n}\nfn generateDiskSample(data: ptr<function, VogelDiskData>) -> vec2f {\n\tlet GOLDEN_ANGLE: f32 = 2.399963;\n\tlet r: f32 = sqrt((data.currentPointId + 0.5) * data.invNumSamples);\n\tlet theta: f32 = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;\n\tlet offset: vec2f = vec2f(cos(theta), sin(theta)) * pow(r, 1.33);\n\tdata.currentPointId = data.currentPointId + 1.0;\n\treturn offset;\n}\nfn PCSSFindBlocker(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, avgBlockerDepth: ptr<function, f32>, numBlockers: ptr<function, i32>,\n\tshadowCoords: vec2f, z: f32, shadowBlockerSamples: i32, penumbraSize: f32, invShadowMapSize: f32, randomSeed: f32) {\n\tvar diskData: VogelDiskData;\n\tprepareDiskConstants(&diskData, shadowBlockerSamples, randomSeed);\n\tlet searchWidth: f32 = penumbraSize * invShadowMapSize;\n\tvar blockerSum: f32 = 0.0;\n\tvar numBlockers_local: i32 = 0;\n\tfor( var i: i32 = 0; i < shadowBlockerSamples; i = i + 1 ) {\n\t\tlet diskUV: vec2f = generateDiskSample(&diskData);\n\t\tlet sampleUV: vec2f = shadowCoords + diskUV * searchWidth;\n\t\tlet shadowMapDepth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, sampleUV, 0.0).r;\n\t\tif ( shadowMapDepth < z ) {\n\t\t\tblockerSum = blockerSum + shadowMapDepth;\n\t\t\tnumBlockers_local = numBlockers_local + 1;\n\t\t}\n\t}\n\t*avgBlockerDepth = blockerSum / f32(numBlockers_local);\n\t*numBlockers = numBlockers_local;\n}\nfn PCSSFilter(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, uv: vec2f, receiverDepth: f32, shadowSamples: i32, filterRadius: f32, randomSeed: f32) -> f32 {\n\tvar diskData: VogelDiskData;\n\tprepareDiskConstants(&diskData, shadowSamples, randomSeed);\n\tvar sum: f32 = 0.0;\n\tfor (var i: i32 = 0; i < shadowSamples; i = i + 1) {\n\t\tlet offsetUV: vec2f = generateDiskSample(&diskData) * filterRadius;\n\t\tlet depth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, uv + offsetUV, 0.0).r;\n\t\tsum = sum + step(receiverDepth, depth);\n\t}\n\treturn sum / f32(shadowSamples);\n}\nfn getPenumbra(dblocker: f32, dreceiver: f32, penumbraSize: f32, penumbraFalloff: f32) -> f32 {\n\tlet dist: f32 = dreceiver - dblocker;\n\tlet penumbra: f32 = 1.0 - pow(1.0 - dist, penumbraFalloff);\n\treturn penumbra * penumbraSize;\n}\nfn PCSSDirectional(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoords: vec3f, cameraParams: vec4f, softShadowParams: vec4f) -> f32 {\n\tlet receiverDepth: f32 = shadowCoords.z;\n\tlet randomSeed: f32 = fractSinRand(pcPosition.xy);\n\tlet shadowSamples: i32 = i32(softShadowParams.x);\n\tlet shadowBlockerSamples: i32 = i32(softShadowParams.y);\n\tlet penumbraSize: f32 = softShadowParams.z;\n\tlet penumbraFalloff: f32 = softShadowParams.w;\n\tlet shadowMapSize: i32 = i32(textureDimensions(shadowMap, 0).x);\n\tvar invShadowMapSize: f32 = 1.0 / f32(shadowMapSize);\n\tinvShadowMapSize = invShadowMapSize * (f32(shadowMapSize) / 2048.0);\n\tvar penumbra: f32;\n\tif (shadowBlockerSamples > 0) {\n\t\tvar avgBlockerDepth: f32 = 0.0;\n\t\tvar numBlockers: i32 = 0;\n\t\tPCSSFindBlocker(shadowMap, shadowMapSampler, &avgBlockerDepth, &numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);\n\t\tif (numBlockers < 1) {\n\t\t\treturn 1.0;\n\t\t}\n\t\tpenumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);\n\t} else {\n\t\tpenumbra = penumbraSize;\n\t}\n\tlet filterRadius: f32 = penumbra * invShadowMapSize;\n\treturn PCSSFilter(shadowMap, shadowMapSampler, shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);\n}\nfn getShadowPCSS(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, cameraParams: vec4f, softShadowParams: vec4f, lightDir: vec3f) -> f32 {\n\treturn PCSSDirectional(shadowMap, shadowMapSampler, shadowCoord, cameraParams, softShadowParams);\n}\n",skinBatchVS:"\nattribute vertex_boneIndices: f32;\nvar texture_poseMap: texture_2d<f32>;\nfn getBoneMatrix(indexFloat: f32) -> mat4x4f {\n\tlet width = i32(textureDimensions(texture_poseMap).x);\n\tlet index: i32 = i32(indexFloat + 0.5) * 3;\n\tlet iy: i32 = index / width;\n\tlet ix: i32 = index % width;\n\tlet v1: vec4f = textureLoad(texture_poseMap, vec2i(ix + 0, iy), 0);\n\tlet v2: vec4f = textureLoad(texture_poseMap, vec2i(ix + 1, iy), 0);\n\tlet v3: vec4f = textureLoad(texture_poseMap, vec2i(ix + 2, iy), 0);\n\treturn mat4x4f(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1.0\n\t);\n}\n",skinVS:"\nattribute vertex_boneWeights: vec4f;\nattribute vertex_boneIndices: vec4f;\nvar texture_poseMap: texture_2d<f32>;\nstruct BoneMatrix {\n\tv1: vec4f,\n\tv2: vec4f,\n\tv3: vec4f,\n}\nfn getBoneMatrix(width: i32, index: i32) -> BoneMatrix {\n\tlet v = index / width;\n\tlet u = index % width;\n\tvar result: BoneMatrix;\n\tresult.v1 = textureLoad(texture_poseMap, vec2i(u + 0, v), 0);\n\tresult.v2 = textureLoad(texture_poseMap, vec2i(u + 1, v), 0);\n\tresult.v3 = textureLoad(texture_poseMap, vec2i(u + 2, v), 0);\n\treturn result;\n}\nfn getSkinMatrix(indicesFloat: vec4f, weights: vec4f) -> mat4x4f {\n\tlet width = i32(textureDimensions(texture_poseMap).x);\n\tvar indices = vec4i(indicesFloat + 0.5) * 3;\n\tlet boneA = getBoneMatrix(width, indices.x);\n\tlet boneB = getBoneMatrix(width, indices.y);\n\tlet boneC = getBoneMatrix(width, indices.z);\n\tlet boneD = getBoneMatrix(width, indices.w);\n\tlet v1 = boneA.v1 * weights.x + boneB.v1 * weights.y + boneC.v1 * weights.z + boneD.v1 * weights.w;\n\tlet v2 = boneA.v2 * weights.x + boneB.v2 * weights.y + boneC.v2 * weights.z + boneD.v2 * weights.w;\n\tlet v3 = boneA.v3 * weights.x + boneB.v3 * weights.y + boneC.v3 * weights.z + boneD.v3 * weights.w;\n\tlet one = dot(weights, vec4f(1.0, 1.0, 1.0, 1.0));\n\treturn mat4x4f(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:'\n\t#define LIT_SKYBOX_INTENSITY\n\t#include "envProcPS"\n\t#include "gammaPS"\n\t#include "tonemappingPS"\n\t#ifdef PREPASS_PASS\n\t\tvarying vLinearDepth: f32;\n\t\t#include "floatAsUintPS"\n\t#endif\n\tvarying vViewDir : vec3f;\n\tuniform skyboxHighlightMultiplier : f32;\n\t#ifdef SKY_CUBEMAP\n\t\tvar texture_cubeMap : texture_cube<f32>;\n\t\tvar texture_cubeMap_sampler : sampler;\n\t\t#ifdef SKYMESH\n\t\t\tvarying vWorldPos : vec3f;\n\t\t\tuniform cubeMapRotationMatrix : mat3x3f;\n\t\t\tuniform projectedSkydomeCenter : vec3f;\n\t\t#endif\n\t#else\n\t\t#include "sphericalPS"\n\t\t#include "envAtlasPS"\n\t\tvar texture_envAtlas : texture_2d<f32>;\n\t\tvar texture_envAtlas_sampler : sampler;\n\t\tuniform mipLevel : f32;\n\t#endif\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\t#ifdef PREPASS_PASS\n\t\t\toutput.color = float2vec4(vLinearDepth);\n\t\t#else\n\t\t\tvar linear : vec3f;\n\t\t\tvar dir : vec3f;\n\t\t\t#ifdef SKY_CUBEMAP\n\t\t\t\t#ifdef SKYMESH\n\t\t\t\t\tvar envDir : vec3f = normalize(input.vWorldPos - uniform.projectedSkydomeCenter);\n\t\t\t\t\tdir = envDir * uniform.cubeMapRotationMatrix;\n\t\t\t\t#else\n\t\t\t\t\tdir = input.vViewDir;\n\t\t\t\t#endif\n\t\t\t\tdir.x *= -1.0;\n\t\t\t\tlinear = {SKYBOX_DECODE_FNC}(textureSample(texture_cubeMap, texture_cubeMap_sampler, dir));\n\t\t\t#else\n\t\t\t\tdir = input.vViewDir * vec3f(-1.0, 1.0, 1.0);\n\t\t\t\tlet uv : vec2f = toSphericalUv(normalize(dir));\n\t\t\t\tlinear = {SKYBOX_DECODE_FNC}(textureSample(texture_envAtlas, texture_envAtlas_sampler, mapRoughnessUv(uv, uniform.mipLevel)));\n\t\t\t#endif\n\t\t\tif (any(linear >= vec3f(64.0))) {\n\t\t\t\tlinear *= uniform.skyboxHighlightMultiplier;\n\t\t\t}\n\t\t\t\n\t\t\toutput.color = vec4f(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n\t\t#endif\n\t\treturn output;\n\t}\n',skyboxVS:"\n\tattribute aPosition : vec4f;\n\tuniform matrix_view : mat4x4f;\n\tuniform matrix_projectionSkybox : mat4x4f;\n\tuniform cubeMapRotationMatrix : mat3x3f;\n\tvarying vViewDir : vec3f;\n\t#ifdef PREPASS_PASS\n\t\tvarying vLinearDepth: f32;\n\t#endif\n\t#ifdef SKYMESH\n\t\tuniform matrix_model : mat4x4f;\n\t\tvarying vWorldPos : vec3f;\n\t#endif\n\t@vertex\n\tfn vertexMain(input : VertexInput) -> VertexOutput {\n\t\tvar output : VertexOutput;\n\t\tvar view : mat4x4f = uniform.matrix_view;\n\t\t#ifdef SKYMESH\n\t\t\tvar worldPos : vec4f = uniform.matrix_model * input.aPosition;\n\t\t\toutput.vWorldPos = worldPos.xyz;\n\t\t\toutput.position = uniform.matrix_projectionSkybox * (view * worldPos);\n\t\t\t#ifdef PREPASS_PASS\n\t\t\t\toutput.vLinearDepth = -(uniform.matrix_view * vec4f(worldPos.xyz, 1.0)).z;\n\t\t\t#endif\n\t\t#else\n\t\t\tview[3][0] = 0.0;\n\t\t\tview[3][1] = 0.0;\n\t\t\tview[3][2] = 0.0;\n\t\t\toutput.position = uniform.matrix_projectionSkybox * (view * input.aPosition);\n\t\t\toutput.vViewDir = input.aPosition.xyz * uniform.cubeMapRotationMatrix;\n\t\t\t#ifdef PREPASS_PASS\n\t\t\t\toutput.vLinearDepth = -pcPosition.w;\n\t\t\t#endif\n\t\t#endif\n\t\toutput.position.z = output.position.w - 1.0e-7;\n\t\treturn output;\n\t}\n",specularPS:"\n#ifdef STD_SPECULAR_CONSTANT\n\tuniform material_specular: vec3f;\n#endif\nfn getSpecularity() {\n\tvar specularColor = vec3f(1.0, 1.0, 1.0);\n\t#ifdef STD_SPECULAR_CONSTANT\n\tspecularColor = specularColor * uniform.material_specular;\n\t#endif\n\t#ifdef STD_SPECULAR_TEXTURE\n\tspecularColor = specularColor * {STD_SPECULAR_TEXTURE_DECODE}(textureSampleBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_NAME}Sampler, {STD_SPECULAR_TEXTURE_UV}, uniform.textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULAR_VERTEX\n\tspecularColor = specularColor * saturate3(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularity = specularColor;\n}\n",sphericalPS:"\nfn toSpherical(dir: vec3f) -> vec2f {\n\tlet angle_xz = select(0.0, atan2(dir.x, dir.z), any(dir.xz != vec2f(0.0)));\n\treturn vec2f(angle_xz, asin(dir.y));\n}\nfn toSphericalUv(dir : vec3f) -> vec2f {\n\tconst PI : f32 = 3.141592653589793;\n\tlet uv : vec2f = toSpherical(dir) / vec2f(PI * 2.0, PI) + vec2f(0.5, 0.5);\n\treturn vec2f(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef STD_SPECULARITYFACTOR_CONSTANT\n\tuniform material_specularityFactor: f32;\n#endif\nfn getSpecularityFactor() {\n\tvar specularityFactor = 1.0;\n\t#ifdef STD_SPECULARITYFACTOR_CONSTANT\n\tspecularityFactor = specularityFactor * uniform.material_specularityFactor;\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_TEXTURE\n\tspecularityFactor = specularityFactor * textureSampleBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_NAME}Sampler, {STD_SPECULARITYFACTOR_TEXTURE_UV}, uniform.textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_VERTEX\n\tspecularityFactor = specularityFactor * saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfn getSpotEffect(lightSpotDir: vec3f, lightInnerConeAngle: f32, lightOuterConeAngle: f32, lightDirNorm: vec3f) -> f32 {\n\tlet cosAngle: f32 = dot(lightDirNorm, lightSpotDir);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}",startNineSlicedPS:"\n\tnineSlicedUv = vec2f(vUv0.x, 1.0 - vUv0.y);\n",startNineSlicedTiledPS:"\n\tlet tileMask: vec2f = step(vMask, vec2f(0.99999));\n\tlet tileSize: vec2f = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tlet tileScale: vec2f = vec2f(1.0) / (vec2f(1.0) - tileSize);\n\tvar clampedUv: vec2f = mix(innerOffset.xy * 0.5, vec2f(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tvar nineSlicedUv: vec2f = vUv0 * tileMask + clampedUv * (vec2f(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",stdDeclarationPS:'\n\tvar<private> dAlpha: f32 = 1.0;\n\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t#ifdef STD_OPACITY_TEXTURE_ALLOCATE\n\t\t\tvar texture_opacityMap : texture_2d<f32>;\n\t\t\tvar texture_opacityMapSampler : sampler;\n\t\t#endif\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\tvar<private> dAlbedo: vec3f;\n\t\tvar<private> dNormalW: vec3f;\n\t\tvar<private> dSpecularity: vec3f = vec3f(0.0, 0.0, 0.0);\n\t\tvar<private> dGlossiness: f32 = 0.0;\n\t\t#ifdef LIT_REFRACTION\n\t\t\tvar<private> dTransmission: f32;\n\t\t\tvar<private> dThickness: f32;\n\t\t#endif\n\t\t#ifdef LIT_SCENE_COLOR\n\t\t\tvar uSceneColorMap : texture_2d<f32>;\n\t\t\tvar uSceneColorMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef LIT_SCREEN_SIZE\n\t\t\tuniform uScreenSize: vec4f;\n\t\t#endif\n\t\t#ifdef LIT_TRANSFORMS\n\t\t\tvar<private> matrix_viewProjection: mat4x4f;\n\t\t\tvar<private> matrix_model: mat4x4f;\n\t\t#endif\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\tvar<private> dUvOffset: vec2f;\n\t\t\t#ifdef STD_HEIGHT_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_heightMap : texture_2d<f32>;\n\t\t\t\tvar texture_heightMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n\t\t\tvar texture_diffuseMap : texture_2d<f32>;\n\t\t\tvar texture_diffuseMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE\n\t\t\tvar texture_diffuseDetailMap : texture_2d<f32>;\n\t\t\tvar texture_diffuseDetailMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_NORMAL_TEXTURE_ALLOCATE\n\t\t\tvar texture_normalMap : texture_2d<f32>;\n\t\t\tvar texture_normalMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE\n\t\t\tvar texture_normalDetailMap : texture_2d<f32>;\n\t\t\tvar texture_normalDetailMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_THICKNESS_TEXTURE_ALLOCATE\n\t\t\tvar texture_thicknessMap : texture_2d<f32>;\n\t\t\tvar texture_thicknessMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_REFRACTION_TEXTURE_ALLOCATE\n\t\t\tvar texture_refractionMap : texture_2d<f32>;\n\t\t\tvar texture_refractionMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tvar<private> dIridescence: f32;\n\t\t\tvar<private> dIridescenceThickness: f32;\n\t\t\t#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_iridescenceThicknessMap : texture_2d<f32>;\n\t\t\t\tvar texture_iridescenceThicknessMapSampler : sampler;\n\t\t\t#endif\n\t\t\t#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_iridescenceMap : texture_2d<f32>;\n\t\t\t\tvar texture_iridescenceMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tvar<private> ccSpecularity: f32;\n\t\t\tvar<private> ccGlossiness: f32;\n\t\t\tvar<private> ccNormalW: vec3f;\n\t\t#endif\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\tvar<private> dAnisotropy: f32;\n\t\t\tvar<private> dAnisotropyRotation: vec2f;\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tvar<private> sSpecularity: vec3f;\n\t\t\t\tvar<private> sGlossiness: f32;\n\t\t\t\t#ifdef STD_SHEEN_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_sheenMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_sheenMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t\t#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_sheenGlossMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_sheenGlossMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\tvar<private> dMetalness: f32;\n\t\t\t\tvar<private> dIor: f32;\n\t\t\t\t#ifdef STD_METALNESS_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_metalnessMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_metalnessMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tvar<private> dSpecularityFactor: f32;\n\t\t\t\t#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_specularityFactorMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_specularityFactorMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#ifdef STD_SPECULAR_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_specularMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_specularMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_GLOSS_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_glossMap : texture_2d<f32>;\n\t\t\t\tvar texture_glossMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\tvar <private> dAo: f32;\n\t\t\t#ifdef STD_AO_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_aoMap : texture_2d<f32>;\n\t\t\t\tvar texture_aoMapSampler : sampler;\n\t\t\t#endif\n\t\t\t#ifdef STD_AODETAIL_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_aoDetailMap : texture_2d<f32>;\n\t\t\t\tvar texture_aoDetailMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\tvar <private> dEmission: vec3f;\n\t\t#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE\n\t\t\tvar texture_emissiveMap : texture_2d<f32>;\n\t\t\tvar texture_emissiveMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_clearCoatMap : texture_2d<f32>;\n\t\t\t\tvar texture_clearCoatMapSampler : sampler;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_clearCoatGlossMap : texture_2d<f32>;\n\t\t\t\tvar texture_clearCoatGlossMapSampler : sampler;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_clearCoatNormalMap : texture_2d<f32>;\n\t\t\t\tvar texture_clearCoatNormalMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_anisotropyMap : texture_2d<f32>;\n\t\t\t\tvar texture_anisotropyMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\tvar<private> dLightmap: vec3f;\n\t\t\t#ifdef STD_LIGHT_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_lightMap : texture_2d<f32>;\n\t\t\t\tvar texture_lightMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#include "litShaderCorePS"\n',stdFrontEndPS:'\n\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t#include "opacityPS"\n\t\t#if defined(LIT_ALPHA_TEST)\n\t\t\t#include "alphaTestPS"\n\t\t#endif\n\t\t#if STD_OPACITY_DITHER != NONE\n\t\t\t#include "opacityDitherPS"\n\t\t#endif\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t#include "parallaxPS"\n\t\t#endif\n\t\t#include  "diffusePS"\n\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t#include "normalMapPS"\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\t#include "transmissionPS"\n\t\t\t#include "thicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t#include "iridescencePS"\n\t\t\t#include "iridescenceThicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t#include "sheenPS"\n\t\t\t\t#include "sheenGlossPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t#include "metalnessPS"\n\t\t\t\t#include "iorPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t#include "specularityFactorPS"\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#include "specularPS"\n\t\t\t#else\n\t\t\t\tfn getSpecularity() { \n\t\t\t\t\tdSpecularity = vec3f(1.0, 1.0, 1.0);\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#include "glossPS"\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\t#include "aoPS"\n\t\t#endif\n\t\t#include "emissivePS"\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#include "clearCoatPS"\n\t\t\t#include "clearCoatGlossPS"\n\t\t\t#include "clearCoatNormalPS"\n\t\t#endif\n\t\t#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n\t\t\t#include "anisotropyPS"\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t#include "lightmapPS"\n\t\t#endif\n\t#endif\n\tfn evaluateFrontend() {\n\t\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t\tgetOpacity();\n\t\t\t#if defined(LIT_ALPHA_TEST)\n\t\t\t\talphaTest(dAlpha);\n\t\t\t#endif\n\t\t\t#if STD_OPACITY_DITHER != NONE\n\t\t\t\topacityDither(dAlpha, 0.0);\n\t\t\t#endif\n\t\t\tlitArgs_opacity = dAlpha;\n\t\t#endif\n\t\t#ifdef FORWARD_PASS\n\t\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t\tgetParallax();\n\t\t\t#endif\n\t\t\tgetAlbedo();\n\t\t\tlitArgs_albedo = dAlbedo;\n\t\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t\tgetNormal();\n\t\t\t\tlitArgs_worldNormal = dNormalW;\n\t\t\t#endif\n\t\t\t#ifdef LIT_REFRACTION\n\t\t\t\tgetRefraction();\n\t\t\t\tlitArgs_transmission = dTransmission;\n\t\t\t\tgetThickness();\n\t\t\t\tlitArgs_thickness = dThickness;\n\t\t\t\t#ifdef LIT_DISPERSION\n\t\t\t\t\tlitArgs_dispersion = uniform.material_dispersion;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t\tgetIridescence();\n\t\t\t\tgetIridescenceThickness();\n\t\t\t\tlitArgs_iridescence_intensity = dIridescence;\n\t\t\t\tlitArgs_iridescence_thickness = dIridescenceThickness;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tgetSheen();\n\t\t\t\t\tlitArgs_sheen_specularity = sSpecularity;\n\t\t\t\t\tgetSheenGlossiness();\n\t\t\t\t\tlitArgs_sheen_gloss = sGlossiness;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t\tgetMetalness();\n\t\t\t\t\tlitArgs_metalness = dMetalness;\n\t\t\t\t\tgetIor();\n\t\t\t\t\tlitArgs_ior = dIor;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t\tgetSpecularityFactor();\n\t\t\t\t\tlitArgs_specularityFactor = dSpecularityFactor;\n\t\t\t\t#endif\n\t\t\t\tgetGlossiness();\n\t\t\t\tgetSpecularity();\n\t\t\t\tlitArgs_specularity = dSpecularity;\n\t\t\t\tlitArgs_gloss = dGlossiness;\n\t\t\t#endif\n\t\t\t#ifdef STD_AO\n\t\t\t\tgetAO();\n\t\t\t\tlitArgs_ao = dAo;\n\t\t\t#endif\n\t\t\tgetEmission();\n\t\t\tlitArgs_emission = dEmission;\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tgetClearCoat();\n\t\t\t\tgetClearCoatGlossiness();\n\t\t\t\tgetClearCoatNormal();\n\t\t\t\tlitArgs_clearcoat_specularity = ccSpecularity;\n\t\t\t\tlitArgs_clearcoat_gloss = ccGlossiness;\n\t\t\t\tlitArgs_clearcoat_worldNormal = ccNormalW;\n\t\t\t#endif\n\t\t\t#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n\t\t\t\tgetAnisotropy();\n\t\t\t#endif\n\t\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t\tgetLightMap();\n\t\t\t\tlitArgs_lightmap = dLightmap;\n\t\t\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\t\t\tlitArgs_lightmapDir = dLightmapDir;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#endif\n\t}\n',TBNPS:"\n#ifdef LIT_TANGENTS\n\t#define TBN_TANGENTS\n#else\n\t#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n\t\t#define TBN_DERIVATIVES\n\t#endif\n#endif\n#if defined(TBN_DERIVATIVES)\n\tuniform tbnBasis: f32;\n#endif\nfn getTBN(tangent: vec3f, binormal: vec3f, normal: vec3f) {\n\t#ifdef TBN_TANGENTS\n\t\tdTBN = mat3x3f(normalize(tangent), normalize(binormal), normalize(normal));\n\t#elif defined(TBN_DERIVATIVES)\n\t\tlet uv: vec2f = {lightingUv};\n\t\tlet dp1: vec3f = dpdx( vPositionW );\n\t\tlet dp2: vec3f = dpdy( vPositionW );\n\t\tlet duv1: vec2f = dpdx( uv );\n\t\tlet duv2: vec2f = dpdy( uv );\n\t\tlet dp2perp: vec3f = cross( dp2, normal );\n\t\tlet dp1perp: vec3f = cross( normal, dp1 );\n\t\tlet T: vec3f = dp2perp * duv1.x + dp1perp * duv2.x;\n\t\tlet B: vec3f = dp2perp * duv1.y + dp1perp * duv2.y;\n\t\tlet denom: f32 = max( dot(T, T), dot(B, B) );\n\t\tlet invmax: f32 = select(uniform.tbnBasis / sqrt( denom ), 0.0, denom == 0.0);\n\t\tdTBN = mat3x3f(T * invmax, -B * invmax, normal );\n\t#else\n\t\tvar B: vec3f = cross(normal, vObjectSpaceUpW);\n\t\tvar T: vec3f = cross(normal, B);\n\t\tif (dot(B,B) == 0.0)\n\t\t{\n\t\t\tlet major: f32 = max(max(normal.x, normal.y), normal.z);\n\t\t\tif (normal.x == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3f(0.0, 1.0, 0.0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse if (normal.y == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3f(0.0, 0.0, 1.0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3f(1.0, 0.0, 0.0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t}\n\t\tdTBN = mat3x3f(normalize(T), normalize(B), normalize(normal));\n\t#endif\n}",thicknessPS:"\n#ifdef STD_THICKNESS_CONSTANT\nuniform material_thickness: f32;\n#endif\nfn getThickness() {\n\tdThickness = 1.0;\n\t#ifdef STD_THICKNESS_CONSTANT\n\tdThickness = dThickness * uniform.material_thickness;\n\t#endif\n\t#ifdef STD_THICKNESS_TEXTURE\n\tdThickness = dThickness * textureSampleBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_NAME}Sampler, {STD_THICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_THICKNESS_VERTEX\n\tdThickness = dThickness * saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});\n\t#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n\t#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n\t#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n\t#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n\t#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n\t#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n\t#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n\t#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform exposure: f32;\nfn toneMap(color: vec3f) -> vec3f {\n\tlet tA: f32 = 2.51;\n\tlet tB: f32 = 0.03;\n\tlet tC: f32 = 2.43;\n\tlet tD: f32 = 0.59;\n\tlet tE: f32 = 0.14;\n\tlet x: vec3f = color * uniform.exposure;\n\treturn (x * (tA * x + tB)) / (x * (tC * x + tD) + tE);\n}\n",tonemappingAces2PS:"\nuniform exposure: f32;\nconst ACESInputMat: mat3x3f = mat3x3f(\n\tvec3f(0.59719, 0.35458, 0.04823),\n\tvec3f(0.07600, 0.90834, 0.01566),\n\tvec3f(0.02840, 0.13383, 0.83777)\n);\nconst ACESOutputMat: mat3x3f = mat3x3f(\n\tvec3f( 1.60475, -0.53108, -0.07367),\n\tvec3f(-0.10208,  1.10813, -0.00605),\n\tvec3f(-0.00327, -0.07276,  1.07602)\n);\nfn RRTAndODTFit(v: vec3f) -> vec3f {\n\tlet a: vec3f = v * (v + vec3f(0.0245786)) - vec3f(0.000090537);\n\tlet b: vec3f = v * (vec3f(0.983729) * v + vec3f(0.4329510)) + vec3f(0.238081);\n\treturn a / b;\n}\nfn toneMap(color: vec3f) -> vec3f {\n\tvar c: vec3f = color * (uniform.exposure / 0.6);\n\tc = c * ACESInputMat;\n\tc = RRTAndODTFit(c);\n\tc = c * ACESOutputMat;\n\treturn clamp(c, vec3f(0.0), vec3f(1.0));\n}\n",tonemappingFilmicPS:"\nconst A: f32 = 0.15;\nconst B: f32 = 0.50;\nconst C: f32 = 0.10;\nconst D: f32 = 0.20;\nconst E: f32 = 0.02;\nconst F: f32 = 0.30;\nconst W: f32 = 11.2;\nuniform exposure: f32;\nfn uncharted2Tonemap(x: vec3f) -> vec3f {\n\treturn ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - vec3f(E / F);\n}\nfn toneMap(color: vec3f) -> vec3f {\n\tvar c: vec3f = uncharted2Tonemap(color * uniform.exposure);\n\tlet whiteScale: vec3f = vec3f(1.0) / uncharted2Tonemap(vec3f(W, W, W));\n\tc *= whiteScale;\n\treturn c;\n}\n",tonemappingHejlPS:"\nuniform exposure: f32;\nfn toneMap(color: vec3f) -> vec3f {\n\tlet A: f32 = 0.22;\n\tlet B: f32 = 0.3;\n\tlet C: f32 = 0.1;\n\tlet D: f32 = 0.2;\n\tlet E: f32 = 0.01;\n\tlet F: f32 = 0.3;\n\tlet Scl: f32 = 1.25;\n\tlet adjusted_color = color * uniform.exposure;\n\tlet h = max(vec3f(0.0), adjusted_color - vec3f(0.004));\n\treturn (h * ((Scl * A) * h + Scl * vec3f(C * B)) + Scl * vec3f(D * E)) /\n\t\t   (h * (A * h + vec3f(B)) + vec3f(D * F)) -\n\t\t   Scl * vec3f(E / F);\n}\n",tonemappingLinearPS:"\nuniform exposure: f32;\nfn toneMap(color: vec3f) -> vec3f {\n\treturn color * uniform.exposure;\n}\n",tonemappingNeutralPS:"\nuniform exposure: f32;\nfn toneMap(col: vec3f) -> vec3f {\n\tvar color = col * uniform.exposure;\n\tlet startCompression = 0.8 - 0.04;\n\tlet desaturation = 0.15;\n\tlet x = min(color.r, min(color.g, color.b));\n\tlet offset = select(0.04, x - 6.25 * x * x, x < 0.08);\n\tcolor -= vec3f(offset);\n\tlet peak = max(color.r, max(color.g, color.b));\n\tif (peak < startCompression) {\n\t\treturn color;\n\t}\n\tlet d = 1.0 - startCompression;\n\tlet newPeak = 1.0 - d * d / (peak + d - startCompression);\n\tcolor *= newPeak / peak;\n\tlet g = 1.0 - 1.0 / (desaturation * (peak - newPeak) + 1.0);\n\treturn mix(color, vec3f(newPeak), vec3f(g));\n}\n",tonemappingNonePS:"\nfn toneMap(color: vec3f) -> vec3f {\n\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\n\tuniform uScreenSize: vec4f;\n#endif\n#ifdef SCREENSPACE\n\tuniform projectionFlipY: f32;\n#endif\nfn evalWorldPosition(vertexPosition: vec3f, modelMatrix: mat4x4f) -> vec4f {\n\tvar localPos: vec3f = getLocalPosition(vertexPosition);\n\t#ifdef NINESLICED\n\t\tvar localPosXZ: vec2f = localPos.xz;\n\t\tlocalPosXZ = localPosXZ * uniform.outerScale;\n\t\tlet positiveUnitOffset: vec2f = clamp(vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n\t\tlet negativeUnitOffset: vec2f = clamp(-vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n\t\tlocalPosXZ = localPosXZ + (-positiveUnitOffset * uniform.innerOffset.xy + negativeUnitOffset * uniform.innerOffset.zw) * vertex_texCoord0.xy;\n\t\tdTiledUvGlobal = (localPosXZ - uniform.outerScale + uniform.innerOffset.xy) * -0.5 + 1.0;\n\t\tlocalPosXZ = localPosXZ * -0.5;\n\t\tlocalPos = vec3f(localPosXZ.x, localPosXZ.y, localPos.y);\n\t#endif\n\tvar posW: vec4f = modelMatrix * vec4f(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\t\tposW = vec4f(posW.xy, 0.0, 1.0);\n\t#endif\n\treturn posW;\n}\nfn getPosition() -> vec4f {\n\tdModelMatrix = getModelMatrix();\n\tlet posW: vec4f = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n\tdPositionW = posW.xyz;\n\tvar screenPos: vec4f;\n\t#ifdef UV1LAYOUT\n\t\tscreenPos = vec4f(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1.0);\n\t\tscreenPos.y *= -1.0;\n\t#else\n\t\t#ifdef SCREENSPACE\n\t\t\tscreenPos = posW;\n\t\t\tscreenPos.y *= uniform.projectionFlipY;\n\t\t#else\n\t\t\tscreenPos = uniform.matrix_viewProjection * posW;\n\t\t#endif\n\t\t#ifdef PIXELSNAP\n\t\t\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\t\t\tscreenPos.xy *= uniforms.uScreenSize.xy;\n\t\t\tscreenPos.xy = floor(screenPos.xy);\n\t\t\tscreenPos.xy *= uniforms.uScreenSize.zw;\n\t\t\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t\t#endif\n\t#endif\n\treturn screenPos;\n}\nfn getWorldPosition() -> vec3f {\n\treturn dPositionW;\n}\n",transformCoreVS:'\n\tattribute vertex_position: vec4f;\n\tuniform matrix_viewProjection: mat4x4f;\n\tuniform matrix_model: mat4x4f;\n\t\n\t#ifdef MORPHING\n\t\tuniform morph_tex_params: vec2f;\n\t\tattribute morph_vertex_id: u32;\n\t\tfn getTextureMorphCoords() -> vec2i {\n\t\t\tvar textureSize: vec2i = vec2i(uniform.morph_tex_params);\n\t\t\tvar morphGridV: i32 = i32(morph_vertex_id) / textureSize.x;\n\t\t\tvar morphGridU: i32 = i32(morph_vertex_id) - (morphGridV * textureSize.x);\n\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t\treturn vec2i(morphGridU, morphGridV);\n\t\t}\n\t\t#ifdef MORPHING_POSITION\n\t\t\t#ifdef MORPHING_INT\n\t\t\t\tuniform aabbSize: vec3f;\n\t\t\t\tuniform aabbMin: vec3f;\n\t\t\t\tvar morphPositionTex: texture_2d<u32>;\n\t\t\t#else\n\t\t\t\tvar morphPositionTex: texture_2d<f32>;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#ifdef defined(BATCH)\n\t\t#include "skinBatchVS"\n\t\tfn getModelMatrix() -> mat4x4f {\n\t\t\treturn getBoneMatrix(vertex_boneIndices);\n\t\t}\n\t#elif defined(SKIN)\n\t\t#include "skinVS"\n\t\tfn getModelMatrix() -> mat4x4f {\n\t\t\treturn uniform.matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t\t}\n\t#elif defined(INSTANCING)\n\t\t#include "transformInstancingVS"\n\t#else\n\t\tfn getModelMatrix() -> mat4x4f {\n\t\t\treturn uniform.matrix_model;\n\t\t}\n\t#endif\n\tfn getLocalPosition(vertexPosition: vec3f) -> vec3f {\n\t\tvar localPos: vec3f = vertexPosition;\n\t\t#ifdef MORPHING_POSITION\n\t\t\tvar morphUV: vec2i = getTextureMorphCoords();\n\t\t\t#ifdef MORPHING_INT\n\t\t\t\tvar morphPos: vec3f = vec3f(textureLoad(morphPositionTex, morphUV, 0).xyz) / 65535.0 * uniform.aabbSize + uniform.aabbMin;\n\t\t\t#else\n\t\t\t\tvar morphPos: vec3f = textureLoad(morphPositionTex, morphUV, 0).xyz;\n\t\t\t#endif\n\t\t\tlocalPos += morphPos;\n\t\t#endif\n\t\treturn localPos;\n\t}\n',transformInstancingVS:"\nattribute instance_line1: vec4f;\nattribute instance_line2: vec4f;\nattribute instance_line3: vec4f;\nattribute instance_line4: vec4f;\nfn getModelMatrix() -> mat4x4f {\n\treturn uniform.matrix_model * mat4x4f(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef STD_REFRACTION_CONSTANT\n\tuniform material_refraction: f32;\n#endif\nfn getRefraction() {\n\tvar refraction: f32 = 1.0;\n\t#ifdef STD_REFRACTION_CONSTANT\n\trefraction = uniform.material_refraction;\n\t#endif\n\t#ifdef STD_REFRACTION_TEXTURE\n\trefraction = refraction * textureSampleBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_NAME}Sampler, {STD_REFRACTION_TEXTURE_UV}, uniform.textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_REFRACTION_VERTEX\n\trefraction = refraction * saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});\n\t#endif\n\tdTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform twoSidedLightingNegScaleFactor: f32;\nfn handleTwoSidedLighting() {\n\tdTBN[2] = dTBN[2] * select(-uniform.twoSidedLightingNegScaleFactor, uniform.twoSidedLightingNegScaleFactor, pcFrontFacing);\n}\n",uv0VS:"\n#ifdef NINESLICED\n\tfn getUv0() -> vec2f {\n\t\tvar uv = vertex_position.xz;\n\t\tlet positiveUnitOffset = clamp(vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n\t\tlet negativeUnitOffset = clamp(-vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n\t\tuv = uv + ((-positiveUnitOffset * uniform.innerOffset.xy) + (negativeUnitOffset * uniform.innerOffset.zw)) * vertex_texCoord0.xy;\n\t\tuv = uv * -0.5 + vec2f(0.5, 0.5);\n\t\tuv = uv * uniform.atlasRect.zw + uniform.atlasRect.xy;\n\t\tdMaskGlobal = vertex_texCoord0.xy;\n\t\treturn uv;\n\t}\n#else\n\tfn getUv0() -> vec2f {\n\t\treturn vertex_texCoord0;\n\t}\n#endif\n",uv1VS:"\nfn getUv1() -> vec2f {\n\treturn vertex_texCoord1;\n}\n",uvTransformVS:"\noutput.vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2f(\n\tdot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}0),\n\tdot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n\tuniform {TRANSFORM_NAME_{i}}0: vec3f;\n\tuniform {TRANSFORM_NAME_{i}}1: vec3f;\n",viewDirPS:"\nfn getViewDir() {\n\tdViewDirW = normalize(uniform.view_position - vPositionW);\n}\n",webgpuPS:"\n",webgpuVS:Ca};class Bm extends Ve{constructor(t){super(),this._batcher=null,this._destroyRequested=!1,this._inFrameUpdate=!1,this._librariesLoaded=!1,this._fillMode=Xp,this._resolutionMode="FIXED",this._allowResize=!0,this._skyboxAsset=null,this._entityIndex={},this._inTools=!1,this._scriptPrefix="",this._time=0,this.enableBundles="undefined"!=typeof TextDecoder,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.frameGraph=new Qp,this.scriptsOrder=[],this.autoRender=!0,this.renderNextFrame=!1,this.lightmapper=null,this.loader=new wm(this),this.scenes=new km(this),this.scripts=new Cm(this),this.systems=new vm,this.i18n=new Em(this),this.keyboard=null,this.mouse=null,this.touch=null,this.gamepads=null,this.elementInput=null,this.xr=null,Bm._applications[t.id]=this,Yp(this),this.root=new Im,this.root._enabledInHierarchy=!0}init(t){const{assetPrefix:e,batchManager:s,componentSystems:i,elementInput:n,gamepads:r,graphicsDevice:a,keyboard:o,lightmapper:l,mouse:h,resourceHandlers:c,scriptsOrder:d,scriptPrefix:u,soundManager:f,touch:p,xr:m}=t;this.graphicsDevice=a,Ch.get(a,Ai).add(Fm),Ch.get(a,Di).add(Nm),this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new Om(a),this._soundManager=f,this.scene=new If(a),this._registerSceneImmediate(this.scene),this.assets=new _m(this.loader),e&&(this.assets.prefix=e),this.bundles=new gm(this.assets),this.scriptsOrder=d||[],this.defaultLayerWorld=new wu({name:"World",id:0}),this.defaultLayerDepth=new wu({name:"Depth",id:1,enabled:!1,opaqueSortMode:0}),this.defaultLayerSkybox=new wu({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new wu({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new wu({name:"Immediate",id:3,opaqueSortMode:0});const _=new Cu("default");_.pushOpaque(this.defaultLayerWorld),_.pushOpaque(this.defaultLayerDepth),_.pushOpaque(this.defaultLayerSkybox),_.pushTransparent(this.defaultLayerWorld),_.pushOpaque(this.defaultLayerImmediate),_.pushTransparent(this.defaultLayerImmediate),_.pushTransparent(this.defaultLayerUi),this.scene.layers=_,tm.createPlaceholder(a),this.renderer=new gu(a),this.renderer.scene=this.scene,l&&(this.lightmapper=new l(a,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),s&&(this._batcher=new s(a,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=o||null,this.mouse=h||null,this.touch=p||null,this.gamepads=r||null,n&&(this.elementInput=n,this.elementInput.app=this),this.xr=m?new m(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=u||"",this.enableBundles&&this.loader.addHandler("bundle",new xm(this)),c.forEach((t=>{const e=new t(this);this.loader.addHandler(e.handlerType,e)})),i.forEach((t=>{this.systems.add(new t(this))})),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=Um(this)}static{this._applications={}}static getApplication(t){return t?Bm._applications[t]:Kp()}_initDefaultMaterial(){const t=new Jf;t.name="Default Material",function(t,e){jh.get(t,(()=>e))}(this.graphicsDevice,t)}_initProgramLibrary(){const t=new vp(this.graphicsDevice,new Jf);!function(t,e){vh.get(t,(()=>e))}(this.graphicsDevice,t)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(t,e){tl.get(t,((t,s)=>{if(t)return void e(t);const i=s.application_properties,n=s.scenes,r=s.assets;this._parseApplicationProperties(i,(t=>{this._parseScenes(n),this._parseAssets(r),e(t||null)}))}))}preload(t){this.fire("preload:start");const e=this.assets.list({preload:!0});if(0===e.length)return this.fire("preload:end"),void t();let s=0;const i=()=>{s++,this.fire("preload:progress",s/e.length),s===e.length&&(this.fire("preload:end"),t())};e.forEach((t=>{t.loaded?i():(t.once("load",i),t.once("error",i),this.assets.load(t))}))}_preloadScripts(t,e){e()}_parseApplicationProperties(t,e){if("number"==typeof t.maxAssetRetries&&t.maxAssetRetries>0&&this.loader.enableRetry(t.maxAssetRetries),t.useDevicePixelRatio||(t.useDevicePixelRatio=t.use_device_pixel_ratio),t.resolutionMode||(t.resolutionMode=t.resolution_mode),t.fillMode||(t.fillMode=t.fill_mode),this._width=t.width,this._height=t.height,t.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(t.resolutionMode,this._width,this._height),this.setCanvasFillMode(t.fillMode,this._width,this._height),t.layers&&t.layerOrder){const e=new Cu("application"),s={};for(const e in t.layers){const i=t.layers[e];i.id=parseInt(e,10),i.enabled=1!==i.id,s[e]=new wu(i)}for(let i=0,n=t.layerOrder.length;i<n;i++){const n=t.layerOrder[i],r=s[n.layer];r&&(n.transparent?e.pushTransparent(r):e.pushOpaque(r),e.subLayerEnabled[i]=n.enabled)}this.scene.layers=e}if(t.batchGroups){const e=this.batcher;if(e)for(let s=0,i=t.batchGroups.length;s<i;s++){const i=t.batchGroups[s];e.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers)}}t.i18nAssets&&(this.i18n.assets=t.i18nAssets),this._loadLibraries(t.libraries,e)}_loadLibraries(t,e){const s=t.length;let i=s;const n=/^https?:\/\//;if(s){const r=(t,s)=>{i--,t?e(t):0===i&&(this.onLibrariesLoaded(),e(null))};for(let e=0;e<s;++e){let s=t[e];!n.test(s.toLowerCase())&&this._scriptPrefix&&(s=ke.join(this._scriptPrefix,s)),this.loader.load(s,"script",r)}}else this.onLibrariesLoaded(),e(null)}_parseScenes(t){if(t)for(let e=0;e<t.length;e++)this.scenes.add(t[e].name,t[e].url)}_parseAssets(t){const e=[],s={},i={};for(let i=0;i<this.scriptsOrder.length;i++){const n=this.scriptsOrder[i];t[n]&&(s[n]=!0,e.push(t[n]))}if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(i[s]=!0,e.push(t[s]));for(const n in t)s[n]||i[n]||e.push(t[n]);for(let t=0;t<e.length;t++){const s=e[t],i=new pm(s.name,s.type,s.file,s.data);if(i.id=parseInt(s.id,10),i.preload=!!s.preload&&s.preload,i.loaded="script"===s.type&&s.data&&s.data.loadingType>0,i.tags.add(s.tags),s.i18n)for(const t in s.i18n)i.addLocalizedAssetId(t,s.i18n[t]);this.assets.add(i)}}start(){this.frame=0,this.fire("start",{timestamp:$e(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(t){this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(t){this.frame++,this.graphicsDevice.update(),this.systems.fire(this._inTools?"toolsUpdate":"update",t),this.systems.fire("animationUpdate",t),this.systems.fire("postUpdate",t),this.fire("update",t),this.inputUpdate(t)}render(){this.updateCanvasSize(),this.graphicsDevice.frameStart(),this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender"),this.graphicsDevice.frameEnd()}renderComposition(t){this.renderer.update(t),this.renderer.buildFrameGraph(this.frameGraph,t),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(t,e,s){const i=this.stats.frame;i.dt=e,i.ms=s,t>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=t+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let t=this.stats.frame;t.cameras=this.renderer._camerasRendered,t.materials=this.renderer._materialSwitches,t.shaders=this.graphicsDevice._shaderSwitchesPerFrame,t.shadowMapUpdates=this.renderer._shadowMapUpdates,t.shadowMapTime=this.renderer._shadowMapTime,t.depthMapTime=this.renderer._depthMapTime,t.forwardTime=this.renderer._forwardTime;const e=this.graphicsDevice._primsPerFrame;t.triangles=e[4]/3+Math.max(e[5]-2,0)+Math.max(e[6]-2,0),t.cullTime=this.renderer._cullTime,t.sortTime=this.renderer._sortTime,t.skinTime=this.renderer._skinTime,t.morphTime=this.renderer._morphTime,t.lightClusters=this.renderer._lightClusters,t.lightClustersTime=this.renderer._lightClustersTime,t.otherPrimitives=0;for(let s=0;s<e.length;s++)s<4&&(t.otherPrimitives+=e[s]),e[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,t=this.stats.drawCalls,t.forward=this.renderer._forwardDrawCalls,t.culled=this.renderer._numDrawCallsCulled,t.depth=0,t.shadow=this.renderer._shadowDrawCalls,t.skinned=this.renderer._skinDrawCalls,t.immediate=0,t.instanced=0,t.removedByInstancing=0,t.misc=t.total-(t.forward+t.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,t=this.stats.particles,t.updatesPerFrame=t._updatesPerFrame,t.frameTime=t._frameTime,t._updatesPerFrame=0,t._frameTime=0}setCanvasFillMode(t,e,s){this._fillMode=t,this.resizeCanvas(e,s)}setCanvasResolution(t,e,s){this._resolutionMode=t,t===$p&&void 0===e&&(e=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(t,e){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if(this._fillMode===Xp){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>s/i?e=(t=s)/n:t=(e=i)*n}else"FILL_WINDOW"===this._fillMode&&(t=s,e=i);return this.graphicsDevice.canvas.style.width=`${t}px`,this.graphicsDevice.canvas.style.height=`${e}px`,this.updateCanvasSize(),{width:t,height:e}}updateCanvasSize(){if(this._allowResize&&!this.xr?.active&&this._resolutionMode===$p){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(t){let e;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const[e,s,i]=t.physics.gravity;this.systems.rigidbody.gravity.set(e,s,i)}this.scene.applySettings(t),t.render.hasOwnProperty("skybox")&&(t.render.skybox?(e=this.assets.get(t.render.skybox),e?this.setSkybox(e):this.assets.once(`add:${t.render.skybox}`,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(t,e){t&&e&&tm.set(this.graphicsDevice,t,e)}setSkybox(t){if(t!==this._skyboxAsset){const e=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off(`load:${this._skyboxAsset.id}`,s,this),this.assets.off(`remove:${this._skyboxAsset.id}`,e,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=t,this._skyboxAsset&&(this.assets.on(`load:${this._skyboxAsset.id}`,s,this),this.assets.once(`remove:${this._skyboxAsset.id}`,e,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){this.lightmapper?.bake(null,this.scene.lightmapMode)}_firstBatch(){this.batcher?.generate()}_processTimestamp(t){return t}drawLine(t,e,s,i,n){this.scene.drawLine(t,e,s,i,n)}drawLines(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(t,e,s,i)}drawLineArrays(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(t,e,s,i)}drawWireSphere(t,e,s=Ze.WHITE,i=20,n=!0,r=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(t,e,s,i,n,r)}drawWireAlignedBox(t,e,s=Ze.WHITE,i=!0,n=this.scene.defaultDrawLayer,r){this.scene.immediate.drawWireAlignedBox(t,e,s,i,n,r)}drawMeshInstance(t,e=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,t,e)}drawMesh(t,e,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,s,t,null,i)}drawQuad(t,e,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,t,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(t,e,s,i,n,r,a=this.scene.defaultDrawLayer,o=!0){if(!1===o&&!this.graphicsDevice.isWebGPU)return;const l=new ps;l.setTRS(new rs(t,e,0),ms.IDENTITY,new rs(s,-i,0)),r||((r=new Gu).cull=0,r.setParameter("colorMap",n),r.shaderDesc=o?this.scene.immediate.getTextureShaderDesc(n.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),r.update()),this.drawQuad(l,r,a)}drawDepthTexture(t,e,s,i,n=this.scene.defaultDrawLayer){const r=new Gu;r.cull=0,r.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),r.update(),this.drawTexture(t,e,s,i,null,r,n)}destroy(){if(this._inFrameUpdate)return void(this._destroyRequested=!0);const t=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const e=this.assets.list();for(let t=0;t<e.length;t++)e[t].unload(),e[t].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;const s=this.loader.getHandler("script");s?.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper?.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,this.xr?.end(),this.xr?.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager?.destroy(),this._soundManager=null,Bm._applications[t]=null,Kp()===this&&Yp(null),Bm.cancelTick(this)}static cancelTick(t){t.frameRequestId&&(window.cancelAnimationFrame(t.frameRequestId),t.frameRequestId=void 0)}getEntityFromIndex(t){return this._entityIndex[t]}_registerSceneImmediate(t){this.on("postrender",t.immediate.onPostRender,t.immediate)}}const Um=function(t){const e=t;return function(t,s){if(!e.graphicsDevice)return;e.frameRequestId&&(e.xr?.session?.cancelAnimationFrame(e.frameRequestId),cancelAnimationFrame(e.frameRequestId),e.frameRequestId=null),e._inFrameUpdate=!0,Yp(e);const i=e._processTimestamp(t)||$e(),n=i-(e._time||i);let r=n/1e3;if(r=Qe.clamp(r,0,e.maxDeltaTime),r*=e.timeScale,e._time=i,e.xr?.session?e.frameRequestId=e.xr.session.requestAnimationFrame(e.tick):e.frameRequestId=Ue.browser||Ue.worker?requestAnimationFrame(e.tick):null,e.graphicsDevice.contextLost)return;e._fillFrameStatsBasic(i,r,n),e.fire("frameupdate",n);let a=!1;s?(a=!e.xr?.update(s),e.graphicsDevice.defaultFramebuffer=s.session.renderState.baseLayer.framebuffer):e.graphicsDevice.defaultFramebuffer=null,a||(e.update(r),e.fire("framerender"),(e.autoRender||e.renderNextFrame)&&(e.render(),e.renderNextFrame=!1),e.fire("frameend")),e._inFrameUpdate=!1,e._destroyRequested&&e.destroy()}};class zm{constructor(){this.componentSystems=[],this.resourceHandlers=[]}}const Vm=new Ts;class Hm{constructor(t,e,s){this.scene=t,this.light=e,this.store(),e.numCascades=1,this.scene.clusteredLightingEnabled&&!s.shadowsEnabled&&(e.castShadows=!1),0!==e.type&&(e._node.getWorldTransform(),e.getBoundingSphere(Vm),this.lightBounds=new Ss,this.lightBounds.center.copy(Vm.center),this.lightBounds.halfExtents.set(Vm.radius,Vm.radius,Vm.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows}restore(){const t=this.light;t.mask=this.mask,t.shadowUpdateMode=this.shadowUpdateMode,t.enabled=this.enabled,t.intensity=this.intensity,t._node.setLocalRotation(this.rotation),t.numCascades=this.numCascades,t._castShadows=this.castShadows}startBake(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()}endBake(t){const e=this.light;e.enabled=!1,e.shadowMap&&(e.shadowMap.cached&&t.add(e,e.shadowMap),e.shadowMap=null)}}const Gm=new os;class Wm extends Hm{constructor(t,e){super(t.scene,e,t.lightingParams)}get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(t,e){const s=this.light;if(s._node.setLocalRotation(this.rotation),t>0){const i=s.bakeArea;df.circlePointDeterministic(Gm,t,e),Gm.mulScalar(.5*i),s._node.rotateLocal(Gm.x,0,Gm.y)}s._node.getWorldTransform();const i=Math.pow(this.intensity,2.2);s.intensity=Math.pow(i/e,1/2.2)}}const jm=new rs;class Xm extends Hm{constructor(t){const e=t.scene,s=new Im("AmbientLight");s.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:e.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:Ze.WHITE,intensity:1,bakeDir:!1}),super(e,s.light.light,t.lightingParams)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(t,e){df.spherePointDeterministic(jm,t,e,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(jm.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=2*Math.PI*this.scene.ambientBakeSpherePart,i=Math.pow(s,2.2);this.light.intensity=Math.pow(i/e,1/2.2)}}class $m{constructor(t,e=null){this.node=t,this.component=t.render||t.model,e=e||this.component.meshInstances,this.store(),this.meshInstances=e,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}const qm={glslBilateralDeNoisePS:"\nfloat normpdf3(in vec3 v, in float sigma) {\n\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvec3 decode(vec4 pixel) {\n\t#if HDR\n\t\treturn pixel.rgb;\n\t#else\n\t\treturn decodeRGBM(pixel);\n\t#endif\n}\nbool isUsed(vec4 pixel) {\n\t#if HDR\n\t\treturn any(greaterThan(pixel.rgb, vec3(0.0)));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[{MSIZE}];\nvoid main(void) {\n\t\n\tvec4 pixel = texture2DLod(source, vUv0, 0.0);\n\tif (!isUsed(pixel)) {\n\t\tgl_FragColor = pixel;\n\t\treturn ;\n\t}\n\tfloat sigma = sigmas.x;\n\tfloat bSigma = sigmas.y;\n\tvec3 pixelHdr = decode(pixel);\n\tvec3 accumulatedHdr = vec3(0.0);\n\tfloat accumulatedFactor = 0.000001;\n\tconst int kSize = ({MSIZE} - 1) / 2;\n\tfor (int i = -kSize; i <= kSize; ++i) {\n\t\tfor (int j = -kSize; j <= kSize; ++j) {\n\t\t\t\n\t\t\tvec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n\t\t\tvec4 pix = texture2DLod(source, coord, 0.0);\n\t\t\tif (isUsed(pix)) {\n\t\t\t\tvec3 hdr = decode(pix);\n\t\t\t\tfloat factor = kernel[kSize + j] * kernel[kSize + i];\n\t\t\t\tfactor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n\t\t\t\taccumulatedHdr += factor * hdr;\n\t\t\t\taccumulatedFactor += factor;\n\t\t\t}\n\t\t}\n\t}\n\tvec3 finalHDR = accumulatedHdr / accumulatedFactor;\n\t#if HDR\n\t\tgl_FragColor = vec4(finalHDR, 1.0);\n\t#else\n\t\tgl_FragColor = encodeRGBM(finalHDR);\n\t#endif\n}\n",glslDilatePS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nbool isUsed(vec4 pixel) {\n\t#if HDR\n\t\treturn any(greaterThan(pixel.rgb, vec3(0.0)));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\nvoid main(void) {\n\tvec4 c = texture2DLod(source, vUv0, 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 - pixelOffset, 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + pixelOffset, 0.0);\n\tgl_FragColor = c;\n}\n"},Km={wgslBilateralDeNoisePS:"\nfn normpdf3(v: vec3f, sigma: f32) -> f32 {\n\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nfn decodeRGBM(rgbm: vec4f) -> vec3f {\n\tlet color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nfn saturate(x: f32) -> f32 {\n\treturn clamp(x, 0.0, 1.0);\n}\nfn encodeRGBM(color: vec3f) -> vec4f {\n\tvar encoded: vec4f;\n\tlet rgb_processed = pow(color.rgb, vec3f(0.5)) * (1.0 / 8.0);\n\tencoded = vec4f(rgb_processed, 0.0);\n\tlet max_g_b = max( encoded.g, max( encoded.b, 1.0 / 255.0 ) );\n\tlet max_rgb = max( encoded.r, max_g_b );\n\tencoded.a = clamp(max_rgb, 0.0, 1.0);\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded = vec4f(encoded.rgb / encoded.a, encoded.a);\n\treturn encoded;\n}\nfn decode(pixel: vec4f) -> vec3f {\n\t#if HDR\n\t\treturn pixel.rgb;\n\t#else\n\t\treturn decodeRGBM(pixel);\n\t#endif\n}\nfn isUsed(pixel: vec4f) -> bool {\n\t#if HDR\n\t\treturn any(pixel.rgb > vec3f(0.0));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\nuniform kernel: array<f32, {MSIZE}>;\nuniform pixelOffset: vec2f;\nuniform sigmas: vec2f;\nuniform bZnorm: f32;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\tlet pixel = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);\n\tif (!isUsed(pixel)) {\n\t\toutput.color = pixel;\n\t\treturn output;\n\t}\n\tlet sigma = uniform.sigmas.x;\n\tlet bSigma = uniform.sigmas.y;\n\tlet pixelHdr = decode(pixel);\n\tvar accumulatedHdr = vec3f(0.0);\n\tvar accumulatedFactor = 0.000001;\n\tconst kSize = ({MSIZE} - 1) / 2;\n\tfor (var i: i32 = -kSize; i <= kSize; i = i + 1) {\n\t\tfor (var j: i32 = -kSize; j <= kSize; j = j + 1) {\n\t\t\tlet coord = input.vUv0 + vec2f(f32(i), f32(j)) * uniform.pixelOffset;\n\t\t\tlet pix = textureSampleLevel(source, sourceSampler, coord, 0.0);\n\t\t\tif (isUsed(pix)) {\n\t\t\t\tlet hdr = decode(pix);\n\t\t\t\tvar factor = uniform.kernel[u32(kSize + j)].element * uniform.kernel[u32(kSize + i)].element;\n\t\t\t\tfactor = factor * normpdf3(hdr - pixelHdr, bSigma) * uniform.bZnorm;\n\t\t\t\taccumulatedHdr = accumulatedHdr + factor * hdr;\n\t\t\t\taccumulatedFactor = accumulatedFactor + factor;\n\t\t\t}\n\t\t}\n\t}\n\tlet finalHDR = accumulatedHdr / accumulatedFactor;\n\t#if HDR\n\t\toutput.color = vec4f(finalHDR, 1.0);\n\t#else\n\t\toutput.color = encodeRGBM(finalHDR);\n\t#endif\n\treturn output;\n}\n",wgslDilatePS:"\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\nuniform pixelOffset: vec2f;\nfn isUsed(pixel: vec4f) -> bool {\n\t#ifdef HDR\n\t\treturn any(pixel.rgb > vec3f(0.0));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar c: vec4f = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 - uniform.pixelOffset, 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, -uniform.pixelOffset.y), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, -uniform.pixelOffset.y), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, uniform.pixelOffset.y), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, uniform.pixelOffset.y), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + uniform.pixelOffset, 0.0), c, isUsed(c));\n\tvar output: FragmentOutput;\n\toutput.color = c;\n\treturn output;\n}\n"};class Ym{constructor(t){this.shaderDilate=[],this.shaderDenoise=[],this.device=t,Ch.get(this.device,Ai).add(qm),Ch.get(this.device,Di).add(Km),this.constantTexSource=t.scope.resolve("source"),this.constantPixelOffset=t.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(t){this.constantTexSource.setValue(t)}prepare(t,e){this.pixelOffset[0]=1/t,this.pixelOffset[1]=1/e,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(t,e,s){const i=s?0:1;if(!this.shaderDenoise[i]){const t=new Map;t.set("{MSIZE}",15),s&&t.set("HDR",""),this.shaderDenoise[i]=Ph.createShader(this.device,{uniqueName:"lmBilateralDeNoise-"+(s?"hdr":"rgbm"),attributes:{vertex_position:$s},vertexGLSL:Ch.get(this.device,Ai).get("fullscreenQuadVS"),vertexWGSL:Ch.get(this.device,Di).get("fullscreenQuadVS"),fragmentGLSL:Ch.get(this.device,Ai).get("glslBilateralDeNoisePS"),fragmentWGSL:Ch.get(this.device,Di).get("wgslBilateralDeNoisePS"),fragmentDefines:t}),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")}this.sigmas[0]=t,this.sigmas[1]=e,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(t,e)}getDenoise(t){const e=t?0:1;return this.shaderDenoise[e]}getDilate(t,e){const s=e?0:1;if(!this.shaderDilate[s]){const i=e?"#define HDR\n":"";this.shaderDilate[s]=Ph.createShader(t,{uniqueName:"lmDilate-"+(e?"hdr":"rgbm"),attributes:{vertex_position:$s},vertexGLSL:Ch.get(this.device,Ai).get("fullscreenQuadVS"),vertexWGSL:Ch.get(this.device,Di).get("fullscreenQuadVS"),fragmentGLSL:i+Ch.get(this.device,Ai).get("glslDilatePS"),fragmentWGSL:i+Ch.get(this.device,Di).get("wgslDilatePS")})}return this.shaderDilate[s]}evaluateDenoiseUniforms(t,e){function s(t,e){return.39894*Math.exp(-.5*t*t/(e*e))/e}this.kernel=this.kernel||new Float32Array(15);const i=this.kernel,n=Math.floor(7);for(let e=0;e<=n;++e){const r=s(e,t);i[n+e]=r,i[n-e]=r}this.constantKernel.setValue(this.kernel);const r=1/s(0,e);this.bZnorm.setValue(r)}}class Qm extends Ao{constructor(t,e,s,i,n,r){super(t),this.viewBindGroups=[],this.renderer=e,this.camera=s,this.worldClusters=i,this.receivers=n,this.lightArray=r}destroy(){this.viewBindGroups.forEach((t=>{t.defaultUniformBuffer.destroy(),t.destroy()})),this.viewBindGroups.length=0}execute(){const{renderer:t,camera:e,receivers:s,renderTarget:i,worldClusters:n,lightArray:r}=this;t.renderForwardLayer(e,i,null,void 0,0,this.viewBindGroups,{meshInstances:s,splitLights:r,lightClusters:n})}}const Zm=new rs;class Jm{constructor(t,e,s,i,n){this.device=t,this.root=e,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new Ze,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){qh.decRef(this.blackTex),this.blackTex=null,qh.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,this.camera?.destroy(),this.camera=null}initBake(t){if(this.bakeHDR=7!==this.scene.lightmapPixelFormat,!this._initCalled){this._initCalled=!0,this.lightmapFilters=new Ym(t),this.constantBakeDir=t.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new dn(this.device,{width:4,height:4,format:7,type:_i,name:"lightmapBlack"}),qh.incRef(this.blackTex);const e=new mc;e.clearColor.set(0,0,0,0),e.clearColorBuffer=!0,e.clearDepthBuffer=!1,e.clearStencilBuffer=!1,e.frustumCulling=!1,e.projection=1,e.aspectRatio=1,e.node=new Mc,this.camera=e,this.camera.shaderParams.gammaCorrection=0,this.camera.shaderParams.toneMapping=0}if(this.scene.clusteredLightingEnabled){const e=new Nu(t.supportsAreaLights,t.maxTextureSize,(()=>{}));this.lightingParams=e;const s=this.scene.lighting;e.shadowsEnabled=s.shadowsEnabled,e.shadowAtlasResolution=s.shadowAtlasResolution,e.cookiesEnabled=s.cookiesEnabled,e.cookieAtlasResolution=s.cookieAtlasResolution,e.areaLightsEnabled=s.areaLightsEnabled,e.cells=new rs(3,3,3),e.maxLightsPerCell=4,this.worldClusters=new Zc(t),this.worldClusters.name="ClusterLightmapper"}}finishBake(t){function e(t){qh.decRef(t.colorBuffer),t.destroy()}this.materials=[],this.renderTargets.forEach((t=>{e(t)})),this.renderTargets.clear(),t.forEach((t=>{t.renderTargets.forEach((t=>{e(t)})),t.renderTargets.length=0})),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(t,e,s){const i=new Jf;return i.name=`lmMaterial-pass:${e}-ambient:${s}`,i.setDefine("UV1LAYOUT",""),i.setDefine("LIT_LIGHTMAP_BAKING",""),0===e?(i.setDefine("LIT_LIGHTMAP_BAKING_COLOR",""),s?i.setDefine("LIT_LIGHTMAP_BAKING_ADD_AMBIENT",""):i.ambient=new Ze(0,0,0),this.bakeHDR||i.setDefine("LIGHTMAP_RGBM",""),i.lightMap=this.blackTex):(i.setDefine("LIT_LIGHTMAP_BAKING_DIR",""),i.setDefine("STD_LIGHTMAP_DIR","")),i.cull=0,i.forceUv1=!0,i.update(),i}createMaterials(t,e,s){for(let t=0;t<s;t++)this.passMaterials[t]||(this.passMaterials[t]=this.createMaterialForPass(e,t,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(e,0,!0),this.ambientAOMaterial.onUpdateShader=function(t){return t.litOptions.lightMapWithoutAmbient=!0,t.litOptions.separateAmbient=!0,t})}createTexture(t,e){return new dn(this.device,{width:t,height:t,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:this.bakeHDR?mi:_i,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}collectModels(t,e,s){if(!t.enabled)return;let i;if(t.model?.model&&t.model?.enabled&&(s&&s.push(new $m(t)),t.model.lightmapped&&e&&(i=t.model.model.meshInstances)),t.render?.enabled&&(s&&s.push(new $m(t)),t.render.lightmapped&&e&&(i=t.render.meshInstances)),i){let s=!0;for(let t=0;t<i.length;t++)if(!i[t].mesh.vertexBuffer.format.hasUv1){s=!1;break}if(s){const s=[];for(let n=0;n<i.length;n++){const r=i[n].mesh;this._tempSet.has(r)?e.push(new $m(t,[i[n]])):s.push(i[n]),this._tempSet.add(r)}this._tempSet.clear(),s.length>0&&e.push(new $m(t,s))}}for(let i=0;i<t._children.length;i++)this.collectModels(t._children[i],e,s)}prepareShadowCasters(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const i=t[s].meshInstances;for(let t=0;t<i.length;t++)i[t].visibleThisFrame=!0,e.push(i[t])}}return e}updateTransforms(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;for(let t=0;t<s.length;t++)s[t].node.getWorldTransform()}}calculateLightmapSize(t){let e;const s=this.scene.lightmapSizeMultiplier||16,i=Zm;let n,r;t.model?(r=t.model.lightmapSizeMultiplier,t.model.asset?(e=this.assets.get(t.model.asset).data,e.area&&(n=e.area)):t.model._area&&(e=t.model,e._area&&(n=e._area))):t.render&&(r=t.render.lightmapSizeMultiplier,"asset"!==t.render.type&&t.render._area&&(e=t.render,e._area&&(n=e._area)));const a={x:1,y:1,z:1,uv:1};n&&(a.x=n.x,a.y=n.y,a.z=n.z,a.uv=n.uv);const o=r||1;a.x*=o,a.y*=o,a.z*=o;const l=t.render||t.model,h=this.computeNodeBounds(l.meshInstances);i.copy(h.halfExtents);let c=a.x*i.y*i.z+a.y*i.x*i.z+a.z*i.x*i.y;c/=a.uv,c=Math.sqrt(c);return Math.min(Qe.nextPowerOfTwo(c*s),this.scene.lightmapMaxResolution||2048)}setLightmapping(t,e,s,i){for(let n=0;n<t.length;n++){const r=t[n],a=r.meshInstances;for(let t=0;t<a.length;t++){const n=a[t];if(n.setLightmapped(e),e){i&&(n._shaderDefs|=i),n.mask=2;for(let t=0;t<s;t++){const e=r.renderTargets[t].colorBuffer;e.minFilter=1,e.magFilter=1,n.setRealtimeLightmap(nc.lightmapParamNames[t],e)}}}}}bake(t,e=1){const s=this.device,i=$e();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,r=s._renderTargetCreationTime,a=s._shaderStats.compileTime,o=[],l=[];if(t){for(let e=0;e<t.length;e++)this.collectModels(t[e],o,null);this.collectModels(this.root,null,l)}else this.collectModels(this.root,o,l);if(o.length>0){this.renderer.shadowRenderer.frameUpdate();const t=1===e?2:1;this.setLightmapping(o,!1,t),this.initBake(s),this.bakeInternal(t,o,l);let i=64;1===e&&(i|=128),this.scene.ambientBake&&(i|=4096),this.setLightmapping(o,!0,t,i),this.finishBake(o)}const h=$e();this.stats.totalRenderTime=h-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-a,this.stats.fboTime=s._renderTargetCreationTime-r,this.stats.lightmapCount=o.length}allocateTextures(t,e){for(let s=0;s<t.length;s++){const i=t[s],n=this.calculateLightmapSize(i.node);for(let t=0;t<e;t++){const e=this.createTexture(n,`lightmapper_lightmap_${s}`);qh.incRef(e),i.renderTargets[t]=new Hn({colorBuffer:e,depth:!1})}if(!this.renderTargets.has(n)){const t=this.createTexture(n,`lightmapper_temp_lightmap_${n}`);qh.incRef(t),this.renderTargets.set(n,new Hn({colorBuffer:t,depth:!1}))}}}prepareLightsToBake(t,e){if(this.scene.ambientBake){const t=new Xm(this);e.push(t)}const s=this.renderer.lights;for(let i=0;i<s.length;i++){const n=s[i],r=new Wm(this,n);t.push(r),n.enabled&&4&n.mask&&(n.mask=7,n.shadowUpdateMode=0===n.type?2:1,e.push(r))}e.sort()}restoreLights(t){for(let e=0;e<t.length;e++)t[e].restore()}setupScene(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants(),this.device.scope.resolve("ambientBakeOcclusionContrast").setValue(this.scene.ambientBakeOcclusionContrast),this.device.scope.resolve("ambientBakeOcclusionBrightness").setValue(this.scene.ambientBakeOcclusionBrightness)}restoreScene(){this.scene.ambientLight.copy(this.ambientLight)}computeNodeBounds(t){const e=new Ss;if(t.length>0){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}computeNodesBounds(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;t[e].bounds=this.computeNodeBounds(s)}}computeBounds(t){const e=new Ss;for(let s=0;s<t.length;s++){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}backupMaterials(t){for(let e=0;e<t.length;e++)this.materials[e]=t[e].material}restoreMaterials(t){for(let e=0;e<t.length;e++)t[e].material=this.materials[e]}lightCameraPrepare(t,e){const s=e.light;let i;if(2===s.type){i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=0,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(i)}return i}lightCameraPrepareAndCull(t,e,s,i){const n=t.light;let r=!0;if(0===n.type){Zm.copy(i.center),Zm.y+=i.halfExtents.y,this.camera.node.setPosition(Zm),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*i.halfExtents.y;const t=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=t}else t.lightBounds.intersects(e.bounds)||(r=!1);if(2===n.type){let t=!1;const i=e.meshInstances;for(let e=0;e<i.length;e++)if(i[e]._isVisible(s)){t=!0;break}t||(r=!1)}return r}setupLightArray(t,e){t[0].length=0,t[1].length=0,t[2].length=0,t[e.type][0]=e,e.visibleThisFrame=!0}renderShadowMap(t,e,s,i){const n=i.light,r=this.scene.clusteredLightingEnabled,a=n.castShadows&&(!r||this.scene.lighting.shadowsEnabled);if(!e&&a)if(n.shadowMap||r||(n.shadowMap=this.shadowMapCache.get(this.device,n)),0===n.type){this.renderer._shadowRendererDirectional.cull(n,t,this.camera,s);const e=this.renderer._shadowRendererDirectional.getLightRenderPass(n,this.camera);e?.render()}else{if(this.device.isWebGPU)return!0;this.renderer._shadowRendererLocal.cull(n,t,s);const e=!1;this.renderer.shadowRenderer.render(n,this.camera,e)}return!0}postprocessTextures(t,e,s){const i=this.lightmapFilters.getDilate(t,this.bakeHDR);let n;const r=this.scene.lightmapFilterEnabled;r&&(this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness,this.bakeHDR),n=this.lightmapFilters.getDenoise(this.bakeHDR)),t.setBlendState(Sn.NOBLEND),t.setDepthState(Tn.NODEPTH),t.setStencilState(null,null);for(let a=0;a<e.length;a++){const o=e[a];for(let e=0;e<s;e++){const s=o.renderTargets[e],a=s.colorBuffer,l=this.renderTargets.get(a.width),h=l.colorBuffer;this.lightmapFilters.prepare(a.width,a.height);for(let o=0;o<1;o++){this.lightmapFilters.setSourceTexture(a);Nh(t,l,r&&0===e&&0===o?n:i),this.lightmapFilters.setSourceTexture(h),Nh(t,s,i)}}}}bakeInternal(t,e,s){const i=this.scene,n=i.layers,r=this.device,a=i.clusteredLightingEnabled;this.createMaterials(r,i,t),this.setupScene(),n._update(),this.computeNodesBounds(e),this.allocateTextures(e,t),this.renderer.collectLights(n);const o=[],l=[];this.prepareLightsToBake(o,l),this.updateTransforms(s);const h=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(h),this.renderer.gpuUpdate(h);const c=this.computeBounds(h);let d,u,f,p;for(d=0;d<e.length;d++){for(f=e[d].meshInstances,u=0;u<f.length;u++)p=f[u],p.setLightmapped(!1),p.mask=4,p.setRealtimeLightmap(nc.lightmapParamNames[0],this.blackTex),p.setRealtimeLightmap(nc.lightmapParamNames[1],this.blackTex)}for(u=0;u<l.length;u++)l[u].light.enabled=!1;const m=[[],[],[]];let _,g,v=!1;for(d=0;d<l.length;d++){const s=l[d],o=s instanceof Xm,b=0===s.light.type;let y=s.numVirtualLights;t>1&&y>1&&s.light.bakeDir&&(y=1);for(let l=0;l<y;l++){y>1&&s.prepareVirtualLight(l,y),s.startBake();let d=!1;const S=this.lightCameraPrepare(r,s);for(g=0;g<e.length;g++){const x=e[g];f=x.meshInstances;if(!this.lightCameraPrepareAndCull(s,x,S,c))continue;this.setupLightArray(m,s.light);const w=b?[]:[s.light];for(a&&this.renderer.lightTextureAtlas.update(w,this.lightingParams),d=this.renderShadowMap(n,d,h,s),a&&this.worldClusters.update(w,this.lightingParams),this.backupMaterials(f),_=0;_<t&&!(_>0&&l>0)&&!(o&&_>0);_++){const t=x.renderTargets[_],e=x.renderTargets[_].colorBuffer.width,n=this.renderTargets.get(e),h=n.colorBuffer;0===_?v=i.updateShaders:v&&(i.updateShaders=!0);let c=this.passMaterials[_];if(o){l+1===y&&0===_&&(c=this.ambientAOMaterial)}for(u=0;u<f.length;u++)f[u].material=c;if(this.renderer.updateShaders(f),1===_&&this.constantBakeDir.setValue(s.light.bakeDir?1:0),r.isWebGPU){const t=new Qm(r,this.renderer,this.camera,a?this.worldClusters:null,f,m);t.init(n),t.render(),t.destroy()}else this.renderer.setCamera(this.camera,n,!0),a&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,n,f,m,0),r.updateEnd();for(x.renderTargets[_]=n,this.renderTargets.set(e,t),u=0;u<f.length;u++)p=f[u],p.setRealtimeLightmap(nc.lightmapParamNames[_],h),p._shaderDefs|=64}this.restoreMaterials(f)}s.endBake(this.shadowMapCache)}}for(this.postprocessTextures(r,e,t),g=0;g<s.length;g++)s[g].restore();this.restoreLights(o),this.restoreScene(),a||this.shadowMapCache.clear()}}class t_ extends Ve{static{this.order=0}constructor(t,e){super(),this.system=t,this.entity=e,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(t,e,s){this.fire(`set_${t}`,t,e,s)})),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(t,e){e.forEach((e=>{const s="object"==typeof e?e.name:e;Object.defineProperty(t,s,{get:function(){return this.data[s]},set:function(t){const e=this.data,i=e[s];e[s]=t,this.fire("set",s,i,t)},configurable:!0})})),t._accessorsBuilt=!0}buildAccessors(t){t_._buildAccessors(this,t)}onSetEnabled(t,e,s){e!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const t=this.system.store[this.entity.getGuid()];return t?t.data:null}set enabled(t){}get enabled(){return!0}}class e_ extends Ve{constructor(t){super(),this.app=t,this.store={},this.schema=[]}addComponent(t,e={}){const s=new this.ComponentType(this,t),i=new this.DataType;return this.store[t.getGuid()]={entity:t,data:i},t[this.id]=s,t.c[this.id]=s,this.initializeComponentData(s,e,[]),this.fire("add",t,s),s}removeComponent(t){const e=this.id,s=this.store[t.getGuid()],i=t.c[e];i.fire("beforeremove"),this.fire("beforeremove",t,i),delete this.store[t.getGuid()],t[e]=void 0,delete t.c[e],this.fire("remove",t,s.data)}cloneComponent(t,e){const s=this.store[t.getGuid()];return this.addComponent(e,s.data)}initializeComponentData(t,e={},s){for(let i=0,n=s.length;i<n;i++){const n=s[i];let r,a;"object"==typeof n?(r=n.name,a=n.type):(r=n,a=void 0);let o=e[r];void 0!==o?(void 0!==a&&(o=s_(o,a)),t[r]=o):t[r]=t.data[r]}t.enabled&&t.entity.enabled&&t.onEnable()}getPropertiesOfType(t){const e=[];return(this.schema||[]).forEach((s=>{s&&"object"==typeof s&&s.type===t&&e.push(s)})),e}destroy(){this.off()}}function s_(t,e){if(!t)return t;switch(e){case"rgb":return t instanceof Ze?t.clone():new Ze(t[0],t[1],t[2]);case"rgba":return t instanceof Ze?t.clone():new Ze(t[0],t[1],t[2],t[3]);case"vec2":return t instanceof os?t.clone():new os(t[0],t[1]);case"vec3":return t instanceof rs?t.clone():new rs(t[0],t[1],t[2]);case"vec4":return t instanceof ls?t.clone():new ls(t[0],t[1],t[2],t[3]);case"boolean":case"number":case"string":case"entity":return t;default:throw new Error(`Could not convert unhandled type: ${e}`)}}class i_{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(t,e){if(t<this._left||t>=this._right){const s=e.length;if(s)if(t<e[0])this._left=-1/0,this._right=e[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(t>=e[s-1])this._left=e[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const s=this._findKey(t,e);this._left=e[s],this._right=e[s+1],this._len=this._right-this._left;const i=1/this._len;this._recip=isFinite(i)?i:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(t-this._left)*this._recip,this._hermite.valid=!1}_findKey(t,e){let s=0;for(;t>=e[s+1];)s++;return s}eval(t,e,s){const i=s._data,n=s._components,r=this._p0*n;if(0===e)for(let e=0;e<n;++e)t[e]=i[r+e];else{const s=this._t,a=this._p1*n;switch(e){case 1:for(let e=0;e<n;++e)t[e]=Qe.lerp(i[r+e],i[a+e],s);break;case 2:{const e=this._hermite;if(!e.valid){const t=s*s,i=s+s,n=1-s,r=n*n;e.valid=!0,e.p0=(1+i)*r,e.m0=s*r,e.p1=t*(3-i),e.m1=t*(s-1)}const r=(3*this._p0+1)*n,a=(3*this._p0+2)*n,o=(3*this._p1+1)*n,l=(3*this._p1+0)*n;for(let s=0;s<n;++s)t[s]=e.p0*i[r+s]+e.m0*i[a+s]*this._len+e.p1*i[o+s]+e.m1*i[l+s]*this._len;break}}}}}class n_{constructor(t){this._name=`${t.name}Snapshot`,this._time=-1,this._cache=[],this._results=[];for(let e=0;e<t._inputs.length;++e)this._cache[e]=new i_;const e=t._curves,s=t._outputs;for(let t=0;t<e.length;++t){const i=s[e[t]._output],n=[];for(let t=0;t<i._components;++t)n[t]=0;this._results[t]=n}}}class r_{static{this.eventFrame={start:0,end:0,residual:0}}constructor(t,e,s,i,n,r){this._name=t.name,this._track=t,this._snapshot=new n_(t),this._playing=i,this._time=e,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=r,this.alignCursorToCurrentTime()}set name(t){this._name=t}get name(){return this._name}set track(t){this._track=t,this._snapshot=new n_(t)}get track(){return this._track}get snapshot(){return this._snapshot}set time(t){this._time=t,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(t){const e=Math.sign(t)!==Math.sign(this._speed);this._speed=t,e&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}set blendWeight(t){this._blendWeight=t}get blendWeight(){return this._blendWeight}set blendOrder(t){this._blendOrder=t}get blendOrder(){return this._blendOrder}set eventCursor(t){this._eventCursor=t}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(t){return!!this.nextEvent&&(this.isReverse?this.nextEvent.time<=t:this.nextEvent.time>=t)}nextEventBehindTime(t){return!!this.nextEvent&&(t===this.track.duration?this.isReverse?this.nextEvent.time>=t:this.nextEvent.time<=t:this.isReverse?this.nextEvent.time>t:this.nextEvent.time<t)}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(t){const e=r_.eventFrame;e.start=0,e.end=t,e.residual=0,this.isReverse?t<0&&(e.start=this.track.duration,e.end=0,e.residual=t+this.track.duration):t>this.track.duration&&(e.start=0,e.end=this.track.duration,e.residual=t-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,{track:this.track,...this.nextEvent}),this.moveEventCursor()}fireNextEventInFrame(t,e){return!(!this.nextEventAheadOfTime(t)||!this.nextEventBehindTime(e))&&(this.fireNextEvent(),!0)}activeEventsForFrame(t,e){const s=r_.eventFrame;this.clipFrameTime(e);const i=this.eventCursor;for(;this.fireNextEventInFrame(t,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(t){return t*this._speed/this._track.duration}_update(t){if(this._playing){let e=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(e,e+i*t),e+=i*t,i>=0?e>s&&(n?e=e%s||0:(e=this._track.duration,this.pause())):e<0&&(n?e=s+(e%s||0):(e=0,this.pause())),this._time=e}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}const a_="NONE",o_="INTEGER",l_="FLOAT",h_="BOOLEAN",c_="TRIGGER",d_="START",u_="END",f_="ANY",p_=[d_,u_,f_],m_="OVERWRITE";class __{static dot(t,e){const s=t.length;let i=0;for(let n=0;n<s;++n)i+=t[n]*e[n];return i}static normalize(t){let e=__.dot(t,t);if(e>0){e=1/Math.sqrt(e);const s=t.length;for(let i=0;i<s;++i)t[i]*=e}}static set(t,e,s){const i=t.length;if("quaternion"===s){let s=__.dot(e,e);s>0&&(s=1/Math.sqrt(s));for(let n=0;n<i;++n)t[n]=e[n]*s}else for(let s=0;s<i;++s)t[s]=e[s]}static blendVec(t,e,s,i){const n=i?1:1-s,r=t.length;for(let i=0;i<r;++i)t[i]=t[i]*n+e[i]*s}static blendQuat(t,e,s,i){const n=t.length,r=i?1:1-s;__.dot(t,e)<0&&(s=-s);for(let i=0;i<n;++i)t[i]=t[i]*r+e[i]*s;i||__.normalize(t)}static blend(t,e,s,i,n){"quaternion"===i?__.blendQuat(t,e,s,n):__.blendVec(t,e,s,n)}static stableSort(t,e){const s=t.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(e(t[n],t[i])){const e=t[i];t[i]=t[n],t[n]=e}}}class g_{static{this.TYPE_QUAT="quaternion"}static{this.TYPE_VEC3="vector3"}static{this.q1=new ms}static{this.q2=new ms}static{this.q3=new ms}static{this.quatArr=[0,0,0,1]}static{this.vecArr=[0,0,0]}static{this.IDENTITY_QUAT_ARR=[0,0,0,1]}constructor(t,e){this._component=t,this.mask=new Int8Array(t.layers.length),this.weights=new Float32Array(t.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=e,this.dirty=!0,this.value=e===g_.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(t){return this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[t]?0:this._normalizeWeights?this.weights[t]/this.totalWeight:Qe.clamp(this.weights[t],0,1)}_layerBlendType(t){return this._component.layers[t].blendType}setMask(t,e){this.mask[t]=e,this._normalizeWeights&&(this._component.layers[t].blendType===m_&&(this.mask=this.mask.fill(0,0,t)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let t=0;t<this.weights.length;t++)this.weights[t]=this._component.layers[t].weight,this.totalWeight+=this.mask[t]*this.weights[t];this.dirty=!1}updateValue(t,e){if(0===this.counter&&(__.set(this.value,g_.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||__.blend(this.value,this.baseValue,1,this.valueType)),this.mask[t]&&0!==this.getWeight(t)){if("ADDITIVE"!==this._layerBlendType(t)||this._normalizeWeights)__.blend(this.value,e,this.getWeight(t),this.valueType);else if(this.valueType===g_.TYPE_QUAT){const s=g_.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=g_.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=g_.q3.set(e[0],e[1],e[2],e[3]),r=i.invert().mul(n);r.slerp(ms.IDENTITY,r,this.getWeight(t)),s.mul(r),g_.quatArr[0]=s.x,g_.quatArr[1]=s.y,g_.quatArr[2]=s.z,g_.quatArr[3]=s.w,__.set(this.value,g_.quatArr,this.valueType)}else g_.vecArr[0]=e[0]-this.baseValue[0],g_.vecArr[1]=e[1]-this.baseValue[1],g_.vecArr[2]=e[2]-this.baseValue[2],__.blend(this.value,g_.vecArr,this.getWeight(t),this.valueType,!0);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}}class v_{constructor(t){this._binder=t,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}addClip(t){const e=this._targets,s=this._binder,i=t.track.curves,n=t.snapshot,r=[],a=[];for(let t=0;t<i.length;++t){const o=i[t].paths;for(let i=0;i<o.length;++i){const l=o[i],h=s.resolve(l);let c=e[h&&h.targetPath||null];if(!c&&h){c={target:h,value:[],curves:0,blendCounter:0};for(let t=0;t<c.target.components;++t)c.value.push(0);if(e[h.targetPath]=c,s.animComponent){if(!s.animComponent.targets[h.targetPath]){let t;t="localRotation"===h.targetPath.substring(h.targetPath.length-13)?g_.TYPE_QUAT:g_.TYPE_VEC3,s.animComponent.targets[h.targetPath]=new g_(s.animComponent,t)}s.animComponent.targets[h.targetPath].layerCounter++,s.animComponent.targets[h.targetPath].setMask(s.layerIndex,1)}}c&&(c.curves++,r.push(n._results[t]),a.push(c))}}this._clips.push(t),this._inputs.push(r),this._outputs.push(a)}removeClip(t){const e=this._targets,s=this._binder,i=this._clips,n=i[t].track.curves;for(let t=0;t<n.length;++t){const i=n[t].paths;for(let t=0;t<i.length;++t){const n=i[t],r=this._binder.resolve(n);r&&(r.curves--,0===r.curves&&(s.unresolve(n),delete e[r.targetPath],s.animComponent&&s.animComponent.targets[r.targetPath].layerCounter--))}}i.splice(t,1),this._inputs.splice(t,1),this._outputs.splice(t,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(t,e){this._clips.forEach((s=>{s.name.includes(t)&&(s.track=e)})),this.rebind()}findClip(t){const e=this._clips;for(let s=0;s<e.length;++s){const i=e[s];if(i.name===t)return i}return null}rebind(){this._binder.rebind(),this._targets={};const t=[...this.clips];this.removeClips(),t.forEach((t=>{this.addClip(t)}))}assignMask(t){return this._binder.assignMask(t)}update(t,e=!0){const s=this._clips,i=s.map(((t,e)=>e));__.stableSort(i,((t,e)=>s[t].blendOrder<s[e].blendOrder));for(let n=0;n<i.length;++n){const r=i[n],a=s[r],o=this._inputs[r],l=this._outputs[r],h=a.blendWeight;if(h>0&&a._update(t),!e)break;let c,d,u;if(h>=1)for(let t=0;t<o.length;++t)c=o[t],d=l[t],u=d.value,__.set(u,c,d.target.type),d.blendCounter++;else if(h>0)for(let t=0;t<o.length;++t)c=o[t],d=l[t],u=d.value,0===d.blendCounter?__.set(u,c,d.target.type):__.blend(u,c,h,d.target.type),d.blendCounter++}const n=this._targets,r=this._binder;for(const t in n)if(n.hasOwnProperty(t)){const e=n[t];if(r.animComponent&&e.target.isTransform){const s=r.animComponent.targets[t];s.counter===s.layerCounter&&(s.counter=0),s.path||(s.path=t,s.baseValue=e.target.get(),s.setter=e.target.set),s.updateValue(r.layerIndex,e.value),s.counter++}else e.target.set(e.value);e.blendCounter=0}this._binder.update(t)}}class b_{constructor(t){this._events=[...t],this._events.sort(((t,e)=>t.time-e.time))}get events(){return this._events}}class y_{static{this.EMPTY=Object.freeze(new y_("empty",Number.MAX_VALUE,[],[],[]))}constructor(t,e,s,i,n,r=new b_([])){this._name=t,this._duration=e,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=r}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(t){this._animEvents=t}get events(){return this._animEvents.events}eval(t,e){e._time=t;const s=this._inputs,i=this._outputs,n=this._curves,r=e._cache,a=e._results;for(let e=0;e<s.length;++e)r[e].update(t,s[e]._data);for(let t=0;t<n.length;++t){const e=n[t],s=i[e._output],o=a[t];r[e._input].eval(o,e._interpolation,s)}}}class S_{static joinPath(t,e){e=e||".";return t.map((function(t){return t.replace(/\\/g,"\\\\").replace(new RegExp(`\\${e}`,"g"),`\\${e}`)})).join(e)}static splitPath(t,e){e=e||".";const s=[];let i="",n=0;for(;n<t.length;){let r=t[n++];"\\"===r&&n<t.length?(r=t[n++],i+="\\"===r||r===e?r:`\\${r}`):r===e?(s.push(i),i=""):i+=r}return i.length>0&&s.push(i),s}static encode(t,e,s){return`${Array.isArray(t)?t.join("/"):t}/${e}/${Array.isArray(s)?s.join("/"):s}`}resolve(t){return null}unresolve(t){}update(t){}}class x_{constructor(t,e,s,i){t.set?(this._set=t.set,this._get=t.get):this._set=t,this._type=e,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class w_{constructor(t){if(this._isPathInMask=(t,e)=>{const s=this._mask[t];return!!s&&!!(s.children||e&&!1!==s.value)},this.graph=t,!t)return;this._mask=null;const e={},s=function(t){e[t.name]=t;for(let e=0;e<t.children.length;++e)s(t.children[e])};s(t),this.nodes=e,this.targetCache={};const i=function(t){let e,s=t;for(;s&&!(s instanceof Im);)s=s.parent;return s&&(s.render?e=s.render.meshInstances:s.model&&(e=s.model.meshInstances)),e};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(t){const e=t.localPosition;return w_.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localPosition")},localRotation:function(t){const e=t.localRotation;return w_.createAnimTarget((function(t){e.set(...t)}),"quaternion",4,t,"localRotation")},localScale:function(t){const e=t.localScale;return w_.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localScale")},weight:function(t,e){e=0===e.indexOf("name.")?e.replace("name.",""):Number(e);const s=i(t);let n;if(s)for(let i=0;i<s.length;++i)if(s[i].node.name===t.name&&s[i].morphInstance){const t=s[i].morphInstance,r=s=>{t.setWeight(e,s[0])};n||(n=[]),n.push(r)}if(n){const s=t=>{for(let e=0;e<n.length;++e)n[e](t)};return w_.createAnimTarget(s,"number",1,t,`weight.${e}`)}return null},materialTexture:(t,e)=>{const s=i(t);if(s){let i;for(let e=0;e<s.length;++e)if(s[e].node.name===t.name){i=s[e];break}if(i){const s=t=>{const s=this.animComponent.system.app.assets.get(t[0]);s&&s.resource&&"texture"===s.type&&(i.material[e]=s.resource,i.material.update())};return w_.createAnimTarget(s,"vector",1,t,"materialTexture","material")}}return null}}}_isPathActive(t){if(!this._mask)return!0;const e=[t.entityPath[0],this.graph.name];for(let s=0;s<e.length;++s){let i=e[s];if(this._isPathInMask(i,1===t.entityPath.length))return!0;for(let e=1;e<t.entityPath.length;e++)if(i+=`/${t.entityPath[e]}`,this._isPathInMask(i,e===t.entityPath.length-1))return!0}return!1}findNode(t){if(!this._isPathActive(t))return null;let e;return this.graph&&(e=this.graph.findByPath(t.entityPath),e||(e=this.graph.findByPath(t.entityPath.slice(1)))),e||(e=this.nodes[t.entityPath[t.entityPath.length-1]||""]),e}static createAnimTarget(t,e,s,i,n,r){const a=S_.encode(i.path,r||"entity",n);return new x_(t,e,s,a)}resolve(t){const e=S_.encode(t.entityPath,t.component,t.propertyPath);let s=this.targetCache[e];if(s)return s;const i=this.findNode(t);if(!i)return null;const n=this.handlers[t.propertyPath];return n?(s=n(i),s?(this.targetCache[e]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null):null}unresolve(t){if("graph"!==t.component)return;const e=this.nodes[t.entityPath[t.entityPath.length-1]||""];if(this.nodeCounts[e.path]--,0===this.nodeCounts[e.path]){const t=this.activeNodes,s=t.indexOf(e.node),i=t.length;s<i-1&&(t[s]=t[i-1]),t.pop()}}update(t){const e=this.activeNodes;for(let t=0;t<e.length;++t)e[t]._dirtifyLocal()}assignMask(t){return t!==this._mask&&(this._mask=t,!0)}}class T_{constructor(t,e,s,i,n=1){this._state=t,this._parent=e,this._name=s,Array.isArray(i)?(this._point=new os(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?`${this._parent.path}.${this._name}`:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(t){this._weight=t}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const t=this._state.totalWeight;return 0===t?0:this.weight/t}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(t){this._weightedSpeed=t}get weightedSpeed(){return this._weightedSpeed}set animTrack(t){this._animTrack=t}get animTrack(){return this._animTrack}}class E_ extends T_{constructor(t,e,s,i,n,r,a,o,l){super(t,e,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=l,this._syncAnimations=!1!==a,this._pointCache={};for(let e=0;e<r.length;e++){const s=r[e];s.children?this._children.push(o(s.type,t,this,s.name,1,s.parameter?[s.parameter]:s.parameters,s.children,s.syncAnimations,o,l)):this._children.push(new T_(t,this,s.name,s.point,s.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(t){for(let e=0;e<this._children.length;e++)if(this._children[e].name===t)return this._children[e];return null}updateParameterValues(){let t=!0;for(let e=0;e<this._parameterValues.length;e++){const s=this._findParameter(this._parameters[e]).value;this._parameterValues[e]!==s&&(this._parameterValues[e]=s,t=!1)}return t}getNodeWeightedDuration(t){return this._children[t].animTrack.duration/this._children[t].speedMultiplier*this._children[t].weight}getNodeCount(){let t=0;for(let e=0;e<this._children.length;e++){this._children[e].constructor===E_?t+=this._children[e].getNodeCount():t++}return t}}class C_ extends E_{constructor(t,e,s,i,n,r,a,o,l){r.sort(((t,e)=>t.point-e.point)),super(t,e,s,i,n,r,a,o,l)}calculateWeights(){if(this.updateParameterValues())return;let t=0;this._children[0].weight=0;for(let e=0;e<this._children.length;e++){const s=this._children[e];if(e!==this._children.length-1){const t=this._children[e+1];if(s.point===t.point)s.weight=.5,t.weight=.5;else if(Qe.between(this._parameterValues[0],s.point,t.point,!0)){const e=Math.abs(s.point-t.point),i=(e-Math.abs(s.point-this._parameterValues[0]))/e;s.weight=i,t.weight=1-i}else t.weight=0}this._syncAnimations&&(t+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let e=0;e<this._children.length;e++){const s=this._children[e];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t}}}class A_ extends E_{static{this._p=new os}static{this._pip=new os}pointDistanceCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=this._children[e].point.clone().sub(this._children[t].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;A_._p.set(...this._parameterValues),t=0,e=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;A_._pip.set(A_._p.x,A_._p.y).sub(n);let r=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(s===t)continue;const e=this.pointDistanceCache(s,t),i=Qe.clamp(1-A_._pip.dot(e)/e.lengthSq(),0,1);i<r&&(r=i)}i.weight=r,t+=r,this._syncAnimations&&(e+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)}}}class D_ extends E_{static{this._p=new os}static{this._pip=new os}pointCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=new os((this._children[e].pointLength-this._children[t].pointLength)/((this._children[e].pointLength+this._children[t].pointLength)/2),2*os.angleRad(this._children[t].point,this._children[e].point))),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;D_._p.set(...this._parameterValues);const s=D_._p.length();t=0,e=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],r=n.point,a=n.pointLength;let o=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(i===t)continue;const e=this.pointCache(i,t),n=this._children[t].pointLength;D_._pip.set((s-a)/((n+a)/2),2*os.angleRad(r,D_._p));const l=Qe.clamp(1-Math.abs(D_._pip.dot(e)/e.lengthSq()),0,1);l<o&&(o=l)}n.weight=o,t+=o,this._syncAnimations&&(e+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i.weight=i._weight/t,this._syncAnimations){const s=i.animTrack.duration/e*t;i.weightedSpeed=i.absoluteSpeed*s}}}}class P_ extends E_{calculateWeights(){if(this.updateParameterValues())return;let t=0,e=0;for(let s=0;s<this._children.length;s++)if(t+=Math.max(this._parameterValues[s],0),this._syncAnimations){const t=this._children[s];e+=t.animTrack.duration/t.absoluteSpeed*t.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s],n=Math.max(this._parameterValues[s],0);t?(i.weight=n/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}class L_{constructor(t,e,s=1,i=!0,n){this._animations={},this._animationList=[],this._controller=t,this._name=e,this._speed=s,this._loop=i,this._hasAnimations=!1,this._blendTree=n?this._createTree(n.type,this,null,e,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,this._controller.findParameter):new T_(this,null,e,1,s)}_createTree(t,e,s,i,n,r,a,o,l,h){switch(t){case"1D":return new C_(e,s,i,n,r,a,o,l,h);case"2D_CARTESIAN":return new A_(e,s,i,n,r,a,o,l,h);case"2D_DIRECTIONAL":return new D_(e,s,i,n,r,a,o,l,h);case"DIRECT":return new P_(e,s,i,n,r,a,o,l,h)}}_getNodeFromPath(t){let e=this._blendTree;for(let s=1;s<t.length;s++)e=e.getChild(t[s]);return e}addAnimation(t,e){const s=t.join("."),i=this._animationList.findIndex((t=>t.path===s));if(i>=0)this._animationList[i].animTrack=e;else{const s=this._getNodeFromPath(t);s.animTrack=e,this._animationList.push(s)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every((t=>t.animTrack&&t.animTrack!==y_.EMPTY))}get name(){return this._name}set animations(t){this._animationList=t,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(t){this._speed=t}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==T_?this._blendTree.getNodeCount():1}get playable(){return-1!==p_.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const t=`${this.name}.${this.animations[0].animTrack.name}`,e=this._controller.animEvaluator.findClip(t);if(e)return e.loop}return!1}get totalWeight(){let t=0;for(let e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}get timelineDuration(){let t=0;for(let e=0;e<this.animations.length;e++){const s=this.animations[e];s.animTrack.duration>t&&(t=s.animTrack.duration)}return t}}class I_{constructor({from:t,to:e,time:s=0,priority:i=0,conditions:n=[],exitTime:r=null,transitionOffset:a=null,interruptionSource:o=a_}){this._from=t,this._to=e,this._time=s,this._priority=i,this._conditions=n,this._exitTime=r,this._transitionOffset=a,this._interruptionSource=o}get from(){return this._from}set to(t){this._to=t}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class R_{constructor(t,e,s,i,n,r,a){this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=d_,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=a_,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=t=>this._findParameter(t),this._animEvaluator=t,this._eventHandler=n,this._findParameter=r,this._consumeTrigger=a;for(let t=0;t<e.length;t++)this._states[e[t].name]=new L_(this,e[t].name,e[t].speed,e[t].loop,e[t].blendTree),this._stateNames.push(e[t].name);this._transitions=s.map((t=>new I_({...t}))),this._activate=i}get animEvaluator(){return this._animEvaluator}set activeState(t){this._activeStateName=t}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(t){this._previousStateName=t}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let t=!0;for(let e=0;e<this._stateNames.length;e++)this._states[this._stateNames[e]].playable||(t=!1);return t}set playing(t){this._playing=t}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let t=0;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this._animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(t=Math.max(t,s.track.duration))}this._activeStateDuration=t,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(t){this._timeInStateBefore=t,this._timeInState=t;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this.animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(s.time=t)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(t){return this._animEvaluator.assignMask(t)}_findState(t){return this._states[t]}_getActiveStateProgressForTime(t){if(this.activeStateName===d_||this.activeStateName===u_||this.activeStateName===f_)return 1;const e=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return e?e.progressForTime(t):null}_findTransitionsFromState(t){let e=this._findTransitionsFromStateCache[t];return e||(e=this._transitions.filter((e=>e.from===t)),Eu(e),this._findTransitionsFromStateCache[t]=e),e}_findTransitionsBetweenStates(t,e){let s=this._findTransitionsBetweenStatesCache[`${t}->${e}`];return s||(s=this._transitions.filter((s=>s.from===t&&s.to===e)),Eu(s),this._findTransitionsBetweenStatesCache[`${t}->${e}`]=s),s}_transitionHasConditionsMet(t){const e=t.conditions;for(let t=0;t<e.length;t++){const s=e[t],i=this._findParameter(s.parameterName);switch(s.predicate){case"GREATER_THAN":if(!(i.value>s.value))return!1;break;case"LESS_THAN":if(!(i.value<s.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(i.value>=s.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(i.value<=s.value))return!1;break;case"EQUAL_TO":if(i.value!==s.value)return!1;break;case"NOT_EQUAL_TO":if(i.value===s.value)return!1}}return!0}_findTransition(t,e){let s=[];if(t&&e)s=s.concat(this._findTransitionsBetweenStates(t,e));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(f_));break;case"NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(f_));break;case"PREV_STATE_NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(f_));break;case"NEXT_STATE_PREV_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(f_))}else s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(f_));if(s=s.filter((t=>{if(t.to===this.activeStateName)return!1;if(t.hasExitTime){let e=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(t.exitTime<1&&this.activeState.loop&&(e-=Math.floor(e),s-=Math.floor(s)),s===e){if(s!==t.exitTime)return null}else if(!(t.exitTime>e&&t.exitTime<=s))return null}return this._transitionHasConditionsMet(t)})),s.length>0){const t=s[0];if(t.to===u_){const e=this._findTransitionsFromState(d_)[0];t.to=e.to}return t}return null}updateStateFromTransition(t){let e,s,i;this.previousState=t.from?this.activeStateName:null,this.activeState=t.to,this._activeStateDurationDirty=!0;for(let e=0;e<t.conditions.length;e++){const s=t.conditions[e];this._findParameter(s.parameterName).type===c_&&this._consumeTrigger(s.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const t=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let n=0;n<this._transitionPreviousStates.length;n++){this._isTransitioning?n!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[n].weight*=1-t:this._transitionPreviousStates[n].weight=t:this._transitionPreviousStates[n].weight=1,e=this._findState(this._transitionPreviousStates[n].name);for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(`${s.name}.previous.${n}`),i||(i=this._animEvaluator.findClip(s.name),i.name=`${s.name}.previous.${n}`),n!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=t.time,this._currTransitionTime=0,this._transitionInterruptionSource=t.interruptionSource;const n=this.activeState,r=t.transitionOffset&&t.transitionOffset>0&&t.transitionOffset<1;let a=0,o=0;if(r){const e=n.timelineDuration*t.transitionOffset;a=e,o=e}this._timeInState=a,this._timeInStateBefore=o;for(let e=0;e<n.animations.length;e++){if(i=this._animEvaluator.findClip(n.animations[e].name),i)i.reset();else{const t=Number.isFinite(n.animations[e].speed)?n.animations[e].speed:n.speed;i=new r_(n.animations[e].animTrack,this._timeInState,t,!0,n.loop,this._eventHandler),i.name=n.animations[e].name,this._animEvaluator.addClip(i)}if(t.time>0?i.blendWeight=0:i.blendWeight=n.animations[e].normalizedWeight,i.play(),r)i.time=n.timelineDuration*t.transitionOffset;else{const t=n.speed>=0?0:this.activeStateDuration;i.time=t}}}_transitionToState(t){if(!this._findState(t))return;let e=this._findTransition(this._activeStateName,t);e||(this._animEvaluator.removeClips(),e=new I_({from:null,to:t})),this.updateStateFromTransition(e)}assignAnimation(t,e,s,i){const n=t.split(".");let r=this._findState(n[0]);r||(r=new L_(this,n[0],s),this._states[n[0]]=r,this._stateNames.push(n[0])),r.addAnimation(n,e),this._animEvaluator.updateClipTrack(r.name,e),void 0!==s&&(r.speed=s),void 0!==i&&(r.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(t){if(-1!==p_.indexOf(t))return!1;const e=this._findState(t);return!!e&&(e.animations=[],!0)}play(t){t&&this._transitionToState(t),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=d_,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(t){if(!this._playing)return;let e,s,i;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=t*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,t=this.activeStateDuration-this._timeInStateBefore));const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=t,this._currTransitionTime<=this._totalTransitionTime){const t=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){e=this._findState(this._transitionPreviousStates[n].name);const r=this._transitionPreviousStates[n].weight;for(let a=0;a<e.animations.length;a++)s=e.animations[a],i=this._animEvaluator.findClip(`${s.name}.previous.${n}`),i&&(i.blendWeight=(1-t)*s.normalizedWeight*r)}e=this.activeState;for(let i=0;i<e.animations.length;i++)s=e.animations[i],this._animEvaluator.findClip(s.name).blendWeight=t*s.normalizedWeight}else{this._isTransitioning=!1;const t=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let e=0;e<n-t;e++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==T_){e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(t,this.activeState.hasAnimations)}}const M_=new os,k_=new rs,O_=new ls,F_=new Ze,N_=new ms;class B_ extends w_{constructor(t,e,s,i,n){super(e),this.animComponent=t,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(t){return t[0]}static _packBoolean(t){return!!t[0]}static _packVec2(t){return M_.x=t[0],M_.y=t[1],M_}static _packVec3(t){return k_.x=t[0],k_.y=t[1],k_.z=t[2],k_}static _packVec4(t){return O_.x=t[0],O_.y=t[1],O_.z=t[2],O_.w=t[3],O_}static _packColor(t){return F_.r=t[0],F_.g=t[1],F_.b=t[2],F_.a=t[3],F_}static _packQuat(t){return N_.x=t[0],N_.y=t[1],N_.z=t[2],N_.w=t[3],N_}resolve(t){const e=S_.encode(t.entityPath,t.component,t.propertyPath);let s,i,n,r=this.targetCache[e];if(r)return r;switch(t.component){case"entity":s=this._getEntityFromHierarchy(t.entityPath),n=S_.encode(s.path,"entity",t.propertyPath),i=s;break;case"graph":if(i=this.findNode(t),!i)return null;n=S_.encode(i.path,"graph",t.propertyPath);break;default:if(s=this._getEntityFromHierarchy(t.entityPath),i=s.findComponent(t.component),!i)return null;n=S_.encode(s.path,t.component,t.propertyPath)}return r=this._createAnimTargetForProperty(i,t.propertyPath,n),this.targetCache[e]=r,r}update(t){const e=this.activeNodes;if(e)for(let t=0;t<e.length;t++)e[t]._dirtifyLocal()}_getEntityFromHierarchy(t){if(!this.animComponent.entity.name===t[0])return null;const e=this.animComponent.entity;return 1===t.length?e:e._parent.findByPath(t)}_resolvePath(t,e,s){const i=e.length-(s?0:1);for(let s=0;s<i;s++)t=t[e[s]];return t}_setter(t,e,s){const i=this._resolvePath(t,e),n=e[e.length-1],r=`set${n.substring(0,1).toUpperCase()}${n.substring(1)}`;if(i[r]){let t=i[`get${n.substring(0,1).toUpperCase()}${n.substring(1)}`].bind(i)();t=[t.x,t.y,t.z,t.w];const e=i[r].bind(i);return{set:t=>{e(s(t))},get:()=>t}}const a=i[n];if("object"==typeof a&&a.hasOwnProperty("copy"))return function(t){a.copy(s(t))};if(-1!==[os,rs,ls,Ze,ms].indexOf(i.constructor)&&e.length>1){const r=e.length>2?this._resolvePath(t,e.slice(0,-1)):t,a=e[e.length-2];return function(t){i[n]=s(t),r[a]=i}}return function(t){i[n]=s(t)}}_createAnimTargetForProperty(t,e,s){if(this.handlers&&e[0].startsWith("weight."))return this.handlers.weight(t,e[0].replace("weight.",""));if(this.handlers&&"material"===e[0]&&2===e.length){const s=e[1];if(s.endsWith("Map"))return this.handlers.materialTexture(t,s)}const i=this._resolvePath(t,e,!0);if(void 0===i)return null;let n,r,a;if("number"==typeof i)n=this._setter(t,e,B_._packFloat),r="vector",a=1;else if("boolean"==typeof i)n=this._setter(t,e,B_._packBoolean),r="vector",a=1;else if("object"==typeof i)switch(i.constructor){case os:n=this._setter(t,e,B_._packVec2),r="vector",a=2;break;case rs:n=this._setter(t,e,B_._packVec3),r="vector",a=3;break;case ls:n=this._setter(t,e,B_._packVec4),r="vector",a=4;break;case Ze:n=this._setter(t,e,B_._packColor),r="vector",a=4;break;case ms:n=this._setter(t,e,B_._packQuat),r="quaternion",a=4;break;default:return null}return-1!==e.indexOf("material")?new x_((e=>{n(e),t.material.update()}),r,a,s):new x_(n,r,a,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const t={},e=function(s){t[s.name]=s;for(let t=0;t<s.children.length;++t)e(s.children[t])};e(this.graph),this.nodes=t}}class U_{constructor(t,e,s,i=1,n=m_){this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=t,this._controller=e,this._component=s,this._weight=i,this._blendType=n}get name(){return this._name}set playing(t){this._controller.playing=t}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(t){const e=this._controller,s=e.playing;e.playing=!0,e.activeStateCurrentTime=t,s||e.update(0),e.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(t){this._weight=t,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(t){t!==this._blendType&&(this._blendType=t,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}get mask(){return this._mask}play(t){this._controller.play(t)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(t){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=Qe.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=t):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(t)}blendToWeight(t,e){this._startingWeight=this.weight,this._targetWeight=t,this._blendTime=Math.max(0,e),this._blendTimeElapsed=0}assignAnimation(t,e,s,i){e instanceof y_&&(this._controller.assignAnimation(t,e,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new I_({from:"START",to:t})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(t){this._controller.removeNodeAnimations(t)&&(this._component.playing=!1)}getAnimationAsset(t){return this._component.animationAssets[`${this.name}:${t}`]}transition(t,e=0,s=null){this._controller.updateStateFromTransition(new I_({from:this._controller.activeStateName,to:t,time:e,transitionOffset:s}))}}class z_{constructor(t){if(this._layers=[],this._parameters={},Array.isArray(t.layers))this._layers=t.layers;else for(const e in t.layers){const s=t.layers[e],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let e=0;e<s.states.length;e++)i.states.push(t.states[s.states[e]]);for(let e=0;e<s.transitions.length;e++){const n=t.transitions[s.transitions[e]];if(n.conditions&&!Array.isArray(n.conditions)){const t=Object.keys(n.conditions),e=[];for(let s=0;s<t.length;s++){const i=n.conditions[t[s]];i.parameterName&&e.push(i)}n.conditions=e}Number.isInteger(n.from)&&(n.from=t.states[n.from].name),Number.isInteger(n.to)&&(n.to=t.states[n.to].name),i.transitions.push(n)}this._layers.push(i)}for(const e in t.parameters){const s=t.parameters[e];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}class V_ extends t_{set stateGraphAsset(t){if(null===t)return void this.removeStateGraph();if(this._stateGraphAsset){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}let e,s;t instanceof pm?(e=t.id,s=this.system.app.assets.get(e),s||(this.system.app.assets.add(t),s=this.system.app.assets.get(e))):(e=t,s=this.system.app.assets.get(e)),s&&this._stateGraphAsset!==e&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",(t=>{this._stateGraph=t.resource,this.loadStateGraph(this._stateGraph)})),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=e)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(t){this._normalizeWeights=t,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(t){this._animationAssets=t,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(t){this._speed=t}get speed(){return this._speed}set activate(t){this._activate=t}get activate(){return this._activate}set playing(t){this._playing=t}get playing(){return this._playing}set rootBone(t){if("string"==typeof t){const e=this.entity.root.findByGuid(t);this._rootBone=e}else this._rootBone=t instanceof Im?t:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(t){this._stateGraph=t}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(t){this._layerIndices=t}get layerIndices(){return this._layerIndices}set parameters(t){this._parameters=t}get parameters(){return this._parameters}set targets(t){this._targets=t}get targets(){return this._targets}get playable(){for(let t=0;t<this._layers.length;t++)if(!this._layers[t].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(t){const e=this.animationAssets,s=this.layers.map((t=>t.mask));this.removeStateGraph(),this._stateGraph=new z_(t._data),this.loadStateGraph(this._stateGraph),this.animationAssets=e,this.loadAnimationAssets(),this.layers.forEach(((t,e)=>{t.mask=s[e]})),this.rebind()}dirtifyTargets(){const t=Object.values(this._targets);for(let e=0;e<t.length;e++)t[e].dirty=!0}_addLayer({name:t,states:e,transitions:s,weight:i,mask:n,blendType:r}){let a;a=this.rootBone?this.rootBone:this.entity;const o=this._layers.length,l=new B_(this,a,t,n,o),h=new v_(l),c=new R_(h,e,s,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new U_(t,c,this,i,r)),this._layerIndices[t]=o,this._layers[o]}addLayer(t,e,s,i){const n=this.findAnimationLayer(t);if(n)return n;return this._addLayer({name:t,states:[{name:"START",speed:1}],transitions:[],weight:e,mask:s,blendType:i})}_assignParameters(t){this._parameters={};const e=Object.keys(t.parameters);for(let s=0;s<e.length;s++){const i=e[s];this._parameters[i]={type:t.parameters[i].type,value:t.parameters[i].value}}}loadStateGraph(t){this._stateGraph=t,this._assignParameters(t),this._layers=[];let e=!1;for(let s=0;s<t.layers.length;s++){const i=t.layers[s];this._addLayer({...i}),i.states.some((t=>t.blendTree))&&(e=!0)}e||this.setupAnimationAssets()}setupAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t],s=e.name;for(let t=0;t<e.states.length;t++){const i=e.states[t];if(-1===p_.indexOf(i)){const t=`${s}:${i}`;this._animationAssets[t]||(this._animationAssets[t]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t];for(let t=0;t<e.states.length;t++){const s=e.states[t];if(-1!==p_.indexOf(s))continue;const i=this._animationAssets[`${e.name}:${s}`];if(!i||!i.asset){this.findAnimationLayer(e.name).assignAnimation(s,y_.EMPTY);continue}const n=i.asset,r=this.system.app.assets.get(n);r&&(r.resource?this.onAnimationAssetLoaded(e.name,s,r):(r.once("load",function(t,e){return function(s){this.onAnimationAssetLoaded(t,e,s)}.bind(this)}.bind(this)(e.name,s)),this.system.app.assets.load(r)))}}}onAnimationAssetLoaded(t,e,s){this.findAnimationLayer(t).assignAnimation(e,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(let t=0;t<this._layers.length;t++){const e=this._layers[t].playing;this._layers[t].reset(),this._layers[t].playing=e}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach((t=>{this._targets[t].unbind()}))}rebind(){this._targets={};for(let t=0;t<this._layers.length;t++)this._layers[t].rebind()}findAnimationLayer(t){const e=this._layerIndices[t];return this._layers[e]||null}addAnimationState(t,e,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new z_({layers:[{name:n,states:[{name:"START",speed:1},{name:t,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}}));const r=this.findAnimationLayer(n);r?r.assignAnimation(t,e,s,i):this.addLayer(n)?.assignAnimation(t,e,s,i)}assignAnimation(t,e,s,i=1,n=!0){if(!this._stateGraph&&-1===t.indexOf("."))return this.loadStateGraph(new z_({layers:[{name:"Base",states:[{name:"START",speed:1},{name:t,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}})),void this.baseLayer.assignAnimation(t,e);const r=s?this.findAnimationLayer(s):this.baseLayer;r&&r.assignAnimation(t,e,i,n)}removeNodeAnimations(t,e){const s=e?this.findAnimationLayer(e):this.baseLayer;s&&s.removeNodeAnimations(t)}getParameterValue(t,e){const s=this._parameters[t];if(s&&s.type===e)return s.value}setParameterValue(t,e,s){const i=this._parameters[t];i&&i.type===e&&(i.value=s)}getFloat(t){return this.getParameterValue(t,l_)}setFloat(t,e){this.setParameterValue(t,l_,e)}getInteger(t){return this.getParameterValue(t,o_)}setInteger(t,e){"number"==typeof e&&e%1==0&&this.setParameterValue(t,o_,e)}getBoolean(t){return this.getParameterValue(t,h_)}setBoolean(t,e){this.setParameterValue(t,h_,!!e)}getTrigger(t){return this.getParameterValue(t,c_)}setTrigger(t,e=!1){this.setParameterValue(t,c_,!0),e&&this._consumedTriggers.add(t)}resetTrigger(t){this.setParameterValue(t,c_,!1)}onBeforeRemove(){if(Number.isFinite(this._stateGraphAsset)){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}}update(t){for(let e=0;e<this.layers.length;e++)this.layers[e].update(t*this.speed);this._consumedTriggers.forEach((t=>{this.parameters[t].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone.getGuid()]?this.rootBone=e[t.rootBone.getGuid()]:this.rebind()}constructor(...t){super(...t),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1,this.findParameter=t=>this._parameters[t],this.consumeTrigger=t=>{this._consumedTriggers.add(t)}}}class H_{constructor(){this.enabled=!0}}const G_=["enabled"];class W_ extends e_{constructor(t){super(t),this.id="anim",this.ComponentType=V_,this.DataType=H_,this.schema=G_,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,G_);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(e).forEach((s=>{i.includes(s)||(t[s]=e[s])})),e.stateGraph&&(t.stateGraph=e.stateGraph,t.loadStateGraph(t.stateGraph)),e.layers&&e.layers.forEach(((e,s)=>{e._controller.states.forEach((i=>{e._controller._states[i]._animationList.forEach((i=>{if(i.animTrack&&i.animTrack!==y_.EMPTY)t.layers[s].assignAnimation(i.name,i.animTrack);else{const n=this.app.assets.get(e._component._animationAssets[`${e.name}:${i.name}`].asset);n&&!n.loaded&&n.once("load",(()=>{t.layers[s].assignAnimation(i.name,n.resource)}))}}))}))})),e.animationAssets&&(t.animationAssets=Object.assign(t.animationAssets,e.animationAssets)),e.masks&&Object.keys(e.masks).forEach((s=>{if(t.layers[s]){const i=e.masks[s].mask,n={};Object.keys(i).forEach((t=>{n[decodeURI(t)]=i[t]})),t.layers[s].mask=n}}))}onAnimationUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(t)}}cloneComponent(t,e){let s;t.anim.rootBone&&t.anim.rootBone!==t||(s={},t.anim.layers.forEach(((t,i)=>{if(t.mask){const n={};Object.keys(t.mask).forEach((s=>{const i=s.split("/");i.shift();const r=[e.name,...i].join("/");n[r]=t.mask[s]})),s[i]={mask:n}}})));const i={enabled:t.anim.enabled,stateGraphAsset:t.anim.stateGraphAsset,animationAssets:t.anim.animationAssets,speed:t.anim.speed,activate:t.anim.activate,playing:t.anim.playing,rootBone:t.anim.rootBone,stateGraph:t.anim.stateGraph,layers:t.anim.layers,layerIndices:t.anim.layerIndices,parameters:t.anim.parameters,normalizeWeights:t.anim.normalizeWeights,masks:s};return this.addComponent(e,i)}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}t_._buildAccessors(V_.prototype,G_);const j_="static",X_="dynamic",$_="kinematic";class q_{destroy(t){this.map.forEach((t=>t.mesh.destroy()))}constructor(){this.map=new Map}}const K_=new ln,Y_=(t,e)=>{const s=K_.get(t,(()=>new q_));let i=s.map.get(e);if(!i){let n,r;switch(e){case"box":n=Wh.fromGeometry(t,new Qu),r={x:2,y:2,z:2,uv:2/3};break;case"capsule":n=Wh.fromGeometry(t,new fp({radius:.5,height:2})),r={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":n=Wh.fromGeometry(t,new pp({baseRadius:.5,peakRadius:0,height:1})),r={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":n=Wh.fromGeometry(t,new mp({radius:.5,height:1})),r={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":n=Wh.fromGeometry(t,new _p({halfExtents:new os(.5,.5),widthSegments:1,lengthSegments:1})),r={x:0,y:1,z:0,uv:1};break;case"sphere":n=Wh.fromGeometry(t,new Zu({radius:.5})),r={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":n=Wh.fromGeometry(t,new gp({tubeRadius:.2,ringRadius:.3})),r={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw new Error(`Invalid primitive type: ${e}`)}n.incRefCount(),i={mesh:n,area:r},s.map.set(e,i)}return i};class Q_ extends fr{constructor(t,e){super(),this.skin=t,this.skinInstance=e}}class Z_{static{this._skinInstanceCache=new Map}static createCachedSkinInstance(t,e,s){let i=Z_.getCachedSkinInstance(t,e);return i||(i=new zh(t),i.resolve(e,s),Z_.addCachedSkinInstance(t,e,i)),i}static getCachedSkinInstance(t,e){let s=null;const i=Z_._skinInstanceCache.get(e);if(i){const e=i.find((e=>e.skin===t));e&&(e.incRefCount(),s=e.skinInstance)}return s}static addCachedSkinInstance(t,e,s){let i=Z_._skinInstanceCache.get(e);i||(i=[],Z_._skinInstanceCache.set(e,i));let n=i.find((e=>e.skin===t));n||(n=new Q_(t,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(t){if(t){const e=t.rootBone;if(e){const s=Z_._skinInstanceCache.get(e);if(s){const i=s.findIndex((e=>e.skinInstance===t));if(i>=0){const n=s[i];n.decRefCount(),0===n.refCount&&(s.splice(i,1),s.length||Z_._skinInstanceCache.delete(e),t&&(t.destroy(),n.skinInstance=null))}}}}}}class J_{constructor(t,e,s,i,n){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=t,this.parent=e,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(t){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=t,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(t){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=t,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on(`load:${this.id}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once(`add:${this.id}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on(`remove:${this.id}`,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on(`unload:${this.id}`,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on(`load:url:${this.url}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once(`add:url:${this.url}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on(`remove:url:${this.url}`,this._onRemove,this)))}_unbind(){this.id&&(this._evtLoadById?.off(),this._evtLoadById=null,this._evtAddById?.off(),this._evtAddById=null,this._evtRemoveById?.off(),this._evtRemoveById=null,this._evtUnloadById?.off(),this._evtUnloadById=null),this.url&&(this._evtLoadByUrl?.off(),this._evtLoadByUrl=null,this._evtAddByUrl?.off(),this._evtAddByUrl=null,this._evtRemoveByUrl?.off(),this._evtRemoveByUrl=null)}_onLoad(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)}_onAdd(t){this.asset=t,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)}_onRemove(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t),this.asset=null}_onUnload(t){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,t)}}class tg extends t_{constructor(t,e){super(t,e),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._materialReferences=[],this._rootBone=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this._assetReference=new J_("asset",this,t.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=t.defaultMaterial,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(t){this._renderStyle!==t&&(this._renderStyle=t,nc._prepareRenderStyleForArray(this._meshInstances,t))}get renderStyle(){return this._renderStyle}set customAabb(t){this._customAabb=t;const e=this._meshInstances;if(e)for(let t=0;t<e.length;t++)e[t].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(t){if(this._type!==t&&(this._area=null,this._type=t,this.destroyMeshInstances(),"asset"!==t)){let e=this._material;e&&e!==this.system.defaultMaterial||(e=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=Y_(this.system.app.graphicsDevice,t);this._area=s.area,this.meshInstances=[new nc(s.mesh,e||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(t){if(this.destroyMeshInstances(),this._meshInstances=t,this._meshInstances){const t=this._meshInstances;for(let e=0;e<t.length;e++)t[e].node||(t[e].node=this.entity),t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].renderStyle=this._renderStyle,t[e].setLightmapped(this._lightmapped),t[e].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(t){if(t!==this._lightmapped){this._lightmapped=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows!==t){const e=this._meshInstances;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=i.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e)}for(let s=0;s<e.length;s++)e[s].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters(e)}}this._castShadows=t}}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t){this._receiveShadows=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(t){const e=this.system.app.scene.layers;let s;if(this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(t){this._batchGroupId!==t&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(Bh.RENDER,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&this.system.app.batcher?.insert(Bh.RENDER,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=t)}get batchGroupId(){return this._batchGroupId}set material(t){if(this._material!==t&&(this._material=t,this._meshInstances&&"asset"!==this._type))for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].material=t}get material(){return this._material}set materialAssets(t=[]){if(this._materialReferences.length>t.length){for(let e=t.length;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this._materialReferences.length=t.length}for(let e=0;e<t.length;e++)if(this._materialReferences[e]||this._materialReferences.push(new J_(e,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),t[e]){const s=t[e]instanceof pm?t[e].id:t[e];this._materialReferences[e].id!==s&&(this._materialReferences[e].id=s),this._materialReferences[e].asset&&this._onMaterialAdded(e,this,this._materialReferences[e].asset)}else this._materialReferences[e].id=null,this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map((t=>t.id))}set asset(t){const e=t instanceof pm?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(t){const e=t instanceof pm?t.id:t;this._assetReference.id=e}set rootBone(t){if(this._rootBone!==t){const e="string"==typeof t;if(this._rootBone&&e&&this._rootBone.getGuid()===t)return;this._rootBone&&this._clearSkinInstances(),this._rootBone=t instanceof Mc?t:e&&this.system.app.getEntityFromIndex(t)||null,this._rootBone&&this._cloneSkinInstances()}}get rootBone(){return this._rootBone}destroyMeshInstances(){const t=this._meshInstances;if(t){this.removeFromLayers(),this._clearSkinInstances();for(let e=0;e<t.length;e++)t[e].destroy();this._meshInstances.length=0}}addToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this._meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this._meshInstances)}onEnable(){const t=this.system.app,e=t.scene,s=e.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));const i="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():i&&this.asset&&this._onRenderAssetAdded();for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].asset&&this.system.app.assets.load(this._materialReferences[t].asset);this._batchGroupId>=0&&t.batcher?.insert(Bh.RENDER,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&t.batcher?.remove(Bh.RENDER,this.batchGroupId,this.entity),this.removeFromLayers()}hide(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!1}show(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const t=this._assetReference.asset.resource;this._evtSetMeshes?.off(),this._evtSetMeshes=t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(t){this._cloneMeshes(t)}_clearSkinInstances(){for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t];Z_.removeCachedSkinInstance(e.skinInstance),e.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone instanceof Mc)for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t],s=e.mesh;s.skin&&!e.skinInstance&&(e.skinInstance=Z_.createCachedSkinInstance(s.skin,this._rootBone,this.entity))}}_cloneMeshes(t){if(t&&t.length){const e=[];for(let s=0;s<t.length;s++){const i=t[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,r=new nc(i,n||this.system.defaultMaterial,this.entity);e.push(r),i.morph&&(r.morphInstance=new Bu(i.morph))}this.meshInstances=e,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._evtSetMeshes?.off(),this._evtSetMeshes=null,this._onRenderAssetUnload()}_onMaterialAdded(t,e,s){s.resource?this._onMaterialLoad(t,e,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(t,e){0===t&&(this.material=e)}_onMaterialLoad(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=s.resource),this._updateMainMaterial(t,s.resource)}_onMaterialRemove(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}_onMaterialUnload(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&(this.rootBone=e[t.rootBone.getGuid()])}}class eg{constructor(){this.enabled=!0}}const sg=["enabled"],ig=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"];class ng extends e_{constructor(t){super(t),this.id="render",this.ComponentType=tg,this.DataType=eg,this.schema=sg,this.defaultMaterial=Xh(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let s=0;s<ig.length;s++)e.hasOwnProperty(ig[s])&&(t[ig[s]]=e[ig[s]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new Ss(new rs(e.aabbCenter),new rs(e.aabbHalfExtents))),super.initializeComponentData(t,e,sg)}cloneComponent(t,e){const s={};for(let e=0;e<ig.length;e++)s[ig[e]]=t.render[ig[e]];s.enabled=t.render.enabled,delete s.meshInstances;const i=this.addComponent(e,s),n=t.render.meshInstances,r=n.map((t=>t.mesh));i._onSetMeshes(r);for(let t=0;t<n.length;t++)i.meshInstances[t].material=n[t].material;return t.render.customAabb&&(i.customAabb=t.render.customAabb.clone()),i}onRemove(t,e){e.onRemove()}}t_._buildAccessors(tg.prototype,sg);class rg{constructor(t,e){this._pool=[],this._count=0,this._constructor=t,this._resize(e)}_resize(t){if(t>this._pool.length)for(let e=this._pool.length;e<t;e++)this._pool[e]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0}}let ag,og,lg,hg;const cg=new ms,dg=new ms,ug=new rs;class fg extends t_{static{this.EVENT_CONTACT="contact"}static{this.EVENT_COLLISIONSTART="collisionstart"}static{this.EVENT_COLLISIONEND="collisionend"}static{this.EVENT_TRIGGERENTER="triggerenter"}static{this.EVENT_TRIGGERLEAVE="triggerleave"}static{this.order=-1}static onLibraryLoaded(){"undefined"!=typeof Ammo&&(ag=new Ammo.btTransform,og=new Ammo.btVector3,lg=new Ammo.btVector3,hg=new Ammo.btQuaternion)}static onAppDestroy(){Ammo.destroy(ag),Ammo.destroy(og),Ammo.destroy(lg),Ammo.destroy(hg),ag=null,og=null,lg=null,hg=null}set angularDamping(t){this._angularDamping!==t&&(this._angularDamping=t,this._body&&this._body.setDamping(this._linearDamping,t))}get angularDamping(){return this._angularDamping}set angularFactor(t){this._angularFactor.equals(t)||(this._angularFactor.copy(t),this._body&&this._type===X_&&(og.setValue(t.x,t.y,t.z),this._body.setAngularFactor(og)))}get angularFactor(){return this._angularFactor}set angularVelocity(t){this._body&&this._type===X_&&(this._body.activate(),og.setValue(t.x,t.y,t.z),this._body.setAngularVelocity(og),this._angularVelocity.copy(t))}get angularVelocity(){if(this._body&&this._type===X_){const t=this._body.getAngularVelocity();this._angularVelocity.set(t.x(),t.y(),t.z())}return this._angularVelocity}set body(t){this._body!==t&&(this._body=t,t&&this._simulationEnabled&&t.activate())}get body(){return this._body}set friction(t){this._friction!==t&&(this._friction=t,this._body&&this._body.setFriction(t))}get friction(){return this._friction}set group(t){this._group!==t&&(this._group=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(t){this._linearDamping!==t&&(this._linearDamping=t,this._body&&this._body.setDamping(t,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(t){this._linearFactor.equals(t)||(this._linearFactor.copy(t),this._body&&this._type===X_&&(og.setValue(t.x,t.y,t.z),this._body.setLinearFactor(og)))}get linearFactor(){return this._linearFactor}set linearVelocity(t){this._body&&this._type===X_&&(this._body.activate(),og.setValue(t.x,t.y,t.z),this._body.setLinearVelocity(og),this._linearVelocity.copy(t))}get linearVelocity(){if(this._body&&this._type===X_){const t=this._body.getLinearVelocity();this._linearVelocity.set(t.x(),t.y(),t.z())}return this._linearVelocity}set mask(t){this._mask!==t&&(this._mask=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(t){if(this._mass!==t&&(this._mass=t,this._body&&this._type===X_)){const e=this.enabled&&this.entity.enabled;e&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(t,og),this._body.setMassProps(t,og),this._body.updateInertiaTensor(),e&&this.enableSimulation()}}get mass(){return this._mass}set restitution(t){this._restitution!==t&&(this._restitution=t,this._body&&this._body.setRestitution(t))}get restitution(){return this._restitution}set rollingFriction(t){this._rollingFriction!==t&&(this._rollingFriction=t,this._body&&this._body.setRollingFriction(t))}get rollingFriction(){return this._rollingFriction}set type(t){if(this._type!==t){switch(this._type=t,this.disableSimulation(),t){case X_:this._group=1,this._mask=65535;break;case $_:this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533}this.createBody()}}get type(){return this._type}createBody(){const t=this.entity;let e;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);const s=this._type===X_?this._mass:0;this._getEntityTransform(ag);const i=this.system.createBody(s,e,ag);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===X_){const t=this._linearFactor;og.setValue(t.x,t.y,t.z),i.setLinearFactor(og);const e=this._angularFactor;og.setValue(e.x,e.y,e.z),i.setAngularFactor(og)}else this._type===$_&&(i.setCollisionFlags(2|i.getCollisionFlags()),i.setActivationState(4));i.entity=t,this.body=i,this.enabled&&t.enabled&&this.enableSimulation()}}isActive(){return!!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate()}enableSimulation(){const t=this.entity;if(t.collision&&t.collision.enabled&&!this._simulationEnabled){const e=this._body;if(e){switch(this.system.addBody(e,this._group,this._mask),this._type){case X_:this.system._dynamic.push(this),e.forceActivationState(1),this.syncEntityToBody();break;case $_:this.system._kinematic.push(this),e.forceActivationState(4);break;case j_:e.forceActivationState(1),this.syncEntityToBody()}"compound"===t.collision.type&&this.system._compounds.push(t.collision),e.activate(),this._simulationEnabled=!0}}}disableSimulation(){const t=this._body;if(t&&this._simulationEnabled){const e=this.system;let s=e._compounds.indexOf(this.entity.collision);s>-1&&e._compounds.splice(s,1),s=e._dynamic.indexOf(this),s>-1&&e._dynamic.splice(s,1),s=e._kinematic.indexOf(this),s>-1&&e._kinematic.splice(s,1),e.removeBody(t),t.forceActivationState(5),this._simulationEnabled=!1}}applyForce(t,e,s,i,n,r){const a=this._body;a&&(a.activate(),t instanceof rs?og.setValue(t.x,t.y,t.z):og.setValue(t,e,s),e instanceof rs?lg.setValue(e.x,e.y,e.z):void 0!==i?lg.setValue(i,n,r):lg.setValue(0,0,0),a.applyForce(og,lg))}applyTorque(t,e,s){const i=this._body;i&&(i.activate(),t instanceof rs?og.setValue(t.x,t.y,t.z):og.setValue(t,e,s),i.applyTorque(og))}applyImpulse(t,e,s,i,n,r){const a=this._body;a&&(a.activate(),t instanceof rs?og.setValue(t.x,t.y,t.z):og.setValue(t,e,s),e instanceof rs?lg.setValue(e.x,e.y,e.z):void 0!==i?lg.setValue(i,n,r):lg.setValue(0,0,0),a.applyImpulse(og,lg))}applyTorqueImpulse(t,e,s){const i=this._body;i&&(i.activate(),t instanceof rs?og.setValue(t.x,t.y,t.z):og.setValue(t,e,s),i.applyTorqueImpulse(og))}isStatic(){return this._type===j_}isStaticOrKinematic(){return this._type===j_||this._type===$_}isKinematic(){return this._type===$_}_getEntityTransform(t){const e=this.entity,s=e.collision;if(s){const t=s.getShapePosition(),e=s.getShapeRotation();og.setValue(t.x,t.y,t.z),hg.setValue(e.x,e.y,e.z,e.w)}else{const t=e.getPosition(),s=e.getRotation();og.setValue(t.x,t.y,t.z),hg.setValue(s.x,s.y,s.z,s.w)}t.setOrigin(og),t.setRotation(hg)}syncEntityToBody(){const t=this._body;if(t){if(this._getEntityTransform(ag),t.setWorldTransform(ag),this._type===$_){const e=t.getMotionState();e&&e.setWorldTransform(ag)}t.activate()}}_updateDynamic(){const t=this._body;if(t.isActive()){const e=t.getMotionState();if(e){const t=this.entity;e.getWorldTransform(ag);const s=ag.getOrigin(),i=ag.getRotation(),n=t.collision;if(n&&n._hasOffset){const e=n.data.linearOffset,r=n.data.angularOffset,a=dg.copy(r).invert(),o=cg.set(i.x(),i.y(),i.z(),i.w()).mul(a);o.transformVector(e,ug),t.setPosition(s.x()-ug.x,s.y()-ug.y,s.z()-ug.z),t.setRotation(o)}else t.setPosition(s.x(),s.y(),s.z()),t.setRotation(i.x(),i.y(),i.z(),i.w())}}}_updateKinematic(){const t=this._body.getMotionState();t&&(this._getEntityTransform(ag),t.setWorldTransform(ag))}teleport(t,e,s,i,n,r){t instanceof rs?this.entity.setPosition(t):this.entity.setPosition(t,e,s),e instanceof ms?this.entity.setRotation(e):e instanceof rs?this.entity.setEulerAngles(e):void 0!==i&&this.entity.setEulerAngles(i,n,r),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}constructor(...t){super(...t),this._angularDamping=0,this._angularFactor=new rs(1,1,1),this._angularVelocity=new rs,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new rs(1,1,1),this._linearVelocity=new rs,this._mask=65533,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=j_}}class pg{constructor(){this.enabled=!0}}let mg,_g;class gg{constructor(t,e,s,i){this.entity=t,this.point=e,this.normal=s,this.hitFraction=i}}class vg{constructor(t,e,s){0!==arguments.length?(this.a=t,this.b=e,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal):(this.a=null,this.b=null,this.impulse=0,this.localPointA=new rs,this.localPointB=new rs,this.pointA=new rs,this.pointB=new rs,this.normal=new rs)}}class bg{constructor(t=new rs,e=new rs,s=new rs,i=new rs,n=new rs,r=0){this.localPoint=t,this.localPointOther=e,this.point=s,this.pointOther=i,this.normal=n,this.impulse=r}}class yg{constructor(t,e){this.other=t,this.contacts=e}}const Sg=["enabled"];class xg extends e_{static{this.EVENT_CONTACT="contact"}constructor(t){super(t),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new rs(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=t.stats.frame,this.ComponentType=fg,this.DataType=pg,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=Sg,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this)}onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const t=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(t)}mg=new Ammo.btVector3,_g=new Ammo.btVector3,fg.onLibraryLoaded(),this.contactPointPool=new rg(bg,1),this.contactResultPool=new rg(yg,1),this.singleContactResultPool=new rg(vg,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(t,e,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const s of i)if(e.hasOwnProperty(s)){const i=e[s];Array.isArray(i)?t[s]=new rs(i[0],i[1],i[2]):t[s]=i}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(e,i)}onBeforeRemove(t,e){e.enabled&&(e.enabled=!1),e.body&&(this.destroyBody(e.body),e.body=null)}addBody(t,e,s){void 0!==e&&void 0!==s?this.dynamicsWorld.addRigidBody(t,e,s):this.dynamicsWorld.addRigidBody(t)}removeBody(t){this.dynamicsWorld.removeRigidBody(t)}createBody(t,e,s){const i=new Ammo.btVector3(0,0,0);0!==t&&e.calculateLocalInertia(t,i);const n=new Ammo.btDefaultMotionState(s),r=new Ammo.btRigidBodyConstructionInfo(t,n,e,i),a=new Ammo.btRigidBody(r);return Ammo.destroy(r),Ammo.destroy(i),a}destroyBody(t){const e=t.getMotionState();e&&Ammo.destroy(e),Ammo.destroy(t)}raycastFirst(t,e,s={}){if(s.filterTags||s.filterCallback)return s.sort=!0,this.raycastAll(t,e,s)[0]||null;let i=null;mg.setValue(t.x,t.y,t.z),_g.setValue(e.x,e.y,e.z);const n=new Ammo.ClosestRayResultCallback(mg,_g);if("number"==typeof s.filterCollisionGroup&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),"number"==typeof s.filterCollisionMask&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(mg,_g,n),n.hasHit()){const t=n.get_m_collisionObject(),e=Ammo.castObject(t,Ammo.btRigidBody);if(e){const t=n.get_m_hitPointWorld(),s=n.get_m_hitNormalWorld();i=new gg(e.entity,new rs(t.x(),t.y(),t.z()),new rs(s.x(),s.y(),s.z()),n.get_m_closestHitFraction())}}return Ammo.destroy(n),i}raycastAll(t,e,s={}){const i=[];mg.setValue(t.x,t.y,t.z),_g.setValue(e.x,e.y,e.z);const n=new Ammo.AllHitsRayResultCallback(mg,_g);if("number"==typeof s.filterCollisionGroup&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),"number"==typeof s.filterCollisionMask&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(mg,_g,n),n.hasHit()){const t=n.get_m_collisionObjects(),e=n.get_m_hitPointWorld(),r=n.get_m_hitNormalWorld(),a=n.get_m_hitFractions(),o=t.size();for(let n=0;n<o;n++){const o=Ammo.castObject(t.at(n),Ammo.btRigidBody);if(o&&o.entity){if(s.filterTags&&!o.entity.tags.has(...s.filterTags)||s.filterCallback&&!s.filterCallback(o.entity))continue;const t=e.at(n),l=r.at(n),h=new gg(o.entity,new rs(t.x(),t.y(),t.z()),new rs(l.x(),l.y(),l.z()),a.at(n));i.push(h)}}s.sort&&i.sort(((t,e)=>t.hitFraction-e.hitFraction))}return Ammo.destroy(n),i}_storeCollision(t,e){let s=!1;const i=t.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:t},this.collisions[i].others.indexOf(e)<0&&(this.collisions[i].others.push(e),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:t},this.frameCollisions[i].others.push(e),s}_createContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),r=t.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPoint.set(e.x(),e.y(),e.z()),a.localPointOther.set(s.x(),s.y(),s.z()),a.point.set(i.x(),i.y(),i.z()),a.pointOther.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=t.getAppliedImpulse(),a}_createReverseContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),r=t.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPointOther.set(e.x(),e.y(),e.z()),a.localPoint.set(s.x(),s.y(),s.z()),a.pointOther.set(i.x(),i.y(),i.z()),a.point.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=t.getAppliedImpulse(),a}_createSingleContactResult(t,e,s){const i=this.singleContactResultPool.allocate();return i.a=t,i.b=e,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(t,e){const s=this.contactResultPool.allocate();return s.other=t,s.contacts=e,s}_cleanOldCollisions(){for(const t in this.collisions)if(this.collisions.hasOwnProperty(t)){const e=this.frameCollisions[t],s=this.collisions[t],i=s.entity,n=i.collision,r=i.rigidbody,a=s.others;let o=a.length;for(;o--;){const t=a[o];(!e||e.others.indexOf(t)<0)&&(a.splice(o,1),i.trigger?(n&&n.fire("triggerleave",t),t.rigidbody&&t.rigidbody.fire("triggerleave",i)):t.trigger||(r&&r.fire("collisionend",t),n&&n.fire("collisionend",t)))}0===a.length&&delete this.collisions[t]}}_hasContactEvent(t){const e=t.collision;if(e&&(e.hasEvent("collisionstart")||e.hasEvent("collisionend")||e.hasEvent("contact")))return!0;const s=t.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(t,e){const s=Ammo.wrapPointer(t,Ammo.btDynamicsWorld).getDispatcher(),i=s.getNumManifolds();this.frameCollisions={};for(let t=0;t<i;t++){const e=s.getManifoldByIndexInternal(t),i=e.getBody0(),n=e.getBody1(),r=Ammo.castObject(i,Ammo.btRigidBody),a=Ammo.castObject(n,Ammo.btRigidBody),o=r.entity,l=a.entity;if(!o||!l)continue;const h=r.getCollisionFlags(),c=a.getCollisionFlags(),d=e.getNumContacts(),u=[],f=[];let p;if(d>0)if(4&h||4&c){const t=o.collision&&(o.collision.hasEvent("triggerenter")||o.collision.hasEvent("triggerleave")),e=l.collision&&(l.collision.hasEvent("triggerenter")||l.collision.hasEvent("triggerleave")),s=o.rigidbody&&(o.rigidbody.hasEvent("triggerenter")||o.rigidbody.hasEvent("triggerleave")),i=l.rigidbody&&(l.rigidbody.hasEvent("triggerenter")||l.rigidbody.hasEvent("triggerleave"));t&&(p=this._storeCollision(o,l),!p||4&c||o.collision.fire("triggerenter",l)),e&&(p=this._storeCollision(l,o),!p||4&h||l.collision.fire("triggerenter",o)),s&&(p||(p=this._storeCollision(l,o)),p&&o.rigidbody.fire("triggerenter",l)),i&&(p||(p=this._storeCollision(o,l)),p&&l.rigidbody.fire("triggerenter",o))}else{const t=this._hasContactEvent(o),s=this._hasContactEvent(l),i=this.hasEvent("contact");if(i||t||s){for(let n=0;n<d;n++){const r=e.getContactPoint(n),a=this._createContactPointFromAmmo(r);if(t||s){u.push(a);const t=this._createReverseContactPointFromAmmo(r);f.push(t)}if(i){const t=this._createSingleContactResult(o,l,a);this.fire("contact",t)}}if(t){const t=this._createContactResult(l,u);p=this._storeCollision(o,l),o.collision&&(o.collision.fire("contact",t),p&&o.collision.fire("collisionstart",t)),o.rigidbody&&(o.rigidbody.fire("contact",t),p&&o.rigidbody.fire("collisionstart",t))}if(s){const t=this._createContactResult(o,f);p=this._storeCollision(l,o),l.collision&&(l.collision.fire("contact",t),p&&l.collision.fire("collisionstart",t)),l.rigidbody&&(l.rigidbody.fire("contact",t),p&&l.rigidbody.fire("collisionstart",t))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(t){let e,s;this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;const i=this.dynamicsWorld.getGravity();i.x()===this._gravityFloat32[0]&&i.y()===this._gravityFloat32[1]&&i.z()===this._gravityFloat32[2]||(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const n=this._triggers;for(e=0,s=n.length;e<s;e++)n[e].updateTransform();const r=this._compounds;for(e=0,s=r.length;e<s;e++)r[e]._updateCompound();const a=this._kinematic;for(e=0,s=a.length;e<s;e++)a[e]._updateKinematic();this.dynamicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);const o=this._dynamic;for(e=0,s=o.length;e<s;e++)o[e]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),t)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),Ammo.destroy(mg),Ammo.destroy(_g),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null,mg=null,_g=null,fg.onAppDestroy())}}t_._buildAccessors(fg.prototype,Sg);class wg{constructor(t,e){this.effect=t,this.inputTarget=e,this.outputTarget=null,this.name=t.constructor.name}}class Tg{constructor(t,e){this.app=t,this.camera=e,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,e.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(t,e){const s=this.camera.rect,i=this.destinationRenderTarget,n=this.app.graphicsDevice,r=Math.floor(s.z*(i?.width??n.width)),a=Math.floor(s.w*(i?.height??n.height));return new dn(n,{name:e,format:t,width:r,height:a,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(t,e){const s=this.app.graphicsDevice,i=(this.destinationRenderTarget??s.backBuffer).isColorBufferSrgb(0),n=(e&&s.getRenderableHdrFormat([Ps,Ls],!0))??(i?Os:7),r=`${this.camera.entity.name}-posteffect-${this.effects.length}`,a=this._allocateColorBuffer(n,r);return new Hn({colorBuffer:a,depth:t,stencil:t&&this.app.graphicsDevice.supportsStencil,samples:t?s.samples:1})}_resizeOffscreenTarget(t){const e=t.colorBuffer.format,s=t.colorBuffer.name;t.destroyFrameBuffers(),t.destroyTextureBuffers(),t._colorBuffer=this._allocateColorBuffer(e,s),t._colorBuffers=[t._colorBuffer]}_destroyOffscreenTarget(t){t.destroyTextureBuffers(),t.destroy()}addEffect(t){const e=this.effects,s=0===e.length,i=this._createOffscreenTarget(s,t.hdr),n=new wg(t,i);e.push(n),this._sourceTarget=n.inputTarget,e.length>1&&(e[e.length-2].outputTarget=n.inputTarget),this._newPostEffect=t,t.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(t){let e=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===t){e=s;break}e>=0&&(e>0?this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[e].inputTarget),this.effects.splice(e,1)),this.enabled&&t.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){const e=this.effects[t].effect;this._newPostEffect!==e&&(e.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){const t=this.app.scene.layers.getLayerById(1);t&&(t.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const t=this.app.scene.layers.getLayerById(1);t&&(t.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let t=null;const e=this.effects.length;if(e)for(let s=0;s<e;s++){const i=this.effects[s];let n=i.outputTarget;s===e-1&&(t=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,t)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null)}_onCanvasResized(t,e){const s=this.camera.rect,i=this.destinationRenderTarget;t=i?.width??t,e=i?.height??e,this.camera.camera.aspectRatio=t*s.z/(e*s.w),this.resizeRenderTargets()}resizeRenderTargets(){const t=this.app.graphicsDevice,e=this.destinationRenderTarget,s=e?.width??t.width,i=e?.height??t.height,n=this.camera.rect,r=Math.floor(n.z*s),a=Math.floor(n.w*i),o=this.effects;for(let t=0,e=o.length;t<e;t++){const e=o[t];e.inputTarget.width===r&&e.inputTarget.height===a||this._resizeOffscreenTarget(e.inputTarget)}}onCameraRectChanged(t,e,s){this.enabled&&this.resizeRenderTargets()}}class Eg extends t_{constructor(t,e){super(t,e),this.onPostprocessing=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=4,this._camera=new mc,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._camera.node=e,this._postEffects=new Tg(t.app,this)}setShaderPass(t){const e=wh.get(this.system.app.graphicsDevice),s=t?e.allocate(t,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){return this._camera.shaderPassInfo?.name}set renderPasses(t){this._camera.renderPasses=t||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=!0}get renderPasses(){return this._camera.renderPasses}get shaderParams(){return this._camera.shaderParams}set gammaCorrection(t){this.camera.shaderParams.gammaCorrection=t}get gammaCorrection(){return this.camera.shaderParams.gammaCorrection}set toneMapping(t){this.camera.shaderParams.toneMapping=t}get toneMapping(){return this.camera.shaderParams.toneMapping}set fog(t){this._camera.fogParams=t}get fog(){return this._camera.fogParams}set aperture(t){this._camera.aperture=t}get aperture(){return this._camera.aperture}set aspectRatio(t){this._camera.aspectRatio=t}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(t){this._camera.aspectRatioMode=t}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(t){this._camera.calculateProjection=t}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(t){this._camera.calculateTransform=t}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(t){this._camera.clearColor=t}get clearColor(){return this._camera.clearColor}set clearColorBuffer(t){this._camera.clearColorBuffer=t,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(t){this._camera.clearDepthBuffer=t,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(t){this._camera.clearStencilBuffer=t,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(t){this._camera.cullFaces=t}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(t){this._disablePostEffectsLayer=t,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(t){this._camera.farClip=t}get farClip(){return this._camera.farClip}set flipFaces(t){this._camera.flipFaces=t}get flipFaces(){return this._camera.flipFaces}set fov(t){this._camera.fov=t}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(t){this._camera.frustumCulling=t}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(t){this._camera.horizontalFov=t}get horizontalFov(){return this._camera.horizontalFov}set layers(t){const e=this._camera.layers,s=this.system.app.scene;e.forEach((t=>{const e=s.layers.getLayerById(t);e?.removeCamera(this)})),this._camera.layers=t,this.enabled&&this.entity.enabled&&t.forEach((t=>{const e=s.layers.getLayerById(t);e?.addCamera(this)})),this.fire("set:layers")}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(t){this._camera.jitter=t}get jitter(){return this._camera.jitter}set nearClip(t){this._camera.nearClip=t}get nearClip(){return this._camera.nearClip}set orthoHeight(t){this._camera.orthoHeight=t}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(t){this._priority=t,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(t){this._camera.projection=t}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(t){this._camera.rect=t,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(t){t&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(t){t&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(t){this._camera.renderTarget=t,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(t){this._camera.scissorRect=t}get scissorRect(){return this._camera.scissorRect}set sensitivity(t){this._camera.sensitivity=t}get sensitivity(){return this._camera.sensitivity}set shutter(t){this._camera.shutter=t}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(t){if(this.layers.find((t=>1===t))){const e=this.system.app.scene.layers.getLayerById(1);t?e?.incrementCounter():e?.decrementCounter()}else if(t)return!1;return!0}requestSceneColorMap(t){this._renderSceneColorMap+=t?1:-1,this._enableDepthLayer(t),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap),this.system.app.scene.layers.markDirty()}requestSceneDepthMap(t){this._renderSceneDepthMap+=t?1:-1,this._enableDepthLayer(t),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap),this.system.app.scene.layers.markDirty()}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirty=!0}screenToWorld(t,e,s,i){const n=this.system.app.graphicsDevice,{width:r,height:a}=n.clientRect;return this._camera.screenToWorld(t,e,s,r,a,i)}worldToScreen(t,e){const s=this.system.app.graphicsDevice,{width:i,height:n}=s.clientRect;return this._camera.worldToScreen(t,i,n,e)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}removeCameraFromLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}}onLayersChanged(t,e){this.addCameraToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addCamera(this)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeCamera(this)}onEnable(){const t=this.system.app.scene,e=t.layers;this.system.addCamera(this),this._evtLayersChanged?.off(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=e.on("add",this.onLayerAdded,this),this._evtLayerRemoved?.off(),this._evtLayerRemoved=e.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const t=this.system.app.scene.layers;this.postEffects.disable(),this.removeCameraFromLayers(),this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.system.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(t){const e=this.system.app.graphicsDevice,s=t?t.width:e.width,i=t?t.height:e.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(t){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(t))}startXr(t,e,s){this.system.app.xr.start(this,t,e,s)}endXr(t){this._camera.xr?this._camera.xr.end(t):t&&t(new Error("Camera is not in XR"))}copy(t){this.aperture=t.aperture,this.aspectRatio=t.aspectRatio,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.disablePostEffectsLayer=t.disablePostEffectsLayer,this.farClip=t.farClip,this.flipFaces=t.flipFaces,this.fov=t.fov,this.frustumCulling=t.frustumCulling,this.horizontalFov=t.horizontalFov,this.layers=t.layers,this.nearClip=t.nearClip,this.orthoHeight=t.orthoHeight,this.priority=t.priority,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.sensitivity=t.sensitivity,this.shutter=t.shutter}}class Cg{constructor(){this.enabled=!0}}const Ag=["enabled"];class Dg extends e_{constructor(t){super(t),this.cameras=[],this.id="camera",this.ComponentType=Eg,this.DataType=Cg,this.schema=Ag,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this)}initializeComponentData(t,e,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fog","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(let i=0;i<s.length;i++){const n=s[i];if(e.hasOwnProperty(n)){const s=e[n];switch(n){case"rect":case"scissorRect":Array.isArray(s)?t[n]=new ls(s[0],s[1],s[2],s[3]):t[n]=s;break;case"clearColor":Array.isArray(s)?t[n]=new Ze(s[0],s[1],s[2],s[3]):t[n]=s;break;default:t[n]=s}}}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.camera;return this.addComponent(e,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter,gammaCorrection:s.gammaCorrection,toneMapping:s.toneMapping})}onBeforeRemove(t,e){this.removeCamera(e),e.onRemove()}onAppPrerender(){for(let t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onAppPrerender()}addCamera(t){this.cameras.push(t),Eu(this.cameras)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),Eu(this.cameras))}destroy(){this.app.off("prerender",this.onAppPrerender,this),super.destroy()}}t_._buildAccessors(Eg.prototype,Ag);class Pg{constructor(){this.enabled=!0,this.type="directional",this.color=new Ze(1,1,1),this.intensity=1,this.luminance=0,this.shape=0,this.affectSpecularity=!0,this.castShadows=!1,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=0,this.shadowType=0,this.vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=!0,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=2,this.mask=1,this.affectDynamic=!0,this.affectLightmapped=!1,this.bake=!1,this.bakeDir=!0,this.isStatic=!1,this.layers=[0],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16}}const Lg=Object.keys(new Pg);class Ig extends t_{get data(){const t=this.system.store[this.entity.getGuid()];return t?t.data:null}set enabled(t){this._setValue("enabled",t,(function(t,e){this.onSetEnabled(null,e,t)}))}get enabled(){return this.data.enabled}set light(t){this._setValue("light",t)}get light(){return this.data.light}set type(t){this._setValue("type",t,(function(t,e){this.system.changeType(this,e,t),this.refreshProperties()}))}get type(){return this.data.type}set color(t){this._setValue("color",t,(function(t,e){this.light.setColor(t)}),!0)}get color(){return this.data.color}set intensity(t){this._setValue("intensity",t,(function(t,e){this.light.intensity=t}))}get intensity(){return this.data.intensity}set luminance(t){this._setValue("luminance",t,(function(t,e){this.light.luminance=t}))}get luminance(){return this.data.luminance}set shape(t){this._setValue("shape",t,(function(t,e){this.light.shape=t}))}get shape(){return this.data.shape}set affectSpecularity(t){this._setValue("affectSpecularity",t,(function(t,e){this.light.affectSpecularity=t}))}get affectSpecularity(){return this.data.affectSpecularity}set castShadows(t){this._setValue("castShadows",t,(function(t,e){this.light.castShadows=t}))}get castShadows(){return this.data.castShadows}set shadowDistance(t){this._setValue("shadowDistance",t,(function(t,e){this.light.shadowDistance=t}))}get shadowDistance(){return this.data.shadowDistance}set shadowIntensity(t){this._setValue("shadowIntensity",t,(function(t,e){this.light.shadowIntensity=t}))}get shadowIntensity(){return this.data.shadowIntensity}set shadowResolution(t){this._setValue("shadowResolution",t,(function(t,e){this.light.shadowResolution=t}))}get shadowResolution(){return this.data.shadowResolution}set shadowBias(t){this._setValue("shadowBias",t,(function(t,e){this.light.shadowBias=-.01*Qe.clamp(t,0,1)}))}get shadowBias(){return this.data.shadowBias}set numCascades(t){this._setValue("numCascades",t,(function(t,e){this.light.numCascades=Qe.clamp(Math.floor(t),1,4)}))}get numCascades(){return this.data.numCascades}set cascadeBlend(t){this._setValue("cascadeBlend",t,(function(t,e){this.light.cascadeBlend=Qe.clamp(t,0,1)}))}get cascadeBlend(){return this.data.cascadeBlend}set bakeNumSamples(t){this._setValue("bakeNumSamples",t,(function(t,e){this.light.bakeNumSamples=Qe.clamp(Math.floor(t),1,255)}))}get bakeNumSamples(){return this.data.bakeNumSamples}set bakeArea(t){this._setValue("bakeArea",t,(function(t,e){this.light.bakeArea=Qe.clamp(t,0,180)}))}get bakeArea(){return this.data.bakeArea}set cascadeDistribution(t){this._setValue("cascadeDistribution",t,(function(t,e){this.light.cascadeDistribution=Qe.clamp(t,0,1)}))}get cascadeDistribution(){return this.data.cascadeDistribution}set normalOffsetBias(t){this._setValue("normalOffsetBias",t,(function(t,e){this.light.normalOffsetBias=Qe.clamp(t,0,1)}))}get normalOffsetBias(){return this.data.normalOffsetBias}set range(t){this._setValue("range",t,(function(t,e){this.light.attenuationEnd=t}))}get range(){return this.data.range}set innerConeAngle(t){this._setValue("innerConeAngle",t,(function(t,e){this.light.innerConeAngle=t}))}get innerConeAngle(){return this.data.innerConeAngle}set outerConeAngle(t){this._setValue("outerConeAngle",t,(function(t,e){this.light.outerConeAngle=t}))}get outerConeAngle(){return this.data.outerConeAngle}set falloffMode(t){this._setValue("falloffMode",t,(function(t,e){this.light.falloffMode=t}))}get falloffMode(){return this.data.falloffMode}set shadowType(t){this._setValue("shadowType",t,(function(t,e){this.light.shadowType=t}))}get shadowType(){return this.data.shadowType}set vsmBlurSize(t){this._setValue("vsmBlurSize",t,(function(t,e){this.light.vsmBlurSize=t}))}get vsmBlurSize(){return this.data.vsmBlurSize}set vsmBlurMode(t){this._setValue("vsmBlurMode",t,(function(t,e){this.light.vsmBlurMode=t}))}get vsmBlurMode(){return this.data.vsmBlurMode}set vsmBias(t){this._setValue("vsmBias",t,(function(t,e){this.light.vsmBias=Qe.clamp(t,0,1)}))}get vsmBias(){return this.data.vsmBias}set cookieAsset(t){this._setValue("cookieAsset",t,(function(t,e){if(!this._cookieAssetId||!(t instanceof pm&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof pm)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;const e=this.system.app.assets.get(t);e?this.onCookieAssetAdd(e):(this._cookieAssetAdd=!0,this.system.app.assets.on(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this))}}))}get cookieAsset(){return this.data.cookieAsset}set cookie(t){this._setValue("cookie",t,(function(t,e){this.light.cookie=t}))}get cookie(){return this.data.cookie}set cookieIntensity(t){this._setValue("cookieIntensity",t,(function(t,e){this.light.cookieIntensity=Qe.clamp(t,0,1)}))}get cookieIntensity(){return this.data.cookieIntensity}set cookieFalloff(t){this._setValue("cookieFalloff",t,(function(t,e){this.light.cookieFalloff=t}))}get cookieFalloff(){return this.data.cookieFalloff}set cookieChannel(t){this._setValue("cookieChannel",t,(function(t,e){this.light.cookieChannel=t}))}get cookieChannel(){return this.data.cookieChannel}set cookieAngle(t){this._setValue("cookieAngle",t,(function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new ls);let e=1,s=1;this.cookieScale&&(e=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(t*Qe.DEG_TO_RAD),n=Math.sin(t*Qe.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}))}get cookieAngle(){return this.data.cookieAngle}set cookieScale(t){this._setValue("cookieScale",t,(function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new ls);const e=t.x,s=t.y,i=Math.cos(this.cookieAngle*Qe.DEG_TO_RAD),n=Math.sin(this.cookieAngle*Qe.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0)}get cookieScale(){return this.data.cookieScale}set cookieOffset(t){this._setValue("cookieOffset",t,(function(t,e){this.light.cookieOffset=t}),!0)}get cookieOffset(){return this.data.cookieOffset}set shadowUpdateMode(t){this._setValue("shadowUpdateMode",t,(function(t,e){this.light.shadowUpdateMode=t}),!0)}get shadowUpdateMode(){return this.data.shadowUpdateMode}set mask(t){this._setValue("mask",t,(function(t,e){this.light.mask=t}))}get mask(){return this.data.mask}set affectDynamic(t){this._setValue("affectDynamic",t,(function(t,e){t?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()}))}get affectDynamic(){return this.data.affectDynamic}set affectLightmapped(t){this._setValue("affectLightmapped",t,(function(t,e){t?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))}))}get affectLightmapped(){return this.data.affectLightmapped}set bake(t){this._setValue("bake",t,(function(t,e){t?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()}))}get bake(){return this.data.bake}set bakeDir(t){this._setValue("bakeDir",t,(function(t,e){this.light.bakeDir=t}))}get bakeDir(){return this.data.bakeDir}set isStatic(t){this._setValue("isStatic",t,(function(t,e){this.light.isStatic=t}))}get isStatic(){return this.data.isStatic}set layers(t){this._setValue("layers",t,(function(t,e){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&(s.removeLight(this),this.light.removeLayer(s))}for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&(this.enabled&&this.entity.enabled&&(s.addLight(this),this.light.addLayer(s)))}}))}get layers(){return this.data.layers}set shadowUpdateOverrides(t){this.light.shadowUpdateOverrides=t}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set shadowSamples(t){this.light.shadowSamples=t}get shadowSamples(){return this.light.shadowSamples}set shadowBlockerSamples(t){this.light.shadowBlockerSamples=t}get shadowBlockerSamples(){return this.light.shadowBlockerSamples}set penumbraSize(t){this.light.penumbraSize=t}get penumbraSize(){return this.light.penumbraSize}set penumbraFalloff(t){this.light.penumbraFalloff=t}get penumbraFalloff(){return this.light.penumbraFalloff}_setValue(t,e,s,i){const n=this.data,r=n[t];(i||r!==e)&&(n[t]=e,s&&s.call(this,e,r))}addLightToLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&(e.addLight(this),this.light.addLayer(e))}}removeLightFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&(e.removeLight(this),this.light.removeLayer(e))}}onLayersChanged(t,e){this.enabled&&this.entity.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)>=0&&this.enabled&&this.entity.enabled&&(t.addLight(this),this.light.addLayer(t))}onLayerRemoved(t){this.layers.indexOf(t.id)>=0&&(t.removeLight(this),this.light.removeLayer(t))}refreshProperties(){for(let t=0;t<Lg.length;t++){const e=Lg[t];this[e]=this[e]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){let t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){const t=this.system.app.scene,e=t.layers;this.light.enabled=!0,this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),e&&(this._evtLayerAdded=e.on("add",this.onLayerAdded,this),this._evtLayerRemoved=e.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){const t=this.system.app.scene.layers;this.light.enabled=!1,this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}constructor(...t){super(...t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}}class Rg extends e_{constructor(t){super(t),this.id="light",this.ComponentType=Ig,this.DataType=Pg,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e){const s={...e};s.type||(s.type=t.data.type),t.data.type=s.type,s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0)),s.color&&Array.isArray(s.color)&&(s.color=new Ze(s.color[0],s.color[1],s.color[2])),s.cookieOffset&&s.cookieOffset instanceof Array&&(s.cookieOffset=new os(s.cookieOffset[0],s.cookieOffset[1])),s.cookieScale&&s.cookieScale instanceof Array&&(s.cookieScale=new os(s.cookieScale[0],s.cookieScale[1])),s.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),s.enabled=s.enable),s.shape||(s.shape=0);const i=new Fu(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);i.type=Iu[s.type],i._node=t.entity,t.data.light=i,super.initializeComponentData(t,s,Lg)}_onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.light,i=[];let n;for(let t=0;t<Lg.length;t++)n=Lg[t],"light"!==n&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);return this.addComponent(e,i)}changeType(t,e,s){e!==s&&(t.light.type=Iu[s])}}const Mg=["x","y","z","w"],kg=[void 0,void 0,os,rs,ls];function Og(t,e,s,i){switch(e.type){case"boolean":return!!s;case"number":if("number"==typeof s)return s;if("string"==typeof s){const t=parseInt(s,10);return isNaN(t)?null:t}return"boolean"==typeof s?0+s:null;case"json":{const i={};if(Array.isArray(e.schema)){s&&"object"==typeof s||(s={});for(let n=0;n<e.schema.length;n++){const r=e.schema[n];if(r.name)if(r.array){i[r.name]=[];const e=Array.isArray(s[r.name])?s[r.name]:[];for(let s=0;s<e.length;s++)i[r.name].push(Og(t,r,e[s]))}else{const e=s.hasOwnProperty(r.name)?s[r.name]:r.default;i[r.name]=Og(t,r,e)}}}return i}case"asset":return s instanceof pm?s:"number"==typeof s?t.assets.get(s)||null:"string"==typeof s&&t.assets.get(parseInt(s,10))||null;case"entity":return s instanceof Mc?s:"string"==typeof s?t.getEntityFromIndex(s):null;case"rgb":case"rgba":if(s instanceof Ze)return i instanceof Ze?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length>=3&&s.length<=4){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;return i||(i=new Ze),i.r=s[0],i.g=s[1],i.b=s[2],i.a=3===s.length?1:s[3],i}return"string"==typeof s&&/#(?:[0-9a-f]{2}){3,4}/i.test(s)?(i||(i=new Ze),i.fromString(s),i):null;case"vec2":case"vec3":case"vec4":{const t=parseInt(e.type.slice(3),10),n=kg[t];if(s instanceof n)return i instanceof n?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length===t){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;i||(i=new n);for(let e=0;e<t;e++)i[Mg[e]]=s[e];return i}return null}case"curve":if(s){let t;if(s instanceof ts||s instanceof es)t=s.clone();else{t=new(s.keys[0]instanceof Array?es:ts)(s.keys),t.type=s.type}return t}}return s}function Fg(t,e,s,i){return e.array?s.map(((s,n)=>Og(t,e,s,i?i[n]:null))):Og(t,e,s,i)}function Ng(t,e,s,i){if(s)for(const n in e){const r=e[n],a=s[n];void 0!==a&&(i[n]=Fg(t,r,a,i[n]))}}class Bg{static{this.assignAttributesToScript=Ng}static{this.attributeToValue=Fg}constructor(t){this.scriptType=t,this.index={}}static{this.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"])}add(t,e){this.index[t]||Bg.reservedNames.has(t)||(this.index[t]=e,Object.defineProperty(this.scriptType.prototype,t,{get:function(){return this.__attributes[t]},set:function(s){const i="attr",n=`attr:${t}`,r=this.__attributes[t];let a=r;if(r&&"json"!==e.type&&"entity"!==e.type&&r.clone&&(this.hasEvent(i)||this.hasEvent(n))&&(a=r.clone()),e.array){if(this.__attributes[t]=[],s)for(let i=0,n=s.length;i<n;i++)this.__attributes[t].push(Og(this.app,e,s[i],r?r[i]:null))}else this.__attributes[t]=Og(this.app,e,s,r);this.fire(i,t,this.__attributes[t],a),this.fire(n,this.__attributes[t],a)}}))}remove(t){return!!this.index[t]&&(delete this.index[t],delete this.scriptType.prototype[t],!0)}has(t){return!!this.index[t]}get(t){return this.index[t]||null}}const Ug="initialize",zg="postInitialize";class Vg extends Ve{static{this.EVENT_ENABLE="enable"}static{this.EVENT_DISABLE="disable"}static{this.EVENT_STATE="state"}static{this.EVENT_DESTROY="destroy"}static{this.EVENT_ATTR="attr"}static{this.EVENT_ERROR="error"}constructor(t){super(),this.initScript(t)}set enabled(t){this._enabled=!!t,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,Ug)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,zg)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScript(t){const e=this.constructor;this.app=t.app,this.entity=t.entity,this._enabled="boolean"!=typeof t.enabled||t.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__scriptType=e,this.__executionOrder=-1}static{this.__name=null}static{this.__getScriptName=Gg}static get scriptName(){return this.__name}}const Hg=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/;function Gg(t){if("function"!=typeof t)return;if(t.scriptName)return t.scriptName;if("name"in Function.prototype)return t.name;if(t===Function||t===Function.prototype.constructor)return"Function";const e=`${t}`.match(Hg);return e?e[1]:void 0}class Wg extends Vg{constructor(t){super(t),this.initScriptType(t)}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new Bg(this)),this.__attributes}initScript(t){Vg.prototype.initScript.call(this,t),this.__attributes={},this.__attributesRaw=t.attributes||{}}initScriptType(t){this.initScript(t)}__initializeAttributes(t){if(t||this.__attributesRaw){for(const t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(t){for(const e in t)t.hasOwnProperty(e)&&(this.prototype[e]=t[e])}}class jg extends t_{static{this.EVENT_CREATE="create"}static{this.EVENT_DESTROY="destroy"}static{this.EVENT_ENABLE="enable"}static{this.EVENT_DISABLE="disable"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_STATE="state"}static{this.EVENT_MOVE="move"}static{this.EVENT_ERROR="error"}constructor(t,e){super(t,e),this._attributeDataMap=new Map,this._scripts=[],this._updateList=new je({sortBy:"__executionOrder"}),this._postUpdateList=new je({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(t){this._scriptsData=t;for(const e in t){if(!t.hasOwnProperty(e))continue;const s=this._scriptsIndex[e];if(s){if("boolean"==typeof t[e].enabled&&(s.once("preInitialize",(()=>{this.initializeAttributes(s)})),s.enabled=!!t[e].enabled),"object"==typeof t[e].attributes)for(const i in t[e].attributes)if(!Bg.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const t=this.system.app.scripts.get(e);t&&t.attributes.add(i,{})}s[i]=t[e].attributes[i]}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(t){const e=this._enabled;this._enabled=t,this.fire("set","enabled",e,t)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const t=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e._initialized&&!e._postInitialized&&e.enabled&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,zg))}this._endLooping(t)}_beginLooping(){const t=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,t}_endLooping(t){this._isLoopingThroughScripts=t,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(t,e,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const e=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e.once("preInitialize",(()=>{this.initializeAttributes(e)})),e.enabled=e._enabled}this._endLooping(e)}_onBeforeRemove(){this.fire("remove");const t=this._beginLooping();for(let t=0;t<this.scripts.length;t++){const e=this.scripts[t];e&&this.destroy(e.__scriptType.__name)}this._endLooping(t)}_removeDestroyedScripts(){const t=this._destroyedScripts.length;if(t){for(let e=0;e<t;e++){const t=this._destroyedScripts[e];this._removeScriptInstance(t)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];this.initializeAttributes(e)}}initializeAttributes(t){if(t instanceof Wg)t.__initializeAttributes();else{const e=t.__scriptType.__name,s=this._attributeDataMap.get(e);if(!s)return;const i=this.system.app.scripts?.getSchema(e);Ng(this.system.app,i.attributes,s,t)}}_scriptMethod(t,e,s){t[e](s)}_onInitialize(){const t=this._scripts,e=this._beginLooping();for(let e=0,s=t.length;e<s;e++){const s=t[e];!s._initialized&&s.enabled&&(s._initialized=!0,s.initialize&&this._scriptMethod(s,Ug))}this._endLooping(e)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(t){const e=this._updateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,"update",t)}this._endLooping(s)}_onPostUpdate(t){const e=this._postUpdateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,"postUpdate",t)}this._endLooping(s)}_insertScriptInstance(t,e,s){-1===e?(this._scripts.push(t),t.__executionOrder=s,t.update&&this._updateList.append(t),t.postUpdate&&this._postUpdateList.append(t)):(this._scripts.splice(e,0,t),t.__executionOrder=e,this._resetExecutionOrder(e+1,s+1),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t))}_removeScriptInstance(t){const e=this._scripts.indexOf(t);return-1===e||(this._scripts.splice(e,1),t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t)),e}_resetExecutionOrder(t,e){for(let s=t;s<e;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(t,e,s,i,n,r){if(t.array){const t=s.length;if(!t)return;const a=s.slice();for(let e=0;e<t;e++){const t=a[e]instanceof Im?a[e].getGuid():a[e];r[t]&&(a[e]=i?r[t].getGuid():r[t])}n[e]=a}else{if(s instanceof Im)s=s.getGuid();else if("string"!=typeof s)return;r[s]&&(n[e]=r[s])}}has(t){if("string"==typeof t)return!!this._scriptsIndex[t];if(!t)return!1;const e=t,s=e.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof e}get(t){if("string"==typeof t){const e=this._scriptsIndex[t];return e?e.instance:null}if(!t)return null;const e=t,s=e.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof e?n:null}create(t,e={}){const s=this;let i=t,n=t;if("string"==typeof i)i=this.system.app.scripts.get(i);else if(i){const t=Gg(i),e=(r=t)[0].toLowerCase()+r.substring(1);i.__name??=i.scriptName??e,n=i.__name}var r;if(i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const t=new i({app:this.system.app,entity:this.entity,enabled:!e.hasOwnProperty("enabled")||e.enabled,attributes:e.attributes||{}});e.properties&&"object"==typeof e.properties&&Object.assign(t,e.properties),t instanceof Wg||this._attributeDataMap.set(n,e.attributes);const r=this._scripts.length;let a=-1;return"number"==typeof e.ind&&-1!==e.ind&&r>e.ind&&(a=e.ind),this._insertScriptInstance(t,a,r),this._scriptsIndex[n]={instance:t,onSwap:function(){s.swap(n)}},this[n]=t,e.preloading||this.initializeAttributes(t),this.fire("create",n,t),this.fire(`create:${n}`,t),this.system.app.scripts.on(`swap:${n}`,this._scriptsIndex[n].onSwap),e.preloading||(t.enabled&&!t._initialized&&(t._initialized=!0,t.initialize&&this._scriptMethod(t,Ug)),t.enabled&&!t._postInitialized&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,zg))),t}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null}destroy(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(delete this._scriptsIndex[e],!i)return!1;this._attributeDataMap.delete(e);const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const t=this._removeScriptInstance(n);t>=0&&this._resetExecutionOrder(t,this._scripts.length)}return this.system.app.scripts.off(`swap:${e}`,i.onSwap),delete this[e],this.fire("destroy",e,n||null),this.fire(`destroy:${e}`,n||null),n&&n.fire("destroy"),!0}swap(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(!i||!i.instance)return!1;const n=i.instance,r=this._scripts.indexOf(n),a=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return!!a.swap&&(this.initializeAttributes(a),this._scripts[r]=a,this._scriptsIndex[e].instance=a,this[e]=a,a.__executionOrder=r,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a),this._scriptMethod(a,"swap",n),this.fire("swap",e,a),this.fire(`swap:${e}`,a),!0)}resolveDuplicatedEntityReferenceProperties(t,e){const s=this.entity.script;for(const i in t._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const r=t._scriptsIndex[i];if(!r||!r.instance)continue;const a=s[i].__attributesRaw??s._attributeDataMap.get(i),o=s[i].__attributes;if(!a&&!o)continue;const l=!!a,h=r.instance.__attributes??s._attributeDataMap.get(i);for(const t in h){if(!h[t])continue;const s=n.attributes?.get(t)??this.system.app.scripts.getSchema(i)?.attributes?.[t];if(s)if("entity"===s.type)this._resolveEntityScriptAttribute(s,t,h[t],l,a||o,e);else if("json"===s.type&&Array.isArray(s.schema)){const i=h[t],n=a?a[t]:o[t];for(let t=0;t<s.schema.length;t++){const r=s.schema[t];if("entity"===r.type)if(s.array)for(let t=0;t<i.length;t++)this._resolveEntityScriptAttribute(r,r.name,i[t][r.name],l,n[t],e);else this._resolveEntityScriptAttribute(r,r.name,i[r.name],l,n,e)}}}}}move(t,e){const s=this._scripts.length;if(e>=s||e<0)return!1;let i=t,n=t;"string"!=typeof n?n=t.__name:i=null;const r=this._scriptsIndex[n];if(!r||!r.instance)return!1;const a=r.instance;if(i&&!(a instanceof i))return!1;const o=this._scripts.indexOf(a);return-1!==o&&o!==e&&(this._scripts.splice(e,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,a,e,o),this.fire(`move:${n}`,a,e,o),!0)}}class Xg{constructor(){this.enabled=!0}}let $g=0;class qg extends e_{constructor(t){super(t),this.id="script",this.ComponentType=jg,this.DataType=Xg,this._components=new je({sortBy:"_executionOrder"}),this._enabledComponents=new je({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e){if(t._executionOrder=$g++,this._components.append(t),$g>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,t.enabled&&t.entity.enabled&&this._enabledComponents.append(t),e.hasOwnProperty("order")&&e.hasOwnProperty("scripts")){t._scriptsData=e.scripts;for(let s=0;s<e.order.length;s++)t.create(e.order[s],{enabled:e.scripts[e.order[s]].enabled,attributes:e.scripts[e.order[s]].attributes,preloading:this.preloading})}}cloneComponent(t,e){const s=[],i={};for(let e=0;e<t.script._scripts.length;e++){const n=t.script._scripts[e],r=n.__scriptType.__name;s.push(r);const a=t.script._attributeDataMap?.get(r)||{};for(const t in n.__attributes)a[t]=n.__attributes[t];i[r]={enabled:n._enabled,attributes:a}}for(const e in t.script._scriptsIndex)e.awaiting&&s.splice(e.ind,0,e);const n={enabled:t.script.enabled,order:s,scripts:i};return this.addComponent(e,n)}_resetExecutionOrder(){$g=0;for(let t=0,e=this._components.length;t<e;t++)this._components.items[t]._executionOrder=$g++}_callComponentMethod(t,e,s){for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)t.items[t.loopIndex][e](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")}_onUpdate(t){this._callComponentMethod(this._enabledComponents,"_onUpdate",t)}_onPostUpdate(t){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",t)}_addComponentToEnabled(t){this._enabledComponents.insert(t)}_removeComponentFromEnabled(t){this._enabledComponents.remove(t)}_onBeforeRemove(t,e){this._components.items.indexOf(e)>=0&&e._onBeforeRemove(),this._removeComponentFromEnabled(e),this._components.remove(e)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}class Kg extends t_{constructor(t,e){super(t,e),this._layers=[0],this._instance=null,this._materialTmp=null,this._highQualitySH=!0,this._customAabb=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._castShadows=!1,this._assetReference=new J_("asset",this,t.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set customAabb(t){this._customAabb=t,this._instance?.meshInstance?.setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set instance(t){if(this.destroyInstance(),this._instance=t,this._instance){const t=this._instance.meshInstance;t.node||(t.node=this.entity),t.castShadow=this._castShadows,t.setCustomAabb(this._customAabb),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set material(t){this._instance?this._instance.material=t:this._materialTmp=t}get material(){return this._instance?.material??this._materialTmp??null}set highQualitySH(t){t!==this._highQualitySH&&(this._highQualitySH=t,this._instance&&this._instance.setHighQualitySH(t))}get highQualitySH(){return this._highQualitySH}set castShadows(t){if(this._castShadows!==t){const e=this.instance?.meshInstance;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=i.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters([e])}if(e.castShadow=t,!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters([e])}}this._castShadows=t}}get castShadows(){return this._castShadows}set layers(t){this.removeFromLayers(),this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];this.enabled&&this.entity.enabled&&this.addToLayers()}get layers(){return this._layers}set asset(t){const e=t instanceof pm?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}destroyInstance(){this._instance&&(this.removeFromLayers(),this._instance?.destroy(),this._instance=null)}addToLayers(){const t=this.instance?.meshInstance;if(t){const e=this.system.app.scene.layers;for(let s=0;s<this._layers.length;s++)e.getLayerById(this._layers[s])?.addMeshInstances([t])}}removeFromLayers(){const t=this.instance?.meshInstance;if(t){const e=this.system.app.scene.layers;for(let s=0;s<this._layers.length;s++)e.getLayerById(this._layers[s])?.removeMeshInstances([t])}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||this._instance&&t.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||this._instance&&t.removeMeshInstances(this._instance.meshInstance)}onEnable(){const t=this.system.app.scene,e=t.layers;this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),e&&(this._evtLayerAdded=e.on("add",this.onLayerAdded,this),this._evtLayerRemoved=e.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){const t=this.system.app.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();const t=this._assetReference.asset;t&&(this.instance=new Wp(t.resource,{material:this._materialTmp,highQualitySH:this._highQualitySH}),this._materialTmp=null,this.customAabb=this.instance.resource.aabb.clone())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}}class Yg{constructor(){this.enabled=!0}}const Qg=["enabled"],Zg=["castShadows","material","highQualitySH","asset","layers"];class Jg extends e_{constructor(t){super(t),this.id="gsplat",this.ComponentType=Kg,this.DataType=Yg,this.schema=Qg,this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let s=0;s<Zg.length;s++)e.hasOwnProperty(Zg[s])&&(t[Zg[s]]=e[Zg[s]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new Ss(new rs(e.aabbCenter),new rs(e.aabbHalfExtents))),super.initializeComponentData(t,e,Qg)}cloneComponent(t,e){const s=t.gsplat,i={};Zg.forEach((t=>{i[t]="material"===t?s[t].clone():s[t]})),i.enabled=s.enabled;const n=this.addComponent(e,i);return s.customAabb&&(n.customAabb=s.customAabb.clone()),n}onRemove(t,e){e.onRemove()}}t_._buildAccessors(Kg.prototype,Qg);class tv extends Ve{static{this.EVENT_SETMESHES="set:meshes"}set meshes(t){this.decRefMeshes(),this._meshes=t,this.incRefMeshes(),this.fire("set:meshes",t)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){this._meshes?.forEach(((t,e)=>{t&&(t.decRefCount(),t.refCount<1&&(t.destroy(),this._meshes[e]=null))}))}incRefMeshes(){this._meshes?.forEach((t=>{t?.incRefCount()}))}constructor(...t){super(...t),this._meshes=null}}function ev(t){const e=this;if(!e.resource)return;const s=t.resource,i=s.renders&&s.renders[e.data.renderIndex];i&&(e.resource.meshes=i.resource.meshes)}function sv(t){const e=this;e.registry.off(`load:${t.id}`,ev,e),e.registry.on(`load:${t.id}`,ev,e),e.registry.off(`remove:${t.id}`,iv,e),e.registry.once(`remove:${t.id}`,iv,e),t.resource?ev.call(e,t):e.registry.load(t)}function iv(t){const e=this;e.registry.off(`load:${t.id}`,ev,e),e.resource&&e.resource.destroy()}class nv extends Sm{constructor(t){super(t,"render"),this._registry=t.assets}open(t,e){return new tv}patch(t,e){if(!t.data.containerAsset)return;const s=e.get(t.data.containerAsset);s?sv.call(t,s):e.once(`add:${t.data.containerAsset}`,sv,t)}}class rv{constructor(t,e,s,i){this._paths=t,this._input=e,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class av{constructor(t,e){this._components=t,this._data=e}get components(){return this._components}get data(){return this._data}}function ov(t,e){let s;const i=(t,e)=>{switch(e){case s.DT_INT8:return new Int8Array(t.buffer,t.byteOffset,t.byteLength);case s.DT_INT16:return new Int16Array(t.buffer,t.byteOffset,t.byteLength/2);case s.DT_INT32:return new Int32Array(t.buffer,t.byteOffset,t.byteLength/4);case s.DT_UINT8:return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);case s.DT_UINT16:return new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2);case s.DT_UINT32:return new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4);case s.DT_FLOAT32:return new Float32Array(t.buffer,t.byteOffset,t.byteLength/4)}return null},n=t=>t.num_components()*(t=>{switch(t){case s.DT_INT8:return 1;case s.DT_INT16:return 2;case s.DT_INT32:return 4;case s.DT_UINT8:return 1;case s.DT_UINT16:return 2;case s.DT_UINT32:case s.DT_FLOAT32:return 4}return 1})(t.data_type()),r={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},a=(t,e)=>{const s=(t,e,s)=>{t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2]},i=(t,e,s)=>{t[0]=e[1]*s[2]-s[1]*e[2],t[1]=e[2]*s[0]-s[2]*e[0],t[2]=e[0]*s[1]-s[0]*e[1]},n=(t,e)=>{const s=t[e+0],i=t[e+1],n=t[e+2],r=1/Math.sqrt(s*s+i*i+n*n);t[e+0]*=r,t[e+1]*=r,t[e+2]*=r},r=(t,e,s)=>{for(let i=0;i<3;++i)t[i]=e[s+i]},a=e.length/3,o=t.length/3,l=new Float32Array(t.length),h=[0,0,0],c=[0,0,0],d=[0,0,0],u=[0,0,0],f=[0,0,0],p=[0,0,0];for(let o=0;o<a;++o){const a=3*e[3*o+0],m=3*e[3*o+1],_=3*e[3*o+2];r(h,t,a),r(c,t,m),r(d,t,_),s(u,c,h),s(f,d,h),i(p,u,f),n(p,0);for(let t=0;t<3;++t)l[a+t]+=p[t],l[m+t]+=p[t],l[_+t]+=p[t]}for(let t=0;t<o;++t)n(l,3*t);return new Uint8Array(l.buffer)},o=t=>{const e=(t=>{const e={},o=new s.DecoderBuffer;o.Init(t,t.length);const l=new s.Decoder;if(l.GetEncodedGeometryType(o)!==s.TRIANGULAR_MESH)return e.error="Failed to decode draco mesh: not a mesh",e;const h=new s.Mesh,c=l.DecodeBufferToMesh(o,h);if(!c||!c.ok()||0===s.getPointer(h))return e.error="Failed to decode draco asset",e;const d=3*h.num_faces(),u=h.num_points()<=65535,f=d*(u?2:4),p=s._malloc(f);u?(l.GetTrianglesUInt16Array(h,f,p),e.indices=new Uint16Array(s.HEAPU16.buffer,p,d).slice().buffer):(l.GetTrianglesUInt32Array(h,f,p),e.indices=new Uint32Array(s.HEAPU32.buffer,p,d).slice().buffer),s._free(p);const m=[];for(let t=0;t<h.num_attributes();++t)m.push(l.GetAttribute(h,t));m.sort(((t,e)=>(r[t.attribute_type()]??r.length)-(r[e.attribute_type()]??r.length))),e.attributes=m.map((t=>t.unique_id()));let _=0;const g=m.map((t=>{const e=_;return _+=4*Math.ceil(n(t)/4),e})),v=m.some((t=>1===t.attribute_type())),b=g[1];if(!v){for(let t=1;t<g.length;++t)g[t]+=12;_+=12}e.vertices=new ArrayBuffer(h.num_points()*_);const y=new Uint8Array(e.vertices);for(let t=0;t<h.num_attributes();++t){const r=m[t],o=n(r),c=h.num_points()*o,d=s._malloc(c);l.GetAttributeDataArrayForAllPoints(h,r,r.data_type(),c,d);const f=new Uint8Array(s.HEAPU8.buffer,d,c);for(let e=0;e<h.num_points();++e)for(let s=0;s<o;++s)y[e*_+g[t]+s]=f[e*o+s];if(!v&&0===r.attribute_type()){const t=a(i(f,r.data_type()),u?new Uint16Array(e.indices):new Uint32Array(e.indices));for(let e=0;e<h.num_points();++e)for(let s=0;s<12;++s)y[e*_+b+s]=t[12*e+s]}s._free(d)}return s.destroy(h),s.destroy(l),s.destroy(o),e})(new Uint8Array(t.buffer));self.postMessage({jobId:t.jobId,error:e.error,indices:e.indices,vertices:e.vertices,attributes:e.attributes},[e.indices,e.vertices].filter((t=>null!=t)))},l=[];self.onmessage=t=>{const e=t.data;switch(e.type){case"init":self.DracoDecoderModule({instantiateWasm:(t,s)=>(WebAssembly.instantiate(e.module,t).then((t=>s(t))).catch((t=>console.error(`instantiate failed + ${t}`))),{})}).then((t=>{s=t,l.forEach((t=>o(t)))}));break;case"decodeMesh":s?o(e):l.push(e)}}}class lv{constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(t,e)=>{t.postMessage({type:"decodeMesh",jobId:e.jobId,buffer:e.buffer},[e.buffer])}}init(t){for(t.forEach((t=>{t.addEventListener("message",(e=>{const s=e.data,i=this.jobCallbacks.get(s.jobId);if(i&&i(s.error,{indices:s.indices,vertices:s.vertices,attributes:s.attributes}),this.jobCallbacks.delete(s.jobId),this.jobQueue.length>0){const e=this.jobQueue.shift();this.run(t,e)}else{const e=this.workers[2].indexOf(t);if(-1!==e)this.workers[2].splice(e,1),this.workers[1].push(t);else{const e=this.workers[1].indexOf(t);-1!==e&&(this.workers[1].splice(e,1),this.workers[0].push(t))}}}))})),this.workers[0]=t;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){const t=this.jobQueue.shift();if(this.workers[0].length>0){const e=this.workers[0].shift();this.workers[1].push(e),this.run(e,t)}else{const e=this.workers[1].shift();this.workers[2].push(e),this.run(e,t)}}}enqueueJob(t,e){const s={jobId:this.jobId++,buffer:t};if(this.jobCallbacks.set(s.jobId,e),this.workers[0].length>0){const t=this.workers[0].shift();this.workers[1].push(t),this.run(t,s)}else if(this.workers[1].length>0){const t=this.workers[1].shift();this.workers[2].push(t),this.run(t,s)}else this.jobQueue.push(s)}}const hv=t=>{const e=()=>fetch(t).then((t=>t.arrayBuffer())).then((t=>WebAssembly.compile(t)));return WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(t)).catch((t=>e())):e()};let cv;const dv=(t,e)=>!!(t=>{if(cv)return!0;if(!t){const e=Ge.getConfig("DracoDecoderModule");t=e?{jsUrl:e.glueUrl,wasmUrl:e.wasmUrl,numWorkers:e.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1}}return!(!t.jsUrl||!t.wasmUrl||(cv=new lv,Promise.all([(e=t.jsUrl,new Promise(((t,s)=>{const i={cache:!0,responseType:"text",retry:!0,maxRetries:3};tl.get(e,i,((e,i)=>{e?s(e):t(i)}))}))),hv(t.wasmUrl)]).then((([e,s])=>{const i=["/* draco */",e,"/* worker */",`(\n${ov.toString()}\n)()\n\n`].join("\n"),n=new Blob([i],{type:"application/javascript"}),r=URL.createObjectURL(n),a=Math.max(1,Math.min(16,t.numWorkers||1)),o=[];for(let t=0;t<a;++t){const t=new Worker(r);t.postMessage({type:"init",module:s}),o.push(t)}cv.init(o)})),0));var e})()&&(cv.enqueueJob(t,e),!0);class uv{destroy(){this.renders&&this.renders.forEach((t=>{t.meshes=null}))}}const fv=t=>/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(t),pv=t=>{switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},mv=t=>{switch(t){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},_v=t=>{switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},gv={POSITION:$s,NORMAL:qs,TANGENT:Ks,COLOR_0:Zs,JOINTS_0:Qs,WEIGHTS_0:Ys,TEXCOORD_0:ti,TEXCOORD_1:ei,TEXCOORD_2:si,TEXCOORD_3:ii,TEXCOORD_4:ni,TEXCOORD_5:ri,TEXCOORD_6:ai,TEXCOORD_7:oi},vv={[$s]:0,[qs]:1,[Ks]:2,[Zs]:3,[Qs]:4,[Ys]:5,[ti]:6,[ei]:7,[si]:8,[ii]:9,[ni]:10,[ri]:11,[ai]:12,[oi]:13},bv=(t,e,s)=>{const i=(t=>{switch(t){case 0:return t=>Math.max(t/127,-1);case 1:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})(s),n=e.length;for(let s=0;s<n;++s)t[s]=i(e[s]);return t},yv=(t,e,s=!1)=>{const i=pv(t.type),n=(t=>{switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}})(t.componentType);if(!n)return null;let r;if(t.sparse){const s=t.sparse,a={count:s.count,type:"SCALAR"},o=yv(Object.assign(a,s.indices),e,!0),l={count:s.count,type:t.type,componentType:t.componentType},h=yv(Object.assign(l,s.values),e,!0);if(t.hasOwnProperty("bufferView")){const s={bufferView:t.bufferView,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type};r=yv(s,e,!0).slice()}else r=new n(t.count*i);for(let t=0;t<s.count;++t){const e=o[t];for(let s=0;s<i;++s)r[e*i+s]=h[t*i+s]}}else if(t.hasOwnProperty("bufferView")){const a=e[t.bufferView];if(s&&a.hasOwnProperty("byteStride")){const e=i*n.BYTES_PER_ELEMENT,s=new ArrayBuffer(t.count*e),o=new Uint8Array(s);let l=0;for(let s=0;s<t.count;++s){let i=(t.byteOffset||0)+s*a.byteStride;for(let t=0;t<e;++t)o[l++]=a[i++]}r=new n(s)}else r=new n(a.buffer,a.byteOffset+(t.byteOffset||0),t.count*i)}else r=new n(t.count*i);return r},Sv=(t,e)=>{const s=yv(t,e,!0);if(s instanceof Float32Array||!t.normalized)return s;const i=new Float32Array(s.length);return bv(i,s,mv(t.componentType)),i},xv=t=>{let e=t.min,s=t.max;if(!e||!s)return null;if(t.normalized){const i=mv(t.componentType);e=bv([],e,i),s=bv([],s,i)}return new Ss(new rs(.5*(s[0]+e[0]),.5*(s[1]+e[1]),.5*(s[2]+e[2])),new rs(.5*(s[0]-e[0]),.5*(s[1]-e[1]),.5*(s[2]-e[2])))},wv=t=>{if(!t.hasOwnProperty("mode"))return 4;switch(t.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}},Tv=(t,e)=>{const s=t[$s];if(!s||3!==s.components)return;let i;if(s.size!==s.stride){const t=s.stride/Ki[s.type],e=new qi[s.type](s.buffer,s.offset,s.count*t);i=new qi[s.type](3*s.count);for(let n=0;n<s.count;++n)i[3*n+0]=e[n*t+0],i[3*n+1]=e[n*t+1],i[3*n+2]=e[n*t+2]}else i=new qi[s.type](s.buffer,s.offset,3*s.count);const n=s.count;e||(e=(t=>{const e=new Uint16Array(t);for(let s=0;s<t;s++)e[s]=s;return e})(n));const r=$u(i,e),a=new Float32Array(r.length);a.set(r),t[qs]={buffer:a.buffer,size:12,offset:0,stride:12,count:n,components:3,type:6}},Ev=t=>{const e=new pm(`${t.name}_clone`,t.type,t.file,t.data,t.options);return e.loaded=!0,e.resource=(t=>{const e=new dn(t.device,t);return e._levels=(t=>{const e=[];for(let s=0;s<t._levels.length;++s){let i=[];if(t.cubemap)for(let e=0;e<6;++e)i.push(t._levels[s][e]);else i=t._levels[s];e.push(i)}return e})(t),e})(t.resource),t.registry.add(e),e},Cv=(t,e,s,i,n,r)=>{const a={},o=[];for(const t in e)e.hasOwnProperty(t)&&gv.hasOwnProperty(t)&&(a[t]=e[t],o.push(`${t}:${e[t]}`));o.sort();const l=o.join();let h=r[l];if(!h){const o={};for(const t in a){const s=i[e[t]],r=yv(s,n),a=n[s.bufferView],l=gv[t],h=pv(s.type)*_v(s.componentType),c=a&&a.hasOwnProperty("byteStride")?a.byteStride:h;o[l]={buffer:r.buffer,size:h,offset:r.byteOffset,stride:c,count:s.count,components:pv(s.type),type:mv(s.componentType),normalize:s.normalized}}o.hasOwnProperty(qs)||Tv(o,s),h=((t,e)=>{const s=e[$s];if(!s)return null;const i=s.count,n=[];for(const s in e)if(e.hasOwnProperty(s)){const i={semantic:s,components:e[s].components,type:e[s].type,normalize:!!e[s].normalize};Nn.isElementValid(t,i)||i.components++,n.push(i)}let r,a,o,l,h,c;n.sort(((t,e)=>vv[t.semantic]-vv[e.semantic]));const d=new Nn(t,n);let u=!0;for(r=0;r<d.elements.length;++r)if(h=d.elements[r],l=e[h.name],c=l.offset-s.offset,l.buffer!==s.buffer||l.stride!==h.stride||l.size!==h.size||c!==h.offset){u=!1;break}const f=new In(t,d,i),p=f.lock(),m=new Uint32Array(p);let _;if(u)_=new Uint32Array(s.buffer,s.offset,i*f.format.size/4),m.set(_);else{let t,s;for(r=0;r<f.format.elements.length;++r){h=f.format.elements[r],t=h.stride/4,l=e[h.name],s=l.stride/4,_=new Uint32Array(l.buffer,l.offset,(l.count-1)*s+(l.size+3)/4);let n=0,c=h.offset/4;const d=Math.floor((l.size+3)/4);for(a=0;a<i;++a){for(o=0;o<d;++o)m[c+o]=_[n+o];n+=s,c+=t}}}return f.unlock(),f})(t,o),r[l]=h}return h},Av=(t,e,s,i,n,r,a,o,l)=>{const h=[];return e.primitives.forEach((c=>{if(c.extensions?.KHR_draco_mesh_compression)h.push(((t,e,s,i,n,r,a)=>{const o=new Wh(t);o.aabb=xv(s[e.attributes.POSITION]);const l=[];for(const[t,i]of Object.entries(e.attributes)){const e=s[i],n=gv[t],r=mv(e.componentType);l.push({semantic:n,components:pv(e.type),type:r,normalize:e.normalized??(n===Zs&&(1===r||3===r))})}if(a.push(new Promise(((s,n)=>{const r=e.extensions.KHR_draco_mesh_compression;dv(i[r.bufferView].slice().buffer,((i,a)=>{if(i)console.log(i),n(i);else{const i={};for(const[t,e]of Object.entries(r.attributes))i[gv[t]]=a.attributes.indexOf(e);l.sort(((t,e)=>i[t.semantic]-i[e.semantic])),e.attributes?.NORMAL||l.splice(1,0,{semantic:"NORMAL",components:3,type:6});const n=new Nn(t,l),h=a.vertices.byteLength/n.size,c=h<=65535?1:2,d=a.indices.byteLength/(h<=65535?2:4),u=new In(t,n,h,{data:a.vertices}),f=new To(t,c,d,0,a.indices);o.vertexBuffer=u,o.indexBuffer[0]=f,o.primitive[0].type=wv(e),o.primitive[0].base=0,o.primitive[0].count=f?d:h,o.primitive[0].indexed=!!f,s()}}))}))),e?.extensions?.KHR_materials_variants){const t=e.extensions.KHR_materials_variants,s={};t.mappings.forEach((t=>{t.variants.forEach((e=>{s[e]=t.material}))})),n[o.id]=s}return r[o.id]=e.material,o})(t,c,s,i,r,a,l));else{let l=c.hasOwnProperty("indices")?yv(s[c.indices],i,!0):null;const d=Cv(t,c.attributes,l,s,i,n),u=wv(c),f=new Wh(t);if(f.vertexBuffer=d,f.primitive[0].type=u,f.primitive[0].base=0,f.primitive[0].indexed=null!==l,null!==l){let e;e=l instanceof Uint8Array?0:l instanceof Uint16Array?1:2,0===e&&t.isWebGPU&&(e=1,l=new Uint16Array(l));const s=new To(t,e,l.length,0,l);f.indexBuffer[0]=s,f.primitive[0].count=l.length}else f.primitive[0].count=d.numVertices;if(c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_materials_variants")){const t=c.extensions.KHR_materials_variants,e={};t.mappings.forEach((t=>{t.variants.forEach((s=>{e[s]=t.material}))})),r[f.id]=e}a[f.id]=c.material;let p=s[c.attributes.POSITION];if(f.aabb=xv(p),c.hasOwnProperty("targets")){const n=[];c.targets.forEach(((t,r)=>{const a={};t.hasOwnProperty("POSITION")&&(p=s[t.POSITION],a.deltaPositions=Sv(p,i),a.aabb=xv(p)),t.hasOwnProperty("NORMAL")&&(p=s[t.NORMAL],a.deltaNormals=Sv(p,i)),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?a.name=e.extras.targetNames[r]:a.name=r.toString(10),e.hasOwnProperty("weights")&&(a.defaultWeight=e.weights[r]),a.preserveData=o.morphPreserveData,n.push(new Vu(a))})),f.morph=new zu(n,t,{preferHighPrecision:o.morphPreferHighPrecision})}h.push(f)}})),h},Dv=(t,e,s)=>{let i;const n=t.texCoord;if(n)for(i=0;i<s.length;++i)e[`${s[i]}MapUv`]=n;const r=[0,0],a=[1,1],o=t.extensions?.KHR_texture_transform;if(o){const t=o.offset||r,n=o.scale||a,l=o.rotation?-o.rotation*Qe.RAD_TO_DEG:0,h=new os(n[0],n[1]),c=new os(t[0],1-n[1]-t[1]);for(i=0;i<s.length;++i)e[`${s[i]}MapTiling`]=h,e[`${s[i]}MapOffset`]=c,e[`${s[i]}MapRotation`]=l}},Pv=(t,e,s)=>{let i,n;if(t.hasOwnProperty("diffuseFactor")?(i=t.diffuseFactor,e.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),e.opacity=i[3]):(e.diffuse.set(1,1,1),e.opacity=1),t.hasOwnProperty("diffuseTexture")){const i=t.diffuseTexture;n=s[i.index],e.diffuseMap=n,e.diffuseMapChannel="rgb",e.opacityMap=n,e.opacityMapChannel="a",Dv(i,e,["diffuse","opacity"])}if(e.useMetalness=!1,t.hasOwnProperty("specularFactor")?(i=t.specularFactor,e.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))):e.specular.set(1,1,1),t.hasOwnProperty("glossinessFactor")?e.gloss=t.glossinessFactor:e.gloss=1,t.hasOwnProperty("specularGlossinessTexture")){const i=t.specularGlossinessTexture;e.specularMap=e.glossMap=s[i.index],e.specularMapChannel="rgb",e.glossMapChannel="a",Dv(i,e,["gloss","metalness"])}},Lv=(t,e,s)=>{if(t.hasOwnProperty("clearcoatFactor")?e.clearCoat=.25*t.clearcoatFactor:e.clearCoat=0,t.hasOwnProperty("clearcoatTexture")){const i=t.clearcoatTexture;e.clearCoatMap=s[i.index],e.clearCoatMapChannel="r",Dv(i,e,["clearCoat"])}if(t.hasOwnProperty("clearcoatRoughnessFactor")?e.clearCoatGloss=t.clearcoatRoughnessFactor:e.clearCoatGloss=0,t.hasOwnProperty("clearcoatRoughnessTexture")){const i=t.clearcoatRoughnessTexture;e.clearCoatGlossMap=s[i.index],e.clearCoatGlossMapChannel="g",Dv(i,e,["clearCoatGloss"])}if(t.hasOwnProperty("clearcoatNormalTexture")){const i=t.clearcoatNormalTexture;e.clearCoatNormalMap=s[i.index],Dv(i,e,["clearCoatNormal"]),i.hasOwnProperty("scale")?e.clearCoatBumpiness=i.scale:e.clearCoatBumpiness=1}e.clearCoatGlossInvert=!0},Iv=(t,e,s)=>{e.useLighting=!1,e.emissive.copy(e.diffuse),e.emissiveMap=e.diffuseMap,e.emissiveMapUv=e.diffuseMapUv,e.emissiveMapTiling.copy(e.diffuseMapTiling),e.emissiveMapOffset.copy(e.diffuseMapOffset),e.emissiveMapRotation=e.diffuseMapRotation,e.emissiveMapChannel=e.diffuseMapChannel,e.emissiveVertexColor=e.diffuseVertexColor,e.emissiveVertexColorChannel=e.diffuseVertexColorChannel,e.useLighting=!1,e.useSkybox=!1,e.diffuse.set(1,1,1),e.diffuseMap=null,e.diffuseVertexColor=!1},Rv=(t,e,s)=>{if(e.useMetalnessSpecularColor=!0,t.hasOwnProperty("specularColorTexture")&&(e.specularMap=s[t.specularColorTexture.index],e.specularMapChannel="rgb",Dv(t.specularColorTexture,e,["specular"])),t.hasOwnProperty("specularColorFactor")){const s=t.specularColorFactor;e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.specular.set(1,1,1);t.hasOwnProperty("specularFactor")?e.specularityFactor=t.specularFactor:e.specularityFactor=1,t.hasOwnProperty("specularTexture")&&(e.specularityFactorMapChannel="a",e.specularityFactorMap=s[t.specularTexture.index],Dv(t.specularTexture,e,["specularityFactor"]))},Mv=(t,e,s)=>{t.hasOwnProperty("ior")&&(e.refractionIndex=1/t.ior)},kv=(t,e,s)=>{t.hasOwnProperty("dispersion")&&(e.dispersion=t.dispersion)},Ov=(t,e,s)=>{e.blendType=2,e.useDynamicRefraction=!0,t.hasOwnProperty("transmissionFactor")&&(e.refraction=t.transmissionFactor),t.hasOwnProperty("transmissionTexture")&&(e.refractionMapChannel="r",e.refractionMap=s[t.transmissionTexture.index],Dv(t.transmissionTexture,e,["refraction"]))},Fv=(t,e,s)=>{if(e.useSheen=!0,t.hasOwnProperty("sheenColorFactor")){const s=t.sheenColorFactor;e.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.sheen.set(1,1,1);t.hasOwnProperty("sheenColorTexture")&&(e.sheenMap=s[t.sheenColorTexture.index],Dv(t.sheenColorTexture,e,["sheen"])),e.sheenGloss=t.hasOwnProperty("sheenRoughnessFactor")?t.sheenRoughnessFactor:0,t.hasOwnProperty("sheenRoughnessTexture")&&(e.sheenGlossMap=s[t.sheenRoughnessTexture.index],e.sheenGlossMapChannel="a",Dv(t.sheenRoughnessTexture,e,["sheenGloss"])),e.sheenGlossInvert=!0},Nv=(t,e,s)=>{if(e.blendType=2,e.useDynamicRefraction=!0,t.hasOwnProperty("thicknessFactor")&&(e.thickness=t.thicknessFactor),t.hasOwnProperty("thicknessTexture")&&(e.thicknessMap=s[t.thicknessTexture.index],e.thicknessMapChannel="g",Dv(t.thicknessTexture,e,["thickness"])),t.hasOwnProperty("attenuationDistance")&&(e.attenuationDistance=t.attenuationDistance),t.hasOwnProperty("attenuationColor")){const s=t.attenuationColor;e.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}},Bv=(t,e,s)=>{t.hasOwnProperty("emissiveStrength")&&(e.emissiveIntensity=t.emissiveStrength)},Uv=(t,e,s)=>{e.useIridescence=!0,t.hasOwnProperty("iridescenceFactor")&&(e.iridescence=t.iridescenceFactor),t.hasOwnProperty("iridescenceTexture")&&(e.iridescenceMapChannel="r",e.iridescenceMap=s[t.iridescenceTexture.index],Dv(t.iridescenceTexture,e,["iridescence"])),t.hasOwnProperty("iridescenceIor")&&(e.iridescenceRefractionIndex=t.iridescenceIor),t.hasOwnProperty("iridescenceThicknessMinimum")&&(e.iridescenceThicknessMin=t.iridescenceThicknessMinimum),t.hasOwnProperty("iridescenceThicknessMaximum")&&(e.iridescenceThicknessMax=t.iridescenceThicknessMaximum),t.hasOwnProperty("iridescenceThicknessTexture")&&(e.iridescenceThicknessMapChannel="g",e.iridescenceThicknessMap=s[t.iridescenceThicknessTexture.index],Dv(t.iridescenceThicknessTexture,e,["iridescenceThickness"]))},zv=(t,e,s)=>{if(e.enableGGXSpecular=!0,t.hasOwnProperty("anisotropyStrength")?e.anisotropyIntensity=t.anisotropyStrength:e.anisotropyIntensity=0,t.hasOwnProperty("anisotropyTexture")){const i=t.anisotropyTexture;e.anisotropyMap=s[i.index],Dv(i,e,["anisotropy"])}t.hasOwnProperty("anisotropyRotation")?e.anisotropyRotation=t.anisotropyRotation*Qe.RAD_TO_DEG:e.anisotropyRotation=0},Vv=(t,e)=>{const s=new Jf;let i,n;if(t.hasOwnProperty("name")&&(s.name=t.name),s.occludeSpecular=1,s.diffuseVertexColor=!0,s.specularTint=!0,s.specularVertexColor=!0,s.specular.set(1,1,1),s.gloss=1,s.glossInvert=!0,s.useMetalness=!0,t.hasOwnProperty("pbrMetallicRoughness")){const r=t.pbrMetallicRoughness;if(r.hasOwnProperty("baseColorFactor")&&(i=r.baseColorFactor,s.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),s.opacity=i[3]),r.hasOwnProperty("baseColorTexture")){const t=r.baseColorTexture;n=e[t.index],s.diffuseMap=n,s.diffuseMapChannel="rgb",s.opacityMap=n,s.opacityMapChannel="a",Dv(t,s,["diffuse","opacity"])}if(r.hasOwnProperty("metallicFactor")&&(s.metalness=r.metallicFactor),r.hasOwnProperty("roughnessFactor")&&(s.gloss=r.roughnessFactor),r.hasOwnProperty("metallicRoughnessTexture")){const t=r.metallicRoughnessTexture;s.metalnessMap=s.glossMap=e[t.index],s.metalnessMapChannel="b",s.glossMapChannel="g",Dv(t,s,["gloss","metalness"])}}if(t.hasOwnProperty("normalTexture")){const i=t.normalTexture;s.normalMap=e[i.index],Dv(i,s,["normal"]),i.hasOwnProperty("scale")&&(s.bumpiness=i.scale)}if(t.hasOwnProperty("occlusionTexture")){const i=t.occlusionTexture;s.aoMap=e[i.index],s.aoMapChannel="r",Dv(i,s,["ao"])}if(t.hasOwnProperty("emissiveFactor")&&(i=t.emissiveFactor,s.emissive.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))),t.hasOwnProperty("emissiveTexture")){const i=t.emissiveTexture;s.emissiveMap=e[i.index],Dv(i,s,["emissive"])}if(t.hasOwnProperty("alphaMode"))switch(t.alphaMode){case"MASK":s.blendType=3,t.hasOwnProperty("alphaCutoff")?s.alphaTest=t.alphaCutoff:s.alphaTest=.5;break;case"BLEND":s.blendType=2,s.depthWrite=!1;break;default:s.blendType=3}else s.blendType=3;t.hasOwnProperty("doubleSided")?(s.twoSidedLighting=t.doubleSided,s.cull=t.doubleSided?0:1):(s.twoSidedLighting=!1,s.cull=1);const r={KHR_materials_clearcoat:Lv,KHR_materials_emissive_strength:Bv,KHR_materials_ior:Mv,KHR_materials_dispersion:kv,KHR_materials_iridescence:Uv,KHR_materials_pbrSpecularGlossiness:Pv,KHR_materials_sheen:Fv,KHR_materials_specular:Rv,KHR_materials_transmission:Ov,KHR_materials_unlit:Iv,KHR_materials_volume:Nv,KHR_materials_anisotropy:zv};if(t.hasOwnProperty("extensions"))for(const i in t.extensions){const n=r[i];void 0!==n&&n(t.extensions[i],s,e)}return s.update(),s},Hv=new ps,Gv=new rs,Wv=(t,e,s)=>{const i=new Mc;if(t.hasOwnProperty("name")&&t.name.length>0?i.name=t.name:i.name=`node_${e}`,t.hasOwnProperty("matrix")&&(Hv.data.set(t.matrix),Hv.getTranslation(Gv),i.setLocalPosition(Gv),Hv.getEulerAngles(Gv),i.setLocalEulerAngles(Gv),Hv.getScale(Gv),i.setLocalScale(Gv)),t.hasOwnProperty("rotation")){const e=t.rotation;i.setLocalRotation(e[0],e[1],e[2],e[3])}if(t.hasOwnProperty("translation")){const e=t.translation;i.setLocalPosition(e[0],e[1],e[2])}if(t.hasOwnProperty("scale")){const e=t.scale;i.setLocalScale(e[0],e[1],e[2])}return t.hasOwnProperty("extensions")&&t.extensions.EXT_mesh_gpu_instancing&&s.set(t,{ext:t.extensions.EXT_mesh_gpu_instancing}),i},jv=(t,e)=>{const s="orthographic"===t.type?1:0,i=1===s?t.orthographic:t.perspective,n={enabled:!1,projection:s,nearClip:i.znear,aspectRatioMode:0};i.zfar&&(n.farClip=i.zfar),1===s?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=1,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*Qe.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=1,n.aspectRatio=i.aspectRatio));const r=new Im(t.name);return r.addComponent("camera",n),r},Xv=(t,e)=>{const s={enabled:!1,type:"point"===t.type?"omni":t.type,color:t.hasOwnProperty("color")?new Ze(t.color):Ze.WHITE,range:t.hasOwnProperty("range")?t.range:9999,falloffMode:1,intensity:t.hasOwnProperty("intensity")?Qe.clamp(t.intensity,0,2):1};t.hasOwnProperty("spot")&&(s.innerConeAngle=t.spot.hasOwnProperty("innerConeAngle")?t.spot.innerConeAngle*Qe.RAD_TO_DEG:0,s.outerConeAngle=t.spot.hasOwnProperty("outerConeAngle")?t.spot.outerConeAngle*Qe.RAD_TO_DEG:Math.PI/4),t.hasOwnProperty("intensity")&&(s.luminance=t.intensity*Fu.getLightUnitConversion(Iu[s.type],s.outerConeAngle,s.innerConeAngle));const i=new Im(e.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},$v=(t,e,s,i)=>{if(!e.hasOwnProperty("skins")||0===e.skins.length)return[];const n=new Map;return e.skins.map((r=>((t,e,s,i,n,r)=>{let a,o,l;const h=e.joints,c=h.length,d=[];if(e.hasOwnProperty("inverseBindMatrices")){const t=e.inverseBindMatrices,n=yv(s[t],i,!0),r=[];for(a=0;a<c;a++){for(o=0;o<16;o++)r[o]=n[16*a+o];l=new ps,l.set(r),d.push(l)}}else for(a=0;a<c;a++)l=new ps,d.push(l);const u=[];for(a=0;a<c;a++)u[a]=n[h[a]].name;const f=u.join("#");let p=r.get(f);return p||(p=new Rf(t,d,u),r.set(f,p)),p})(t,r,e.accessors,i,s,n)))},qv=(t,e,s,i)=>{if(!t.hasOwnProperty("animations")||0===t.animations.length)return[];const n=i?.animation?.preprocess,r=i?.animation?.postprocess;return t.animations.map(((i,a)=>{n&&n(i);const o=((t,e,s,i,n,r,a)=>{const o=t=>new av(pv(t.type),Sv(t,i)),l={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},c={},d={};let u,f=1;for(u=0;u<t.samplers.length;++u){const e=t.samplers[u];h.hasOwnProperty(e.input)||(h[e.input]=o(s[e.input])),c.hasOwnProperty(e.output)||(c[e.output]=o(s[e.output]));const i=e.hasOwnProperty("interpolation")&&l.hasOwnProperty(e.interpolation)?l[e.interpolation]:1,n={paths:[],input:e.input,output:e.output,interpolation:i};d[u]=n}const p=[],m={translation:"localPosition",rotation:"localRotation",scale:"localScale"},_=t=>{const e=[];for(;t;)e.unshift(t.name),t=t.parent;return e},g=(t,e,s)=>{const i=c[t.output];if(!i)return;let n;if(r&&r[e.mesh]){const t=r[e.mesh];t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")&&(n=t.extras.targetNames)}const a=i.data,o=a.length/h[t.input].data.length,l=a.length/o,p=4*l,m=new ArrayBuffer(p*o);for(let e=0;e<o;e++){const i=new Float32Array(m,p*e,l);for(let t=0;t<l;t++)i[t]=a[t*o+e];const r=new av(1,i),h=n?.[e]?`name.${n[e]}`:e;c[-f]=r;const _={paths:[{entityPath:s,component:"graph",propertyPath:[`weight.${h}`]}],input:t.input,output:-f,interpolation:t.interpolation};f++,d[`morphCurve-${u}-${e}`]=_}};for(u=0;u<t.channels.length;++u){const e=t.channels[u],s=e.target,i=d[e.sampler],r=n[s.node],o=a[s.node],l=_(r);s.path.startsWith("weights")?(g(i,o,l),d[e.sampler].morphCurve=!0):i.paths.push({entityPath:l,component:"graph",propertyPath:[m[s.path]]})}const v=[],b=[],y=[];for(const t in h)v.push(h[t]),h[t]=v.length-1;for(const t in c)b.push(c[t]),c[t]=b.length-1;for(const t in d){const e=d[t];e.morphCurve||(y.push(new rv(e.paths,h[e.input],c[e.output],e.interpolation)),e.paths.length>0&&"localRotation"===e.paths[0].propertyPath[0]&&2!==e.interpolation&&p.push(y[y.length-1].output))}p.sort();let S,x=null;for(u=0;u<p.length;++u){const t=p[u];if(0===u||t!==x){if(S=b[t],4===S.components){const t=S.data,e=t.length-4;for(let s=0;s<e;s+=4)t[s+0]*t[s+4]+t[s+1]*t[s+5]+t[s+2]*t[s+6]+t[s+3]*t[s+7]<0&&(t[s+4]*=-1,t[s+5]*=-1,t[s+6]*=-1,t[s+7]*=-1)}x=t}}let w=0;for(u=0;u<v.length;u++)S=v[u]._data,w=Math.max(w,0===S.length?0:S[S.length-1]);return new y_(t.hasOwnProperty("name")?t.name:`animation_${e}`,w,v,b,y)})(i,a,t.accessors,s,e,t.meshes,t.nodes);return r&&r(i,o),o}))},Kv=async(t,e,s,i,n)=>{const r=n?.global?.preprocess,a=n?.global?.postprocess;r&&r(e);const o=new Map,l=((t,e,s)=>{if(!t.hasOwnProperty("nodes")||0===t.nodes.length)return[];const i=e?.node?.preprocess,n=e?.node?.process??Wv,r=e?.node?.postprocess,a=t.nodes.map(((t,e)=>{i&&i(t);const a=n(t,e,s);return r&&r(t,a),a}));for(let e=0;e<t.nodes.length;++e){const s=t.nodes[e];if(s.hasOwnProperty("children")){const t=a[e],i={};for(let e=0;e<s.children.length;++e){const n=a[s.children[e]];n.parent||(i.hasOwnProperty(n.name)?n.name+=i[n.name]++:i[n.name]=1,t.addChild(n))}}}return a})(e,n,o),h=((t,e)=>{const s=[],i=t.scenes.length;if(1===i&&1===t.scenes[0].nodes?.length){const i=t.scenes[0].nodes[0];s.push(e[i])}else for(let n=0;n<i;n++){const i=t.scenes[n];if(i.nodes){const t=new Mc(i.name);for(let s=0;s<i.nodes.length;s++){const n=e[i.nodes[s]];t.addChild(n)}s.push(t)}}return s})(e,l),c=((t,e,s)=>{let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const n=t.extensions.KHR_lights_punctual.lights;if(n.length){const r=s?.light?.preprocess,a=s?.light?.process??Xv,o=s?.light?.postprocess;t.nodes.forEach(((t,s)=>{if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("light")){const l=t.extensions.KHR_lights_punctual.light,h=n[l];if(h){r&&r(h);const n=a(h,e[s]);o&&o(h,n),n&&(i||(i=new Map),i.set(t,n))}}}))}}return i})(e,l,n),d=((t,e,s)=>{let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("cameras")&&t.cameras.length>0){const n=s?.camera?.preprocess,r=s?.camera?.process??jv,a=s?.camera?.postprocess;t.nodes.forEach(((s,o)=>{if(s.hasOwnProperty("camera")){const l=t.cameras[s.camera];if(l){n&&n(l);const t=r(l,e[o]);a&&a(l,t),t&&(i||(i=new Map),i.set(s,t))}}}))}return i})(e,l,n),u=(t=>{if(!t.hasOwnProperty("extensions")||!t.extensions.hasOwnProperty("KHR_materials_variants"))return null;const e=t.extensions.KHR_materials_variants.variants,s={};for(let t=0;t<e.length;t++)s[e[t].name]=t;return s})(e),f=await Promise.all(s),{meshes:p,meshVariants:m,meshDefaultMaterials:_,promises:g}=((t,e,s,i)=>{const n={},r={},a={},o=[];return{meshes:!i.skipMeshes&&e?.meshes?.length&&e?.accessors?.length&&e?.bufferViews?.length?e.meshes.map((l=>Av(t,l,e.accessors,s,n,r,a,i,o))):[],meshVariants:r,meshDefaultMaterials:a,promises:o}})(t,e,f,n),v=qv(e,l,f,n);((t,e,s,i)=>{const n=e.accessors;s.forEach(((t,e)=>{const s=t.ext.attributes;let r,a,o;if(s.hasOwnProperty("TRANSLATION")){const t=n[s.TRANSLATION];r=Sv(t,i)}if(s.hasOwnProperty("ROTATION")){const t=n[s.ROTATION];a=Sv(t,i)}if(s.hasOwnProperty("SCALE")){const t=n[s.SCALE];o=Sv(t,i)}const l=(r?r.length/3:0)||(a?a.length/4:0)||(o?o.length/3:0);if(l){const e=new Float32Array(16*l),s=new rs,i=new ms,n=new rs(1,1,1),h=new ps;let c=0;for(let t=0;t<l;t++){const l=3*t;if(r&&s.set(r[l],r[l+1],r[l+2]),a){const e=4*t;i.set(a[e],a[e+1],a[e+2],a[e+3])}o&&n.set(o[l],o[l+1],o[l+2]),h.setTRS(s,i,n);for(let t=0;t<16;t++)e[c++]=h.data[t]}t.matrices=e}}))})(0,e,o,f);const b=await Promise.all(i),y=((t,e,s)=>{if(!t.hasOwnProperty("materials")||0===t.materials.length)return[];const i=s?.material?.preprocess,n=s?.material?.process??Vv,r=s?.material?.postprocess;return t.materials.map((t=>{i&&i(t);const s=n(t,e);return r&&r(t,s),s}))})(e,b.map((t=>t.resource)),n),S=$v(t,e,l,f),x=[];for(let t=0;t<p.length;t++)x[t]=new tv,x[t].meshes=p[t];((t,e,s)=>{t.nodes.forEach((t=>{t.hasOwnProperty("mesh")&&t.hasOwnProperty("skin")&&e[t.mesh].meshes.forEach((e=>{e.skin=s[t.skin]}))}))})(e,x,S);const w=new uv;return w.gltf=e,w.nodes=l,w.scenes=h,w.animations=v,w.textures=b,w.materials=y,w.variants=u,w.meshVariants=m,w.meshDefaultMaterials=_,w.renders=x,w.skins=S,w.lights=c,w.cameras=d,w.nodeInstancingMap=o,a&&a(e,w),await Promise.all(g),w};let Yv=0;const Qv=t=>t.extensions?.KHR_texture_basisu?.source??t.extensions?.EXT_texture_webp?.source??t.source,Zv=(t,e,s)=>{t&&t.toLowerCase().endsWith(".glb")||(()=>{const t=new Uint8Array(e);return 103===t[0]&&108===t[1]&&84===t[2]&&70===t[3]})()?((t,e)=>{const s=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),i=s.getUint32(0,!0),n=s.getUint32(4,!0),r=s.getUint32(8,!0);if(1179937895!==i)return void e(`Invalid magic number found in glb header. Expected 0x46546C67, found 0x${i.toString(16)}`);if(2!==n)return void e(`Invalid version number found in glb header. Expected 2, found ${n}`);if(r<=0||r>s.byteLength)return void e(`Invalid length found in glb header. Found ${r}`);const a=[];let o=12;for(;o<r;){const t=s.getUint32(o,!0);o+t+8>s.byteLength&&e(`Invalid chunk length found in glb. Found ${t}`);const i=s.getUint32(o+4,!0),n=new Uint8Array(s.buffer,s.byteOffset+o+8,t);a.push({length:t,type:i,data:n}),o+=t+8}1===a.length||2===a.length?1313821514===a[0].type?a.length>1&&5130562!==a[1].type?e(`Invalid chunk type found in glb file. Expected 0x004E4942, found 0x${a[1].type.toString(16)}`):e(null,{gltfChunk:a[0].data,binaryChunk:2===a.length?a[1].data:null}):e(`Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x${a[0].type.toString(16)}`):e("Invalid number of chunks found in glb file.")})(e,s):s(null,{gltfChunk:e,binaryChunk:null})};class Jv{static parse(t,e,s,i,n,r,a){Zv(t,s,((t,s)=>{t?a(t):((t,e)=>{const s=JSON.parse((t=>{if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);let e="";for(let s=0;s<t.length;s++)e+=String.fromCharCode(t[s]);return decodeURIComponent(escape(e))})(t));s.asset&&s.asset.version&&parseFloat(s.asset.version)<2?e(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`):e(null,s)})(s.gltfChunk,((t,o)=>{if(t)return void a(t);const l=((t,e,s,i)=>{if(!t.buffers||0===t.buffers.length)return[];const n=i?.buffer?.preprocess,r=i?.buffer?.processAsync,a=i?.buffer?.postprocess;return t.buffers.map(((i,o)=>{let l;return n&&n(i),l=new Promise(r?(t,e)=>{r(i,((s,i)=>{s?e(s):t(i)}))}:t=>{t(null)}),l=l.then((t=>{if(t)return t;if(i.hasOwnProperty("uri")){if(fv(i.uri)){const t=atob(i.uri.split(",")[1]),e=new Uint8Array(t.length);for(let s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e}return new Promise(((t,e)=>{tl.get(hm.test(i.uri)?i.uri:ke.join(s,i.uri),{cache:!0,responseType:"arraybuffer",retry:!1},((s,i)=>{s?e(s):t(new Uint8Array(i))}))}))}return e})),a&&(l=l.then((e=>(a(t.buffers[o],e),e)))),l}))})(o,s.binaryChunk,e,r),h=((t,e,s)=>{const i=[],n=s?.bufferView?.preprocess,r=s?.bufferView?.processAsync,a=s?.bufferView?.postprocess;if(!t.bufferViews?.length)return i;for(let s=0;s<t.bufferViews.length;++s){const o=t.bufferViews[s];let l;n&&n(o),l=new Promise(r?(t,s)=>{r(o,e,((e,i)=>{e?s(e):t(i)}))}:t=>{t(null)}),l=l.then((t=>t||e[o.buffer].then((t=>new Uint8Array(t.buffer,t.byteOffset+(o.byteOffset||0),o.byteLength))))),o.hasOwnProperty("byteStride")&&(l=l.then((t=>(t.byteStride=o.byteStride,t)))),a&&(l=l.then((t=>(a(o,t),t)))),i.push(l)}return i})(o,l,r),c=((t,e,s,i,n)=>{if(!t.images||0===t.images.length)return[];const r=n?.image?.preprocess,a=n?.image?.processAsync,o=n?.image?.postprocess,l={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},h=(t,e,s,n,r,a)=>new Promise(((o,h)=>{const c=s=>{const c=`${t.name||"gltf-texture"}-${Yv++}`,d={url:e||c};if(s&&(d.contents=s.slice(0).buffer),n){const t=l[n];t&&(d.filename=`${d.url}.${t}`)}const u=new pm(c,"texture",d,{srgb:a},r);u.on("load",(t=>o(t))),u.on("error",(t=>h(t))),i.add(u),i.load(u)};s?s.then((t=>c(t))):c(null)})),c=(t=>{const e=new Set;return t.hasOwnProperty("materials")&&t.materials.forEach((s=>{if(s.hasOwnProperty("pbrMetallicRoughness")){const i=s.pbrMetallicRoughness;if(i.hasOwnProperty("baseColorTexture")){const s=t.textures[i.baseColorTexture.index];e.add(Qv(s))}}if(s.hasOwnProperty("emissiveTexture")){const i=t.textures[s.emissiveTexture.index];e.add(Qv(i))}if(s.hasOwnProperty("extensions")){const i=s.extensions.KHR_materials_sheen;if(i&&i.hasOwnProperty("sheenColorTexture")){const s=t.textures[i.sheenColorTexture.index];e.add(Qv(s))}const n=s.extensions.KHR_materials_pbrSpecularGlossiness;if(n&&n.hasOwnProperty("specularGlossinessTexture")){const s=t.textures[n.specularGlossinessTexture.index];e.add(Qv(s))}const r=s.extensions.KHR_materials_specular;if(r&&r.hasOwnProperty("specularColorTexture")){const s=t.textures[r.specularColorTexture.index];e.add(Qv(s))}}})),e})(t);return t.images.map(((t,i)=>{let n;return r&&r(t),n=new Promise(a?(e,s)=>{a(t,((t,i)=>{t?s(t):e(i)}))}:t=>{t(null)}),n=n.then((n=>{const r=c.has(i);return n||(t.hasOwnProperty("uri")?fv(t.uri)?h(t,t.uri,null,(a=t.uri).substring(a.indexOf(":")+1,a.indexOf(";")),null,r):h(t,hm.test(t.uri)?t.uri:ke.join(s,t.uri),null,null,{crossOrigin:"anonymous"},r):t.hasOwnProperty("bufferView")&&t.hasOwnProperty("mimeType")?h(t,null,e[t.bufferView],t.mimeType,null,r):Promise.reject(new Error(`Invalid image found in gltf (neither uri or bufferView found). index=${i}`)));var a})),o&&(n=n.then((e=>(o(t,e),e)))),n}))})(o,h,e,n,r),d=((t,e,s)=>{if(!t?.images?.length||!t?.textures?.length)return[];const i=s?.texture?.preprocess,n=s?.texture?.processAsync,r=s?.texture?.postprocess,a=new Set;return t.textures.map((s=>{let o;return i&&i(s),o=new Promise(n?(e,i)=>{n(s,t.images,((t,s)=>{t?i(t):e(s)}))}:t=>{t(null)}),o=o.then((i=>{i=i??Qv(s);const n=a.has(i);return a.add(i),e[i].then((e=>{const i=n?Ev(e):e;return((t,e)=>{const s=(t,e)=>{switch(t){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return e}},i=(t,e)=>{switch(t){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return e}};t&&(e=e??{},t.minFilter=s(e.minFilter,5),t.magFilter=s(e.magFilter,1),t.addressU=i(e.wrapS,0),t.addressV=i(e.wrapT,0))})(i.resource,(t.samplers??[])[s.sampler]),i}))})),r&&(o=o.then((t=>(r(s,t),t)))),o}))})(o,c,r);Kv(i,o,h,d,r).then((t=>a(null,t))).catch((t=>a(t)))}))}))}static createDefaultMaterial(){return Vv({name:"defaultGlbMaterial"},[])}}class tb extends Sm{constructor(t){super(t,"animclip")}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=Jo.ResponseType.JSON),tl.get(t.load,s,((s,i)=>{s?e(`Error loading animation clip resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){const s=e.name,i=e.duration,n=e.inputs.map((t=>new av(1,t))),r=e.outputs.map((t=>new av(t.components,t.data))),a=e.curves.map((t=>new rv([t.path],t.inputIndex,t.outputIndex,t.interpolation)));return new y_(s,i,n,r,a)}}class eb extends Sm{constructor(t){super(t,"animstategraph")}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=Jo.ResponseType.JSON),tl.get(t.load,s,((s,i)=>{s?e(`Error loading animation state graph resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return new z_(e)}}class sb extends Sm{constructor(t){super(t,"binary")}load(t,e){"string"==typeof t&&(t={load:t,original:t}),tl.get(t.load,{responseType:Jo.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},((s,i)=>{s?e(`Error loading binary resource: ${t.original} [${s}]`):e(null,i)}))}openBinary(t){return t.buffer}}class ib{constructor(t,e,s,i){const n=function(t,i,n){const r=ib.createAsset(e.name,t,i,n);return s.add(r),r},r=[];for(let e=0;e<t.renders.length;++e)r.push(n("render",t.renders[e],e));const a=[];for(let e=0;e<t.materials.length;++e)a.push(n("material",t.materials[e],e));const o=[];for(let e=0;e<t.animations.length;++e)o.push(n("animation",t.animations[e],e));this.data=t,this._model=null,this._assetName=e.name,this._assets=s,this._defaultMaterial=i,this.renders=r,this.materials=a,this.textures=t.textures,this.animations=o}get model(){if(!this._model){const t=ib.createModel(this.data,this._defaultMaterial),e=ib.createAsset(this._assetName,"model",t,0);this._assets.add(e),this._model=e}return this._model}static createAsset(t,e,s,i){const n=new pm(`${t}/${e}/${i}`,e,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(t){const e=new Im(void 0,this._assets._loader._app);return e.addComponent("model",Object.assign({type:"asset",asset:this.model},t)),e}instantiateRenderEntity(t){const e=this._defaultMaterial,s=[],i=function(t,i,n,r,a,o,l,h){const c=a[n.id],d=void 0===c?e:r[c],u=new nc(n,d);n.morph&&(u.morphInstance=new Bu(n.morph)),l.hasOwnProperty("skin")&&s.push({meshInstance:u,rootBone:t,entity:i});const f=h.get(l);if(f){const t=f.matrices,e=Nn.getDefaultInstancingFormat(n.device),s=new In(n.device,e,t.length/16,{data:t});u.setInstancing(s),u.instancingData._destroyVertexBuffer=!0}return u},n=(e,s,r)=>{const a=new Im(void 0,this._assets._loader._app);s._cloneInternal(a),e||(e=a);let o=null,l=null;for(let t=0;t<r.nodes.length;t++){if(r.nodes[t]===s){const s=r.gltf.nodes[t];if(s.hasOwnProperty("mesh")){const t=r.renders[s.mesh].meshes;l=this.renders[s.mesh];for(let n=0;n<t.length;n++){const l=t[n];if(l){const t=i(e,a,l,r.materials,r.meshDefaultMaterials,r.skins,s,r.nodeInstancingMap);o||(o=[]),o.push(t)}}}if(r.lights){const t=r.lights.get(s);t&&a.addChild(t.clone())}if(r.cameras){const t=r.cameras.get(s);t&&t.camera.system.cloneComponent(t,a)}}}o&&(a.addComponent("render",Object.assign({type:"asset",meshInstances:o},t)),a.render.assignAsset(l));const h=s.children;for(let t=0;t<h.length;t++){const s=n(e,h[t],r);a.addChild(s)}return a},r=[];for(const t of this.data.scenes)r.push(n(null,t,this.data));return s.forEach((t=>{t.meshInstance.skinInstance=Z_.createCachedSkinInstance(t.meshInstance.mesh.skin,t.rootBone,t.entity),t.meshInstance.node.render.rootBone=t.rootBone})),ib.createSceneHierarchy(r,Im)}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(t,e){const s=e?this.data.variants[e]:null;if(void 0===s)return;const i=t.findComponents("render");for(let t=0;t<i.length;t++){const e=i[t];this._applyMaterialVariant(s,e.meshInstances)}}applyMaterialVariantInstances(t,e){const s=e?this.data.variants[e]:null;void 0!==s&&this._applyMaterialVariant(s,t)}_applyMaterialVariant(t,e){e.forEach((e=>{if(null===t)e.material=this._defaultMaterial;else{const s=this.data.meshVariants[e.mesh.id];s&&(e.material=this.data.materials[s[t]])}}))}static createSceneHierarchy(t,e){let s=null;if(1===t.length)s=t[0];else{s=new e("SceneGroup");for(const e of t)s.addChild(e)}return s}static createModel(t,e){const s=function(s,i,n,r,a,o,l){const h=t.meshDefaultMaterials[i.id],c=void 0===h?e:a[h],d=new nc(i,c,o);if(i.morph){const t=new Bu(i.morph);d.morphInstance=t,s.morphInstances.push(t)}if(l.hasOwnProperty("skin")){const t=l.skin,e=n[t];i.skin=e;const a=r[t];d.skinInstance=a,s.skinInstances.push(a)}s.meshInstances.push(d)},i=new Uu,n=[];for(const e of t.skins){const t=new zh(e);t.bones=e.bones,n.push(t)}i.graph=ib.createSceneHierarchy(t.scenes,Mc);for(let e=0;e<t.nodes.length;e++){const r=t.nodes[e];if(r.root===i.graph){const a=t.gltf.nodes[e];if(a.hasOwnProperty("mesh")){const e=t.renders[a.mesh].meshes;for(let o=0;o<e.length;o++){const l=e[o];l&&s(i,l,t.skins,n,t.materials,r,a)}}}}return i}destroy(){const t=this._assets,e=function(e){t.remove(e),e.unload()},s=function(t){t.forEach((t=>{e(t)}))};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(e(this._model),this._model=null),this.data=null,this.assets=null}}class nb{constructor(t,e,s){this._device=t,this._assets=e,this._defaultMaterial=Jv.createDefaultMaterial(),this.maxRetries=s}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}load(t,e,s){pm.fetchArrayBuffer(t.load,((i,n)=>{i?e(i):Jv.parse(this._getUrlWithoutParams(t.original),ke.extractPath(t.load),n,this._device,s.registry,s.options,((t,i)=>{t?e(t):e(null,new ib(i,s,this._assets,this._defaultMaterial))}))}),s,this.maxRetries)}open(t,e,s){return e}patch(t,e){}}class rb extends Sm{constructor(t){super(t,"container"),this.glbContainerParser=new nb(t.graphicsDevice,t.assets,0),this.parsers={}}set maxRetries(t){this.glbContainerParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=t?ke.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".",""):null;return this.parsers[e]||this.glbContainerParser}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){return this._getParser(t).open(t,e,s)}}class ab extends Sm{constructor(t){super(t,"cubemap"),this._device=t.graphicsDevice,this._registry=t.assets,this._loader=t.loader}load(t,e,s){this.loadAssets(s,e)}open(t,e,s){return s?s.resource:null}patch(t,e){this.loadAssets(t,((s,i)=>{s&&(e.fire("error",t),e.fire(`error:${t.id}`,s,t),t.fire("error",t))}))}getAssetIds(t){const e=[];if(e[0]=t.file,(t.loadFaces||!t.file)&&t.data&&t.data.textures)for(let s=0;s<6;++s)e[s+1]=t.data.textures[s];else e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=null;return e}compareAssetIds(t,e){return t&&e?parseInt(t,10)===t||"string"==typeof t?t===e:t.url===e.url:null!==t==(null!==e)}update(t,e,s){const i=t.data||{},n=t._handlerState.assets,r=t._resources;let a,o,l;const h=[null,null,null,null,null,null,null],c=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?_i:mi:null};if(t.loaded&&s[0]===n[0])h[1]=r[1]||null,h[2]=r[2]||null,h[3]=r[3]||null,h[4]=r[4]||null,h[5]=r[5]||null,h[6]=r[6]||null;else if(s[0])if(a=s[0].resource,a.cubemap)for(l=0;l<6;++l)h[l+1]=new dn(this._device,{name:`${t.name}_prelitCubemap${a.width>>l}`,cubemap:!0,type:c()||a.type,width:a.width>>l,height:a.height>>l,format:a.format,levels:[a._levels[l]],addressU:1,addressV:1,mipmaps:0===l});else h[1]=a;const d=s.slice(1);if(t.loaded&&this.cmpArrays(d,n.slice(1)))h[0]=r[0]||null;else if(-1===d.indexOf(null)){const e=d.map((t=>t.resource)),s=[];for(o=0;o<e[0]._levels.length;++o)s.push(e.map((t=>t._levels[o])));const n=e[0].format,r=new dn(this._device,{name:`${t.name}_faces`,cubemap:!0,type:c()||e[0].type,width:e[0].width,height:e[0].height,format:6===n?7:n,mipmaps:i.mipmaps??!0,levels:s,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:e[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:e[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:1,addressV:1});h[0]=r}if(!this.cmpArrays(h,r))for(t.resources=h,t._handlerState.assetIds=e,t._handlerState.assets=s,l=0;l<r.length;++l)null!==r[l]&&-1===h.indexOf(r[l])&&r[l].destroy();for(l=0;l<n.length;++l)null!==n[l]&&-1===s.indexOf(n[l])&&n[l].unload()}cmpArrays(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}resolveId(t){const e=parseInt(t,10);return e===t||e.toString()===t?e:t}loadAssets(t,e){t.hasOwnProperty("_handlerState")||(t._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(t),n=[null,null,null,null,null,null,null],r=t._handlerState.assetIds,a=t._handlerState.assets,o=s._registry;let l=7;const h=function(r,a){n[r]=a,l--,0===l&&(s.update(t,i,n),e(null,t.resources))},c=function(t,s,i){e(s)},d=function(t,e){e.loaded?h(t,e):(o.once(`load:${e.id}`,h.bind(s,t)),o.once(`error:${e.id}`,c.bind(s,t)),e.loading||o.load(e))};let u;for(let e=0;e<7;++e){const n=this.resolveId(i[e]);if(n)if(s.compareAssetIds(n,r[e]))d(e,a[e]);else if(parseInt(n,10)===n)u=o.get(n),u?d(e,u):setTimeout(((t,e)=>{const s=o.get(e);s?d(t,s):c(0,`failed to find dependent cubemap asset=${e}`)}).bind(null,e,n));else{const s="string"==typeof n?{url:n,filename:n}:n,i=-1===s.url.search(".dds")?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:!1}:null;u=new pm(`${t.name}_part_${e}`,"texture",s,i),o.add(u),d(e,u)}else h(e,null)}}}const ob=.28209479177387814;class lb{constructor(t,e,s,i,n,r){const a=(t,e)=>{const s=(1<<e)-1;return(t&s)/s},o=(t,e)=>{t.x=a(e>>>21,11),t.y=a(e>>>11,10),t.z=a(e,11)},l=(t,e,s)=>t*(1-s)+e*s,{chunkData:h,chunkSize:c,vertexData:d,shData0:u,shData1:f,shData2:p,shBands:m}=t,_=[3,8,15][m-1];this.read=t=>{const g=Math.floor(t/256)*c;var v,b;if(e&&(o(e,d[4*t+0]),e.x=l(h[g+0],h[g+3],e.x),e.y=l(h[g+1],h[g+4],e.y),e.z=l(h[g+2],h[g+5],e.z)),s&&((t,e)=>{const s=1/(.5*Math.sqrt(2)),i=(a(e>>>20,10)-.5)*s,n=(a(e>>>10,10)-.5)*s,r=(a(e,10)-.5)*s,o=Math.sqrt(1-(i*i+n*n+r*r));switch(e>>>30){case 0:t.set(i,n,r,o);break;case 1:t.set(o,n,r,i);break;case 2:t.set(n,o,r,i);break;case 3:t.set(n,r,o,i)}})(s,d[4*t+1]),i&&(o(i,d[4*t+2]),i.x=l(h[g+6],h[g+9],i.x),i.y=l(h[g+7],h[g+10],i.y),i.z=l(h[g+8],h[g+11],i.z)),n&&(v=n,b=d[4*t+3],v.x=a(b>>>24,8),v.y=a(b>>>16,8),v.z=a(b>>>8,8),v.w=a(b,8),c>12&&(n.x=l(h[g+12],h[g+15],n.x),n.y=l(h[g+13],h[g+16],n.y),n.z=l(h[g+14],h[g+17],n.z))),r&&m>0){const e=[u,f,p];for(let s=0;s<3;++s)for(let i=0;i<15;++i)r[15*s+i]=i<_?e[s][16*t+i]*(8/255)-4:0}}}}class hb{createIter(t,e,s,i,n){return new lb(this,t,e,s,i,n)}calcAabb(t){const{chunkData:e,numChunks:s,chunkSize:i}=this;let n=Math.exp(Math.max(e[9],e[10],e[11])),r=e[0]-n,a=e[1]-n,o=e[2]-n,l=e[3]+n,h=e[4]+n,c=e[5]+n;for(let t=1;t<s;++t){const s=t*i;n=Math.exp(Math.max(e[s+9],e[s+10],e[s+11])),r=Math.min(r,e[s+0]-n),a=Math.min(a,e[s+1]-n),o=Math.min(o,e[s+2]-n),l=Math.max(l,e[s+3]+n),h=Math.max(h,e[s+4]+n),c=Math.max(c,e[s+5]+n)}return t.center.set(.5*(r+l),.5*(a+h),.5*(o+c)),t.halfExtents.set(.5*(l-r),.5*(h-a),.5*(c-o)),!0}getCenters(t){const{vertexData:e,chunkData:s,numChunks:i,chunkSize:n}=this;let r,a,o,l,h,c;for(let d=0;d<i;++d){const i=d*n;r=s[i+0],a=s[i+1],o=s[i+2],l=s[i+3],h=s[i+4],c=s[i+5];const u=Math.min(this.numSplats,256*(d+1));for(let s=256*d;s<u;++s){const i=e[4*s],n=(i>>>21)/2047,d=(i>>>11&1023)/1023,u=(2047&i)/2047;t[3*s+0]=(1-n)*r+n*l,t[3*s+1]=(1-d)*a+d*h,t[3*s+2]=(1-u)*o+u*c}}}getChunks(t){const{chunkData:e,numChunks:s,chunkSize:i}=this;let n,r,a,o,l,h;for(let c=0;c<s;++c){const s=c*i;n=e[s+0],r=e[s+1],a=e[s+2],o=e[s+3],l=e[s+4],h=e[s+5],t[6*c+0]=n,t[6*c+1]=r,t[6*c+2]=a,t[6*c+3]=o,t[6*c+4]=l,t[6*c+5]=h}}calcFocalPoint(t){const{chunkData:e,numChunks:s,chunkSize:i}=this;t.x=0,t.y=0,t.z=0;for(let n=0;n<s;++n){const s=n*i;t.x+=e[s+0]+e[s+3],t.y+=e[s+1]+e[s+4],t.z+=e[s+2]+e[s+5]}t.mulScalar(.5/s)}get isCompressed(){return!0}get numChunks(){return Math.ceil(this.numSplats/256)}get chunkSize(){return this.chunkData.length/this.numChunks}decompress(){const t=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:e}=this;if(e>0){const e=[];for(let t=0;t<45;++t)e.push(`f_rest_${t}`);t.splice(t.indexOf("f_dc_0")+1,0,...e)}const s={};t.forEach((t=>{s[t]=new Float32Array(this.numSplats)}));const i=new rs,n=new ms,r=new rs,a=new ls,o=e>0?new Float32Array(45):null,l=this.createIter(i,n,r,a,o);for(let t=0;t<this.numSplats;++t)if(l.read(t),s.x[t]=i.x,s.y[t]=i.y,s.z[t]=i.z,s.rot_1[t]=n.x,s.rot_2[t]=n.y,s.rot_3[t]=n.z,s.rot_0[t]=n.w,s.scale_0[t]=r.x,s.scale_1[t]=r.y,s.scale_2[t]=r.z,s.f_dc_0[t]=(a.x-.5)/ob,s.f_dc_1[t]=(a.y-.5)/ob,s.f_dc_2[t]=(a.z-.5)/ob,s.opacity[t]=a.w<=0?-40:a.w>=1?40:-Math.log(1/a.w-1),o)for(let e=0;e<45;++e)s[`f_rest_${e}`][t]=o[e];return new Ap([{name:"vertex",count:this.numSplats,properties:t.map((t=>({name:t,type:"float",byteSize:4,storage:s[t]})))}],this.comments)}}class cb extends Dp{constructor(t,e){super(t,e);const{chunkData:s,chunkSize:i,numChunks:n,numSplats:r,vertexData:a,shBands:o}=e;this.chunks=new Float32Array(6*n),e.getChunks(this.chunks),this.packedTexture=this.createTexture("packedData",Us,this.evalTextureSize(r),a);const l=this.evalTextureSize(n);l.x*=5,this.chunkTexture=this.createTexture("chunkData",Ls,l);const h=this.chunkTexture.lock();if(((t,e,s,i,n)=>{for(let r=0;r<n;++r)for(let n=0;n<i;++n)t[r*e+n]=s[r*i+n]})(h,20,s,i,n),12===i)for(let t=0;t<n;++t)h[20*t+15]=1,h[20*t+16]=1,h[20*t+17]=1;if(this.chunkTexture.unlock(),o>0){const t=this.evalTextureSize(r);this.shTexture0=this.createTexture("shTexture0",Us,t,new Uint32Array(e.shData0.buffer)),this.shTexture1=this.createTexture("shTexture1",Us,t,new Uint32Array(e.shData1.buffer)),this.shTexture2=this.createTexture("shTexture2",Us,t,new Uint32Array(e.shData2.buffer))}else this.shTexture0=null,this.shTexture1=null,this.shTexture2=null}destroy(){this.packedTexture?.destroy(),this.chunkTexture?.destroy(),this.shTexture0?.destroy(),this.shTexture1?.destroy(),this.shTexture2?.destroy(),super.destroy()}configureMaterial(t){t.setDefine("GSPLAT_COMPRESSED_DATA",!0),t.setParameter("packedTexture",this.packedTexture),t.setParameter("chunkTexture",this.chunkTexture),this.shTexture0?(t.setDefine("SH_BANDS",3),t.setParameter("shTexture0",this.shTexture0),t.setParameter("shTexture1",this.shTexture1),t.setParameter("shTexture2",this.shTexture2)):t.setDefine("SH_BANDS",0)}evalTextureSize(t){const e=Math.ceil(Math.sqrt(t)),s=Math.ceil(t/e);return new os(e,s)}}const db=new Uint8Array([112,108,121,10]),ub=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),fb=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]);class pb{constructor(t,e){this.head=0,this.tail=0,this.reader=t,this.progressFunc=e}async read(){const{value:t,done:e}=await this.reader.read();if(e)throw new Error("Stream finished before end of header");this.push(t),this.progressFunc?.(t.byteLength)}push(t){if(this.data){const e=this.tail-this.head,s=e+t.length;if(this.data.length>=s)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(t,e),this.head=0,this.tail=s):(this.data.set(t,this.tail),this.tail+=t.length);else{const i=new Uint8Array(s);this.head>0||this.tail<this.data.length?i.set(this.data.subarray(this.head,this.tail),0):i.set(this.data,0),i.set(t,e),this.data=i,this.view=new DataView(this.data.buffer),this.head=0,this.tail=s}}else this.data=t,this.view=new DataView(this.data.buffer),this.tail=t.length}compact(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0)}get remaining(){return this.tail-this.head}getInt8(){const t=this.view.getInt8(this.head);return this.head++,t}getUint8(){const t=this.view.getUint8(this.head);return this.head++,t}getInt16(){const t=this.view.getInt16(this.head,!0);return this.head+=2,t}getUint16(){const t=this.view.getUint16(this.head,!0);return this.head+=2,t}getInt32(){const t=this.view.getInt32(this.head,!0);return this.head+=4,t}getUint32(){const t=this.view.getUint32(this.head,!0);return this.head+=4,t}getFloat32(){const t=this.view.getFloat32(this.head,!0);return this.head+=4,t}getFloat64(){const t=this.view.getFloat64(this.head,!0);return this.head+=8,t}}const mb=async(t,e=null,s=null)=>{const i=(t,e)=>{const s=t.length-e.length;let i,n;for(i=0;i<=s;++i){for(n=0;n<e.length&&t[i+n]===e[n];++n);if(n===e.length)return i}return-1},n=(t,e)=>{if(t.length<e.length)return!1;for(let s=0;s<e.length;++s)if(t[s]!==e[s])return!1;return!0},r=new pb(t,s);let a;for(;;){if(await r.read(),r.tail>=db.length&&!n(r.data,db))throw new Error("Invalid ply header");if(a=i(r.data,ub),-1!==a)break}const o=new TextDecoder("ascii").decode(r.data.subarray(0,a)).split("\n"),{elements:l,format:h,comments:c}=(t=>{const e=[],s=[];let i;for(let n=1;n<t.length;++n){const r=t[n].split(" ");switch(r[0]){case"comment":s.push(r.slice(1).join(" "));break;case"format":i=r[1];break;case"element":e.push({name:r[1],count:parseInt(r[2],10),properties:[]});break;case"property":if(!fb.has(r[1]))throw new Error(`Unrecognized property data type '${r[1]}' in ply header`);e[e.length-1].properties.push({type:r[1],name:r[2],storage:null,byteSize:fb.get(r[1]).BYTES_PER_ELEMENT});break;default:throw new Error(`Unrecognized header value '${r[0]}' in ply header`)}}return{elements:e,format:i,comments:s}})(o);if("binary_little_endian"!==h)throw new Error("Unsupported ply format");r.head=a+ub.length,r.compact();return await(async()=>(t=>{const e=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],s=["packed_position","packed_rotation","packed_scale","packed_color"],i=new Array(45).fill("").map(((t,e)=>`f_rest_${e}`)),n=()=>"chunk"===t[0].name&&t[0].properties.every(((t,s)=>t.name===e[s]&&"float"===t.type))&&"vertex"===t[1].name&&t[1].properties.every(((t,e)=>t.name===s[e]&&"uint"===t.type));return 2===t.length&&n()||3===t.length&&n()&&"sh"===t[2].name&&-1!==[9,24,45].indexOf(t[2].properties.length)&&t[2].properties.every(((t,e)=>t.name===i[e]&&"uchar"===t.type))})(l)?await(async(t,e,s)=>{const i=new hb;i.comments=s;const n=e[0].count,r=e[0].properties.length,a=e[1].count,o=(t=>{const e=Math.ceil(Math.sqrt(t));return e*Math.ceil(t/e)})(a);i.numSplats=a,i.chunkData=new Float32Array(n*r),i.vertexData=new Uint32Array(4*o);const l=async(e,s)=>{const i=new Uint8Array(e);let n=0;for(;n<s;){for(;0===t.remaining;)await t.read();const e=Math.min(s-n,t.remaining),r=t.data;for(let s=0;s<e;++s)i[n++]=r[t.head++]}};if(await l(i.chunkData.buffer,n*r*4),await l(i.vertexData.buffer,4*a*4),3===e.length){const t=16*o,s=new Uint8Array(t),n=new Uint8Array(t),r=new Uint8Array(t),a=1024,h=e[2].properties.length/3,c=new Uint8Array(a*h*3);for(let t=0;t<i.numSplats;t+=a){const e=Math.min(a,i.numSplats-t);await l(c.buffer,e*h*3);for(let i=0;i<e;++i)for(let e=0;e<15;++e){const a=16*(t+i)+e;e<h?(s[a]=c[(3*i+0)*h+e],n[a]=c[(3*i+1)*h+e],r[a]=c[(3*i+2)*h+e]):(s[a]=127,n[a]=127,r[a]=127)}}i.shData0=s,i.shData1=n,i.shData2=r,i.shBands={3:1,8:2,15:3}[h]}else i.shBands=0;return i})(r,l,c):(l.forEach((t=>{t.properties.forEach((s=>{const i=fb.get(s.type);if(i){const n=!e||e(s.name)?new i(t.count):null;s.storage=n}}))})),(t=>1===t.length&&"vertex"===t[0].name&&t[0].properties.every((t=>"float"===t.type)))(l)?await(async(t,e,s)=>{const i=e[0],n=i.properties,r=n.length,a=n.map((t=>t.storage)),o=n.reduce(((t,e)=>t+e.byteSize),0);let l,h=0;const c=()=>{const e=t.data.buffer;l?.buffer!==e&&(l=new Float32Array(e,0,e.byteLength/4))};for(c();h<i.count;){for(;t.remaining<o;)await t.read(),c();const e=Math.min(i.count-h,Math.floor(t.remaining/o));for(let t=0;t<r;++t){const s=a[t];for(let i=0;i<e;++i)s[i+h]=l[i*r+t]}h+=e,t.head+=e*o}return new Ap(e,s)})(r,l,c):await(async(t,e,s)=>{for(let s=0;s<e.length;++s){const i=e[s],n=i.properties.reduce(((t,e)=>t+e.byteSize),0),r=i.properties.map((t=>{if(!t.storage)return e=>{e.head+=t.byteSize};switch(t.type){case"char":return(e,s)=>{t.storage[s]=e.getInt8()};case"uchar":return(e,s)=>{t.storage[s]=e.getUint8()};case"short":return(e,s)=>{t.storage[s]=e.getInt16()};case"ushort":return(e,s)=>{t.storage[s]=e.getUint16()};case"int":return(e,s)=>{t.storage[s]=e.getInt32()};case"uint":return(e,s)=>{t.storage[s]=e.getUint32()};case"float":return(e,s)=>{t.storage[s]=e.getFloat32()};case"double":return(e,s)=>{t.storage[s]=e.getFloat64()};default:throw new Error(`Unsupported property data type '${t.type}' in ply header`)}}));let a=0;for(;a<i.count;){for(;t.remaining<n;)await t.read();const e=Math.min(i.count-a,Math.floor(t.remaining/n));for(let s=0;s<e;++s){for(let e=0;e<i.properties.length;++e)r[e](t,a);a++}}}return new Ap(e,s)})(r,l,c)))()},_b=t=>!0;class gb{constructor(t,e){this.app=t,this.maxRetries=e}async load(t,e,s){try{const i=await(s.file?.contents??fetch(t.load));if(i&&i.body){const t=parseInt(i.headers.get("content-length")??"0",10);let n=0;const r=await mb(i.body.getReader(),s.data.elementFilter??_b,(e=>{n+=e,s&&s.fire("progress",n,t)}));s.fire("load:data",r),r.isCompressed||(s.data.reorder??1)&&r.reorderData();e(null,r.isCompressed&&!s.data.decompress?new cb(this.app.graphicsDevice,r):new Pp(this.app.graphicsDevice,r.isCompressed?r.decompress():r))}else e("Error loading resource",null)}catch(t){e(t,null)}}open(t,e){return e}}const vb=(t,e)=>{const s=new Map;e.forEach((e=>{const i=(i,n)=>{s.set(e,{loaded:i,total:n}),(()=>{let e=0,i=0;s.forEach((t=>{e+=t.loaded,i+=t.total})),t.fire("progress",e,i)})()},n=()=>{e.off("progress",i),e.off("load",n),e.off("error",n)};e.on("progress",i),e.on("load",n),e.on("error",n)}))};class bb{constructor(t,e){this.app=t,this.maxRetries=e}async loadTextures(t,e,s,i){const{assets:n}=this.app,r=["means","quats","scales","sh0","shN"],a={},o=[];r.forEach((e=>{const r=i[e]?.files??[];a[e]=r.map((e=>{const i=new pm(e,"texture",{url:s.options?.mapUrl?.(e)??new URL(e,new URL(t.load,window.location.href).toString()).toString(),filename:e},{mipmaps:!1}),r=new Promise(((t,e)=>{i.on("load",(()=>t(null))),i.on("error",(t=>e(t)))}));return n.add(i),o.push(r),i}))}));const l=r.map((t=>a[t])).flat();vb(s,l),l.forEach((t=>n.load(t))),await Promise.allSettled(o);const h=new Up;h.meta=i,h.numSplats=i.means.shape[0],h.means_l=a.means[0].resource,h.means_u=a.means[1].resource,h.quats=a.quats[0].resource,h.scales=a.scales[0].resource,h.sh0=a.sh0[0].resource,h.sh_centroids=a.shN?.[0]?.resource,h.sh_labels=a.shN?.[1]?.resource;const c=s.data?.decompress;c||await h.prepareGpuData();e(null,c?new Pp(this.app.graphicsDevice,await h.decompress()):new jp(this.app.graphicsDevice,h))}load(t,e,s){if(s.data?.means)this.loadTextures(t,e,s,s.data);else{"string"==typeof t&&(t={load:t,original:t});const i={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:Jo.ResponseType.JSON};tl.get(t.load,i,((i,n)=>{i?e(`Error loading gsplat meta: ${t.original} [${i}]`):this.loadTextures(t,e,s,n)}))}}}class yb extends Sm{constructor(t){super(t,"gsplat"),this.parsers={ply:new gb(t,3),json:new bb(t,3)}}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=ke.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.parsers.ply}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){return e}}function Sb(){const t=0,e=1,s=2,i=3,n=8,r=9,a=10,o=11,l=12,h=13,c=14,d=16,u={astc:a,dxt:s,etc1:t,etc2:t,pvr:n,atc:o,none:c},f={astc:a,dxt:i,etc1:d,etc2:e,pvr:r,atc:l,none:d},p=21,m=22,_=23,g=8,v=10,b=26,y=27,S=28,x=29,w=30,T=7,E=3,C=5,A=(u,f)=>{switch(u){case t:return f.formats.etc2?m:p;case e:return _;case s:return g;case i:return v;case n:return b;case r:return y;case a:return S;case o:return x;case l:return w;case h:return T;case c:return E;case d:return C}},D=t=>{const e=function(t,e){const s=t*(2/255)-1,i=e*(2/255)-1,n=Math.sqrt(1-Math.min(1,s*s+i*i));return Math.max(0,Math.min(255,Math.floor(.5*(n+1)*255)))};for(let s=0;s<t.length;s+=4){const i=t[s+3],n=t[s+1];t[s+0]=i,t[s+2]=e(i,n),t[s+3]=255}return t},P=t=>{const e=new Uint16Array(t.length/4);for(let s=0;s<t.length;s+=4){const i=t[s+0],n=t[s+1],r=t[s+2];e[s/4]=(248&i)<<8|(252&n)<<3|r>>3}return e},L=()=>"undefined"!=typeof performance?performance.now():0;let I,R,M;const k=(t,e,s)=>{if(s){if(t.formats.astc)return"astc"}else if(e){if(t.formats.etc2)return"etc2"}else{if(t.formats.etc2)return"etc2";if(t.formats.etc1)return"etc1"}return(e=>{for(let s=0;s<e.length;++s){const i=e[s];if(t.formats[i])return i}return"none"})(e?M:R)},O=(h,c,d)=>{switch(d){case t:case e:return!0;case s:case i:return!(3&h||3&c);case n:case r:return((t,e)=>!(t&t-1||e&e-1))(h,c);case a:case o:case l:return!0}return!1},F=(t,e,s)=>s.isKTX2?((t,e,s)=>{if(!I.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const i=L(),n=new I.KTX2File(new Uint8Array(e)),r=n.getWidth(),a=n.getHeight(),o=n.getLevels(),l=!!n.getHasAlpha(),p=n.isUASTC&&n.isUASTC();if(!r||!a||!o)throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${r} height=${a} levels=${o}`);const m=k(s.deviceDetails,l,p),_=!!s.isGGGR&&"pvr"===m;let g,v;if(_?g=h:(g=l?f[m]:u[m],O(r,a,g)||(g=l?h:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error(`Failed to start transcoding url=${t}`);const b=[];for(let e=0;e<o;++e){const s=n.getImageTranscodedSizeInBytes(e,0,0,g),i=new Uint8Array(s);if(!n.transcodeImage(i,e,0,0,g,0,-1,-1))throw n.close(),n.delete(),new Error(`Failed to transcode image url=${t}`);const r=g===c||g===d;b.push(r?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),_)for(g=c,v=0;v<b.length;++v)b[v]=P(D(b[v]));return{format:A(g,s.deviceDetails),width:r,height:a,levels:b,cubemap:!1,transcodeTime:L()-i,url:t,unswizzledGGGR:_}})(t,e,s):((t,e,s)=>{const i=L(),n=new I.BasisFile(new Uint8Array(e)),r=n.getImageWidth(0,0),a=n.getImageHeight(0,0),o=n.getNumImages(),l=n.getNumLevels(0),p=!!n.getHasAlpha(),m=n.isUASTC&&n.isUASTC();if(!(r&&a&&o&&l))throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${r} height=${a} images=${o} levels=${l}`);const _=k(s.deviceDetails,p,m),g=!!s.isGGGR&&"pvr"===_;let v,b;if(g?v=h:(v=p?f[_]:u[_],O(r,a,v)||(v=p?h:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error(`Failed to start transcoding url=${t}`);const y=[];for(let e=0;e<l;++e){const s=n.getImageTranscodedSizeInBytes(0,e,v),i=new Uint8Array(s);if(!n.transcodeImage(i,0,e,v,0,0)){if(e!==l-1||s!==y[e-1].buffer.byteLength)throw n.close(),n.delete(),new Error(`Failed to transcode image url=${t}`);i.set(new Uint8Array(y[e-1].buffer)),console.warn(`Failed to transcode last mipmap level, using previous level instead url=${t}`)}const r=v===c||v===d;y.push(r?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),g)for(v=c,b=0;b<y.length;++b)y[b]=P(D(y[b]));return{format:A(v,s.deviceDetails),width:r,height:a,levels:y,cubemap:!1,transcodeTime:L()-i,url:t,unswizzledGGGR:g}})(t,e,s),N=(t,e,s)=>{try{const i=F(t,e,s);i.levels=i.levels.map((t=>t.buffer)),self.postMessage({url:t,data:i},i.levels)}catch(e){self.postMessage({url:t,err:e},null)}},B=[];self.onmessage=t=>{const e=t.data;switch(e.type){case"init":s=e.config,i=()=>{for(let t=0;t<B.length;++t)N(B[t].url,B[t].data,B[t].options);B.length=0},self.BASIS(s.module?{instantiateWasm:(t,e)=>(WebAssembly.instantiate(s.module,t).then((t=>{e(t)})).catch((t=>{console.error(`instantiate failed + ${t}`)})),{})}:null).then((t=>{t.initializeBasis(),I=t,R=s.rgbPriority,M=s.rgbaPriority,i(null)}));break;case"transcode":I?N(e.url,e.data,e.options):B.push(e)}var s,i}}const xb=t=>({astc:!!t.extCompressedTextureASTC,atc:!!t.extCompressedTextureATC,dxt:!!t.extCompressedTextureS3TC,etc1:!!t.extCompressedTextureETC1,etc2:!!t.extCompressedTextureETC,pvr:!!t.extCompressedTexturePVRTC});class wb{constructor(t,e,s){this.queue=t,this.worker=new Worker(e.workerUrl),this.worker.addEventListener("message",(t=>{const e=t.data;this.queue.handleResponse(e.url,e.err,e.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:e}),this.eager=s}run(t){const e=[];t.data instanceof ArrayBuffer&&e.push(t.data),this.worker.postMessage({type:"transcode",url:t.url,format:t.format,data:t.data,options:t.options},e),this.eager&&this.queue.enqueueClient(this)}}const Tb=["etc2","etc1","astc","dxt","pvr","atc"],Eb=["astc","dxt","etc2","pvr","atc"],Cb=new class{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(t,e,s,i){if(this.callbacks.hasOwnProperty(t))this.callbacks[t].push(s);else{this.callbacks[t]=[s];const n={url:t,data:e,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(t){this.queue.length>0?t.run(this.queue.shift()):this.clients.push(t)}handleResponse(t,e,s){const i=this.callbacks[t];if(e)for(let t=0;t<i.length;++t)i[t](e);else{3===s.format||5===s.format?s.levels=s.levels.map((t=>new Uint16Array(t))):s.levels=s.levels.map((t=>new Uint8Array(t)));for(let t=0;t<i.length;++t)i[t](null,s)}delete this.callbacks[t]}};let Ab=null,Db=!1;function Pb(t){if(!Db){if(t){if(t.lazyInit)return void(Ab=t)}else t=Ab||{};if(!t.glueUrl||!t.wasmUrl||!t.fallbackUrl){const e=Ge.getConfig("BASIS");e&&(t={glueUrl:e.glueUrl,wasmUrl:e.wasmUrl,fallbackUrl:e.fallbackUrl,numWorkers:e.numWorkers})}if(t.glueUrl||t.wasmUrl||t.fallbackUrl){Db=!0;const e=Math.max(1,Math.min(16,t.numWorkers||1)),s=1===t.numWorkers||!t.hasOwnProperty("eagerWorkers")||t.eagerWorkers;t.rgbPriority=t.rgbPriority||Tb,t.rgbaPriority=t.rgbaPriority||Eb,t.maxRetries=t.hasOwnProperty("maxRetries")?t.maxRetries:5,((t,e)=>{const s=t=>{const e=["/* basis */",t,"",`(${Sb.toString()})()\n\n`].join("\n");return new Blob([e],{type:"application/javascript"})},i=(i,n)=>{e(null,{workerUrl:URL.createObjectURL(s(i)),module:n,rgbPriority:t.rgbPriority,rgbaPriority:t.rgbaPriority})},n={cache:!0,responseType:"text",retry:t.maxRetries>0,maxRetries:t.maxRetries};if(t.glueUrl&&t.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1})()){let s=null,r=null;tl.get(t.glueUrl,n,((t,n)=>{t?e(t):r?i(n,r):s=n}));const a=fetch(t.wasmUrl),o=()=>{a.then((t=>t.arrayBuffer())).then((t=>WebAssembly.compile(t))).then((t=>{s?i(s,t):r=t})).catch((t=>{e(t,null)}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(a).then((t=>{s?i(s,t):r=t})).catch((t=>{o()})):o()}else tl.get(t.fallbackUrl,n,((t,s)=>{t?e(t,null):i(s,null)}))})(t,((t,i)=>{if(t)console.error(`failed to initialize basis worker: ${t}`);else for(let t=0;t<e;++t)Cb.enqueueClient(new wb(Cb,i,s))}))}}}let Lb=null;function Ib(t,e,s,i,n){return Pb(),Lb||(Lb={formats:xb(t)}),Cb.enqueueJob(e,s,i,{deviceDetails:Lb,isGGGR:!!n?.isGGGR,isKTX2:!!n?.isKTX2}),Db}class Rb{load(t,e,s){throw new Error("not implemented")}open(t,e,s){throw new Error("not implemented")}}class Mb extends Rb{constructor(t,e){super(),this.device=e,this.maxRetries=0}load(t,e,s){const i=this.device;pm.fetchArrayBuffer(t.load,((n,r)=>{n?e(n):(n=>{Ib(i,t.load,n,e,{isGGGR:!!(8&s?.file?.variants?.basis?.opt)})||e(`Basis module not found. Asset [${s.name}](${s.getFileUrl()}) basis texture variant will not be loaded.`)})(r)}),s,this.maxRetries)}open(t,e,s,i={}){const n=i.srgb?js(e.format):e.format,r=new dn(s,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:n,cubemap:e.cubemap,levels:e.levels,...i});return r.upload(),r}}class kb extends Rb{constructor(t,e){super(),this.crossOrigin=t.prefix?"anonymous":null,this.maxRetries=0,this.device=e}load(t,e,s){const i=!!s?.file?.contents;if(i){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromBlob(new Blob([s.file.contents]),e);t={load:URL.createObjectURL(new Blob([s.file.contents])),original:t.original}}const n=(s,n)=>{i&&URL.revokeObjectURL(t.load),e(s,n)};let r;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?r=s.options.crossOrigin:hm.test(t.load)&&(r=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(t.load,t.original,r,n,s):this._loadImage(t.load,t.original,r,n,s)}open(t,e,s,i={}){const n=new dn(s,{name:t,width:e.width,height:e.height,format:i.srgb?Os:7,...i});return n.setSource(e),n}_loadImage(t,e,s,i,n){const r=new Image;s&&(r.crossOrigin=s);let a=0;const o=this.maxRetries;let l;const h=1048576;n?.fire("progress",0,h),r.onload=function(){n?.fire("progress",h,h),i(null,r)},r.onerror=function(){if(!l)if(o>0&&++a<=o){const s=100*Math.pow(2,a);console.log(`Error loading Texture from: '${e}' - Retrying in ${s}ms...`);const i=t.indexOf("?")>=0?"&":"?";l=setTimeout((()=>{r.src=`${t+i}retry=${Date.now()}`,l=null}),s)}else i(`Error loading Texture from: '${e}'`)},r.src=t}_loadImageBitmap(t,e,s,i,n){const r={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries,progress:n};tl.get(t,r,((t,e)=>{t?i(t):this._loadImageBitmapFromBlob(e,i)}))}_loadImageBitmapFromBlob(t,e){createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then((t=>e(null,t))).catch((t=>e(t)))}}const Ob=[1481919403,3140563232,169478669],Fb={33776:8,33778:9,33779:Ds,36196:21,37492:22,37496:23,35840:26,35841:Fs,35842:27,35843:Ns,32849:6,32856:7,35905:19,35907:Os,35898:ks,34843:11,34842:Ps};class Nb extends Rb{constructor(t){super(),this.maxRetries=0}load(t,e,s){pm.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s,i={}){const n=this.parse(e);if(!n)return null;const r=i.srgb?js(n.format):n.format,a=new dn(s,{name:t,addressU:n.cubemap?1:0,addressV:n.cubemap?1:0,width:n.width,height:n.height,format:r,cubemap:n.cubemap,levels:n.levels,...i});return a.upload(),a}parse(t){const e=new Uint32Array(t);if(Ob[0]!==e[0]||Ob[1]!==e[1]||Ob[2]!==e[2])return null;const s={glInternalFormat:e[7],pixelWidth:e[9],pixelHeight:e[10],pixelDepth:e[11],numberOfArrayElements:e[12],numberOfFaces:e[13],numberOfMipmapLevels:e[14],bytesOfKeyValueData:e[15]};if(s.pixelDepth>1)return null;if(0!==s.numberOfArrayElements)return null;const i=Fb[s.glInternalFormat];if(void 0===i)return null;let n=16+s.bytesOfKeyValueData/4;const r=s.numberOfFaces>1,a=[];for(let c=0;c<(s.numberOfMipmapLevels||1);c++){const s=e[n++];r&&a.push([]);const d=r?a[c]:a;for(let e=0;e<(r?6:1);++e)d.push((o=t,l=4*n,h=s,i===ks?new Uint32Array(o,l,h/4):new Uint8Array(o,l,h))),n+=s+3>>2}var o,l,h;return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:a,cubemap:r}}}const Bb=166;class Ub extends Rb{constructor(t,e){super(),this.maxRetries=0,this.device=e}load(t,e,s){pm.fetchArrayBuffer(t.load,((i,n)=>{i?e(i,n):this.parse(n,t,e,s)}),s,this.maxRetries)}open(t,e,s,i={}){const n=i.srgb?js(e.format):e.format,r=new dn(s,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:n,cubemap:e.cubemap,levels:e.levels,...i});return r.upload(),r}parse(t,e,s,i){const n=new We(t),r=[n.readU32be(),n.readU32be(),n.readU32be()];if(2873840728!==r[0]||540160187!==r[1]||218765834!==r[2])return null;const a={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},o={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},l=[];for(let t=0;t<Math.max(1,a.levelCount);++t)l.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;n.skip(8);const h=n.readU8();if(n.skip(o.dfdByteLength-9),n.skip(o.kvdByteLength),1===a.supercompressionScheme||h===Bb){Ib(this.device,e.load,t,s,{isGGGR:!!(8&i?.file?.variants?.basis?.opt),isKTX2:!0})||s(`Basis module not found. Asset [${i.name}](${i.getFileUrl()}) basis texture variant will not be loaded.`)}else s("unsupported KTX2 pixel format")}}class zb extends Rb{constructor(t){super(),this.maxRetries=0}load(t,e,s){pm.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s,i={}){const n=new Uint32Array(e,0,32),r=n[4],a=n[3],o=Math.max(n[7],1),l=4===n[20],h=n[21],c=n[22],d=65024===n[28],u=827611204,f=825438800,p=825439312;let m,_=!1,g=!1,v=!1,b=!1,y=null,S=1;if(l?h===u?(y=8,_=!0):894720068===h?(y=Ds,_=!0):113===h?(y=Ps,S=2):116===h?(y=Ls,S=4):826496069===h?(y=21,_=!0,g=!0):h===f||825504336===h?(y=h===f?Fs:Ns,_=!0,v=!0):h!==p&&825504848!==h||(y=h===p?26:27,_=!0,b=!0):32===c&&(y=7),!y)return m=new dn(s,{width:4,height:4,format:6,name:"dds-legacy-empty"}),m;m=new dn(s,{name:t,addressU:d?1:0,addressV:d?1:0,width:r,height:a,format:y,cubemap:d,mipmaps:o>1,...i});let x=128;const w=d?6:1;let T;const E=h===u?8:16;let C,A,D;for(let t=0;t<w;t++){let s=r,i=a;for(let n=0;n<o;n++){_?g?T=Math.floor((s+3)/4)*Math.floor((i+3)/4)*8:v?T=Math.max(s,16)*Math.max(i,8)/4:b?T=Math.max(s,8)*Math.max(i,8)/2:(C=Math.floor((s+4-1)/4),A=Math.floor((i+4-1)/4),D=C*A,T=D*E):T=s*i*4;const r=y===Ls?new Float32Array(e,x,T):y===Ps?new Uint16Array(e,x,T):new Uint8Array(e,x,T);d?(m._levels[n]||(m._levels[n]=[]),m._levels[n][t]=r):m._levels[n]=r,x+=T*S,s=Math.max(.5*s,1),i=Math.max(.5*i,1)}}return m.upload(),m}}class Vb extends Rb{constructor(t){super(),this.maxRetries=0}load(t,e,s){pm.fetchArrayBuffer(t.load,e,s,this.maxRetries),s.data&&!s.data.type&&(s.data.type=gi)}open(t,e,s,i={}){const n=this.parse(e);if(!n)return null;const r=new dn(s,{name:t,addressU:0,addressV:1,minFilter:0,magFilter:0,width:n.width,height:n.height,levels:n.levels,format:7,type:gi,mipmaps:!1,...i});return r.upload(),r}parse(t){const e=new We(t);if(!e.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const t=e.readLine();if(0===t.length)break;{const e=t.split("=");2===e.length&&(s[e[0]]=e[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const i=e.readLine().split(" ");if(4!==i.length)return null;const n=parseInt(i[1],10),r=parseInt(i[3],10),a=this._readPixels(e,r,n,"-Y"===i[0]);return a?{width:r,height:n,levels:[a]}:null}_readPixels(t,e,s,i){if(e<8||e>32767)return this._readPixelsFlat(t,e,s);const n=[0,0,0,0];if(t.readArray(n),2!==n[0]||2!==n[1]||128&n[2])return t.skip(-4),this._readPixelsFlat(t,e,s);const r=new ArrayBuffer(e*s*4),a=new Uint8Array(r);let o,l,h,c,d,u,f=i?0:4*e*(s-1);for(l=0;l<s;++l){if(l&&t.readArray(n),(n[2]<<8)+n[3]!==e)return null;for(c=0;c<4;++c)for(o=0;o<e;)if(d=t.readU8(),d>128){if(d-=128,o+d>e)return null;for(u=t.readU8(),h=0;h<d;++h)a[f+c+4*o++]=u}else{if(0===d||o+d>e)return null;for(h=0;h<d;++h)a[f+c+4*o++]=t.readU8()}f+=4*e*(i?1:-1)}return a}_readPixelsFlat(t,e,s){return t.remainingBytes===e*s*4?new Uint8Array(t.arraybuffer,t.offset):null}}const Hb={repeat:0,clamp:1,mirror:2},Gb={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Wb={default:mi,rgbm:_i,rgbe:gi,rgbp:vi,swizzleGGGR:bi};class jb extends Sm{constructor(t){super(t,"texture");const e=t.assets,s=t.graphicsDevice;this._device=s,this._assets=e,this.imgParser=new kb(e,s),this.parsers={dds:new zb(e),ktx:new Nb(e),ktx2:new Ub(e,s),basis:new Mb(e,s),hdr:new Vb(e)}}set crossOrigin(t){this.imgParser.crossOrigin=t}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(t){this.imgParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=ke.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.imgParser}_getTextureOptions(t){const e={};if(t){t.name?.length>0&&(e.name=t.name);const s=t.data;s.hasOwnProperty("minfilter")&&(e.minFilter=Gb[s.minfilter]),s.hasOwnProperty("magfilter")&&(e.magFilter=Gb[s.magfilter]),s.hasOwnProperty("addressu")&&(e.addressU=Hb[s.addressu]),s.hasOwnProperty("addressv")&&(e.addressV=Hb[s.addressv]),s.hasOwnProperty("mipmaps")&&(e.mipmaps=s.mipmaps),s.hasOwnProperty("anisotropy")&&(e.anisotropy=s.anisotropy),s.hasOwnProperty("flipY")&&(e.flipY=!!s.flipY),s.hasOwnProperty("srgb")&&(e.srgb=!!s.srgb),e.type=mi,s.hasOwnProperty("type")?e.type=Wb[s.type]:s.hasOwnProperty("rgbm")&&s.rgbm?e.type=_i:t.file&&8&t.file.opt&&(e.type=bi)}return e}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){if(!t)return;const i=this._getTextureOptions(s);let n=this._getParser(t).open(t,e,this._device,i);return null===n?n=new dn(this._device,{width:4,height:4,format:6}):(!function(t){const e=hn.calcMipLevelsCount(t._width,t._height);if(7!==t._format&&t._format!==Ls||t._volume||t._compressed||1===t._levels.length||t._levels.length===e||(s=t._cubemap?t._levels[0][0]:t._levels[0])instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement)return;var s;const i=function(t,e,s){const i=Math.max(1,t>>1),n=Math.max(1,e>>1),r=new s.constructor(i*n*4),a=Math.floor(t/i),o=Math.floor(e/n),l=a*o;for(let e=0;e<n;++e)for(let n=0;n<i;++n)for(let h=0;h<4;++h){let c=0;for(let i=0;i<o;++i)for(let r=0;r<a;++r)c+=s[4*(n*a+r+(e*o+i)*t)+h];r[4*(n+e*i)+h]=c/l}return r};for(let s=t._levels.length;s<e;++s){const e=Math.max(1,t._width>>s-1),n=Math.max(1,t._height>>s-1);if(t._cubemap){const r=[];for(let a=0;a<6;++a)r.push(i(e,n,t._levels[s-1][a]));t._levels.push(r)}else t._levels.push(i(e,n,t._levels[s-1]))}t._levelsUpdated=t._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}(n),e.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),n}patch(t,e){const s=t.resource;if(!s)return;const i=this._getTextureOptions(t);for(const t of Object.keys(i))s[t]=i[t]}}const Xb="immersive-ar",$b="viewer",qb="point",Kb="plane",Yb="mesh",Qb="gpu-optimized",Zb="luminance-alpha",Jb="unsigned-short",ty="float32";class ey{constructor(t){this._supported=Ue.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=t}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(t){this._supported&&!this._manager.active&&(this._root=t)}get root(){return this._root}}const sy=[],iy=[];class ny extends Ve{static{this.EVENT_REMOVE="remove"}static{this.EVENT_RESULT="result"}constructor(t,e,s,i=null){super(),this.manager=t,this._xrHitTestSource=e,this._transient=s,this._inputSource=i}remove(){if(!this._xrHitTestSource)return;const t=this.manager.hitTest.sources,e=t.indexOf(this);-1!==e&&t.splice(e,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(t){if(this._transient){const e=t.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let t=0;t<e.length;t++){const s=e[t];if(!s.results.length)continue;let i;s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else{const e=t.getHitTestResults(this._xrHitTestSource);if(!e.length)return;this.updateHitResults(e)}}updateHitResults(t,e){if(this._inputSource&&this._inputSource!==e)return;const s=sy.pop()??new rs;e?s.copy(e.getOrigin()):s.copy(this.manager.camera.getPosition());let i=1/0,n=null;const r=sy.pop()??new rs,a=iy.pop()??new ms;for(let e=0;e<t.length;e++){const o=t[e].getPose(this.manager._referenceSpace),l=s.distance(o.transform.position);l>=i||(i=l,n=t[e],r.copy(o.transform.position),a.copy(o.transform.orientation))}this.fire("result",r,a,e||this._inputSource,n),this.manager.hitTest.fire("result",this,r,a,e||this._inputSource,n),sy.push(s),sy.push(r),iy.push(a)}}class ry extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_RESULT="result"}static{this.EVENT_ERROR="error"}constructor(t){super(),this._supported=Ue.browser&&!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._available=!1,this._checkingAvailability=!1,this.sources=[],this.manager=t,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){if(this.manager.session.enabledFeatures){const t=-1!==this.manager.session.enabledFeatures.indexOf("hit-test");if(!t)return;this._available=t,this.fire("available")}else this._checkingAvailability||(this._checkingAvailability=!0,this.manager.session.requestReferenceSpace($b).then((t=>{this.manager.session.requestHitTestSource({space:t}).then((t=>{t.cancel(),this.manager.active&&(this._available=!0,this.fire("available"))})).catch((()=>{}))})).catch((()=>{})))}_onSessionEnd(){if(this._available){this._available=!1;for(let t=0;t<this.sources.length;t++)this.sources[t].onStop();this.sources=[],this.fire("unavailable")}}start(t={}){if(!this._supported)return void t.callback?.(new Error("XR HitTest is not supported"),null);if(!this._available)return void t.callback?.(new Error("XR HitTest is not available"),null);let e;t.profile||t.spaceType||(t.spaceType=$b);const s=t.offsetRay;if(s){const t=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),i=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);e=new XRRay(t,i)}const i=t.callback;t.spaceType?this.manager.session.requestReferenceSpace(t.spaceType).then((s=>{if(!this.manager.session){const t=new Error("XR Session is not started (2)");return i&&i(t),void this.fire("error",t)}this.manager.session.requestHitTestSource({space:s,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((e=>{this._onHitTestSource(e,!1,t.inputSource,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))})).catch((t=>{i&&i(t),this.fire("error",t)})):this.manager.session.requestHitTestSourceForTransientInput({profile:t.profile,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((e=>{this._onHitTestSource(e,!0,t.inputSource,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))}_onHitTestSource(t,e,s,i){if(!this.manager.session){t.cancel();const e=new Error("XR Session is not started (3)");return i&&i(e),void this.fire("error",e)}const n=new ny(this.manager,t,e,s??null);this.sources.push(n),i&&i(null,n),this.fire("add",n)}update(t){if(this._available)for(let e=0;e<this.sources.length;e++)this.sources[e].update(t)}get supported(){return this._supported}get available(){return this._available}}class ay extends Ve{static{this.EVENT_TRACKED="tracked"}static{this.EVENT_UNTRACKED="untracked"}constructor(t,e){super(),this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new rs,this._rotation=new ms,this._image=t,this._width=e}get image(){return this._image}set width(t){this._width=t}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then((t=>(this._bitmap=t,{image:this._bitmap,widthInMeters:this._width})))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}class oy extends Ve{static{this.EVENT_ERROR="error"}constructor(t){super(),this._supported=Ue.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=t,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(t,e){if(!this._supported||this._manager.active)return null;const s=new ay(t,e);return this._images.push(s),s}remove(t){if(this._manager.active)return;const e=this._images.indexOf(t);-1!==e&&(t.destroy(),this._images.splice(e,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then((t=>{this._available=!0;for(let e=0;e<t.length;e++)this._images[e]._trackable="trackable"===t[e]})).catch((t=>{this._available=!1,this.fire("error",t)}))}_onSessionEnd(){this._available=!1;for(let t=0;t<this._images.length;t++){const e=this._images[t];e._pose=null,e._measuredWidth=0,e._tracking&&(e._tracking=!1,e.fire("untracked"))}}prepareImages(t){this._images.length?Promise.all(this._images.map((t=>t.prepare()))).then((e=>{t(null,e)})).catch((e=>{t(e,null)})):t(null,null)}update(t){if(!this._available)return;const e=t.getImageTrackingResults(),s={};for(let i=0;i<e.length;i++){s[e[i].index]=e[i];const n=this._images[e[i].index];n._emulated="emulated"===e[i].trackingState,n._measuredWidth=e[i].measuredWidthInMeters,n._pose=t.getPose(e[i].imageSpace,this._manager._referenceSpace)}for(let t=0;t<this._images.length;t++)this._images[t]._tracking&&!s[t]?(this._images[t]._tracking=!1,this._images[t].fire("untracked")):!this._images[t]._tracking&&s[t]&&(this._images[t]._tracking=!0,this._images[t].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}class ly{constructor(t,e){this._joints=[],this._tip=null,this._index=t,this._hand=e,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const hy=Ue.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],cy={};for(let t=0;t<hy.length;t++)cy[hy[t]]=!0;class dy{constructor(t,e,s,i=null){this._radius=null,this._localTransform=new ps,this._worldTransform=new ps,this._localPosition=new rs,this._localRotation=new ms,this._position=new rs,this._rotation=new ms,this._dirtyLocal=!0,this._index=t,this._id=e,this._hand=s,this._finger=i,this._wrist="wrist"===e,this._tip=this._finger&&!!cy[e]}update(t){this._dirtyLocal=!0,this._radius=t.radius,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,rs.ONE));const t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get id(){return this._id}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let uy=[];const fy=new rs,py=new rs,my=new rs;Ue.browser&&window.XRHand&&(uy=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class _y extends Ve{static{this.EVENT_TRACKING="tracking"}static{this.EVENT_TRACKINGLOST="trackinglost"}constructor(t){super(),this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const e=t._xrInputSource.hand;if(this._manager=t._manager,this._inputSource=t,e.get("wrist")){const t=new dy(0,"wrist",this,null);this._wrist=t,this._joints.push(t),this._jointsById.wrist=t}for(let t=0;t<uy.length;t++){const s=new ly(t,this);for(let i=0;i<uy[t].length;i++){const n=uy[t][i];if(!e.get(n))continue;const r=new dy(i,n,this,s);this._joints.push(r),this._jointsById[n]=r,r.tip&&(this._tips.push(r),s._tip=r),s._joints.push(r)}}}update(t){const e=this._inputSource._xrInputSource;for(let s=0;s<this._joints.length;s++){const i=this._joints[s],n=e.hand.get(i._id);if(n){let e;if("hidden"!==t.session.visibilityState&&(e=t.getJointPose(n,this._manager._referenceSpace)),e)i.update(e),i.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(i.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],r=this._jointsById["index-finger-tip"],a=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&r&&a&&o){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,r._localPosition,.5);let t=s,e=o;if("left"===this._inputSource.handedness){const s=t;t=e,e=s}fy.sub2(t._localPosition,this._wrist._localPosition),py.sub2(e._localPosition,this._wrist._localPosition),my.cross(fy,py).normalize(),fy.lerp(n._localPosition,a._localPosition,.5),fy.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(my,fy,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(t){const e=this._fingers[t];return fy.sub2(e.joints[0]._localPosition,e.joints[1]._localPosition).normalize(),py.sub2(e.joints[2]._localPosition,e.joints[3]._localPosition).normalize(),fy.dot(py)<-.8}getJointById(t){return this._jointsById[t]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}const gy=new rs,vy=new ms;let by=0;class yy extends Ve{static{this.EVENT_REMOVE="remove"}static{this.EVENT_SELECT="select"}static{this.EVENT_SELECTSTART="selectstart"}static{this.EVENT_SELECTEND="selectend"}static{this.EVENT_SQUEEZE="squeeze"}static{this.EVENT_SQUEEZESTART="squeezestart"}static{this.EVENT_SQUEEZEEND="squeezeend"}static{this.EVENT_HITTESTADD="hittest:add"}static{this.EVENT_HITTESTREMOVE="hittest:remove"}static{this.EVENT_HITTESTRESULT="hittest:result"}constructor(t,e){super(),this._ray=new As,this._rayLocal=new As,this._grip=!1,this._hand=null,this._velocitiesAvailable=!1,this._velocitiesTimestamp=$e(),this._localTransform=null,this._worldTransform=null,this._position=new rs,this._rotation=new ms,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++by,this._manager=t,this._xrInputSource=e,e.hand&&(this._hand=new _y(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(t){this._elementInput!==t&&(this._elementInput=t,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(t){if(this._hand)this._hand.update(t);else{const e=this._xrInputSource.gripSpace;if(e){const s=t.getPose(e,this._manager._referenceSpace);if(s){this._grip||(this._grip=!0,this._localTransform=new ps,this._worldTransform=new ps,this._localPositionLast=new rs,this._localPosition=new rs,this._localRotation=new ms,this._linearVelocity=new rs);const t=$e(),e=(t-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=t,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(s.transform.position),this._localRotation.copy(s.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&s.linearVelocity?this._linearVelocity.copy(s.linearVelocity):e>0&&(gy.sub2(this._localPosition,this._localPositionLast).divScalar(e),this._linearVelocity.lerp(this._linearVelocity,gy,.15))}else this._velocitiesAvailable=!1}const s=t.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=!0,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),vy.copy(s.transform.orientation),vy.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,rs.ONE));const t=this._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const t=this._dirtyRay;this._dirtyRay=!1;if(this._manager.camera.parent){const t=this._manager.camera.parent.getWorldTransform();t.getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else t&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(t={}){t.inputSource=this,t.profile=this._xrInputSource.profiles[0];const e=t.callback;t.callback=(t,s)=>{s&&this.onHitTestSourceAdd(s),e&&e(t,s)},this._manager.hitTest.start(t)}onHitTestSourceAdd(t){this._hitTestSources.push(t),this.fire("hittest:add",t),t.on("result",((e,s,i,n)=>{i===this&&this.fire("hittest:result",t,e,s,n)})),t.once("remove",(()=>{this.onHitTestSourceRemove(t),this.fire("hittest:remove",t)}))}onHitTestSourceRemove(t){const e=this._hitTestSources.indexOf(t);-1!==e&&this._hitTestSources.splice(e,1)}}class Sy extends Ve{static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_SELECT="select"}static{this.EVENT_SELECTSTART="selectstart"}static{this.EVENT_SELECTEND="selectend"}static{this.EVENT_SQUEEZE="squeeze"}static{this.EVENT_SQUEEZESTART="squeezestart"}static{this.EVENT_SQUEEZEEND="squeezeend"}constructor(t){super(),this._inputSources=[],this.velocitiesSupported=!1,this.manager=t,this.velocitiesSupported=!(!Ue.browser||!window.XRPose?.prototype?.hasOwnProperty("linearVelocity")),this._onInputSourcesChangeEvt=t=>{this._onInputSourcesChange(t)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const t=this.manager.session;t.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),t.addEventListener("select",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("select",t),this.fire("select",e,t)})),t.addEventListener("selectstart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!0,e.fire("selectstart",t),this.fire("selectstart",e,t)})),t.addEventListener("selectend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!1,e.fire("selectend",t),this.fire("selectend",e,t)})),t.addEventListener("squeeze",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("squeeze",t),this.fire("squeeze",e,t)})),t.addEventListener("squeezestart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!0,e.fire("squeezestart",t),this.fire("squeezestart",e,t)})),t.addEventListener("squeezeend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!1,e.fire("squeezeend",t),this.fire("squeezeend",e,t)}));const e=t.inputSources;for(let t=0;t<e.length;t++)this._addInputSource(e[t])}_onSessionEnd(){let t=this._inputSources.length;for(;t--;){const e=this._inputSources[t];this._inputSources.splice(t,1),e.fire("remove"),this.fire("remove",e)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(t){for(let e=0;e<t.removed.length;e++)this._removeInputSource(t.removed[e]);for(let e=0;e<t.added.length;e++)this._addInputSource(t.added[e])}_getByInputSource(t){for(let e=0;e<this._inputSources.length;e++)if(this._inputSources[e].inputSource===t)return this._inputSources[e];return null}_addInputSource(t){if(this._getByInputSource(t))return;const e=new yy(this.manager,t);this._inputSources.push(e),this.fire("add",e)}_removeInputSource(t){for(let e=0;e<this._inputSources.length;e++){if(this._inputSources[e].inputSource!==t)continue;const s=this._inputSources[e];this._inputSources.splice(e,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();return s.fire("remove"),void this.fire("remove",s)}}update(t){for(let e=0;e<this._inputSources.length;e++)this._inputSources[e].update(t)}get inputSources(){return this._inputSources}}const xy=new rs,wy=new rs,Ty=new ps,Ey=new ps;class Cy extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_ERROR="error"}constructor(t){super(),this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new ms,this._color=new Ze,this._sphericalHarmonics=new Float32Array(27),this._manager=t,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let t;this._manager.session||(t=new Error("XR session is not running")),t||this._manager.type===Xb||(t=new Error("XR session type is not AR")),t||this._supported||(t=new Error("light-estimation is not supported")),(!t&&this._lightProbe||this._lightProbeRequested)&&(t=new Error("light estimation is already requested")),t?this.fire("error",t):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((t=>{const e=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?e&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))})).catch((t=>{this._lightProbeRequested=!1,this.fire("error",t)})))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(t){if(!this._lightProbe)return;const e=t.getLightEstimate(this._lightProbe);if(!e)return;this._available||(this._available=!0,this.fire("available"));const s=e.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),xy.copy(s).mulScalar(1/this._intensity),this._color.set(xy.x,xy.y,xy.z),xy.set(0,0,0),wy.copy(e.primaryLightDirection),Ty.setLookAt(wy,xy,rs.UP),Ey.setFromAxisAngle(rs.RIGHT,90),Ty.mul(Ey),this._rotation.setFromMat4(Ty),this._sphericalHarmonics.set(e.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}let Ay=0;class Dy extends Ve{static{this.EVENT_REMOVE="remove"}static{this.EVENT_CHANGE="change"}constructor(t,e){super(),this._position=new rs,this._rotation=new ms,this._id=++Ay,this._planeDetection=t,this._xrPlane=e,this._lastChangedTime=e.lastChangedTime,this._orientation=e.orientation}destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))}update(t){const e=this._planeDetection._manager,s=t.getPose(this._xrPlane.planeSpace,e._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}}class Py extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}constructor(t){super(),this._supported=Ue.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=[],this._manager=t,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){if(this._manager.session.enabledFeatures){-1!==this._manager.session.enabledFeatures.indexOf("plane-detection")&&(this._available=!0,this.fire("available"))}}_onSessionEnd(){for(let t=0;t<this._planes.length;t++)this._planes[t].destroy(),this.fire("remove",this._planes[t]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))}update(t){if(!this._available){if(this._manager.session.enabledFeatures||!t.detectedPlanes.size)return;this._available=!0,this.fire("available")}const e=t.detectedPlanes;for(const[t,s]of this._planesIndex)e.has(t)||(this._planesIndex.delete(t),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(const s of e){let e=this._planesIndex.get(s);e?e.update(t):(e=new Dy(this,s),this._planesIndex.set(s,e),this._planes.push(e),e.update(t),this.fire("add",e))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}class Ly extends Ve{static{this.EVENT_DESTROY="destroy"}static{this.EVENT_CHANGE="change"}static{this.EVENT_PERSIST="persist"}static{this.EVENT_FORGET="forget"}constructor(t,e,s=null){super(),this._position=new rs,this._rotation=new ms,this._uuid=null,this._uuidRequests=null,this._anchors=t,this._xrAnchor=e,this._uuid=s}destroy(){if(!this._xrAnchor)return;const t=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",t,this)}update(t){if(!this._xrAnchor)return;const e=t.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(e){if(this._position.equals(e.transform.position)&&this._rotation.equals(e.transform.orientation))return;this._position.copy(e.transform.position),this._rotation.copy(e.transform.orientation),this.fire("change")}}getPosition(){return this._position}getRotation(){return this._rotation}persist(t){this._anchors.persistence?this._uuid?t?.(null,this._uuid):this._uuidRequests?t&&this._uuidRequests.push(t):(this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then((e=>{this._uuid=e,this._anchors._indexByUuid.set(this._uuid,this),t?.(null,e);for(const t of this._uuidRequests)t(null,e);this._uuidRequests=null,this.fire("persist",e)})).catch((e=>{t?.(e,null);for(const t of this._uuidRequests)t(e,null);this._uuidRequests=null}))):t?.(new Error("Persistent Anchors are not supported"),null)}forget(t){this._uuid?this._anchors.forget(this._uuid,(e=>{this._uuid=null,t?.(e),this.fire("forget")})):t?.(new Error("Anchor is not persistent"))}get uuid(){return this._uuid}get persistent(){return!!this._uuid}}class Iy extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ERROR="error"}static{this.EVENT_ADD="add"}static{this.EVENT_DESTROY="destroy"}constructor(t){super(),this._supported=Ue.browser&&!!window.XRAnchor,this._available=!1,this._checkingAvailability=!1,this._persistence=Ue.browser&&!!window?.XRSession?.prototype.restorePersistentAnchor,this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=t,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const t=this.manager.session.enabledFeatures?.indexOf("anchors")>=0;t&&(this._available=t,this.fire("available"))}_onSessionEnd(){if(!this._available)return;this._available=!1;for(let t=0;t<this._creationQueue.length;t++)this._creationQueue[t].callback&&this._creationQueue[t].callback(new Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let t=this._list.length;for(;t--;)this._list[t].destroy();this._list.length=0,this.fire("unavailable")}_createAnchor(t,e=null){const s=new Ly(this,t,e);return this._index.set(t,s),e&&this._indexByUuid.set(e,s),this._list.push(s),s.once("destroy",this._onAnchorDestroy,this),s}_onAnchorDestroy(t,e){this._index.delete(t),e.uuid&&this._indexByUuid.delete(e.uuid);const s=this._list.indexOf(e);-1!==s&&this._list.splice(s,1),this.fire("destroy",e)}create(t,e,s){if(this._available)if(window.XRHitTestResult&&t instanceof XRHitTestResult){const i=t;if(s=e,!this._supported)return void s?.(new Error("Anchors API is not supported"),null);if(!i.createAnchor)return void s?.(new Error("Creating Anchor from Hit Test is not supported"),null);i.createAnchor().then((t=>{const e=this._createAnchor(t);s?.(null,e),this.fire("add",e)})).catch((t=>{s?.(t,null),this.fire("error",t)}))}else this._creationQueue.push({transform:new XRRigidTransform(t,e),callback:s});else s?.(new Error("Anchors API is not available"),null)}restore(t,e){this._available?this._persistence?this.manager.active?this.manager.session.restorePersistentAnchor(t).then((s=>{const i=this._createAnchor(s,t);e?.(null,i),this.fire("add",i)})).catch((t=>{e?.(t,null),this.fire("error",t)})):e?.(new Error("WebXR session is not active"),null):e?.(new Error("Anchor Persistence is not supported"),null):e?.(new Error("Anchors API is not available"),null)}forget(t,e){this._available?this._persistence?this.manager.active?this.manager.session.deletePersistentAnchor(t).then((()=>{e?.(null)})).catch((t=>{e?.(t),this.fire("error",t)})):e?.(new Error("WebXR session is not active")):e?.(new Error("Anchor Persistence is not supported")):e?.(new Error("Anchors API is not available"))}update(t){if(this._available){if(this._creationQueue.length){for(let e=0;e<this._creationQueue.length;e++){const s=this._creationQueue[e];t.createAnchor(s.transform,this.manager._referenceSpace).then((t=>{s.callback&&this._callbacksAnchors.set(t,s.callback)})).catch((t=>{s.callback&&s.callback(t,null),this.fire("error",t)}))}this._creationQueue.length=0}for(const[e,s]of this._index)t.trackedAnchors.has(e)||(this._index.delete(e),s.destroy());for(let e=0;e<this._list.length;e++)this._list[e].update(t);for(const e of t.trackedAnchors){if(this._index.has(e))continue;const s=this._createAnchor(e);s.update(t);const i=this._callbacksAnchors.get(e);i&&(this._callbacksAnchors.delete(e),i(null,s)),this.fire("add",s)}}else this.manager.session.enabledFeatures||this._checkingAvailability||(this._checkingAvailability=!0,t.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then((t=>{t.delete(),this.manager.active&&(this._available=!0,this.fire("available"))})).catch((()=>{})))}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return this._available&&this._persistence&&this.manager.active?this.manager.session.persistentAnchors:null}get list(){return this._list}}class Ry extends Ve{static{this.EVENT_REMOVE="remove"}static{this.EVENT_CHANGE="change"}constructor(t,e){super(),this._lastChanged=0,this._position=new rs,this._rotation=new ms,this._meshDetection=t,this._xrMesh=e,this._lastChanged=this._xrMesh.lastChangedTime}get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))}update(t){const e=this._meshDetection._manager,s=t.getPose(this._xrMesh.meshSpace,e._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}}class My extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}constructor(t){super(),this._supported=Ue.browser&&!!window.XRMesh,this._available=!1,this._index=new Map,this._list=[],this._manager=t,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}update(t){if(!this._available){if(this._manager.session.enabledFeatures||!t.detectedMeshes.size)return;this._available=!0,this.fire("available")}for(const e of t.detectedMeshes){let s=this._index.get(e);s?s.update(t):(s=new Ry(this,e),this._index.set(e,s),this._list.push(s),s.update(t),this.fire("add",s))}for(const e of this._index.values())t.detectedMeshes.has(e.xrMesh)||this._removeMesh(e)}_removeMesh(t){this._index.delete(t.xrMesh),this._list.splice(this._list.indexOf(t),1),t.destroy(),this.fire("remove",t)}_onSessionStart(){if(this._manager.session.enabledFeatures){const t=-1!==this._manager.session.enabledFeatures.indexOf("mesh-detection");if(!t)return;this._available=t,this.fire("available")}}_onSessionEnd(){if(this._available){this._available=!1;for(const t of this._index.values())this._removeMesh(t);this.fire("unavailable")}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}}class ky extends Ve{static{this.EVENT_DEPTHRESIZE="depth:resize"}constructor(t,e,s){super(),this._positionData=new Float32Array(3),this._viewport=new ls,this._projMat=new ps,this._projViewOffMat=new ps,this._viewMat=new ps,this._viewOffMat=new ps,this._viewMat3=new as,this._viewInvMat=new ps,this._viewInvOffMat=new ps,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new ps,this._manager=t,this._xrView=e;const i=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new dn(i,{format:6,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,width:this._xrCamera.width,height:this._xrCamera.height,name:`XrView-${this._xrView.eye}-Color`}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){const t=this._manager.views.depthGpuOptimized?0:1;this._textureDepth=new dn(i,{format:this._manager.views.depthPixelFormat,arrayLength:1===s?0:s,mipmaps:!1,addressU:1,addressV:1,minFilter:t,magFilter:t,width:4,height:4,name:`XrView-${this._xrView.eye}-Depth`});for(let t=0;t<this._textureDepth._levels.length;t++)this._textureDepth._levels[t]=this._emptyDepthBuffer;this._textureDepth.upload()}(this._textureColor||this._textureDepth)&&i.on("devicelost",this._onDeviceLost,this)}get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){return this._depthInfo?.rawValueToMeters||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(t,e){this._xrView=e,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);const s=t.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=s.x,this._viewport.y=s.y,this._viewport.z=s.width,this._viewport.w=s.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(t)}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;const t=this._manager.webglBinding;if(!t)return;const e=t.getCameraImage(this._xrCamera);if(!e)return;const s=this._manager.app.graphicsDevice,i=s.gl;if(this._frameBufferSource){const t=i.COLOR_ATTACHMENT0,n=this._xrCamera.width,r=this._xrCamera.height;s.setFramebuffer(this._frameBufferSource),i.framebufferTexture2D(i.FRAMEBUFFER,t,i.TEXTURE_2D,e,0),s.setFramebuffer(this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,t,i.TEXTURE_2D,this._textureColor.impl._glTexture,0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._frameBufferSource),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._frameBuffer),i.blitFramebuffer(0,r,n,0,0,0,n,r,i.COLOR_BUFFER_BIT,i.NEAREST)}else this._frameBufferSource=i.createFramebuffer(),this._frameBuffer=i.createFramebuffer()}_updateDepth(t){if(!this._manager.views.availableDepth||!this._textureDepth)return;const e=this._manager.views.depthGpuOptimized,s=e?this._manager.webglBinding:t;if(!s)return void(this._depthInfo=null);const i=s.getDepthInformation(this._xrView);if(!i)return void(this._depthInfo=null);let n=!this._depthInfo!=!i;this._depthInfo=i;const r=this._depthInfo?.width||4,a=this._depthInfo?.height||4;let o=!1;if(this._textureDepth.width===r&&this._textureDepth.height===a||(this._textureDepth._width=r,this._textureDepth._height=a,n=!0,o=!0),n&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo)if(e){if(this._depthInfo.texture){const t=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,"texture-array"===this._depthInfo.textureType?this._textureDepth.impl._glTarget=t.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=t.TEXTURE_2D,this._manager.views.depthPixelFormat){case Is:this._textureDepth.impl._glInternalFormat=t.R32F,this._textureDepth.impl._glPixelType=t.FLOAT,this._textureDepth.impl._glFormat=t.RED;break;case Rs:this._textureDepth.impl._glInternalFormat=t.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=t.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=t.DEPTH_COMPONENT}this._textureDepth.impl._glCreated=!0}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();o&&this.fire("depth:resize",r,a)}updateTransforms(t){t?(this._viewInvOffMat.mul2(t,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null}getDepth(t,e){return this._manager.views.depthGpuOptimized?null:this._depthInfo?.getDepthInMeters(t,e)??null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){const t=this._manager.app.graphicsDevice.gl;t.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,t.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}}}class Oy extends Ve{static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}constructor(t){super(),this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=Ue.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=Ue.browser&&!!window.XRDepthInformation,this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._depthFormats={[Zb]:2,[Jb]:Rs,[ty]:Is},this._manager=t,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===Qb}get depthFormat(){return this._depthFormat}get depthPixelFormat(){return this._depthFormats[this._depthFormat]??null}update(t,e){for(let t=0;t<e.length;t++)this._indexTmp.set(e[t].eye,e[t]);for(const[s,i]of this._indexTmp){let n=this._index.get(s);n?n.update(t,i):(n=new ky(this._manager,i,e.length),this._index.set(s,n),this._list.push(n),n.update(t,i),this.fire("add",n))}for(const[t,e]of this._index){if(this._indexTmp.has(t))continue;e.destroy(),this._index.delete(t);const s=this._list.indexOf(e);-1!==s&&this._list.splice(s,1),this.fire("remove",e)}this._indexTmp.clear()}get(t){return this._index.get(t)||null}_onSessionStart(){if(this._manager.type===Xb&&this._manager.session.enabledFeatures&&(this._availableColor=-1!==this._manager.session.enabledFeatures.indexOf("camera-access"),this._availableDepth=-1!==this._manager.session.enabledFeatures.indexOf("depth-sensing"),this._availableDepth)){const t=this._manager.session;this._depthUsage=t.depthUsage,this._depthFormat=t.depthDataFormat}}_onSessionEnd(){for(const t of this._index.values())t.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0}}class Fy extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_START="start"}static{this.EVENT_END="end"}static{this.EVENT_UPDATE="update"}static{this.EVENT_ERROR="error"}constructor(t){super(),this._supported=Ue.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this._camera=null,this._localPosition=new rs,this._localRotation=new ms,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=t,this._available.inline=!1,this._available["immersive-vr"]=!1,this._available[Xb]=!1,this.views=new Oy(this),this.domOverlay=new ey(this),this.hitTest=new ry(this),this.imageTracking=new oy(this),this.planeDetection=new Py(this),this.meshDetection=new My(this),this.input=new Sy(this),this.lightEstimation=new Cy(this),this.anchors=new Iy(this),this.views=new Oy(this),this._supported&&(navigator.xr.addEventListener("devicechange",(()=>{this._deviceAvailabilityCheck()})),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this))}destroy(){}start(t,e,s,i){let n=i;if("object"==typeof i&&(n=i.callback),!this._available[e])return void(n&&n(new Error("XR is not available")));if(this._session)return void(n&&n(new Error("XR session is already started")));this._camera=t,this._camera.camera.xr=this,this._type=e,this._spaceType=s,this._framebufferScaleFactor=i?.framebufferScaleFactor??1,this._setClipPlanes(t.nearClip,t.farClip);const r={requiredFeatures:[s],optionalFeatures:[]},a=this.app.graphicsDevice;a?.isWebGPU&&r.requiredFeatures.push("webgpu");const o=a?.isWebGL2;if(e===Xb){if(r.optionalFeatures.push("light-estimation"),r.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&r.optionalFeatures.push("image-tracking"),i.planeDetection&&r.optionalFeatures.push("plane-detection"),i.meshDetection&&r.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(r.optionalFeatures.push("dom-overlay"),r.domOverlay={root:this.domOverlay.root}),i&&i.anchors&&this.anchors.supported&&r.optionalFeatures.push("anchors"),i&&i.depthSensing&&this.views.supportedDepth){r.optionalFeatures.push("depth-sensing");const t=[],e=[];if(t.push(Qb,"cpu-optimized"),e.push(ty,Zb,Jb),i.depthSensing.usagePreference){const e=t.indexOf(i.depthSensing.usagePreference);-1!==e&&t.splice(e,1),t.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const t=e.indexOf(i.depthSensing.dataFormatPreference);-1!==t&&e.splice(t,1),e.unshift(i.depthSensing.dataFormatPreference)}r.depthSensing={usagePreference:t,dataFormatPreference:e}}o&&i&&i.cameraColor&&this.views.supportedColor&&r.optionalFeatures.push("camera-access")}r.optionalFeatures.push("hand-tracking"),i&&i.optionalFeatures&&(r.optionalFeatures=r.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(((t,i)=>{if(t)return n&&n(t),void this.fire("error",t);null!==i&&(r.trackedImages=i),this._onStartOptionsReady(e,s,r,n)})):this._onStartOptionsReady(e,s,r,n)}_onStartOptionsReady(t,e,s,i){navigator.xr.requestSession(t,s).then((t=>{this._onSessionStart(t,e,i)})).catch((t=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(t),this.fire("error",t)}))}end(t){this._session?(this.webglBinding=null,t&&this.once("end",t),this._session.end()):t&&t(new Error("XR Session is not initialized"))}isAvailable(t){return this._available[t]}_deviceAvailabilityCheck(){for(const t in this._available)this._sessionSupportCheck(t)}initiateRoomCapture(t){this._session?this._session.initiateRoomCapture?this._session.initiateRoomCapture().then((()=>{t&&t(null)})).catch((e=>{t&&t(e)})):t(new Error("Session does not support manual room capture")):t(new Error("Session is not active"))}updateTargetFrameRate(t,e){this._session?.updateTargetFrameRate?this._session.updateTargetFrameRate(t).then((()=>{e?.()})).catch((t=>{e?.(t)})):e?.(new Error("unable to update frameRate"))}_sessionSupportCheck(t){navigator.xr.isSessionSupported(t).then((e=>{this._available[t]!==e&&(this._available[t]=e,this.fire("available",t,e),this.fire(`available:${t}`,e))})).catch((t=>{this.fire("error",t)}))}_onSessionStart(t,e,s){let i=!1;this._session=t;const n=()=>{this.fire("visibility:change",t.visibilityState)},r=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},a=()=>{this._camera&&(this._camera.off("set_nearClip",r),this._camera.off("set_farClip",r),this._camera.camera.xr=null,this._camera=null),t.removeEventListener("end",a),t.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.tick()};t.addEventListener("end",a),t.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",r),this._camera.on("set_farClip",r),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",(()=>{this.fire("frameratechange",this._session?.frameRate)})),t.requestReferenceSpace(e).then((t=>{this._referenceSpace=t,this.app.tick(),s&&s(null),this.fire("start")})).catch((e=>{i=!0,t.end(),s&&s(e),this.fire("error",e)}))}_setClipPlanes(t,e){this._depthNear===t&&this._depthFar===e||(this._depthNear=t,this._depthFar=e,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}_createBaseLayer(){const t=this.app.graphicsDevice,e=t.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,t.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:e,antialias:!1}),t?.isWebGL2&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,t.gl)}catch(t){this.fire("error",t)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))}_onDeviceRestored(){this._session&&setTimeout((()=>{this.app.graphicsDevice.gl.makeXRCompatible().then((()=>{this._createBaseLayer()})).catch((t=>{this.fire("error",t)}))}),0)}update(t){if(!this._session)return!1;const e=t.session.renderState.baseLayer.framebufferWidth,s=t.session.renderState.baseLayer.framebufferHeight;this._width===e&&this._height===s||(this._width=e,this._height=s,this.app.graphicsDevice.setResolution(e,s));const i=t.getViewerPose(this._referenceSpace);if(!i)return!1;const n=this.views.list.length;this.views.update(t,i.views);const r=i.transform.position,a=i.transform.orientation;if(this._localPosition.set(r.x,r.y,r.z),this._localRotation.set(a.x,a.y,a.z,a.w),0===n&&this.views.list.length>0){const t=new ps,e=this.views.list[0];t.copy(e.projMat);const s=t.data,i=2*Math.atan(1/s[5])*180/Math.PI,n=s[5]/s[0],r=s[14]/(s[10]+1),a=s[14]/(s[10]-1),o=!1;this._camera.camera.setXrProperties({aspectRatio:n,farClip:r,fov:i,horizontalFov:o,nearClip:a})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(t),this._type===Xb&&(this.hitTest.supported&&this.hitTest.update(t),this.lightEstimation.supported&&this.lightEstimation.update(t),this.imageTracking.supported&&this.imageTracking.update(t),this.anchors.supported&&this.anchors.update(t),this.planeDetection.supported&&this.planeDetection.update(t),this.meshDetection.supported&&this.meshDetection.update(t)),this.fire("update",t),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){return this._session?.frameRate??null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(t){null!==(this._baseLayer?.fixedFoveation??null)&&(this._baseLayer.fixedFoveation=t)}get fixedFoveation(){return this._baseLayer?.fixedFoveation??null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}const Ny=[],By=[[],[],[]];class Uy extends Ao{constructor(t,e){super(t),this.viewBindGroups=[],this.renderer=e}destroy(){this.viewBindGroups.forEach((t=>{t.defaultUniformBuffer.destroy(),t.destroy()})),this.viewBindGroups.length=0}update(t,e,s,i){this.camera=t,this.scene=e,this.layers=s,this.mapping=i}execute(){const t=this.device,{renderer:e,camera:s,scene:i,layers:n,mapping:r,renderTarget:a}=this,o=i.layers.layerList,l=i.layers.subLayerEnabled,h=i.layers.subLayerList;for(let c=0;c<o.length;c++){const d=o[c];if(!(n&&n.indexOf(d)<0)&&(d.enabled&&l[c]&&d.camerasSet.has(s.camera))){const n=h[c];d._clearDepthBuffer&&e.clear(s.camera,!1,!0,!1);const o=d.meshInstances;for(let t=0;t<o.length;t++){const e=o[t];e.pick&&e.transparent===n&&(Ny.push(e),r.set(e.id,e))}if(Ny.length>0){if(i.clusteredLightingEnabled){e.worldClustersAllocator.empty.activate()}e.setCameraUniforms(s.camera,a),t.supportsUniformBuffers&&e.setupViewUniformBuffers(this.viewBindGroups,e.viewUniformFormat,e.viewBindGroupFormat,null),e.renderForward(s.camera,a,Ny,By,3,(e=>{t.setBlendState(Sn.NOBLEND)})),Ny.length=0}}}}}const zy=new Set,Vy=new ls;let Hy=class{constructor(t,e,s){this.renderTarget=null,this.mapping=new Map,this.deviceValid=!0,this.renderer=t.renderer,this.device=t.graphicsDevice,this.renderPass=new Uy(this.device,t.renderer),this.width=0,this.height=0,this.resize(e,s),this.device.on("destroy",(()=>{this.deviceValid=!1}))}getSelection(t,e,s=1,i=1){const n=this.device;if(n.isWebGPU)return[];e=this.renderTarget.height-(e+i);const r=this.sanitizeRect(t,e,s,i);n.setRenderTarget(this.renderTarget),n.updateBegin();const a=new Uint8Array(4*r.z*r.w);return n.readPixels(r.x,r.y,r.z,r.w,a),n.updateEnd(),this.decodePixels(a,this.mapping)}getSelectionAsync(t,e,s=1,i=1){this.device?.isWebGL2&&(e=this.renderTarget.height-(e+i));const n=this.sanitizeRect(t,e,s,i);return this.renderTarget.colorBuffer.read(n.x,n.y,n.z,n.w,{renderTarget:this.renderTarget,immediate:!0}).then((t=>this.decodePixels(t,this.mapping)))}sanitizeRect(t,e,s,i){const n=this.renderTarget.width,r=this.renderTarget.height;return t=Qe.clamp(Math.floor(t),0,n-1),e=Qe.clamp(Math.floor(e),0,r-1),s=Math.floor(Math.max(s,1)),s=Math.min(s,n-t),i=Math.floor(Math.max(i,1)),i=Math.min(i,r-e),Vy.set(t,e,s,i)}decodePixels(t,e){const s=[];if(this.deviceValid){const i=t.length;for(let s=0;s<i;s+=4){const i=t[s+0],n=t[s+1],r=t[s+2],a=(t[s+3]<<24|i<<16|n<<8|r)>>>0;4294967295!==a&&zy.add(e.get(a))}zy.forEach((t=>{t&&s.push(t)})),zy.clear()}return s}allocateRenderTarget(){const t=new dn(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"pick"});this.renderTarget=new Hn({colorBuffer:t,depth:!0})}releaseRenderTarget(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}prepare(t,e,s){s instanceof wu&&(s=[s]),this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.mapping.clear();const i=this.renderPass;i.init(this.renderTarget),i.colorOps.clearValue=Ze.WHITE,i.colorOps.clear=!0,i.depthStencilOps.clearDepth=!0,i.update(t,e,s,this.mapping),i.render()}resize(t,e){this.width=Math.floor(t),this.height=Math.floor(e)}};os.prototype.scale=os.prototype.mulScalar,rs.prototype.scale=rs.prototype.mulScalar,ls.prototype.scale=ls.prototype.mulScalar,Object.defineProperties(Hn.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(t){}}}),Object.defineProperty(Nn,"defaultInstancingFormat",{get:function(){return null}}),Object.defineProperties(dn.prototype,{rgbm:{get:function(){return this.type===_i},set:function(t){this.type=t?_i:mi}},swizzleGGGR:{get:function(){return this.type===bi},set:function(t){this.type=t?bi:mi}},_glTexture:{get:function(){return this.impl._glTexture}}}),Object.defineProperty(zn.prototype,"boneLimit",{get:function(){return 1024}}),Object.defineProperty(zn.prototype,"webgl2",{get:function(){return this.isWebGL2}}),Object.defineProperty(zn.prototype,"textureFloatHighPrecision",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"extBlendMinmax",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"extTextureHalfFloat",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"extTextureLod",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"textureHalfFloatFilterable",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"supportsMrt",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"supportsVolumeTextures",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"supportsInstancing",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"textureHalfFloatUpdatable",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"extTextureFloat",{get:function(){return!0}}),Object.defineProperty(zn.prototype,"extStandardDerivatives",{get:function(){return!0}}),Sn.DEFAULT=Object.freeze(new Sn);const Gy=new Sn,Wy=new Tn;function jy(t,e,s=""){Object.defineProperty(t.prototype,e,{set:function(t){},get:function(){}})}function Xy(t,e){Object.defineProperty(Jf.prototype,e,{get:function(){return this[t]},set:function(e){this[t]=e}})}function $y(t){Object.defineProperty(Jf.prototype,t,{get:function(){return!0},set:function(t){}})}function qy(t,e){"pass"!==t&&Object.defineProperty(Uf.prototype,t,{get:function(){return this.litOptions[e||t]},set:function(s){this.litOptions[e||t]=s}})}zn.prototype.setBlendFunction=function(t,e){const s=this.blendState;Gy.copy(s),Gy.setColorBlend(s.colorOp,t,e),Gy.setAlphaBlend(s.alphaOp,t,e),this.setBlendState(Gy)},zn.prototype.setBlendFunctionSeparate=function(t,e,s,i){const n=this.blendState;Gy.copy(n),Gy.setColorBlend(n.colorOp,t,e),Gy.setAlphaBlend(n.alphaOp,s,i),this.setBlendState(Gy)},zn.prototype.setBlendEquation=function(t){const e=this.blendState;Gy.copy(e),Gy.setColorBlend(t,e.colorSrcFactor,e.colorDstFactor),Gy.setAlphaBlend(t,e.alphaSrcFactor,e.alphaDstFactor),this.setBlendState(Gy)},zn.prototype.setBlendEquationSeparate=function(t,e){const s=this.blendState;Gy.copy(s),Gy.setColorBlend(t,s.colorSrcFactor,s.colorDstFactor),Gy.setAlphaBlend(e,s.alphaSrcFactor,s.alphaDstFactor),this.setBlendState(Gy)},zn.prototype.setColorWrite=function(t,e,s,i){const n=this.blendState;Gy.copy(n),Gy.setColorWrite(t,e,s,i),this.setBlendState(Gy)},zn.prototype.getBlending=function(){return this.blendState.blend},zn.prototype.setBlending=function(t){Gy.copy(this.blendState),Gy.blend=t,this.setBlendState(Gy)},zn.prototype.setDepthWrite=function(t){Wy.copy(this.depthState),Wy.write=t,this.setDepthState(Wy)},zn.prototype.setDepthFunc=function(t){Wy.copy(this.depthState),Wy.func=t,this.setDepthState(Wy)},zn.prototype.setDepthTest=function(t){Wy.copy(this.depthState),Wy.test=t,this.setDepthState(Wy)},zn.prototype.getCullMode=function(){return this.cullMode},new Proxy({},{get:(t,e)=>Ch.get(Kp().graphicsDevice,Ai).get(e),set:(t,e,s)=>(Ch.get(Kp().graphicsDevice,Ai).set(e,s),!0)}),Object.defineProperty(If.prototype,"defaultMaterial",{get:function(){return Xh(Kp().graphicsDevice)}}),Object.defineProperty(If.prototype,"fogColor",{set:function(t){this.fog.color=t},get:function(){return this.fog.color}}),Object.defineProperty(If.prototype,"fogEnd",{set:function(t){this.fog.end=t},get:function(){return this.fog.end}}),Object.defineProperty(If.prototype,"fogStart",{set:function(t){this.fog.start=t},get:function(){return this.fog.start}}),Object.defineProperty(If.prototype,"fogDensity",{set:function(t){this.fog.density=t},get:function(){return this.fog.density}}),Object.defineProperty(If.prototype,"toneMapping",{set:function(t){},get:function(){}}),Object.defineProperty(If.prototype,"gammaCorrection",{set:function(t){},get:function(){}}),Object.defineProperty(If.prototype,"rendering",{set:function(t){},get:function(){}}),Object.defineProperty(Cu.prototype,"_meshInstances",{get:function(){return null}}),Object.defineProperty(If.prototype,"drawCalls",{get:function(){return null}}),["128","64","32","16","8","4"].forEach(((t,e)=>{Object.defineProperty(If.prototype,`skyboxPrefiltered${t}`,{get:function(){return this._prefilteredCubemaps[e]},set:function(t){this._prefilteredCubemaps[e]=t,this.updateShaders=!0}})})),Object.defineProperty(If.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),jy(wu,"renderTarget"),jy(wu,"onPreCull"),jy(wu,"onPreRender"),jy(wu,"onPreRenderOpaque"),jy(wu,"onPreRenderTransparent"),jy(wu,"onPostCull"),jy(wu,"onPostRender"),jy(wu,"onPostRenderOpaque"),jy(wu,"onPostRenderTransparent"),jy(wu,"onDrawCall"),jy(wu,"layerReference"),jy(Eg,"onPreCull","Use Scene#EVENT_PRECULL event instead."),jy(Eg,"onPostCull","Use Scene#EVENT_POSTCULL event instead."),jy(Eg,"onPreRender","Use Scene#EVENT_PRERENDER event instead."),jy(Eg,"onPostRender","Use Scene#EVENT_POSTRENDER event instead."),jy(Eg,"onPreRenderLayer","Use Scene#EVENT_PRERENDER_LAYER event instead."),jy(Eg,"onPostRenderLayer","Use Scene#EVENT_POSTRENDER_LAYER event instead."),gu.prototype.renderComposition=function(t){Kp().renderComposition(t)},nc.prototype.syncAabb=function(){},zu.prototype.getTarget=function(t){return this.targets[t]},Mc.prototype.getChildren=function(){return this.children},Mc.prototype.getName=function(){return this.name},Mc.prototype.getPath=function(){return this.path},Mc.prototype.getRoot=function(){return this.root},Mc.prototype.getParent=function(){return this.parent},Mc.prototype.setName=function(t){this.name=t},Object.defineProperty(_d.prototype,"shader",{set:function(t){},get:function(){return null}}),Object.defineProperty(_d.prototype,"blend",{set:function(t){this.blendState.blend=t},get:function(){return this.blendState.blend}}),Object.defineProperty(Jf.prototype,"shininess",{get:function(){return 100*this.gloss},set:function(t){this.gloss=.01*t}}),Object.defineProperty(Jf.prototype,"useGammaTonemap",{get:function(){return this.useTonemap},set:function(t){this.useTonemap=t}}),Object.defineProperty(Jf.prototype,"anisotropy",{get:function(){const t=Math.sign(Math.cos(this.anisotropyRotation*Qe.DEG_TO_RAD*2));return this.anisotropyIntensity*t},set:function(t){this.anisotropyIntensity=Math.abs(t),this.anisotropyRotation=t>=0?0:90}}),$y("sheenTint"),$y("diffuseTint"),$y("emissiveTint"),$y("ambientTint"),Xy("specularTint","specularMapTint"),Xy("aoVertexColor","aoMapVertexColor"),Xy("diffuseVertexColor","diffuseMapVertexColor"),Xy("specularVertexColor","specularMapVertexColor"),Xy("emissiveVertexColor","emissiveMapVertexColor"),Xy("metalnessVertexColor","metalnessMapVertexColor"),Xy("glossVertexColor","glossMapVertexColor"),Xy("opacityVertexColor","opacityMapVertexColor"),Xy("lightVertexColor","lightMapVertexColor"),Xy("sheenGloss","sheenGlossiess"),Xy("clearCoatGloss","clearCostGlossiness"),qy("refraction","useRefraction");const Ky=new kf,Yy=Object.getOwnPropertyNames(Ky);for(const t in Yy)qy(Yy[t]);_m.prototype.getAssetById=function(t){return this.get(t)},Object.defineProperty(yy.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(yy.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(yy.prototype,"rotation",{get:function(){return this._localRotation}});Object.defineProperty(qo.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Bm.prototype.isFullscreen=function(){return!!document.fullscreenElement},Bm.prototype.enableFullscreen=function(t,e,s){t=t||this.graphicsDevice.canvas;const i=function(){e(),document.removeEventListener("fullscreenchange",i)},n=function(){s(),document.removeEventListener("fullscreenerror",n)};e&&document.addEventListener("fullscreenchange",i,!1),s&&document.addEventListener("fullscreenerror",n,!1),t.requestFullscreen?t.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):s()},Bm.prototype.disableFullscreen=function(t){const e=function(){t(),document.removeEventListener("fullscreenchange",e)};t&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()},Bm.prototype.getSceneUrl=function(t){const e=this.scenes.find(t);return e?e.url:null},Bm.prototype.loadScene=function(t,e){this.scenes.loadScene(t,e)},Bm.prototype.loadSceneHierarchy=function(t,e){this.scenes.loadSceneHierarchy(t,e)},Bm.prototype.loadSceneSettings=function(t,e){this.scenes.loadSceneSettings(t,e)},class extends t_{constructor(t,e){super(t,e),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._layers=[0],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._material=t.defaultMaterial,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(t){this._model&&(this._model.meshInstances=t)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(t){if(this._customAabb=t,this._model){const t=this._model.meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(t){if(this._type!==t)if(this._area=null,this._type=t,"asset"===t)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{const e=Y_(this.system.app.graphicsDevice,t);this._area=e.area;const s=e.mesh,i=new Mc,n=new Uu;n.graph=i,n.meshInstances=[new nc(s,this._material,i)],this.model=n,this._asset=null}}get type(){return this._type}set asset(t){const e=this.system.app.assets;let s=t;if(t instanceof pm&&(s=t.id),this._asset!==s){if(this._asset){e.off(`add:${this._asset}`,this._onModelAssetAdded,this);const t=e.get(this._asset);t&&this._unbindModelAsset(t)}if(this._asset=s,this._asset){const t=e.get(this._asset);t?this._bindModelAsset(t):(this.model=null,e.on(`add:${this._asset}`,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(t){if(this._model!==t&&(!t||!t._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=t,this._model)){this._model._immutable=!0;const t=this._model.meshInstances;for(let e=0;e<t.length;e++)t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(t){if(t!==this._lightmapped&&(this._lightmapped=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows===t)return;const e=this._model;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e.meshInstances)}const n=e.meshInstances;for(let e=0;e<n.length;e++)n[e].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters(e.meshInstances)}}this._castShadows=t}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t&&(this._receiveShadows=t,this._model)){const e=this._model.meshInstances;for(let s=0,i=e.length;s<i;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(t){const e=this.system.app.scene.layers;if(this.meshInstances)for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(t){this._batchGroupId!==t&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(Bh.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&this.system.app.batcher?.insert(Bh.MODEL,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=t)}get batchGroupId(){return this._batchGroupId}set materialAsset(t){let e=t;t instanceof pm&&(e=t.id);const s=this.system.app.assets;if(e!==this._materialAsset){if(this._materialAsset){s.off(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this);const t=s.get(this._materialAsset);t&&this._unbindMaterialAsset(t)}if(this._materialAsset=e,this._materialAsset){const t=s.get(this._materialAsset);t?this._bindMaterialAsset(t):(this._setMaterial(this.system.defaultMaterial),s.on(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(t){this._material!==t&&(this.materialAsset=null,this._setMaterial(t))}get material(){return this._material}set mapping(t){if("asset"!==this._type)return;if(this._unsetMaterialEvents(),t||(t={}),this._mapping=t,!this._model)return;const e=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let n=null;for(let s=0,r=e.length;s<r;s++)if(void 0!==t[s])t[s]?(n=this.system.app.assets.get(t[s]),this._loadAndSetMeshInstanceMaterial(n,e[s],s)):e[s].material=this.system.defaultMaterial;else if(i)if(i[s]&&(i[s].material||i[s].path)){if(void 0!==i[s].material)n=this.system.app.assets.get(i[s].material);else if(void 0!==i[s].path){const t=this._getMaterialAssetUrl(i[s].path);t&&(n=this.system.app.assets.getByUrl(t))}this._loadAndSetMeshInstanceMaterial(n,e[s],s)}else e[s].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this.meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this.meshInstances)}_setMaterialEvent(t,e,s,i){const n=`${e}:${s}`;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[t]||(this._materialEvents[t]={}),this._materialEvents[t][n]={id:s,handler:i}}_unsetMaterialEvents(){const t=this.system.app.assets,e=this._materialEvents;if(e){for(let s=0,i=e.length;s<i;s++){if(!e[s])continue;const i=e[s];for(const e in i)t.off(e,i[e].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(t){let e=null;if(isNaN(parseInt(t,10))){if(this.asset){const s=this._getMaterialAssetUrl(t);s&&(e=this.system.app.assets.getByUrl(s))}}else e=this.system.app.assets.get(t);return e}_getMaterialAssetUrl(t){if(!this.asset)return null;const e=this.system.app.assets.get(this.asset);return e?e.getAbsoluteUrl(t):null}_loadAndSetMeshInstanceMaterial(t,e,s){const i=this.system.app.assets;t&&(t.resource?(e.material=t.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=this.system.defaultMaterial}))):(this._setMaterialEvent(s,"load",t.id,(function(i){e.material=i.resource,this._setMaterialEvent(s,"remove",t.id,(function(){e.material=this.system.defaultMaterial}))})),this.enabled&&this.entity.enabled&&i.load(t)))}onEnable(){const t=this.system.app,e=t.scene,s=e?.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));const i="asset"===this._type;let n;if(this._model?this.addModelToLayers():i&&this._asset&&(n=t.assets.get(this._asset),n&&n.resource!==this._model&&this._bindModelAsset(n)),this._materialAsset&&(n=t.assets.get(this._materialAsset),n&&n.resource!==this._material&&this._bindMaterialAsset(n)),i&&this._mapping)for(const e in this._mapping)this._mapping[e]&&(n=this._getAssetByIdOrPath(this._mapping[e]),n&&!n.resource&&t.assets.load(n));this._batchGroupId>=0&&t.batcher?.insert(Bh.MODEL,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&t.batcher?.remove(Bh.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()}hide(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!1}}show(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!0}}_bindMaterialAsset(t){if(t.on("load",this._onMaterialAssetLoad,this),t.on("unload",this._onMaterialAssetUnload,this),t.on("remove",this._onMaterialAssetRemove,this),t.on("change",this._onMaterialAssetChange,this),t.resource)this._onMaterialAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMaterialAsset(t){t.off("load",this._onMaterialAssetLoad,this),t.off("unload",this._onMaterialAssetUnload,this),t.off("remove",this._onMaterialAssetRemove,this),t.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(t){this.system.app.assets.off(`add:${t.id}`,this._onMaterialAssetAdd,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_onMaterialAssetLoad(t){this._setMaterial(t.resource)}_onMaterialAssetUnload(t){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(t){this._onMaterialAssetUnload(t)}_onMaterialAssetChange(t){}_bindModelAsset(t){if(this._unbindModelAsset(t),t.on("load",this._onModelAssetLoad,this),t.on("unload",this._onModelAssetUnload,this),t.on("change",this._onModelAssetChange,this),t.on("remove",this._onModelAssetRemove,this),t.resource)this._onModelAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindModelAsset(t){t.off("load",this._onModelAssetLoad,this),t.off("unload",this._onModelAssetUnload,this),t.off("change",this._onModelAssetChange,this),t.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(t){this.system.app.assets.off(`add:${t.id}`,this._onModelAssetAdded,this),t.id===this._asset&&this._bindModelAsset(t)}_onModelAssetLoad(t){this.model=t.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(t){this.model=null}_onModelAssetChange(t,e,s,i){"data"===e&&(this.mapping=this._mapping)}_onModelAssetRemove(t){this.model=null}_setMaterial(t){if(this._material===t)return;this._material=t;const e=this._model;if(e&&"asset"!==this._type){const s=e.meshInstances;for(let e=0,i=s.length;e<i;e++)s[e].material=t}}}.prototype.setVisible=function(t){this.enabled=t},Object.defineProperty(fg.prototype,"bodyType",{get:function(){return this.type},set:function(t){this.type=t}}),fg.prototype.syncBodyToEntity=function(){this._updateDynamic()},xg.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};class Qy{constructor(t){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=!0,t.on("frameupdate",this.begin.bind(this,"update")),t.on("framerender",this.mark.bind(this,"render")),t.on("frameend",this.mark.bind(this,"other"))}begin(t){if(!this.enabled)return;this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);const e=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=e,this._frameIndex=0,this.mark(t)}mark(t){if(!this.enabled)return;const e=$e();if(this._frameIndex>0){const t=this._frameTimings[this._frameIndex-1];t[1]=e-t[1]}else if(this._timings.length>0){const t=this._timings[this._timings.length-1];t[1]=e-t[1]}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([t,e]);else{const s=this._frameTimings[this._frameIndex];s[0]=t,s[1]=e}this._frameIndex++}get timings(){return this._timings.slice(0,-1).map((t=>t[1]))}}class Zy{constructor(t){this.device=t,t.gpuProfiler.enabled=!0,this.enabled=!0,this.unitsName="ms",this.decimalPlaces=1,this._timings=[]}get timings(){return this._timings[0]=this.device.gpuProfiler._frameTime,this._timings}}class Jy{constructor(t,e,s,i,n){this.app=t,this.values=[],this.statNames=e,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=i,this.decimalPlaces=s,this.multiplier=n||1;const r=(t,e)=>t.split(".").reduce(((t,e)=>t?t[e]:null),e||this);t.on("frameupdate",(t=>{for(let t=0;t<this.statNames.length;t++)this.values[t]=r(this.statNames[t],this.app.stats)*this.multiplier}))}get timings(){return this.values}}class tS{constructor(t,e,s,i,n){this.app=e,this.name=t,this.device=e.graphicsDevice,this.timer=n,this.watermark=s,this.enabled=!1,this.textRefreshRate=i,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.counter=0,this.app.on("frameupdate",this.update,this)}destroy(){this.app.off("frameupdate",this.update,this)}loseContext(){this.timer&&"function"==typeof this.timer.loseContext&&this.timer.loseContext()}update(t){const e=this.timer.timings,s=e.reduce(((t,e)=>t+e),0);if(this.avgTotal+=s,this.avgTimer+=t,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){let t=0;const s=1.5*this.watermark;for(let i=0;i<e.length;++i)t+=Math.floor(e[i]/s*255),this.sample[i]=t;this.sample[3]=this.watermark/s*255;this.texture.lock().set(this.sample,4*(this.cursor+this.yOffset*this.texture.width)),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}}render(t,e,s,i,n){t.quad(e+i,s,-i,n,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-i,0,this.texture,0)}}class eS{constructor(t,e){const s=t=>{t.font='10px "Lucida Console", Monaco, monospace',t.textAlign="left",t.textBaseline="alphabetic"},i=document.createElement("canvas"),n=i.getContext("2d",{alpha:!0});s(n);const r=new Map;let a=5,o=5;e.forEach((t=>{const e=n.measureText(t),s=Math.ceil(-e.actualBoundingBoxLeft),i=Math.ceil(e.actualBoundingBoxRight),l=Math.ceil(e.actualBoundingBoxAscent),h=Math.ceil(e.actualBoundingBoxDescent),c=s+i,d=l+h;a+c+5>=512&&(a=5,o+=16),r.set(t,{l:s,r:i,a:l,d:h,w:c,h:d,x:a,y:o}),a+=c+5})),i.width=512,i.height=Qe.nextPowerOfTwo(o+16+5),s(n),n.fillStyle="rgb(0, 0, 0)",n.fillRect(0,0,i.width,i.height),r.forEach(((t,e)=>{n.fillStyle=(t=>"."===t||1===t.length&&t.charCodeAt(0)>=48&&t.charCodeAt(0)<=57)(e)?"rgb(255, 255, 255)":"rgb(170, 170, 170)",n.fillText(e,t.x-t.l,t.y+t.a)})),this.placements=r;const l=n.getImageData(0,0,i.width,i.height).data;for(let t=0;t<l.length;t+=4)l[t+3]=l[t+0],l[t+0]=255,l[t+1]=255,l[t+2]=255;this.texture=new dn(t,{name:"mini-stats-word-atlas",width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[l]})}destroy(){this.texture.destroy(),this.texture=null}render(t,e,s,i){const n=this.placements.get(e);if(n){const e=1;return t.quad(s+n.l-e,i-n.d+e,n.w+2*e,n.h+2*e,n.x-e,this.texture.height-n.y-n.h-e,void 0,void 0,this.texture,1),n.w}return 0}}class sS{constructor(t,e=512){const s=new Nn(t,[{semantic:$s,components:3,type:6},{semantic:ti,components:4,type:6}]),i=new Uint16Array(6*e);for(let t=0;t<e;++t)i[6*t+0]=4*t,i[6*t+1]=4*t+1,i[6*t+2]=4*t+2,i[6*t+3]=4*t,i[6*t+4]=4*t+2,i[6*t+5]=4*t+3;this.device=t,this.buffer=new In(t,s,4*e,{usage:2}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new To(t,1,6*e,0,i),this.prim={type:4,indexed:!0,base:0,baseVertex:0,count:0},this.quads=0,this.mesh=new Wh(t),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];const n=new Gu({uniqueName:"MiniStats",vertexGLSL:"\n\tattribute vec3 vertex_position;\n\tattribute vec4 vertex_texCoord0;\n\tvarying vec4 uv0;\n\tvarying float wordFlag;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n\t\tuv0 = vertex_texCoord0;\n\t\twordFlag = vertex_position.z;\n\t}\n",fragmentGLSL:"\n\tvarying vec4 uv0;\n\tvarying float wordFlag;\n\tuniform vec4 clr;\n\tuniform sampler2D graphTex;\n\tuniform sampler2D wordsTex;\n\tvoid main (void) {\n\t\tvec4 graphSample = texture2D(graphTex, uv0.xy);\n\t\tvec4 graph;\n\t\tif (uv0.w < graphSample.r)\n\t\t\tgraph = vec4(0.7, 0.2, 0.2, 1.0);\n\t\telse if (uv0.w < graphSample.g)\n\t\t\tgraph = vec4(0.2, 0.7, 0.2, 1.0);\n\t\telse if (uv0.w < graphSample.b)\n\t\t\tgraph = vec4(0.2, 0.2, 0.7, 1.0);\n\t\telse\n\t\t\tgraph = vec4(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n\t\tvec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));\n\t\tgl_FragColor = mix(graph, words, wordFlag) * clr;\n\t}\n",vertexWGSL:"\n\tattribute vertex_position: vec3f;\n\tattribute vertex_texCoord0: vec4f;\n\tvarying uv0: vec4f;\n\tvarying wordFlag: f32;\n\t@vertex fn vertexMain(input : VertexInput) -> VertexOutput {\n\t\tvar output : VertexOutput;\n\t\toutput.position = vec4(input.vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n\t\toutput.uv0 = input.vertex_texCoord0;\n\t\toutput.wordFlag = input.vertex_position.z;\n\t\treturn output;\n\t}\n",fragmentWGSL:"\n\tvarying uv0: vec4f;\n\tvarying wordFlag: f32;\n\tuniform clr: vec4f;\n\tvar graphTex : texture_2d<f32>;\n\tvar graphTex_sampler : sampler;\n\tvar wordsTex : texture_2d<f32>;\n\tvar wordsTex_sampler : sampler;\n\t@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar uv0: vec4f = input.uv0;\n\t\tvar graphSample: vec4f = textureSample(graphTex, graphTex_sampler, uv0.xy);\n\t\tvar graph: vec4f;\n\t\tif (uv0.w < graphSample.r) {\n\t\t\tgraph = vec4f(0.7, 0.2, 0.2, 1.0);\n\t\t} else if (uv0.w < graphSample.g) {\n\t\t\tgraph = vec4f(0.2, 0.7, 0.2, 1.0);\n\t\t} else if (uv0.w < graphSample.b) {\n\t\t\tgraph = vec4f(0.2, 0.2, 0.7, 1.0);\n\t\t} else {\n\t\t\tgraph = vec4f(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n\t\t}\n\t\tvar words: vec4f = textureSample(wordsTex, wordsTex_sampler, vec2f(uv0.x, 1.0 - uv0.y));\n\t\tvar output: FragmentOutput;\n\t\toutput.color = mix(graph, words, input.wordFlag) * uniform.clr;\n\t\treturn output;\n\t}\n",attributes:{vertex_position:$s,vertex_texCoord0:ti}});this.material=n,n.cull=0,n.depthState=Tn.NODEPTH,n.blendState=new Sn(!0,0,6,8,0,1,1),n.update(),this.meshInstance=new nc(this.mesh,n,new Mc("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:t.width,height:t.height}}quad(t,e,s,i,n,r,a,o,l,h=0){const c=this.targetSize.width,d=this.targetSize.height,u=t/c,f=e/d,p=(t+s)/c,m=(e+i)/d,_=l.width,g=l.height,v=n/_,b=r/g,y=(n+(a??s))/_,S=(r+(o??i))/g;this.data.set([u,f,h,v,b,0,0,p,f,h,y,b,1,0,p,m,h,y,S,1,1,u,m,h,v,S,0,1],28*this.quads),this.quads++,this.prim.count+=6}startFrame(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight}render(t,e,s,i,n,r){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(n,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",s),this.material.setParameter("wordsTex",i),t.drawMeshInstance(this.meshInstance,e)}}class iS{constructor(t,e){const s=t.graphicsDevice;e=e||iS.getDefaultOptions(),this.initGraphs(t,s,e);const i=new Set(["","ms","0","1","2","3","4","5","6","7","8","9","."].concat(this.graphs.map((t=>t.name))).concat(e.stats?e.stats.map((t=>t.unitsName)):[]).filter((t=>!!t)));this.wordAtlas=new eS(s,i),this.sizes=e.sizes,this._activeSizeIndex=e.startSizeIndex;const n=document.createElement("div");n.setAttribute("id","mini-stats"),n.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(n),n.addEventListener("mouseenter",(t=>{this.opacity=1})),n.addEventListener("mouseleave",(t=>{this.opacity=.7})),n.addEventListener("click",(t=>{t.preventDefault(),this._enabled&&(this.activeSizeIndex=(this.activeSizeIndex+1)%this.sizes.length,this.resize(this.sizes[this.activeSizeIndex].width,this.sizes[this.activeSizeIndex].height,this.sizes[this.activeSizeIndex].graphs))})),s.on("resizecanvas",this.updateDiv,this),s.on("losecontext",this.loseContext,this),t.on("postrender",this.postRender,this),this.app=t,this.drawLayer=t.scene.layers.getLayerById(4),this.device=s,this.render2d=new sS(s),this.div=n,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=!0,this.activeSizeIndex=this._activeSizeIndex}destroy(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach((t=>t.destroy())),this.wordAtlas.destroy(),this.texture.destroy()}static getDefaultOptions(){return{sizes:[{width:100,height:16,spacing:0,graphs:!1},{width:128,height:32,spacing:2,graphs:!0},{width:256,height:64,spacing:2,graphs:!0}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:!0,watermark:33},gpu:{enabled:!0,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}}set activeSizeIndex(t){this._activeSizeIndex=t,this.gspacing=this.sizes[t].spacing,this.resize(this.sizes[t].width,this.sizes[t].height,this.sizes[t].graphs)}get activeSizeIndex(){return this._activeSizeIndex}set opacity(t){this.clr[3]=t}get opacity(){return this.clr[3]}get overallHeight(){const t=this.graphs,e=this.gspacing;return this.height*t.length+e*(t.length-1)}set enabled(t){if(t!==this._enabled){this._enabled=t;for(let e=0;e<this.graphs.length;++e)this.graphs[e].enabled=t,this.graphs[e].timer.enabled=t}}get enabled(){return this._enabled}initGraphs(t,e,s){if(this.graphs=[],s.cpu.enabled){const e=new Qy(t),i=new tS("CPU",t,s.cpu.watermark,s.textRefreshRate,e);this.graphs.push(i)}if(s.gpu.enabled){const i=new Zy(e),n=new tS("GPU",t,s.gpu.watermark,s.textRefreshRate,i);this.graphs.push(n)}s.stats&&s.stats.forEach((e=>{const i=new Jy(t,e.stats,e.decimalPlaces,e.unitsName,e.multiplier),n=new tS(e.name,t,e.watermark,s.textRefreshRate,i);this.graphs.push(n)}));const i=s.sizes.reduce(((t,e)=>e.width>t?e.width:t),0);this.texture=new dn(e,{name:"mini-stats-graph-texture",width:Qe.nextPowerOfTwo(i),height:Qe.nextPowerOfTwo(this.graphs.length),mipmaps:!1,minFilter:0,magFilter:0,addressU:0,addressV:0}),this.graphs.forEach(((t,e)=>{t.texture=this.texture,t.yOffset=e}))}render(){const t=this.graphs,e=this.wordAtlas,s=this.render2d,i=this.width,n=this.height,r=this.gspacing;s.startFrame();for(let a=0;a<t.length;++a){const o=t[a];let l=a*(n+r);o.render(s,0,l,i,n);let h=1;l+=n-13,h+=e.render(s,o.name,h,l)+10;const c=o.timingText;for(let t=0;t<c.length;++t)h+=e.render(s,c[t],h,l);o.timer.unitsName&&(h+=3,e.render(s,o.timer.unitsName,h,l))}s.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,n)}resize(t,e,s){const i=this.graphs;for(let t=0;t<i.length;++t)i[t].enabled=s;this.width=t,this.height=e,this.updateDiv()}updateDiv(){const t=this.device.canvas.getBoundingClientRect();this.div.style.left=`${t.left}px`,this.div.style.bottom=window.innerHeight-t.bottom+"px",this.div.style.width=`${this.width}px`,this.div.style.height=`${this.overallHeight}px`}loseContext(){this.graphs.forEach((t=>t.loseContext()))}postRender(){this._enabled&&this.render()}}class nS{constructor(){}textureToCanvas(t,e={}){const s=t.getSource();if("undefined"!=typeof HTMLImageElement&&s instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&s instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&s instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&s instanceof ImageBitmap){const{width:t,height:i}=this.calcTextureSize(s.width,s.height,e.maxTextureSize),n=document.createElement("canvas");n.width=t,n.height=i;const r=n.getContext("2d");if(null===r)return Promise.resolve(void 0);if(r.drawImage(s,0,0,n.width,n.height),e.color){const{r:s,g:n,b:a}=e.color,o=r.getImageData(0,0,t,i),l=o.data;for(let t=0;t<l.length;t+=4)l[t+0]=l[t+0]*s,l[t+1]=l[t+1]*n,l[t+2]=l[t+2]*a;r.putImageData(o,0,0)}return Promise.resolve(n)}const i=t.device,{width:n,height:r}=this.calcTextureSize(t.width,t.height,e.maxTextureSize),a=Hs(t.format)?7:t.format,o=new dn(i,{name:"ExtractedTexture",width:n,height:r,format:a,cubemap:!1,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),l=new Hn({colorBuffer:o,depth:!1}),h=Ph.createShader(i,{uniqueName:"ShaderCoreExporterBlit",attributes:{vertex_position:$s},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"});return i.scope.resolve("source").setValue(t),i.setBlendState(Sn.NOBLEND),Nh(i,l,h),o.read(0,0,n,r,{renderTarget:l,immediate:!0}).then((t=>{o.destroy(),l.destroy();const e=new Uint8ClampedArray(n*r*4);e.set(t);const s=new ImageData(e,n,r),i=document.createElement("canvas");i.width=n,i.height=r;const a=i.getContext("2d");return a?(a.putImageData(s,0,0),Promise.resolve(i)):Promise.resolve(void 0)}))}calcTextureSize(t,e,s){if(s){const i=Math.min(s/Math.max(t,e),1);t=Math.round(t*i),e=Math.round(e*i)}return{width:t,height:e}}}var rS=Uint8Array,aS=Uint16Array,oS=Int32Array,lS=new rS([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),hS=new rS([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),cS=new rS([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),dS=function(t,e){for(var s=new aS(31),i=0;i<31;++i)s[i]=e+=1<<t[i-1];var n=new oS(s[30]);for(i=1;i<30;++i)for(var r=s[i];r<s[i+1];++r)n[r]=r-s[i]<<5|i;return{b:s,r:n}},uS=dS(lS,2),fS=uS.b,pS=uS.r;fS[28]=258,pS[258]=28;for(var mS=dS(hS,0).r,_S=new aS(32768),gS=0;gS<32768;++gS){var vS=(43690&gS)>>1|(21845&gS)<<1;vS=(61680&(vS=(52428&vS)>>2|(13107&vS)<<2))>>4|(3855&vS)<<4,_S[gS]=((65280&vS)>>8|(255&vS)<<8)>>1}var bS=function(t,e,s){for(var i=t.length,n=0,r=new aS(e);n<i;++n)t[n]&&++r[t[n]-1];var a,o=new aS(e);for(n=1;n<e;++n)o[n]=o[n-1]+r[n-1]<<1;if(s){a=new aS(1<<e);var l=15-e;for(n=0;n<i;++n)if(t[n])for(var h=n<<4|t[n],c=e-t[n],d=o[t[n]-1]++<<c,u=d|(1<<c)-1;d<=u;++d)a[_S[d]>>l]=h}else for(a=new aS(i),n=0;n<i;++n)t[n]&&(a[n]=_S[o[t[n]-1]++]>>15-t[n]);return a},yS=new rS(288);for(gS=0;gS<144;++gS)yS[gS]=8;for(gS=144;gS<256;++gS)yS[gS]=9;for(gS=256;gS<280;++gS)yS[gS]=7;for(gS=280;gS<288;++gS)yS[gS]=8;var SS=new rS(32);for(gS=0;gS<32;++gS)SS[gS]=5;var xS=bS(yS,9,0);bS(yS,9,1);var wS=bS(SS,5,0);bS(SS,5,1);var TS=function(t){return(t+7)/8|0},ES=function(t,e,s){return(null==s||s>t.length)&&(s=t.length),new rS(t.subarray(e,s))},CS=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],AS=function(t,e,s){var i=new Error(e||CS[t]);if(i.code=t,Error.captureStackTrace&&Error.captureStackTrace(i,AS),!s)throw i;return i},DS=function(t,e,s){s<<=7&e;var i=e/8|0;t[i]|=s,t[i+1]|=s>>8},PS=function(t,e,s){s<<=7&e;var i=e/8|0;t[i]|=s,t[i+1]|=s>>8,t[i+2]|=s>>16},LS=function(t,e){for(var s=[],i=0;i<t.length;++i)t[i]&&s.push({s:i,f:t[i]});var n=s.length,r=s.slice();if(!n)return{t:NS,l:0};if(1==n){var a=new rS(s[0].s+1);return a[s[0].s]=1,{t:a,l:1}}s.sort((function(t,e){return t.f-e.f})),s.push({s:-1,f:25001});var o=s[0],l=s[1],h=0,c=1,d=2;for(s[0]={s:-1,f:o.f+l.f,l:o,r:l};c!=n-1;)o=s[s[h].f<s[d].f?h++:d++],l=s[h!=c&&s[h].f<s[d].f?h++:d++],s[c++]={s:-1,f:o.f+l.f,l:o,r:l};var u=r[0].s;for(i=1;i<n;++i)r[i].s>u&&(u=r[i].s);var f=new aS(u+1),p=IS(s[c-1],f,0);if(p>e){i=0;var m=0,_=p-e,g=1<<_;for(r.sort((function(t,e){return f[e.s]-f[t.s]||t.f-e.f}));i<n;++i){var v=r[i].s;if(!(f[v]>e))break;m+=g-(1<<p-f[v]),f[v]=e}for(m>>=_;m>0;){var b=r[i].s;f[b]<e?m-=1<<e-f[b]++-1:++i}for(;i>=0&&m;--i){var y=r[i].s;f[y]==e&&(--f[y],++m)}p=e}return{t:new rS(f),l:p}},IS=function(t,e,s){return-1==t.s?Math.max(IS(t.l,e,s+1),IS(t.r,e,s+1)):e[t.s]=s},RS=function(t){for(var e=t.length;e&&!t[--e];);for(var s=new aS(++e),i=0,n=t[0],r=1,a=function(t){s[i++]=t},o=1;o<=e;++o)if(t[o]==n&&o!=e)++r;else{if(!n&&r>2){for(;r>138;r-=138)a(32754);r>2&&(a(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(a(n),--r;r>6;r-=6)a(8304);r>2&&(a(r-3<<5|8208),r=0)}for(;r--;)a(n);r=1,n=t[o]}return{c:s.subarray(0,i),n:e}},MS=function(t,e){for(var s=0,i=0;i<e.length;++i)s+=t[i]*e[i];return s},kS=function(t,e,s){var i=s.length,n=TS(e+2);t[n]=255&i,t[n+1]=i>>8,t[n+2]=255^t[n],t[n+3]=255^t[n+1];for(var r=0;r<i;++r)t[n+r+4]=s[r];return 8*(n+4+i)},OS=function(t,e,s,i,n,r,a,o,l,h,c){DS(e,c++,s),++n[256];for(var d=LS(n,15),u=d.t,f=d.l,p=LS(r,15),m=p.t,_=p.l,g=RS(u),v=g.c,b=g.n,y=RS(m),S=y.c,x=y.n,w=new aS(19),T=0;T<v.length;++T)++w[31&v[T]];for(T=0;T<S.length;++T)++w[31&S[T]];for(var E=LS(w,7),C=E.t,A=E.l,D=19;D>4&&!C[cS[D-1]];--D);var P,L,I,R,M=h+5<<3,k=MS(n,yS)+MS(r,SS)+a,O=MS(n,u)+MS(r,m)+a+14+3*D+MS(w,C)+2*w[16]+3*w[17]+7*w[18];if(l>=0&&M<=k&&M<=O)return kS(e,c,t.subarray(l,l+h));if(DS(e,c,1+(O<k)),c+=2,O<k){P=bS(u,f,0),L=u,I=bS(m,_,0),R=m;var F=bS(C,A,0);DS(e,c,b-257),DS(e,c+5,x-1),DS(e,c+10,D-4),c+=14;for(T=0;T<D;++T)DS(e,c+3*T,C[cS[T]]);c+=3*D;for(var N=[v,S],B=0;B<2;++B){var U=N[B];for(T=0;T<U.length;++T){var z=31&U[T];DS(e,c,F[z]),c+=C[z],z>15&&(DS(e,c,U[T]>>5&127),c+=U[T]>>12)}}}else P=xS,L=yS,I=wS,R=SS;for(T=0;T<o;++T){var V=i[T];if(V>255){PS(e,c,P[(z=V>>18&31)+257]),c+=L[z+257],z>7&&(DS(e,c,V>>23&31),c+=lS[z]);var H=31&V;PS(e,c,I[H]),c+=R[H],H>3&&(PS(e,c,V>>5&8191),c+=hS[H])}else PS(e,c,P[V]),c+=L[V]}return PS(e,c,P[256]),c+L[256]},FS=new oS([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),NS=new rS(0),BS=function(){for(var t=new Int32Array(256),e=0;e<256;++e){for(var s=e,i=9;--i;)s=(1&s&&-306674912)^s>>>1;t[e]=s}return t}(),US=function(){var t=-1;return{p:function(e){for(var s=t,i=0;i<e.length;++i)s=BS[255&s^e[i]]^s>>>8;t=s},d:function(){return~t}}},zS=function(t,e,s,i,n){if(!n&&(n={l:1},e.dictionary)){var r=e.dictionary.subarray(-32768),a=new rS(r.length+t.length);a.set(r),a.set(t,r.length),t=a,n.w=r.length}return function(t,e,s,i,n,r){var a=r.z||t.length,o=new rS(i+a+5*(1+Math.ceil(a/7e3))+n),l=o.subarray(i,o.length-n),h=r.l,c=7&(r.r||0);if(e){c&&(l[0]=r.r>>3);for(var d=FS[e-1],u=d>>13,f=8191&d,p=(1<<s)-1,m=r.p||new aS(32768),_=r.h||new aS(p+1),g=Math.ceil(s/3),v=2*g,b=function(e){return(t[e]^t[e+1]<<g^t[e+2]<<v)&p},y=new oS(25e3),S=new aS(288),x=new aS(32),w=0,T=0,E=r.i||0,C=0,A=r.w||0,D=0;E+2<a;++E){var P=b(E),L=32767&E,I=_[P];if(m[L]=I,_[P]=L,A<=E){var R=a-E;if((w>7e3||C>24576)&&(R>423||!h)){c=OS(t,l,0,y,S,x,T,C,D,E-D,c),C=w=T=0,D=E;for(var M=0;M<286;++M)S[M]=0;for(M=0;M<30;++M)x[M]=0}var k=2,O=0,F=f,N=L-I&32767;if(R>2&&P==b(E-N))for(var B=Math.min(u,R)-1,U=Math.min(32767,E),z=Math.min(258,R);N<=U&&--F&&L!=I;){if(t[E+k]==t[E+k-N]){for(var V=0;V<z&&t[E+V]==t[E+V-N];++V);if(V>k){if(k=V,O=N,V>B)break;var H=Math.min(N,V-2),G=0;for(M=0;M<H;++M){var W=E-N+M&32767,j=W-m[W]&32767;j>G&&(G=j,I=W)}}}N+=(L=I)-(I=m[L])&32767}if(O){y[C++]=268435456|pS[k]<<18|mS[O];var X=31&pS[k],$=31&mS[O];T+=lS[X]+hS[$],++S[257+X],++x[$],A=E+k,++w}else y[C++]=t[E],++S[t[E]]}}for(E=Math.max(E,A);E<a;++E)y[C++]=t[E],++S[t[E]];c=OS(t,l,h,y,S,x,T,C,D,E-D,c),h||(r.r=7&c|l[c/8|0]<<3,c-=7,r.h=_,r.p=m,r.i=E,r.w=A)}else{for(E=r.w||0;E<a+h;E+=65535){var q=E+65535;q>=a&&(l[c/8|0]=h,q=a),c=kS(l,c+1,t.subarray(E,q))}r.i=a}return ES(o,0,i+TS(c)+n)}(t,null==e.level?6:e.level,null==e.mem?n.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(t.length)))):20:12+e.mem,s,i,n)},VS=function(t,e){var s={};for(var i in t)s[i]=t[i];for(var i in e)s[i]=e[i];return s},HS=function(t,e,s){for(;s;++e)t[e]=s,s>>>=8};function GS(t,e){return zS(t,e||{},0,0)}var WS=function(t,e,s,i){for(var n in t){var r=t[n],a=e+n,o=i;Array.isArray(r)&&(o=VS(i,r[1]),r=r[0]),r instanceof rS?s[a]=[r,o]:(s[a+="/"]=[new rS(0),o],WS(r,a,s,i))}},jS="undefined"!=typeof TextEncoder&&new TextEncoder,XS="undefined"!=typeof TextDecoder&&new TextDecoder;try{XS.decode(NS,{stream:!0})}catch(t){}function $S(t,e){if(jS)return jS.encode(t);for(var s=t.length,i=new rS(t.length+(t.length>>1)),n=0,r=function(t){i[n++]=t},a=0;a<s;++a){if(n+5>i.length){var o=new rS(n+8+(s-a<<1));o.set(i),i=o}var l=t.charCodeAt(a);l<128||e?r(l):l<2048?(r(192|l>>6),r(128|63&l)):l>55295&&l<57344?(r(240|(l=65536+(1047552&l)|1023&t.charCodeAt(++a))>>18),r(128|l>>12&63),r(128|l>>6&63),r(128|63&l)):(r(224|l>>12),r(128|l>>6&63),r(128|63&l))}return ES(i,0,n)}var qS=function(t){var e=0;if(t)for(var s in t){var i=t[s].length;i>65535&&AS(9),e+=i+4}return e},KS=function(t,e,s,i,n,r,a,o){var l=i.length,h=s.extra,c=o&&o.length,d=qS(h);HS(t,e,null!=a?33639248:67324752),e+=4,null!=a&&(t[e++]=20,t[e++]=s.os),t[e]=20,e+=2,t[e++]=s.flag<<1|(r<0&&8),t[e++]=n&&8,t[e++]=255&s.compression,t[e++]=s.compression>>8;var u=new Date(null==s.mtime?Date.now():s.mtime),f=u.getFullYear()-1980;if((f<0||f>119)&&AS(10),HS(t,e,f<<25|u.getMonth()+1<<21|u.getDate()<<16|u.getHours()<<11|u.getMinutes()<<5|u.getSeconds()>>1),e+=4,-1!=r&&(HS(t,e,s.crc),HS(t,e+4,r<0?-r-2:r),HS(t,e+8,s.size)),HS(t,e+12,l),HS(t,e+14,d),e+=16,null!=a&&(HS(t,e,c),HS(t,e+6,s.attrs),HS(t,e+10,a),e+=14),t.set(i,e),e+=l,d)for(var p in h){var m=h[p],_=m.length;HS(t,e,+p),HS(t,e+2,_),t.set(m,e+4),e+=4+_}return c&&(t.set(o,e),e+=c),e};function YS(t,e){e||(e={});var s={},i=[];WS(t,"",s,e);var n=0,r=0;for(var a in s){var o=s[a],l=o[0],h=o[1],c=0==h.level?0:8,d=(w=$S(a)).length,u=h.comment,f=u&&$S(u),p=f&&f.length,m=qS(h.extra);d>65535&&AS(11);var _=c?GS(l,h):l,g=_.length,v=US();v.p(l),i.push(VS(h,{size:l.length,crc:v.d(),c:_,f:w,m:f,u:d!=a.length||f&&u.length!=p,o:n,compression:c})),n+=30+d+m+g,r+=76+2*(d+m)+(p||0)+g}for(var b=new rS(r+22),y=n,S=r-n,x=0;x<i.length;++x){var w=i[x];KS(b,w.o,w,w.f,w.u,w.c.length);var T=30+w.f.length+qS(w.extra);b.set(w.c,w.o+T),KS(b,n,w,w.f,w.u,w.c.length,w.o,w.m),n+=16+T+(w.m?w.m.length:0)}return function(t,e,s,i,n){HS(t,e,101010256),HS(t,e+8,s),HS(t,e+10,s),HS(t,e+12,i),HS(t,e+16,n)}(b,n,i.length,S,y),b}const QS="root",ZS=(t,e,s)=>`                    ${t} inputs:${e} = ${s}`;class JS extends nS{init(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set}done(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null}build(t,e={}){this.init(),this.addFile(null,QS);const s=[];if(t){t.findComponents("render").forEach((t=>{s.push(...t.meshInstances)}))}let i="";s.forEach((t=>{i+=this.buildMeshInstance(t)})),i+=`\ndef "Materials"\n{\n\t\t${this.materials.join("\n")}\n}\n`,this.addFile(null,QS,"",i);const n={maxTextureSize:e.maxTextureSize},r=Array.from(this.textureMap.keys()),a=[];for(let t=0;t<r.length;t++){const e="image/png",s=r[t],i=this.textureToCanvas(s,n).then((t=>t?new Promise((s=>t.toBlob(s,e,1))).then((t=>t.arrayBuffer())):(console.warn(`Export of texture ${s.name} is not currently supported.`),new Promise((t=>t(null))))));a.push(i)}const o=Promise.all(a).then((t=>{t.forEach(((t,e)=>{const s=r[e],i=this.getTextureFileIds(s);this.files[i.fileName]=new Uint8Array(t)})),this.alignFiles();const e=YS(this.files,{level:0});return this.done(),e}));return o}alignFiles(){let t=0;for(const e in this.files){const s=this.files[e];t+=34+e.length;const i=63&t;if(4!==i){const t=new Uint8Array(64-i);this.files[e]=[s,{extra:{12345:t}}]}t=s.length}}getFileIds(t,e,s,i="usda"){const n=`${t?`${t}/`:""}${e}.${i}`;return{name:e,fileName:n,refName:`@./${n}@</${s}>`}}getTextureFileIds(t){return this.getFileIds("texture",`Texture_${t.id}`,"Texture","png")}addFile(t,e,s="",i=""){let n=null;i&&(n=$S(i=`#usda 1.0\n(\n\t\tcustomLayerData = {\n\t\t\t\tstring creator = "PlayCanvas UsdzExporter"\n\t\t}\n\t\tmetersPerUnit = 1\n\t\tupAxis = "Y"\n)\n\n${i}`));const r=this.getFileIds(t,e,s);return this.files[r.fileName]=n,r.refName}getMaterialRef(t){let e=this.materialMap.get(t);return e||(e=this.buildMaterial(t),this.materialMap.set(t,e)),e}getMeshRef(t){let e=this.meshMap.get(t);return e||(e=this.buildMesh(t),this.meshMap.set(t,e)),e}buildArray2(t){const e=[],s=t.length;for(let i=0;i<s;i+=2)e.push(`(${t[i]}, ${1-t[i+1]})`);return e.join(", ")}buildArray3(t){const e=[],s=t.length;for(let i=0;i<s;i+=3)e.push(`(${t[i]}, ${t[i+1]}, ${t[i+2]})`);return e.join(", ")}buildMat4(t){const e=t.data,s=[];for(let t=0;t<16;t+=4)s.push(`(${e[t]}, ${e[t+1]}, ${e[t+2]}, ${e[t+3]})`);return`( ${s.join(", ")} )`}buildMaterial(t){const e=`Material_${t.id}`,s=`/Materials/${e}`,i=t=>`<${s}${t}>`,n=[],r=[],a=(e,s,a,o,l,h=!1,c=!1)=>{const d=t[e];if(d){const h=this.getTextureFileIds(d);this.textureMap.set(d,h.refName);const u=t[`${e}Channel`]||"rgb",f=i(`/${h.name}_${l}.outputs:${u}`);n.push(ZS(a,`${o}.connect`,f));const p=t[`${e}Tiling`],m=t[`${e}Offset`],_=t[`${e}Rotation`],g=1===t[`${e}Uv`]?"st1":"st",v=c&&s?s:Ze.WHITE;r.push(((t,e,s,n,r,a,o,l)=>`\n\t\t\t\t\t\t\t\tdef Shader "Transform2d_${s}" (\n\t\t\t\t\t\t\t\t\t\tsdrMetadata = {\n\t\t\t\t\t\t\t\t\t\t\t\tstring role = "math"\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdTransform2d"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:in.connect = ${i(`/uvReader_${n}.outputs:result`)}\n\t\t\t\t\t\t\t\t\t\tfloat inputs:rotation = ${o}\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:scale = (${r.x}, ${r.y})\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:translation = (${a.x}, ${a.y})\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdef Shader "Texture_${t.id}_${s}"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdUVTexture"\n\t\t\t\t\t\t\t\t\t\tasset inputs:file = @${e.fileName}@\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:st.connect = ${i(`/Transform2d_${s}.outputs:result`)}\n\t\t\t\t\t\t\t\t\t\ttoken inputs:wrapS = "repeat"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:wrapT = "repeat"\n\t\t\t\t\t\t\t\t\t\tfloat4 inputs:scale = (${l.r}, ${l.g}, ${l.b}, ${l.a})\n\t\t\t\t\t\t\t\t\t\tfloat outputs:r\n\t\t\t\t\t\t\t\t\t\tfloat outputs:g\n\t\t\t\t\t\t\t\t\t\tfloat outputs:b\n\t\t\t\t\t\t\t\t\t\tfloat3 outputs:rgb\n\t\t\t\t\t\t\t\t\t\tfloat outputs:a\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`)(d,h,l,g,p,m,_,v))}else if(s){const t="float"===a?`${s}`:`(${s.r}, ${s.g}, ${s.b})`;n.push(ZS(a,o,t))}};a("diffuseMap",t.diffuse,"color3f","diffuseColor","diffuse",!1,!0),(t.transparent||t.alphaTest>0)&&a("opacityMap",t.opacity,"float","opacity","opacity",!0),a("normalMap",null,"normal3f","normal","normal"),a("emissiveMap",t.emissive,"color3f","emissiveColor","emissive",!1,!0),a("aoMap",null,"float","occlusion","occlusion"),a("metalnessMap",t.metalness,"float","metallic","metallic"),a("glossMap",t.gloss,"float","roughness","roughness");const o=`\n\t\t\t\t\t\tdef Material "${e}"\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdef Shader "PreviewSurface"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPreviewSurface"\n${n.join("\n")}\n\t\t\t\t\t\t\t\t\t\tint inputs:useSpecularWorkflow = 0\n\t\t\t\t\t\t\t\t\t\ttoken outputs:surface\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\ttoken outputs:surface.connect = ${i("/PreviewSurface.outputs:surface")}\n\n\t\t\t\t\t\t\t\tdef Shader "uvReader_st"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPrimvarReader_float2"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:varname = "st"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:fallback = (0.0, 0.0)\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdef Shader "uvReader_st1"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPrimvarReader_float2"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:varname = "st1"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:fallback = (0.0, 0.0)\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t${r.join("\n")}\n\t\t\t\t\t\t}\n\t\t\t\t`;return this.materials.push(o),i("")}buildMesh(t){let e=[];const s=[];let i=[],n=[],r=[];t.getVertexStream($s,e),t.getVertexStream(qs,i),t.getVertexStream(ti,n),t.getVertexStream(ei,r),t.getIndices(s);const a=s.length||e.length,o=Array(a/3).fill(3).join(", ");if(!s.length)for(let t=0;t<a;t++)s[t]=t;const l=e.length/3;i=i.length?i:Array(3*l).fill(0),n=n.length?n:Array(2*l).fill(0),r=r.length?r:Array(2*l).fill(0),e=this.buildArray3(e),i=this.buildArray3(i),n=this.buildArray2(n),r=this.buildArray2(r);const h=((t,e,s,i,n,r)=>`\ndef "Mesh"\n{\n\t\tdef Mesh "Mesh"\n\t\t{\n\t\t\t\tint[] faceVertexCounts = [${t}]\n\t\t\t\tint[] faceVertexIndices = [${e}]\n\t\t\t\tnormal3f[] normals = [${s}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\tpoint3f[] points = [${i}]\n\t\t\t\ttexCoord2f[] primvars:st = [${n}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\ttexCoord2f[] primvars:st1 = [${r}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\tuniform token subdivisionScheme = "none"\n\t\t}\n}\n`)(o,s,i,e,n,r);return this.addFile("mesh",`Mesh_${t.id}`,"Mesh",h)}buildMeshInstance(t){const e=this.getMeshRef(t.mesh),s=this.getMaterialRef(t.material),i=this.buildMat4(t.node.getWorldTransform()),n=t.node.name.replace(/[^a-z0-9]/gi,"_");let r=n;for(;this.nodeNames.has(r);)r=`${n}_${Math.random().toString(36).slice(2,7)}`;return this.nodeNames.add(r),((t,e,s,i)=>`\ndef Xform "${t}" (\n\t\tprepend references = ${e}\n)\n{\n\t\tmatrix4d xformOp:transform = ${s}\n\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\trel material:binding = ${i}\n}\n`)(r,e,i,s)}}const tx=new rs,ex=new ms;class sx{constructor(t=rs.ZERO,e=rs.ZERO,s=0){this.position=new rs,this.angles=new rs,this.distance=0,this.pitchRange=new os(-1/0,1/0),this.yawRange=new os(-1/0,1/0),this.xRange=new os(-1/0,1/0),this.yRange=new os(-1/0,1/0),this.zRange=new os(-1/0,1/0),this.set(t,e,s)}copy(t){return this.set(t.position,t.angles,t.distance)}clone(){return new sx(this.position.clone(),this.angles.clone(),this.distance)}equalsApprox(t,e=1e-6){return this.position.equalsApprox(t.position,e)&&this.angles.equalsApprox(t.angles,e)&&Math.abs(this.distance-t.distance)<e}lerp(t,e,s,i=s,n=s){return this.position.lerp(t.position,e.position,s),this.angles.x=Qe.lerpAngle(t.angles.x,e.angles.x,i)%360,this.angles.y=Qe.lerpAngle(t.angles.y,e.angles.y,i)%360,this.angles.z=Qe.lerpAngle(t.angles.z,e.angles.z,i)%360,this.distance=Qe.lerp(t.distance,e.distance,n),this}move(t){return this.position.add(t),this.position.x=Qe.clamp(this.position.x,this.xRange.x,this.xRange.y),this.position.y=Qe.clamp(this.position.y,this.yRange.x,this.yRange.y),this.position.z=Qe.clamp(this.position.z,this.zRange.x,this.zRange.y),this}rotate(t){return this.angles.add(t),this.angles.x%=360,this.angles.y%=360,this.angles.z%=360,this.angles.x=Qe.clamp(this.angles.x,this.pitchRange.x,this.pitchRange.y),this.angles.y=Qe.clamp(this.angles.y,this.yawRange.x,this.yawRange.y),this}set(t,e,s){return this.position.copy(t),this.angles.copy(e),this.distance=s,this}look(t,e){this.position.copy(t),this.distance=t.distance(e);const s=tx.sub2(e,t).normalize(),i=Math.atan2(-s.y,Math.sqrt(s.x*s.x+s.z*s.z))*Qe.RAD_TO_DEG,n=Math.atan2(-s.x,-s.z)*Qe.RAD_TO_DEG;return this.angles.set(-i,n,0),this}getFocus(t){return ex.setFromEulerAngles(this.angles).transformVector(rs.FORWARD,t).mulScalar(this.distance).add(this.position)}}class ix{constructor(t){Array.isArray(t)?this._value=t.slice():this._value=new Array(+t).fill(0)}add(t){for(let e=0;e<this._value.length;e++)this._value[e]+=t._value[e]||0;return this}append(t){for(let e=0;e<this._value.length;e++)this._value[e]+=t[e]||0;return this}copy(t){for(let e=0;e<this._value.length;e++)this._value[e]=t._value[e]||0;return this}length(){let t=0;for(const e of this._value)t+=e*e;return Math.sqrt(t)}read(){const t=this._value.slice();return this._value.fill(0),t}}class nx{constructor(t){this.deltas={};for(const e in t)this.deltas[e]=new ix(t[e])}read(){const t={};for(const e in this.deltas)t[e]=this.deltas[e].read();return t}}class rx extends nx{on(t,e){this._events.on(t,e)}off(t,e){this._events.off(t,e)}fire(t,...e){this._events.fire(t,...e)}attach(t){this._element&&this.detach(),this._element=t}detach(){this._element&&(this._element=null,this.read())}destroy(){this.detach(),this._events.off()}constructor(...t){super(...t),this._element=null,this._events=new Ve}}class ax{update(t,e){t.read()}}class ox extends ax{attach(t,e=!0){}detach(){}update(t,e){return super.update(t,e),this._pose}destroy(){this.detach()}constructor(...t){super(...t),this._pose=new sx}}const lx=new os;class hx{constructor({range:t}={}){this._range=70,this._position=new os,this._value=new os,this._range=t??this._range}get value(){return this._value}down(t,e){return this._position.set(t,e),this._value.set(0,0),[t,e,t,e]}move(t,e){lx.set(t-this._position.x,e-this._position.y),lx.length()>this._range&&lx.normalize().mulScalar(this._range),this._value.set(Qe.clamp(lx.x/this._range,-1,1),Qe.clamp(lx.y/this._range,-1,1));const{x:s,y:i}=this._position;return[s,i,s+lx.x,i+lx.y]}up(){return this._position.set(0,0),this._value.set(0,0),[-1,-1,-1,-1]}}const cx=(t,e)=>0===t.indexOf(e),dx=(t,e)=>-1!==t.indexOf(e,t.length-e.length);class ux extends rx{constructor(t){super({leftInput:[0,0],rightInput:[0,0],doubleTap:[0]}),this._layout="joystick-touch",this._pointerData=new Map,this._lastPointer={x:0,y:0,time:0},t&&(this.layout=t),this._leftJoystick=new hx,this._rightJoystick=new hx,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this)}set layout(t){this._layout!==t&&(this._layout=t,this.read(),this._pointerData.clear())}get layout(){return this._layout}get leftJoystick(){return this._leftJoystick}get rightJoystick(){return this._rightJoystick}_onPointerDown(t){const{pointerType:e,pointerId:s,clientX:i,clientY:n}=t;if("touch"!==e)return;this._element?.setPointerCapture(s);const r=i<.5*window.innerWidth;this._pointerData.set(s,{x:i,y:n,left:r});const a=Date.now();(this._lastPointer.x-i)**2+(this._lastPointer.y-n)**2<100&&a-this._lastPointer.time<250&&this.deltas.doubleTap.append([1]),this._lastPointer.x=i,this._lastPointer.y=n,this._lastPointer.time=a,r&&cx(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.down(i,n)),!r&&dx(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.down(i,n))}_onPointerMove(t){const{pointerType:e,pointerId:s,target:i,clientX:n,clientY:r,movementX:a,movementY:o}=t;if("touch"!==e)return;if(i!==this._element)return;const l=this._pointerData.get(s);if(!l)return;const{left:h}=l;l.x=n,l.y=r,h?cx(this._layout,"joystick")?this.fire("joystick:position:left",this._leftJoystick.move(n,r)):this.deltas.leftInput.append([a,o]):dx(this._layout,"joystick")?this.fire("joystick:position:right",this._rightJoystick.move(n,r)):this.deltas.rightInput.append([a,o])}_onPointerUp(t){const{pointerType:e,pointerId:s}=t;if("touch"!==e)return;this._element?.releasePointerCapture(s);const i=this._pointerData.get(s);if(!i)return;const{left:n}=i;this._pointerData.delete(s),n&&cx(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.up()),!n&&dx(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.up())}attach(t){super.attach(t),this._element=t,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp)}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._pointerData.clear(),super.detach())}read(){return this.deltas.leftInput.append([this._leftJoystick.value.x,this._leftJoystick.value.y]),this.deltas.rightInput.append([this._rightJoystick.value.x,this._rightJoystick.value.y]),super.read()}destroy(){this._leftJoystick.up(),this._rightJoystick.up(),super.destroy()}}const fx=new os;class px extends rx{constructor(){super({touch:[0,0],count:[0],pinch:[0]}),this._pointerEvents=new Map,this._pointerPos=new os,this._pinchDist=-1,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this)}_onPointerDown(t){const{pointerId:e,pointerType:s}=t;"touch"===s&&(this._element?.setPointerCapture(e),this._pointerEvents.set(e,t),this.deltas.count.append([1]),this._pointerEvents.size>1&&(this._getMidPoint(this._pointerPos),this._pinchDist=this._getPinchDist()))}_onPointerMove(t){const{pointerType:e,target:s,pointerId:i,movementX:n,movementY:r}=t;if("touch"===e&&s===this._element&&0!==this._pointerEvents.size)if(this._pointerEvents.set(i,t),this._pointerEvents.size>1){const t=this._getMidPoint(fx);this.deltas.touch.append([t.x-this._pointerPos.x,t.y-this._pointerPos.y]),this._pointerPos.copy(t);const e=this._getPinchDist();this._pinchDist>0&&this.deltas.pinch.append([this._pinchDist-e]),this._pinchDist=e}else this.deltas.touch.append([n,r])}_onPointerUp(t){const{pointerType:e,pointerId:s}=t;"touch"===e&&(this._element?.releasePointerCapture(s),this._pointerEvents.delete(s),this.deltas.count.append([-1]),this._pointerEvents.size<2&&(this._pinchDist=-1),this._pointerPos.set(0,0))}_onContextMenu(t){t.preventDefault()}_getMidPoint(t){if(this._pointerEvents.size<2)return t.set(0,0);const[e,s]=this._pointerEvents.values(),i=e.clientX-s.clientX,n=e.clientY-s.clientY;return t.set(s.clientX+.5*i,s.clientY+.5*n)}_getPinchDist(){if(this._pointerEvents.size<2)return 0;const[t,e]=this._pointerEvents.values(),s=t.clientX-e.clientX,i=t.clientY-e.clientY;return Math.sqrt(s*s+i*i)}attach(t){super.attach(t),this._element=t,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu)}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),this._pointerEvents.clear(),super.detach())}}const mx={passive:!1},_x={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,0:26,1:27,2:28,3:29,4:30,5:31,6:32,7:33,8:34,9:35,UP:36,DOWN:37,LEFT:38,RIGHT:39,SPACE:40,SHIFT:41,CTRL:42},gx=Object.keys(_x).length,vx=Array(gx).fill(0);class bx extends rx{static{this.keyCode=_x}constructor({pointerLock:t=!1}={}){super({key:Array(gx).fill(0),button:[0,0,0],mouse:[0,0],wheel:[0]}),this._pointerId=-1,this._keyMap=new Map,this._keyPrev=Array(gx).fill(0),this._keyNow=Array(gx).fill(0),this._button=Array(3).fill(0),this._pointerLock=t??!1;const{keyCode:e}=bx;for(let t=0;t<26;t++){const s=`Key${String.fromCharCode("A".charCodeAt(0)+t)}`;this._keyMap.set(s,e.A+t)}for(let t=0;t<10;t++){const s=`Digit${t}`;this._keyMap.set(s,e[0]+t)}this._keyMap.set("ArrowUp",e.UP),this._keyMap.set("ArrowDown",e.DOWN),this._keyMap.set("ArrowLeft",e.LEFT),this._keyMap.set("ArrowRight",e.RIGHT),this._keyMap.set("Space",e.SPACE),this._keyMap.set("ShiftLeft",e.SHIFT),this._keyMap.set("ShiftRight",e.SHIFT),this._keyMap.set("ControlLeft",e.CTRL),this._keyMap.set("ControlRight",e.CTRL),this._onWheel=this._onWheel.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this)}_onWheel(t){t.preventDefault(),this.deltas.wheel.append([t.deltaY])}_onPointerDown(t){"mouse"===t.pointerType&&(this._pointerLock?document.pointerLockElement!==this._element&&this._element?.requestPointerLock():this._element?.setPointerCapture(t.pointerId),this._clearButtons(),this._button[t.button]=1,this.deltas.button.append(this._button),-1===this._pointerId&&(this._pointerId=t.pointerId))}_onPointerMove(t){if("mouse"===t.pointerType&&t.target===this._element){if(this._pointerLock){if(document.pointerLockElement!==this._element)return}else if(this._pointerId!==t.pointerId)return;this.deltas.mouse.append([t.movementX,t.movementY])}}_onPointerUp(t){"mouse"===t.pointerType&&(this._pointerLock||this._element?.releasePointerCapture(t.pointerId),this._clearButtons(),this.deltas.button.append(this._button),this._pointerId===t.pointerId&&(this._pointerId=-1))}_onContextMenu(t){t.preventDefault()}_onKeyDown(t){this._pointerLock&&document.pointerLockElement!==this._element||(t.stopPropagation(),this._setKey(t.code,1))}_onKeyUp(t){t.stopPropagation(),this._setKey(t.code,0)}_clearButtons(){for(let t=0;t<this._button.length;t++)1!==this._button[t]?this._button[t]=0:this._button[t]=-1}_setKey(t,e){this._keyMap.has(t)&&(this._keyNow[this._keyMap.get(t)??0]=e)}attach(t){super.attach(t),this._element=t,this._element.addEventListener("wheel",this._onWheel,mx),this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("pointerleave",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1)}detach(){this._element&&(this._element.removeEventListener("wheel",this._onWheel,mx),this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("pointerleave",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("keydown",this._onKeyDown,!1),window.removeEventListener("keyup",this._onKeyUp,!1),this._keyNow.fill(0),this._keyPrev.fill(0),super.detach())}read(){for(let t=0;t<vx.length;t++)vx[t]=this._keyNow[t]-this._keyPrev[t],this._keyPrev[t]=this._keyNow[t];return this.deltas.key.append(vx),super.read()}}const yx={A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,SELECT:8,START:9,LEFT_STICK:10,RIGHT_STICK:11},Sx=Object.keys(yx).length;class xx extends rx{static{this.buttonCode=yx}constructor(){super({buttons:Array(Sx).fill(0),leftStick:[0,0],rightStick:[0,0]}),this._buttonPrev=Array(Sx).fill(0)}read(){const t=navigator.getGamepads();for(let e=0;e<t.length;e++){const s=t[e];if(!s)continue;if("standard"!==s.mapping)continue;if(s.axes.length<4)continue;if(s.buttons.length<Sx)continue;const{buttons:i,axes:n}=s;for(let t=0;t<this._buttonPrev.length;t++){const e=+i[t].pressed;this.deltas.buttons[t]=e-this._buttonPrev[t],this._buttonPrev[t]=e}this.deltas.leftStick.append([n[0],n[1]]),this.deltas.rightStick.append([n[2],n[3]])}return super.read()}}const wx=(t,e)=>1-Math.pow(t,1e3*e),Tx=new rs,Ex=new rs,Cx=new rs,Ax=new rs,Dx=new rs,Px=new ms;class Lx extends ox{set pitchRange(t){this._targetPose.pitchRange.copy(t),this._pose.copy(this._targetPose.rotate(rs.ZERO))}get pitchRange(){return this._targetPose.pitchRange}set yawRange(t){this._targetPose.yawRange.copy(t),this._pose.copy(this._targetPose.rotate(rs.ZERO))}get yawRange(){return this._targetPose.yawRange}attach(t,e=!0){this._targetPose.copy(t),e||this._pose.copy(this._targetPose)}detach(){this._targetPose.copy(this._pose)}update(t,e){const{move:s,rotate:i}=t.read();return this._targetPose.rotate(Ex.set(-i[1],-i[0],0)),Px.setFromEulerAngles(this._pose.angles),Px.transformVector(rs.FORWARD,Cx),Px.transformVector(rs.RIGHT,Ax),Px.transformVector(rs.UP,Dx),Tx.set(0,0,0),Tx.add(Cx.mulScalar(s[2])),Tx.add(Ax.mulScalar(s[0])),Tx.add(Dx.mulScalar(s[1])),this._targetPose.move(Tx),this._pose.lerp(this._pose,this._targetPose,wx(this.moveDamping,e),wx(this.rotateDamping,e))}destroy(){this.detach()}constructor(...t){super(...t),this._targetPose=new sx,this.rotateDamping=.98,this.moveDamping=.98}}const Ix=new rs,Rx=new rs,Mx=new rs,kx=new ms;class Ox extends ox{set pitchRange(t){this._targetRootPose.pitchRange.copy(t),this._rootPose.copy(this._targetRootPose.rotate(rs.ZERO))}get pitchRange(){return this._targetRootPose.pitchRange}set yawRange(t){this._targetRootPose.yawRange.copy(t),this._rootPose.copy(this._targetRootPose.rotate(rs.ZERO))}get yawRange(){return this._targetRootPose.yawRange}set zoomRange(t){this._targetChildPose.zRange.copy(t),this._childPose.copy(this._targetChildPose.move(rs.ZERO))}get zoomRange(){return this._targetRootPose.zRange}attach(t,e=!0){this._targetRootPose.set(t.getFocus(Ix),t.angles,0),this._targetChildPose.position.set(0,0,t.distance),e||(this._rootPose.copy(this._targetRootPose),this._childPose.copy(this._targetChildPose))}detach(){this._targetRootPose.copy(this._rootPose),this._targetChildPose.copy(this._childPose)}update(t,e){const{move:s,rotate:i}=t.read();Rx.set(s[0],s[1],0),kx.setFromEulerAngles(this._rootPose.angles).transformVector(Rx,Rx),this._targetRootPose.move(Rx);const{z:n}=this._targetChildPose.position;return this._targetChildPose.move(Rx.set(0,0,n*(1+s[2])-n)),this._targetRootPose.rotate(Mx.set(-i[1],-i[0],0)),this._rootPose.lerp(this._rootPose,this._targetRootPose,wx(this.moveDamping,e),wx(this.rotateDamping,e),1),this._childPose.lerp(this._childPose,this._targetChildPose,wx(this.zoomDamping,e),1,1),kx.setFromEulerAngles(this._rootPose.angles).transformVector(this._childPose.position,Rx).add(this._rootPose.position),this._pose.set(Rx,this._rootPose.angles,this._childPose.position.z)}destroy(){this.detach()}constructor(...t){super(...t),this._targetRootPose=new sx,this._rootPose=new sx,this._targetChildPose=new sx,this._childPose=new sx,this.rotateDamping=.98,this.moveDamping=.98,this.zoomDamping=.98}}let Fx;function Nx(t){if(Fx.call(this,t),3===t);else this._blendState.setAlphaBlend(0,1,8)}const Bx=()=>{const t=Object.getOwnPropertyDescriptor(_d.prototype,"blendType");Fx=t.set,Object.defineProperty(_d.prototype,"blendType",{set(t){Nx.call(this,t)},get(){return t.get.call(this)}})};var Ux,zx,Vx,Hx,Gx={exports:{}},Wx={},jx={exports:{}},Xx={};function $x(){return Ux||(Ux=1,function(t){function e(t,e){var s=t.length;t.push(e);t:for(;0<s;){var i=s-1>>>1,r=t[i];if(!(0<n(r,e)))break t;t[i]=e,t[s]=r,s=i}}function s(t){return 0===t.length?null:t[0]}function i(t){if(0===t.length)return null;var e=t[0],s=t.pop();if(s!==e){t[0]=s;t:for(var i=0,r=t.length,a=r>>>1;i<a;){var o=2*(i+1)-1,l=t[o],h=o+1,c=t[h];if(0>n(l,s))h<r&&0>n(c,l)?(t[i]=c,t[h]=s,i=h):(t[i]=l,t[o]=s,i=o);else{if(!(h<r&&0>n(c,s)))break t;t[i]=c,t[h]=s,i=h}}}return e}function n(t,e){var s=t.sortIndex-e.sortIndex;return 0!==s?s:t.id-e.id}if("object"==typeof performance&&"function"==typeof performance.now){var r=performance;t.unstable_now=function(){return r.now()}}else{var a=Date,o=a.now();t.unstable_now=function(){return a.now()-o}}var l=[],h=[],c=1,d=null,u=3,f=!1,p=!1,m=!1,_="function"==typeof setTimeout?setTimeout:null,g="function"==typeof clearTimeout?clearTimeout:null,v="undefined"!=typeof setImmediate?setImmediate:null;function b(t){for(var n=s(h);null!==n;){if(null===n.callback)i(h);else{if(!(n.startTime<=t))break;i(h),n.sortIndex=n.expirationTime,e(l,n)}n=s(h)}}function y(t){if(m=!1,b(t),!p)if(null!==s(l))p=!0,R(S);else{var e=s(h);null!==e&&M(y,e.startTime-t)}}function S(e,n){p=!1,m&&(m=!1,g(E),E=-1),f=!0;var r=u;try{for(b(n),d=s(l);null!==d&&(!(d.expirationTime>n)||e&&!D());){var a=d.callback;if("function"==typeof a){d.callback=null,u=d.priorityLevel;var o=a(d.expirationTime<=n);n=t.unstable_now(),"function"==typeof o?d.callback=o:d===s(l)&&i(l),b(n)}else i(l);d=s(l)}if(null!==d)var c=!0;else{var _=s(h);null!==_&&M(y,_.startTime-n),c=!1}return c}finally{d=null,u=r,f=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var x,w=!1,T=null,E=-1,C=5,A=-1;function D(){return!(t.unstable_now()-A<C)}function P(){if(null!==T){var e=t.unstable_now();A=e;var s=!0;try{s=T(!0,e)}finally{s?x():(w=!1,T=null)}}else w=!1}if("function"==typeof v)x=function(){v(P)};else if("undefined"!=typeof MessageChannel){var L=new MessageChannel,I=L.port2;L.port1.onmessage=P,x=function(){I.postMessage(null)}}else x=function(){_(P,0)};function R(t){T=t,w||(w=!0,x())}function M(e,s){E=_((function(){e(t.unstable_now())}),s)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(t){t.callback=null},t.unstable_continueExecution=function(){p||f||(p=!0,R(S))},t.unstable_forceFrameRate=function(t){0>t||125<t?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):C=0<t?Math.floor(1e3/t):5},t.unstable_getCurrentPriorityLevel=function(){return u},t.unstable_getFirstCallbackNode=function(){return s(l)},t.unstable_next=function(t){switch(u){case 1:case 2:case 3:var e=3;break;default:e=u}var s=u;u=e;try{return t()}finally{u=s}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=function(){},t.unstable_runWithPriority=function(t,e){switch(t){case 1:case 2:case 3:case 4:case 5:break;default:t=3}var s=u;u=t;try{return e()}finally{u=s}},t.unstable_scheduleCallback=function(i,n,r){var a=t.unstable_now();switch("object"==typeof r&&null!==r?r="number"==typeof(r=r.delay)&&0<r?a+r:a:r=a,i){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return i={id:c++,callback:n,priorityLevel:i,startTime:r,expirationTime:o=r+o,sortIndex:-1},r>a?(i.sortIndex=r,e(h,i),null===s(l)&&i===s(h)&&(m?(g(E),E=-1):m=!0,M(y,r-a))):(i.sortIndex=o,e(l,i),p||f||(p=!0,R(S))),i},t.unstable_shouldYield=D,t.unstable_wrapCallback=function(t){var e=u;return function(){var s=u;u=e;try{return t.apply(this,arguments)}finally{u=s}}}}(Xx)),Xx}function qx(){return zx||(zx=1,jx.exports=$x()),jx.exports}
/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */function Kx(){if(Vx)return Wx;Vx=1;var t=c(),e=qx();function s(t){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+t,s=1;s<arguments.length;s++)e+="&args[]="+encodeURIComponent(arguments[s]);return"Minified React error #"+t+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var i=new Set,n={};function r(t,e){a(t,e),a(t+"Capture",e)}function a(t,e){for(n[t]=e,t=0;t<e.length;t++)i.add(e[t])}var o=!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement),l=Object.prototype.hasOwnProperty,h=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,d={},u={};function f(t,e,s,i,n,r,a){this.acceptsBooleans=2===e||3===e||4===e,this.attributeName=i,this.attributeNamespace=n,this.mustUseProperty=s,this.propertyName=t,this.type=e,this.sanitizeURL=r,this.removeEmptyString=a}var p={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(t){p[t]=new f(t,0,!1,t,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(t){var e=t[0];p[e]=new f(e,1,!1,t[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(t){p[t]=new f(t,2,!1,t.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(t){p[t]=new f(t,2,!1,t,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(t){p[t]=new f(t,3,!1,t.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(t){p[t]=new f(t,3,!0,t,null,!1,!1)})),["capture","download"].forEach((function(t){p[t]=new f(t,4,!1,t,null,!1,!1)})),["cols","rows","size","span"].forEach((function(t){p[t]=new f(t,6,!1,t,null,!1,!1)})),["rowSpan","start"].forEach((function(t){p[t]=new f(t,5,!1,t.toLowerCase(),null,!1,!1)}));var m=/[\-:]([a-z])/g;function _(t){return t[1].toUpperCase()}function g(t,e,s,i){var n=p.hasOwnProperty(e)?p[e]:null;(null!==n?0!==n.type:i||!(2<e.length)||"o"!==e[0]&&"O"!==e[0]||"n"!==e[1]&&"N"!==e[1])&&(function(t,e,s,i){if(null==e||function(t,e,s,i){if(null!==s&&0===s.type)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return!i&&(null!==s?!s.acceptsBooleans:"data-"!==(t=t.toLowerCase().slice(0,5))&&"aria-"!==t);default:return!1}}(t,e,s,i))return!0;if(i)return!1;if(null!==s)switch(s.type){case 3:return!e;case 4:return!1===e;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}(e,s,n,i)&&(s=null),i||null===n?function(t){return!!l.call(u,t)||!l.call(d,t)&&(h.test(t)?u[t]=!0:(d[t]=!0,!1))}(e)&&(null===s?t.removeAttribute(e):t.setAttribute(e,""+s)):n.mustUseProperty?t[n.propertyName]=null===s?3!==n.type&&"":s:(e=n.attributeName,i=n.attributeNamespace,null===s?t.removeAttribute(e):(s=3===(n=n.type)||4===n&&!0===s?"":""+s,i?t.setAttributeNS(i,e,s):t.setAttribute(e,s))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(t){var e=t.replace(m,_);p[e]=new f(e,1,!1,t,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(t){var e=t.replace(m,_);p[e]=new f(e,1,!1,t,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(t){var e=t.replace(m,_);p[e]=new f(e,1,!1,t,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(t){p[t]=new f(t,1,!1,t.toLowerCase(),null,!1,!1)})),p.xlinkHref=new f("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(t){p[t]=new f(t,1,!1,t.toLowerCase(),null,!0,!0)}));var v=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,b=Symbol.for("react.element"),y=Symbol.for("react.portal"),S=Symbol.for("react.fragment"),x=Symbol.for("react.strict_mode"),w=Symbol.for("react.profiler"),T=Symbol.for("react.provider"),E=Symbol.for("react.context"),C=Symbol.for("react.forward_ref"),A=Symbol.for("react.suspense"),D=Symbol.for("react.suspense_list"),P=Symbol.for("react.memo"),L=Symbol.for("react.lazy"),I=Symbol.for("react.offscreen"),R=Symbol.iterator;function M(t){return null===t||"object"!=typeof t?null:"function"==typeof(t=R&&t[R]||t["@@iterator"])?t:null}var k,O=Object.assign;function F(t){if(void 0===k)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);k=e&&e[1]||""}return"\n"+k+t}var N=!1;function B(t,e){if(!t||N)return"";N=!0;var s=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(e,[])}catch(t){var i=t}Reflect.construct(t,[],e)}else{try{e.call()}catch(t){i=t}t.call(e.prototype)}else{try{throw Error()}catch(t){i=t}t()}}catch(e){if(e&&i&&"string"==typeof e.stack){for(var n=e.stack.split("\n"),r=i.stack.split("\n"),a=n.length-1,o=r.length-1;1<=a&&0<=o&&n[a]!==r[o];)o--;for(;1<=a&&0<=o;a--,o--)if(n[a]!==r[o]){if(1!==a||1!==o)do{if(a--,0>--o||n[a]!==r[o]){var l="\n"+n[a].replace(" at new "," at ");return t.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",t.displayName)),l}}while(1<=a&&0<=o);break}}}finally{N=!1,Error.prepareStackTrace=s}return(t=t?t.displayName||t.name:"")?F(t):""}function U(t){switch(t.tag){case 5:return F(t.type);case 16:return F("Lazy");case 13:return F("Suspense");case 19:return F("SuspenseList");case 0:case 2:case 15:return t=B(t.type,!1);case 11:return t=B(t.type.render,!1);case 1:return t=B(t.type,!0);default:return""}}function z(t){if(null==t)return null;if("function"==typeof t)return t.displayName||t.name||null;if("string"==typeof t)return t;switch(t){case S:return"Fragment";case y:return"Portal";case w:return"Profiler";case x:return"StrictMode";case A:return"Suspense";case D:return"SuspenseList"}if("object"==typeof t)switch(t.$$typeof){case E:return(t.displayName||"Context")+".Consumer";case T:return(t._context.displayName||"Context")+".Provider";case C:var e=t.render;return(t=t.displayName)||(t=""!==(t=e.displayName||e.name||"")?"ForwardRef("+t+")":"ForwardRef"),t;case P:return null!==(e=t.displayName||null)?e:z(t.type)||"Memo";case L:e=t._payload,t=t._init;try{return z(t(e))}catch(t){}}return null}function V(t){var e=t.type;switch(t.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return t=(t=e.render).displayName||t.name||"",e.displayName||(""!==t?"ForwardRef("+t+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return z(e);case 8:return e===x?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e}return null}function H(t){switch(typeof t){case"boolean":case"number":case"string":case"undefined":case"object":return t;default:return""}}function G(t){var e=t.type;return(t=t.nodeName)&&"input"===t.toLowerCase()&&("checkbox"===e||"radio"===e)}function W(t){t._valueTracker||(t._valueTracker=function(t){var e=G(t)?"checked":"value",s=Object.getOwnPropertyDescriptor(t.constructor.prototype,e),i=""+t[e];if(!t.hasOwnProperty(e)&&void 0!==s&&"function"==typeof s.get&&"function"==typeof s.set){var n=s.get,r=s.set;return Object.defineProperty(t,e,{configurable:!0,get:function(){return n.call(this)},set:function(t){i=""+t,r.call(this,t)}}),Object.defineProperty(t,e,{enumerable:s.enumerable}),{getValue:function(){return i},setValue:function(t){i=""+t},stopTracking:function(){t._valueTracker=null,delete t[e]}}}}(t))}function j(t){if(!t)return!1;var e=t._valueTracker;if(!e)return!0;var s=e.getValue(),i="";return t&&(i=G(t)?t.checked?"true":"false":t.value),(t=i)!==s&&(e.setValue(t),!0)}function X(t){if(void 0===(t=t||("undefined"!=typeof document?document:void 0)))return null;try{return t.activeElement||t.body}catch(e){return t.body}}function $(t,e){var s=e.checked;return O({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=s?s:t._wrapperState.initialChecked})}function q(t,e){var s=null==e.defaultValue?"":e.defaultValue,i=null!=e.checked?e.checked:e.defaultChecked;s=H(null!=e.value?e.value:s),t._wrapperState={initialChecked:i,initialValue:s,controlled:"checkbox"===e.type||"radio"===e.type?null!=e.checked:null!=e.value}}function K(t,e){null!=(e=e.checked)&&g(t,"checked",e,!1)}function Y(t,e){K(t,e);var s=H(e.value),i=e.type;if(null!=s)"number"===i?(0===s&&""===t.value||t.value!=s)&&(t.value=""+s):t.value!==""+s&&(t.value=""+s);else if("submit"===i||"reset"===i)return void t.removeAttribute("value");e.hasOwnProperty("value")?Z(t,e.type,s):e.hasOwnProperty("defaultValue")&&Z(t,e.type,H(e.defaultValue)),null==e.checked&&null!=e.defaultChecked&&(t.defaultChecked=!!e.defaultChecked)}function Q(t,e,s){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var i=e.type;if(!("submit"!==i&&"reset"!==i||void 0!==e.value&&null!==e.value))return;e=""+t._wrapperState.initialValue,s||e===t.value||(t.value=e),t.defaultValue=e}""!==(s=t.name)&&(t.name=""),t.defaultChecked=!!t._wrapperState.initialChecked,""!==s&&(t.name=s)}function Z(t,e,s){"number"===e&&X(t.ownerDocument)===t||(null==s?t.defaultValue=""+t._wrapperState.initialValue:t.defaultValue!==""+s&&(t.defaultValue=""+s))}var J=Array.isArray;function tt(t,e,s,i){if(t=t.options,e){e={};for(var n=0;n<s.length;n++)e["$"+s[n]]=!0;for(s=0;s<t.length;s++)n=e.hasOwnProperty("$"+t[s].value),t[s].selected!==n&&(t[s].selected=n),n&&i&&(t[s].defaultSelected=!0)}else{for(s=""+H(s),e=null,n=0;n<t.length;n++){if(t[n].value===s)return t[n].selected=!0,void(i&&(t[n].defaultSelected=!0));null!==e||t[n].disabled||(e=t[n])}null!==e&&(e.selected=!0)}}function et(t,e){if(null!=e.dangerouslySetInnerHTML)throw Error(s(91));return O({},e,{value:void 0,defaultValue:void 0,children:""+t._wrapperState.initialValue})}function st(t,e){var i=e.value;if(null==i){if(i=e.children,e=e.defaultValue,null!=i){if(null!=e)throw Error(s(92));if(J(i)){if(1<i.length)throw Error(s(93));i=i[0]}e=i}null==e&&(e=""),i=e}t._wrapperState={initialValue:H(i)}}function it(t,e){var s=H(e.value),i=H(e.defaultValue);null!=s&&((s=""+s)!==t.value&&(t.value=s),null==e.defaultValue&&t.defaultValue!==s&&(t.defaultValue=s)),null!=i&&(t.defaultValue=""+i)}function nt(t){var e=t.textContent;e===t._wrapperState.initialValue&&""!==e&&null!==e&&(t.value=e)}function rt(t){switch(t){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function at(t,e){return null==t||"http://www.w3.org/1999/xhtml"===t?rt(e):"http://www.w3.org/2000/svg"===t&&"foreignObject"===e?"http://www.w3.org/1999/xhtml":t}var ot,lt,ht=(lt=function(t,e){if("http://www.w3.org/2000/svg"!==t.namespaceURI||"innerHTML"in t)t.innerHTML=e;else{for((ot=ot||document.createElement("div")).innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=ot.firstChild;t.firstChild;)t.removeChild(t.firstChild);for(;e.firstChild;)t.appendChild(e.firstChild)}},"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(t,e,s,i){MSApp.execUnsafeLocalFunction((function(){return lt(t,e)}))}:lt);function ct(t,e){if(e){var s=t.firstChild;if(s&&s===t.lastChild&&3===s.nodeType)return void(s.nodeValue=e)}t.textContent=e}var dt={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},ut=["Webkit","ms","Moz","O"];function ft(t,e,s){return null==e||"boolean"==typeof e||""===e?"":s||"number"!=typeof e||0===e||dt.hasOwnProperty(t)&&dt[t]?(""+e).trim():e+"px"}function pt(t,e){for(var s in t=t.style,e)if(e.hasOwnProperty(s)){var i=0===s.indexOf("--"),n=ft(s,e[s],i);"float"===s&&(s="cssFloat"),i?t.setProperty(s,n):t[s]=n}}Object.keys(dt).forEach((function(t){ut.forEach((function(e){e=e+t.charAt(0).toUpperCase()+t.substring(1),dt[e]=dt[t]}))}));var mt=O({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function _t(t,e){if(e){if(mt[t]&&(null!=e.children||null!=e.dangerouslySetInnerHTML))throw Error(s(137,t));if(null!=e.dangerouslySetInnerHTML){if(null!=e.children)throw Error(s(60));if("object"!=typeof e.dangerouslySetInnerHTML||!("__html"in e.dangerouslySetInnerHTML))throw Error(s(61))}if(null!=e.style&&"object"!=typeof e.style)throw Error(s(62))}}function gt(t,e){if(-1===t.indexOf("-"))return"string"==typeof e.is;switch(t){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var vt=null;function bt(t){return(t=t.target||t.srcElement||window).correspondingUseElement&&(t=t.correspondingUseElement),3===t.nodeType?t.parentNode:t}var yt=null,St=null,xt=null;function wt(t){if(t=gn(t)){if("function"!=typeof yt)throw Error(s(280));var e=t.stateNode;e&&(e=bn(e),yt(t.stateNode,t.type,e))}}function Tt(t){St?xt?xt.push(t):xt=[t]:St=t}function Et(){if(St){var t=St,e=xt;if(xt=St=null,wt(t),e)for(t=0;t<e.length;t++)wt(e[t])}}function Ct(t,e){return t(e)}function At(){}var Dt=!1;function Pt(t,e,s){if(Dt)return t(e,s);Dt=!0;try{return Ct(t,e,s)}finally{Dt=!1,(null!==St||null!==xt)&&(At(),Et())}}function Lt(t,e){var i=t.stateNode;if(null===i)return null;var n=bn(i);if(null===n)return null;i=n[e];t:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(n=!n.disabled)||(n=!("button"===(t=t.type)||"input"===t||"select"===t||"textarea"===t)),t=!n;break t;default:t=!1}if(t)return null;if(i&&"function"!=typeof i)throw Error(s(231,e,typeof i));return i}var It=!1;if(o)try{var Rt={};Object.defineProperty(Rt,"passive",{get:function(){It=!0}}),window.addEventListener("test",Rt,Rt),window.removeEventListener("test",Rt,Rt)}catch(lt){It=!1}function Mt(t,e,s,i,n,r,a,o,l){var h=Array.prototype.slice.call(arguments,3);try{e.apply(s,h)}catch(t){this.onError(t)}}var kt=!1,Ot=null,Ft=!1,Nt=null,Bt={onError:function(t){kt=!0,Ot=t}};function Ut(t,e,s,i,n,r,a,o,l){kt=!1,Ot=null,Mt.apply(Bt,arguments)}function zt(t){var e=t,s=t;if(t.alternate)for(;e.return;)e=e.return;else{t=e;do{!!(4098&(e=t).flags)&&(s=e.return),t=e.return}while(t)}return 3===e.tag?s:null}function Vt(t){if(13===t.tag){var e=t.memoizedState;if(null===e&&(null!==(t=t.alternate)&&(e=t.memoizedState)),null!==e)return e.dehydrated}return null}function Ht(t){if(zt(t)!==t)throw Error(s(188))}function Gt(t){return t=function(t){var e=t.alternate;if(!e){if(null===(e=zt(t)))throw Error(s(188));return e!==t?null:t}for(var i=t,n=e;;){var r=i.return;if(null===r)break;var a=r.alternate;if(null===a){if(null!==(n=r.return)){i=n;continue}break}if(r.child===a.child){for(a=r.child;a;){if(a===i)return Ht(r),t;if(a===n)return Ht(r),e;a=a.sibling}throw Error(s(188))}if(i.return!==n.return)i=r,n=a;else{for(var o=!1,l=r.child;l;){if(l===i){o=!0,i=r,n=a;break}if(l===n){o=!0,n=r,i=a;break}l=l.sibling}if(!o){for(l=a.child;l;){if(l===i){o=!0,i=a,n=r;break}if(l===n){o=!0,n=a,i=r;break}l=l.sibling}if(!o)throw Error(s(189))}}if(i.alternate!==n)throw Error(s(190))}if(3!==i.tag)throw Error(s(188));return i.stateNode.current===i?t:e}(t),null!==t?Wt(t):null}function Wt(t){if(5===t.tag||6===t.tag)return t;for(t=t.child;null!==t;){var e=Wt(t);if(null!==e)return e;t=t.sibling}return null}var jt=e.unstable_scheduleCallback,Xt=e.unstable_cancelCallback,$t=e.unstable_shouldYield,qt=e.unstable_requestPaint,Kt=e.unstable_now,Yt=e.unstable_getCurrentPriorityLevel,Qt=e.unstable_ImmediatePriority,Zt=e.unstable_UserBlockingPriority,Jt=e.unstable_NormalPriority,te=e.unstable_LowPriority,ee=e.unstable_IdlePriority,se=null,ie=null;var ne=Math.clz32?Math.clz32:function(t){return t>>>=0,0===t?32:31-(re(t)/ae|0)|0},re=Math.log,ae=Math.LN2;var oe=64,le=4194304;function he(t){switch(t&-t){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&t;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&t;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return t}}function ce(t,e){var s=t.pendingLanes;if(0===s)return 0;var i=0,n=t.suspendedLanes,r=t.pingedLanes,a=268435455&s;if(0!==a){var o=a&~n;0!==o?i=he(o):0!==(r&=a)&&(i=he(r))}else 0!==(a=s&~n)?i=he(a):0!==r&&(i=he(r));if(0===i)return 0;if(0!==e&&e!==i&&0===(e&n)&&((n=i&-i)>=(r=e&-e)||16===n&&4194240&r))return e;if(4&i&&(i|=16&s),0!==(e=t.entangledLanes))for(t=t.entanglements,e&=i;0<e;)n=1<<(s=31-ne(e)),i|=t[s],e&=~n;return i}function de(t,e){switch(t){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;default:return-1}}function ue(t){return 0!==(t=-1073741825&t.pendingLanes)?t:1073741824&t?1073741824:0}function fe(){var t=oe;return!(4194240&(oe<<=1))&&(oe=64),t}function pe(t){for(var e=[],s=0;31>s;s++)e.push(t);return e}function me(t,e,s){t.pendingLanes|=e,536870912!==e&&(t.suspendedLanes=0,t.pingedLanes=0),(t=t.eventTimes)[e=31-ne(e)]=s}function _e(t,e){var s=t.entangledLanes|=e;for(t=t.entanglements;s;){var i=31-ne(s),n=1<<i;n&e|t[i]&e&&(t[i]|=e),s&=~n}}var ge=0;function ve(t){return 1<(t&=-t)?4<t?268435455&t?16:536870912:4:1}var be,ye,Se,xe,we,Te=!1,Ee=[],Ce=null,Ae=null,De=null,Pe=new Map,Le=new Map,Ie=[],Re="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Me(t,e){switch(t){case"focusin":case"focusout":Ce=null;break;case"dragenter":case"dragleave":Ae=null;break;case"mouseover":case"mouseout":De=null;break;case"pointerover":case"pointerout":Pe.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":Le.delete(e.pointerId)}}function ke(t,e,s,i,n,r){return null===t||t.nativeEvent!==r?(t={blockedOn:e,domEventName:s,eventSystemFlags:i,nativeEvent:r,targetContainers:[n]},null!==e&&(null!==(e=gn(e))&&ye(e)),t):(t.eventSystemFlags|=i,e=t.targetContainers,null!==n&&-1===e.indexOf(n)&&e.push(n),t)}function Oe(t){var e=_n(t.target);if(null!==e){var s=zt(e);if(null!==s)if(13===(e=s.tag)){if(null!==(e=Vt(s)))return t.blockedOn=e,void we(t.priority,(function(){Se(s)}))}else if(3===e&&s.stateNode.current.memoizedState.isDehydrated)return void(t.blockedOn=3===s.tag?s.stateNode.containerInfo:null)}t.blockedOn=null}function Fe(t){if(null!==t.blockedOn)return!1;for(var e=t.targetContainers;0<e.length;){var s=$e(t.domEventName,t.eventSystemFlags,e[0],t.nativeEvent);if(null!==s)return null!==(e=gn(s))&&ye(e),t.blockedOn=s,!1;var i=new(s=t.nativeEvent).constructor(s.type,s);vt=i,s.target.dispatchEvent(i),vt=null,e.shift()}return!0}function Ne(t,e,s){Fe(t)&&s.delete(e)}function Be(){Te=!1,null!==Ce&&Fe(Ce)&&(Ce=null),null!==Ae&&Fe(Ae)&&(Ae=null),null!==De&&Fe(De)&&(De=null),Pe.forEach(Ne),Le.forEach(Ne)}function Ue(t,s){t.blockedOn===s&&(t.blockedOn=null,Te||(Te=!0,e.unstable_scheduleCallback(e.unstable_NormalPriority,Be)))}function ze(t){function e(e){return Ue(e,t)}if(0<Ee.length){Ue(Ee[0],t);for(var s=1;s<Ee.length;s++){var i=Ee[s];i.blockedOn===t&&(i.blockedOn=null)}}for(null!==Ce&&Ue(Ce,t),null!==Ae&&Ue(Ae,t),null!==De&&Ue(De,t),Pe.forEach(e),Le.forEach(e),s=0;s<Ie.length;s++)(i=Ie[s]).blockedOn===t&&(i.blockedOn=null);for(;0<Ie.length&&null===(s=Ie[0]).blockedOn;)Oe(s),null===s.blockedOn&&Ie.shift()}var Ve=v.ReactCurrentBatchConfig,He=!0;function Ge(t,e,s,i){var n=ge,r=Ve.transition;Ve.transition=null;try{ge=1,je(t,e,s,i)}finally{ge=n,Ve.transition=r}}function We(t,e,s,i){var n=ge,r=Ve.transition;Ve.transition=null;try{ge=4,je(t,e,s,i)}finally{ge=n,Ve.transition=r}}function je(t,e,s,i){if(He){var n=$e(t,e,s,i);if(null===n)Vi(t,e,i,Xe,s),Me(t,i);else if(function(t,e,s,i,n){switch(e){case"focusin":return Ce=ke(Ce,t,e,s,i,n),!0;case"dragenter":return Ae=ke(Ae,t,e,s,i,n),!0;case"mouseover":return De=ke(De,t,e,s,i,n),!0;case"pointerover":var r=n.pointerId;return Pe.set(r,ke(Pe.get(r)||null,t,e,s,i,n)),!0;case"gotpointercapture":return r=n.pointerId,Le.set(r,ke(Le.get(r)||null,t,e,s,i,n)),!0}return!1}(n,t,e,s,i))i.stopPropagation();else if(Me(t,i),4&e&&-1<Re.indexOf(t)){for(;null!==n;){var r=gn(n);if(null!==r&&be(r),null===(r=$e(t,e,s,i))&&Vi(t,e,i,Xe,s),r===n)break;n=r}null!==n&&i.stopPropagation()}else Vi(t,e,i,null,s)}}var Xe=null;function $e(t,e,s,i){if(Xe=null,null!==(t=_n(t=bt(i))))if(null===(e=zt(t)))t=null;else if(13===(s=e.tag)){if(null!==(t=Vt(e)))return t;t=null}else if(3===s){if(e.stateNode.current.memoizedState.isDehydrated)return 3===e.tag?e.stateNode.containerInfo:null;t=null}else e!==t&&(t=null);return Xe=t,null}function qe(t){switch(t){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Yt()){case Qt:return 1;case Zt:return 4;case Jt:case te:return 16;case ee:return 536870912;default:return 16}default:return 16}}var Ke=null,Ye=null,Qe=null;function Ze(){if(Qe)return Qe;var t,e,s=Ye,i=s.length,n="value"in Ke?Ke.value:Ke.textContent,r=n.length;for(t=0;t<i&&s[t]===n[t];t++);var a=i-t;for(e=1;e<=a&&s[i-e]===n[r-e];e++);return Qe=n.slice(t,1<e?1-e:void 0)}function Je(t){var e=t.keyCode;return"charCode"in t?0===(t=t.charCode)&&13===e&&(t=13):t=e,10===t&&(t=13),32<=t||13===t?t:0}function ts(){return!0}function es(){return!1}function ss(t){function e(e,s,i,n,r){for(var a in this._reactName=e,this._targetInst=i,this.type=s,this.nativeEvent=n,this.target=r,this.currentTarget=null,t)t.hasOwnProperty(a)&&(e=t[a],this[a]=e?e(n):n[a]);return this.isDefaultPrevented=(null!=n.defaultPrevented?n.defaultPrevented:!1===n.returnValue)?ts:es,this.isPropagationStopped=es,this}return O(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():"unknown"!=typeof t.returnValue&&(t.returnValue=!1),this.isDefaultPrevented=ts)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():"unknown"!=typeof t.cancelBubble&&(t.cancelBubble=!0),this.isPropagationStopped=ts)},persist:function(){},isPersistent:ts}),e}var is,ns,rs,as={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(t){return t.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},os=ss(as),ls=O({},as,{view:0,detail:0}),hs=ss(ls),cs=O({},ls,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:xs,button:0,buttons:0,relatedTarget:function(t){return void 0===t.relatedTarget?t.fromElement===t.srcElement?t.toElement:t.fromElement:t.relatedTarget},movementX:function(t){return"movementX"in t?t.movementX:(t!==rs&&(rs&&"mousemove"===t.type?(is=t.screenX-rs.screenX,ns=t.screenY-rs.screenY):ns=is=0,rs=t),is)},movementY:function(t){return"movementY"in t?t.movementY:ns}}),ds=ss(cs),us=ss(O({},cs,{dataTransfer:0})),fs=ss(O({},ls,{relatedTarget:0})),ps=ss(O({},as,{animationName:0,elapsedTime:0,pseudoElement:0})),ms=O({},as,{clipboardData:function(t){return"clipboardData"in t?t.clipboardData:window.clipboardData}}),_s=ss(ms),gs=ss(O({},as,{data:0})),vs={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},bs={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},ys={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Ss(t){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(t):!!(t=ys[t])&&!!e[t]}function xs(){return Ss}var ws=O({},ls,{key:function(t){if(t.key){var e=vs[t.key]||t.key;if("Unidentified"!==e)return e}return"keypress"===t.type?13===(t=Je(t))?"Enter":String.fromCharCode(t):"keydown"===t.type||"keyup"===t.type?bs[t.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:xs,charCode:function(t){return"keypress"===t.type?Je(t):0},keyCode:function(t){return"keydown"===t.type||"keyup"===t.type?t.keyCode:0},which:function(t){return"keypress"===t.type?Je(t):"keydown"===t.type||"keyup"===t.type?t.keyCode:0}}),Ts=ss(ws),Es=ss(O({},cs,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),Cs=ss(O({},ls,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:xs})),As=ss(O({},as,{propertyName:0,elapsedTime:0,pseudoElement:0})),Ds=O({},cs,{deltaX:function(t){return"deltaX"in t?t.deltaX:"wheelDeltaX"in t?-t.wheelDeltaX:0},deltaY:function(t){return"deltaY"in t?t.deltaY:"wheelDeltaY"in t?-t.wheelDeltaY:"wheelDelta"in t?-t.wheelDelta:0},deltaZ:0,deltaMode:0}),Ps=ss(Ds),Ls=[9,13,27,32],Is=o&&"CompositionEvent"in window,Rs=null;o&&"documentMode"in document&&(Rs=document.documentMode);var Ms=o&&"TextEvent"in window&&!Rs,ks=o&&(!Is||Rs&&8<Rs&&11>=Rs),Os=String.fromCharCode(32),Fs=!1;function Ns(t,e){switch(t){case"keyup":return-1!==Ls.indexOf(e.keyCode);case"keydown":return 229!==e.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Bs(t){return"object"==typeof(t=t.detail)&&"data"in t?t.data:null}var Us=!1;var zs={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Vs(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return"input"===e?!!zs[t.type]:"textarea"===e}function Hs(t,e,s,i){Tt(i),0<(e=Gi(e,"onChange")).length&&(s=new os("onChange","change",null,s,i),t.push({event:s,listeners:e}))}var Gs=null,Ws=null;function js(t){Oi(t,0)}function Xs(t){if(j(vn(t)))return t}function $s(t,e){if("change"===t)return e}var qs=!1;if(o){var Ks;if(o){var Ys="oninput"in document;if(!Ys){var Qs=document.createElement("div");Qs.setAttribute("oninput","return;"),Ys="function"==typeof Qs.oninput}Ks=Ys}else Ks=!1;qs=Ks&&(!document.documentMode||9<document.documentMode)}function Zs(){Gs&&(Gs.detachEvent("onpropertychange",Js),Ws=Gs=null)}function Js(t){if("value"===t.propertyName&&Xs(Ws)){var e=[];Hs(e,Ws,t,bt(t)),Pt(js,e)}}function ti(t,e,s){"focusin"===t?(Zs(),Ws=s,(Gs=e).attachEvent("onpropertychange",Js)):"focusout"===t&&Zs()}function ei(t){if("selectionchange"===t||"keyup"===t||"keydown"===t)return Xs(Ws)}function si(t,e){if("click"===t)return Xs(e)}function ii(t,e){if("input"===t||"change"===t)return Xs(e)}var ni="function"==typeof Object.is?Object.is:function(t,e){return t===e&&(0!==t||1/t==1/e)||t!=t&&e!=e};function ri(t,e){if(ni(t,e))return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;var s=Object.keys(t),i=Object.keys(e);if(s.length!==i.length)return!1;for(i=0;i<s.length;i++){var n=s[i];if(!l.call(e,n)||!ni(t[n],e[n]))return!1}return!0}function ai(t){for(;t&&t.firstChild;)t=t.firstChild;return t}function oi(t,e){var s,i=ai(t);for(t=0;i;){if(3===i.nodeType){if(s=t+i.textContent.length,t<=e&&s>=e)return{node:i,offset:e-t};t=s}t:{for(;i;){if(i.nextSibling){i=i.nextSibling;break t}i=i.parentNode}i=void 0}i=ai(i)}}function li(t,e){return!(!t||!e)&&(t===e||(!t||3!==t.nodeType)&&(e&&3===e.nodeType?li(t,e.parentNode):"contains"in t?t.contains(e):!!t.compareDocumentPosition&&!!(16&t.compareDocumentPosition(e))))}function hi(){for(var t=window,e=X();e instanceof t.HTMLIFrameElement;){try{var s="string"==typeof e.contentWindow.location.href}catch(t){s=!1}if(!s)break;e=X((t=e.contentWindow).document)}return e}function ci(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return e&&("input"===e&&("text"===t.type||"search"===t.type||"tel"===t.type||"url"===t.type||"password"===t.type)||"textarea"===e||"true"===t.contentEditable)}function di(t){var e=hi(),s=t.focusedElem,i=t.selectionRange;if(e!==s&&s&&s.ownerDocument&&li(s.ownerDocument.documentElement,s)){if(null!==i&&ci(s))if(e=i.start,void 0===(t=i.end)&&(t=e),"selectionStart"in s)s.selectionStart=e,s.selectionEnd=Math.min(t,s.value.length);else if((t=(e=s.ownerDocument||document)&&e.defaultView||window).getSelection){t=t.getSelection();var n=s.textContent.length,r=Math.min(i.start,n);i=void 0===i.end?r:Math.min(i.end,n),!t.extend&&r>i&&(n=i,i=r,r=n),n=oi(s,r);var a=oi(s,i);n&&a&&(1!==t.rangeCount||t.anchorNode!==n.node||t.anchorOffset!==n.offset||t.focusNode!==a.node||t.focusOffset!==a.offset)&&((e=e.createRange()).setStart(n.node,n.offset),t.removeAllRanges(),r>i?(t.addRange(e),t.extend(a.node,a.offset)):(e.setEnd(a.node,a.offset),t.addRange(e)))}for(e=[],t=s;t=t.parentNode;)1===t.nodeType&&e.push({element:t,left:t.scrollLeft,top:t.scrollTop});for("function"==typeof s.focus&&s.focus(),s=0;s<e.length;s++)(t=e[s]).element.scrollLeft=t.left,t.element.scrollTop=t.top}}var ui=o&&"documentMode"in document&&11>=document.documentMode,fi=null,pi=null,mi=null,_i=!1;function gi(t,e,s){var i=s.window===s?s.document:9===s.nodeType?s:s.ownerDocument;_i||null==fi||fi!==X(i)||("selectionStart"in(i=fi)&&ci(i)?i={start:i.selectionStart,end:i.selectionEnd}:i={anchorNode:(i=(i.ownerDocument&&i.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:i.anchorOffset,focusNode:i.focusNode,focusOffset:i.focusOffset},mi&&ri(mi,i)||(mi=i,0<(i=Gi(pi,"onSelect")).length&&(e=new os("onSelect","select",null,e,s),t.push({event:e,listeners:i}),e.target=fi)))}function vi(t,e){var s={};return s[t.toLowerCase()]=e.toLowerCase(),s["Webkit"+t]="webkit"+e,s["Moz"+t]="moz"+e,s}var bi={animationend:vi("Animation","AnimationEnd"),animationiteration:vi("Animation","AnimationIteration"),animationstart:vi("Animation","AnimationStart"),transitionend:vi("Transition","TransitionEnd")},yi={},Si={};function xi(t){if(yi[t])return yi[t];if(!bi[t])return t;var e,s=bi[t];for(e in s)if(s.hasOwnProperty(e)&&e in Si)return yi[t]=s[e];return t}o&&(Si=document.createElement("div").style,"AnimationEvent"in window||(delete bi.animationend.animation,delete bi.animationiteration.animation,delete bi.animationstart.animation),"TransitionEvent"in window||delete bi.transitionend.transition);var wi=xi("animationend"),Ti=xi("animationiteration"),Ei=xi("animationstart"),Ci=xi("transitionend"),Ai=new Map,Di="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Pi(t,e){Ai.set(t,e),r(e,[t])}for(var Li=0;Li<Di.length;Li++){var Ii=Di[Li];Pi(Ii.toLowerCase(),"on"+(Ii[0].toUpperCase()+Ii.slice(1)))}Pi(wi,"onAnimationEnd"),Pi(Ti,"onAnimationIteration"),Pi(Ei,"onAnimationStart"),Pi("dblclick","onDoubleClick"),Pi("focusin","onFocus"),Pi("focusout","onBlur"),Pi(Ci,"onTransitionEnd"),a("onMouseEnter",["mouseout","mouseover"]),a("onMouseLeave",["mouseout","mouseover"]),a("onPointerEnter",["pointerout","pointerover"]),a("onPointerLeave",["pointerout","pointerover"]),r("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),r("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),r("onBeforeInput",["compositionend","keypress","textInput","paste"]),r("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),r("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),r("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Ri="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Mi=new Set("cancel close invalid load scroll toggle".split(" ").concat(Ri));function ki(t,e,i){var n=t.type||"unknown-event";t.currentTarget=i,function(t,e,i,n,r,a,o,l,h){if(Ut.apply(this,arguments),kt){if(!kt)throw Error(s(198));var c=Ot;kt=!1,Ot=null,Ft||(Ft=!0,Nt=c)}}(n,e,void 0,t),t.currentTarget=null}function Oi(t,e){e=!!(4&e);for(var s=0;s<t.length;s++){var i=t[s],n=i.event;i=i.listeners;t:{var r=void 0;if(e)for(var a=i.length-1;0<=a;a--){var o=i[a],l=o.instance,h=o.currentTarget;if(o=o.listener,l!==r&&n.isPropagationStopped())break t;ki(n,o,h),r=l}else for(a=0;a<i.length;a++){if(l=(o=i[a]).instance,h=o.currentTarget,o=o.listener,l!==r&&n.isPropagationStopped())break t;ki(n,o,h),r=l}}}if(Ft)throw t=Nt,Ft=!1,Nt=null,t}function Fi(t,e){var s=e[fn];void 0===s&&(s=e[fn]=new Set);var i=t+"__bubble";s.has(i)||(zi(e,t,2,!1),s.add(i))}function Ni(t,e,s){var i=0;e&&(i|=4),zi(s,t,i,e)}var Bi="_reactListening"+Math.random().toString(36).slice(2);function Ui(t){if(!t[Bi]){t[Bi]=!0,i.forEach((function(e){"selectionchange"!==e&&(Mi.has(e)||Ni(e,!1,t),Ni(e,!0,t))}));var e=9===t.nodeType?t:t.ownerDocument;null===e||e[Bi]||(e[Bi]=!0,Ni("selectionchange",!1,e))}}function zi(t,e,s,i){switch(qe(e)){case 1:var n=Ge;break;case 4:n=We;break;default:n=je}s=n.bind(null,e,s,t),n=void 0,!It||"touchstart"!==e&&"touchmove"!==e&&"wheel"!==e||(n=!0),i?void 0!==n?t.addEventListener(e,s,{capture:!0,passive:n}):t.addEventListener(e,s,!0):void 0!==n?t.addEventListener(e,s,{passive:n}):t.addEventListener(e,s,!1)}function Vi(t,e,s,i,n){var r=i;if(!(1&e||2&e||null===i))t:for(;;){if(null===i)return;var a=i.tag;if(3===a||4===a){var o=i.stateNode.containerInfo;if(o===n||8===o.nodeType&&o.parentNode===n)break;if(4===a)for(a=i.return;null!==a;){var l=a.tag;if((3===l||4===l)&&((l=a.stateNode.containerInfo)===n||8===l.nodeType&&l.parentNode===n))return;a=a.return}for(;null!==o;){if(null===(a=_n(o)))return;if(5===(l=a.tag)||6===l){i=r=a;continue t}o=o.parentNode}}i=i.return}Pt((function(){var i=r,n=bt(s),a=[];t:{var o=Ai.get(t);if(void 0!==o){var l=os,h=t;switch(t){case"keypress":if(0===Je(s))break t;case"keydown":case"keyup":l=Ts;break;case"focusin":h="focus",l=fs;break;case"focusout":h="blur",l=fs;break;case"beforeblur":case"afterblur":l=fs;break;case"click":if(2===s.button)break t;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":l=ds;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":l=us;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":l=Cs;break;case wi:case Ti:case Ei:l=ps;break;case Ci:l=As;break;case"scroll":l=hs;break;case"wheel":l=Ps;break;case"copy":case"cut":case"paste":l=_s;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":l=Es}var c=!!(4&e),d=!c&&"scroll"===t,u=c?null!==o?o+"Capture":null:o;c=[];for(var f,p=i;null!==p;){var m=(f=p).stateNode;if(5===f.tag&&null!==m&&(f=m,null!==u&&(null!=(m=Lt(p,u))&&c.push(Hi(p,m,f)))),d)break;p=p.return}0<c.length&&(o=new l(o,h,null,s,n),a.push({event:o,listeners:c}))}}if(!(7&e)){if(l="mouseout"===t||"pointerout"===t,(!(o="mouseover"===t||"pointerover"===t)||s===vt||!(h=s.relatedTarget||s.fromElement)||!_n(h)&&!h[un])&&(l||o)&&(o=n.window===n?n:(o=n.ownerDocument)?o.defaultView||o.parentWindow:window,l?(l=i,null!==(h=(h=s.relatedTarget||s.toElement)?_n(h):null)&&(h!==(d=zt(h))||5!==h.tag&&6!==h.tag)&&(h=null)):(l=null,h=i),l!==h)){if(c=ds,m="onMouseLeave",u="onMouseEnter",p="mouse","pointerout"!==t&&"pointerover"!==t||(c=Es,m="onPointerLeave",u="onPointerEnter",p="pointer"),d=null==l?o:vn(l),f=null==h?o:vn(h),(o=new c(m,p+"leave",l,s,n)).target=d,o.relatedTarget=f,m=null,_n(n)===i&&((c=new c(u,p+"enter",h,s,n)).target=f,c.relatedTarget=d,m=c),d=m,l&&h)t:{for(u=h,p=0,f=c=l;f;f=Wi(f))p++;for(f=0,m=u;m;m=Wi(m))f++;for(;0<p-f;)c=Wi(c),p--;for(;0<f-p;)u=Wi(u),f--;for(;p--;){if(c===u||null!==u&&c===u.alternate)break t;c=Wi(c),u=Wi(u)}c=null}else c=null;null!==l&&ji(a,o,l,c,!1),null!==h&&null!==d&&ji(a,d,h,c,!0)}if("select"===(l=(o=i?vn(i):window).nodeName&&o.nodeName.toLowerCase())||"input"===l&&"file"===o.type)var _=$s;else if(Vs(o))if(qs)_=ii;else{_=ei;var g=ti}else(l=o.nodeName)&&"input"===l.toLowerCase()&&("checkbox"===o.type||"radio"===o.type)&&(_=si);switch(_&&(_=_(t,i))?Hs(a,_,s,n):(g&&g(t,o,i),"focusout"===t&&(g=o._wrapperState)&&g.controlled&&"number"===o.type&&Z(o,"number",o.value)),g=i?vn(i):window,t){case"focusin":(Vs(g)||"true"===g.contentEditable)&&(fi=g,pi=i,mi=null);break;case"focusout":mi=pi=fi=null;break;case"mousedown":_i=!0;break;case"contextmenu":case"mouseup":case"dragend":_i=!1,gi(a,s,n);break;case"selectionchange":if(ui)break;case"keydown":case"keyup":gi(a,s,n)}var v;if(Is)t:{switch(t){case"compositionstart":var b="onCompositionStart";break t;case"compositionend":b="onCompositionEnd";break t;case"compositionupdate":b="onCompositionUpdate";break t}b=void 0}else Us?Ns(t,s)&&(b="onCompositionEnd"):"keydown"===t&&229===s.keyCode&&(b="onCompositionStart");b&&(ks&&"ko"!==s.locale&&(Us||"onCompositionStart"!==b?"onCompositionEnd"===b&&Us&&(v=Ze()):(Ye="value"in(Ke=n)?Ke.value:Ke.textContent,Us=!0)),0<(g=Gi(i,b)).length&&(b=new gs(b,t,null,s,n),a.push({event:b,listeners:g}),v?b.data=v:null!==(v=Bs(s))&&(b.data=v))),(v=Ms?function(t,e){switch(t){case"compositionend":return Bs(e);case"keypress":return 32!==e.which?null:(Fs=!0,Os);case"textInput":return(t=e.data)===Os&&Fs?null:t;default:return null}}(t,s):function(t,e){if(Us)return"compositionend"===t||!Is&&Ns(t,e)?(t=Ze(),Qe=Ye=Ke=null,Us=!1,t):null;switch(t){case"paste":default:return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return ks&&"ko"!==e.locale?null:e.data}}(t,s))&&(0<(i=Gi(i,"onBeforeInput")).length&&(n=new gs("onBeforeInput","beforeinput",null,s,n),a.push({event:n,listeners:i}),n.data=v))}Oi(a,e)}))}function Hi(t,e,s){return{instance:t,listener:e,currentTarget:s}}function Gi(t,e){for(var s=e+"Capture",i=[];null!==t;){var n=t,r=n.stateNode;5===n.tag&&null!==r&&(n=r,null!=(r=Lt(t,s))&&i.unshift(Hi(t,r,n)),null!=(r=Lt(t,e))&&i.push(Hi(t,r,n))),t=t.return}return i}function Wi(t){if(null===t)return null;do{t=t.return}while(t&&5!==t.tag);return t||null}function ji(t,e,s,i,n){for(var r=e._reactName,a=[];null!==s&&s!==i;){var o=s,l=o.alternate,h=o.stateNode;if(null!==l&&l===i)break;5===o.tag&&null!==h&&(o=h,n?null!=(l=Lt(s,r))&&a.unshift(Hi(s,l,o)):n||null!=(l=Lt(s,r))&&a.push(Hi(s,l,o))),s=s.return}0!==a.length&&t.push({event:e,listeners:a})}var Xi=/\r\n?/g,$i=/\u0000|\uFFFD/g;function qi(t){return("string"==typeof t?t:""+t).replace(Xi,"\n").replace($i,"")}function Ki(t,e,i){if(e=qi(e),qi(t)!==e&&i)throw Error(s(425))}function Yi(){}var Qi=null,Zi=null;function Ji(t,e){return"textarea"===t||"noscript"===t||"string"==typeof e.children||"number"==typeof e.children||"object"==typeof e.dangerouslySetInnerHTML&&null!==e.dangerouslySetInnerHTML&&null!=e.dangerouslySetInnerHTML.__html}var tn="function"==typeof setTimeout?setTimeout:void 0,en="function"==typeof clearTimeout?clearTimeout:void 0,sn="function"==typeof Promise?Promise:void 0,nn="function"==typeof queueMicrotask?queueMicrotask:void 0!==sn?function(t){return sn.resolve(null).then(t).catch(rn)}:tn;function rn(t){setTimeout((function(){throw t}))}function an(t,e){var s=e,i=0;do{var n=s.nextSibling;if(t.removeChild(s),n&&8===n.nodeType)if("/$"===(s=n.data)){if(0===i)return t.removeChild(n),void ze(e);i--}else"$"!==s&&"$?"!==s&&"$!"!==s||i++;s=n}while(s);ze(e)}function on(t){for(;null!=t;t=t.nextSibling){var e=t.nodeType;if(1===e||3===e)break;if(8===e){if("$"===(e=t.data)||"$!"===e||"$?"===e)break;if("/$"===e)return null}}return t}function ln(t){t=t.previousSibling;for(var e=0;t;){if(8===t.nodeType){var s=t.data;if("$"===s||"$!"===s||"$?"===s){if(0===e)return t;e--}else"/$"===s&&e++}t=t.previousSibling}return null}var hn=Math.random().toString(36).slice(2),cn="__reactFiber$"+hn,dn="__reactProps$"+hn,un="__reactContainer$"+hn,fn="__reactEvents$"+hn,pn="__reactListeners$"+hn,mn="__reactHandles$"+hn;function _n(t){var e=t[cn];if(e)return e;for(var s=t.parentNode;s;){if(e=s[un]||s[cn]){if(s=e.alternate,null!==e.child||null!==s&&null!==s.child)for(t=ln(t);null!==t;){if(s=t[cn])return s;t=ln(t)}return e}s=(t=s).parentNode}return null}function gn(t){return!(t=t[cn]||t[un])||5!==t.tag&&6!==t.tag&&13!==t.tag&&3!==t.tag?null:t}function vn(t){if(5===t.tag||6===t.tag)return t.stateNode;throw Error(s(33))}function bn(t){return t[dn]||null}var yn=[],Sn=-1;function xn(t){return{current:t}}function wn(t){0>Sn||(t.current=yn[Sn],yn[Sn]=null,Sn--)}function Tn(t,e){Sn++,yn[Sn]=t.current,t.current=e}var En={},Cn=xn(En),An=xn(!1),Dn=En;function Pn(t,e){var s=t.type.contextTypes;if(!s)return En;var i=t.stateNode;if(i&&i.__reactInternalMemoizedUnmaskedChildContext===e)return i.__reactInternalMemoizedMaskedChildContext;var n,r={};for(n in s)r[n]=e[n];return i&&((t=t.stateNode).__reactInternalMemoizedUnmaskedChildContext=e,t.__reactInternalMemoizedMaskedChildContext=r),r}function Ln(t){return null!=(t=t.childContextTypes)}function In(){wn(An),wn(Cn)}function Rn(t,e,i){if(Cn.current!==En)throw Error(s(168));Tn(Cn,e),Tn(An,i)}function Mn(t,e,i){var n=t.stateNode;if(e=e.childContextTypes,"function"!=typeof n.getChildContext)return i;for(var r in n=n.getChildContext())if(!(r in e))throw Error(s(108,V(t)||"Unknown",r));return O({},i,n)}function kn(t){return t=(t=t.stateNode)&&t.__reactInternalMemoizedMergedChildContext||En,Dn=Cn.current,Tn(Cn,t),Tn(An,An.current),!0}function On(t,e,i){var n=t.stateNode;if(!n)throw Error(s(169));i?(t=Mn(t,e,Dn),n.__reactInternalMemoizedMergedChildContext=t,wn(An),wn(Cn),Tn(Cn,t)):wn(An),Tn(An,i)}var Fn=null,Nn=!1,Bn=!1;function Un(t){null===Fn?Fn=[t]:Fn.push(t)}function zn(){if(!Bn&&null!==Fn){Bn=!0;var t=0,e=ge;try{var s=Fn;for(ge=1;t<s.length;t++){var i=s[t];do{i=i(!0)}while(null!==i)}Fn=null,Nn=!1}catch(e){throw null!==Fn&&(Fn=Fn.slice(t+1)),jt(Qt,zn),e}finally{ge=e,Bn=!1}}return null}var Vn=[],Hn=0,Gn=null,Wn=0,jn=[],Xn=0,$n=null,qn=1,Kn="";function Yn(t,e){Vn[Hn++]=Wn,Vn[Hn++]=Gn,Gn=t,Wn=e}function Qn(t,e,s){jn[Xn++]=qn,jn[Xn++]=Kn,jn[Xn++]=$n,$n=t;var i=qn;t=Kn;var n=32-ne(i)-1;i&=~(1<<n),s+=1;var r=32-ne(e)+n;if(30<r){var a=n-n%5;r=(i&(1<<a)-1).toString(32),i>>=a,n-=a,qn=1<<32-ne(e)+n|s<<n|i,Kn=r+t}else qn=1<<r|s<<n|i,Kn=t}function Zn(t){null!==t.return&&(Yn(t,1),Qn(t,1,0))}function Jn(t){for(;t===Gn;)Gn=Vn[--Hn],Vn[Hn]=null,Wn=Vn[--Hn],Vn[Hn]=null;for(;t===$n;)$n=jn[--Xn],jn[Xn]=null,Kn=jn[--Xn],jn[Xn]=null,qn=jn[--Xn],jn[Xn]=null}var tr=null,er=null,sr=!1,ir=null;function nr(t,e){var s=Ph(5,null,null,0);s.elementType="DELETED",s.stateNode=e,s.return=t,null===(e=t.deletions)?(t.deletions=[s],t.flags|=16):e.push(s)}function rr(t,e){switch(t.tag){case 5:var s=t.type;return null!==(e=1!==e.nodeType||s.toLowerCase()!==e.nodeName.toLowerCase()?null:e)&&(t.stateNode=e,tr=t,er=on(e.firstChild),!0);case 6:return null!==(e=""===t.pendingProps||3!==e.nodeType?null:e)&&(t.stateNode=e,tr=t,er=null,!0);case 13:return null!==(e=8!==e.nodeType?null:e)&&(s=null!==$n?{id:qn,overflow:Kn}:null,t.memoizedState={dehydrated:e,treeContext:s,retryLane:1073741824},(s=Ph(18,null,null,0)).stateNode=e,s.return=t,t.child=s,tr=t,er=null,!0);default:return!1}}function ar(t){return!(!(1&t.mode)||128&t.flags)}function or(t){if(sr){var e=er;if(e){var i=e;if(!rr(t,e)){if(ar(t))throw Error(s(418));e=on(i.nextSibling);var n=tr;e&&rr(t,e)?nr(n,i):(t.flags=-4097&t.flags|2,sr=!1,tr=t)}}else{if(ar(t))throw Error(s(418));t.flags=-4097&t.flags|2,sr=!1,tr=t}}}function lr(t){for(t=t.return;null!==t&&5!==t.tag&&3!==t.tag&&13!==t.tag;)t=t.return;tr=t}function hr(t){if(t!==tr)return!1;if(!sr)return lr(t),sr=!0,!1;var e;if((e=3!==t.tag)&&!(e=5!==t.tag)&&(e="head"!==(e=t.type)&&"body"!==e&&!Ji(t.type,t.memoizedProps)),e&&(e=er)){if(ar(t))throw cr(),Error(s(418));for(;e;)nr(t,e),e=on(e.nextSibling)}if(lr(t),13===t.tag){if(!(t=null!==(t=t.memoizedState)?t.dehydrated:null))throw Error(s(317));t:{for(t=t.nextSibling,e=0;t;){if(8===t.nodeType){var i=t.data;if("/$"===i){if(0===e){er=on(t.nextSibling);break t}e--}else"$"!==i&&"$!"!==i&&"$?"!==i||e++}t=t.nextSibling}er=null}}else er=tr?on(t.stateNode.nextSibling):null;return!0}function cr(){for(var t=er;t;)t=on(t.nextSibling)}function dr(){er=tr=null,sr=!1}function ur(t){null===ir?ir=[t]:ir.push(t)}var fr=v.ReactCurrentBatchConfig;function pr(t,e,i){if(null!==(t=i.ref)&&"function"!=typeof t&&"object"!=typeof t){if(i._owner){if(i=i._owner){if(1!==i.tag)throw Error(s(309));var n=i.stateNode}if(!n)throw Error(s(147,t));var r=n,a=""+t;return null!==e&&null!==e.ref&&"function"==typeof e.ref&&e.ref._stringRef===a?e.ref:(e=function(t){var e=r.refs;null===t?delete e[a]:e[a]=t},e._stringRef=a,e)}if("string"!=typeof t)throw Error(s(284));if(!i._owner)throw Error(s(290,t))}return t}function mr(t,e){throw t=Object.prototype.toString.call(e),Error(s(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t))}function _r(t){return(0,t._init)(t._payload)}function gr(t){function e(e,s){if(t){var i=e.deletions;null===i?(e.deletions=[s],e.flags|=16):i.push(s)}}function i(s,i){if(!t)return null;for(;null!==i;)e(s,i),i=i.sibling;return null}function n(t,e){for(t=new Map;null!==e;)null!==e.key?t.set(e.key,e):t.set(e.index,e),e=e.sibling;return t}function r(t,e){return(t=Ih(t,e)).index=0,t.sibling=null,t}function a(e,s,i){return e.index=i,t?null!==(i=e.alternate)?(i=i.index)<s?(e.flags|=2,s):i:(e.flags|=2,s):(e.flags|=1048576,s)}function o(e){return t&&null===e.alternate&&(e.flags|=2),e}function l(t,e,s,i){return null===e||6!==e.tag?((e=Oh(s,t.mode,i)).return=t,e):((e=r(e,s)).return=t,e)}function h(t,e,s,i){var n=s.type;return n===S?d(t,e,s.props.children,i,s.key):null!==e&&(e.elementType===n||"object"==typeof n&&null!==n&&n.$$typeof===L&&_r(n)===e.type)?((i=r(e,s.props)).ref=pr(t,e,s),i.return=t,i):((i=Rh(s.type,s.key,s.props,null,t.mode,i)).ref=pr(t,e,s),i.return=t,i)}function c(t,e,s,i){return null===e||4!==e.tag||e.stateNode.containerInfo!==s.containerInfo||e.stateNode.implementation!==s.implementation?((e=Fh(s,t.mode,i)).return=t,e):((e=r(e,s.children||[])).return=t,e)}function d(t,e,s,i,n){return null===e||7!==e.tag?((e=Mh(s,t.mode,i,n)).return=t,e):((e=r(e,s)).return=t,e)}function u(t,e,s){if("string"==typeof e&&""!==e||"number"==typeof e)return(e=Oh(""+e,t.mode,s)).return=t,e;if("object"==typeof e&&null!==e){switch(e.$$typeof){case b:return(s=Rh(e.type,e.key,e.props,null,t.mode,s)).ref=pr(t,null,e),s.return=t,s;case y:return(e=Fh(e,t.mode,s)).return=t,e;case L:return u(t,(0,e._init)(e._payload),s)}if(J(e)||M(e))return(e=Mh(e,t.mode,s,null)).return=t,e;mr(t,e)}return null}function f(t,e,s,i){var n=null!==e?e.key:null;if("string"==typeof s&&""!==s||"number"==typeof s)return null!==n?null:l(t,e,""+s,i);if("object"==typeof s&&null!==s){switch(s.$$typeof){case b:return s.key===n?h(t,e,s,i):null;case y:return s.key===n?c(t,e,s,i):null;case L:return f(t,e,(n=s._init)(s._payload),i)}if(J(s)||M(s))return null!==n?null:d(t,e,s,i,null);mr(t,s)}return null}function p(t,e,s,i,n){if("string"==typeof i&&""!==i||"number"==typeof i)return l(e,t=t.get(s)||null,""+i,n);if("object"==typeof i&&null!==i){switch(i.$$typeof){case b:return h(e,t=t.get(null===i.key?s:i.key)||null,i,n);case y:return c(e,t=t.get(null===i.key?s:i.key)||null,i,n);case L:return p(t,e,s,(0,i._init)(i._payload),n)}if(J(i)||M(i))return d(e,t=t.get(s)||null,i,n,null);mr(e,i)}return null}function m(s,r,o,l){for(var h=null,c=null,d=r,m=r=0,_=null;null!==d&&m<o.length;m++){d.index>m?(_=d,d=null):_=d.sibling;var g=f(s,d,o[m],l);if(null===g){null===d&&(d=_);break}t&&d&&null===g.alternate&&e(s,d),r=a(g,r,m),null===c?h=g:c.sibling=g,c=g,d=_}if(m===o.length)return i(s,d),sr&&Yn(s,m),h;if(null===d){for(;m<o.length;m++)null!==(d=u(s,o[m],l))&&(r=a(d,r,m),null===c?h=d:c.sibling=d,c=d);return sr&&Yn(s,m),h}for(d=n(s,d);m<o.length;m++)null!==(_=p(d,s,m,o[m],l))&&(t&&null!==_.alternate&&d.delete(null===_.key?m:_.key),r=a(_,r,m),null===c?h=_:c.sibling=_,c=_);return t&&d.forEach((function(t){return e(s,t)})),sr&&Yn(s,m),h}function _(r,o,l,h){var c=M(l);if("function"!=typeof c)throw Error(s(150));if(null==(l=c.call(l)))throw Error(s(151));for(var d=c=null,m=o,_=o=0,g=null,v=l.next();null!==m&&!v.done;_++,v=l.next()){m.index>_?(g=m,m=null):g=m.sibling;var b=f(r,m,v.value,h);if(null===b){null===m&&(m=g);break}t&&m&&null===b.alternate&&e(r,m),o=a(b,o,_),null===d?c=b:d.sibling=b,d=b,m=g}if(v.done)return i(r,m),sr&&Yn(r,_),c;if(null===m){for(;!v.done;_++,v=l.next())null!==(v=u(r,v.value,h))&&(o=a(v,o,_),null===d?c=v:d.sibling=v,d=v);return sr&&Yn(r,_),c}for(m=n(r,m);!v.done;_++,v=l.next())null!==(v=p(m,r,_,v.value,h))&&(t&&null!==v.alternate&&m.delete(null===v.key?_:v.key),o=a(v,o,_),null===d?c=v:d.sibling=v,d=v);return t&&m.forEach((function(t){return e(r,t)})),sr&&Yn(r,_),c}return function t(s,n,a,l){if("object"==typeof a&&null!==a&&a.type===S&&null===a.key&&(a=a.props.children),"object"==typeof a&&null!==a){switch(a.$$typeof){case b:t:{for(var h=a.key,c=n;null!==c;){if(c.key===h){if((h=a.type)===S){if(7===c.tag){i(s,c.sibling),(n=r(c,a.props.children)).return=s,s=n;break t}}else if(c.elementType===h||"object"==typeof h&&null!==h&&h.$$typeof===L&&_r(h)===c.type){i(s,c.sibling),(n=r(c,a.props)).ref=pr(s,c,a),n.return=s,s=n;break t}i(s,c);break}e(s,c),c=c.sibling}a.type===S?((n=Mh(a.props.children,s.mode,l,a.key)).return=s,s=n):((l=Rh(a.type,a.key,a.props,null,s.mode,l)).ref=pr(s,n,a),l.return=s,s=l)}return o(s);case y:t:{for(c=a.key;null!==n;){if(n.key===c){if(4===n.tag&&n.stateNode.containerInfo===a.containerInfo&&n.stateNode.implementation===a.implementation){i(s,n.sibling),(n=r(n,a.children||[])).return=s,s=n;break t}i(s,n);break}e(s,n),n=n.sibling}(n=Fh(a,s.mode,l)).return=s,s=n}return o(s);case L:return t(s,n,(c=a._init)(a._payload),l)}if(J(a))return m(s,n,a,l);if(M(a))return _(s,n,a,l);mr(s,a)}return"string"==typeof a&&""!==a||"number"==typeof a?(a=""+a,null!==n&&6===n.tag?(i(s,n.sibling),(n=r(n,a)).return=s,s=n):(i(s,n),(n=Oh(a,s.mode,l)).return=s,s=n),o(s)):i(s,n)}}var vr=gr(!0),br=gr(!1),yr=xn(null),Sr=null,xr=null,wr=null;function Tr(){wr=xr=Sr=null}function Er(t){var e=yr.current;wn(yr),t._currentValue=e}function Cr(t,e,s){for(;null!==t;){var i=t.alternate;if((t.childLanes&e)!==e?(t.childLanes|=e,null!==i&&(i.childLanes|=e)):null!==i&&(i.childLanes&e)!==e&&(i.childLanes|=e),t===s)break;t=t.return}}function Ar(t,e){Sr=t,wr=xr=null,null!==(t=t.dependencies)&&null!==t.firstContext&&(0!==(t.lanes&e)&&(go=!0),t.firstContext=null)}function Dr(t){var e=t._currentValue;if(wr!==t)if(t={context:t,memoizedValue:e,next:null},null===xr){if(null===Sr)throw Error(s(308));xr=t,Sr.dependencies={lanes:0,firstContext:t}}else xr=xr.next=t;return e}var Pr=null;function Lr(t){null===Pr?Pr=[t]:Pr.push(t)}function Ir(t,e,s,i){var n=e.interleaved;return null===n?(s.next=s,Lr(e)):(s.next=n.next,n.next=s),e.interleaved=s,Rr(t,i)}function Rr(t,e){t.lanes|=e;var s=t.alternate;for(null!==s&&(s.lanes|=e),s=t,t=t.return;null!==t;)t.childLanes|=e,null!==(s=t.alternate)&&(s.childLanes|=e),s=t,t=t.return;return 3===s.tag?s.stateNode:null}var Mr=!1;function kr(t){t.updateQueue={baseState:t.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Or(t,e){t=t.updateQueue,e.updateQueue===t&&(e.updateQueue={baseState:t.baseState,firstBaseUpdate:t.firstBaseUpdate,lastBaseUpdate:t.lastBaseUpdate,shared:t.shared,effects:t.effects})}function Fr(t,e){return{eventTime:t,lane:e,tag:0,payload:null,callback:null,next:null}}function Nr(t,e,s){var i=t.updateQueue;if(null===i)return null;if(i=i.shared,2&Cl){var n=i.pending;return null===n?e.next=e:(e.next=n.next,n.next=e),i.pending=e,Rr(t,s)}return null===(n=i.interleaved)?(e.next=e,Lr(i)):(e.next=n.next,n.next=e),i.interleaved=e,Rr(t,s)}function Br(t,e,s){if(null!==(e=e.updateQueue)&&(e=e.shared,4194240&s)){var i=e.lanes;s|=i&=t.pendingLanes,e.lanes=s,_e(t,s)}}function Ur(t,e){var s=t.updateQueue,i=t.alternate;if(null!==i&&s===(i=i.updateQueue)){var n=null,r=null;if(null!==(s=s.firstBaseUpdate)){do{var a={eventTime:s.eventTime,lane:s.lane,tag:s.tag,payload:s.payload,callback:s.callback,next:null};null===r?n=r=a:r=r.next=a,s=s.next}while(null!==s);null===r?n=r=e:r=r.next=e}else n=r=e;return s={baseState:i.baseState,firstBaseUpdate:n,lastBaseUpdate:r,shared:i.shared,effects:i.effects},void(t.updateQueue=s)}null===(t=s.lastBaseUpdate)?s.firstBaseUpdate=e:t.next=e,s.lastBaseUpdate=e}function zr(t,e,s,i){var n=t.updateQueue;Mr=!1;var r=n.firstBaseUpdate,a=n.lastBaseUpdate,o=n.shared.pending;if(null!==o){n.shared.pending=null;var l=o,h=l.next;l.next=null,null===a?r=h:a.next=h,a=l;var c=t.alternate;null!==c&&((o=(c=c.updateQueue).lastBaseUpdate)!==a&&(null===o?c.firstBaseUpdate=h:o.next=h,c.lastBaseUpdate=l))}if(null!==r){var d=n.baseState;for(a=0,c=h=l=null,o=r;;){var u=o.lane,f=o.eventTime;if((i&u)===u){null!==c&&(c=c.next={eventTime:f,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});t:{var p=t,m=o;switch(u=e,f=s,m.tag){case 1:if("function"==typeof(p=m.payload)){d=p.call(f,d,u);break t}d=p;break t;case 3:p.flags=-65537&p.flags|128;case 0:if(null==(u="function"==typeof(p=m.payload)?p.call(f,d,u):p))break t;d=O({},d,u);break t;case 2:Mr=!0}}null!==o.callback&&0!==o.lane&&(t.flags|=64,null===(u=n.effects)?n.effects=[o]:u.push(o))}else f={eventTime:f,lane:u,tag:o.tag,payload:o.payload,callback:o.callback,next:null},null===c?(h=c=f,l=d):c=c.next=f,a|=u;if(null===(o=o.next)){if(null===(o=n.shared.pending))break;o=(u=o).next,u.next=null,n.lastBaseUpdate=u,n.shared.pending=null}}if(null===c&&(l=d),n.baseState=l,n.firstBaseUpdate=h,n.lastBaseUpdate=c,null!==(e=n.shared.interleaved)){n=e;do{a|=n.lane,n=n.next}while(n!==e)}else null===r&&(n.shared.lanes=0);kl|=a,t.lanes=a,t.memoizedState=d}}function Vr(t,e,i){if(t=e.effects,e.effects=null,null!==t)for(e=0;e<t.length;e++){var n=t[e],r=n.callback;if(null!==r){if(n.callback=null,n=i,"function"!=typeof r)throw Error(s(191,r));r.call(n)}}}var Hr={},Gr=xn(Hr),Wr=xn(Hr),jr=xn(Hr);function Xr(t){if(t===Hr)throw Error(s(174));return t}function $r(t,e){switch(Tn(jr,e),Tn(Wr,t),Tn(Gr,Hr),t=e.nodeType){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:at(null,"");break;default:e=at(e=(t=8===t?e.parentNode:e).namespaceURI||null,t=t.tagName)}wn(Gr),Tn(Gr,e)}function qr(){wn(Gr),wn(Wr),wn(jr)}function Kr(t){Xr(jr.current);var e=Xr(Gr.current),s=at(e,t.type);e!==s&&(Tn(Wr,t),Tn(Gr,s))}function Yr(t){Wr.current===t&&(wn(Gr),wn(Wr))}var Qr=xn(0);function Zr(t){for(var e=t;null!==e;){if(13===e.tag){var s=e.memoizedState;if(null!==s&&(null===(s=s.dehydrated)||"$?"===s.data||"$!"===s.data))return e}else if(19===e.tag&&void 0!==e.memoizedProps.revealOrder){if(128&e.flags)return e}else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break;for(;null===e.sibling;){if(null===e.return||e.return===t)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var Jr=[];function ta(){for(var t=0;t<Jr.length;t++)Jr[t]._workInProgressVersionPrimary=null;Jr.length=0}var ea=v.ReactCurrentDispatcher,sa=v.ReactCurrentBatchConfig,ia=0,na=null,ra=null,aa=null,oa=!1,la=!1,ha=0,ca=0;function da(){throw Error(s(321))}function ua(t,e){if(null===e)return!1;for(var s=0;s<e.length&&s<t.length;s++)if(!ni(t[s],e[s]))return!1;return!0}function fa(t,e,i,n,r,a){if(ia=a,na=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,ea.current=null===t||null===t.memoizedState?Ya:Qa,t=i(n,r),la){a=0;do{if(la=!1,ha=0,25<=a)throw Error(s(301));a+=1,aa=ra=null,e.updateQueue=null,ea.current=Za,t=i(n,r)}while(la)}if(ea.current=Ka,e=null!==ra&&null!==ra.next,ia=0,aa=ra=na=null,oa=!1,e)throw Error(s(300));return t}function pa(){var t=0!==ha;return ha=0,t}function ma(){var t={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===aa?na.memoizedState=aa=t:aa=aa.next=t,aa}function _a(){if(null===ra){var t=na.alternate;t=null!==t?t.memoizedState:null}else t=ra.next;var e=null===aa?na.memoizedState:aa.next;if(null!==e)aa=e,ra=t;else{if(null===t)throw Error(s(310));t={memoizedState:(ra=t).memoizedState,baseState:ra.baseState,baseQueue:ra.baseQueue,queue:ra.queue,next:null},null===aa?na.memoizedState=aa=t:aa=aa.next=t}return aa}function ga(t,e){return"function"==typeof e?e(t):e}function va(t){var e=_a(),i=e.queue;if(null===i)throw Error(s(311));i.lastRenderedReducer=t;var n=ra,r=n.baseQueue,a=i.pending;if(null!==a){if(null!==r){var o=r.next;r.next=a.next,a.next=o}n.baseQueue=r=a,i.pending=null}if(null!==r){a=r.next,n=n.baseState;var l=o=null,h=null,c=a;do{var d=c.lane;if((ia&d)===d)null!==h&&(h=h.next={lane:0,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),n=c.hasEagerState?c.eagerState:t(n,c.action);else{var u={lane:d,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null};null===h?(l=h=u,o=n):h=h.next=u,na.lanes|=d,kl|=d}c=c.next}while(null!==c&&c!==a);null===h?o=n:h.next=l,ni(n,e.memoizedState)||(go=!0),e.memoizedState=n,e.baseState=o,e.baseQueue=h,i.lastRenderedState=n}if(null!==(t=i.interleaved)){r=t;do{a=r.lane,na.lanes|=a,kl|=a,r=r.next}while(r!==t)}else null===r&&(i.lanes=0);return[e.memoizedState,i.dispatch]}function ba(t){var e=_a(),i=e.queue;if(null===i)throw Error(s(311));i.lastRenderedReducer=t;var n=i.dispatch,r=i.pending,a=e.memoizedState;if(null!==r){i.pending=null;var o=r=r.next;do{a=t(a,o.action),o=o.next}while(o!==r);ni(a,e.memoizedState)||(go=!0),e.memoizedState=a,null===e.baseQueue&&(e.baseState=a),i.lastRenderedState=a}return[a,n]}function ya(){}function Sa(t,e){var i=na,n=_a(),r=e(),a=!ni(n.memoizedState,r);if(a&&(n.memoizedState=r,go=!0),n=n.queue,Ma(Ta.bind(null,i,n,t),[t]),n.getSnapshot!==e||a||null!==aa&&1&aa.memoizedState.tag){if(i.flags|=2048,Da(9,wa.bind(null,i,n,r,e),void 0,null),null===Al)throw Error(s(349));30&ia||xa(i,e,r)}return r}function xa(t,e,s){t.flags|=16384,t={getSnapshot:e,value:s},null===(e=na.updateQueue)?(e={lastEffect:null,stores:null},na.updateQueue=e,e.stores=[t]):null===(s=e.stores)?e.stores=[t]:s.push(t)}function wa(t,e,s,i){e.value=s,e.getSnapshot=i,Ea(e)&&Ca(t)}function Ta(t,e,s){return s((function(){Ea(e)&&Ca(t)}))}function Ea(t){var e=t.getSnapshot;t=t.value;try{var s=e();return!ni(t,s)}catch(t){return!0}}function Ca(t){var e=Rr(t,1);null!==e&&th(e,t,1,-1)}function Aa(t){var e=ma();return"function"==typeof t&&(t=t()),e.memoizedState=e.baseState=t,t={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:ga,lastRenderedState:t},e.queue=t,t=t.dispatch=ja.bind(null,na,t),[e.memoizedState,t]}function Da(t,e,s,i){return t={tag:t,create:e,destroy:s,deps:i,next:null},null===(e=na.updateQueue)?(e={lastEffect:null,stores:null},na.updateQueue=e,e.lastEffect=t.next=t):null===(s=e.lastEffect)?e.lastEffect=t.next=t:(i=s.next,s.next=t,t.next=i,e.lastEffect=t),t}function Pa(){return _a().memoizedState}function La(t,e,s,i){var n=ma();na.flags|=t,n.memoizedState=Da(1|e,s,void 0,void 0===i?null:i)}function Ia(t,e,s,i){var n=_a();i=void 0===i?null:i;var r=void 0;if(null!==ra){var a=ra.memoizedState;if(r=a.destroy,null!==i&&ua(i,a.deps))return void(n.memoizedState=Da(e,s,r,i))}na.flags|=t,n.memoizedState=Da(1|e,s,r,i)}function Ra(t,e){return La(8390656,8,t,e)}function Ma(t,e){return Ia(2048,8,t,e)}function ka(t,e){return Ia(4,2,t,e)}function Oa(t,e){return Ia(4,4,t,e)}function Fa(t,e){return"function"==typeof e?(t=t(),e(t),function(){e(null)}):null!=e?(t=t(),e.current=t,function(){e.current=null}):void 0}function Na(t,e,s){return s=null!=s?s.concat([t]):null,Ia(4,4,Fa.bind(null,e,t),s)}function Ba(){}function Ua(t,e){var s=_a();e=void 0===e?null:e;var i=s.memoizedState;return null!==i&&null!==e&&ua(e,i[1])?i[0]:(s.memoizedState=[t,e],t)}function za(t,e){var s=_a();e=void 0===e?null:e;var i=s.memoizedState;return null!==i&&null!==e&&ua(e,i[1])?i[0]:(t=t(),s.memoizedState=[t,e],t)}function Va(t,e,s){return 21&ia?(ni(s,e)||(s=fe(),na.lanes|=s,kl|=s,t.baseState=!0),e):(t.baseState&&(t.baseState=!1,go=!0),t.memoizedState=s)}function Ha(t,e){var s=ge;ge=0!==s&&4>s?s:4,t(!0);var i=sa.transition;sa.transition={};try{t(!1),e()}finally{ge=s,sa.transition=i}}function Ga(){return _a().memoizedState}function Wa(t,e,s){var i=Jl(t);if(s={lane:i,action:s,hasEagerState:!1,eagerState:null,next:null},Xa(t))$a(e,s);else if(null!==(s=Ir(t,e,s,i))){th(s,t,i,Zl()),qa(s,e,i)}}function ja(t,e,s){var i=Jl(t),n={lane:i,action:s,hasEagerState:!1,eagerState:null,next:null};if(Xa(t))$a(e,n);else{var r=t.alternate;if(0===t.lanes&&(null===r||0===r.lanes)&&null!==(r=e.lastRenderedReducer))try{var a=e.lastRenderedState,o=r(a,s);if(n.hasEagerState=!0,n.eagerState=o,ni(o,a)){var l=e.interleaved;return null===l?(n.next=n,Lr(e)):(n.next=l.next,l.next=n),void(e.interleaved=n)}}catch(t){}null!==(s=Ir(t,e,n,i))&&(th(s,t,i,n=Zl()),qa(s,e,i))}}function Xa(t){var e=t.alternate;return t===na||null!==e&&e===na}function $a(t,e){la=oa=!0;var s=t.pending;null===s?e.next=e:(e.next=s.next,s.next=e),t.pending=e}function qa(t,e,s){if(4194240&s){var i=e.lanes;s|=i&=t.pendingLanes,e.lanes=s,_e(t,s)}}var Ka={readContext:Dr,useCallback:da,useContext:da,useEffect:da,useImperativeHandle:da,useInsertionEffect:da,useLayoutEffect:da,useMemo:da,useReducer:da,useRef:da,useState:da,useDebugValue:da,useDeferredValue:da,useTransition:da,useMutableSource:da,useSyncExternalStore:da,useId:da,unstable_isNewReconciler:!1},Ya={readContext:Dr,useCallback:function(t,e){return ma().memoizedState=[t,void 0===e?null:e],t},useContext:Dr,useEffect:Ra,useImperativeHandle:function(t,e,s){return s=null!=s?s.concat([t]):null,La(4194308,4,Fa.bind(null,e,t),s)},useLayoutEffect:function(t,e){return La(4194308,4,t,e)},useInsertionEffect:function(t,e){return La(4,2,t,e)},useMemo:function(t,e){var s=ma();return e=void 0===e?null:e,t=t(),s.memoizedState=[t,e],t},useReducer:function(t,e,s){var i=ma();return e=void 0!==s?s(e):e,i.memoizedState=i.baseState=e,t={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:t,lastRenderedState:e},i.queue=t,t=t.dispatch=Wa.bind(null,na,t),[i.memoizedState,t]},useRef:function(t){return t={current:t},ma().memoizedState=t},useState:Aa,useDebugValue:Ba,useDeferredValue:function(t){return ma().memoizedState=t},useTransition:function(){var t=Aa(!1),e=t[0];return t=Ha.bind(null,t[1]),ma().memoizedState=t,[e,t]},useMutableSource:function(){},useSyncExternalStore:function(t,e,i){var n=na,r=ma();if(sr){if(void 0===i)throw Error(s(407));i=i()}else{if(i=e(),null===Al)throw Error(s(349));30&ia||xa(n,e,i)}r.memoizedState=i;var a={value:i,getSnapshot:e};return r.queue=a,Ra(Ta.bind(null,n,a,t),[t]),n.flags|=2048,Da(9,wa.bind(null,n,a,i,e),void 0,null),i},useId:function(){var t=ma(),e=Al.identifierPrefix;if(sr){var s=Kn;e=":"+e+"R"+(s=(qn&~(1<<32-ne(qn)-1)).toString(32)+s),0<(s=ha++)&&(e+="H"+s.toString(32)),e+=":"}else e=":"+e+"r"+(s=ca++).toString(32)+":";return t.memoizedState=e},unstable_isNewReconciler:!1},Qa={readContext:Dr,useCallback:Ua,useContext:Dr,useEffect:Ma,useImperativeHandle:Na,useInsertionEffect:ka,useLayoutEffect:Oa,useMemo:za,useReducer:va,useRef:Pa,useState:function(){return va(ga)},useDebugValue:Ba,useDeferredValue:function(t){return Va(_a(),ra.memoizedState,t)},useTransition:function(){return[va(ga)[0],_a().memoizedState]},useMutableSource:ya,useSyncExternalStore:Sa,useId:Ga,unstable_isNewReconciler:!1},Za={readContext:Dr,useCallback:Ua,useContext:Dr,useEffect:Ma,useImperativeHandle:Na,useInsertionEffect:ka,useLayoutEffect:Oa,useMemo:za,useReducer:ba,useRef:Pa,useState:function(){return ba(ga)},useDebugValue:Ba,useDeferredValue:function(t){var e=_a();return null===ra?e.memoizedState=t:Va(e,ra.memoizedState,t)},useTransition:function(){return[ba(ga)[0],_a().memoizedState]},useMutableSource:ya,useSyncExternalStore:Sa,useId:Ga,unstable_isNewReconciler:!1};function Ja(t,e){if(t&&t.defaultProps){for(var s in e=O({},e),t=t.defaultProps)void 0===e[s]&&(e[s]=t[s]);return e}return e}function to(t,e,s,i){s=null==(s=s(i,e=t.memoizedState))?e:O({},e,s),t.memoizedState=s,0===t.lanes&&(t.updateQueue.baseState=s)}var eo={isMounted:function(t){return!!(t=t._reactInternals)&&zt(t)===t},enqueueSetState:function(t,e,s){t=t._reactInternals;var i=Zl(),n=Jl(t),r=Fr(i,n);r.payload=e,null!=s&&(r.callback=s),null!==(e=Nr(t,r,n))&&(th(e,t,n,i),Br(e,t,n))},enqueueReplaceState:function(t,e,s){t=t._reactInternals;var i=Zl(),n=Jl(t),r=Fr(i,n);r.tag=1,r.payload=e,null!=s&&(r.callback=s),null!==(e=Nr(t,r,n))&&(th(e,t,n,i),Br(e,t,n))},enqueueForceUpdate:function(t,e){t=t._reactInternals;var s=Zl(),i=Jl(t),n=Fr(s,i);n.tag=2,null!=e&&(n.callback=e),null!==(e=Nr(t,n,i))&&(th(e,t,i,s),Br(e,t,i))}};function so(t,e,s,i,n,r,a){return"function"==typeof(t=t.stateNode).shouldComponentUpdate?t.shouldComponentUpdate(i,r,a):!e.prototype||!e.prototype.isPureReactComponent||(!ri(s,i)||!ri(n,r))}function io(t,e,s){var i=!1,n=En,r=e.contextType;return"object"==typeof r&&null!==r?r=Dr(r):(n=Ln(e)?Dn:Cn.current,r=(i=null!=(i=e.contextTypes))?Pn(t,n):En),e=new e(s,r),t.memoizedState=null!==e.state&&void 0!==e.state?e.state:null,e.updater=eo,t.stateNode=e,e._reactInternals=t,i&&((t=t.stateNode).__reactInternalMemoizedUnmaskedChildContext=n,t.__reactInternalMemoizedMaskedChildContext=r),e}function no(t,e,s,i){t=e.state,"function"==typeof e.componentWillReceiveProps&&e.componentWillReceiveProps(s,i),"function"==typeof e.UNSAFE_componentWillReceiveProps&&e.UNSAFE_componentWillReceiveProps(s,i),e.state!==t&&eo.enqueueReplaceState(e,e.state,null)}function ro(t,e,s,i){var n=t.stateNode;n.props=s,n.state=t.memoizedState,n.refs={},kr(t);var r=e.contextType;"object"==typeof r&&null!==r?n.context=Dr(r):(r=Ln(e)?Dn:Cn.current,n.context=Pn(t,r)),n.state=t.memoizedState,"function"==typeof(r=e.getDerivedStateFromProps)&&(to(t,e,r,s),n.state=t.memoizedState),"function"==typeof e.getDerivedStateFromProps||"function"==typeof n.getSnapshotBeforeUpdate||"function"!=typeof n.UNSAFE_componentWillMount&&"function"!=typeof n.componentWillMount||(e=n.state,"function"==typeof n.componentWillMount&&n.componentWillMount(),"function"==typeof n.UNSAFE_componentWillMount&&n.UNSAFE_componentWillMount(),e!==n.state&&eo.enqueueReplaceState(n,n.state,null),zr(t,s,n,i),n.state=t.memoizedState),"function"==typeof n.componentDidMount&&(t.flags|=4194308)}function ao(t,e){try{var s="",i=e;do{s+=U(i),i=i.return}while(i);var n=s}catch(t){n="\nError generating stack: "+t.message+"\n"+t.stack}return{value:t,source:e,stack:n,digest:null}}function oo(t,e,s){return{value:t,source:null,stack:null!=s?s:null,digest:null!=e?e:null}}function lo(t,e){try{console.error(e.value)}catch(t){setTimeout((function(){throw t}))}}var ho="function"==typeof WeakMap?WeakMap:Map;function co(t,e,s){(s=Fr(-1,s)).tag=3,s.payload={element:null};var i=e.value;return s.callback=function(){Hl||(Hl=!0,Gl=i),lo(0,e)},s}function uo(t,e,s){(s=Fr(-1,s)).tag=3;var i=t.type.getDerivedStateFromError;if("function"==typeof i){var n=e.value;s.payload=function(){return i(n)},s.callback=function(){lo(0,e)}}var r=t.stateNode;return null!==r&&"function"==typeof r.componentDidCatch&&(s.callback=function(){lo(0,e),"function"!=typeof i&&(null===Wl?Wl=new Set([this]):Wl.add(this));var t=e.stack;this.componentDidCatch(e.value,{componentStack:null!==t?t:""})}),s}function fo(t,e,s){var i=t.pingCache;if(null===i){i=t.pingCache=new ho;var n=new Set;i.set(e,n)}else void 0===(n=i.get(e))&&(n=new Set,i.set(e,n));n.has(s)||(n.add(s),t=wh.bind(null,t,e,s),e.then(t,t))}function po(t){do{var e;if((e=13===t.tag)&&(e=null===(e=t.memoizedState)||null!==e.dehydrated),e)return t;t=t.return}while(null!==t);return null}function mo(t,e,s,i,n){return 1&t.mode?(t.flags|=65536,t.lanes=n,t):(t===e?t.flags|=65536:(t.flags|=128,s.flags|=131072,s.flags&=-52805,1===s.tag&&(null===s.alternate?s.tag=17:((e=Fr(-1,1)).tag=2,Nr(s,e,1))),s.lanes|=1),t)}var _o=v.ReactCurrentOwner,go=!1;function vo(t,e,s,i){e.child=null===t?br(e,null,s,i):vr(e,t.child,s,i)}function bo(t,e,s,i,n){s=s.render;var r=e.ref;return Ar(e,n),i=fa(t,e,s,i,r,n),s=pa(),null===t||go?(sr&&s&&Zn(e),e.flags|=1,vo(t,e,i,n),e.child):(e.updateQueue=t.updateQueue,e.flags&=-2053,t.lanes&=~n,Ho(t,e,n))}function yo(t,e,s,i,n){if(null===t){var r=s.type;return"function"!=typeof r||Lh(r)||void 0!==r.defaultProps||null!==s.compare||void 0!==s.defaultProps?((t=Rh(s.type,null,i,e,e.mode,n)).ref=e.ref,t.return=e,e.child=t):(e.tag=15,e.type=r,So(t,e,r,i,n))}if(r=t.child,0===(t.lanes&n)){var a=r.memoizedProps;if((s=null!==(s=s.compare)?s:ri)(a,i)&&t.ref===e.ref)return Ho(t,e,n)}return e.flags|=1,(t=Ih(r,i)).ref=e.ref,t.return=e,e.child=t}function So(t,e,s,i,n){if(null!==t){var r=t.memoizedProps;if(ri(r,i)&&t.ref===e.ref){if(go=!1,e.pendingProps=i=r,0===(t.lanes&n))return e.lanes=t.lanes,Ho(t,e,n);131072&t.flags&&(go=!0)}}return To(t,e,s,i,n)}function xo(t,e,s){var i=e.pendingProps,n=i.children,r=null!==t?t.memoizedState:null;if("hidden"===i.mode)if(1&e.mode){if(!(1073741824&s))return t=null!==r?r.baseLanes|s:s,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:t,cachePool:null,transitions:null},e.updateQueue=null,Tn(Il,Ll),Ll|=t,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},i=null!==r?r.baseLanes:s,Tn(Il,Ll),Ll|=i}else e.memoizedState={baseLanes:0,cachePool:null,transitions:null},Tn(Il,Ll),Ll|=s;else null!==r?(i=r.baseLanes|s,e.memoizedState=null):i=s,Tn(Il,Ll),Ll|=i;return vo(t,e,n,s),e.child}function wo(t,e){var s=e.ref;(null===t&&null!==s||null!==t&&t.ref!==s)&&(e.flags|=512,e.flags|=2097152)}function To(t,e,s,i,n){var r=Ln(s)?Dn:Cn.current;return r=Pn(e,r),Ar(e,n),s=fa(t,e,s,i,r,n),i=pa(),null===t||go?(sr&&i&&Zn(e),e.flags|=1,vo(t,e,s,n),e.child):(e.updateQueue=t.updateQueue,e.flags&=-2053,t.lanes&=~n,Ho(t,e,n))}function Eo(t,e,s,i,n){if(Ln(s)){var r=!0;kn(e)}else r=!1;if(Ar(e,n),null===e.stateNode)Vo(t,e),io(e,s,i),ro(e,s,i,n),i=!0;else if(null===t){var a=e.stateNode,o=e.memoizedProps;a.props=o;var l=a.context,h=s.contextType;"object"==typeof h&&null!==h?h=Dr(h):h=Pn(e,h=Ln(s)?Dn:Cn.current);var c=s.getDerivedStateFromProps,d="function"==typeof c||"function"==typeof a.getSnapshotBeforeUpdate;d||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==i||l!==h)&&no(e,a,i,h),Mr=!1;var u=e.memoizedState;a.state=u,zr(e,i,a,n),l=e.memoizedState,o!==i||u!==l||An.current||Mr?("function"==typeof c&&(to(e,s,c,i),l=e.memoizedState),(o=Mr||so(e,s,o,i,u,l,h))?(d||"function"!=typeof a.UNSAFE_componentWillMount&&"function"!=typeof a.componentWillMount||("function"==typeof a.componentWillMount&&a.componentWillMount(),"function"==typeof a.UNSAFE_componentWillMount&&a.UNSAFE_componentWillMount()),"function"==typeof a.componentDidMount&&(e.flags|=4194308)):("function"==typeof a.componentDidMount&&(e.flags|=4194308),e.memoizedProps=i,e.memoizedState=l),a.props=i,a.state=l,a.context=h,i=o):("function"==typeof a.componentDidMount&&(e.flags|=4194308),i=!1)}else{a=e.stateNode,Or(t,e),o=e.memoizedProps,h=e.type===e.elementType?o:Ja(e.type,o),a.props=h,d=e.pendingProps,u=a.context,"object"==typeof(l=s.contextType)&&null!==l?l=Dr(l):l=Pn(e,l=Ln(s)?Dn:Cn.current);var f=s.getDerivedStateFromProps;(c="function"==typeof f||"function"==typeof a.getSnapshotBeforeUpdate)||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==d||u!==l)&&no(e,a,i,l),Mr=!1,u=e.memoizedState,a.state=u,zr(e,i,a,n);var p=e.memoizedState;o!==d||u!==p||An.current||Mr?("function"==typeof f&&(to(e,s,f,i),p=e.memoizedState),(h=Mr||so(e,s,h,i,u,p,l)||!1)?(c||"function"!=typeof a.UNSAFE_componentWillUpdate&&"function"!=typeof a.componentWillUpdate||("function"==typeof a.componentWillUpdate&&a.componentWillUpdate(i,p,l),"function"==typeof a.UNSAFE_componentWillUpdate&&a.UNSAFE_componentWillUpdate(i,p,l)),"function"==typeof a.componentDidUpdate&&(e.flags|=4),"function"==typeof a.getSnapshotBeforeUpdate&&(e.flags|=1024)):("function"!=typeof a.componentDidUpdate||o===t.memoizedProps&&u===t.memoizedState||(e.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===t.memoizedProps&&u===t.memoizedState||(e.flags|=1024),e.memoizedProps=i,e.memoizedState=p),a.props=i,a.state=p,a.context=l,i=h):("function"!=typeof a.componentDidUpdate||o===t.memoizedProps&&u===t.memoizedState||(e.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===t.memoizedProps&&u===t.memoizedState||(e.flags|=1024),i=!1)}return Co(t,e,s,i,r,n)}function Co(t,e,s,i,n,r){wo(t,e);var a=!!(128&e.flags);if(!i&&!a)return n&&On(e,s,!1),Ho(t,e,r);i=e.stateNode,_o.current=e;var o=a&&"function"!=typeof s.getDerivedStateFromError?null:i.render();return e.flags|=1,null!==t&&a?(e.child=vr(e,t.child,null,r),e.child=vr(e,null,o,r)):vo(t,e,o,r),e.memoizedState=i.state,n&&On(e,s,!0),e.child}function Ao(t){var e=t.stateNode;e.pendingContext?Rn(0,e.pendingContext,e.pendingContext!==e.context):e.context&&Rn(0,e.context,!1),$r(t,e.containerInfo)}function Do(t,e,s,i,n){return dr(),ur(n),e.flags|=256,vo(t,e,s,i),e.child}var Po,Lo,Io,Ro,Mo={dehydrated:null,treeContext:null,retryLane:0};function ko(t){return{baseLanes:t,cachePool:null,transitions:null}}function Oo(t,e,i){var n,r=e.pendingProps,a=Qr.current,o=!1,l=!!(128&e.flags);if((n=l)||(n=(null===t||null!==t.memoizedState)&&!!(2&a)),n?(o=!0,e.flags&=-129):null!==t&&null===t.memoizedState||(a|=1),Tn(Qr,1&a),null===t)return or(e),null!==(t=e.memoizedState)&&null!==(t=t.dehydrated)?(1&e.mode?"$!"===t.data?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(l=r.children,t=r.fallback,o?(r=e.mode,o=e.child,l={mode:"hidden",children:l},1&r||null===o?o=kh(l,r,0,null):(o.childLanes=0,o.pendingProps=l),t=Mh(t,r,i,null),o.return=e,t.return=e,o.sibling=t,e.child=o,e.child.memoizedState=ko(i),e.memoizedState=Mo,t):Fo(e,l));if(null!==(a=t.memoizedState)&&null!==(n=a.dehydrated))return function(t,e,i,n,r,a,o){if(i)return 256&e.flags?(e.flags&=-257,No(t,e,o,n=oo(Error(s(422))))):null!==e.memoizedState?(e.child=t.child,e.flags|=128,null):(a=n.fallback,r=e.mode,n=kh({mode:"visible",children:n.children},r,0,null),(a=Mh(a,r,o,null)).flags|=2,n.return=e,a.return=e,n.sibling=a,e.child=n,1&e.mode&&vr(e,t.child,null,o),e.child.memoizedState=ko(o),e.memoizedState=Mo,a);if(!(1&e.mode))return No(t,e,o,null);if("$!"===r.data){if(n=r.nextSibling&&r.nextSibling.dataset)var l=n.dgst;return n=l,No(t,e,o,n=oo(a=Error(s(419)),n,void 0))}if(l=0!==(o&t.childLanes),go||l){if(null!==(n=Al)){switch(o&-o){case 4:r=2;break;case 16:r=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:r=32;break;case 536870912:r=268435456;break;default:r=0}0!==(r=0!==(r&(n.suspendedLanes|o))?0:r)&&r!==a.retryLane&&(a.retryLane=r,Rr(t,r),th(n,t,r,-1))}return fh(),No(t,e,o,n=oo(Error(s(421))))}return"$?"===r.data?(e.flags|=128,e.child=t.child,e=Eh.bind(null,t),r._reactRetry=e,null):(t=a.treeContext,er=on(r.nextSibling),tr=e,sr=!0,ir=null,null!==t&&(jn[Xn++]=qn,jn[Xn++]=Kn,jn[Xn++]=$n,qn=t.id,Kn=t.overflow,$n=e),e=Fo(e,n.children),e.flags|=4096,e)}(t,e,l,r,n,a,i);if(o){o=r.fallback,l=e.mode,n=(a=t.child).sibling;var h={mode:"hidden",children:r.children};return 1&l||e.child===a?(r=Ih(a,h)).subtreeFlags=14680064&a.subtreeFlags:((r=e.child).childLanes=0,r.pendingProps=h,e.deletions=null),null!==n?o=Ih(n,o):(o=Mh(o,l,i,null)).flags|=2,o.return=e,r.return=e,r.sibling=o,e.child=r,r=o,o=e.child,l=null===(l=t.child.memoizedState)?ko(i):{baseLanes:l.baseLanes|i,cachePool:null,transitions:l.transitions},o.memoizedState=l,o.childLanes=t.childLanes&~i,e.memoizedState=Mo,r}return t=(o=t.child).sibling,r=Ih(o,{mode:"visible",children:r.children}),!(1&e.mode)&&(r.lanes=i),r.return=e,r.sibling=null,null!==t&&(null===(i=e.deletions)?(e.deletions=[t],e.flags|=16):i.push(t)),e.child=r,e.memoizedState=null,r}function Fo(t,e){return(e=kh({mode:"visible",children:e},t.mode,0,null)).return=t,t.child=e}function No(t,e,s,i){return null!==i&&ur(i),vr(e,t.child,null,s),(t=Fo(e,e.pendingProps.children)).flags|=2,e.memoizedState=null,t}function Bo(t,e,s){t.lanes|=e;var i=t.alternate;null!==i&&(i.lanes|=e),Cr(t.return,e,s)}function Uo(t,e,s,i,n){var r=t.memoizedState;null===r?t.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:i,tail:s,tailMode:n}:(r.isBackwards=e,r.rendering=null,r.renderingStartTime=0,r.last=i,r.tail=s,r.tailMode=n)}function zo(t,e,s){var i=e.pendingProps,n=i.revealOrder,r=i.tail;if(vo(t,e,i.children,s),2&(i=Qr.current))i=1&i|2,e.flags|=128;else{if(null!==t&&128&t.flags)t:for(t=e.child;null!==t;){if(13===t.tag)null!==t.memoizedState&&Bo(t,s,e);else if(19===t.tag)Bo(t,s,e);else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break t;for(;null===t.sibling;){if(null===t.return||t.return===e)break t;t=t.return}t.sibling.return=t.return,t=t.sibling}i&=1}if(Tn(Qr,i),1&e.mode)switch(n){case"forwards":for(s=e.child,n=null;null!==s;)null!==(t=s.alternate)&&null===Zr(t)&&(n=s),s=s.sibling;null===(s=n)?(n=e.child,e.child=null):(n=s.sibling,s.sibling=null),Uo(e,!1,n,s,r);break;case"backwards":for(s=null,n=e.child,e.child=null;null!==n;){if(null!==(t=n.alternate)&&null===Zr(t)){e.child=n;break}t=n.sibling,n.sibling=s,s=n,n=t}Uo(e,!0,s,null,r);break;case"together":Uo(e,!1,null,null,void 0);break;default:e.memoizedState=null}else e.memoizedState=null;return e.child}function Vo(t,e){!(1&e.mode)&&null!==t&&(t.alternate=null,e.alternate=null,e.flags|=2)}function Ho(t,e,i){if(null!==t&&(e.dependencies=t.dependencies),kl|=e.lanes,0===(i&e.childLanes))return null;if(null!==t&&e.child!==t.child)throw Error(s(153));if(null!==e.child){for(i=Ih(t=e.child,t.pendingProps),e.child=i,i.return=e;null!==t.sibling;)t=t.sibling,(i=i.sibling=Ih(t,t.pendingProps)).return=e;i.sibling=null}return e.child}function Go(t,e){if(!sr)switch(t.tailMode){case"hidden":e=t.tail;for(var s=null;null!==e;)null!==e.alternate&&(s=e),e=e.sibling;null===s?t.tail=null:s.sibling=null;break;case"collapsed":s=t.tail;for(var i=null;null!==s;)null!==s.alternate&&(i=s),s=s.sibling;null===i?e||null===t.tail?t.tail=null:t.tail.sibling=null:i.sibling=null}}function Wo(t){var e=null!==t.alternate&&t.alternate.child===t.child,s=0,i=0;if(e)for(var n=t.child;null!==n;)s|=n.lanes|n.childLanes,i|=14680064&n.subtreeFlags,i|=14680064&n.flags,n.return=t,n=n.sibling;else for(n=t.child;null!==n;)s|=n.lanes|n.childLanes,i|=n.subtreeFlags,i|=n.flags,n.return=t,n=n.sibling;return t.subtreeFlags|=i,t.childLanes=s,e}function jo(t,e,i){var r=e.pendingProps;switch(Jn(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Wo(e),null;case 1:case 17:return Ln(e.type)&&In(),Wo(e),null;case 3:return r=e.stateNode,qr(),wn(An),wn(Cn),ta(),r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),null!==t&&null!==t.child||(hr(e)?e.flags|=4:null===t||t.memoizedState.isDehydrated&&!(256&e.flags)||(e.flags|=1024,null!==ir&&(nh(ir),ir=null))),Lo(t,e),Wo(e),null;case 5:Yr(e);var a=Xr(jr.current);if(i=e.type,null!==t&&null!=e.stateNode)Io(t,e,i,r,a),t.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!r){if(null===e.stateNode)throw Error(s(166));return Wo(e),null}if(t=Xr(Gr.current),hr(e)){r=e.stateNode,i=e.type;var o=e.memoizedProps;switch(r[cn]=e,r[dn]=o,t=!!(1&e.mode),i){case"dialog":Fi("cancel",r),Fi("close",r);break;case"iframe":case"object":case"embed":Fi("load",r);break;case"video":case"audio":for(a=0;a<Ri.length;a++)Fi(Ri[a],r);break;case"source":Fi("error",r);break;case"img":case"image":case"link":Fi("error",r),Fi("load",r);break;case"details":Fi("toggle",r);break;case"input":q(r,o),Fi("invalid",r);break;case"select":r._wrapperState={wasMultiple:!!o.multiple},Fi("invalid",r);break;case"textarea":st(r,o),Fi("invalid",r)}for(var l in _t(i,o),a=null,o)if(o.hasOwnProperty(l)){var h=o[l];"children"===l?"string"==typeof h?r.textContent!==h&&(!0!==o.suppressHydrationWarning&&Ki(r.textContent,h,t),a=["children",h]):"number"==typeof h&&r.textContent!==""+h&&(!0!==o.suppressHydrationWarning&&Ki(r.textContent,h,t),a=["children",""+h]):n.hasOwnProperty(l)&&null!=h&&"onScroll"===l&&Fi("scroll",r)}switch(i){case"input":W(r),Q(r,o,!0);break;case"textarea":W(r),nt(r);break;case"select":case"option":break;default:"function"==typeof o.onClick&&(r.onclick=Yi)}r=a,e.updateQueue=r,null!==r&&(e.flags|=4)}else{l=9===a.nodeType?a:a.ownerDocument,"http://www.w3.org/1999/xhtml"===t&&(t=rt(i)),"http://www.w3.org/1999/xhtml"===t?"script"===i?((t=l.createElement("div")).innerHTML="<script><\/script>",t=t.removeChild(t.firstChild)):"string"==typeof r.is?t=l.createElement(i,{is:r.is}):(t=l.createElement(i),"select"===i&&(l=t,r.multiple?l.multiple=!0:r.size&&(l.size=r.size))):t=l.createElementNS(t,i),t[cn]=e,t[dn]=r,Po(t,e,!1,!1),e.stateNode=t;t:{switch(l=gt(i,r),i){case"dialog":Fi("cancel",t),Fi("close",t),a=r;break;case"iframe":case"object":case"embed":Fi("load",t),a=r;break;case"video":case"audio":for(a=0;a<Ri.length;a++)Fi(Ri[a],t);a=r;break;case"source":Fi("error",t),a=r;break;case"img":case"image":case"link":Fi("error",t),Fi("load",t),a=r;break;case"details":Fi("toggle",t),a=r;break;case"input":q(t,r),a=$(t,r),Fi("invalid",t);break;case"option":default:a=r;break;case"select":t._wrapperState={wasMultiple:!!r.multiple},a=O({},r,{value:void 0}),Fi("invalid",t);break;case"textarea":st(t,r),a=et(t,r),Fi("invalid",t)}for(o in _t(i,a),h=a)if(h.hasOwnProperty(o)){var c=h[o];"style"===o?pt(t,c):"dangerouslySetInnerHTML"===o?null!=(c=c?c.__html:void 0)&&ht(t,c):"children"===o?"string"==typeof c?("textarea"!==i||""!==c)&&ct(t,c):"number"==typeof c&&ct(t,""+c):"suppressContentEditableWarning"!==o&&"suppressHydrationWarning"!==o&&"autoFocus"!==o&&(n.hasOwnProperty(o)?null!=c&&"onScroll"===o&&Fi("scroll",t):null!=c&&g(t,o,c,l))}switch(i){case"input":W(t),Q(t,r,!1);break;case"textarea":W(t),nt(t);break;case"option":null!=r.value&&t.setAttribute("value",""+H(r.value));break;case"select":t.multiple=!!r.multiple,null!=(o=r.value)?tt(t,!!r.multiple,o,!1):null!=r.defaultValue&&tt(t,!!r.multiple,r.defaultValue,!0);break;default:"function"==typeof a.onClick&&(t.onclick=Yi)}switch(i){case"button":case"input":case"select":case"textarea":r=!!r.autoFocus;break t;case"img":r=!0;break t;default:r=!1}}r&&(e.flags|=4)}null!==e.ref&&(e.flags|=512,e.flags|=2097152)}return Wo(e),null;case 6:if(t&&null!=e.stateNode)Ro(t,e,t.memoizedProps,r);else{if("string"!=typeof r&&null===e.stateNode)throw Error(s(166));if(i=Xr(jr.current),Xr(Gr.current),hr(e)){if(r=e.stateNode,i=e.memoizedProps,r[cn]=e,(o=r.nodeValue!==i)&&null!==(t=tr))switch(t.tag){case 3:Ki(r.nodeValue,i,!!(1&t.mode));break;case 5:!0!==t.memoizedProps.suppressHydrationWarning&&Ki(r.nodeValue,i,!!(1&t.mode))}o&&(e.flags|=4)}else(r=(9===i.nodeType?i:i.ownerDocument).createTextNode(r))[cn]=e,e.stateNode=r}return Wo(e),null;case 13:if(wn(Qr),r=e.memoizedState,null===t||null!==t.memoizedState&&null!==t.memoizedState.dehydrated){if(sr&&null!==er&&1&e.mode&&!(128&e.flags))cr(),dr(),e.flags|=98560,o=!1;else if(o=hr(e),null!==r&&null!==r.dehydrated){if(null===t){if(!o)throw Error(s(318));if(!(o=null!==(o=e.memoizedState)?o.dehydrated:null))throw Error(s(317));o[cn]=e}else dr(),!(128&e.flags)&&(e.memoizedState=null),e.flags|=4;Wo(e),o=!1}else null!==ir&&(nh(ir),ir=null),o=!0;if(!o)return 65536&e.flags?e:null}return 128&e.flags?(e.lanes=i,e):((r=null!==r)!==(null!==t&&null!==t.memoizedState)&&r&&(e.child.flags|=8192,1&e.mode&&(null===t||1&Qr.current?0===Rl&&(Rl=3):fh())),null!==e.updateQueue&&(e.flags|=4),Wo(e),null);case 4:return qr(),Lo(t,e),null===t&&Ui(e.stateNode.containerInfo),Wo(e),null;case 10:return Er(e.type._context),Wo(e),null;case 19:if(wn(Qr),null===(o=e.memoizedState))return Wo(e),null;if(r=!!(128&e.flags),null===(l=o.rendering))if(r)Go(o,!1);else{if(0!==Rl||null!==t&&128&t.flags)for(t=e.child;null!==t;){if(null!==(l=Zr(t))){for(e.flags|=128,Go(o,!1),null!==(r=l.updateQueue)&&(e.updateQueue=r,e.flags|=4),e.subtreeFlags=0,r=i,i=e.child;null!==i;)t=r,(o=i).flags&=14680066,null===(l=o.alternate)?(o.childLanes=0,o.lanes=t,o.child=null,o.subtreeFlags=0,o.memoizedProps=null,o.memoizedState=null,o.updateQueue=null,o.dependencies=null,o.stateNode=null):(o.childLanes=l.childLanes,o.lanes=l.lanes,o.child=l.child,o.subtreeFlags=0,o.deletions=null,o.memoizedProps=l.memoizedProps,o.memoizedState=l.memoizedState,o.updateQueue=l.updateQueue,o.type=l.type,t=l.dependencies,o.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext}),i=i.sibling;return Tn(Qr,1&Qr.current|2),e.child}t=t.sibling}null!==o.tail&&Kt()>zl&&(e.flags|=128,r=!0,Go(o,!1),e.lanes=4194304)}else{if(!r)if(null!==(t=Zr(l))){if(e.flags|=128,r=!0,null!==(i=t.updateQueue)&&(e.updateQueue=i,e.flags|=4),Go(o,!0),null===o.tail&&"hidden"===o.tailMode&&!l.alternate&&!sr)return Wo(e),null}else 2*Kt()-o.renderingStartTime>zl&&1073741824!==i&&(e.flags|=128,r=!0,Go(o,!1),e.lanes=4194304);o.isBackwards?(l.sibling=e.child,e.child=l):(null!==(i=o.last)?i.sibling=l:e.child=l,o.last=l)}return null!==o.tail?(e=o.tail,o.rendering=e,o.tail=e.sibling,o.renderingStartTime=Kt(),e.sibling=null,i=Qr.current,Tn(Qr,r?1&i|2:1&i),e):(Wo(e),null);case 22:case 23:return hh(),r=null!==e.memoizedState,null!==t&&null!==t.memoizedState!==r&&(e.flags|=8192),r&&1&e.mode?!!(1073741824&Ll)&&(Wo(e),6&e.subtreeFlags&&(e.flags|=8192)):Wo(e),null;case 24:case 25:return null}throw Error(s(156,e.tag))}function Xo(t,e){switch(Jn(e),e.tag){case 1:return Ln(e.type)&&In(),65536&(t=e.flags)?(e.flags=-65537&t|128,e):null;case 3:return qr(),wn(An),wn(Cn),ta(),65536&(t=e.flags)&&!(128&t)?(e.flags=-65537&t|128,e):null;case 5:return Yr(e),null;case 13:if(wn(Qr),null!==(t=e.memoizedState)&&null!==t.dehydrated){if(null===e.alternate)throw Error(s(340));dr()}return 65536&(t=e.flags)?(e.flags=-65537&t|128,e):null;case 19:return wn(Qr),null;case 4:return qr(),null;case 10:return Er(e.type._context),null;case 22:case 23:return hh(),null;default:return null}}Po=function(t,e){for(var s=e.child;null!==s;){if(5===s.tag||6===s.tag)t.appendChild(s.stateNode);else if(4!==s.tag&&null!==s.child){s.child.return=s,s=s.child;continue}if(s===e)break;for(;null===s.sibling;){if(null===s.return||s.return===e)return;s=s.return}s.sibling.return=s.return,s=s.sibling}},Lo=function(){},Io=function(t,e,s,i){var r=t.memoizedProps;if(r!==i){t=e.stateNode,Xr(Gr.current);var a,o=null;switch(s){case"input":r=$(t,r),i=$(t,i),o=[];break;case"select":r=O({},r,{value:void 0}),i=O({},i,{value:void 0}),o=[];break;case"textarea":r=et(t,r),i=et(t,i),o=[];break;default:"function"!=typeof r.onClick&&"function"==typeof i.onClick&&(t.onclick=Yi)}for(c in _t(s,i),s=null,r)if(!i.hasOwnProperty(c)&&r.hasOwnProperty(c)&&null!=r[c])if("style"===c){var l=r[c];for(a in l)l.hasOwnProperty(a)&&(s||(s={}),s[a]="")}else"dangerouslySetInnerHTML"!==c&&"children"!==c&&"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&"autoFocus"!==c&&(n.hasOwnProperty(c)?o||(o=[]):(o=o||[]).push(c,null));for(c in i){var h=i[c];if(l=null!=r?r[c]:void 0,i.hasOwnProperty(c)&&h!==l&&(null!=h||null!=l))if("style"===c)if(l){for(a in l)!l.hasOwnProperty(a)||h&&h.hasOwnProperty(a)||(s||(s={}),s[a]="");for(a in h)h.hasOwnProperty(a)&&l[a]!==h[a]&&(s||(s={}),s[a]=h[a])}else s||(o||(o=[]),o.push(c,s)),s=h;else"dangerouslySetInnerHTML"===c?(h=h?h.__html:void 0,l=l?l.__html:void 0,null!=h&&l!==h&&(o=o||[]).push(c,h)):"children"===c?"string"!=typeof h&&"number"!=typeof h||(o=o||[]).push(c,""+h):"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&(n.hasOwnProperty(c)?(null!=h&&"onScroll"===c&&Fi("scroll",t),o||l===h||(o=[])):(o=o||[]).push(c,h))}s&&(o=o||[]).push("style",s);var c=o;(e.updateQueue=c)&&(e.flags|=4)}},Ro=function(t,e,s,i){s!==i&&(e.flags|=4)};var $o=!1,qo=!1,Ko="function"==typeof WeakSet?WeakSet:Set,Yo=null;function Qo(t,e){var s=t.ref;if(null!==s)if("function"==typeof s)try{s(null)}catch(s){xh(t,e,s)}else s.current=null}function Zo(t,e,s){try{s()}catch(s){xh(t,e,s)}}var Jo=!1;function tl(t,e,s){var i=e.updateQueue;if(null!==(i=null!==i?i.lastEffect:null)){var n=i=i.next;do{if((n.tag&t)===t){var r=n.destroy;n.destroy=void 0,void 0!==r&&Zo(e,s,r)}n=n.next}while(n!==i)}}function el(t,e){if(null!==(e=null!==(e=e.updateQueue)?e.lastEffect:null)){var s=e=e.next;do{if((s.tag&t)===t){var i=s.create;s.destroy=i()}s=s.next}while(s!==e)}}function sl(t){var e=t.ref;if(null!==e){var s=t.stateNode;t.tag,t=s,"function"==typeof e?e(t):e.current=t}}function il(t){var e=t.alternate;null!==e&&(t.alternate=null,il(e)),t.child=null,t.deletions=null,t.sibling=null,5===t.tag&&(null!==(e=t.stateNode)&&(delete e[cn],delete e[dn],delete e[fn],delete e[pn],delete e[mn])),t.stateNode=null,t.return=null,t.dependencies=null,t.memoizedProps=null,t.memoizedState=null,t.pendingProps=null,t.stateNode=null,t.updateQueue=null}function nl(t){return 5===t.tag||3===t.tag||4===t.tag}function rl(t){t:for(;;){for(;null===t.sibling;){if(null===t.return||nl(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;5!==t.tag&&6!==t.tag&&18!==t.tag;){if(2&t.flags)continue t;if(null===t.child||4===t.tag)continue t;t.child.return=t,t=t.child}if(!(2&t.flags))return t.stateNode}}function al(t,e,s){var i=t.tag;if(5===i||6===i)t=t.stateNode,e?8===s.nodeType?s.parentNode.insertBefore(t,e):s.insertBefore(t,e):(8===s.nodeType?(e=s.parentNode).insertBefore(t,s):(e=s).appendChild(t),null!=(s=s._reactRootContainer)||null!==e.onclick||(e.onclick=Yi));else if(4!==i&&null!==(t=t.child))for(al(t,e,s),t=t.sibling;null!==t;)al(t,e,s),t=t.sibling}function ol(t,e,s){var i=t.tag;if(5===i||6===i)t=t.stateNode,e?s.insertBefore(t,e):s.appendChild(t);else if(4!==i&&null!==(t=t.child))for(ol(t,e,s),t=t.sibling;null!==t;)ol(t,e,s),t=t.sibling}var ll=null,hl=!1;function cl(t,e,s){for(s=s.child;null!==s;)dl(t,e,s),s=s.sibling}function dl(t,e,s){if(ie&&"function"==typeof ie.onCommitFiberUnmount)try{ie.onCommitFiberUnmount(se,s)}catch(t){}switch(s.tag){case 5:qo||Qo(s,e);case 6:var i=ll,n=hl;ll=null,cl(t,e,s),hl=n,null!==(ll=i)&&(hl?(t=ll,s=s.stateNode,8===t.nodeType?t.parentNode.removeChild(s):t.removeChild(s)):ll.removeChild(s.stateNode));break;case 18:null!==ll&&(hl?(t=ll,s=s.stateNode,8===t.nodeType?an(t.parentNode,s):1===t.nodeType&&an(t,s),ze(t)):an(ll,s.stateNode));break;case 4:i=ll,n=hl,ll=s.stateNode.containerInfo,hl=!0,cl(t,e,s),ll=i,hl=n;break;case 0:case 11:case 14:case 15:if(!qo&&(null!==(i=s.updateQueue)&&null!==(i=i.lastEffect))){n=i=i.next;do{var r=n,a=r.destroy;r=r.tag,void 0!==a&&(2&r||4&r)&&Zo(s,e,a),n=n.next}while(n!==i)}cl(t,e,s);break;case 1:if(!qo&&(Qo(s,e),"function"==typeof(i=s.stateNode).componentWillUnmount))try{i.props=s.memoizedProps,i.state=s.memoizedState,i.componentWillUnmount()}catch(t){xh(s,e,t)}cl(t,e,s);break;case 21:cl(t,e,s);break;case 22:1&s.mode?(qo=(i=qo)||null!==s.memoizedState,cl(t,e,s),qo=i):cl(t,e,s);break;default:cl(t,e,s)}}function ul(t){var e=t.updateQueue;if(null!==e){t.updateQueue=null;var s=t.stateNode;null===s&&(s=t.stateNode=new Ko),e.forEach((function(e){var i=Ch.bind(null,t,e);s.has(e)||(s.add(e),e.then(i,i))}))}}function fl(t,e){var i=e.deletions;if(null!==i)for(var n=0;n<i.length;n++){var r=i[n];try{var a=t,o=e,l=o;t:for(;null!==l;){switch(l.tag){case 5:ll=l.stateNode,hl=!1;break t;case 3:case 4:ll=l.stateNode.containerInfo,hl=!0;break t}l=l.return}if(null===ll)throw Error(s(160));dl(a,o,r),ll=null,hl=!1;var h=r.alternate;null!==h&&(h.return=null),r.return=null}catch(t){xh(r,e,t)}}if(12854&e.subtreeFlags)for(e=e.child;null!==e;)pl(e,t),e=e.sibling}function pl(t,e){var i=t.alternate,n=t.flags;switch(t.tag){case 0:case 11:case 14:case 15:if(fl(e,t),ml(t),4&n){try{tl(3,t,t.return),el(3,t)}catch(e){xh(t,t.return,e)}try{tl(5,t,t.return)}catch(e){xh(t,t.return,e)}}break;case 1:fl(e,t),ml(t),512&n&&null!==i&&Qo(i,i.return);break;case 5:if(fl(e,t),ml(t),512&n&&null!==i&&Qo(i,i.return),32&t.flags){var r=t.stateNode;try{ct(r,"")}catch(e){xh(t,t.return,e)}}if(4&n&&null!=(r=t.stateNode)){var a=t.memoizedProps,o=null!==i?i.memoizedProps:a,l=t.type,h=t.updateQueue;if(t.updateQueue=null,null!==h)try{"input"===l&&"radio"===a.type&&null!=a.name&&K(r,a),gt(l,o);var c=gt(l,a);for(o=0;o<h.length;o+=2){var d=h[o],u=h[o+1];"style"===d?pt(r,u):"dangerouslySetInnerHTML"===d?ht(r,u):"children"===d?ct(r,u):g(r,d,u,c)}switch(l){case"input":Y(r,a);break;case"textarea":it(r,a);break;case"select":var f=r._wrapperState.wasMultiple;r._wrapperState.wasMultiple=!!a.multiple;var p=a.value;null!=p?tt(r,!!a.multiple,p,!1):f!==!!a.multiple&&(null!=a.defaultValue?tt(r,!!a.multiple,a.defaultValue,!0):tt(r,!!a.multiple,a.multiple?[]:"",!1))}r[dn]=a}catch(e){xh(t,t.return,e)}}break;case 6:if(fl(e,t),ml(t),4&n){if(null===t.stateNode)throw Error(s(162));r=t.stateNode,a=t.memoizedProps;try{r.nodeValue=a}catch(e){xh(t,t.return,e)}}break;case 3:if(fl(e,t),ml(t),4&n&&null!==i&&i.memoizedState.isDehydrated)try{ze(e.containerInfo)}catch(e){xh(t,t.return,e)}break;case 4:default:fl(e,t),ml(t);break;case 13:fl(e,t),ml(t),8192&(r=t.child).flags&&(a=null!==r.memoizedState,r.stateNode.isHidden=a,!a||null!==r.alternate&&null!==r.alternate.memoizedState||(Ul=Kt())),4&n&&ul(t);break;case 22:if(d=null!==i&&null!==i.memoizedState,1&t.mode?(qo=(c=qo)||d,fl(e,t),qo=c):fl(e,t),ml(t),8192&n){if(c=null!==t.memoizedState,(t.stateNode.isHidden=c)&&!d&&1&t.mode)for(Yo=t,d=t.child;null!==d;){for(u=Yo=d;null!==Yo;){switch(p=(f=Yo).child,f.tag){case 0:case 11:case 14:case 15:tl(4,f,f.return);break;case 1:Qo(f,f.return);var m=f.stateNode;if("function"==typeof m.componentWillUnmount){n=f,i=f.return;try{e=n,m.props=e.memoizedProps,m.state=e.memoizedState,m.componentWillUnmount()}catch(t){xh(n,i,t)}}break;case 5:Qo(f,f.return);break;case 22:if(null!==f.memoizedState){bl(u);continue}}null!==p?(p.return=f,Yo=p):bl(u)}d=d.sibling}t:for(d=null,u=t;;){if(5===u.tag){if(null===d){d=u;try{r=u.stateNode,c?"function"==typeof(a=r.style).setProperty?a.setProperty("display","none","important"):a.display="none":(l=u.stateNode,o=null!=(h=u.memoizedProps.style)&&h.hasOwnProperty("display")?h.display:null,l.style.display=ft("display",o))}catch(e){xh(t,t.return,e)}}}else if(6===u.tag){if(null===d)try{u.stateNode.nodeValue=c?"":u.memoizedProps}catch(e){xh(t,t.return,e)}}else if((22!==u.tag&&23!==u.tag||null===u.memoizedState||u===t)&&null!==u.child){u.child.return=u,u=u.child;continue}if(u===t)break t;for(;null===u.sibling;){if(null===u.return||u.return===t)break t;d===u&&(d=null),u=u.return}d===u&&(d=null),u.sibling.return=u.return,u=u.sibling}}break;case 19:fl(e,t),ml(t),4&n&&ul(t);case 21:}}function ml(t){var e=t.flags;if(2&e){try{t:{for(var i=t.return;null!==i;){if(nl(i)){var n=i;break t}i=i.return}throw Error(s(160))}switch(n.tag){case 5:var r=n.stateNode;32&n.flags&&(ct(r,""),n.flags&=-33),ol(t,rl(t),r);break;case 3:case 4:var a=n.stateNode.containerInfo;al(t,rl(t),a);break;default:throw Error(s(161))}}catch(e){xh(t,t.return,e)}t.flags&=-3}4096&e&&(t.flags&=-4097)}function _l(t,e,s){Yo=t,gl(t)}function gl(t,e,s){for(var i=!!(1&t.mode);null!==Yo;){var n=Yo,r=n.child;if(22===n.tag&&i){var a=null!==n.memoizedState||$o;if(!a){var o=n.alternate,l=null!==o&&null!==o.memoizedState||qo;o=$o;var h=qo;if($o=a,(qo=l)&&!h)for(Yo=n;null!==Yo;)l=(a=Yo).child,22===a.tag&&null!==a.memoizedState?yl(n):null!==l?(l.return=a,Yo=l):yl(n);for(;null!==r;)Yo=r,gl(r),r=r.sibling;Yo=n,$o=o,qo=h}vl(t)}else 8772&n.subtreeFlags&&null!==r?(r.return=n,Yo=r):vl(t)}}function vl(t){for(;null!==Yo;){var e=Yo;if(8772&e.flags){var i=e.alternate;try{if(8772&e.flags)switch(e.tag){case 0:case 11:case 15:qo||el(5,e);break;case 1:var n=e.stateNode;if(4&e.flags&&!qo)if(null===i)n.componentDidMount();else{var r=e.elementType===e.type?i.memoizedProps:Ja(e.type,i.memoizedProps);n.componentDidUpdate(r,i.memoizedState,n.__reactInternalSnapshotBeforeUpdate)}var a=e.updateQueue;null!==a&&Vr(e,a,n);break;case 3:var o=e.updateQueue;if(null!==o){if(i=null,null!==e.child)switch(e.child.tag){case 5:case 1:i=e.child.stateNode}Vr(e,o,i)}break;case 5:var l=e.stateNode;if(null===i&&4&e.flags){i=l;var h=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":h.autoFocus&&i.focus();break;case"img":h.src&&(i.src=h.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===e.memoizedState){var c=e.alternate;if(null!==c){var d=c.memoizedState;if(null!==d){var u=d.dehydrated;null!==u&&ze(u)}}}break;default:throw Error(s(163))}qo||512&e.flags&&sl(e)}catch(t){xh(e,e.return,t)}}if(e===t){Yo=null;break}if(null!==(i=e.sibling)){i.return=e.return,Yo=i;break}Yo=e.return}}function bl(t){for(;null!==Yo;){var e=Yo;if(e===t){Yo=null;break}var s=e.sibling;if(null!==s){s.return=e.return,Yo=s;break}Yo=e.return}}function yl(t){for(;null!==Yo;){var e=Yo;try{switch(e.tag){case 0:case 11:case 15:var s=e.return;try{el(4,e)}catch(t){xh(e,s,t)}break;case 1:var i=e.stateNode;if("function"==typeof i.componentDidMount){var n=e.return;try{i.componentDidMount()}catch(t){xh(e,n,t)}}var r=e.return;try{sl(e)}catch(t){xh(e,r,t)}break;case 5:var a=e.return;try{sl(e)}catch(t){xh(e,a,t)}}}catch(t){xh(e,e.return,t)}if(e===t){Yo=null;break}var o=e.sibling;if(null!==o){o.return=e.return,Yo=o;break}Yo=e.return}}var Sl,xl=Math.ceil,wl=v.ReactCurrentDispatcher,Tl=v.ReactCurrentOwner,El=v.ReactCurrentBatchConfig,Cl=0,Al=null,Dl=null,Pl=0,Ll=0,Il=xn(0),Rl=0,Ml=null,kl=0,Ol=0,Fl=0,Nl=null,Bl=null,Ul=0,zl=1/0,Vl=null,Hl=!1,Gl=null,Wl=null,jl=!1,Xl=null,$l=0,ql=0,Kl=null,Yl=-1,Ql=0;function Zl(){return 6&Cl?Kt():-1!==Yl?Yl:Yl=Kt()}function Jl(t){return 1&t.mode?2&Cl&&0!==Pl?Pl&-Pl:null!==fr.transition?(0===Ql&&(Ql=fe()),Ql):0!==(t=ge)?t:t=void 0===(t=window.event)?16:qe(t.type):1}function th(t,e,i,n){if(50<ql)throw ql=0,Kl=null,Error(s(185));me(t,i,n),2&Cl&&t===Al||(t===Al&&(!(2&Cl)&&(Ol|=i),4===Rl&&rh(t,Pl)),eh(t,n),1===i&&0===Cl&&!(1&e.mode)&&(zl=Kt()+500,Nn&&zn()))}function eh(t,e){var s=t.callbackNode;!function(t,e){for(var s=t.suspendedLanes,i=t.pingedLanes,n=t.expirationTimes,r=t.pendingLanes;0<r;){var a=31-ne(r),o=1<<a,l=n[a];-1===l?0!==(o&s)&&0===(o&i)||(n[a]=de(o,e)):l<=e&&(t.expiredLanes|=o),r&=~o}}(t,e);var i=ce(t,t===Al?Pl:0);if(0===i)null!==s&&Xt(s),t.callbackNode=null,t.callbackPriority=0;else if(e=i&-i,t.callbackPriority!==e){if(null!=s&&Xt(s),1===e)0===t.tag?function(t){Nn=!0,Un(t)}(ah.bind(null,t)):Un(ah.bind(null,t)),nn((function(){!(6&Cl)&&zn()})),s=null;else{switch(ve(i)){case 1:s=Qt;break;case 4:s=Zt;break;case 16:default:s=Jt;break;case 536870912:s=ee}s=Ah(s,sh.bind(null,t))}t.callbackPriority=e,t.callbackNode=s}}function sh(t,e){if(Yl=-1,Ql=0,6&Cl)throw Error(s(327));var i=t.callbackNode;if(yh()&&t.callbackNode!==i)return null;var n=ce(t,t===Al?Pl:0);if(0===n)return null;if(30&n||0!==(n&t.expiredLanes)||e)e=ph(t,n);else{e=n;var r=Cl;Cl|=2;var a=uh();for(Al===t&&Pl===e||(Vl=null,zl=Kt()+500,ch(t,e));;)try{_h();break}catch(e){dh(t,e)}Tr(),wl.current=a,Cl=r,null!==Dl?e=0:(Al=null,Pl=0,e=Rl)}if(0!==e){if(2===e&&(0!==(r=ue(t))&&(n=r,e=ih(t,r))),1===e)throw i=Ml,ch(t,0),rh(t,n),eh(t,Kt()),i;if(6===e)rh(t,n);else{if(r=t.current.alternate,!(30&n||function(t){for(var e=t;;){if(16384&e.flags){var s=e.updateQueue;if(null!==s&&null!==(s=s.stores))for(var i=0;i<s.length;i++){var n=s[i],r=n.getSnapshot;n=n.value;try{if(!ni(r(),n))return!1}catch(t){return!1}}}if(s=e.child,16384&e.subtreeFlags&&null!==s)s.return=e,e=s;else{if(e===t)break;for(;null===e.sibling;){if(null===e.return||e.return===t)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}(r)||(e=ph(t,n),2===e&&(a=ue(t),0!==a&&(n=a,e=ih(t,a))),1!==e)))throw i=Ml,ch(t,0),rh(t,n),eh(t,Kt()),i;switch(t.finishedWork=r,t.finishedLanes=n,e){case 0:case 1:throw Error(s(345));case 2:case 5:bh(t,Bl,Vl);break;case 3:if(rh(t,n),(130023424&n)===n&&10<(e=Ul+500-Kt())){if(0!==ce(t,0))break;if(((r=t.suspendedLanes)&n)!==n){Zl(),t.pingedLanes|=t.suspendedLanes&r;break}t.timeoutHandle=tn(bh.bind(null,t,Bl,Vl),e);break}bh(t,Bl,Vl);break;case 4:if(rh(t,n),(4194240&n)===n)break;for(e=t.eventTimes,r=-1;0<n;){var o=31-ne(n);a=1<<o,(o=e[o])>r&&(r=o),n&=~a}if(n=r,10<(n=(120>(n=Kt()-n)?120:480>n?480:1080>n?1080:1920>n?1920:3e3>n?3e3:4320>n?4320:1960*xl(n/1960))-n)){t.timeoutHandle=tn(bh.bind(null,t,Bl,Vl),n);break}bh(t,Bl,Vl);break;default:throw Error(s(329))}}}return eh(t,Kt()),t.callbackNode===i?sh.bind(null,t):null}function ih(t,e){var s=Nl;return t.current.memoizedState.isDehydrated&&(ch(t,e).flags|=256),2!==(t=ph(t,e))&&(e=Bl,Bl=s,null!==e&&nh(e)),t}function nh(t){null===Bl?Bl=t:Bl.push.apply(Bl,t)}function rh(t,e){for(e&=~Fl,e&=~Ol,t.suspendedLanes|=e,t.pingedLanes&=~e,t=t.expirationTimes;0<e;){var s=31-ne(e),i=1<<s;t[s]=-1,e&=~i}}function ah(t){if(6&Cl)throw Error(s(327));yh();var e=ce(t,0);if(!(1&e))return eh(t,Kt()),null;var i=ph(t,e);if(0!==t.tag&&2===i){var n=ue(t);0!==n&&(e=n,i=ih(t,n))}if(1===i)throw i=Ml,ch(t,0),rh(t,e),eh(t,Kt()),i;if(6===i)throw Error(s(345));return t.finishedWork=t.current.alternate,t.finishedLanes=e,bh(t,Bl,Vl),eh(t,Kt()),null}function oh(t,e){var s=Cl;Cl|=1;try{return t(e)}finally{0===(Cl=s)&&(zl=Kt()+500,Nn&&zn())}}function lh(t){null!==Xl&&0===Xl.tag&&!(6&Cl)&&yh();var e=Cl;Cl|=1;var s=El.transition,i=ge;try{if(El.transition=null,ge=1,t)return t()}finally{ge=i,El.transition=s,!(6&(Cl=e))&&zn()}}function hh(){Ll=Il.current,wn(Il)}function ch(t,e){t.finishedWork=null,t.finishedLanes=0;var s=t.timeoutHandle;if(-1!==s&&(t.timeoutHandle=-1,en(s)),null!==Dl)for(s=Dl.return;null!==s;){var i=s;switch(Jn(i),i.tag){case 1:null!=(i=i.type.childContextTypes)&&In();break;case 3:qr(),wn(An),wn(Cn),ta();break;case 5:Yr(i);break;case 4:qr();break;case 13:case 19:wn(Qr);break;case 10:Er(i.type._context);break;case 22:case 23:hh()}s=s.return}if(Al=t,Dl=t=Ih(t.current,null),Pl=Ll=e,Rl=0,Ml=null,Fl=Ol=kl=0,Bl=Nl=null,null!==Pr){for(e=0;e<Pr.length;e++)if(null!==(i=(s=Pr[e]).interleaved)){s.interleaved=null;var n=i.next,r=s.pending;if(null!==r){var a=r.next;r.next=n,i.next=a}s.pending=i}Pr=null}return t}function dh(t,e){for(;;){var i=Dl;try{if(Tr(),ea.current=Ka,oa){for(var n=na.memoizedState;null!==n;){var r=n.queue;null!==r&&(r.pending=null),n=n.next}oa=!1}if(ia=0,aa=ra=na=null,la=!1,ha=0,Tl.current=null,null===i||null===i.return){Rl=1,Ml=e,Dl=null;break}t:{var a=t,o=i.return,l=i,h=e;if(e=Pl,l.flags|=32768,null!==h&&"object"==typeof h&&"function"==typeof h.then){var c=h,d=l,u=d.tag;if(!(1&d.mode||0!==u&&11!==u&&15!==u)){var f=d.alternate;f?(d.updateQueue=f.updateQueue,d.memoizedState=f.memoizedState,d.lanes=f.lanes):(d.updateQueue=null,d.memoizedState=null)}var p=po(o);if(null!==p){p.flags&=-257,mo(p,o,l,0,e),1&p.mode&&fo(a,c,e),h=c;var m=(e=p).updateQueue;if(null===m){var _=new Set;_.add(h),e.updateQueue=_}else m.add(h);break t}if(!(1&e)){fo(a,c,e),fh();break t}h=Error(s(426))}else if(sr&&1&l.mode){var g=po(o);if(null!==g){!(65536&g.flags)&&(g.flags|=256),mo(g,o,l,0,e),ur(ao(h,l));break t}}a=h=ao(h,l),4!==Rl&&(Rl=2),null===Nl?Nl=[a]:Nl.push(a),a=o;do{switch(a.tag){case 3:a.flags|=65536,e&=-e,a.lanes|=e,Ur(a,co(0,h,e));break t;case 1:l=h;var v=a.type,b=a.stateNode;if(!(128&a.flags||"function"!=typeof v.getDerivedStateFromError&&(null===b||"function"!=typeof b.componentDidCatch||null!==Wl&&Wl.has(b)))){a.flags|=65536,e&=-e,a.lanes|=e,Ur(a,uo(a,l,e));break t}}a=a.return}while(null!==a)}vh(i)}catch(t){e=t,Dl===i&&null!==i&&(Dl=i=i.return);continue}break}}function uh(){var t=wl.current;return wl.current=Ka,null===t?Ka:t}function fh(){0!==Rl&&3!==Rl&&2!==Rl||(Rl=4),null===Al||!(268435455&kl)&&!(268435455&Ol)||rh(Al,Pl)}function ph(t,e){var i=Cl;Cl|=2;var n=uh();for(Al===t&&Pl===e||(Vl=null,ch(t,e));;)try{mh();break}catch(e){dh(t,e)}if(Tr(),Cl=i,wl.current=n,null!==Dl)throw Error(s(261));return Al=null,Pl=0,Rl}function mh(){for(;null!==Dl;)gh(Dl)}function _h(){for(;null!==Dl&&!$t();)gh(Dl)}function gh(t){var e=Sl(t.alternate,t,Ll);t.memoizedProps=t.pendingProps,null===e?vh(t):Dl=e,Tl.current=null}function vh(t){var e=t;do{var s=e.alternate;if(t=e.return,32768&e.flags){if(null!==(s=Xo(s,e)))return s.flags&=32767,void(Dl=s);if(null===t)return Rl=6,void(Dl=null);t.flags|=32768,t.subtreeFlags=0,t.deletions=null}else if(null!==(s=jo(s,e,Ll)))return void(Dl=s);if(null!==(e=e.sibling))return void(Dl=e);Dl=e=t}while(null!==e);0===Rl&&(Rl=5)}function bh(t,e,i){var n=ge,r=El.transition;try{El.transition=null,ge=1,function(t,e,i,n){do{yh()}while(null!==Xl);if(6&Cl)throw Error(s(327));i=t.finishedWork;var r=t.finishedLanes;if(null===i)return null;if(t.finishedWork=null,t.finishedLanes=0,i===t.current)throw Error(s(177));t.callbackNode=null,t.callbackPriority=0;var a=i.lanes|i.childLanes;if(function(t,e){var s=t.pendingLanes&~e;t.pendingLanes=e,t.suspendedLanes=0,t.pingedLanes=0,t.expiredLanes&=e,t.mutableReadLanes&=e,t.entangledLanes&=e,e=t.entanglements;var i=t.eventTimes;for(t=t.expirationTimes;0<s;){var n=31-ne(s),r=1<<n;e[n]=0,i[n]=-1,t[n]=-1,s&=~r}}(t,a),t===Al&&(Dl=Al=null,Pl=0),!(2064&i.subtreeFlags)&&!(2064&i.flags)||jl||(jl=!0,Ah(Jt,(function(){return yh(),null}))),a=!!(15990&i.flags),!!(15990&i.subtreeFlags)||a){a=El.transition,El.transition=null;var o=ge;ge=1;var l=Cl;Cl|=4,Tl.current=null,function(t,e){if(Qi=He,ci(t=hi())){if("selectionStart"in t)var i={start:t.selectionStart,end:t.selectionEnd};else{var n=(i=(i=t.ownerDocument)&&i.defaultView||window).getSelection&&i.getSelection();if(n&&0!==n.rangeCount){i=n.anchorNode;var r=n.anchorOffset,a=n.focusNode;n=n.focusOffset;var o=0,l=-1,h=-1,c=0,d=0,u=t,f=null;t:for(;;){for(var p;u!==i||0!==r&&3!==u.nodeType||(l=o+r),u!==a||0!==n&&3!==u.nodeType||(h=o+n),3===u.nodeType&&(o+=u.nodeValue.length),null!==(p=u.firstChild);)f=u,u=p;for(;;){if(u===t)break t;if(f===i&&++c===r&&(l=o),f===a&&++d===n&&(h=o),null!==(p=u.nextSibling))break;f=(u=f).parentNode}u=p}i=-1===l||-1===h?null:{start:l,end:h}}else i=null}i=i||{start:0,end:0}}else i=null;for(Zi={focusedElem:t,selectionRange:i},He=!1,Yo=e;null!==Yo;)if(t=(e=Yo).child,1028&e.subtreeFlags&&null!==t)t.return=e,Yo=t;else for(;null!==Yo;){e=Yo;try{var m=e.alternate;if(1024&e.flags)switch(e.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==m){var _=m.memoizedProps,g=m.memoizedState,v=e.stateNode,b=v.getSnapshotBeforeUpdate(e.elementType===e.type?_:Ja(e.type,_),g);v.__reactInternalSnapshotBeforeUpdate=b}break;case 3:var y=e.stateNode.containerInfo;1===y.nodeType?y.textContent="":9===y.nodeType&&y.documentElement&&y.removeChild(y.documentElement);break;default:throw Error(s(163))}}catch(t){xh(e,e.return,t)}if(null!==(t=e.sibling)){t.return=e.return,Yo=t;break}Yo=e.return}m=Jo,Jo=!1}(t,i),pl(i,t),di(Zi),He=!!Qi,Zi=Qi=null,t.current=i,_l(i),qt(),Cl=l,ge=o,El.transition=a}else t.current=i;if(jl&&(jl=!1,Xl=t,$l=r),a=t.pendingLanes,0===a&&(Wl=null),function(t){if(ie&&"function"==typeof ie.onCommitFiberRoot)try{ie.onCommitFiberRoot(se,t,void 0,!(128&~t.current.flags))}catch(t){}}(i.stateNode),eh(t,Kt()),null!==e)for(n=t.onRecoverableError,i=0;i<e.length;i++)r=e[i],n(r.value,{componentStack:r.stack,digest:r.digest});if(Hl)throw Hl=!1,t=Gl,Gl=null,t;!!(1&$l)&&0!==t.tag&&yh(),a=t.pendingLanes,1&a?t===Kl?ql++:(ql=0,Kl=t):ql=0,zn()}(t,e,i,n)}finally{El.transition=r,ge=n}return null}function yh(){if(null!==Xl){var t=ve($l),e=El.transition,i=ge;try{if(El.transition=null,ge=16>t?16:t,null===Xl)var n=!1;else{if(t=Xl,Xl=null,$l=0,6&Cl)throw Error(s(331));var r=Cl;for(Cl|=4,Yo=t.current;null!==Yo;){var a=Yo,o=a.child;if(16&Yo.flags){var l=a.deletions;if(null!==l){for(var h=0;h<l.length;h++){var c=l[h];for(Yo=c;null!==Yo;){var d=Yo;switch(d.tag){case 0:case 11:case 15:tl(8,d,a)}var u=d.child;if(null!==u)u.return=d,Yo=u;else for(;null!==Yo;){var f=(d=Yo).sibling,p=d.return;if(il(d),d===c){Yo=null;break}if(null!==f){f.return=p,Yo=f;break}Yo=p}}}var m=a.alternate;if(null!==m){var _=m.child;if(null!==_){m.child=null;do{var g=_.sibling;_.sibling=null,_=g}while(null!==_)}}Yo=a}}if(2064&a.subtreeFlags&&null!==o)o.return=a,Yo=o;else t:for(;null!==Yo;){if(2048&(a=Yo).flags)switch(a.tag){case 0:case 11:case 15:tl(9,a,a.return)}var v=a.sibling;if(null!==v){v.return=a.return,Yo=v;break t}Yo=a.return}}var b=t.current;for(Yo=b;null!==Yo;){var y=(o=Yo).child;if(2064&o.subtreeFlags&&null!==y)y.return=o,Yo=y;else t:for(o=b;null!==Yo;){if(2048&(l=Yo).flags)try{switch(l.tag){case 0:case 11:case 15:el(9,l)}}catch(t){xh(l,l.return,t)}if(l===o){Yo=null;break t}var S=l.sibling;if(null!==S){S.return=l.return,Yo=S;break t}Yo=l.return}}if(Cl=r,zn(),ie&&"function"==typeof ie.onPostCommitFiberRoot)try{ie.onPostCommitFiberRoot(se,t)}catch(t){}n=!0}return n}finally{ge=i,El.transition=e}}return!1}function Sh(t,e,s){t=Nr(t,e=co(0,e=ao(s,e),1),1),e=Zl(),null!==t&&(me(t,1,e),eh(t,e))}function xh(t,e,s){if(3===t.tag)Sh(t,t,s);else for(;null!==e;){if(3===e.tag){Sh(e,t,s);break}if(1===e.tag){var i=e.stateNode;if("function"==typeof e.type.getDerivedStateFromError||"function"==typeof i.componentDidCatch&&(null===Wl||!Wl.has(i))){e=Nr(e,t=uo(e,t=ao(s,t),1),1),t=Zl(),null!==e&&(me(e,1,t),eh(e,t));break}}e=e.return}}function wh(t,e,s){var i=t.pingCache;null!==i&&i.delete(e),e=Zl(),t.pingedLanes|=t.suspendedLanes&s,Al===t&&(Pl&s)===s&&(4===Rl||3===Rl&&(130023424&Pl)===Pl&&500>Kt()-Ul?ch(t,0):Fl|=s),eh(t,e)}function Th(t,e){0===e&&(1&t.mode?(e=le,!(130023424&(le<<=1))&&(le=4194304)):e=1);var s=Zl();null!==(t=Rr(t,e))&&(me(t,e,s),eh(t,s))}function Eh(t){var e=t.memoizedState,s=0;null!==e&&(s=e.retryLane),Th(t,s)}function Ch(t,e){var i=0;switch(t.tag){case 13:var n=t.stateNode,r=t.memoizedState;null!==r&&(i=r.retryLane);break;case 19:n=t.stateNode;break;default:throw Error(s(314))}null!==n&&n.delete(e),Th(t,i)}function Ah(t,e){return jt(t,e)}function Dh(t,e,s,i){this.tag=t,this.key=s,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=i,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Ph(t,e,s,i){return new Dh(t,e,s,i)}function Lh(t){return!(!(t=t.prototype)||!t.isReactComponent)}function Ih(t,e){var s=t.alternate;return null===s?((s=Ph(t.tag,e,t.key,t.mode)).elementType=t.elementType,s.type=t.type,s.stateNode=t.stateNode,s.alternate=t,t.alternate=s):(s.pendingProps=e,s.type=t.type,s.flags=0,s.subtreeFlags=0,s.deletions=null),s.flags=14680064&t.flags,s.childLanes=t.childLanes,s.lanes=t.lanes,s.child=t.child,s.memoizedProps=t.memoizedProps,s.memoizedState=t.memoizedState,s.updateQueue=t.updateQueue,e=t.dependencies,s.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext},s.sibling=t.sibling,s.index=t.index,s.ref=t.ref,s}function Rh(t,e,i,n,r,a){var o=2;if(n=t,"function"==typeof t)Lh(t)&&(o=1);else if("string"==typeof t)o=5;else t:switch(t){case S:return Mh(i.children,r,a,e);case x:o=8,r|=8;break;case w:return(t=Ph(12,i,e,2|r)).elementType=w,t.lanes=a,t;case A:return(t=Ph(13,i,e,r)).elementType=A,t.lanes=a,t;case D:return(t=Ph(19,i,e,r)).elementType=D,t.lanes=a,t;case I:return kh(i,r,a,e);default:if("object"==typeof t&&null!==t)switch(t.$$typeof){case T:o=10;break t;case E:o=9;break t;case C:o=11;break t;case P:o=14;break t;case L:o=16,n=null;break t}throw Error(s(130,null==t?t:typeof t,""))}return(e=Ph(o,i,e,r)).elementType=t,e.type=n,e.lanes=a,e}function Mh(t,e,s,i){return(t=Ph(7,t,i,e)).lanes=s,t}function kh(t,e,s,i){return(t=Ph(22,t,i,e)).elementType=I,t.lanes=s,t.stateNode={isHidden:!1},t}function Oh(t,e,s){return(t=Ph(6,t,null,e)).lanes=s,t}function Fh(t,e,s){return(e=Ph(4,null!==t.children?t.children:[],t.key,e)).lanes=s,e.stateNode={containerInfo:t.containerInfo,pendingChildren:null,implementation:t.implementation},e}function Nh(t,e,s,i,n){this.tag=e,this.containerInfo=t,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=pe(0),this.expirationTimes=pe(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=pe(0),this.identifierPrefix=i,this.onRecoverableError=n,this.mutableSourceEagerHydrationData=null}function Bh(t,e,s,i,n,r,a,o,l){return t=new Nh(t,e,s,o,l),1===e?(e=1,!0===r&&(e|=8)):e=0,r=Ph(3,null,null,e),t.current=r,r.stateNode=t,r.memoizedState={element:i,isDehydrated:s,cache:null,transitions:null,pendingSuspenseBoundaries:null},kr(r),t}function Uh(t){if(!t)return En;t:{if(zt(t=t._reactInternals)!==t||1!==t.tag)throw Error(s(170));var e=t;do{switch(e.tag){case 3:e=e.stateNode.context;break t;case 1:if(Ln(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break t}}e=e.return}while(null!==e);throw Error(s(171))}if(1===t.tag){var i=t.type;if(Ln(i))return Mn(t,i,e)}return e}function zh(t,e,s,i,n,r,a,o,l){return(t=Bh(s,i,!0,t,0,r,0,o,l)).context=Uh(null),s=t.current,(r=Fr(i=Zl(),n=Jl(s))).callback=null!=e?e:null,Nr(s,r,n),t.current.lanes=n,me(t,n,i),eh(t,i),t}function Vh(t,e,s,i){var n=e.current,r=Zl(),a=Jl(n);return s=Uh(s),null===e.context?e.context=s:e.pendingContext=s,(e=Fr(r,a)).payload={element:t},null!==(i=void 0===i?null:i)&&(e.callback=i),null!==(t=Nr(n,e,a))&&(th(t,n,a,r),Br(t,n,a)),a}function Hh(t){return(t=t.current).child?(t.child.tag,t.child.stateNode):null}function Gh(t,e){if(null!==(t=t.memoizedState)&&null!==t.dehydrated){var s=t.retryLane;t.retryLane=0!==s&&s<e?s:e}}function Wh(t,e){Gh(t,e),(t=t.alternate)&&Gh(t,e)}Sl=function(t,e,i){if(null!==t)if(t.memoizedProps!==e.pendingProps||An.current)go=!0;else{if(0===(t.lanes&i)&&!(128&e.flags))return go=!1,function(t,e,s){switch(e.tag){case 3:Ao(e),dr();break;case 5:Kr(e);break;case 1:Ln(e.type)&&kn(e);break;case 4:$r(e,e.stateNode.containerInfo);break;case 10:var i=e.type._context,n=e.memoizedProps.value;Tn(yr,i._currentValue),i._currentValue=n;break;case 13:if(null!==(i=e.memoizedState))return null!==i.dehydrated?(Tn(Qr,1&Qr.current),e.flags|=128,null):0!==(s&e.child.childLanes)?Oo(t,e,s):(Tn(Qr,1&Qr.current),null!==(t=Ho(t,e,s))?t.sibling:null);Tn(Qr,1&Qr.current);break;case 19:if(i=0!==(s&e.childLanes),128&t.flags){if(i)return zo(t,e,s);e.flags|=128}if(null!==(n=e.memoizedState)&&(n.rendering=null,n.tail=null,n.lastEffect=null),Tn(Qr,Qr.current),i)break;return null;case 22:case 23:return e.lanes=0,xo(t,e,s)}return Ho(t,e,s)}(t,e,i);go=!!(131072&t.flags)}else go=!1,sr&&1048576&e.flags&&Qn(e,Wn,e.index);switch(e.lanes=0,e.tag){case 2:var n=e.type;Vo(t,e),t=e.pendingProps;var r=Pn(e,Cn.current);Ar(e,i),r=fa(null,e,n,t,r,i);var a=pa();return e.flags|=1,"object"==typeof r&&null!==r&&"function"==typeof r.render&&void 0===r.$$typeof?(e.tag=1,e.memoizedState=null,e.updateQueue=null,Ln(n)?(a=!0,kn(e)):a=!1,e.memoizedState=null!==r.state&&void 0!==r.state?r.state:null,kr(e),r.updater=eo,e.stateNode=r,r._reactInternals=e,ro(e,n,t,i),e=Co(null,e,n,!0,a,i)):(e.tag=0,sr&&a&&Zn(e),vo(null,e,r,i),e=e.child),e;case 16:n=e.elementType;t:{switch(Vo(t,e),t=e.pendingProps,n=(r=n._init)(n._payload),e.type=n,r=e.tag=function(t){if("function"==typeof t)return Lh(t)?1:0;if(null!=t){if((t=t.$$typeof)===C)return 11;if(t===P)return 14}return 2}(n),t=Ja(n,t),r){case 0:e=To(null,e,n,t,i);break t;case 1:e=Eo(null,e,n,t,i);break t;case 11:e=bo(null,e,n,t,i);break t;case 14:e=yo(null,e,n,Ja(n.type,t),i);break t}throw Error(s(306,n,""))}return e;case 0:return n=e.type,r=e.pendingProps,To(t,e,n,r=e.elementType===n?r:Ja(n,r),i);case 1:return n=e.type,r=e.pendingProps,Eo(t,e,n,r=e.elementType===n?r:Ja(n,r),i);case 3:t:{if(Ao(e),null===t)throw Error(s(387));n=e.pendingProps,r=(a=e.memoizedState).element,Or(t,e),zr(e,n,null,i);var o=e.memoizedState;if(n=o.element,a.isDehydrated){if(a={element:n,isDehydrated:!1,cache:o.cache,pendingSuspenseBoundaries:o.pendingSuspenseBoundaries,transitions:o.transitions},e.updateQueue.baseState=a,e.memoizedState=a,256&e.flags){e=Do(t,e,n,i,r=ao(Error(s(423)),e));break t}if(n!==r){e=Do(t,e,n,i,r=ao(Error(s(424)),e));break t}for(er=on(e.stateNode.containerInfo.firstChild),tr=e,sr=!0,ir=null,i=br(e,null,n,i),e.child=i;i;)i.flags=-3&i.flags|4096,i=i.sibling}else{if(dr(),n===r){e=Ho(t,e,i);break t}vo(t,e,n,i)}e=e.child}return e;case 5:return Kr(e),null===t&&or(e),n=e.type,r=e.pendingProps,a=null!==t?t.memoizedProps:null,o=r.children,Ji(n,r)?o=null:null!==a&&Ji(n,a)&&(e.flags|=32),wo(t,e),vo(t,e,o,i),e.child;case 6:return null===t&&or(e),null;case 13:return Oo(t,e,i);case 4:return $r(e,e.stateNode.containerInfo),n=e.pendingProps,null===t?e.child=vr(e,null,n,i):vo(t,e,n,i),e.child;case 11:return n=e.type,r=e.pendingProps,bo(t,e,n,r=e.elementType===n?r:Ja(n,r),i);case 7:return vo(t,e,e.pendingProps,i),e.child;case 8:case 12:return vo(t,e,e.pendingProps.children,i),e.child;case 10:t:{if(n=e.type._context,r=e.pendingProps,a=e.memoizedProps,o=r.value,Tn(yr,n._currentValue),n._currentValue=o,null!==a)if(ni(a.value,o)){if(a.children===r.children&&!An.current){e=Ho(t,e,i);break t}}else for(null!==(a=e.child)&&(a.return=e);null!==a;){var l=a.dependencies;if(null!==l){o=a.child;for(var h=l.firstContext;null!==h;){if(h.context===n){if(1===a.tag){(h=Fr(-1,i&-i)).tag=2;var c=a.updateQueue;if(null!==c){var d=(c=c.shared).pending;null===d?h.next=h:(h.next=d.next,d.next=h),c.pending=h}}a.lanes|=i,null!==(h=a.alternate)&&(h.lanes|=i),Cr(a.return,i,e),l.lanes|=i;break}h=h.next}}else if(10===a.tag)o=a.type===e.type?null:a.child;else if(18===a.tag){if(null===(o=a.return))throw Error(s(341));o.lanes|=i,null!==(l=o.alternate)&&(l.lanes|=i),Cr(o,i,e),o=a.sibling}else o=a.child;if(null!==o)o.return=a;else for(o=a;null!==o;){if(o===e){o=null;break}if(null!==(a=o.sibling)){a.return=o.return,o=a;break}o=o.return}a=o}vo(t,e,r.children,i),e=e.child}return e;case 9:return r=e.type,n=e.pendingProps.children,Ar(e,i),n=n(r=Dr(r)),e.flags|=1,vo(t,e,n,i),e.child;case 14:return r=Ja(n=e.type,e.pendingProps),yo(t,e,n,r=Ja(n.type,r),i);case 15:return So(t,e,e.type,e.pendingProps,i);case 17:return n=e.type,r=e.pendingProps,r=e.elementType===n?r:Ja(n,r),Vo(t,e),e.tag=1,Ln(n)?(t=!0,kn(e)):t=!1,Ar(e,i),io(e,n,r),ro(e,n,r,i),Co(null,e,n,!0,t,i);case 19:return zo(t,e,i);case 22:return xo(t,e,i)}throw Error(s(156,e.tag))};var jh="function"==typeof reportError?reportError:function(t){console.error(t)};function Xh(t){this._internalRoot=t}function $h(t){this._internalRoot=t}function qh(t){return!(!t||1!==t.nodeType&&9!==t.nodeType&&11!==t.nodeType)}function Kh(t){return!(!t||1!==t.nodeType&&9!==t.nodeType&&11!==t.nodeType&&(8!==t.nodeType||" react-mount-point-unstable "!==t.nodeValue))}function Yh(){}function Qh(t,e,s,i,n){var r=s._reactRootContainer;if(r){var a=r;if("function"==typeof n){var o=n;n=function(){var t=Hh(a);o.call(t)}}Vh(e,a,t,n)}else a=function(t,e,s,i,n){if(n){if("function"==typeof i){var r=i;i=function(){var t=Hh(a);r.call(t)}}var a=zh(e,i,t,0,null,!1,0,"",Yh);return t._reactRootContainer=a,t[un]=a.current,Ui(8===t.nodeType?t.parentNode:t),lh(),a}for(;n=t.lastChild;)t.removeChild(n);if("function"==typeof i){var o=i;i=function(){var t=Hh(l);o.call(t)}}var l=Bh(t,0,!1,null,0,!1,0,"",Yh);return t._reactRootContainer=l,t[un]=l.current,Ui(8===t.nodeType?t.parentNode:t),lh((function(){Vh(e,l,s,i)})),l}(s,e,t,n,i);return Hh(a)}$h.prototype.render=Xh.prototype.render=function(t){var e=this._internalRoot;if(null===e)throw Error(s(409));Vh(t,e,null,null)},$h.prototype.unmount=Xh.prototype.unmount=function(){var t=this._internalRoot;if(null!==t){this._internalRoot=null;var e=t.containerInfo;lh((function(){Vh(null,t,null,null)})),e[un]=null}},$h.prototype.unstable_scheduleHydration=function(t){if(t){var e=xe();t={blockedOn:null,target:t,priority:e};for(var s=0;s<Ie.length&&0!==e&&e<Ie[s].priority;s++);Ie.splice(s,0,t),0===s&&Oe(t)}},be=function(t){switch(t.tag){case 3:var e=t.stateNode;if(e.current.memoizedState.isDehydrated){var s=he(e.pendingLanes);0!==s&&(_e(e,1|s),eh(e,Kt()),!(6&Cl)&&(zl=Kt()+500,zn()))}break;case 13:lh((function(){var e=Rr(t,1);if(null!==e){var s=Zl();th(e,t,1,s)}})),Wh(t,1)}},ye=function(t){if(13===t.tag){var e=Rr(t,134217728);if(null!==e)th(e,t,134217728,Zl());Wh(t,134217728)}},Se=function(t){if(13===t.tag){var e=Jl(t),s=Rr(t,e);if(null!==s)th(s,t,e,Zl());Wh(t,e)}},xe=function(){return ge},we=function(t,e){var s=ge;try{return ge=t,e()}finally{ge=s}},yt=function(t,e,i){switch(e){case"input":if(Y(t,i),e=i.name,"radio"===i.type&&null!=e){for(i=t;i.parentNode;)i=i.parentNode;for(i=i.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<i.length;e++){var n=i[e];if(n!==t&&n.form===t.form){var r=bn(n);if(!r)throw Error(s(90));j(n),Y(n,r)}}}break;case"textarea":it(t,i);break;case"select":null!=(e=i.value)&&tt(t,!!i.multiple,e,!1)}},Ct=oh,At=lh;var Zh={usingClientEntryPoint:!1,Events:[gn,vn,bn,Tt,Et,oh]},Jh={findFiberByHostInstance:_n,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},tc={bundleType:Jh.bundleType,version:Jh.version,rendererPackageName:Jh.rendererPackageName,rendererConfig:Jh.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:v.ReactCurrentDispatcher,findHostInstanceByFiber:function(t){return null===(t=Gt(t))?null:t.stateNode},findFiberByHostInstance:Jh.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var ec=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!ec.isDisabled&&ec.supportsFiber)try{se=ec.inject(tc),ie=ec}catch(lt){}}return Wx.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Zh,Wx.createPortal=function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!qh(e))throw Error(s(200));return function(t,e,s){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:y,key:null==i?null:""+i,children:t,containerInfo:e,implementation:s}}(t,e,null,i)},Wx.createRoot=function(t,e){if(!qh(t))throw Error(s(299));var i=!1,n="",r=jh;return null!=e&&(!0===e.unstable_strictMode&&(i=!0),void 0!==e.identifierPrefix&&(n=e.identifierPrefix),void 0!==e.onRecoverableError&&(r=e.onRecoverableError)),e=Bh(t,1,!1,null,0,i,0,n,r),t[un]=e.current,Ui(8===t.nodeType?t.parentNode:t),new Xh(e)},Wx.findDOMNode=function(t){if(null==t)return null;if(1===t.nodeType)return t;var e=t._reactInternals;if(void 0===e){if("function"==typeof t.render)throw Error(s(188));throw t=Object.keys(t).join(","),Error(s(268,t))}return t=null===(t=Gt(e))?null:t.stateNode},Wx.flushSync=function(t){return lh(t)},Wx.hydrate=function(t,e,i){if(!Kh(e))throw Error(s(200));return Qh(null,t,e,!0,i)},Wx.hydrateRoot=function(t,e,i){if(!qh(t))throw Error(s(405));var n=null!=i&&i.hydratedSources||null,r=!1,a="",o=jh;if(null!=i&&(!0===i.unstable_strictMode&&(r=!0),void 0!==i.identifierPrefix&&(a=i.identifierPrefix),void 0!==i.onRecoverableError&&(o=i.onRecoverableError)),e=zh(e,null,t,1,null!=i?i:null,r,0,a,o),t[un]=e.current,Ui(t),n)for(t=0;t<n.length;t++)r=(r=(i=n[t])._getVersion)(i._source),null==e.mutableSourceEagerHydrationData?e.mutableSourceEagerHydrationData=[i,r]:e.mutableSourceEagerHydrationData.push(i,r);return new $h(e)},Wx.render=function(t,e,i){if(!Kh(e))throw Error(s(200));return Qh(null,t,e,!1,i)},Wx.unmountComponentAtNode=function(t){if(!Kh(t))throw Error(s(40));return!!t._reactRootContainer&&(lh((function(){Qh(null,null,t,!1,(function(){t._reactRootContainer=null,t[un]=null}))})),!0)},Wx.unstable_batchedUpdates=oh,Wx.unstable_renderSubtreeIntoContainer=function(t,e,i,n){if(!Kh(i))throw Error(s(200));if(null==t||void 0===t._reactInternals)throw Error(s(38));return Qh(t,e,i,!1,n)},Wx.version="18.3.1-next-f1338f8080-20240426",Wx}function Yx(){if(Hx)return Gx.exports;return Hx=1,function t(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(t)}catch(t){console.error(t)}}(),Gx.exports=Kx(),Gx.exports}var Qx=n(Yx());const Zx=t=>u.createElement(jt,{class:"pcui-error",title:"Error",hidden:!t.observerData.ui.error,text:t.observerData.ui.error,icon:"E218"}),Jx=(t,e,s=2)=>{let i,n;const r=t=>{i=t.pageX,n=t.pageY};t.addEventListener("mousedown",r);const a=t=>{const r=Math.abs(t.pageX-i),a=Math.abs(t.pageY-n);r<s&&a<s&&e(t)};return t.addEventListener("mouseup",a),()=>{t.removeEventListener("mousedown",r),t.removeEventListener("mouseup",a)}},tw=(t,e)=>{const s=(t,e)=>{for(const s of e){if(!t.hasOwnProperty(s))return null;t=t[s]}return t},i={};for(const n of e){const e=n.split("."),r=s(t,e);let a=i;for(let t=0;t<e.length;++t){const s=e[t];t<e.length-1?(a.hasOwnProperty(s)||(a[s]={}),a=a[s]):a[s]=r}}return i},ew=t=>u.createElement(vt,{class:"panel-option"},u.createElement(Xt,{class:"panel-label",text:t.label}),u.createElement(Xt,{class:"panel-value",text:String(t.value)})),sw=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement(Xt,{class:"panel-label",text:t.label}),u.createElement(Pe,{class:"panel-value",dimensions:t.dimensions,value:t.value,precision:7})),iw=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement(Xt,{class:"panel-label",text:t.label}),u.createElement(rt,{class:"panel-value-boolean",type:"toggle",value:t.value,onChange:e=>t.setProperty(e)})),nw=t=>u.createElement(vt,{class:"panel-option"},u.createElement(Xt,{class:"panel-label",text:t.label}),u.createElement(vt,{class:"panel-value"},u.createElement(rt,{type:"toggle",value:t.booleanValue,onChange:e=>t.setBooleanProperty(e)}),u.createElement(gt,{class:"panel-value-toggle-color",value:t.colorValue,onChange:e=>t.setColorProperty(e)}))),rw=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement(Xt,{class:"panel-label",text:t.label}),u.createElement(ne,{class:"panel-value",min:t.min,max:t.max,sliderMin:t.min,sliderMax:t.max,precision:t.precision,step:t.step??.01,onChange:e=>{t.setProperty(e)},value:t.value})),aw=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement(Xt,{class:"panel-label",text:t.label}),u.createElement($t,{class:"panel-value",min:t.min,max:t.max,onChange:e=>{t.setProperty(e)},value:t.value})),ow=t=>u.createElement(vt,{class:"panel-option",hidden:t.hidden,enabled:t.enabled??!0},u.createElement(Xt,{class:"panel-label",text:t.label}),u.createElement(gt,{class:"panel-value",value:t.value,onChange:e=>t.setProperty(e)})),lw=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement(Xt,{class:"morph-label",flexGrow:"1",flexShrink:"1",text:t.label?t.label:t.name.substring(0,1).toUpperCase()+t.name.substring(1,t.name.length),flex:!0}),u.createElement(ne,{class:"morph-value",flexGrow:"0",flexShrink:"0",min:t.min,max:t.max,sliderMin:t.min,sliderMax:t.max,precision:t.precision,step:.01,onChange:e=>{t.setProperty(e)},value:t.value})),hw=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement(Xt,{class:"panel-label",text:t.label}),u.createElement(Kt,{class:"panel-value",type:t.type,options:t.options,value:t.value,onChange:e=>{t.setProperty(e)}})),cw=t=>u.createElement(Kt,{id:t.id,class:t.class,width:t.width,type:t.type,options:t.options,enabled:t.enabled??!0,value:t.value,onChange:e=>{t.setProperty(e)}}),dw=t=>u.createElement(ne,{id:t.id,class:t.class,width:t.width,min:t.min,max:t.max,sliderMin:t.min,sliderMax:t.max,precision:t.precision,step:.01,enabled:t.enabled??!0,value:t.value,onChange:e=>{t.setProperty(e)}});var uw,fw={exports:{}};function pw(){return uw?fw.exports:(uw=1,t=function(t,e){return function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=4)}([function(t,e,s){t.exports=s(5)()},function(e,s){e.exports=t},function(t,s){t.exports=e},function(t,e){t.exports=function(t,e,s){var i=t.direction,n=t.value;switch(i){case"top":return s.top+n<e.top&&s.bottom>e.bottom&&s.left<e.left&&s.right>e.right;case"left":return s.left+n<e.left&&s.bottom>e.bottom&&s.top<e.top&&s.right>e.right;case"bottom":return s.bottom-n>e.bottom&&s.left<e.left&&s.right>e.right&&s.top<e.top;case"right":return s.right-n>e.right&&s.left<e.left&&s.top<e.top&&s.bottom>e.bottom}}},function(t,e,s){s.r(e),s.d(e,"default",(function(){return g}));var i=s(1),n=s.n(i),r=s(2),a=s.n(r),o=s(0),l=s.n(o),h=s(3),c=s.n(h);function d(t){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},d(t)}function u(t,e,s){return e&&function(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(t.prototype,e),t}function f(t){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},f(t)}function p(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function m(t,e){return m=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},m(t,e)}function _(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}var g=function(t){function e(t){var s;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),s=function(t,e){return!e||"object"!==d(e)&&"function"!=typeof e?p(t):e}(this,f(e).call(this,t)),_(p(s),"getContainer",(function(){return s.props.containment||window})),_(p(s),"addEventListener",(function(t,e,i,n){var r;s.debounceCheck||(s.debounceCheck={});var a=function(){r=null,s.check()},o={target:t,fn:n>-1?function(){r||(r=setTimeout(a,n||0))}:function(){clearTimeout(r),r=setTimeout(a,i||0)},getLastTimeout:function(){return r}};t.addEventListener(e,o.fn),s.debounceCheck[e]=o})),_(p(s),"startWatching",(function(){s.debounceCheck||s.interval||(s.props.intervalCheck&&(s.interval=setInterval(s.check,s.props.intervalDelay)),s.props.scrollCheck&&s.addEventListener(s.getContainer(),"scroll",s.props.scrollDelay,s.props.scrollThrottle),s.props.resizeCheck&&s.addEventListener(window,"resize",s.props.resizeDelay,s.props.resizeThrottle),!s.props.delayedCall&&s.check())})),_(p(s),"stopWatching",(function(){if(s.debounceCheck)for(var t in s.debounceCheck)if(s.debounceCheck.hasOwnProperty(t)){var e=s.debounceCheck[t];clearTimeout(e.getLastTimeout()),e.target.removeEventListener(t,e.fn),s.debounceCheck[t]=null}s.debounceCheck=null,s.interval&&(s.interval=clearInterval(s.interval))})),_(p(s),"check",(function(){var t,e,i=s.node;if(!i)return s.state;if(t=function(t){return void 0===t.width&&(t.width=t.right-t.left),void 0===t.height&&(t.height=t.bottom-t.top),t}(s.roundRectDown(i.getBoundingClientRect())),s.props.containment){var n=s.props.containment.getBoundingClientRect();e={top:n.top,left:n.left,bottom:n.bottom,right:n.right}}else e={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var r=s.props.offset||{};"object"===d(r)&&(e.top+=r.top||0,e.left+=r.left||0,e.bottom-=r.bottom||0,e.right-=r.right||0);var a={top:t.top>=e.top,left:t.left>=e.left,bottom:t.bottom<=e.bottom,right:t.right<=e.right},o=t.height>0&&t.width>0,l=o&&a.top&&a.left&&a.bottom&&a.right;if(o&&s.props.partialVisibility){var h=t.top<=e.bottom&&t.bottom>=e.top&&t.left<=e.right&&t.right>=e.left;"string"==typeof s.props.partialVisibility&&(h=a[s.props.partialVisibility]),l=s.props.minTopValue?h&&t.top<=e.bottom-s.props.minTopValue:h}"string"==typeof r.direction&&"number"==typeof r.value&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",r.direction,r.value),l=c()(r,t,e));var u=s.state;return s.state.isVisible!==l&&(u={isVisible:l,visibilityRect:a},s.setState(u),s.props.onChange&&s.props.onChange(l)),u})),s.state={isVisible:null,visibilityRect:{}},s}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&m(t,e)}(e,t),u(e,[{key:"componentDidMount",value:function(){this.node=a.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(t){this.node=a.a.findDOMNode(this),this.props.active&&!t.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(t){return{top:Math.floor(t.top),left:Math.floor(t.left),bottom:Math.floor(t.bottom),right:Math.floor(t.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):n.a.Children.only(this.props.children)}}]),e}(n.a.Component);_(g,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:n.a.createElement("span",null)}),_(g,"propTypes",{onChange:l.a.func,active:l.a.bool,partialVisibility:l.a.oneOfType([l.a.bool,l.a.oneOf(["top","right","bottom","left"])]),delayedCall:l.a.bool,offset:l.a.oneOfType([l.a.shape({top:l.a.number,left:l.a.number,bottom:l.a.number,right:l.a.number}),l.a.shape({direction:l.a.oneOf(["top","right","bottom","left"]),value:l.a.number})]),scrollCheck:l.a.bool,scrollDelay:l.a.number,scrollThrottle:l.a.number,resizeCheck:l.a.bool,resizeDelay:l.a.number,resizeThrottle:l.a.number,intervalCheck:l.a.bool,intervalDelay:l.a.number,containment:"undefined"!=typeof window?l.a.instanceOf(window.Element):l.a.any,children:l.a.oneOfType([l.a.element,l.a.func]),minTopValue:l.a.number})},function(t,e,s){var i=s(6);function n(){}function r(){}r.resetWarningCache=n,t.exports=function(){function t(t,e,s,n,r,a){if(a!==i){var o=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw o.name="Invariant Violation",o}}function e(){return t}t.isRequired=t;var s={array:t,bool:t,func:t,number:t,object:t,string:t,symbol:t,any:t,arrayOf:e,element:t,elementType:t,instanceOf:e,node:t,objectOf:e,oneOf:e,oneOfType:e,shape:e,exact:e,checkPropTypes:r,resetWarningCache:n};return s.PropTypes=s,s}},function(t,e,s){t.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"}])},fw.exports=t(c(),Yx()));var t}var mw=n(pw());class _w extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.morphs)!==JSON.stringify(this.props.morphs)}render(){const t=this.props.morphs;return t?u.createElement(qt,{headerText:"MORPH TARGETS",class:"scene-morph-panel",collapsible:!1},Object.keys(t).map((e=>{const s=t[e];return u.createElement("div",{key:`${e}.${s.name}`},u.createElement(qt,{headerText:s.name,collapsible:!0,class:"morph-target-panel"},Object.keys(s.targets).map((t=>{const i=s.targets[t];return u.createElement("div",{key:t},u.createElement(mw,{offset:{top:-750,bottom:-750}},(({isVisible:s})=>u.createElement("div",null,s?u.createElement(lw,{name:`${i.name}`,precision:2,min:0,max:1,value:i.weight,setProperty:s=>this.props.setProperty(`morphs.${e}.targets.${t}.weight`,s)}):u.createElement("div",{style:{width:30,height:30}})))))}))))}))):null}}const gw=()=>{const t=document.getElementById("panel-left");t&&t.classList.toggle("collapsed")},vw=t=>{const e=["Bytes","KB","MB","GB","TB"];if(0===t)return"n/a";const s=Math.min(Math.floor(Math.log(t)/Math.log(1024)),e.length-1);return 0===s?`${t} ${e[s]}`:`${(t/1024**s).toFixed(1)} ${e[s]}`};class bw extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.sceneData.filenames)!==JSON.stringify(this.props.sceneData.filenames)||t.sceneData.loadTime!==this.props.sceneData.loadTime||t.sceneData.meshCount!==this.props.sceneData.meshCount||t.sceneData.vertexCount!==this.props.sceneData.vertexCount||t.sceneData.primitiveCount!==this.props.sceneData.primitiveCount||t.sceneData.materialCount!==this.props.sceneData.materialCount||t.sceneData.textureVRAM!==this.props.sceneData.textureVRAM||t.sceneData.meshVRAM!==this.props.sceneData.meshVRAM||t.sceneData.bounds!==this.props.sceneData.bounds||t.sceneData.variant.selected!==this.props.sceneData.variant.selected||t.sceneData.variants.list!==this.props.sceneData.variants.list}render(){const t=this.props.sceneData,e=JSON.parse(t.variants.list).map((t=>({v:t,t:t})));return u.createElement(qt,{headerText:"SCENE",id:"scene-panel",flexShrink:"0",flexGrow:"0",collapsible:!1},u.createElement(ew,{label:"Filename",value:t.filenames.join(", ")}),u.createElement(ew,{label:"Meshes",value:t.meshCount}),u.createElement(ew,{label:"Materials",value:t.materialCount}),u.createElement(ew,{label:"Textures",value:t.textureCount}),u.createElement(ew,{label:"Primitives",value:t.primitiveCount}),u.createElement(ew,{label:"Verts",value:t.vertexCount}),u.createElement(ew,{label:"Mesh VRAM",value:vw(t.meshVRAM)}),u.createElement(ew,{label:"Texture VRAM",value:vw(t.textureVRAM)}),u.createElement(ew,{label:"Load time",value:t.loadTime}),u.createElement(sw,{label:"Bounds",dimensions:3,value:t.bounds,enabled:!1}),u.createElement(hw,{label:"Variant",type:"string",options:e,value:t.variant.selected,setProperty:t=>{this.props.setProperty("scene.variant.selected",t)},enabled:e.length>0}))}}class yw extends u.Component{shouldComponentUpdate(t){return t.sceneData.nodes!==this.props.sceneData.nodes}render(){const t=this.props.sceneData,e=JSON.parse(t.nodes),s=t=>t.map((t=>u.createElement(Ae,{text:`${t.name}`,key:t.path,onSelect:e=>{this.props.setProperty("scene.selectedNode.path",t.path);const s=Jx(document.body,(()=>{e.selected=!1,s()}),4)},onDeselect:()=>this.props.setProperty("scene.selectedNode.path","")},s(t.children))));return u.createElement(qt,{headerText:"HIERARCHY",class:"scene-hierarchy-panel",enabled:e.length>0,collapsible:!1},e.length>0&&u.createElement(Ce,{allowReordering:!1,allowDrag:!1},s(e)))}}class Sw extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.observerData.runtime)!==JSON.stringify(this.props.observerData.runtime)||t.observerData.enableWebGPU!==this.props.observerData.enableWebGPU}render(){const t=this.props.observerData.runtime;return u.createElement(qt,{headerText:"DEVICE",id:"device-panel",collapsible:!1},u.createElement(iw,{label:"Use WebGPU",value:this.props.observerData.enableWebGPU,enabled:void 0!==navigator.gpu,setProperty:t=>this.props.setProperty("enableWebGPU",t)}),u.createElement(ew,{label:"Active Device",value:"webgpu"===t.activeDeviceType?"webgpu (beta)":t.activeDeviceType}),u.createElement(ew,{label:"Viewport",value:`${t.viewportWidth} x ${t.viewportHeight}`}))}}class xw extends u.Component{isMobile;constructor(t){super(t),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(t){return JSON.stringify(t.observerData.scene)!==JSON.stringify(this.props.observerData.scene)||JSON.stringify(t.observerData.runtime)!==JSON.stringify(this.props.observerData.runtime)}componentDidMount(){document.getElementById("panel-toggle").addEventListener("click",(()=>{gw()})),document.getElementById("title").addEventListener("click",(()=>{gw()}))}componentDidUpdate(t){}render(){const t=this.props.observerData.scene,e=this.props.observerData.morphs;return u.createElement(vt,{id:"scene-container",flex:!0},u.createElement(bw,{sceneData:t,setProperty:this.props.setProperty}),u.createElement("div",{id:"scene-scrolly-bits"},u.createElement(yw,{sceneData:t,setProperty:this.props.setProperty}),u.createElement(_w,{progress:this.props.observerData.animation.progress,morphs:e,setProperty:this.props.setProperty})),u.createElement(Sw,{observerData:this.props.observerData,setProperty:this.props.setProperty}))}}var ww="5.5.3";const Tw=t=>{const[e,s]=d.useState(!1),i=d.useRef(null);return u.createElement("div",{id:"load-controls"},u.createElement(vt,{class:"load-button-panel",enabled:!0,flex:!0},u.createElement("div",{className:"header"},u.createElement("img",{src:"static/playcanvas-logo.png"}),u.createElement("div",null,u.createElement(Xt,{text:`MODEL VIEWER v${ww}`})),u.createElement(at,{onClick:()=>{window.open("https://github.com/playcanvas/model-viewer","_blank").focus()},icon:"E259"})),u.createElement("input",{type:"file",id:"file",accept:".glb,.gltf,.ply",multiple:!0,onChange:t=>{const e=window.viewer,s=t.target.files;if(e&&s.length){const t=[];for(let e=0;e<s.length;++e){const i=s[e];t.push({url:URL.createObjectURL(i),filename:i.name})}e.loadFiles(t)}},ref:i,style:{display:"none"}}),u.createElement("div",{id:"drag-drop",onClick:()=>{i.current.click()}},u.createElement(at,{id:"drag-drop-search-icon",icon:"E129"}),u.createElement(Xt,{class:"desktop",text:"Drag & drop .glb, .gltf, or .ply files, or click to open files"}),u.createElement(Xt,{class:"mobile",text:"Click to open files"})),u.createElement(Xt,{id:"or-text",text:"OR",class:"centered-label"}),u.createElement(oe,{class:"secondary",id:"glb-url-input",placeholder:"Enter .glb, .gltf, or .ply URL",keyChange:!0,onValidate:t=>{const e=(t=>{try{return new URL(t),!0}catch{return!1}})(t);return s(e),e}}),u.createElement(at,{class:"secondary",id:"glb-url-button",text:"LOAD MODEL FROM URL",onClick:()=>{const t=window.viewer,e=document.getElementById("glb-url-input").ui.value,s=new URL(e).pathname.split("/").pop(),i=!!s.split(".").splice(1).pop();t.loadFiles([{url:e,filename:s+(i?"":".glb")}])},enabled:e})))};class Ew extends u.Component{shouldComponentUpdate(t){return t.animationData.list!==this.props.animationData.list||t.animationData.playing!==this.props.animationData.playing||t.animationData.selectedTrack!==this.props.animationData.selectedTrack}render(){const t=this.props,e=JSON.parse(t.animationData.list).map((t=>({v:t,t:t})));return u.createElement(cw,{id:"anim-track-select",width:160,type:"string",options:e,setProperty:e=>t.setProperty("animation.selectedTrack",e),value:t.animationData.selectedTrack})}}class Cw extends u.Component{shouldComponentUpdate(t){return t.animationData.speed!==this.props.animationData.speed}render(){const t=this.props;return u.createElement(cw,{id:"anim-speed-select",width:60,type:"string",setProperty:e=>t.setProperty("animation.speed",e),value:t.animationData.speed,options:[{v:"0.25",t:"0.25x"},{v:"0.5",t:"0.5x"},{v:"1",t:"1x"},{v:"1.5",t:"1.5x"},{v:"2",t:"2x"}]})}}class Aw extends u.Component{animationState;shouldComponentUpdate(t){return JSON.stringify(t.animationData)!==JSON.stringify(this.props.animationData)}componentDidUpdate(){this.animationState=this.props.animationData}render(){const t=this.props;return JSON.parse(t.animationData.list).length>0?u.createElement("div",{className:"animation-controls-panel-parent"},u.createElement(at,{class:"anim-control-button",width:30,height:30,icon:t.animationData.playing?"E376":"E286",text:"",onClick:()=>{t.setProperty("animation.playing",!this.animationState.playing)}}),u.createElement(Ew,{animationData:this.props.animationData,setProperty:this.props.setProperty}),u.createElement(dw,{id:"anim-scrub-slider",width:240,precision:2,min:0,max:1,setProperty:e=>{const s=this.animationState;s.playing=!1,s.progress=e,t.setProperty("animation",s)},value:t.animationData.progress}),u.createElement(Cw,{animationData:this.props.animationData,setProperty:this.props.setProperty})):u.createElement("div",null)}}var Dw,Pw={exports:{}};function Lw(){return Dw||(Dw=1,Pw.exports=function(){var t=function(){},e=Object.prototype.hasOwnProperty,s=Array.prototype.slice;function i(e,s){var i;return"function"==typeof Object.create?i=Object.create(e):(t.prototype=e,i=new t,t.prototype=null),s&&r(!0,i,s),i}function n(t,e,s,n){var a=this;return"string"!=typeof t&&(n=s,s=e,e=t,t=null),"function"!=typeof e&&(n=s,s=e,e=function(){return a.apply(this,arguments)}),r(!1,e,a,n),e.prototype=i(a.prototype,s),e.prototype.constructor=e,e.class_=t||a.class_,e.super_=a,e}function r(t,i,n){for(var r,a,o=0,l=(n=s.call(arguments,2)).length;o<l;o++)for(r in a=n[o])t&&!e.call(a,r)||(i[r]=a[r])}var a=n;function o(){}o.class_="Nevis",o.super_=Object,o.extend=a;var l=o,h=l.extend((function(t,e,s){this.qrious=t,this.element=e,this.element.qrious=t,this.enabled=Boolean(s)}),{draw:function(t){},getElement:function(){return this.enabled||(this.enabled=!0,this.render()),this.element},getModuleSize:function(t){var e=this.qrious,s=e.padding||0,i=Math.floor((e.size-2*s)/t.width);return Math.max(1,i)},getOffset:function(t){var e=this.qrious,s=e.padding;if(null!=s)return s;var i=this.getModuleSize(t),n=Math.floor((e.size-i*t.width)/2);return Math.max(0,n)},render:function(t){this.enabled&&(this.resize(),this.reset(),this.draw(t))},reset:function(){},resize:function(){}}),c=h,d=c.extend({draw:function(t){var e,s,i=this.qrious,n=this.getModuleSize(t),r=this.getOffset(t),a=this.element.getContext("2d");for(a.fillStyle=i.foreground,a.globalAlpha=i.foregroundAlpha,e=0;e<t.width;e++)for(s=0;s<t.width;s++)t.buffer[s*t.width+e]&&a.fillRect(n*e+r,n*s+r,n,n)},reset:function(){var t=this.qrious,e=this.element.getContext("2d"),s=t.size;e.lineWidth=1,e.clearRect(0,0,s,s),e.fillStyle=t.background,e.globalAlpha=t.backgroundAlpha,e.fillRect(0,0,s,s)},resize:function(){var t=this.element;t.width=t.height=this.qrious.size}}),u=d,f=l.extend(null,{BLOCK:[0,11,15,19,23,27,31,16,18,20,22,24,26,28,20,22,24,24,26,28,28,22,24,24,26,26,28,28,24,24,26,26,26,28,28,24,26,26,26,28,28]}),p=l.extend(null,{BLOCKS:[1,0,19,7,1,0,16,10,1,0,13,13,1,0,9,17,1,0,34,10,1,0,28,16,1,0,22,22,1,0,16,28,1,0,55,15,1,0,44,26,2,0,17,18,2,0,13,22,1,0,80,20,2,0,32,18,2,0,24,26,4,0,9,16,1,0,108,26,2,0,43,24,2,2,15,18,2,2,11,22,2,0,68,18,4,0,27,16,4,0,19,24,4,0,15,28,2,0,78,20,4,0,31,18,2,4,14,18,4,1,13,26,2,0,97,24,2,2,38,22,4,2,18,22,4,2,14,26,2,0,116,30,3,2,36,22,4,4,16,20,4,4,12,24,2,2,68,18,4,1,43,26,6,2,19,24,6,2,15,28,4,0,81,20,1,4,50,30,4,4,22,28,3,8,12,24,2,2,92,24,6,2,36,22,4,6,20,26,7,4,14,28,4,0,107,26,8,1,37,22,8,4,20,24,12,4,11,22,3,1,115,30,4,5,40,24,11,5,16,20,11,5,12,24,5,1,87,22,5,5,41,24,5,7,24,30,11,7,12,24,5,1,98,24,7,3,45,28,15,2,19,24,3,13,15,30,1,5,107,28,10,1,46,28,1,15,22,28,2,17,14,28,5,1,120,30,9,4,43,26,17,1,22,28,2,19,14,28,3,4,113,28,3,11,44,26,17,4,21,26,9,16,13,26,3,5,107,28,3,13,41,26,15,5,24,30,15,10,15,28,4,4,116,28,17,0,42,26,17,6,22,28,19,6,16,30,2,7,111,28,17,0,46,28,7,16,24,30,34,0,13,24,4,5,121,30,4,14,47,28,11,14,24,30,16,14,15,30,6,4,117,30,6,14,45,28,11,16,24,30,30,2,16,30,8,4,106,26,8,13,47,28,7,22,24,30,22,13,15,30,10,2,114,28,19,4,46,28,28,6,22,28,33,4,16,30,8,4,122,30,22,3,45,28,8,26,23,30,12,28,15,30,3,10,117,30,3,23,45,28,4,31,24,30,11,31,15,30,7,7,116,30,21,7,45,28,1,37,23,30,19,26,15,30,5,10,115,30,19,10,47,28,15,25,24,30,23,25,15,30,13,3,115,30,2,29,46,28,42,1,24,30,23,28,15,30,17,0,115,30,10,23,46,28,10,35,24,30,19,35,15,30,17,1,115,30,14,21,46,28,29,19,24,30,11,46,15,30,13,6,115,30,14,23,46,28,44,7,24,30,59,1,16,30,12,7,121,30,12,26,47,28,39,14,24,30,22,41,15,30,6,14,121,30,6,34,47,28,46,10,24,30,2,64,15,30,17,4,122,30,29,14,46,28,49,10,24,30,24,46,15,30,4,18,122,30,13,32,46,28,48,14,24,30,42,32,15,30,20,4,117,30,40,7,47,28,43,22,24,30,10,67,15,30,19,6,118,30,18,31,47,28,34,34,24,30,20,61,15,30],FINAL_FORMAT:[30660,29427,32170,30877,26159,25368,27713,26998,21522,20773,24188,23371,17913,16590,20375,19104,13663,12392,16177,14854,9396,8579,11994,11245,5769,5054,7399,6608,1890,597,3340,2107],LEVELS:{L:1,M:2,Q:3,H:4}}),m=l.extend(null,{EXPONENT:[1,2,4,8,16,32,64,128,29,58,116,232,205,135,19,38,76,152,45,90,180,117,234,201,143,3,6,12,24,48,96,192,157,39,78,156,37,74,148,53,106,212,181,119,238,193,159,35,70,140,5,10,20,40,80,160,93,186,105,210,185,111,222,161,95,190,97,194,153,47,94,188,101,202,137,15,30,60,120,240,253,231,211,187,107,214,177,127,254,225,223,163,91,182,113,226,217,175,67,134,17,34,68,136,13,26,52,104,208,189,103,206,129,31,62,124,248,237,199,147,59,118,236,197,151,51,102,204,133,23,46,92,184,109,218,169,79,158,33,66,132,21,42,84,168,77,154,41,82,164,85,170,73,146,57,114,228,213,183,115,230,209,191,99,198,145,63,126,252,229,215,179,123,246,241,255,227,219,171,75,150,49,98,196,149,55,110,220,165,87,174,65,130,25,50,100,200,141,7,14,28,56,112,224,221,167,83,166,81,162,89,178,121,242,249,239,195,155,43,86,172,69,138,9,18,36,72,144,61,122,244,245,247,243,251,235,203,139,11,22,44,88,176,125,250,233,207,131,27,54,108,216,173,71,142,0],LOG:[255,0,1,25,2,50,26,198,3,223,51,238,27,104,199,75,4,100,224,14,52,141,239,129,28,193,105,248,200,8,76,113,5,138,101,47,225,36,15,33,53,147,142,218,240,18,130,69,29,181,194,125,106,39,249,185,201,154,9,120,77,228,114,166,6,191,139,98,102,221,48,253,226,152,37,179,16,145,34,136,54,208,148,206,143,150,219,189,241,210,19,92,131,56,70,64,30,66,182,163,195,72,126,110,107,58,40,84,250,133,186,61,202,94,155,159,10,21,121,43,78,212,229,172,115,243,167,87,7,112,192,247,140,128,99,13,103,74,222,237,49,197,254,24,227,165,153,119,38,184,180,124,17,68,146,217,35,32,137,46,55,63,209,91,149,188,207,205,144,135,151,178,220,252,190,97,242,86,211,171,20,42,93,158,132,60,57,83,71,109,65,162,31,45,67,216,183,123,164,118,196,23,73,236,127,12,111,246,108,161,59,82,41,157,85,170,251,96,134,177,187,204,62,90,203,89,95,176,156,169,160,81,11,245,22,235,122,117,44,215,79,174,213,233,230,231,173,232,116,214,244,234,168,80,88,175]}),_=l.extend(null,{BLOCK:[3220,1468,2713,1235,3062,1890,2119,1549,2344,2936,1117,2583,1330,2470,1667,2249,2028,3780,481,4011,142,3098,831,3445,592,2517,1776,2234,1951,2827,1070,2660,1345,3177]}),g=_,v=l.extend((function(t){var e,s,i,n,r,a=t.value.length;for(this._badness=[],this._level=p.LEVELS[t.level],this._polynomial=[],this._value=t.value,this._version=0,this._stringBuffer=[];this._version<40&&(this._version++,i=4*(this._level-1)+16*(this._version-1),n=p.BLOCKS[i++],r=p.BLOCKS[i++],e=p.BLOCKS[i++],s=p.BLOCKS[i],!(a<=(i=e*(n+r)+r-3+(this._version<=9)))););this._dataBlock=e,this._eccBlock=s,this._neccBlock1=n,this._neccBlock2=r;var o=this.width=17+4*this._version;this.buffer=v._createArray(o*o),this._ecc=v._createArray(e+(e+s)*(n+r)+r),this._mask=v._createArray((o*(o+1)+1)/2),this._insertFinders(),this._insertAlignments(),this.buffer[8+o*(o-8)]=1,this._insertTimingGap(),this._reverseMask(),this._insertTimingRowAndColumn(),this._insertVersion(),this._syncMask(),this._convertBitStream(a),this._calculatePolynomial(),this._appendEccToData(),this._interleaveBlocks(),this._pack(),this._finish()}),{_addAlignment:function(t,e){var s,i=this.buffer,n=this.width;for(i[t+n*e]=1,s=-2;s<2;s++)i[t+s+n*(e-2)]=1,i[t-2+n*(e+s+1)]=1,i[t+2+n*(e+s)]=1,i[t+s+1+n*(e+2)]=1;for(s=0;s<2;s++)this._setMask(t-1,e+s),this._setMask(t+1,e-s),this._setMask(t-s,e-1),this._setMask(t+s,e+1)},_appendData:function(t,e,s,i){var n,r,a,o=this._polynomial,l=this._stringBuffer;for(r=0;r<i;r++)l[s+r]=0;for(r=0;r<e;r++){if(255!==(n=m.LOG[l[t+r]^l[s]]))for(a=1;a<i;a++)l[s+a-1]=l[s+a]^m.EXPONENT[v._modN(n+o[i-a])];else for(a=s;a<s+i;a++)l[a]=l[a+1];l[s+i-1]=255===n?0:m.EXPONENT[v._modN(n+o[0])]}},_appendEccToData:function(){var t,e=0,s=this._dataBlock,i=this._calculateMaxLength(),n=this._eccBlock;for(t=0;t<this._neccBlock1;t++)this._appendData(e,s,i,n),e+=s,i+=n;for(t=0;t<this._neccBlock2;t++)this._appendData(e,s+1,i,n),e+=s+1,i+=n},_applyMask:function(t){var e,s,i,n,r=this.buffer,a=this.width;switch(t){case 0:for(n=0;n<a;n++)for(i=0;i<a;i++)i+n&1||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 1:for(n=0;n<a;n++)for(i=0;i<a;i++)1&n||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 2:for(n=0;n<a;n++)for(e=0,i=0;i<a;i++,e++)3===e&&(e=0),e||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 3:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),e=s,i=0;i<a;i++,e++)3===e&&(e=0),e||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 4:for(n=0;n<a;n++)for(e=0,s=n>>1&1,i=0;i<a;i++,e++)3===e&&(e=0,s=!s),s||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 5:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),e=0,i=0;i<a;i++,e++)3===e&&(e=0),(i&n&1)+!(!e|!s)||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 6:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),e=0,i=0;i<a;i++,e++)3===e&&(e=0),(i&n&1)+(e&&e===s)&1||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 7:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),e=0,i=0;i<a;i++,e++)3===e&&(e=0),(e&&e===s)+(i+n&1)&1||this._isMasked(i,n)||(r[i+n*a]^=1)}},_calculateMaxLength:function(){return this._dataBlock*(this._neccBlock1+this._neccBlock2)+this._neccBlock2},_calculatePolynomial:function(){var t,e,s=this._eccBlock,i=this._polynomial;for(i[0]=1,t=0;t<s;t++){for(i[t+1]=1,e=t;e>0;e--)i[e]=i[e]?i[e-1]^m.EXPONENT[v._modN(m.LOG[i[e]]+t)]:i[e-1];i[0]=m.EXPONENT[v._modN(m.LOG[i[0]]+t)]}for(t=0;t<=s;t++)i[t]=m.LOG[i[t]]},_checkBadness:function(){var t,e,s,i,n,r=0,a=this._badness,o=this.buffer,l=this.width;for(n=0;n<l-1;n++)for(i=0;i<l-1;i++)(o[i+l*n]&&o[i+1+l*n]&&o[i+l*(n+1)]&&o[i+1+l*(n+1)]||!(o[i+l*n]||o[i+1+l*n]||o[i+l*(n+1)]||o[i+1+l*(n+1)]))&&(r+=v.N2);var h=0;for(n=0;n<l;n++){for(s=0,a[0]=0,t=0,i=0;i<l;i++)t===(e=o[i+l*n])?a[s]++:a[++s]=1,h+=(t=e)?1:-1;r+=this._getBadness(s)}h<0&&(h=-h);var c=0,d=h;for(d+=d<<2,d<<=1;d>l*l;)d-=l*l,c++;for(r+=c*v.N4,i=0;i<l;i++){for(s=0,a[0]=0,t=0,n=0;n<l;n++)t===(e=o[i+l*n])?a[s]++:a[++s]=1,t=e;r+=this._getBadness(s)}return r},_convertBitStream:function(t){var e,s,i=this._ecc,n=this._version;for(s=0;s<t;s++)i[s]=this._value.charCodeAt(s);var r=this._stringBuffer=i.slice(),a=this._calculateMaxLength();t>=a-2&&(t=a-2,n>9&&t--);var o=t;if(n>9){for(r[o+2]=0,r[o+3]=0;o--;)e=r[o],r[o+3]|=255&e<<4,r[o+2]=e>>4;r[2]|=255&t<<4,r[1]=t>>4,r[0]=64|t>>12}else{for(r[o+1]=0,r[o+2]=0;o--;)e=r[o],r[o+2]|=255&e<<4,r[o+1]=e>>4;r[1]|=255&t<<4,r[0]=64|t>>4}for(o=t+3-(n<10);o<a;)r[o++]=236,r[o++]=17},_getBadness:function(t){var e,s=0,i=this._badness;for(e=0;e<=t;e++)i[e]>=5&&(s+=v.N1+i[e]-5);for(e=3;e<t-1;e+=2)i[e-2]===i[e+2]&&i[e+2]===i[e-1]&&i[e-1]===i[e+1]&&3*i[e-1]===i[e]&&(0===i[e-3]||e+3>t||3*i[e-3]>=4*i[e]||3*i[e+3]>=4*i[e])&&(s+=v.N3);return s},_finish:function(){var t,e;this._stringBuffer=this.buffer.slice();var s=0,i=3e4;for(e=0;e<8&&(this._applyMask(e),(t=this._checkBadness())<i&&(i=t,s=e),7!==s);e++)this.buffer=this._stringBuffer.slice();s!==e&&this._applyMask(s),i=p.FINAL_FORMAT[s+(this._level-1<<3)];var n=this.buffer,r=this.width;for(e=0;e<8;e++,i>>=1)1&i&&(n[r-1-e+8*r]=1,e<6?n[8+r*e]=1:n[8+r*(e+1)]=1);for(e=0;e<7;e++,i>>=1)1&i&&(n[8+r*(r-7+e)]=1,e?n[6-e+8*r]=1:n[7+8*r]=1)},_interleaveBlocks:function(){var t,e,s=this._dataBlock,i=this._ecc,n=this._eccBlock,r=0,a=this._calculateMaxLength(),o=this._neccBlock1,l=this._neccBlock2,h=this._stringBuffer;for(t=0;t<s;t++){for(e=0;e<o;e++)i[r++]=h[t+e*s];for(e=0;e<l;e++)i[r++]=h[o*s+t+e*(s+1)]}for(e=0;e<l;e++)i[r++]=h[o*s+t+e*(s+1)];for(t=0;t<n;t++)for(e=0;e<o+l;e++)i[r++]=h[a+t+e*n];this._stringBuffer=i},_insertAlignments:function(){var t,e,s,i=this._version,n=this.width;if(i>1)for(t=f.BLOCK[i],s=n-7;;){for(e=n-7;e>t-3&&(this._addAlignment(e,s),!(e<t));)e-=t;if(s<=t+9)break;s-=t,this._addAlignment(6,s),this._addAlignment(s,6)}},_insertFinders:function(){var t,e,s,i,n=this.buffer,r=this.width;for(t=0;t<3;t++){for(e=0,i=0,1===t&&(e=r-7),2===t&&(i=r-7),n[i+3+r*(e+3)]=1,s=0;s<6;s++)n[i+s+r*e]=1,n[i+r*(e+s+1)]=1,n[i+6+r*(e+s)]=1,n[i+s+1+r*(e+6)]=1;for(s=1;s<5;s++)this._setMask(i+s,e+1),this._setMask(i+1,e+s+1),this._setMask(i+5,e+s),this._setMask(i+s+1,e+5);for(s=2;s<4;s++)n[i+s+r*(e+2)]=1,n[i+2+r*(e+s+1)]=1,n[i+4+r*(e+s)]=1,n[i+s+1+r*(e+4)]=1}},_insertTimingGap:function(){var t,e,s=this.width;for(e=0;e<7;e++)this._setMask(7,e),this._setMask(s-8,e),this._setMask(7,e+s-7);for(t=0;t<8;t++)this._setMask(t,7),this._setMask(t+s-8,7),this._setMask(t,s-8)},_insertTimingRowAndColumn:function(){var t,e=this.buffer,s=this.width;for(t=0;t<s-14;t++)1&t?(this._setMask(8+t,6),this._setMask(6,8+t)):(e[8+t+6*s]=1,e[6+s*(8+t)]=1)},_insertVersion:function(){var t,e,s,i,n=this.buffer,r=this._version,a=this.width;if(r>6)for(t=g.BLOCK[r-7],e=17,s=0;s<6;s++)for(i=0;i<3;i++,e--)1&(e>11?r>>e-12:t>>e)?(n[5-s+a*(2-i+a-11)]=1,n[2-i+a-11+a*(5-s)]=1):(this._setMask(5-s,2-i+a-11),this._setMask(2-i+a-11,5-s))},_isMasked:function(t,e){var s=v._getMaskBit(t,e);return 1===this._mask[s]},_pack:function(){var t,e,s,i=1,n=1,r=this.width,a=r-1,o=r-1,l=(this._dataBlock+this._eccBlock)*(this._neccBlock1+this._neccBlock2)+this._neccBlock2;for(e=0;e<l;e++)for(t=this._stringBuffer[e],s=0;s<8;s++,t<<=1){128&t&&(this.buffer[a+r*o]=1);do{n?a--:(a++,i?0!==o?o--:(i=!i,6==(a-=2)&&(a--,o=9)):o!==r-1?o++:(i=!i,6==(a-=2)&&(a--,o-=8))),n=!n}while(this._isMasked(a,o))}},_reverseMask:function(){var t,e,s=this.width;for(t=0;t<9;t++)this._setMask(t,8);for(t=0;t<8;t++)this._setMask(t+s-8,8),this._setMask(8,t);for(e=0;e<7;e++)this._setMask(8,e+s-7)},_setMask:function(t,e){var s=v._getMaskBit(t,e);this._mask[s]=1},_syncMask:function(){var t,e,s=this.width;for(e=0;e<s;e++)for(t=0;t<=e;t++)this.buffer[t+s*e]&&this._setMask(t,e)}},{_createArray:function(t){var e,s=[];for(e=0;e<t;e++)s[e]=0;return s},_getMaskBit:function(t,e){var s;return t>e&&(s=t,t=e,e=s),s=e,s+=e*e,s>>=1,s+=t},_modN:function(t){for(;t>=255;)t=((t-=255)>>8)+(255&t);return t},N1:3,N2:3,N3:40,N4:10}),b=v,y=c.extend({draw:function(){this.element.src=this.qrious.toDataURL()},reset:function(){this.element.src=""},resize:function(){var t=this.element;t.width=t.height=this.qrious.size}}),S=l.extend((function(t,e,s,i){this.name=t,this.modifiable=Boolean(e),this.defaultValue=s,this._valueTransformer=i}),{transform:function(t){var e=this._valueTransformer;return"function"==typeof e?e(t,this):t}}),x=l.extend(null,{abs:function(t){return null!=t?Math.abs(t):null},hasOwn:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},noop:function(){},toUpperCase:function(t){return null!=t?t.toUpperCase():null}}),w=l.extend((function(t){this.options={},t.forEach((function(t){this.options[t.name]=t}),this)}),{exists:function(t){return null!=this.options[t]},get:function(t,e){return w._get(this.options[t],e)},getAll:function(t){var e,s=this.options,i={};for(e in s)x.hasOwn(s,e)&&(i[e]=w._get(s[e],t));return i},init:function(t,e,s){var i,n;for(i in"function"!=typeof s&&(s=x.noop),this.options)x.hasOwn(this.options,i)&&(n=this.options[i],w._set(n,n.defaultValue,e),w._createAccessor(n,e,s));this._setAll(t,e,!0)},set:function(t,e,s){return this._set(t,e,s)},setAll:function(t,e){return this._setAll(t,e)},_set:function(t,e,s,i){var n=this.options[t];if(!n)throw new Error("Invalid option: "+t);if(!n.modifiable&&!i)throw new Error("Option cannot be modified: "+t);return w._set(n,e,s)},_setAll:function(t,e,s){if(!t)return!1;var i,n=!1;for(i in t)x.hasOwn(t,i)&&this._set(i,t[i],e,s)&&(n=!0);return n}},{_createAccessor:function(t,e,s){var i={get:function(){return w._get(t,e)}};t.modifiable&&(i.set=function(i){w._set(t,i,e)&&s(i,t)}),Object.defineProperty(e,t.name,i)},_get:function(t,e){return e["_"+t.name]},_set:function(t,e,s){var i="_"+t.name,n=s[i],r=t.transform(null!=e?e:t.defaultValue);return s[i]=r,r!==n}}),T=w,E=l.extend((function(){this._services={}}),{getService:function(t){var e=this._services[t];if(!e)throw new Error("Service is not being managed with name: "+t);return e},setService:function(t,e){if(this._services[t])throw new Error("Service is already managed with name: "+t);e&&(this._services[t]=e)}}),C=new T([new S("background",!0,"white"),new S("backgroundAlpha",!0,1,x.abs),new S("element"),new S("foreground",!0,"black"),new S("foregroundAlpha",!0,1,x.abs),new S("level",!0,"L",x.toUpperCase),new S("mime",!0,"image/png"),new S("padding",!0,null,x.abs),new S("size",!0,100,x.abs),new S("value",!0,"")]),A=new E,D=l.extend((function(t){C.init(t,this,this.update.bind(this));var e=C.get("element",this),s=A.getService("element"),i=e&&s.isCanvas(e)?e:s.createCanvas(),n=e&&s.isImage(e)?e:s.createImage();this._canvasRenderer=new u(this,i,!0),this._imageRenderer=new y(this,n,n===e),this.update()}),{get:function(){return C.getAll(this)},set:function(t){C.setAll(t,this)&&this.update()},toDataURL:function(t){return this.canvas.toDataURL(t||this.mime)},update:function(){var t=new b({level:this.level,value:this.value});this._canvasRenderer.render(t),this._imageRenderer.render(t)}},{use:function(t){A.setService(t.getName(),t)}});Object.defineProperties(D.prototype,{canvas:{get:function(){return this._canvasRenderer.getElement()}},image:{get:function(){return this._imageRenderer.getElement()}}});var P=D,L=P,I=l.extend({getName:function(){}}).extend({createCanvas:function(){},createImage:function(){},getName:function(){return"element"},isCanvas:function(t){},isImage:function(t){}}).extend({createCanvas:function(){return document.createElement("canvas")},createImage:function(){return document.createElement("img")},isCanvas:function(t){return t instanceof HTMLCanvasElement},isImage:function(t){return t instanceof HTMLImageElement}});return L.use(new I),L}()),Pw.exports}var Iw=n(Lw());const Rw=t=>[t.r,t.g,t.b,1],Mw=t=>({r:t[0],g:t[1],b:t[2]});class kw extends u.Component{shouldComponentUpdate(t){const e=["ui","debug","animation.playing"],s=tw(t.observerData,e),i=tw(this.props.observerData,e);return JSON.stringify(s)!==JSON.stringify(i)}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{class:"popup-panel",flex:!0,hidden:"camera"!==t.observerData.ui.active},u.createElement(Xt,{text:"Camera",class:"popup-panel-heading"}),u.createElement(rw,{label:"Fov",precision:0,min:35,max:150,value:t.observerData.camera.fov,setProperty:e=>t.setProperty("camera.fov",e)}),u.createElement(hw,{label:"Tonemap",type:"string",options:["None","Linear","Neutral","Filmic","Hejl","ACES","ACES2"].map((t=>({v:t,t:t}))),value:t.observerData.camera.tonemapping,setProperty:e=>t.setProperty("camera.tonemapping",e)}),u.createElement(hw,{label:"Pixel Scale",value:t.observerData.camera.pixelScale,type:"number",options:[1,2,4,8,16].map((t=>({v:t,t:Number(t).toString()}))),setProperty:e=>t.setProperty("camera.pixelScale",e)}),u.createElement(iw,{label:"Multisample",value:t.observerData.camera.multisample,enabled:t.observerData.camera.multisampleSupported,setProperty:e=>t.setProperty("camera.multisample",e)}),u.createElement(iw,{label:"High Quality",value:t.observerData.camera.hq,enabled:!t.observerData.animation.playing&&!t.observerData.debug.stats,setProperty:e=>t.setProperty("camera.hq",e)})))}}class Ow extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.skyboxData)!==JSON.stringify(this.props.skyboxData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{class:"popup-panel",flex:!0,hidden:"skybox"!==t.uiData.active},u.createElement(Xt,{text:"Sky",class:"popup-panel-heading"}),u.createElement(hw,{label:"Environment",type:"string",options:JSON.parse(t.skyboxData.options),value:t.skyboxData.value,setProperty:e=>t.setProperty("skybox.value",e)}),u.createElement(rw,{label:"Exposure",value:t.skyboxData.exposure,setProperty:e=>t.setProperty("skybox.exposure",e),precision:2,min:-6,max:6,enabled:"None"!==t.skyboxData.value}),u.createElement(rw,{label:"Rotation",precision:0,min:-180,max:180,value:t.skyboxData.rotation,setProperty:e=>t.setProperty("skybox.rotation",e),enabled:"None"!==t.skyboxData.value}),u.createElement(hw,{label:"Background",type:"string",options:["Solid Color","Infinite Sphere","Projective Dome","Projective Box"].map((t=>({v:t,t:t}))),value:t.skyboxData.background,setProperty:e=>t.setProperty("skybox.background",e),enabled:"None"!==t.skyboxData.value}),u.createElement(ow,{label:"Background Color",value:Rw(t.skyboxData.backgroundColor),setProperty:e=>t.setProperty("skybox.backgroundColor",Mw(e)),enabled:"None"===t.skyboxData.value||"Solid Color"===t.skyboxData.background}),u.createElement(rw,{label:"Blur",value:t.skyboxData.blur,setProperty:e=>t.setProperty("skybox.blur",e),enabled:"None"!==t.skyboxData.value&&"Infinite Sphere"===t.skyboxData.background,min:0,max:5,precision:0,step:1}),u.createElement(aw,{label:"Scale",value:t.skyboxData.domeProjection.domeRadius,setProperty:e=>t.setProperty("skybox.domeProjection.domeRadius",e),min:0,max:1e3,enabled:"None"!==t.skyboxData.value&&-1!==["Projective Dome","Projective Box"].indexOf(t.skyboxData.background)}),u.createElement(rw,{label:"Tripod Offset",value:t.skyboxData.domeProjection.tripodOffset,setProperty:e=>t.setProperty("skybox.domeProjection.tripodOffset",e),min:0,max:1,precision:2,enabled:"None"!==t.skyboxData.value&&-1!==["Projective Dome","Projective Box"].indexOf(t.skyboxData.background)})))}}class Fw extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.lightData)!==JSON.stringify(this.props.lightData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{class:"popup-panel",flex:!0,hidden:"light"!==t.uiData.active},u.createElement(Xt,{text:"Light",class:"popup-panel-heading"}),u.createElement(iw,{label:"Enabled",value:t.lightData.enabled,setProperty:e=>t.setProperty("light.enabled",e)}),u.createElement(iw,{label:"Follow Camera",value:t.lightData.follow,setProperty:e=>t.setProperty("light.follow",e)}),u.createElement(ow,{label:"Color",value:Rw(t.lightData.color),setProperty:e=>t.setProperty("light.color",Mw(e))}),u.createElement(rw,{label:"Intensity",precision:2,min:0,max:6,value:t.lightData.intensity,setProperty:e=>t.setProperty("light.intensity",e)}),u.createElement(iw,{label:"Cast Shadow",value:t.lightData.shadow,setProperty:e=>t.setProperty("light.shadow",e)}),u.createElement(iw,{label:"Shadow Catcher",value:t.shadowCatcherData.enabled,setProperty:e=>t.setProperty("shadowCatcher.enabled",e)}),u.createElement(rw,{label:"Catcher Intensity",precision:2,min:0,max:1,value:t.shadowCatcherData.intensity,setProperty:e=>t.setProperty("shadowCatcher.intensity",e)})))}}class Nw extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.debugData)!==JSON.stringify(this.props.debugData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{class:"popup-panel",flex:!0,hidden:"debug"!==t.uiData.active},u.createElement(Xt,{text:"Debug",class:"popup-panel-heading"}),u.createElement(hw,{label:"Render Mode",type:"string",options:[{t:"Default",v:"default"},{t:"Lighting",v:"lighting"},{t:"Albedo",v:"albedo"},{t:"Emissive",v:"emission"},{t:"WorldNormal",v:"world_normal"},{t:"Metalness",v:"metalness"},{t:"Gloss",v:"gloss"},{t:"Ao",v:"ao"},{t:"Specularity",v:"specularity"},{t:"Opacity",v:"opacity"},{t:"Uv0",v:"uv0"}],value:t.debugData.renderMode,setProperty:e=>t.setProperty("debug.renderMode",e)}),u.createElement(nw,{label:"Wireframe",booleanValue:t.debugData.wireframe,setBooleanProperty:e=>t.setProperty("debug.wireframe",e),colorValue:Rw(t.debugData.wireframeColor),setColorProperty:e=>t.setProperty("debug.wireframeColor",Mw(e))}),u.createElement(iw,{label:"Grid",value:t.debugData.grid,setProperty:e=>t.setProperty("debug.grid",e)}),u.createElement(iw,{label:"Axes",value:t.debugData.axes,setProperty:e=>t.setProperty("debug.axes",e)}),u.createElement(iw,{label:"Skeleton",value:t.debugData.skeleton,setProperty:e=>t.setProperty("debug.skeleton",e)}),u.createElement(iw,{label:"Bounds",value:t.debugData.bounds,setProperty:e=>t.setProperty("debug.bounds",e)}),u.createElement(rw,{label:"Normals",precision:2,min:0,max:1,setProperty:e=>t.setProperty("debug.normals",e),value:t.debugData.normals}),u.createElement(iw,{label:"Stats",value:t.debugData.stats,setProperty:e=>t.setProperty("debug.stats",e)})))}}class Bw extends u.Component{isMobile;get shareUrl(){return`${location.origin}${location.pathname}?${this.props.sceneData.urls.map((t=>`load=${t}`)).join("&")}`}constructor(t){super(t),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(t){return JSON.stringify(t.sceneData)!==JSON.stringify(this.props.sceneData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}get hasQRCode(){return this.props.sceneData.urls.length>0&&!this.isMobile}updateQRCode(){const t=document.getElementById("share-qr");new Iw({element:t,value:this.shareUrl,size:t.getBoundingClientRect().width*window.devicePixelRatio})}componentDidMount(){this.hasQRCode&&this.updateQRCode()}componentDidUpdate(){this.hasQRCode&&this.updateQRCode()}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{id:"view-panel",class:"popup-panel",flex:!0,hidden:"view"!==t.uiData.active},this.hasQRCode?u.createElement(u.Fragment,null,u.createElement(Xt,{text:"View and share on mobile with QR code"}),u.createElement("div",{id:"qr-wrapper"},u.createElement("canvas",{id:"share-qr"})),u.createElement(Xt,{text:"View and share on mobile with URL"}),u.createElement("div",{id:"share-url-wrapper"},u.createElement(oe,{class:"secondary",value:this.shareUrl,enabled:!1}),u.createElement(at,{id:"copy-button",icon:"E126",onClick:()=>{navigator.clipboard&&window.isSecureContext&&navigator.clipboard.writeText(this.shareUrl)}}))):null,u.createElement(at,{class:"secondary",text:"TAKE A SNAPSHOT AS PNG",onClick:()=>{window.viewer&&window.viewer.downloadPngScreenshot()}})))}}const Uw=t=>u.createElement(u.Fragment,null,u.createElement(kw,{setProperty:t.setProperty,observerData:t.observerData}),u.createElement(Ow,{setProperty:t.setProperty,skyboxData:t.observerData.skybox,uiData:t.observerData.ui}),u.createElement(Fw,{setProperty:t.setProperty,lightData:t.observerData.light,uiData:t.observerData.ui,shadowCatcherData:t.observerData.shadowCatcher}),u.createElement(Nw,{setProperty:t.setProperty,debugData:t.observerData.debug,uiData:t.observerData.ui}),u.createElement(Bw,{setProperty:t.setProperty,sceneData:t.observerData.scene,uiData:t.observerData.ui,runtimeData:t.observerData.runtime}));class zw extends u.Component{popupPanelElement;render(){let t;const e=e=>{this.props.setProperty("ui.active",this.props.observerData.ui.active===e?null:e),this.popupPanelElement||(this.popupPanelElement=document.getElementById("popup")),setTimeout((()=>{t&&t();t=Jx(document.body,(e=>{this.popupPanelElement.contains(e.target)||(this.props.setProperty("ui.active",null),t(),t=null)}),4)}))},s=t=>this.props.observerData.ui.active===t?["popup-button","selected"]:["popup-button"];return u.createElement("div",{id:"popup-buttons-parent"},u.createElement(Aw,{animationData:this.props.observerData.animation,setProperty:this.props.setProperty}),u.createElement(at,{class:s("camera"),icon:"E212",width:40,height:40,onClick:()=>e("camera")}),u.createElement(at,{class:s("skybox"),icon:"E200",width:40,height:40,onClick:()=>e("skybox")}),u.createElement(at,{class:s("light"),icon:"E194",width:40,height:40,onClick:()=>e("light")}),u.createElement(at,{class:s("debug"),icon:"E134",width:40,height:40,onClick:()=>e("debug")}),u.createElement(at,{class:s("view"),icon:"E301",width:40,height:40,onClick:()=>e("view")}))}}class Vw extends u.Component{link;usdzExporter;get hasArSupport(){return this.props.observerData.runtime.xrSupported||this.usdzExporter}constructor(t){super(t),this.link=document.getElementById("ar-link"),(this.link.relList.supports("ar")||Boolean(window.webkit?.messageHandlers)&&Boolean(/CriOS\/|EdgiOS\/|FxiOS\/|GSA\/|DuckDuckGo\//.test(navigator.userAgent)))&&(this.usdzExporter=new JS)}render(){return u.createElement("div",{id:"popup",className:"[]"===this.props.observerData.scene.nodes?"empty":null},u.createElement(Uw,{observerData:this.props.observerData,setProperty:this.props.setProperty}),u.createElement(zw,{observerData:this.props.observerData,setProperty:this.props.setProperty}),u.createElement(at,{class:"popup-button",id:"launch-ar-button",icon:"E189",hidden:!this.hasArSupport||"[]"===this.props.observerData.scene.nodes,width:40,height:40,onClick:()=>{if(this.usdzExporter){const t=window.viewer.app.root.findByName("sceneRoot");this.usdzExporter.build(t).then((t=>{const e=new Blob([t],{type:"application/octet-stream"});this.link.href=URL.createObjectURL(e),this.link.click()})).catch(console.error)}else window.viewer&&window.viewer.xrMode.start()}}),u.createElement("div",{id:"floating-top-parent"},u.createElement(at,{class:"popup-button",id:"fullscreen-button",icon:"E127",width:40,height:40,onClick:()=>{document.getElementById("panel-left").classList.toggle("collapsed")}})),u.createElement("div",{id:"floating-bottom-parent"},u.createElement(at,{class:["popup-button","camera-mode-button",this.props.observerData.camera.mode],id:"camera-mode-button",width:40,height:40,onClick:()=>{const t="orbit"===this.props.observerData.camera.mode?"fly":"orbit";this.props.setProperty("camera.mode",t)}})))}}class Hw extends u.Component{shouldComponentUpdate(t){return t.sceneData.nodes!==this.props.sceneData.nodes||t.sceneData.selectedNode.path!==this.props.sceneData.selectedNode.path||t.sceneData.selectedNode.name!==this.props.sceneData.selectedNode.name||t.sceneData.selectedNode.position!==this.props.sceneData.selectedNode.position||t.sceneData.selectedNode.rotation!==this.props.sceneData.selectedNode.rotation||t.sceneData.selectedNode.scale!==this.props.sceneData.selectedNode.scale}render(){const t=this.props.sceneData,e="[]"!==t.nodes,s=t.selectedNode.path;return e&&s?u.createElement("div",{className:"selected-node-panel-parent"},u.createElement(vt,{class:"selected-node-panel",flex:!0},u.createElement(ew,{label:"Name",value:t.selectedNode.name}),u.createElement(sw,{label:"Position",dimensions:3,value:t.selectedNode.position,enabled:!1}),u.createElement(sw,{label:"Rotation",dimensions:3,value:t.selectedNode.rotation,enabled:!1}),u.createElement(sw,{label:"Scale",dimensions:3,value:t.selectedNode.scale,enabled:!1}))):null}}let Gw=class extends u.Component{state=null;canvasRef;constructor(t){super(t),this.canvasRef=u.createRef(),this.state=this._retrieveState(),t.observer.on("*:set",(()=>{this.setState(this._retrieveState())}))}_retrieveState=()=>{const t={};return this.props.observer._keys.forEach((e=>{t[e]=this.props.observer.get(e)})),t};_setStateProperty=(t,e)=>{this.props.observer.set(t,e)};render(){return u.createElement("div",{id:"application-container"},u.createElement(vt,{id:"panel-left",class:"collapsed",flex:!0,resizable:"right",resizeMin:220,resizeMax:800},u.createElement("div",{className:"header",style:{display:"none"}},u.createElement("div",{id:"title"},u.createElement("img",{src:"static/playcanvas-logo.png"}),u.createElement("div",null,`MODEL VIEWER v${ww}`))),u.createElement("div",{id:"panel-toggle"},u.createElement("img",{src:"static/playcanvas-logo.png"})),u.createElement(xw,{observerData:this.state,setProperty:this._setStateProperty})),u.createElement("div",{id:"canvas-wrapper"},u.createElement("canvas",{id:"application-canvas",ref:this.canvasRef}),u.createElement(Tw,{setProperty:this._setStateProperty}),u.createElement(Hw,{sceneData:this.state.scene}),u.createElement(Vw,{observerData:this.state,setProperty:this._setStateProperty}),u.createElement(Zx,{observerData:this.state}),u.createElement(ae,{id:"spinner",size:30,hidden:!0})))}};class Ww extends Bm{constructor(t,e){super(t);const s=new zm;s.graphicsDevice=e.graphicsDevice,this.addComponentSystems(s),this.addResourceHandles(s),s.elementInput=e.elementInput,s.keyboard=e.keyboard,s.mouse=e.mouse,s.touch=e.touch,s.gamepads=e.gamepads,s.scriptPrefix=e.scriptPrefix,s.assetPrefix=e.assetPrefix,s.scriptsOrder=e.scriptsOrder,s.lightmapper=Jm,s.xr=Fy,this.init(s)}addComponentSystems(t){t.componentSystems=[W_,ng,Dg,Rg,Jg,qg]}addResourceHandles(t){t.resourceHandlers=[nv,tb,eb,jb,ab,sb,rb,yb]}}const jw=new rs,Xw=new rs,$w=new sx,qw=new nx({move:[0,0,0],rotate:[0,0,0]}),Kw=(t,e,s)=>{const i=Math.sqrt(t[0]*t[0]+t[1]*t[1]);if(i<e)return void t.fill(0);const n=(i-e)/(s-e);t[0]*=n/i,t[1]*=n/i},Yw=(t,e,s,i,n=new rs)=>{const{system:r,fov:a,aspectRatio:o,horizontalFov:l,projection:h,orthoHeight:c}=t,{width:d,height:u}=r.app.graphicsDevice.clientRect;n.set(-e/d*2,s/u*2,0);const f=Xw.set(0,0,0);if(0===h){const t=i*Math.tan(.5*a*Qe.DEG_TO_RAD);l?f.set(t,t/o,0):f.set(t*o,t,0)}else f.set(c*o,c,0);return n.mul(f),n};class CameraControls{_app;_camera;_observer;_zoomRange=new os;_desktopInput=new bx;_orbitMobileInput=new px;_flyMobileInput=new ux;_gamepadInput=new xx;_flyController=new Lx;_orbitController=new Ox;_controller;_pose=new sx;_mode;_state={axis:new rs,mouse:[0,0,0],shift:0,ctrl:0,touches:0};moveSpeed=1;orbitSpeed=18;pinchSpeed=.4;wheelSpeed=.06;gamepadDeadZone=new os(.3,.6);constructor(t,e,s){this._app=t,this._camera=e,this._observer=s,this._orbitController.zoomRange=new os(0,1/0),this._orbitController.pitchRange=new os(-90,90),this._orbitController.rotateDamping=.97,this._orbitController.moveDamping=.97,this._orbitController.zoomDamping=.97,this._flyController.pitchRange=new os(-90,90),this._flyController.rotateDamping=.97,this._flyController.moveDamping=.97,this._desktopInput.attach(this._app.graphicsDevice.canvas),this._orbitMobileInput.attach(this._app.graphicsDevice.canvas),this._flyMobileInput.attach(this._app.graphicsDevice.canvas),this._gamepadInput.attach(this._app.graphicsDevice.canvas),this._pose.look(this._camera.entity.getPosition(),rs.ZERO),this.mode="orbit"}set zoomRange(t){this._zoomRange.x=t.x,this._zoomRange.y=t.y<=t.x?1/0:t.y,this._orbitController.zoomRange=this._zoomRange}get zoomRange(){return this._zoomRange}set mode(t){if(this._mode!==t){switch(this._mode=t,this._controller&&this._controller.detach(),this._mode){case"orbit":this._controller=this._orbitController;break;case"fly":this._controller=this._flyController}this._controller.attach(this._pose,!1),this._observer.set("camera.mode",this._mode)}}get mode(){return this._mode}reset(t,e){this.mode="orbit",this._controller.attach($w.look(e,t))}update(t){const{keyCode:e}=bx,{key:s,button:i,mouse:n,wheel:r}=this._desktopInput.read(),{touch:a,pinch:o,count:l}=this._orbitMobileInput.read(),{leftInput:h,rightInput:c}=this._flyMobileInput.read(),{leftStick:d,rightStick:u}=this._gamepadInput.read();Kw(d,this.gamepadDeadZone.x,this.gamepadDeadZone.y),Kw(u,this.gamepadDeadZone.x,this.gamepadDeadZone.y),this._state.axis.add(jw.set(s[e.D]-s[e.A]+(s[e.RIGHT]-s[e.LEFT]),s[e.E]-s[e.Q],s[e.W]-s[e.S]+(s[e.UP]-s[e.DOWN])));for(let t=0;t<this._state.mouse.length;t++)this._state.mouse[t]+=i[t];this._state.shift+=s[e.SHIFT],this._state.ctrl+=s[e.CTRL],this._state.touches+=l[0],"fly"!==this._mode&&this._state.axis.length()>0&&(this.mode="fly");const f=+("orbit"===this._mode),p=+("fly"===this._mode),m=+(this._state.touches>1),_=this._state.mouse[2]||+(-1===i[2])||m,g=this._pose.distance,{deltas:v}=qw,b=jw.set(0,0,0),y=this._state.axis.clone().normalize();b.add(y.mulScalar(p*this.moveSpeed*(this._state.shift?2:this._state.ctrl?.5:1)*t));const S=Yw(this._camera,n[0],n[1],g);b.add(S.mulScalar(_));const x=new rs(0,0,-r[0]);b.add(x.mulScalar(this.wheelSpeed*t)),v.move.append([b.x,b.y,f?-b.z:b.z]),b.set(0,0,0);const w=new rs(n[0],n[1],0);b.add(w.mulScalar((1-_)*this.orbitSpeed*t)),v.rotate.append([b.x,b.y,b.z]),b.set(0,0,0);const T=Yw(this._camera,a[0],a[1],g);b.add(T.mulScalar(f*_));const E=new rs(h[0],0,-h[1]);b.add(E.mulScalar(p*this.moveSpeed*t));const C=new rs(0,0,o[0]);b.add(C.mulScalar(f*m*this.pinchSpeed*t)),v.move.append([b.x,b.y,b.z]),b.set(0,0,0);const A=new rs(a[0],a[1],0);b.add(A.mulScalar(f*(1-_)*this.orbitSpeed*t));const D=new rs(c[0],c[1],0);b.add(D.mulScalar(p*this.orbitSpeed*t)),v.rotate.append([b.x,b.y,b.z]),b.set(0,0,0);const P=new rs(d[0],0,-d[1]);b.add(P.mulScalar(this.moveSpeed*t)),v.move.append([b.x,b.y,b.z]),b.set(0,0,0);const L=new rs(u[0],u[1],0);b.add(L.mulScalar(this.orbitSpeed*t)),v.rotate.append([b.x,b.y,b.z]),this._app.xr?.active?qw.read():(this._pose.copy(this._controller.update(qw,t)),this._camera.entity.setPosition(this._pose.position),this._camera.entity.setEulerAngles(this._pose.angles))}destroy(){this._desktopInput.destroy(),this._orbitMobileInput.destroy(),this._flyMobileInput.destroy(),this._gamepadInput.destroy(),this._flyController.destroy(),this._orbitController.destroy()}}let Qw=null,Zw=null;const Jw=new rs,tT=new rs,eT=new rs,sT=new rs(0,1,0),iT=new ps,nT=[[[0,0,0],[-.5,0,.3]],[[0,0,0],[.5,0,.3]],[[0,0,0],[0,-.5,.3]],[[0,0,0],[0,.5,.3]],[[0,0,1],[-.5,0,.3]],[[0,0,1],[.5,0,.3]],[[0,0,1],[0,-.5,.3]],[[0,0,1],[0,.5,.3]],[[0,-.5,.3],[.5,0,.3]],[[.5,0,.3],[0,.5,.3]],[[0,.5,.3],[-.5,0,.3]],[[-.5,0,.3],[0,-.5,.3]]];class rT{app;mesh;meshInstances;vertexFormat;vertexCursor;vertexData;colorData;depthState=new Tn;constructor(t,e,s=!0){const i=t.graphicsDevice;if(!Qw){Zw=new wu({enabled:!0,name:"Debug Layer Behind",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0}),Qw=new wu({enabled:!0,name:"Debug Layer",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0});const s=t.scene.layers,i=s.getLayerByName("World"),n=s.getTransparentIndex(i);s.insert(Zw,n),s.insert(Qw,n+1),e.camera.layers=e.camera.layers.concat([Zw.id,Qw.id])}const n=new Nn(i,[{semantic:$s,components:3,type:6},{semantic:Zs,components:4,type:1,normalize:!0}]),r=new Wh(i);r.vertexBuffer=new In(i,n,8192,{usage:1}),r.primitive[0].type=1,r.primitive[0].base=0,r.primitive[0].indexed=!1,r.primitive[0].count=0;const a={uniqueName:"debug-lines",attributes:{vertex_position:$s,vertex_color:Zs},vertexGLSL:"\nattribute vec3 vertex_position;\nattribute vec4 vertex_color;\n\nvarying vec2 zw;\nvarying vec4 vColor;\n\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvoid main(void) {\n    vColor = vertex_color;\n\n    gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);\n\n    // store z/w for later use in fragment shader\n    zw = gl_Position.zw;\n\n    // disable depth clipping\n    gl_Position.z = 0.0;\n}",fragmentGLSL:"\nprecision highp float;\n\nvarying vec2 zw;\nvarying vec4 vColor;\nuniform vec4 uColor;\n\nvoid main(void) {\n    gl_FragColor = vColor * uColor;\n\n    // clamp depth in Z to [0, 1] range\n    gl_FragDepth = max(0.0, min(1.0, (zw.x / zw.y + 1.0) * 0.5));\n}",vertexWGSL:"\nattribute vertex_position: vec3f;\nattribute vertex_color: vec4f;\n\nvarying zw: vec2f;\nvarying vColor: vec4f;\n\nuniform matrix_model: mat4x4f;\nuniform matrix_viewProjection: mat4x4f;\n\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n    var output: VertexOutput;\n\n    output.vColor = vertex_color;\n    output.position = uniform.matrix_viewProjection * uniform.matrix_model * vec4(vertex_position, 1.0);\n\n    // store z/w for later use in fragment shader\n    output.zw = output.position.zw;\n\n    // disable depth clipping\n    output.position.z = 0.0;\n\n    return output;\n}\n",fragmentWGSL:"\nvarying zw: vec2f;\nvarying vColor: vec4f;\n\nuniform uColor: vec4f;\n\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n    var output: FragmentOutput;\n\n    output.color = input.vColor * uniform.uColor;\n\n    // clamp depth in Z to [0, 1] range\n    output.fragDepth = max(0.0, min(1.0, (zw.x / zw.y + 1.0) * 0.5));\n\n    return output;\n}\n"},o=new Gu(a);o.setParameter("uColor",[1,1,1,.7]),o.blendType=2,o.update();const l=new nc(r,o,new Mc);if(l.cull=!1,l.visible=!1,Qw.addMeshInstances([l],!0),this.meshInstances=[l],s){const t=new Gu(a);t.setParameter("uColor",[.5,.5,.5,.5]),t.blendType=2,t.depthState.func=4,t.depthState.write=!1,t.update();const e=new nc(r,t,new Mc);e.cull=!1,e.visible=!1,Zw.addMeshInstances([e],!0),this.meshInstances.push(e)}this.app=t,this.mesh=r,this.vertexFormat=n,this.vertexCursor=0,this.vertexData=new Float32Array(this.mesh.vertexBuffer.lock()),this.colorData=new Uint32Array(this.mesh.vertexBuffer.lock())}static matrixMad(t,e,s){if(s>0)for(let i=0;i<16;++i)t.data[i]+=e.data[i]*s}clear(){this.vertexCursor=0}box(t,e){this.line(new rs(t.x,t.y,t.z),new rs(e.x,t.y,t.z)),this.line(new rs(e.x,t.y,t.z),new rs(e.x,t.y,e.z)),this.line(new rs(e.x,t.y,e.z),new rs(t.x,t.y,e.z)),this.line(new rs(t.x,t.y,e.z),new rs(t.x,t.y,t.z)),this.line(new rs(t.x,e.y,t.z),new rs(e.x,e.y,t.z)),this.line(new rs(e.x,e.y,t.z),new rs(e.x,e.y,e.z)),this.line(new rs(e.x,e.y,e.z),new rs(t.x,e.y,e.z)),this.line(new rs(t.x,e.y,e.z),new rs(t.x,e.y,t.z)),this.line(new rs(t.x,t.y,t.z),new rs(t.x,e.y,t.z)),this.line(new rs(e.x,t.y,t.z),new rs(e.x,e.y,t.z)),this.line(new rs(e.x,t.y,e.z),new rs(e.x,e.y,e.z)),this.line(new rs(t.x,t.y,e.z),new rs(t.x,e.y,e.z))}line(t,e,s=4294967295){if(this.vertexCursor>=this.vertexData.length/8){const t=this.mesh.vertexBuffer,e=2*t.lock().byteLength,s=new ArrayBuffer(e);this.mesh.vertexBuffer=new In(this.app.graphicsDevice,t.getFormat(),2*t.getNumVertices(),{usage:1,data:s}),this.vertexData=new Float32Array(s),this.colorData=new Uint32Array(s),this.colorData.set(new Uint32Array(t.lock()))}const i=this.vertexCursor,n=this.vertexData,r=this.colorData;n[8*i+0]=t.x,n[8*i+1]=t.y,n[8*i+2]=t.z,r[8*i+3]=s,n[8*i+4]=e.x,n[8*i+5]=e.y,n[8*i+6]=e.z,r[8*i+7]=s,this.vertexCursor++}generateNormals(t,e,s,i){const n=new Vo(t),r=n.element[$s],a=n.element[qs],o=n.element[Qs],l=n.element[Ys];if(!r||!a)return;const h=t.getNumVertices(),c=new rs,d=new rs,u=new ps;for(let t=0;t<h;++t){if(c.set(r.get(0),r.get(1),r.get(2)),d.set(a.get(0),a.get(1),a.get(2)),o&&l&&i){u.copy(ps.ZERO);for(let t=0;t<4;++t)rT.matrixMad(u,i[o.get(t)],l.get(t));u.mul2(e,u),u.transformPoint(c,c),u.transformVector(d,d)}else e.transformPoint(c,c),e.transformVector(d,d);d.normalize().mulScalar(s).add(c),this.line(c,d),n.next()}}bone(t,e,s=4294967295){iT.setLookAt(t,e,sT),Jw.sub2(e,t);const i=Jw.length(),n=(t,e)=>{Jw.set(e[0]*i*.3,e[1]*i*.3,e[2]*-i),iT.transformPoint(Jw,t)};nT.forEach((t=>{n(tT,t[0]),n(eT,t[1]),this.line(tT,eT,s)}))}axis(t,e=1){t.getTranslation(Jw),t.getScale(eT),eT.set(e/eT.x,e/eT.y,e/eT.z),t.getX(tT).mul(eT).add(Jw),this.line(Jw,tT,4278190335),t.getY(tT).mul(eT).add(Jw),this.line(Jw,tT,4278255360),t.getZ(tT).mul(eT).add(Jw),this.line(Jw,tT,4294901760)}generateSkeleton(t,e,s,i){const n=(r,a)=>{if(r.enabled){a||=r===i;for(let t=0;t<r.children.length;++t){const s=r.children[t];e&&this.bone(r.getPosition(),s.getPosition(),a?4294967040:4294967295),n(s,a)}if(s){const e=t.parent;e&&(Jw.sub2(r.getPosition(),e.getPosition()),this.axis(r.getWorldTransform(),.05*Jw.length()))}}};n(t,!1)}update(){0===this.vertexCursor?this.meshInstances.forEach((t=>{t.visible=!1})):(this.meshInstances.forEach((t=>{t.visible=!0})),this.mesh.vertexBuffer.unlock(),this.mesh.primitive[0].count=2*this.vertexCursor,this.vertexCursor=0)}}const aT=t=>{const e=[],s=[];return t.forEach((t=>{t.isFile?s.push(t):t.isDirectory&&e.push(new Promise((e=>{const s=t.createReader(),i=[],n=()=>{s.readEntries((t=>{t.length>0?(i.push(aT(t)),n()):Promise.all(i).then((t=>{e(t.flat())}))}))};n()})))})),Promise.all(e).then((t=>s.concat(...t)))},oT=(t,e)=>{t.addEventListener("dragstart",(t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.effectAllowed="all"}),!1),t.addEventListener("dragover",(t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.effectAllowed="all"}),!1),t.addEventListener("drop",(t=>{t.preventDefault();const s=Array.from(t.dataTransfer.items).map((t=>t.webkitGetAsEntry()));aT(s).then((t=>Promise.all(t.map((t=>new Promise((e=>{t.file((s=>{e({url:URL.createObjectURL(s),filename:t.fullPath.substring(1)})}))}))))))).then((s=>{s.length>1&&(t=>{const e=t=>{const e=t.split(ke.delimiter);return[e[0],e.slice(1).join(ke.delimiter)]};for(;;){const s=e(t[0].filename);if(0===s[1].length)return;for(let i=1;i<t.length;++i){const n=e(t[i].filename);if(s[0]!==n[0])return}for(let s=0;s<t.length;++s)t[s].filename=e(t[s].filename)[1]}})(s),e(s,!t.shiftKey)}))}),!1)},lT=t=>(t=>t.textureHalfFloatRenderable)(t)?Ps:(t=>t.textureFloatRenderable)(t)?Ls:7,hT=(t,e)=>1/(Math.sqrt(2*Math.PI)*e)*Math.exp(-t*t/(2*e*e)),cT=new Sn(!0,0,11,12),dT=new Sn(!1);class uT extends Mf{events=new Ve;execute(){this.events.fire("execute"),super.execute()}}const fT=(t,e)=>{for(const s in e)t.resolve(s).setValue(e[s])};class pT{device;camera;textureBias;shader=null;accumTexture=null;accumRenderTarget=null;updateRenderPass;finalRenderPass;sampleArray=[];sampleId=0;sampleAccum=0;enabled=!0;blend=1;constructor(t,e,s){this.device=t,this.camera=e,this.samples=s||pT.generateSamples(5,!1,2,0);this.camera.system.app.scene.on(fh,(e=>{if(e!==this.camera)return;const s=this.camera.camera,i=s.projectionMatrix;if(this.enabled&&this.accumTexture){const e=this.sampleArray[this.sampleId];i.data[8]=e.x/this.accumTexture.width,i.data[9]=e.y/this.accumTexture.height,fT(t.scope,{textureBias:0===this.sampleId?0:this.textureBias})}else i.data[8]=0,i.data[9]=0,fT(t.scope,{textureBias:0});s._viewProjMatDirty=!0})),this.camera.system.app.scene.on(ph,(t=>{if(t!==this.camera)return;const s=e.projectionMatrix;s.data[8]=0,s.data[9]=0})),this.shader=Ph.createShader(t,{uniqueName:"multiframe-shader",attributes:{vertex_position:$s},vertexGLSL:"\n    attribute vec2 vertex_position;\n    varying vec2 texcoord;\n    uniform vec4 texcoordMod;\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.5, 1.0);\n        texcoord = (vertex_position.xy * 0.5 + 0.5) * texcoordMod.xy + texcoordMod.zw;\n    }\n",fragmentGLSL:"\n    varying vec2 texcoord;\n    uniform sampler2D multiframeTex;\n    uniform float power;\n    void main(void) {\n        vec4 t = texture2D(multiframeTex, texcoord);\n        gl_FragColor = pow(t, vec4(power));\n    }\n",vertexWGSL:"\n    attribute vertex_position: vec2f;\n\n    varying texcoord: vec2f;\n\n    uniform texcoordMod: vec4f;\n\n    @vertex\n    fn vertexMain(input: VertexInput) -> VertexOutput {\n        var output: VertexOutput;\n\n        output.position = vec4f(vertex_position, 0.5, 1.0);\n        output.texcoord = (vertex_position.xy * 0.5 + 0.5) * uniform.texcoordMod.xy + uniform.texcoordMod.zw;\n\n        return output;\n    }\n",fragmentWGSL:"\n    varying texcoord: vec2f;\n\n    var multiframeTex: texture_2d<f32>;\n    var multiframeSampler: sampler;\n\n    uniform power: f32;\n\n    @fragment\n    fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n\n        let t: vec4f = textureSample(multiframeTex, multiframeSampler, input.texcoord);\n        output.color = pow(t, vec4f(uniform.power));\n\n        return output;\n    }\n"}),this.accumTexture=new dn(t,{name:"multiframe-texture",width:t.width,height:t.height,format:lT(t),mipmaps:!1,minFilter:0,magFilter:0}),this.accumRenderTarget=new Hn({name:"multiframe-target",colorBuffer:this.accumTexture,depth:!1}),this.updateRenderPass=new uT(t),this.updateRenderPass.init(this.accumRenderTarget,{}),this.updateRenderPass.shader=this.shader,this.updateRenderPass.blendState=cT,this.updateRenderPass.events.on("execute",(()=>{const e=this.sampleArray[this.sampleId++].z,s=e/(this.sampleAccum+e);this.sampleAccum+=e,t.setBlendColor(s,s,s,s),fT(t.scope,{texcoordMod:[1,1,0,0],multiframeTex:this.sourceTex,power:2.2})})),this.finalRenderPass=new uT(t),this.finalRenderPass.init(null,{}),this.finalRenderPass.shader=this.shader,this.finalRenderPass.events.on("execute",(()=>{const e=this.enabled&&this.sampleId>0;1!==this.blend?(t.setBlendColor(this.blend,this.blend,this.blend,this.blend),this.finalRenderPass.blendState=cT):this.finalRenderPass.blendState=dT,fT(t.scope,{texcoordMod:!e&&t.isWebGPU?[1,-1,0,1]:[1,1,0,0],multiframeTex:e?this.accumTexture:this.sourceTex,power:e?1/2.2:1})}));const i=()=>{this.destroy()};t.once("destroy",i),t.on("devicelost",i)}get sourceTex(){return this.camera.renderTarget.colorBuffer}set samples(t){this.sampleArray=t,this.textureBias=-Math.log2(Math.sqrt(t.length)),this.sampleId=0}get samples(){return this.sampleArray}static generateSamples(t,e=!1,s=1,i=0){const n=[],r=Math.ceil(3*i)+1,a=.5*s;let o,l,h,c=0;for(let s=0;s<t;++s)for(let d=0;d<t;++d)e?(o=(s+Math.random())/t*2-1,l=(d+Math.random())/t*2-1):(o=s/(t-1)*2-1,l=d/(t-1)*2-1),h=i<=0?1:hT(o*r,i)*hT(l*r,i),c+=h,n.push(new rs(o*a,l*a,h));return n.forEach((t=>{t.z/=c})),n.sort(((t,e)=>{const s=t.length(),i=e.length();return s<i?-1:i<s?1:0})),n}destroy(){this.accumRenderTarget&&(this.accumRenderTarget.destroy(),this.accumRenderTarget=null),this.accumTexture&&(this.accumTexture.destroy(),this.accumTexture=null)}moved(){this.sampleId=0,this.sampleAccum=0}update(){if(!this.enabled)return this.finalRenderPass.render(),!1;const t=this.sampleArray.length,{sourceTex:e}=this;return this.accumRenderTarget.resize(e.width,e.height),this.enabled&&this.sampleId<t&&this.updateRenderPass.render(),this.finalRenderPass.render(),this.sampleId<t}}const mT=new Float32Array(1),_T=new Uint8Array(mT.buffer),gT=new ls(2,2,2,1),vT=new ls(1,1,1,0);class bT{app;camera;picker;constructor(t,e){this.app=t,this.camera=e,this.picker=null}async pick(t,e){const{app:s,camera:i}=this,{graphicsDevice:n}=s,{canvas:r}=n,a=r.clientWidth,o=r.clientHeight;e=n.isWebGL2?o-e-1:e,this.picker||(this.picker=new Hy(this.app,a,o));const{picker:l}=this;l.resize(a,o),l.prepare(i.camera,s.scene,[s.scene.layers.getLayerByName("World")]);const h=await l.renderTarget.colorBuffer.read(t,e,1,1,{renderTarget:l.renderTarget,immediate:!0});for(let t=0;t<4;++t)_T[t]=h[t];const c=mT[0];if(!isFinite(c))return null;const d=new ls(t/a,e/o,c,1).mul(gT).sub(vT);n.isWebGL2||(d.y*=-1),i.camera.projectionMatrix.clone().invert().transformVec4(d,d),d.mulScalar(1/d.w);const u=new rs(d.x,d.y,d.z);return i.getWorldTransform().transformPoint(u,u),u}}class yT{static WORKER_STR=function(t){(async()=>{const e=await new Promise((e=>{self.importScripts(`${t}static/lib/lodepng/lodepng.js`),e(self.lodepng({locateFile:()=>`${t}static/lib/lodepng/lodepng.wasm`}))}));self.onmessage=t=>{const s=t.data,i=((t,e,s,i)=>{const n=t._malloc(4),r=t._malloc(4),a=t._malloc(s*i*4);for(let n=0;n<i;++n){let r=n*s,o=a/4+(i-1-n)*s;for(let i=0;i<s;++i)t.HEAPU32[o++]=e[r++]}t._lodepng_encode32(n,r,a,s,i);const o=t.HEAPU8.slice(t.HEAPU32[n/4],t.HEAPU32[n/4]+t.HEAPU32[r/4]);return t._free(n),t._free(r),t._free(a),o})(e,s.words,s.width,s.height);self.postMessage({result:i},void 0,[i.buffer])}})()}.toString();worker;receiveCallback;constructor(){let t=null;const e=new Blob([`(${yT.WORKER_STR})('${window.location.href.split("?")[0]}')\n\n`],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(e)),this.worker.addEventListener("message",(e=>{t(e)})),this.receiveCallback=e=>{t=s=>{e(s.data.result),t=null}}}_downloadFile(t,e){const s=new Blob([e],{type:"octet/stream"}),i=window.URL.createObjectURL(s),n=document.createElement("a");n.download=t,n.href=i,n.click(),window.URL.revokeObjectURL(i)}async export(t,e,s,i){this.worker.postMessage({words:e,width:s,height:i},[e.buffer]),this._downloadFile(t,await new Promise(this.receiveCallback))}}class ST{layer;material;plane;light;sceneRoot;camera;constructor(t,e,s,i){this.layer=new wu({name:"Shadow Layer"});const n=t.scene.layers,r=n.getLayerByName("World"),a=n.getTransparentIndex(r);n.insert(this.layer,a+1),this.material=new Jf,this.material.blendType=4,this.material.shadowCatcher=!0,this.material.useSkybox=!1,this.material.depthWrite=!1,this.material.diffuse.set(0,0,0),this.material.specular.set(0,0,0),this.material.shaderChunks.glsl.set("litUserMainEndPS","\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0 - gl_FragColor.r);\n"),this.material.shaderChunks.wgsl.set("litUserMainEndPS","\n    output.color = vec4f(0.0, 0.0, 0.0, 1.0 - output.color.r);\n"),this.material.update(),this.plane=new Im("ShadowPlane"),this.plane.addComponent("render",{type:"plane",castShadows:!1,material:this.material}),this.light=new Im("ShadowLight"),this.light.addComponent("light",{type:"directional",castShadows:!0,normalOffsetBias:0,shadowBias:0,shadowResolution:1024,shadowType:2,shadowUpdateMode:2,vsmBlurSize:64,enabled:!0,shadowIntensity:.4}),s.addChild(this.plane),s.addChild(this.light),this.plane.render.layers=[this.layer.id],this.light.light.layers=[this.layer.id],e.layers=e.layers.concat([this.layer.id]),this.sceneRoot=i,this.camera=e}onEntityAdded(t){t.findComponents("render").forEach((t=>{this.layer.shadowCasters=this.layer.shadowCasters.concat(t.meshInstances)}))}onEntityRemoved(t){t.findComponents("render").forEach((t=>{this.layer.shadowCasters=this.layer.shadowCasters.filter((e=>-1===t.meshInstances.indexOf(e)))}))}onUpdate(t){const e=t,s=e.center,i=Math.sqrt(e.halfExtents.x*e.halfExtents.x+e.halfExtents.z*e.halfExtents.z);this.plane.setLocalScale(4*i,1,4*i),this.plane.setPosition(s.x,e.getMin().y,s.z),this.light.light.shadowDistance=this.camera.camera._farClip}set enabled(t){this.layer.enabled=t,this.light.enabled=t}get enabled(){return this.layer.enabled}set intensity(t){this.light.light.shadowIntensity=t}get intensity(){return this.light.light.shadowIntensity}}var xT=new Image;xT.src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:svg='http://www.w3.org/2000/svg' width='1010' height='1000' version='1.1' style='background-color:rgba(32%2c32%2c32%2c.4)'%3e%3cg class='layer'%3e%3cpath id='svg_1' fill='white' d='m363%2c300l126%2c126l-58%2c58l-126%2c-126l-126%2c126l-58%2c-58l126%2c-126l-126%2c-126l58%2c-58l126%2c126l126%2c-126l58%2c58l-126%2c126z' transform='translate(205%2c 200)'/%3e%3c/g%3e%3c/svg%3e";var wT=new Image;wT.src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:svg='http://www.w3.org/2000/svg' width='1010' height='1000' version='1.1' style='background-color:rgba(32%2c32%2c32%2c.4)'%3e%3cg class='layer'%3e%3cpath id='svg_1' fill='white' d='m402.87%2c60.55l-15.2%2c28.51l-83.62%2c-47.51l-81.72%2c47.51l-15.2%2c-28.51l96.92%2c-58.91l98.82%2c58.91zm-239.45%2c62.71l-64.61%2c38.01l58.91%2c34.21l-19%2c26.61l-57.01%2c-30.41l0%2c72.21l-34.21%2c0l0%2c-110.22l98.82%2c-58.91l17.1%2c28.51zm399.08%2c140.63l-34.21%2c0l0%2c-72.21l-55.11%2c30.41l-19%2c-26.61l58.91%2c-34.21l-66.51%2c-38.01l17.1%2c-28.51l98.82%2c58.91l0%2c110.22zm-271.75%2c43.71l-72.21%2c-41.81l13.3%2c-26.61l74.11%2c41.81l74.11%2c-41.81l15.2%2c26.61l-72.21%2c41.81l0%2c81.72l-32.31%2c0l0%2c-81.72zm-127.32%2c171.03l-17.1%2c28.51l-98.82%2c-58.91l0%2c-112.12l34.21%2c0l0%2c93.12l81.72%2c49.41zm399.08%2c-142.53l0%2c112.12l-98.82%2c58.91l-17.1%2c-28.51l81.72%2c-49.41l0%2c-93.12l34.21%2c0zm-159.63%2c203.34l-98.82%2c58.91l-96.92%2c-58.91l15.2%2c-28.51l68.41%2c39.91l0%2c-70.31l32.31%2c0l0%2c68.41l64.61%2c-38.01l15.2%2c28.51z' transform='translate(205%2c 200)'/%3e%3c/g%3e%3c/svg%3e";const TT=new rs,ET=new rs,CT=new rs,AT=new rs,DT=new ps,PT=(t,e)=>(t%e+e)%e;class LT{value;source;target;timer=0;transitionTime=0;constructor(t){this.value=t,this.source={...t},this.target={...t}}goto(t,e=.25){0===e&&LT.copy(this.value,t),LT.copy(this.source,this.value),LT.copy(this.target,t),this.timer=0,this.transitionTime=e}update(t){this.timer<this.transitionTime?(this.timer=Math.min(this.timer+t,this.transitionTime),LT.lerp(this.value,this.source,this.target,LT.quintic(this.timer/this.transitionTime))):LT.copy(this.value,this.target)}static quintic(t){return Math.pow(t-1,5)+1}static copy(t,e){Object.keys(t).forEach((s=>{t[s]=e[s]}))}static lerp(t,e,s,i){Object.keys(t).forEach((n=>{t[n]=e[n]+i*(s[n]-e[n])}))}}class IT{options;dom;events=new Ve;active=!1;rotating=!1;constructor(t){this.options=t;const e=t.xr;e.domOverlay.root=this._createRotateInput(),this.options.showUI&&this._createUI(),this._createModelHandler();e.on(`available: ${Xb}`,(t=>{this.events.fire("xr:available",t)})),e.on("start",(()=>{var t;this.active=!0,this.events.fire("xr:started"),t=t=>{this.events.fire("xr:initial-place",t),navigator?.vibrate(10),e.hitTest.start({profile:"generic-touchscreen",entityTypes:[qb,Kb,Yb],callback:(t,e)=>{t?console.log(t):e.on("result",(t=>{this.rotating||this.events.fire("xr:place",t)}))}})},e.hitTest.start({spaceType:$b,entityTypes:[qb,Kb,Yb],callback:(e,s)=>{e?console.log(e):s.on("result",(e=>{t(e),s.remove()}))}})})),e.on("end",(()=>{this.active=!1,this.events.fire("xr:ended")}))}get available(){return this.options.xr.isAvailable(Xb)}_createRotateInput(){const t=new Map;let e=0,s=0;const i=t=>{t.preventDefault(),t.stopPropagation()},n=e=>{i(e),t.set(e.pointerId,{start:{x:e.clientX,y:e.clientY},previous:{x:e.clientX,y:e.clientY},current:{x:e.clientX,y:e.clientY}}),this.rotating?1===t.size&&(this.rotating=!1):this.rotating=t.size>1},r=n=>{i(n);const r=t.get(n.pointerId);if(r&&(r.previous.x=r.current.x,r.previous.y=r.current.y,r.current.x=n.clientX,r.current.y=n.clientY),2===t.size){const i=Array.from(t.keys()),n=t.get(i[0]),r=t.get(i[1]),a=Math.atan2(r.start.y-n.start.y,r.start.x-n.start.x),o=Math.atan2(r.current.y-n.current.y,r.current.x-n.current.x);s=o-a,this.events.fire("xr:rotate",-180*(e+s)/Math.PI)}},a=n=>{i(n),2===t.size&&(e+=s),t.delete(n.pointerId)},o=document.createElement("div");return o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.touchAction="none",o.style.display="none",document.body.appendChild(o),this.events.on("xr:started",(()=>{o.style.display="block",o.addEventListener("pointerdown",n),o.addEventListener("pointermove",r),o.addEventListener("pointerup",a)})),this.events.on("xr:ended",(()=>{o.style.display="none",o.removeEventListener("pointerdown",n),o.removeEventListener("pointermove",r),o.removeEventListener("pointerup",a)})),o}_createUI(){const t=document.createElement("img");t.src=this.options.startArImgSrc,t.style.position="fixed",t.style.right="20px",t.style.top="20px",t.style.width="36px",t.style.height="36px",t.style.opacity="100%",t.style.display="none",document.body.appendChild(t);let e=!0;this.events.on("xr:available",(e=>{t.style.display=e?"block":"none"})),this.events.on("xr:started",(()=>{e=!0,t.src=this.options.stopArImgSrc,this.options.xr.domOverlay.root.appendChild(t)})),this.events.on("xr:ended",(()=>{e=!0,t.src=this.options.startArImgSrc,document.body.appendChild(t)})),t.addEventListener("click",(()=>{e&&(e=!1,this.active?this.end():this.start())}))}_createModelHandler(){const t=this.options.xr,e=this.events,s=new LT({x:0,y:0,z:0}),i=new LT({x:0,y:0,z:0}),n=new LT({scale:1}),r=.25;let a=!0;const o=new rs,l=new Ss;let h;const c=()=>{if(h.length){l.copy(h[0].aabb);for(let t=1;t<h.length;++t)l.add(h[t].aabb)}};e.on("xr:start",(()=>{a=!0,h=this.options.content.findComponents("render").map((t=>t.meshInstances)).flat().concat(this.options.content.findComponents("gsplat").map((t=>t.instance.meshInstance))),c();const t=l.halfExtents;o.set(0,-t.y,4*-t.length())})),e.on("xr:initial-place",(e=>{DT.copy(t.camera.camera.viewMatrix).invert(),DT.transformPoint(o,TT),DT.getEulerAngles(ET),s.goto({x:TT.x,y:TT.y,z:TT.z},0),i.goto({x:ET.x,y:ET.y,z:ET.z},0),n.goto({scale:.55},0),i.goto({x:0,y:0,z:0},r),s.goto({x:e.x,y:e.y,z:e.z},r),a=!1})),e.on("xr:place",(t=>{s.goto({x:t.x,y:t.y,z:t.z},r)})),e.on("xr:rotate",(t=>{t=PT(t,360),i.goto({x:0,y:t,z:0},r),i.source.y=t-180+PT(i.source.y-t+180,360)})),e.on("xr:ended",(()=>{this.options.content.setLocalPosition(0,0,0),this.options.content.setLocalEulerAngles(0,0,0)})),t.app.on("frameupdate",(t=>{const e=t/1e3;s.update(e),i.update(e),n.update(e)})),t.on("update",(()=>{const t=this.options.xr;if(!t.views.list.length)return;DT.copy(t.camera.camera.viewMatrix).invert();const e=this.options.content;a?(DT.transformPoint(o,TT),DT.getEulerAngles(ET),e.setLocalPosition(TT.x,TT.y,TT.z),e.setLocalEulerAngles(ET.x,ET.y,ET.z),e.setLocalScale(1,1,1)):(e.setLocalPosition(s.value.x,s.value.y,s.value.z),e.setLocalEulerAngles(i.value.x,i.value.y,i.value.z),e.setLocalScale(n.value.scale,n.value.scale,n.value.scale)),c();const r=l.center,h=l.halfExtents.length();DT.getZ(AT),DT.getTranslation(CT),TT.sub2(r,CT);const d=-TT.dot(AT),u=d+h,f=Math.max(1e-4,d<h?u/1024:d-h);t._setClipPlanes(f/1.5,1.5*u),this.events.fire("xr:update")}))}start(){this.available&&!this.active&&(this.events.fire("xr:start"),this.options.xr.start(this.options.camera.camera,Xb,"local",{callback:t=>{t&&console.log(t)}}))}end(){this.options.xr.end()}}var RT=function(){var t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),e=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var s,i=WebAssembly.validate(t)?"b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb":"b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",n=WebAssembly.instantiate(r(i),{}).then((function(t){(s=t.instance).exports.__wasm_call_ctors()}));function r(t){for(var s=new Uint8Array(t.length),i=0;i<t.length;++i){var n=t.charCodeAt(i);s[i]=n>96?n-97:n>64?n-39:n+4}var r=0;for(i=0;i<t.length;++i)s[r++]=s[i]<60?e[s[i]]:64*(s[i]-60)+s[++i];return s.buffer.slice(0,r)}function a(t,e,i,n,r,a){var o=s.exports.sbrk,l=i+3&-4,h=o(l*n),c=o(r.length),d=new Uint8Array(s.exports.memory.buffer);d.set(r,c);var u=t(h,i,n,c,r.length);if(0==u&&a&&a(h,l,n),e.set(d.subarray(h,h+i*n)),o(h-o(0)),0!=u)throw new Error("Malformed buffer data: "+u)}var o={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],c=0;function d(t){var e={object:new Worker(t),pending:0,requests:{}};return e.object.onmessage=function(t){var s=t.data;e.pending-=s.count,e.requests[s.id][s.action](s.value),delete e.requests[s.id]},e}function u(t){for(var e="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(r(i))+"]), {}).then(function(result) { instance = result.instance; instance.exports.__wasm_call_ctors(); });self.onmessage = workerProcess;"+a.toString()+f.toString(),s=new Blob([e],{type:"text/javascript"}),n=URL.createObjectURL(s),o=0;o<t;++o)h[o]=d(n);URL.revokeObjectURL(n)}function f(t){n.then((function(){var e=t.data;try{var i=new Uint8Array(e.count*e.size);a(s.exports[e.mode],i,e.count,e.size,e.source,s.exports[e.filter]),self.postMessage({id:e.id,count:e.count,action:"resolve",value:i},[i.buffer])}catch(t){self.postMessage({id:e.id,count:e.count,action:"reject",value:t})}}))}return{ready:n,supported:!0,useWorkers:function(t){u(t)},decodeVertexBuffer:function(t,e,i,n,r){a(s.exports.meshopt_decodeVertexBuffer,t,e,i,n,s.exports[o[r]])},decodeIndexBuffer:function(t,e,i,n){a(s.exports.meshopt_decodeIndexBuffer,t,e,i,n)},decodeIndexSequence:function(t,e,i,n){a(s.exports.meshopt_decodeIndexSequence,t,e,i,n)},decodeGltfBuffer:function(t,e,i,n,r,h){a(s.exports[l[r]],t,e,i,n,s.exports[o[h]])},decodeGltfBufferAsync:function(t,e,i,r,d){return h.length>0?function(t,e,s,i,n){for(var r=h[0],a=1;a<h.length;++a)h[a].pending<r.pending&&(r=h[a]);return new Promise((function(a,o){var l=new Uint8Array(s),h=c++;r.pending+=t,r.requests[h]={resolve:a,reject:o},r.object.postMessage({id:h,count:t,size:e,source:l,mode:i,filter:n},[l.buffer])}))}(t,e,i,l[r],o[d]):n.then((function(){var n=new Uint8Array(t*e);return a(s.exports[l[r]],n,t,e,i,s.exports[o[d]]),n}))}}}();const MT=["gltf","glb","vox"],kT=new Ss(new rs(0,1,0),new rs(1,1,1)),OT=new rs,FT=new Ss;class NT{canvas;app;skyboxUrls;controlEventKeys=null;pngExporter=null;prevCameraMat;camera;initialCameraPosition;initialCameraFocus;light;sceneRoot;debugRoot;entities;entityAssets;assets;meshInstances;wireframeMeshInstances;wireframeMaterial;animTracks;animationMap;firstFrame;skyboxLoaded;animSpeed;animTransition;animLoops;showWireframe;showBounds;showSkeleton;showAxes;showGrid;normalLength;dirtyWireframe;dirtyBounds;dirtySkeleton;dirtyGrid;dirtyNormals;sceneBounds;dynamicSceneBounds;debugBounds;debugSkeleton;debugGrid;debugNormals;miniStats;observer;suppressAnimationProgressUpdate;selectedNode;multiframe;multiframeBusy=!1;picker=null;cursorWorld=new rs;loadTimestamp=null;shadowCatcher=null;xrMode;canvasResize=!0;cameraControls;constructor(t,e,s,i){this.canvas=t;const n=new Ww(t,{mouse:new Ko(t),touch:new Zo(t),keyboard:new Xo(window),graphicsDevice:e});this.app=n,this.skyboxUrls=i,Ch.get(this.app.graphicsDevice,"glsl").set("pickPS","\nvec4 packFloat(float depth) {\n    uvec4 u = (uvec4(floatBitsToUint(depth)) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu;\n    return vec4(u) / 255.0;\n}\nvec4 getPickOutput() {\n    return packFloat(gl_FragCoord.z);\n}\n"),Ch.get(this.app.graphicsDevice,"wgsl").set("pickPS","\n    fn packFloat(depth: f32) -> vec4f {\n        let u: vec4<u32> = (vec4<u32>(bitcast<u32>(depth)) >> vec4<u32>(0u, 8u, 16u, 24u)) & vec4<u32>(0xffu);\n        return vec4f(u) / 255.0;\n    }\n\n    fn getPickOutput() -> vec4f {\n        return packFloat(pcPosition.z);\n    }\n"),this.app.scene.clusteredLightingEnabled=!1;const r=n.mouse._moveHandler;n.mouse.detach(),n.mouse._moveHandler=e=>{e.target===t&&r(e)},n.mouse.attach(t);const a=n.touch._moveHandler;n.touch.detach(),n.touch._moveHandler=e=>{e.target===t&&a(e)},n.touch.attach(t);const o=n.graphicsDevice.maxSamples>1;s.set("camera.multisampleSupported",o),s.set("camera.multisample",o&&s.get("camera.multisample")),this.pngExporter=new yT,oT(document.getElementById("app"),((t,e)=>{this.loadFiles(t,e)})),new ResizeObserver((()=>{this.xrMode&&!this.xrMode.active&&(this.canvasResize=!0,this.renderNextFrame())})).observe(window.document.getElementById("canvas-wrapper"));const l=n.scene.layers.getLayerById(1);n.scene.layers.remove(l),n.scene.layers.insertOpaque(l,2);const h=new Im("Camera");h.setPosition(0,1,10),this.app.root.addChild(h),h.addComponent("camera",{fov:75,frustumCulling:!0,clearColor:new Ze(0,0,0,0)}),this.cameraControls=new CameraControls(n,h.camera,s),this.cameraControls.zoomRange=new os(.01,1/0),h.camera.requestSceneColorMap(!0),n.keyboard.on("keydown",(t=>{switch(t.key){case 70:this.focus(!1);break;case 82:this.cameraControls.reset(rs.ZERO,new rs(2,2,2))}}));const c=new Im;c.addComponent("light",{type:"directional",shadowBias:.2,shadowResolution:2048}),n.root.addChild(c),n.autoRender=!1,this.prevCameraMat=new ps,n.on("update",this.update,this),n.on("framerender",this.onFrameRender,this),n.on("prerender",this.onPrerender,this),n.on("postrender",this.onPostrender,this),n.on("frameend",this.onFrameend,this);const d=new Im("sceneRoot",n);n.root.addChild(d);const u=new Im("debugRoot",n);n.root.addChild(u),this.camera=h,this.initialCameraPosition=null,this.initialCameraFocus=null,this.light=c,this.sceneRoot=d,this.debugRoot=u,this.entities=[],this.entityAssets=[],this.assets=[],this.meshInstances=[],this.wireframeMeshInstances=[];const f=new Jf;f.blendState=new Sn(!0,0,1,0,0,0,1),f.useLighting=!1,f.useSkybox=!1,f.ambient=new Ze(0,0,0),f.diffuse=new Ze(0,0,0),f.specular=new Ze(0,0,0),f.emissive=new Ze(1,1,1),f.update(),this.wireframeMaterial=f,this.animTracks=[],this.animationMap={},this.firstFrame=!1,this.skyboxLoaded=!1,this.animSpeed=s.get("animation.speed"),this.animTransition=s.get("animation.transition"),this.animLoops=s.get("animation.loops"),this.showWireframe=s.get("debug.wireframe"),this.showBounds=s.get("debug.bounds"),this.showSkeleton=s.get("debug.skeleton"),this.showAxes=s.get("debug.axes"),this.normalLength=s.get("debug.normals"),this.setTonemapping(s.get("camera.tonemapping")),this.setBackgroundColor(s.get("skybox.backgroundColor")),this.setLightColor(s.get("light.color")),this.setWireframeColor(s.get("debug.wireframeColor")),this.dirtyWireframe=!1,this.dirtyBounds=!1,this.dirtySkeleton=!1,this.dirtyGrid=!1,this.dirtyNormals=!1,this.sceneBounds=new Ss,this.dynamicSceneBounds=new Ss,this.debugBounds=new rT(n,h),this.debugSkeleton=new rT(n,h),this.debugGrid=new rT(n,h,!1),this.debugNormals=new rT(n,h,!1),this.miniStats=new iS(n),this.miniStats.enabled=s.get("debug.stats"),this.observer=s;const p=this.app.graphicsDevice;p.on("devicerestored",(()=>{this.renderNextFrame()})),this.multiframe=new pT(p,this.camera.camera),this.shadowCatcher=new ST(n,this.camera.camera,this.debugRoot,this.sceneRoot),this.initXrMode(),this.bindControlEvents(),this.reloadSettings(),this.picker=new bT(n,h),this.cursorWorld=new rs,t.addEventListener("dblclick",(async t=>{const e=await this.picker.pick(t.offsetX,t.offsetY);e&&this.cameraControls.reset(e,this.camera.getPosition())})),this.app.scene.layers.getLayerByName("World").transparentSortMode=3,n.start()}initXrMode(){const t=this.app.xr;this.xrMode=new IT({xr:t,camera:this.camera,content:this.sceneRoot,showUI:!0,startArImgSrc:wT.src,stopArImgSrc:xT.src});const e=this.xrMode.events;e.on("xr:started",(()=>{this.setShadowCatcherEnabled(!0),this.setShadowCatcherIntensity(.4),this.setDebugGrid(!1),this.setDebugBounds(!1),this.setLightEnabled(!0),this.setLightShadow(!0),this.setLightFollow(!1),this.setCenterScene(!0),this.setSkyboxBackground("None"),this.setSkyboxExposure(0),this.setBackgroundColor(Ze.BLACK),this.app.scene.layers.getLayerById(2).enabled=!1,this.multiframe.blend=.5})),e.on("xr:initial-place",(()=>{this.multiframe.blend=1})),e.on("xr:ended",(()=>{this.reloadSettings(),this.setBackgroundColor(this.observer.get("skybox.backgroundColor")),this.multiframe.blend=1}))}getSelectedMeshInstances(){return this.selectedNode?this.collectMeshInstances(this.selectedNode):this.meshInstances}collectMeshInstances(t){const e=[];if(t){const s=t.findComponents("render");for(let t=0;t<s.length;t++){const i=s[t];if(i.meshInstances)for(let t=0;t<i.meshInstances.length;t++){const s=i.meshInstances[t];e.push(s)}}const i=t.findComponents("gsplat");for(let t=0;t<i.length;t++){const s=i[t];s.instance&&e.push(s.instance.meshInstance)}}return e}static calcMeshBoundingBox(t,e){if(e.length>0){t.copy(e[0].aabb);for(let s=1;s<e.length;++s)t.add(e[s].aabb)}}static calcHierBoundingBox(t,e){const s=e.getPosition();let i=s.x,n=s.y,r=s.z,a=s.x,o=s.y,l=s.z;const h=t=>{const e=t.getPosition();i=Math.min(i,e.x),n=Math.min(n,e.y),r=Math.min(r,e.z),a=Math.max(a,e.x),o=Math.max(o,e.y),l=Math.max(l,e.z);for(let e=0;e<t.children.length;++e)h(t.children[e])};h(e),t.setMinMax(new rs(i,n,r),new rs(a,o,l))}bindControlEvents(){const t={"camera.fov":this.setFov.bind(this),"camera.tonemapping":this.setTonemapping.bind(this),"camera.pixelScale":()=>{this.canvasResize=!0,this.renderNextFrame()},"camera.multisample":()=>{this.destroyRenderTargets(),this.renderNextFrame()},"camera.hq":t=>{this.multiframe.enabled=t,this.renderNextFrame()},"camera.mode":t=>{this.cameraControls.mode=t},"skybox.value":t=>{if(this.skyboxUrls.has(t)){const e=this.skyboxUrls.get(t);this.loadFiles([{url:e,filename:e}])}else"None"===t?this.clearSkybox():this.loadFiles([{url:t,filename:t}])},"skybox.blur":this.setSkyboxBlur.bind(this),"skybox.exposure":this.setSkyboxExposure.bind(this),"skybox.rotation":this.setSkyboxRotation.bind(this),"skybox.background":this.setSkyboxBackground.bind(this),"skybox.backgroundColor":this.setBackgroundColor.bind(this),"skybox.domeProjection.domeRadius":this.setSkyboxDomeRadius.bind(this),"skybox.domeProjection.tripodOffset":this.setSkyboxTripodOffset.bind(this),"light.enabled":this.setLightEnabled.bind(this),"light.intensity":this.setLightIntensity.bind(this),"light.color":this.setLightColor.bind(this),"light.follow":this.setLightFollow.bind(this),"light.shadow":this.setLightShadow.bind(this),"shadowCatcher.enabled":this.setShadowCatcherEnabled.bind(this),"shadowCatcher.intensity":this.setShadowCatcherIntensity.bind(this),"debug.stats":this.setDebugStats.bind(this),"debug.wireframe":this.setDebugWireframe.bind(this),"debug.wireframeColor":this.setWireframeColor.bind(this),"debug.bounds":this.setDebugBounds.bind(this),"debug.skeleton":this.setDebugSkeleton.bind(this),"debug.axes":this.setDebugAxes.bind(this),"debug.grid":this.setDebugGrid.bind(this),"debug.normals":this.setNormalLength.bind(this),"debug.renderMode":this.setRenderMode.bind(this),"animation.playing":t=>{t?this.play():this.stop()},"animation.selectedTrack":this.setSelectedTrack.bind(this),"animation.speed":this.setSpeed.bind(this),"animation.transition":this.setTransition.bind(this),"animation.loops":this.setLoops.bind(this),"animation.progress":this.setAnimationProgress.bind(this),"scene.selectedNode.path":this.setSelectedNode.bind(this),"scene.variant.selected":this.setSelectedVariant.bind(this),centerScene:this.setCenterScene.bind(this)};this.controlEventKeys=Object.keys(t),this.controlEventKeys.forEach((e=>{this.observer.on(`${e}:set`,t[e])}))}reloadSettings(){this.controlEventKeys.forEach((t=>{this.observer.set(t,this.observer.get(t),!1,!1,!0)}))}clearSkybox(){this.app.scene.envAtlas=null,this.app.scene.setSkybox(null),this.renderNextFrame(),this.skyboxLoaded=!1}initSkybox(t){const e=Pf.generateSkyboxCubemap(t),s=Pf.generateLightingSource(t),i=Pf.generateAtlas(s,{});s.destroy(),this.app.scene.envAtlas=i,this.app.scene.skybox=e,this.renderNextFrame()}loadSkybox(t){const e=this.app;if(6!==t.length){const s=new pm("skybox_equi","texture",{url:t[0].url,filename:t[0].filename});s.ready((()=>{const t=s.resource;t.type===mi&&7===t.format&&(t.type=_i),this.initSkybox(t),s.unload(),e.assets.remove(s)})),e.assets.add(s),e.assets.load(s)}else{const s=[["posx","negx","posy","negy","posz","negz"],["px","nx","py","ny","pz","nz"],["right","left","up","down","front","back"],["right","left","top","bottom","forward","backward"],["0","1","2","3","4","5"]],i=t=>{const e=t.toLowerCase();for(let t=0;t<s.length;++t){const i=s[t];for(let t=0;t<i.length;++t)if(-1!==e.indexOf(`${i[t]}.`))return t}return 0},n=(t,e)=>{const s=i(t.filename),n=i(e.filename);return s<n?-1:n<s?1:0};t.sort(n);const r=t.map(((t,s)=>{const i=new pm(`skybox_face${s}`,"texture",t);return e.assets.add(i),e.assets.load(i),i})),a=new pm("skybox_cubemap","cubemap",null,{textures:r.map((t=>t.id))});a.loadFaces=!0,a.on("load",(()=>{this.initSkybox(a.resource)})),e.assets.add(a),e.assets.load(a)}this.skyboxLoaded=!0}getCanvasSize(){const t=this.canvas.getBoundingClientRect();return{width:t.width,height:t.height}}calcFocalPoint(t){const e=new rs;if(this.initialCameraFocus)e.copy(this.initialCameraFocus),this.initialCameraFocus=null;else{const s=this.entityAssets[0],i=s?.asset?.resource?.gsplatData;i?(i.calcFocalPoint(e,(()=>!0)),s.entity.getWorldTransform().transformPoint(e,e)):e.copy(t.center)}return e}calcZoom(t){const e=this.camera.camera;return Math.tan(37.5*Qe.DEG_TO_RAD)/Math.tan(.5*e.fov*Qe.DEG_TO_RAD)*(1/e.aspectRatio)*t+t}focus(t){this.calcSceneBounds(FT,this.selectedNode);const e=FT.halfExtents.length();this.cameraControls.moveSpeed=2.5*e,this.cameraControls.zoomRange=new os(.01,10*e);const s=this.calcFocalPoint(FT),i=this.calcZoom(e);if(this.initialCameraPosition){const t=this.initialCameraPosition.clone();return this.initialCameraPosition=null,void this.cameraControls.reset(s,t)}const n=(t?rs.FORWARD:this.camera.forward).clone().mulScalar(-i).add(s);this.cameraControls.reset(s,n)}destroyRenderTargets(){const t=this.camera.camera.renderTarget;t&&(t.colorBuffer?.destroy(),t.depthBuffer?.destroy(),t.destroy(),this.camera.camera.renderTarget=null)}rebuildRenderTargets(){const t=this.app.graphicsDevice,e=t.width,s=t.height,i=this.camera.camera.renderTarget;if(i&&i.width===e&&i.height===s)return;this.destroyRenderTargets();const n=(e,s,i)=>new dn(t,{name:"viewer-rt-texture",width:e,height:s,format:i,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),r=t.maxSamples,a=n(e,s,7),o=n(e,s,Rs),l=new Hn({name:"viewer-rt",colorBuffer:a,depthBuffer:o,flipY:!1,samples:this.observer.get("camera.multisample")?r:1,autoResolve:!1});this.camera.camera.renderTarget=l}resetScene(){const t=this.app;this.entities.forEach((t=>{this.sceneRoot.removeChild(t),this.shadowCatcher.onEntityRemoved(t),t.destroy()})),this.entities=[],this.assets.forEach((e=>{t.assets.remove(e),e.unload()})),this.assets=[],this.meshInstances=[],this.resetWireframeMeshes(),this.animTracks=[],this.animationMap={}}updateSceneStats(){let t=0,e=0,s=0,i=0,n=0,r=0,a=0,o=[];this.assets.forEach((l=>{if(l.resource instanceof Dp){const r=l.resource;t++,n++,i+=r.gsplatData.numSplats,s+=4*r.gsplatData.numSplats,e+=64*r.gsplatData.numSplats}else{const h=l.resource;o=o.concat(h.getMaterialVariants()??[]),h.renders.forEach((n=>{const r=n.resource;t+=r.meshes.length,r.meshes.forEach((t=>{s+=t.vertexBuffer.getNumVertices();const n=t.primitive[0];switch(n.type){case 0:case 2:i+=n.count;break;case 1:i+=n.count/2;break;case 3:i+=n.count-1;break;case 4:i+=n.count/3;break;case 5:case 6:i+=n.count-2}e+=t.vertexBuffer.numBytes+(t.indexBuffer?.[0]?.numBytes??0)}))})),n+=h.materials.length??0,r+=h.textures.length??0,(h.textures??[]).forEach((t=>{a+=t.resource.gpuSize}))}}));const l=function(t){return t.children.map((t=>({name:t.name,path:t.path,children:l(t)})))},h=this.entities.map((t=>({name:t.name,path:t.path,children:l(t)})));this.observer.set("scene.nodes",JSON.stringify(h)),this.observer.set("scene.meshCount",t),this.observer.set("scene.materialCount",n),this.observer.set("scene.textureCount",r),this.observer.set("scene.vertexCount",s),this.observer.set("scene.primitiveCount",i),this.observer.set("scene.textureVRAM",a),this.observer.set("scene.meshVRAM",e),this.observer.set("scene.variants.list",JSON.stringify(o)),this.observer.set("scene.variant.selected",o[0])}downloadPngScreenshot(){const t=this.camera.camera.renderTarget.colorBuffer;t.read(0,0,t.width,t.height).then((e=>{this.pngExporter.export("model-viewer.png",new Uint32Array(e.buffer.slice(0)),t.width,t.height)}))}fitCameraClipPlanes(){if(this.xrMode?.active)return;const t=this.camera.getWorldTransform(),e=t.getTranslation(),s=t.getZ(),i=this.dynamicSceneBounds,n=i.center,r=2*i.halfExtents.length();OT.sub2(n,e);const a=-OT.dot(s),o=a+r,l=Math.max(.001,a<r?o/1024:a-r);this.camera.camera.nearClip=l,this.camera.camera.farClip=o,this.light.light.shadowDistance=o,this.light.light.normalOffsetBias=o/1024}loadGltf(t,e){return new Promise(((s,i)=>{const n=new pm(t.filename,"container",t,null,{bufferView:{processAsync:function(t,e,s){if(t.extensions&&t.extensions.EXT_meshopt_compression){const i=t.extensions.EXT_meshopt_compression;Promise.all([RT.ready,e[i.buffer]]).then((t=>{const e=t[1],n=i.byteOffset||0,r=i.byteLength||0,a=i.count,o=i.byteStride,l=new Uint8Array(a*o),h=new Uint8Array(e.buffer,e.byteOffset+n,r);RT.decodeGltfBuffer(l,a,o,h,i.mode,i.filter),s(null,l)}))}else s(null,null)}.bind(this)},image:{processAsync:function(t,s){const i=e.find((e=>e.filename===decodeURIComponent(ke.normalize(t.uri||""))));if(i){const t=new pm(i.filename,"texture",{url:i.url,filename:i.filename});t.on("load",(()=>{s(null,t)})),this.app.assets.add(t),this.app.assets.load(t)}else s(null,null)}.bind(this),postprocess:(t,e)=>{e.resource.anisotropy=this.app.graphicsDevice.maxAnisotropy}},buffer:{processAsync:function(t,s){const i=e.find((e=>e.filename===decodeURIComponent(ke.normalize(t.uri||""))));if(i){const t=new pm(i.filename,"binary",{url:i.url,filename:i.filename});t.on("load",(()=>{s(null,new Uint8Array(t.resource))})),this.app.assets.add(t),this.app.assets.load(t)}else s(null,null)}.bind(this)}});n.on("load",(()=>s(n))),n.on("error",(t=>i(t))),this.app.assets.add(n),this.app.assets.load(n)}))}loadPly(t,e){const s={};return e.forEach((t=>{s[t.filename]=t.url})),new Promise(((e,i)=>{const n=new pm(t.filename,"gsplat",t,null,{mapUrl:t=>s[t]});n.on("load",(()=>e(n))),n.on("error",(t=>i(t))),this.app.assets.add(n),this.app.assets.load(n)}))}isModelFilename(t){const e=t.split("?")[0].split("/").pop().split(".");return 1===e.length||MT.includes(e.pop().toLowerCase())}isGSplatFilename(t){const e=t.split("?")[0].split("/").pop().split(".");return e.length>0&&["ply","json"].includes(e.pop().toLowerCase())}loadFiles(t,e=!1){Array.isArray(t)||(t=[t]);const s=t.reduce(((t,e)=>t||this.isModelFilename(e.filename)||this.isGSplatFilename(e.filename)),!1);if(s){e&&this.resetScene();const s=Date.now();this.observer.set("ui.spinner",!0),this.observer.set("ui.error",null),this.clearCta();const i=t.map((e=>this.isModelFilename(e.filename)?this.loadGltf(e,t):this.isGSplatFilename(e.filename)?this.loadPly(e,t):null));Promise.all(i).then((i=>{this.loadTimestamp=s,i.forEach((t=>{t&&this.addToScene(t)})),this.postSceneLoad();const n=t.map((t=>t.url)),r=t.map((t=>t.filename.split("/").pop()));e?(this.observer.set("scene.urls",n),this.observer.set("scene.filenames",r)):(this.observer.set("scene.urls",this.observer.get("scene.urls").concat(n)),this.observer.set("scene.filenames",this.observer.get("scene.filenames").concat(r)))})).catch((t=>{console.log(t),this.observer.set("ui.error",t?.toString()||t)})).finally((()=>{this.observer.set("ui.spinner",!1)}))}else this.loadSkybox(t);return s}setSelectedTrack(t){if("ALL_TRACKS"!==t){const e=this.animationMap[t];this.entities.forEach((t=>{t.anim?.baseLayer?.transition(e)}))}}play(){this.entities.forEach((t=>{t.anim&&(t.anim.playing=!0,t.anim.baseLayer?.play())}))}stop(){this.entities.forEach((t=>{t.anim&&(t.anim.playing=!1,t.anim.baseLayer?.pause())}))}setSpeed(t){this.animSpeed=t,this.entities.forEach((e=>{const s=e.anim;s&&(s.speed=t)}))}setTransition(t){this.animTransition=t,this.animTracks.length>0&&this.rebuildAnimTracks()}setLoops(t){this.animLoops=t,this.animTracks.length>0&&this.rebuildAnimTracks()}setAnimationProgress(t){this.suppressAnimationProgressUpdate||(this.entities.forEach((e=>{const s=e.anim,i=s?.baseLayer;i&&(this.play(),i.activeStateCurrentTime=i.activeStateDuration*t,s.update(0),s.playing=!1)})),this.renderNextFrame())}setSelectedNode(t){const e=this.app.root.findByPath(t);e&&this.observer.set("scene.selectedNode",{name:e.name,path:t,position:e.getLocalPosition().toString(),rotation:e.getLocalEulerAngles().toString(),scale:e.getLocalScale().toString()}),this.selectedNode=e,this.dirtyWireframe=!0,this.dirtyBounds=!0,this.dirtySkeleton=!0,this.renderNextFrame()}setSelectedVariant(t){t&&(this.entityAssets.forEach((e=>{const s=e.asset.resource;-1!==s.getMaterialVariants().indexOf(t)&&s.applyMaterialVariant(e.entity,t)})),this.renderNextFrame())}setCenterScene(t){this.sceneRoot.setLocalPosition(0,0,0),this.calcSceneBounds(this.sceneBounds),t&&this.sceneRoot.setLocalPosition(-this.sceneBounds.center.x,-this.sceneBounds.getMin().y,-this.sceneBounds.center.z),this.dirtyBounds=!0,this.renderNextFrame()}setDebugStats(t){this.miniStats.enabled=t,this.renderNextFrame()}setDebugWireframe(t){this.showWireframe=t,this.dirtyWireframe=!0,this.renderNextFrame()}setWireframeColor(t){this.wireframeMaterial.emissive=new Ze(t.r,t.g,t.b),this.wireframeMaterial.update(),this.renderNextFrame()}setDebugBounds(t){this.showBounds=t,this.dirtyBounds=!0,this.renderNextFrame()}setDebugSkeleton(t){this.showSkeleton=t,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugAxes(t){this.showAxes=t,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugGrid(t){this.showGrid=t,this.dirtyGrid=!0,this.renderNextFrame()}setNormalLength(t){this.normalLength=t,this.dirtyNormals=!0,this.renderNextFrame()}setFov(t){this.camera.camera.fov=t,this.renderNextFrame()}setRenderMode(t){this.camera.camera.setShaderPass("default"!==t?`debug_${t}`:"forward"),this.renderNextFrame()}setLightEnabled(t){this.light.enabled=t,this.renderNextFrame()}setLightIntensity(t){this.light.light.intensity=t,this.renderNextFrame()}setLightColor(t){this.light.light.color=new Ze(t.r,t.g,t.b),this.renderNextFrame()}setLightFollow(t){this.light.reparent(t?this.camera:this.app.root),t?this.light.setLocalEulerAngles(90,0,0):this.light.setLocalEulerAngles(45,30,0),this.renderNextFrame()}setLightShadow(t){this.light.light.castShadows=t,this.renderNextFrame()}setShadowCatcherEnabled(t){this.shadowCatcher.enabled=t,this.renderNextFrame()}setShadowCatcherIntensity(t){this.shadowCatcher.intensity=t,this.renderNextFrame()}setSkyboxExposure(t){this.app.scene.skyboxIntensity=Math.pow(2,t),this.renderNextFrame()}setSkyboxRotation(t){const e=new ms;e.setFromEulerAngles(0,t,0),this.app.scene.skyboxRotation=e,this.renderNextFrame()}setSkyboxBackground(t){const{scene:e}=this.app;switch(this.app.scene.layers.getLayerById(2).enabled="Solid Color"!==t,t){case"Solid Color":break;case"Infinite Sphere":e.sky.type=ah;break;case"Projective Dome":e.sky.type=oh;break;case"Projective Box":e.sky.type="box"}this.app.scene.skyboxMip="Infinite Sphere"===t?this.observer.get("skybox.blur"):0,this.renderNextFrame()}setSkyboxBlur(t){this.app.scene.skyboxMip="Infinite Sphere"===this.observer.get("skybox.background")?t:0,this.renderNextFrame()}setSkyboxDomeRadius(t){const e=(this.sceneBounds?.halfExtents.length()??1)*t;this.app.scene.sky.node.setLocalScale(e,e,e),this.renderNextFrame()}setSkyboxTripodOffset(t){this.app.scene.sky.center=new rs(0,t,0),this.renderNextFrame()}setTonemapping(t){const e={None:6,Linear:0,Neutral:5,Filmic:1,Hejl:2,ACES:3,ACES2:4};this.camera.camera.toneMapping=e.hasOwnProperty(t)?e[t]:3,this.renderNextFrame()}setBackgroundColor(t){const e=t=>Math.max(0,Math.min(255,Math.floor(255*t)));document.getElementById("canvas-wrapper").style.backgroundColor=`rgb(${e(t.r)}, ${e(t.g)}, ${e(t.b)})`}update(t){this.xrMode?.active||this.cameraControls.update(t);const e=this.camera.getWorldTransform();((t,e)=>{let s=0;for(let i=0;i<16;++i)s=Math.max(s,Math.abs(t.data[i]-e.data[i]));return s})(e,this.prevCameraMat)>1e-4&&(this.prevCameraMat.copy(e),this.renderNextFrame()),this.xrMode?.active&&this.renderNextFrame();let s=!1;for(let t=0;t<this.entities.length;++t){const e=this.entities[t].anim;if(e&&e.baseLayer&&e.baseLayer.playing){s=!0;break}}s&&(this.dirtyBounds=!0,this.dirtySkeleton=!0,this.dirtyNormals=!0,this.renderNextFrame(),this.observer.emit("animationUpdate")),this.miniStats.enabled&&this.renderNextFrame()}renderNextFrame(){this.app.renderNextFrame=!0,this.multiframe&&this.multiframe.moved()}clearCta(){document.querySelector("#panel-left").classList.add("no-cta"),document.querySelector("#application-canvas").classList.add("no-cta"),document.querySelector(".load-button-panel").classList.add("hide")}addToScene(t){const e=t.resource,s=e.renders&&e.renders.length>0,i=e.animations&&e.animations.length>0,n=0===this.entities.length?null:this.entities[this.entities.length-1];let r;!s&&n&&n.findComponent("render")?r=n:("container"===t.type?r=e.instantiateRenderEntity():(r=new Im,r.setEulerAngles(0,0,180),r.addComponent("gsplat",{asset:t}),r.gsplat.instance.sorter.on("updated",(()=>{this.renderNextFrame()}))),this.entities.push(r),this.entityAssets.push({entity:r,asset:t}),this.sceneRoot.addChild(r),this.shadowCatcher.onEntityAdded(r)),i&&e.animations.forEach((t=>{this.animTracks.push(t.resource)})),this.assets.push(t)}postSceneLoad(){this.meshInstances=this.entities.map((t=>this.collectMeshInstances(t))).flat(),0===this.meshInstances.length&&this.observer.set("debug.skeleton",!0),this.updateSceneStats(),this.animTracks.length>0&&this.rebuildAnimTracks();const t={},e={};this.meshInstances.forEach(((s,i)=>{if(s.morphInstance){const n=s.morphInstance;e[i]=n;const r=s&&s.node&&s.node.name||`Mesh ${i}`;t[i]={name:r,targets:{}},n.morph.targets.forEach(((s,n)=>{t[i].targets[n]={name:s.name,targetIndex:n},this.observer.on(`morphs.${i}.targets.${n}.weight:set`,(t=>{e[i].setWeight(n,t),this.dirtyNormals=!0,this.renderNextFrame()}))}))}})),this.observer.suspendEvents=!0,this.observer.set("morphs",t),this.observer.suspendEvents=!1;const s=this.observer;s.on("animationUpdate",(()=>{for(let t=0;t<this.entities.length;++t){const e=this.entities[t];if(e&&e.anim){const t=e.anim.baseLayer,i=t.activeStateCurrentTime/t.activeStateDuration;this.suppressAnimationProgressUpdate=!0,s.set("animation.progress",1===i?i:i%1),this.suppressAnimationProgressUpdate=!1;break}}})),this.dirtyWireframe=this.dirtyBounds=this.dirtySkeleton=this.dirtyGrid=this.dirtyNormals=!0,this.renderNextFrame(),this.firstFrame=!0}initSceneBounds(){this.setCenterScene(this.observer.get("centerScene")),this.setSkyboxDomeRadius(this.observer.get("skybox.domeProjection.domeRadius")),this.focus(!0),this.fitCameraClipPlanes()}rebuildAnimTracks(){this.entities.forEach((t=>{t.anim?t.anim.removeStateGraph():(t.addComponent("anim",{activate:!0,speed:this.animSpeed}),t.anim.rootBone=t),this.animTracks.forEach(((e,s)=>{e.events=new b_([{name:"transition",time:e.duration,nextTrack:`track_${s===this.animTracks.length-1?0:s+1}`}]);const i=`track_${s}`;t.anim.assignAnimation(i,e),this.animationMap[e.name]=i})),t.anim.on("transition",(e=>{"ALL_TRACKS"===this.observer.get("animation.selectedTrack")&&t.anim.baseLayer.activeStateProgress>=this.animLoops&&t.anim.baseLayer.transition(e.nextTrack,this.animTransition)}))}));const t=this.observer.get("animation"),e=Object.keys(this.animationMap);t.list=JSON.stringify(e),t.selectedTrack=e[0],t.playing=!0,this.observer.set("animation",t)}calcSceneBounds(t,e=null){const s=e?this.collectMeshInstances(e):this.meshInstances;s.length?NT.calcMeshBoundingBox(t,s):(e=e??this.sceneRoot).children.length?NT.calcHierBoundingBox(t,e):t.copy(kT)}resetWireframeMeshes(){this.app.scene.layers.getLayerByName("World").removeMeshInstances(this.wireframeMeshInstances),this.wireframeMeshInstances.forEach((t=>{t.clearShaders()})),this.wireframeMeshInstances=[]}buildWireframeMeshes(){this.wireframeMeshInstances=this.getSelectedMeshInstances().map((t=>{const e=new nc(t.mesh,this.wireframeMaterial,t.node);return e.renderStyle=1,e.skinInstance=t.skinInstance,e.morphInstance=t.morphInstance,e})),this.app.scene.layers.getLayerByName("World").addMeshInstances(this.wireframeMeshInstances)}onFrameRender(){if(this.canvasResize){const{width:t,height:e}=this.getCanvasSize(),s=this.observer.get("camera.pixelScale"),i=Math.floor(t*window.devicePixelRatio/s),n=Math.floor(e*window.devicePixelRatio/s);this.app.graphicsDevice.setResolution(i,n),this.observer.set("runtime.viewportWidth",i),this.observer.set("runtime.viewportHeight",n),this.canvasResize=!1}this.rebuildRenderTargets()}onPrerender(){if(!this.firstFrame){if(this.dirtyWireframe&&(this.dirtyWireframe=!1,this.resetWireframeMeshes(),this.showWireframe&&this.buildWireframeMeshes(),this.getSelectedMeshInstances().forEach((t=>{t.material.depthBias=this.showWireframe?-1:0,t.material.slopeDepthBias=this.showWireframe?1:0}))),this.dirtyBounds||this.xrMode?.active){this.dirtyBounds=!1,this.calcSceneBounds(this.dynamicSceneBounds),this.debugBounds.clear(),this.showBounds&&(this.calcSceneBounds(FT,this.selectedNode),this.debugBounds.box(FT.getMin(),FT.getMax())),this.debugBounds.update();const t=new rs(2*this.dynamicSceneBounds.halfExtents.x,2*this.dynamicSceneBounds.halfExtents.y,2*this.dynamicSceneBounds.halfExtents.z);this.observer.set("scene.bounds",t.toString())}if(this.dirtyNormals){if(this.dirtyNormals=!1,this.debugNormals.clear(),this.normalLength>0)for(let t=0;t<this.meshInstances.length;++t){const e=this.meshInstances[t],s=e.morphInstance?e.morphInstance._vertexBuffer:e.mesh.vertexBuffer;if(s){const t=e.skinInstance?e.skinInstance.matrices:null;t&&e.skinInstance.updateMatrices(e.node),this.debugNormals.generateNormals(s,e.node.getWorldTransform(),this.normalLength,t)}}this.debugNormals.update()}if(this.dirtySkeleton&&(this.dirtySkeleton=!1,this.debugSkeleton.clear(),(this.showSkeleton||this.showAxes)&&this.entities.forEach((t=>{(0===this.meshInstances.length||t.findComponent("render"))&&this.debugSkeleton.generateSkeleton(t,this.showSkeleton,this.showAxes,this.selectedNode)})),this.debugSkeleton.update()),this.sceneBounds&&this.dirtyGrid){if(this.dirtyGrid=!1,this.debugGrid.clear(),this.showGrid){const t=Math.pow(10,Math.floor(Math.log10(this.sceneBounds.halfExtents.length()))),e=new rs(0,0,0),s=new rs(0,0,0),i=0,n=10,r=n*t;for(let a=-n;a<n+1;++a){const n=a*t;e.set(-r,i,n),s.set(r,i,n),this.debugGrid.line(e,s,0===n?2147483648:2164260863),e.set(n,i,-r),s.set(n,i,r),this.debugGrid.line(e,s,0===n?2147483648:2164260863)}}this.debugGrid.update()}this.fitCameraClipPlanes(),this.shadowCatcher.onUpdate(this.dynamicSceneBounds)}}onPostrender(){this.firstFrame&&(this.firstFrame=!1,this.initSceneBounds());const t=this.camera.camera.renderTarget;t.samples>1&&t.resolve(),this.multiframeBusy=this.multiframe.update()}onFrameend(){null!==this.loadTimestamp&&(this.observer.set("scene.loadTime",Date.now()-this.loadTimestamp+"ms"),this.loadTimestamp=null),this.multiframeBusy&&(this.app.renderNextFrame=!0)}}class BT{constructor(t){if(t.graphicsDevice.isWebGPU)return void console.log("WebGPU is already created, skipping dummy WebGPU creation");if(!navigator.gpu)return void console.log("WebGPU is not supported, skipping dummy WebGPU creation");const e=document.createElement("canvas");e.width=20,e.height=20,e.style.position="absolute",e.style.top="20px",e.style.left="20px",document.body.appendChild(e),(async()=>{const s=await navigator.gpu.requestAdapter(),i=await s.requestDevice();console.log("Created WebGPU device used for profiling");const n=e.getContext("webgpu");n.configure({device:i,format:"bgra8unorm"}),t.on("frameend",(()=>{const t=n.getCurrentTexture().createView(),e=i.createCommandEncoder(),s={colorAttachments:[{view:t,clearValue:{r:1,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]};e.beginRenderPass(s).end(),i.queue.submit([e.finish()])}))})()}}const UT=[{label:"Abandoned Tank Farm",url:"./skybox/abandoned_tank_farm_01_2k.hdr"},{label:"Adam's Place Bridge",url:"./skybox/adams_place_bridge_2k.hdr"},{label:"Artist Workshop",url:"./skybox/artist_workshop_2k.hdr"},{label:"Ballroom",url:"./skybox/ballroom_2k.hdr"},{label:"Circus Arena",url:"./skybox/circus_arena_2k.hdr"},{label:"Colorful Studio",url:"./skybox/colorful_studio.hdr"},{label:"Golf Course Sunrise",url:"./skybox/golf_course_sunrise_2k.hdr"},{label:"Helipad",url:"./skybox/Helipad_equi.png"},{label:"Kloppenheim",url:"./skybox/kloppenheim_02_2k.hdr"},{label:"Lebombo",url:"./skybox/lebombo_2k.hdr"},{label:"Outdoor Umbrellas",url:"./skybox/outdoor_umbrellas_2k.hdr"},{label:"Paul Lobe Haus",url:"./skybox/paul_lobe_haus_2k.hdr"},{label:"Reinforced Concrete",url:"./skybox/reinforced_concrete_01_2k.hdr"},{label:"Rural Asphalt Road",url:"./skybox/rural_asphalt_road_2k.hdr"},{label:"Spruit Sunrise",url:"./skybox/spruit_sunrise_2k.hdr"},{label:"Studio Small",url:"./skybox/studio_small_03_2k.hdr"},{label:"Venice Sunset",url:"./skybox/venice_sunset_1k.hdr"},{label:"Vignaioli Night",url:"./skybox/vignaioli_night_2k.hdr"},{label:"Wooden Motel",url:"./skybox/wooden_motel_2k.hdr"}],zT={ui:{fullscreen:!1,active:null,spinner:!1,error:null},camera:{fov:40,tonemapping:"Linear",pixelScale:1,multisampleSupported:!0,multisample:!0,hq:!0,mode:"orbit"},skybox:{value:"Paul Lobe Haus",options:JSON.stringify(["None"].concat(UT.map((t=>t.label))).map((t=>({v:t,t:t})))),exposure:0,rotation:0,background:"Infinite Sphere",backgroundColor:{r:.4,g:.45,b:.5},blur:1,domeProjection:{domeRadius:20,tripodOffset:.1}},light:{enabled:!1,color:{r:1,g:1,b:1},intensity:1,follow:!1,shadow:!1},shadowCatcher:{enabled:!1,intensity:.4},debug:{renderMode:"default",stats:!1,wireframe:!1,wireframeColor:{r:0,g:0,b:0},bounds:!1,skeleton:!1,axes:!1,grid:!0,normals:0},animation:{playing:!1,speed:1,transition:.1,loops:1,list:"[]",progress:0,selectedTrack:"ALL_TRACKS"},scene:{urls:[],filenames:[],nodes:"[]",selectedNode:{path:"",name:null,position:{0:0,1:0,2:0},rotation:{0:0,1:0,2:0,3:0},scale:{0:0,1:0,2:0}},meshCount:null,materialCount:null,textureCount:null,vertexCount:null,primitiveCount:null,textureVRAM:null,meshVRAM:null,bounds:null,variant:{selected:0},variants:{list:"[]"},loadTime:null},runtime:{activeDeviceType:"",viewportWidth:0,viewportHeight:0,xrSupported:!1,xrActive:!1},morphs:null,enableWebGPU:!1,centerScene:!1};console.log(`Model Viewer v${ww} | PCUI v5.2.0 (f03db26) | PlayCanvas Engine v${Le} (${Ie})`);(()=>{const t=new i(zT),e=new URL(window.location.href);Bx(),Pb({glueUrl:"static/lib/basis/basis.wasm.js",wasmUrl:"static/lib/basis/basis.wasm.wasm",fallbackUrl:"static/lib/basis/basis.js",lazyInit:!0}),Ge.setConfig("DracoDecoderModule",{glueUrl:"static/lib/draco/draco.wasm.js",wasmUrl:"static/lib/draco/draco.wasm.wasm",fallbackUrl:"static/lib/draco/draco.js"});const s=new Map(UT.map((t=>[t.label,`static/${t.url}`])));t.on("ui.spinner:set",(t=>{const e=document.getElementById("spinner");t?e.classList.remove("pcui-hidden"):e.classList.add("pcui-hidden")})),e.searchParams.has("default")||(((t,e,s)=>{const i=["skybox.options","debug.renderMode"],n=(e,r)=>{-1===i.indexOf(e)&&("object"==typeof r?Object.keys(r).forEach((t=>{n(e?`${e}.${t}`:t,r[t])})):("skybox.value"!==e||"None"===r||s.has(r))&&t.set(e,r))},r=window.localStorage.getItem(`model-viewer-${e}`);if(r)try{n("",JSON.parse(r))}catch{}})(t,"uistate",s),t.on("*:set",(()=>{((t,e)=>{const s=t.json();window.localStorage.setItem(`model-viewer-${e}`,JSON.stringify({camera:s.camera,skybox:s.skybox,light:s.light,debug:s.debug,shadowCatcher:s.shadowCatcher,enableWebGPU:s.enableWebGPU}))})(t,"uistate")}))),(t=>{Qx.render(u.createElement(Gw,{observer:t}),document.getElementById("app"))})(t);const n=document.getElementById("application-canvas");(function(t,e={}){const s=e.deviceTypes??[];s.includes(Vi)||s.push(Vi),s.includes(Gi)||s.push(Gi),Ue.browser&&navigator.xr&&(e.xrCompatible??=!0);const i=[];for(let n=0;n<s.length;n++){const r=s[n];r===Hi&&window?.navigator?.gpu&&i.push((()=>new Za(t,e).initWebGpu(e.glslangUrl,e.twgslUrl))),r===Vi&&i.push((()=>new _o(t,e))),r===Gi&&i.push((()=>new xo(t,e)))}return new Promise(((t,e)=>{let s=0;const n=()=>{s>=i.length?e(new Error("Failed to create a graphics device")):Promise.resolve(i[s++]()).then((e=>{e?t(e):n()})).catch((t=>{console.log(t),n()}))};n()}))})(n,{deviceTypes:e.searchParams.has("webgpu")||t.get("enableWebGPU")?["webgpu"]:[],antialias:!1,depth:!1,stencil:!1,xrCompatible:!0,powerPreference:"high-performance"}).then((i=>{t.set("runtime.activeDeviceType",i.deviceType);const r=new NT(n,i,t,s);window.viewer=r;const a=[],o=[];"launchQueue"in window&&window.launchQueue.setConsumer((t=>{for(const e of t.files)o.push(e.getFile().then((t=>{a.push({url:URL.createObjectURL(t),filename:t.name})})))}));for(const[s,i]of e.searchParams)switch(s){case"load":case"assetUrl":{const t=decodeURIComponent(i);a.push({url:t,filename:t});break}case"cameraPosition":{const t=i.split(",").map(Number);3===t.length&&(r.initialCameraPosition=new rs(t));break}case"cameraFocus":{const t=i.split(",").map(Number);3===t.length&&(r.initialCameraFocus=new rs(t));break}case"dummyWebGPU":new BT(r.app);break;default:if(t.has(s))switch(typeof t.get(s)){case"boolean":t.set(s,"true"===i.toLowerCase());break;case"number":t.set(s,Number(i));break;default:t.set(s,decodeURIComponent(i))}}Promise.all(o).then((()=>{a.length>0&&r.loadFiles(a)}))}))})();
//# sourceMappingURL=index.js.map
